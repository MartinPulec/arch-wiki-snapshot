<!DOCTYPE html>
<html class="client-nojs vector-feature-language-in-header-enabled vector-feature-language-in-main-page-header-disabled vector-feature-sticky-header-disabled vector-feature-page-tools-pinned-disabled vector-feature-toc-pinned-clientpref-1 vector-feature-main-menu-pinned-disabled vector-feature-limited-width-clientpref-1 vector-feature-limited-width-content-enabled vector-feature-custom-font-size-clientpref-0 vector-feature-client-preferences-disabled vector-feature-client-prefs-pinned-disabled vector-feature-night-mode-disabled skin-theme-clientpref-day vector-toc-available" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>Btrfs (Русский) - ArchWiki</title>
<link rel="stylesheet" href="../ArchWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<meta name="generator" content="MediaWiki 1.42.1">
<meta name="referrer" content="no-referrer-when-downgrade">
<meta name="robots" content="max-image-preview:standard">
<meta name="format-detection" content="telephone=no">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=0.25, maximum-scale=5.0">
<link rel="icon" href="/favicon.ico">
<link rel="search" type="application/opensearchdescription+xml" href="/opensearch_desc.php" title="ArchWiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.archlinux.org/api.php?action=rsd">
<link rel="license" href="https://www.gnu.org/copyleft/fdl.html">
<link rel="alternate" type="application/atom+xml" title="ArchWiki Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="skin-vector skin-vector-search-vue mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-Btrfs_Русский rootpage-Btrfs_Русский skin-vector-2022 action-view skin--responsive">
<a class="mw-jump-link" href="#bodyContent">Jump to content</a>
<div class="vector-header-container">
	</div>
<div class="mw-page-container">
	<div class="mw-page-container-inner">
		<div class="vector-column-start">
			<div class="vector-main-menu-container">
		</div>
	<div class="vector-sticky-pinned-container">
				<nav id="mw-panel-toc" role="navigation" aria-label="Contents" data-event-name="ui.sidebar-toc" class="mw-table-of-contents-container vector-toc-landmark">
					<div id="vector-toc-pinned-container" class="vector-pinned-container">
					<div id="vector-toc" class="vector-toc vector-pinnable-element">
	<div class="vector-pinnable-header vector-toc-pinnable-header vector-pinnable-header-pinned" data-feature-name="toc-pinned" data-pinnable-element-id="vector-toc">
	<h2 class="vector-pinnable-header-label">Contents</h2>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-pin-button" data-event-name="pinnable-header.vector-toc.pin">move to sidebar</button>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-unpin-button" data-event-name="pinnable-header.vector-toc.unpin">hide</button>
</div>


	<ul class="vector-toc-contents" id="mw-panel-toc-list">
		<li id="toc-mw-content-text" class="vector-toc-list-item vector-toc-level-1">
			<a href="#" class="vector-toc-link">
				<div class="vector-toc-text">Beginning</div>
			</a>
		</li>
		<li id="toc-Подготовка" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#%D0%9F%D0%BE%D0%B4%D0%B3%D0%BE%D1%82%D0%BE%D0%B2%D0%BA%D0%B0">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">1</span>Подготовка</div>
		</a>
		
		<ul id="toc-Подготовка-sublist" class="vector-toc-list">
		</ul>
	</li>
	<li id="toc-Создание_файловой_системы" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D1%84%D0%B0%D0%B9%D0%BB%D0%BE%D0%B2%D0%BE%D0%B9_%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D1%8B">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">2</span>Создание файловой системы</div>
		</a>
		
			<button aria-controls="toc-Создание_файловой_системы-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Создание файловой системы subsection</span>
			</button>
		
		<ul id="toc-Создание_файловой_системы-sublist" class="vector-toc-list">
			<li id="toc-Файловая_система_на_одном_устройстве" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%A4%D0%B0%D0%B9%D0%BB%D0%BE%D0%B2%D0%B0%D1%8F_%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D0%B0_%D0%BD%D0%B0_%D0%BE%D0%B4%D0%BD%D0%BE%D0%BC_%D1%83%D1%81%D1%82%D1%80%D0%BE%D0%B9%D1%81%D1%82%D0%B2%D0%B5">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.1</span>Файловая система на одном устройстве</div>
			</a>
			
			<ul id="toc-Файловая_система_на_одном_устройстве-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Файловая_система_на_нескольких_устройствах" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%A4%D0%B0%D0%B9%D0%BB%D0%BE%D0%B2%D0%B0%D1%8F_%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D0%B0_%D0%BD%D0%B0_%D0%BD%D0%B5%D1%81%D0%BA%D0%BE%D0%BB%D1%8C%D0%BA%D0%B8%D1%85_%D1%83%D1%81%D1%82%D1%80%D0%BE%D0%B9%D1%81%D1%82%D0%B2%D0%B0%D1%85">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.2</span>Файловая система на нескольких устройствах</div>
			</a>
			
			<ul id="toc-Файловая_система_на_нескольких_устройствах-sublist" class="vector-toc-list">
				<li id="toc-Профили" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#%D0%9F%D1%80%D0%BE%D1%84%D0%B8%D0%BB%D0%B8">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.2.1</span>Профили</div>
			</a>
			
			<ul id="toc-Профили-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Настройка_файловой_системы" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0_%D1%84%D0%B0%D0%B9%D0%BB%D0%BE%D0%B2%D0%BE%D0%B9_%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D1%8B">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">3</span>Настройка файловой системы</div>
		</a>
		
			<button aria-controls="toc-Настройка_файловой_системы-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Настройка файловой системы subsection</span>
			</button>
		
		<ul id="toc-Настройка_файловой_системы-sublist" class="vector-toc-list">
			<li id="toc-Копирование_при_записи_(CoW)" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%9A%D0%BE%D0%BF%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_%D0%BF%D1%80%D0%B8_%D0%B7%D0%B0%D0%BF%D0%B8%D1%81%D0%B8_(CoW)">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.1</span>Копирование при записи (CoW)</div>
			</a>
			
			<ul id="toc-Копирование_при_записи_(CoW)-sublist" class="vector-toc-list">
				<li id="toc-Отключение_CoW" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#%D0%9E%D1%82%D0%BA%D0%BB%D1%8E%D1%87%D0%B5%D0%BD%D0%B8%D0%B5_CoW">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.1.1</span>Отключение CoW</div>
			</a>
			
			<ul id="toc-Отключение_CoW-sublist" class="vector-toc-list">
				<li id="toc-Влияние_на_снимки" class="vector-toc-list-item vector-toc-level-4">
			<a class="vector-toc-link" href="#%D0%92%D0%BB%D0%B8%D1%8F%D0%BD%D0%B8%D0%B5_%D0%BD%D0%B0_%D1%81%D0%BD%D0%B8%D0%BC%D0%BA%D0%B8">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.1.1.1</span>Влияние на снимки</div>
			</a>
			
			<ul id="toc-Влияние_на_снимки-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Сжатие" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%A1%D0%B6%D0%B0%D1%82%D0%B8%D0%B5">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.2</span>Сжатие</div>
			</a>
			
			<ul id="toc-Сжатие-sublist" class="vector-toc-list">
				<li id="toc-Просмотр_типов_и_коэффициентов_сжатия" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#%D0%9F%D1%80%D0%BE%D1%81%D0%BC%D0%BE%D1%82%D1%80_%D1%82%D0%B8%D0%BF%D0%BE%D0%B2_%D0%B8_%D0%BA%D0%BE%D1%8D%D1%84%D1%84%D0%B8%D1%86%D0%B8%D0%B5%D0%BD%D1%82%D0%BE%D0%B2_%D1%81%D0%B6%D0%B0%D1%82%D0%B8%D1%8F">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.2.1</span>Просмотр типов и коэффициентов сжатия</div>
			</a>
			
			<ul id="toc-Просмотр_типов_и_коэффициентов_сжатия-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Подтома" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%9F%D0%BE%D0%B4%D1%82%D0%BE%D0%BC%D0%B0">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.3</span>Подтома</div>
			</a>
			
			<ul id="toc-Подтома-sublist" class="vector-toc-list">
				<li id="toc-Создание_подтома" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D0%BF%D0%BE%D0%B4%D1%82%D0%BE%D0%BC%D0%B0">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.3.1</span>Создание подтома</div>
			</a>
			
			<ul id="toc-Создание_подтома-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Список_подтомов" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#%D0%A1%D0%BF%D0%B8%D1%81%D0%BE%D0%BA_%D0%BF%D0%BE%D0%B4%D1%82%D0%BE%D0%BC%D0%BE%D0%B2">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.3.2</span>Список подтомов</div>
			</a>
			
			<ul id="toc-Список_подтомов-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Удаление_подтома" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#%D0%A3%D0%B4%D0%B0%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5_%D0%BF%D0%BE%D0%B4%D1%82%D0%BE%D0%BC%D0%B0">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.3.3</span>Удаление подтома</div>
			</a>
			
			<ul id="toc-Удаление_подтома-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Монтирование_подтомов" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#%D0%9C%D0%BE%D0%BD%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_%D0%BF%D0%BE%D0%B4%D1%82%D0%BE%D0%BC%D0%BE%D0%B2">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.3.4</span>Монтирование подтомов</div>
			</a>
			
			<ul id="toc-Монтирование_подтомов-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Монтирование_подтома_в_качестве_корня" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#%D0%9C%D0%BE%D0%BD%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_%D0%BF%D0%BE%D0%B4%D1%82%D0%BE%D0%BC%D0%B0_%D0%B2_%D0%BA%D0%B0%D1%87%D0%B5%D1%81%D1%82%D0%B2%D0%B5_%D0%BA%D0%BE%D1%80%D0%BD%D1%8F">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.3.5</span>Монтирование подтома в качестве корня</div>
			</a>
			
			<ul id="toc-Монтирование_подтома_в_качестве_корня-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Изменение_подтома_по_умолчанию" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#%D0%98%D0%B7%D0%BC%D0%B5%D0%BD%D0%B5%D0%BD%D0%B8%D0%B5_%D0%BF%D0%BE%D0%B4%D1%82%D0%BE%D0%BC%D0%B0_%D0%BF%D0%BE_%D1%83%D0%BC%D0%BE%D0%BB%D1%87%D0%B0%D0%BD%D0%B8%D1%8E">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.3.6</span>Изменение подтома по умолчанию</div>
			</a>
			
			<ul id="toc-Изменение_подтома_по_умолчанию-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Квоты" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%9A%D0%B2%D0%BE%D1%82%D1%8B">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.4</span>Квоты</div>
			</a>
			
			<ul id="toc-Квоты-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Интервал_записи_на_диск" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%98%D0%BD%D1%82%D0%B5%D1%80%D0%B2%D0%B0%D0%BB_%D0%B7%D0%B0%D0%BF%D0%B8%D1%81%D0%B8_%D0%BD%D0%B0_%D0%B4%D0%B8%D1%81%D0%BA">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.5</span>Интервал записи на диск</div>
			</a>
			
			<ul id="toc-Интервал_записи_на_диск-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-SSD_TRIM" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#SSD_TRIM">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.6</span>SSD TRIM</div>
			</a>
			
			<ul id="toc-SSD_TRIM-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Использование" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#%D0%98%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">4</span>Использование</div>
		</a>
		
			<button aria-controls="toc-Использование-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Использование subsection</span>
			</button>
		
		<ul id="toc-Использование-sublist" class="vector-toc-list">
			<li id="toc-Файл_подкачки" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%A4%D0%B0%D0%B9%D0%BB_%D0%BF%D0%BE%D0%B4%D0%BA%D0%B0%D1%87%D0%BA%D0%B8">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">4.1</span>Файл подкачки</div>
			</a>
			
			<ul id="toc-Файл_подкачки-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Отображение_занятого/свободного_места" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%9E%D1%82%D0%BE%D0%B1%D1%80%D0%B0%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5_%D0%B7%D0%B0%D0%BD%D1%8F%D1%82%D0%BE%D0%B3%D0%BE/%D1%81%D0%B2%D0%BE%D0%B1%D0%BE%D0%B4%D0%BD%D0%BE%D0%B3%D0%BE_%D0%BC%D0%B5%D1%81%D1%82%D0%B0">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">4.2</span>Отображение занятого/свободного места</div>
			</a>
			
			<ul id="toc-Отображение_занятого/свободного_места-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Дефрагментация" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%94%D0%B5%D1%84%D1%80%D0%B0%D0%B3%D0%BC%D0%B5%D0%BD%D1%82%D0%B0%D1%86%D0%B8%D1%8F">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">4.3</span>Дефрагментация</div>
			</a>
			
			<ul id="toc-Дефрагментация-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-RAID" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#RAID">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">4.4</span>RAID</div>
			</a>
			
			<ul id="toc-RAID-sublist" class="vector-toc-list">
				<li id="toc-Scrub" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Scrub">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">4.4.1</span>Scrub</div>
			</a>
			
			<ul id="toc-Scrub-sublist" class="vector-toc-list">
				<li id="toc-Запуск_вручную" class="vector-toc-list-item vector-toc-level-4">
			<a class="vector-toc-link" href="#%D0%97%D0%B0%D0%BF%D1%83%D1%81%D0%BA_%D0%B2%D1%80%D1%83%D1%87%D0%BD%D1%83%D1%8E">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">4.4.1.1</span>Запуск вручную</div>
			</a>
			
			<ul id="toc-Запуск_вручную-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Запуск_с_помощью_службы_или_таймера" class="vector-toc-list-item vector-toc-level-4">
			<a class="vector-toc-link" href="#%D0%97%D0%B0%D0%BF%D1%83%D1%81%D0%BA_%D1%81_%D0%BF%D0%BE%D0%BC%D0%BE%D1%89%D1%8C%D1%8E_%D1%81%D0%BB%D1%83%D0%B6%D0%B1%D1%8B_%D0%B8%D0%BB%D0%B8_%D1%82%D0%B0%D0%B9%D0%BC%D0%B5%D1%80%D0%B0">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">4.4.1.2</span>Запуск с помощью службы или таймера</div>
			</a>
			
			<ul id="toc-Запуск_с_помощью_службы_или_таймера-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Балансировка" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#%D0%91%D0%B0%D0%BB%D0%B0%D0%BD%D1%81%D0%B8%D1%80%D0%BE%D0%B2%D0%BA%D0%B0">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">4.4.2</span>Балансировка</div>
			</a>
			
			<ul id="toc-Балансировка-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Снимки" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%A1%D0%BD%D0%B8%D0%BC%D0%BA%D0%B8">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">4.5</span>Снимки</div>
			</a>
			
			<ul id="toc-Снимки-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Отправка/получение" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%9E%D1%82%D0%BF%D1%80%D0%B0%D0%B2%D0%BA%D0%B0/%D0%BF%D0%BE%D0%BB%D1%83%D1%87%D0%B5%D0%BD%D0%B8%D0%B5">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">4.6</span>Отправка/получение</div>
			</a>
			
			<ul id="toc-Отправка/получение-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Дедупликация" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%94%D0%B5%D0%B4%D1%83%D0%BF%D0%BB%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D1%8F">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">4.7</span>Дедупликация</div>
			</a>
			
			<ul id="toc-Дедупликация-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Изменение_размера" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%98%D0%B7%D0%BC%D0%B5%D0%BD%D0%B5%D0%BD%D0%B8%D0%B5_%D1%80%D0%B0%D0%B7%D0%BC%D0%B5%D1%80%D0%B0">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">4.8</span>Изменение размера</div>
			</a>
			
			<ul id="toc-Изменение_размера-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Известные_проблемы" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#%D0%98%D0%B7%D0%B2%D0%B5%D1%81%D1%82%D0%BD%D1%8B%D0%B5_%D0%BF%D1%80%D0%BE%D0%B1%D0%BB%D0%B5%D0%BC%D1%8B">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">5</span>Известные проблемы</div>
		</a>
		
			<button aria-controls="toc-Известные_проблемы-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Известные проблемы subsection</span>
			</button>
		
		<ul id="toc-Известные_проблемы-sublist" class="vector-toc-list">
			<li id="toc-Шифрование" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%A8%D0%B8%D1%84%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">5.1</span>Шифрование</div>
			</a>
			
			<ul id="toc-Шифрование-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Проблемы_проверки_btrfs" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%9F%D1%80%D0%BE%D0%B1%D0%BB%D0%B5%D0%BC%D1%8B_%D0%BF%D1%80%D0%BE%D0%B2%D0%B5%D1%80%D0%BA%D0%B8_btrfs">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">5.2</span>Проблемы проверки btrfs</div>
			</a>
			
			<ul id="toc-Проблемы_проверки_btrfs-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Советы_и_рекомендации" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#%D0%A1%D0%BE%D0%B2%D0%B5%D1%82%D1%8B_%D0%B8_%D1%80%D0%B5%D0%BA%D0%BE%D0%BC%D0%B5%D0%BD%D0%B4%D0%B0%D1%86%D0%B8%D0%B8">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">6</span>Советы и рекомендации</div>
		</a>
		
			<button aria-controls="toc-Советы_и_рекомендации-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Советы и рекомендации subsection</span>
			</button>
		
		<ul id="toc-Советы_и_рекомендации-sublist" class="vector-toc-list">
			<li id="toc-Диск_Btrfs_без_разделов" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%94%D0%B8%D1%81%D0%BA_Btrfs_%D0%B1%D0%B5%D0%B7_%D1%80%D0%B0%D0%B7%D0%B4%D0%B5%D0%BB%D0%BE%D0%B2">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">6.1</span>Диск Btrfs без разделов</div>
			</a>
			
			<ul id="toc-Диск_Btrfs_без_разделов-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Преобразование_Ext3/4_в_Btrfs" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%9F%D1%80%D0%B5%D0%BE%D0%B1%D1%80%D0%B0%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_Ext3/4_%D0%B2_Btrfs">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">6.2</span>Преобразование Ext3/4 в Btrfs</div>
			</a>
			
			<ul id="toc-Преобразование_Ext3/4_в_Btrfs-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Восстановление_повреждённой_файловой_системы" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%92%D0%BE%D1%81%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5_%D0%BF%D0%BE%D0%B2%D1%80%D0%B5%D0%B6%D0%B4%D1%91%D0%BD%D0%BD%D0%BE%D0%B9_%D1%84%D0%B0%D0%B9%D0%BB%D0%BE%D0%B2%D0%BE%D0%B9_%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D1%8B">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">6.3</span>Восстановление повреждённой файловой системы</div>
			</a>
			
			<ul id="toc-Восстановление_повреждённой_файловой_системы-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Загрузка_в_снимок" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%97%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D0%BA%D0%B0_%D0%B2_%D1%81%D0%BD%D0%B8%D0%BC%D0%BE%D0%BA">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">6.4</span>Загрузка в снимок</div>
			</a>
			
			<ul id="toc-Загрузка_в_снимок-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Использование_подтомов_Btrfs_в_systemd-nspawn" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%98%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_%D0%BF%D0%BE%D0%B4%D1%82%D0%BE%D0%BC%D0%BE%D0%B2_Btrfs_%D0%B2_systemd-nspawn">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">6.5</span>Использование подтомов Btrfs в systemd-nspawn</div>
			</a>
			
			<ul id="toc-Использование_подтомов_Btrfs_в_systemd-nspawn-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Уменьшение_частоты_записи_метаданных_при_обновлении_времени_доступа" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%A3%D0%BC%D0%B5%D0%BD%D1%8C%D1%88%D0%B5%D0%BD%D0%B8%D0%B5_%D1%87%D0%B0%D1%81%D1%82%D0%BE%D1%82%D1%8B_%D0%B7%D0%B0%D0%BF%D0%B8%D1%81%D0%B8_%D0%BC%D0%B5%D1%82%D0%B0%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85_%D0%BF%D1%80%D0%B8_%D0%BE%D0%B1%D0%BD%D0%BE%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B8_%D0%B2%D1%80%D0%B5%D0%BC%D0%B5%D0%BD%D0%B8_%D0%B4%D0%BE%D1%81%D1%82%D1%83%D0%BF%D0%B0">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">6.6</span>Уменьшение частоты записи метаданных при обновлении времени доступа</div>
			</a>
			
			<ul id="toc-Уменьшение_частоты_записи_метаданных_при_обновлении_времени_доступа-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Инкрементное_резервное_копирование_на_внешний_диск" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%98%D0%BD%D0%BA%D1%80%D0%B5%D0%BC%D0%B5%D0%BD%D1%82%D0%BD%D0%BE%D0%B5_%D1%80%D0%B5%D0%B7%D0%B5%D1%80%D0%B2%D0%BD%D0%BE%D0%B5_%D0%BA%D0%BE%D0%BF%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_%D0%BD%D0%B0_%D0%B2%D0%BD%D0%B5%D1%88%D0%BD%D0%B8%D0%B9_%D0%B4%D0%B8%D1%81%D0%BA">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">6.7</span>Инкрементное резервное копирование на внешний диск</div>
			</a>
			
			<ul id="toc-Инкрементное_резервное_копирование_на_внешний_диск-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Автоматические_снимки" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%90%D0%B2%D1%82%D0%BE%D0%BC%D0%B0%D1%82%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B8%D0%B5_%D1%81%D0%BD%D0%B8%D0%BC%D0%BA%D0%B8">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">6.8</span>Автоматические снимки</div>
			</a>
			
			<ul id="toc-Автоматические_снимки-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Решение_проблем" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#%D0%A0%D0%B5%D1%88%D0%B5%D0%BD%D0%B8%D0%B5_%D0%BF%D1%80%D0%BE%D0%B1%D0%BB%D0%B5%D0%BC">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">7</span>Решение проблем</div>
		</a>
		
			<button aria-controls="toc-Решение_проблем-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Решение проблем subsection</span>
			</button>
		
		<ul id="toc-Решение_проблем-sublist" class="vector-toc-list">
			<li id="toc-GRUB" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#GRUB">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">7.1</span>GRUB</div>
			</a>
			
			<ul id="toc-GRUB-sublist" class="vector-toc-list">
				<li id="toc-Смещение_раздела" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#%D0%A1%D0%BC%D0%B5%D1%89%D0%B5%D0%BD%D0%B8%D0%B5_%D1%80%D0%B0%D0%B7%D0%B4%D0%B5%D0%BB%D0%B0">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">7.1.1</span>Смещение раздела</div>
			</a>
			
			<ul id="toc-Смещение_раздела-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Корневая_файловая_система_не_найдена" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#%D0%9A%D0%BE%D1%80%D0%BD%D0%B5%D0%B2%D0%B0%D1%8F_%D1%84%D0%B0%D0%B9%D0%BB%D0%BE%D0%B2%D0%B0%D1%8F_%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D0%B0_%D0%BD%D0%B5_%D0%BD%D0%B0%D0%B9%D0%B4%D0%B5%D0%BD%D0%B0">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">7.1.2</span>Корневая файловая система не найдена</div>
			</a>
			
			<ul id="toc-Корневая_файловая_система_не_найдена-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Таймаут_монтирования" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%A2%D0%B0%D0%B9%D0%BC%D0%B0%D1%83%D1%82_%D0%BC%D0%BE%D0%BD%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">7.2</span>Таймаут монтирования</div>
			</a>
			
			<ul id="toc-Таймаут_монтирования-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-BTRFS:_open_ctree_failed" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#BTRFS:_open_ctree_failed">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">7.3</span>BTRFS: open_ctree failed</div>
			</a>
			
			<ul id="toc-BTRFS:_open_ctree_failed-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Проверка_файловой_системы" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%9F%D1%80%D0%BE%D0%B2%D0%B5%D1%80%D0%BA%D0%B0_%D1%84%D0%B0%D0%B9%D0%BB%D0%BE%D0%B2%D0%BE%D0%B9_%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D1%8B">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">7.4</span>Проверка файловой системы</div>
			</a>
			
			<ul id="toc-Проверка_файловой_системы-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Диск_постоянно_активен" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%94%D0%B8%D1%81%D0%BA_%D0%BF%D0%BE%D1%81%D1%82%D0%BE%D1%8F%D0%BD%D0%BD%D0%BE_%D0%B0%D0%BA%D1%82%D0%B8%D0%B2%D0%B5%D0%BD">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">7.5</span>Диск постоянно активен</div>
			</a>
			
			<ul id="toc-Диск_постоянно_активен-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Смотрите_также" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#%D0%A1%D0%BC%D0%BE%D1%82%D1%80%D0%B8%D1%82%D0%B5_%D1%82%D0%B0%D0%BA%D0%B6%D0%B5">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">8</span>Смотрите также</div>
		</a>
		
		<ul id="toc-Смотрите_также-sublist" class="vector-toc-list">
		</ul>
	</li>
</ul>
</div>

					</div>
		</nav>
			</div>
		</div>
		<div class="mw-content-container">
			<main id="content" class="mw-body" role="main" style="margin: 0">
				<header class="mw-body-header vector-page-titlebar">
					<nav role="navigation" aria-label="Contents" class="vector-toc-landmark">
						
<div id="vector-page-titlebar-toc" class="vector-dropdown vector-page-titlebar-toc vector-button-flush-left">
	<input type="checkbox" id="vector-page-titlebar-toc-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-vector-page-titlebar-toc" class="vector-dropdown-checkbox " aria-label="Toggle the table of contents">
	<label id="vector-page-titlebar-toc-label" for="vector-page-titlebar-toc-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--icon-only " aria-hidden="true"><span class="vector-icon mw-ui-icon-listBullet mw-ui-icon-wikimedia-listBullet"></span>

<span class="vector-dropdown-label-text">Toggle the table of contents</span>
	</label>
	<div class="vector-dropdown-content">


							<div id="vector-page-titlebar-toc-unpinned-container" class="vector-unpinned-container">
			</div>
		
	</div>
</div>

					</nav>
					<h1 id="firstHeading" class="firstHeading mw-first-heading"><span class="mw-page-title-main">Btrfs (Русский)</span></h1>
							
<div id="p-lang-btn" class="vector-dropdown mw-portlet mw-portlet-lang">
	<input type="checkbox" id="p-lang-btn-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-p-lang-btn" class="vector-dropdown-checkbox mw-interlanguage-selector" aria-label="Go to an article in another language. Available in 7 languages">
	<label id="p-lang-btn-label" for="p-lang-btn-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--action-progressive mw-portlet-lang-heading-7" aria-hidden="true"><span class="vector-icon mw-ui-icon-language-progressive mw-ui-icon-wikimedia-language-progressive"></span>

<span class="vector-dropdown-label-text">7 languages</span>
	</label>
	<div class="vector-dropdown-content">

		<div class="vector-menu-content">
			
			<ul class="vector-menu-content-list">
				
				<li class="interlanguage-link interwiki-de mw-list-item"><a href="https://wiki.archlinux.de/title/Arch_auf_BtrFS" title="Arch auf BtrFS – Deutsch" lang="de" hreflang="de" class="interlanguage-link-target"><span>Deutsch</span></a></li>
<li class="interlanguage-link interwiki-en mw-list-item"><a href="../en/Btrfs.html" title="Btrfs – English" lang="en" hreflang="en" class="interlanguage-link-target"><span>English</span></a></li>
<li class="interlanguage-link interwiki-es mw-list-item"><a href="../es/Btrfs.html" title="Btrfs – español" lang="es" hreflang="es" class="interlanguage-link-target"><span>Español</span></a></li>
<li class="interlanguage-link interwiki-it mw-list-item"><a href="../it/Btrfs.html" title="Btrfs – italiano" lang="it" hreflang="it" class="interlanguage-link-target"><span>Italiano</span></a></li>
<li class="interlanguage-link interwiki-ja mw-list-item"><a href="https://wiki.archlinux.jp/index.php/Btrfs" title="Btrfs – 日本語" lang="ja" hreflang="ja" class="interlanguage-link-target"><span>日本語</span></a></li>
<li class="interlanguage-link interwiki-pt mw-list-item"><a href="../pt/Btrfs.html" title="Btrfs – português" lang="pt" hreflang="pt" class="interlanguage-link-target"><span>Português</span></a></li>
<li class="interlanguage-link interwiki-zh-hans mw-list-item"><a href="https://wiki.archlinuxcn.org/wiki/Btrfs" title="Btrfs – 中文（简体）" lang="zh-Hans" hreflang="zh-Hans" class="interlanguage-link-target"><span>中文（简体）</span></a></li>
			</ul>
			
		</div>

	</div>
</div>
</header>
				<div class="vector-column-end">
					<div class="vector-sticky-pinned-container">
						<nav class="vector-page-tools-landmark" aria-label="Page tools">
							<div id="vector-page-tools-pinned-container" class="vector-pinned-container">
				
							</div>
		</nav>
						<nav class="vector-client-prefs-landmark" aria-label="Appearance">
						</nav>
					</div>
				</div>
				<div id="bodyContent" class="vector-body" aria-labelledby="firstHeading" data-mw-ve-target-container>
					<div class="vector-body-before-content">
							<div class="mw-indicators">
		</div>

						<div id="siteSub" class="noprint">From ArchWiki</div>
					</div>
					<div id="contentSub"><div id="mw-content-subtitle"></div></div>
					
					
					<div id="mw-content-text" class="mw-body-content">
<div class="mw-content-ltr mw-parser-output" lang="ru" dir="ltr">
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Состояние перевода:</strong> На этой странице представлен перевод статьи <a href="../en/Btrfs.html" title="Btrfs">Btrfs</a>. Дата последней синхронизации: 26 мая 2024. Вы можете <a href="../ru/ArchWiki:Translation_Team.html" title="ArchWiki:Translation Team (Русский)">помочь</a> синхронизировать перевод, если в английской версии произошли <a rel="nofollow" class="external text" href="https://wiki.archlinux.org/index.php?title=Btrfs&amp;diff=0&amp;oldid=808666">изменения</a>.</div>
<div class="archwiki-template-meta-related-articles">
<p>Ссылки по теме</p>
<ul>
<li><a href="../ru/File_systems.html" class="mw-redirect" title="Файловые системы">Файловые системы</a></li>
<li><a href="../en/Snapper.html" title="Snapper">Snapper</a></li>
<li><a href="../en/Timeshift.html" title="Timeshift">Timeshift</a></li>
<li><a href="../en/Yabsnap.html" title="Yabsnap">Yabsnap</a></li>
</ul>
</div>
<p>Из <a rel="nofollow" class="external text" href="https://btrfs.readthedocs.io/en/latest/Introduction.html">документации Btrfs</a>:
</p>
<dl><dd>Btrfs — это современная файловая система для Linux, использующая принцип «копирование при записи» (CoW), направленная на реализацию дополнительных функций с особым упором на отказоустойчивость, восстановление и простоту администрирования.</dd></dl>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> Как и некоторые другие файловые системы, Btrfs находится в активной разработке. Это означает, что некоторые функции могут быть ещё не готовы к повседневному использованию. Чтобы узнать, может ли это повлиять на ваш вариант использования, проверьте страницу <a rel="nofollow" class="external text" href="https://btrfs.readthedocs.io/en/latest/Status.html">Status</a> в документации Btrfs и раздел <a href="#%D0%98%D0%B7%D0%B2%D0%B5%D1%81%D1%82%D0%BD%D1%8B%D0%B5_%D0%BF%D1%80%D0%BE%D0%B1%D0%BB%D0%B5%D0%BC%D1%8B">#Известные проблемы</a> этой статьи.</div>
<meta property="mw:PageProp/toc">
<h2>
<span id=".D0.9F.D0.BE.D0.B4.D0.B3.D0.BE.D1.82.D0.BE.D0.B2.D0.BA.D0.B0"></span><span class="mw-headline" id="Подготовка">Подготовка</span>
</h2>
<p>Для утилит пользовательского пространства <a href="../ru/Help:Reading.html#%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0_%D0%BF%D0%B0%D0%BA%D0%B5%D1%82%D0%BE%D0%B2" class="mw-redirect" title="Установите">установите</a> пакет <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=btrfs-progs">btrfs-progs</a></span>, который необходим для базовых операций.
</p>
<p>Если вам нужно загрузиться с файловой системы Btrfs (то есть ядро и initramfs находятся на разделе Btrfs), проверьте, имеет ли ваш <a href="../ru/Arch_boot_process.html#%D0%97%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D1%87%D0%B8%D0%BA" class="mw-redirect" title="Загрузчик">загрузчик</a> поддержку Btrfs.
</p>
<h2>
<span id=".D0.A1.D0.BE.D0.B7.D0.B4.D0.B0.D0.BD.D0.B8.D0.B5_.D1.84.D0.B0.D0.B9.D0.BB.D0.BE.D0.B2.D0.BE.D0.B9_.D1.81.D0.B8.D1.81.D1.82.D0.B5.D0.BC.D1.8B"></span><span class="mw-headline" id="Создание_файловой_системы">Создание файловой системы</span>
</h2>
<p>Этот раздел демонстрирует, как создать новую <a href="../ru/File_systems.html" title="File systems (Русский)">файловую систему</a> Btrfs. Также можно выполнить <a href="#%D0%9F%D1%80%D0%B5%D0%BE%D0%B1%D1%80%D0%B0%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_Ext3/4_%D0%B2_Btrfs">#Преобразование Ext3/4 в Btrfs</a> или сделать <a href="#%D0%94%D0%B8%D1%81%D0%BA_Btrfs_%D0%B1%D0%B5%D0%B7_%D1%80%D0%B0%D0%B7%D0%B4%D0%B5%D0%BB%D0%BE%D0%B2">#Диск Btrfs без разделов</a>.
</p>
<p>Дополнительная информация доступна man-странице <span class="plainlinks archwiki-template-man" title="$ man 8 mkfs.btrfs"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/mkfs.btrfs.8">mkfs.btrfs(8)</a></span>.
</p>
<h3>
<span id=".D0.A4.D0.B0.D0.B9.D0.BB.D0.BE.D0.B2.D0.B0.D1.8F_.D1.81.D0.B8.D1.81.D1.82.D0.B5.D0.BC.D0.B0_.D0.BD.D0.B0_.D0.BE.D0.B4.D0.BD.D0.BE.D0.BC_.D1.83.D1.81.D1.82.D1.80.D0.BE.D0.B9.D1.81.D1.82.D0.B2.D0.B5"></span><span class="mw-headline" id="Файловая_система_на_одном_устройстве">Файловая система на одном устройстве</span>
</h3>
<p>Чтобы создать файловую систему Btrfs на разделе <code>/dev/<i>раздел</i></code>:
</p>
<pre># mkfs.btrfs -L <i>метка</i> /dev/<i>раздел</i>
</pre>
<p>Размер узла для метаданных по умолчанию составляет 16 КиБ, а размер сектора по умолчанию для данных равен размеру страницы и определяется автоматически. Чтобы использовать больший размер узла для метаданных (он должен быть кратен размеру сектора, допускается до 64 КиБ), укажите значение <code>nodesize</code> с помощью опции <code>-n</code>, как показано в этом примере с блоками по 32 КиБ:
</p>
<pre># mkfs.btrfs -L <i>метка</i> -n 32k /dev/<i>раздел</i>
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> Согласно <span class="plainlinks archwiki-template-man" title="$ man 8 mkfs.btrfs"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/mkfs.btrfs.8#OPTIONS">mkfs.btrfs(8) § OPTIONS</a></span>, «меньший размер узла увеличивает фрагментацию, но приводит к использованию более высоких b-деревьев, что, в свою очередь, приводит к меньшей конкуренции при блокировке. Больший размер узла даёт лучшую упаковку и меньшую фрагментацию ценой более дорогих операций с памятью при обновлении блоков метаданных».</div>
<h3>
<span id=".D0.A4.D0.B0.D0.B9.D0.BB.D0.BE.D0.B2.D0.B0.D1.8F_.D1.81.D0.B8.D1.81.D1.82.D0.B5.D0.BC.D0.B0_.D0.BD.D0.B0_.D0.BD.D0.B5.D1.81.D0.BA.D0.BE.D0.BB.D1.8C.D0.BA.D0.B8.D1.85_.D1.83.D1.81.D1.82.D1.80.D0.BE.D0.B9.D1.81.D1.82.D0.B2.D0.B0.D1.85"></span><span class="mw-headline" id="Файловая_система_на_нескольких_устройствах">Файловая система на нескольких устройствах</span>
</h3>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Важно:</strong> Режимы RAID 5 и RAID 6 в Btrfs фатально несовершенны и не должны использоваться для чего-либо, кроме тестирования на данных, которые не жалко потерять. <a rel="nofollow" class="external text" href="https://lore.kernel.org/linux-btrfs/20200627032414.GX10769@hungrycats.org/">Список известных проблем и частичных обходных путей</a>. Актуальную информацию о статусе можно посмотреть здесь: <span class="plainlinks archwiki-template-man" title="$ man 5 btrfs"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/btrfs.5#RAID56_STATUS_AND_RECOMMENDED_PRACTICES">btrfs(5) § RAID56 STATUS AND RECOMMENDED PRACTICES</a></span>.</div>
<p>Можно использовать несколько устройств для создания RAID-массива. Поддерживаются уровни RAID 0, RAID 1, RAID 10, RAID 5 и RAID 6. Начиная с ядра 5.5, поддерживаются RAID1c3 и RAID1c4 для 3- и 4- копий уровня RAID 1. Уровни RAID могут быть настроены отдельно для данных и метаданных с помощью опций <code>-d</code> и <code>-m</code> соответственно. По умолчанию данные имеют одну копию (<code>single</code>), а метаданные зеркалируются (<code>raid1</code>). Это похоже на создание конфигурации <a href="https://en.wikipedia.org/wiki/ru:JBOD" class="extiw" title="wikipedia:ru:JBOD">JBOD</a>, где диски воспринимаются как одна файловая система, но файлы не дублируются. Дополнительная информация о создании Btrfs RAID есть на странице <a rel="nofollow" class="external text" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/Using_Btrfs_with_Multiple_Devices.html">Using Btrfs with Multiple Devices</a>.
</p>
<pre># mkfs.btrfs -d single -m raid1 /dev/<i>раздел1</i> /dev/<i>раздел2</i> ...
</pre>
<p>В <code>/etc/mkinitcpio.conf</code> необходимо включить хук <code>udev</code>, <code>systemd</code> или <code>btrfs</code>, чтобы использовать несколько устройств Btrfs в пуле. Дополнительную информацию смотрите в статье <a href="../ru/Mkinitcpio.html#%D0%94%D0%BE%D1%81%D1%82%D1%83%D0%BF%D0%BD%D1%8B%D0%B5_%D1%85%D1%83%D0%BA%D0%B8" title="Mkinitcpio (Русский)">mkinitcpio (Русский)#Доступные хуки</a>.
</p>
<p>После создания файловой системы рекомендуется выполнить следующую команду для сканирования файловых систем Btrfs на нескольких устройствах и их регистрации, что позволит монтировать файловую систему с несколькими устройствами, указав только одно из устройств:
</p>
<pre># btrfs device scan
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> 
<ul>
<li>Существует возможность добавлять дополнительные устройства в файловую систему с несколькими устройствами после её создания. Дополнительную информацию смотрите в <a rel="nofollow" class="external text" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/Using_Btrfs_with_Multiple_Devices.html">Btrfs wiki</a>.</li>
<li>Устройства могут быть разных размеров. Однако если один из дисков в конфигурации RAID больше остальных, то дополнительное пространство не будет использоваться.</li>
<li>Некоторые <a href="../ru/Arch_boot_process.html#%D0%97%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D1%87%D0%B8%D0%BA" title="Arch boot process (Русский)">загрузчики</a>, такие как <a href="../ru/Syslinux.html" title="Syslinux (Русский)">Syslinux</a>, не поддерживают файловые системы на нескольких устройствах.</li>
<li>Btrfs не пытается выбирать самое быстрое устройство для чтения, поэтому совместное использование разных типов дисков приводит к нестабильной производительности. <a rel="nofollow" class="external autonumber" href="https://stackoverflow.com/a/55408367">[1]</a>
</li>
</ul>
</div>
<p>Советы по обслуживанию файловых систем на нескольких устройствах приведены в разделе <a href="#RAID">#RAID</a>.
</p>
<h4>
<span id=".D0.9F.D1.80.D0.BE.D1.84.D0.B8.D0.BB.D0.B8"></span><span class="mw-headline" id="Профили">Профили</span>
</h4>
<p>Btrfs использует концепцию <a rel="nofollow" class="external text" href="https://btrfs.readthedocs.io/en/latest/mkfs.btrfs.html#profiles">профилей</a> для настройки зеркалирования, чётности и чередования. В стандартной терминологии <a href="https://en.wikipedia.org/wiki/ru:RAID" class="extiw" title="wikipedia:ru:RAID">RAID</a> это называется <i>уровнем RAID</i>. Профили для метаданных (опция <code>-m</code> команды <span class="plainlinks archwiki-template-man" title="$ man 8 mkfs.btrfs"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/mkfs.btrfs.8">mkfs.btrfs(8)</a></span>) и данных (опция <code>-d</code> команды <span class="plainlinks archwiki-template-man" title="$ man 8 mkfs.btrfs"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/mkfs.btrfs.8">mkfs.btrfs(8)</a></span>) могут быть разными в пределах одной файловой системы.
</p>
<p>Некоторые примечательные профили:
</p>
<dl>
<dt>single</dt>
<dd>Без зеркалирования, без чередования, без чётности, позволяет объединить несколько устройств в одну файловую систему, что в терминологии <a href="../en/RAID.html" class="mw-redirect" title="RAID (Русский)">mdadm</a> называется <code>LINEAR</code>.</dd>
<dt>raid0</dt>
<dd>Без зеркалирования, с чередованием, без чётности, обеспечивает параллельный доступ между устройствами, но не ограничивается устройствами одного размера, как традиционный <a href="../en/RAID.html" class="mw-redirect" title="RAID (Русский)">mdadm</a> RAID.</dd>
<dt>raid1</dt>
<dd>С зеркалированием, без чередования, без чётности, позволяет выполнить восстановление после отказа одного диска.</dd>
</dl>
<h2>
<span id=".D0.9D.D0.B0.D1.81.D1.82.D1.80.D0.BE.D0.B9.D0.BA.D0.B0_.D1.84.D0.B0.D0.B9.D0.BB.D0.BE.D0.B2.D0.BE.D0.B9_.D1.81.D0.B8.D1.81.D1.82.D0.B5.D0.BC.D1.8B"></span><span class="mw-headline" id="Настройка_файловой_системы">Настройка файловой системы</span>
</h2>
<h3>
<span id=".D0.9A.D0.BE.D0.BF.D0.B8.D1.80.D0.BE.D0.B2.D0.B0.D0.BD.D0.B8.D0.B5_.D0.BF.D1.80.D0.B8_.D0.B7.D0.B0.D0.BF.D0.B8.D1.81.D0.B8_.28CoW.29"></span><span class="mw-headline" id="Копирование_при_записи_(CoW)">Копирование при записи (CoW)</span>
</h3>
<p>По умолчанию Btrfs постоянно использует <a href="https://en.wikipedia.org/wiki/ru:%D0%9A%D0%BE%D0%BF%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_%D0%BF%D1%80%D0%B8_%D0%B7%D0%B0%D0%BF%D0%B8%D1%81%D0%B8" class="extiw" title="wikipedia:ru:Копирование при записи">копирование при записи</a> (copy-on-write) для всех файлов. Когда выполняется операция записи, новые данные не записываются поверх старых; вместо этого изменённая копия блока записывается в новое место и в метаданные записывается адрес нового блока. Подробности реализации, а также преимущества и недостатки описаны в <a rel="nofollow" class="external text" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/SysadminGuide.html#Copy_on_Write_.28CoW.29">Btrfs Sysadmin Guide</a>.
</p>
<h4>
<span id=".D0.9E.D1.82.D0.BA.D0.BB.D1.8E.D1.87.D0.B5.D0.BD.D0.B8.D0.B5_CoW"></span><span class="mw-headline" id="Отключение_CoW">Отключение CoW</span>
</h4>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Важно:</strong> Отключение CoW в Btrfs также отключает контрольные суммы. Btrfs не сможет обнаружить повреждения в <code>nodatacow</code> файлах. В сочетании с RAID 1 перебои в электропитании или другие причины повреждений могут привести к рассинхронизации данных.</div>
<p>Чтобы отключить копирование при записи для создаваемых файлов в примонтированном подтоме, используйте опцию монтирования <code>nodatacow</code>. Это повлияет только на новые файлы. Для существующих файлов копирование при записи всё равно будет происходить. Опция <code>nodatacow</code> также отключает сжатие. Подробности смотрите в <span class="plainlinks archwiki-template-man" title="$ man 5 btrfs"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/btrfs.5">btrfs(5)</a></span>.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> Из <span class="plainlinks archwiki-template-man" title="$ man 5 btrfs"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/btrfs.5#MOUNT_OPTIONS">btrfs(5) § MOUNT OPTIONS</a></span>:
<dl><dd>в рамках одной файловой системы невозможно монтировать одни подтома с <code>nodatacow</code>, а другие с <code>datacow</code>. Опция монтирования первого смонтированного подтома применяется ко всем остальным подтомам.</dd></dl>
</div>
<p>Чтобы отключить копирование при записи для отдельных файлов/каталогов, выполните:
</p>
<pre>$ chattr +C <i>/каталог/файл</i>
</pre>
<p>Это отключит копирование при записи для операций над файлами, на которые есть только одна ссылка. Если ссылок на файл больше одной, например, из-за клонирования файлов или облегчённых клонов или снимков файловой системы, копирование при записи всё равно будет происходить. Начиная с <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=coreutils">coreutils</a></span> 9.0, <code>cp</code> пытается создавать облегчённые копии по умолчанию — смотрите <span class="plainlinks archwiki-template-man" title="$ man 1 cp"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/cp.1">cp(1)</a></span> для более подробной информации.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> Из <span class="plainlinks archwiki-template-man" title="$ man 1 chattr"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/chattr.1">chattr(1)</a></span>:
<dl><dd>При использовании Btrfs флаг '<code>C</code>' следует устанавливать для новых или пустых файлов. Если он установлен на файле, который уже имеет блоки данных, то неизвестно, когда блоки, назначенные файлу, станут полностью стабильными. Если флаг '<code>C</code>' установлен для каталога, он не будет иметь никакого эффекта на каталог, но новые файлы, создаваемые в этом каталоге, будут иметь атрибут <code>No_COW</code>.</dd></dl>
</div>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Совет:</strong> В соответствии с примечанием выше, вы можете использовать следующий трюк, чтобы отключить копирование при записи для существующих файлов в каталоге:
<pre>$ mv <i>/путь/к/каталогу</i> <i>/путь/к/каталогу</i>_old
$ mkdir <i>/путь/к/каталогу</i>
$ chattr +C <i>/путь/к/каталогу</i>
$ cp -a --reflink=never <i>/путь/к/каталогу</i>_old/. <i>/путь/к/каталогу</i>
$ rm -rf <i>/путь/к/каталогу</i>_old
</pre>
Убедитесь, что данные не используются во время этого процесса. Также обратите внимание, что <code>mv</code> или <code>cp</code> без <code>--reflink=never</code>, как описано ниже, работать не будут.</div>
<h5>
<span id=".D0.92.D0.BB.D0.B8.D1.8F.D0.BD.D0.B8.D0.B5_.D0.BD.D0.B0_.D1.81.D0.BD.D0.B8.D0.BC.D0.BA.D0.B8"></span><span class="mw-headline" id="Влияние_на_снимки">Влияние на снимки</span>
</h5>
<p>Если для файла отключено копирование при записи (NOCOW) и сделан <a href="#%D0%A1%D0%BD%D0%B8%D0%BC%D0%BA%D0%B8">снимок</a>, то первая запись в блок файла после создания снимка <a rel="nofollow" class="external text" href="https://www.spinics.net/lists/linux-btrfs/msg33090.html">будет COW-операцией</a>, поскольку снимок блокирует старые блоки файла на своих местах. Однако файл сохранит атрибут NOCOW, и все последующие записи будут выполняться в одни и те же блоки файла до момента создания следующего снимка.
</p>
<p>Частые снимки могут снизить эффективность NOCOW, так как при первой записи всё равно требуется COW. Чтобы полностью избежать COW-операций для таких файлов, поместите их в отдельный подтом и не создавайте снимки этого подтома.
</p>
<h3>
<span id=".D0.A1.D0.B6.D0.B0.D1.82.D0.B8.D0.B5"></span><span class="mw-headline" id="Сжатие">Сжатие</span>
</h3>
<p>Btrfs поддерживает <a rel="nofollow" class="external text" href="https://btrfs.readthedocs.io/en/latest/Compression.html">прозрачное и автоматическое сжатие</a>. Это уменьшает размер файлов, а также значительно увеличивает срок службы флеш-носителей благодаря уменьшению вызываемого записью износа. Смотрите <a href="https://fedoraproject.org/wiki/Changes/BtrfsByDefault#Compression" class="extiw" title="fedora:Changes/BtrfsByDefault">Fedora:Changes/BtrfsByDefault#Compression</a>, <a rel="nofollow" class="external autonumber" href="https://lists.fedoraproject.org/archives/list/devel@lists.fedoraproject.org/message/NTV77NFF6NDZM3QTPUM2TQZ5PCM6GOO2/">[2]</a> и <a rel="nofollow" class="external autonumber" href="https://pagure.io/fedora-btrfs/project/issue/36#comment-701551">[3]</a>. Это также может <a rel="nofollow" class="external text" href="https://www.phoronix.com/scan.php?page=article&amp;item=btrfs_compress_2635&amp;num=1">улучшить производительность</a> в одних случаях (например, однопоточные задачи с интенсивным файловым вводом-выводом), но в то же время ухудшить производительность в других случаях (например, многопоточные задачи и/или задачи с нагрузкой на процессор и большим файловым вводом-выводом). Более высокая производительность обычно достигается при использовании самых быстрых алгоритмов сжатия, <i>zstd</i> и <i>lzo</i>, и некоторые <a rel="nofollow" class="external text" href="https://www.phoronix.com/scan.php?page=article&amp;item=btrfs-zstd-compress">бенчмарки</a> предоставляют подробные сравнения.
</p>
<p>LZO имеет фиксированный уровень сжатия, в то время как zlib и zstd имеют диапазон уровней сжатия от 1 (слабое сжатие) до 9 (zlib) или 15 (zstd); смотрите <span class="plainlinks archwiki-template-man" title="$ man 5 btrfs"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/btrfs.5#COMPRESSION">btrfs(5) § COMPRESSION</a></span>. Изменение уровней по-разному влияет нагрузку процессора и пропускную способность ввода-вывода, поэтому стоит проверять производительность до и после изменения.
</p>
<p>Опция монтирования <code>compress=<i>алгоритм[:уровень]</i></code> позволяет включить сжатие, где <code><i>алгоритм</i></code> — это либо <code>zlib</code>, <code>lzo</code>, <code>zstd</code>, либо <code>no</code> (без сжатия). При использовании этой опции Btrfs будет проверять, помогает ли сжатие первой порции данных в файле сэкономить место. Если да, то весь файл будет сжат; если нет, то сжатие использоваться не будет. Таким образом, если размер первой порции записи не уменьшится при сжатии, то весь файл не будет сжат, даже если остальные порции сжимаются хорошо. <a rel="nofollow" class="external autonumber" href="https://btrfs.readthedocs.io/en/latest/Compression.html#incompressible-data">[4]</a>. Это сделано для того, чтобы не заставлять диск ждать начала записи, пока все записываемые данные не будут полностью переданы Btrfs и сжаты.
</p>
<p>Также можно использовать другую опцию монтирования <code>compress-force=<i>алгоритм[:уровень]</i></code>, которая заставляет Btrfs пропустить проверку сжимаемости первой порции данных и включает автоматическую попытку сжатия для каждого файла. В худшем случае это может привести к (незначительному) бесполезному увеличению загрузки процессора. Однако эмпирическое тестирование на нескольких системах смешанного использования показало значительное улучшение примерно на 10% сжатия диска при использовании <code>compress-force=<i>zstd</i></code> по сравнению с просто <code>compress=<i>zstd</i></code>, который также имел 10% сжатие диска. Однако имейте в виду, что принудительное сжатие не рекомендуется <a rel="nofollow" class="external text" href="https://btrfs.readthedocs.io/en/latest/Compression.html#incompressible-data">официальной документацией Btrfs</a>.
</p>
<p>Будут сжиматься только файлы, созданные или изменённые после добавления опции монтирования.
</p>
<p>Чтобы применить сжатие к существующим файлам, используйте команду <code>btrfs filesystem defragment -c<i>алгоритм</i></code>, где <code><i>алгоритм</i></code> — это <code>zlib</code>, <code>lzo</code> или <code>zstd</code>. Например, чтобы сжать всю файловую систему с помощью <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=zstd">zstd</a></span>, выполните следующую команду:
</p>
<pre># btrfs filesystem defragment -r -v -czstd /
</pre>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Важно:</strong> Дефрагментация файла, имеющего CoW-копию (либо снимок, либо копию, сделанную с помощью <code>cp</code> или bcp), плюс использование ключа <code>-c</code> с алгоритмом сжатия может привести к появлению двух не связанных друг с другом файлов, что приведёт к увеличению использования места на диске.</div>
<p>Чтобы включить сжатие при установке Arch на пустой раздел Btrfs, используйте опцию <code>compress</code> при <a href="../ru/File_systems.html#%D0%9C%D0%BE%D0%BD%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_%D1%84%D0%B0%D0%B9%D0%BB%D0%BE%D0%B2%D0%BE%D0%B9_%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D1%8B" title="File systems (Русский)">монтировании</a> файловой системы: <code>mount -o compress=zstd /dev/sd<i>xY</i> /mnt/</code>. Во время настройки свежеустановленной системы добавьте <code>compress=zstd</code> в опции монтирования корневой файловой системы в файле <a href="../ru/Fstab.html" title="Fstab (Русский)">fstab</a>.
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Совет:</strong> Сжатие также может быть включено для отдельных файлов без использования опции монтирования <code>compress</code>; для этого примените к файлу <code>chattr +c</code> <b>или</b> <code>btrfs property set <i>файл</i> compression <i>алгоритм</i></code>. Первая команда использует старый интерфейс атрибутов файлов, который унаследован от файловой системы ext2 и не является гибким, поэтому по умолчанию устанавливается сжатие <code>zlib</code>. Вторая команда устанавливает свойство файла с заданным алгоритмом (установка уровня сжатия таким способом пока не реализована). Если применить это к каталогу, то файлы, создаваемые в этом каталоге, будут автоматически сжиматься.</div>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Важно:</strong> 
<ul>
<li>Системы, использующие старые ядра или <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=btrfs-progs">btrfs-progs</a></span> без поддержки <code>zstd</code>, могут быть не в состоянии прочитать или восстановить вашу файловую систему, если вы используете эту опцию.</li>
<li>Поддержка <i>zstd</i> в <a href="../ru/GRUB.html" title="GRUB (Русский)">GRUB</a> появилась в версии 2.04. Убедитесь, что у вас обновлён код загрузчика, установленный в MBR/ESP, запустив <code>grub-install</code> с соответствующими опциями для вашей настройки BIOS/UEFI, поскольку это не выполняется автоматически. Смотрите <a rel="nofollow" class="external text" href="https://bugs.archlinux.org/task/63235">FS#63235</a>.</li>
</ul>
</div>
<h4>
<span id=".D0.9F.D1.80.D0.BE.D1.81.D0.BC.D0.BE.D1.82.D1.80_.D1.82.D0.B8.D0.BF.D0.BE.D0.B2_.D0.B8_.D0.BA.D0.BE.D1.8D.D1.84.D1.84.D0.B8.D1.86.D0.B8.D0.B5.D0.BD.D1.82.D0.BE.D0.B2_.D1.81.D0.B6.D0.B0.D1.82.D0.B8.D1.8F"></span><span class="mw-headline" id="Просмотр_типов_и_коэффициентов_сжатия">Просмотр типов и коэффициентов сжатия</span>
</h4>
<p><span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=compsize">compsize</a></span> берёт список файлов (или всю файловую систему Btrfs) и смотрит используемые типы сжатия и эффективные коэффициенты сжатия. Размер без сжатия может не совпадать с числом, выдаваемым другими программами, такими как <span class="plainlinks archwiki-template-man" title="$ man 1 du"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/du.1">du(1)</a></span>, потому что каждый экстент считается один раз, даже если на него есть несколько ссылок и даже если часть его больше нигде не используется, но ещё не была убрана при сборке мусора. Опция <code>-x</code> ограничивает анализ одной файловой системой, что полезно в ситуациях типа <code>compsize -x /</code>, чтобы предотвратить попытки программы просканировать не-Btrfs подкаталоги.
</p>
<h3>
<span id=".D0.9F.D0.BE.D0.B4.D1.82.D0.BE.D0.BC.D0.B0"></span><span class="mw-headline" id="Подтома">Подтома</span>
</h3>
<p>В Btrfs подтом (subvolume) не является блочным устройством (и не может рассматриваться как устройство); вместо этого можно рассматривать подтом Btrfs как пространство имён файлов POSIX. Доступ к этому пространству имён может осуществляться через подтом верхнего уровня, или он может быть смонтирован сам по себе. <a rel="nofollow" class="external autonumber" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/SysadminGuide.html#Subvolumes">[5]</a>
</p>
<p>Каждая файловая система Btrfs имеет подтом верхнего уровня с идентификатором 5, который нельзя удалить или заменить. Он всегда имеет внутренний путь <code>/</code>, а все остальные подтома <i>вложены</i> в подтом верхнего уровня. Подтома можно перемещать в файловой системе, и их пути могут измениться, а их ID неизменны.
</p>
<p>При монтировании файловой системы Btrfs по умолчанию монтируется подтом верхнего уровня. При желании вместо него можно <a href="#%D0%9C%D0%BE%D0%BD%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_%D0%BF%D0%BE%D0%B4%D1%82%D0%BE%D0%BC%D0%BE%D0%B2">смонтировать другой подтом</a>.
</p>
<p>Одно из основных применений подтомов — <a href="#%D0%A1%D0%BD%D0%B8%D0%BC%D0%BA%D0%B8">#Снимки</a>.
</p>
<p>Более подробную информацию можно найти по следующим ссылкам:
</p>
<ul>
<li><a rel="nofollow" class="external text" href="https://btrfs.readthedocs.io/en/latest/Subvolumes.html">Документация Btrfs</a></li>
<li><a rel="nofollow" class="external text" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/SysadminGuide.html#Subvolumes">Btrfs Wiki SysadminGuide#Subvolumes</a></li>
<li><a rel="nofollow" class="external text" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/Trees.html">Btrfs Wiki Trees</a></li>
</ul>
<h4>
<span id=".D0.A1.D0.BE.D0.B7.D0.B4.D0.B0.D0.BD.D0.B8.D0.B5_.D0.BF.D0.BE.D0.B4.D1.82.D0.BE.D0.BC.D0.B0"></span><span class="mw-headline" id="Создание_подтома">Создание подтома</span>
</h4>
<p>Для создания подтома файловая система Btrfs должна быть примонтирована. Последний аргумент команды будет названием подтома.
</p>
<pre># btrfs subvolume create <i>/путь/к/подтому</i>
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> Можно использовать опцию <code>--parents</code> для автоматического создания родительских каталогов, если они не существуют.</div>
<h4>
<span id=".D0.A1.D0.BF.D0.B8.D1.81.D0.BE.D0.BA_.D0.BF.D0.BE.D0.B4.D1.82.D0.BE.D0.BC.D0.BE.D0.B2"></span><span class="mw-headline" id="Список_подтомов">Список подтомов</span>
</h4>
<p>Чтобы просмотреть список текущих подтомов и их идентификаторы:
</p>
<pre># btrfs subvolume list -p <i>путь</i>
</pre>
<h4>
<span id=".D0.A3.D0.B4.D0.B0.D0.BB.D0.B5.D0.BD.D0.B8.D0.B5_.D0.BF.D0.BE.D0.B4.D1.82.D0.BE.D0.BC.D0.B0"></span><span class="mw-headline" id="Удаление_подтома">Удаление подтома</span>
</h4>
<p>Чтобы удалить подтом:
</p>
<pre># btrfs subvolume delete <i>/путь/к/подтому</i>
</pre>
<p>Также можно удалить подтом как обычный каталог командами вроде <code>rm -r</code> или <code>rmdir</code>.
</p>
<h4>
<span id=".D0.9C.D0.BE.D0.BD.D1.82.D0.B8.D1.80.D0.BE.D0.B2.D0.B0.D0.BD.D0.B8.D0.B5_.D0.BF.D0.BE.D0.B4.D1.82.D0.BE.D0.BC.D0.BE.D0.B2"></span><span class="mw-headline" id="Монтирование_подтомов">Монтирование подтомов</span>
</h4>
<p>Подтома можно монтировать как разделы файловой системы, используя флаги монтирования <code>subvol=<i>/путь/к/подтому</i></code> (путь указывается относительно подтома верхнего уровня) или <code>subvolid=<i>objectid</i></code>. Например, вы можете иметь подтом с именем <code>subvol_root</code> и монтировать его как <code>/</code>. Можно имитировать традиционные разделы файловой системы, создавая различные подтома на верхнем уровне файловой системы и затем монтируя их в соответствующих точках монтирования. Предпочтительнее монтировать, используя <code>subvol=<i>/путь/к/подтому</i></code>, а не через subvolid, поскольку subvolid может измениться при восстановлении из снимков, что потребует изменения настроек монтирования.
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Совет:</strong> Изменение компоновки подтомов можно упростить, если не использовать подтом верхнего уровня (ID=5) в качестве <code>/</code> (что делается по умолчанию). Вместо этого создайте подтом для хранения фактических данных и смонтируйте его как <code>/</code>.</div>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> Из <span class="plainlinks archwiki-template-man" title="$ man 5 btrfs"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/btrfs.5#MOUNT_OPTIONS">btrfs(5) § MOUNT OPTIONS</a></span>:
<dl><dd>Большинство опций монтирования применяются ко <b>всей файловой системе</b>, и иметь силу будут только опции первого монтируемого подтома. Это связано с ограничениями текущей реализации и может измениться в будущем.</dd></dl>
<p>В <a rel="nofollow" class="external text" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/FAQ.html#Can_I_mount_subvolumes_with_different_mount_options.3F">Btrfs Wiki FAQ</a> описано, какие опции монтирования можно применять для отдельных подтомов.
</p>
</div>
<p>Примеры схем файловых систем с использованием подтомов можно посмотреть здесь: <a href="../en/Snapper.html#Suggested_filesystem_layout" title="Snapper">Snapper#Suggested filesystem layout</a>, <a rel="nofollow" class="external text" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/SysadminGuide.html#Managing_Snapshots">Btrfs SysadminGuide#Managing Snapshots</a>, <a rel="nofollow" class="external text" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/SysadminGuide.html#Layout">SysadminGuide#Layout</a>.
</p>
<p>Полный список опций монтирования, специфичных для Btrfs, описан в man-странице <span class="plainlinks archwiki-template-man" title="$ man 5 btrfs"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/btrfs.5">btrfs(5)</a></span>.
</p>
<h4>
<span id=".D0.9C.D0.BE.D0.BD.D1.82.D0.B8.D1.80.D0.BE.D0.B2.D0.B0.D0.BD.D0.B8.D0.B5_.D0.BF.D0.BE.D0.B4.D1.82.D0.BE.D0.BC.D0.B0_.D0.B2_.D0.BA.D0.B0.D1.87.D0.B5.D1.81.D1.82.D0.B2.D0.B5_.D0.BA.D0.BE.D1.80.D0.BD.D1.8F"></span><span class="mw-headline" id="Монтирование_подтома_в_качестве_корня">Монтирование подтома в качестве корня</span>
</h4>
<p>Чтобы примонтировать определённый подтом как корневую файловую систему, <a href="#%D0%98%D0%B7%D0%BC%D0%B5%D0%BD%D0%B5%D0%BD%D0%B8%D0%B5_%D0%BF%D0%BE%D0%B4%D1%82%D0%BE%D0%BC%D0%B0_%D0%BF%D0%BE_%D1%83%D0%BC%D0%BE%D0%BB%D1%87%D0%B0%D0%BD%D0%B8%D1%8E">измените подтом, используемый по умолчанию</a>, или пропишите подтом в <a href="../ru/Kernel_parameters.html" class="mw-redirect" title="Параметры ядра">параметры ядра</a>: <code>rootflags=subvol=<i>/путь/к/подтому</i></code>. Отредактируйте корневую точку монтирования в <code>/etc/fstab</code>, добавив опцию монтирования <code>subvol=</code>. Также можно указать id подтома (<code>rootflags=subvolid=<i>objectid</i></code> как параметр ядра и <code>subvolid=<i>objectid</i></code> как опция монтирования в <code>/etc/fstab</code>). Лучше использовать <code>subvol=<i>/путь/к/подтому</i></code>, так как subvolid может меняться при восстановлении из снимков, что потребует изменения настроек монтирования, иначе система не сможет загрузиться.
</p>
<h4>
<span id=".D0.98.D0.B7.D0.BC.D0.B5.D0.BD.D0.B5.D0.BD.D0.B8.D0.B5_.D0.BF.D0.BE.D0.B4.D1.82.D0.BE.D0.BC.D0.B0_.D0.BF.D0.BE_.D1.83.D0.BC.D0.BE.D0.BB.D1.87.D0.B0.D0.BD.D0.B8.D1.8E"></span><span class="mw-headline" id="Изменение_подтома_по_умолчанию">Изменение подтома по умолчанию</span>
</h4>
<p>Если опция монтирования <code>subvol=</code> не указана, будет монтироваться подтом по умолчанию. Чтобы изменить подтом, используемый по умолчанию, выполните команду:
</p>
<pre># btrfs subvolume set-default <i>subvolume-id</i> /
</pre>
<p>Чтобы найти <i>subvolume-id</i>, посмотрите <a href="#%D0%A1%D0%BF%D0%B8%D1%81%D0%BE%D0%BA_%D0%BF%D0%BE%D0%B4%D1%82%D0%BE%D0%BC%D0%BE%D0%B2">#Список подтомов</a>.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> После изменения подтома по умолчанию, если вы используете <a href="../ru/GRUB.html" title="GRUB (Русский)">GRUB</a>, вы должны снова запустить <code>grub-install</code>, чтобы загрузчик узнал об изменениях. Смотрите <a rel="nofollow" class="external text" href="https://bbs.archlinux.org/viewtopic.php?pid=1615373">эту тему на форуме</a>.</div>
<p>Изменение подтома по умолчанию с помощью <code>btrfs subvolume set-default</code> сделает верхний уровень файловой системы недоступным, хотя вы всё равно сможете примонтировать его с помощью опций монтирования <code>subvol=/</code> или <code>subvolid=5</code> <a rel="nofollow" class="external autonumber" href="https://btrfs.readthedocs.io/en/latest/Administration.html">[6]</a>.
</p>
<h3>
<span id=".D0.9A.D0.B2.D0.BE.D1.82.D1.8B"></span><span class="mw-headline" id="Квоты">Квоты</span>
</h3>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Важно:</strong> Qgroup ещё не стабильна, и сочетание квоты с очень большим количеством снимков подтомов может вызвать проблемы с производительностью, например, при удалении снимков. Кроме того, есть ещё несколько <a rel="nofollow" class="external text" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/Quota_support.html#Known_issues">известных проблем</a>.</div>
<p>Поддержка квот в Btrfs реализована на уровне подтомов с помощью групп квот, или qgroup: по умолчанию каждому подтому назначается группа квот в виде <i>0/subvolume_id</i>. Однако при желании можно создать группу квот с любым номером.
</p>
<p>Для использования групп квот необходимо сначала включить квоты командой
</p>
<pre># btrfs quota enable <i>путь</i>
</pre>
<p>С этого момента вновь созданные подтома будут контролироваться этими группами.
Чтобы ретроспективно включить их для уже существующих подтомов, включите квоты как обычно, а затем создайте группу квот (qgroup) для каждого из этих подтомов, используя их <i>subvolume_id</i>, после чего просканируйте их:
</p>
<pre># btrfs subvolume list <i>путь</i> | cut -d' ' -f2 | xargs -I{} -n1 btrfs qgroup create 0/{} <i>путь</i>
# btrfs quota rescan <i>путь</i>
</pre>
<p>Группы квот в Btrfs образуют древовидную иерархию, в которой группы квот прикреплены к подтомам. Ограничения на размер устанавливаются для каждой группы квот и применяются при достижении любого предела в дереве, содержащем данный подтом.
</p>
<p>Ограничения на группах квот могут применяться либо к общему использованию данных, либо к использованию данных, которые не используются в других подтомах (уникальных данных, unshared), либо к использованию сжатых данных, либо к обоим. Копирование и удаление файлов могут влиять на лимиты, так как в других группах квот может измениться размер уникальных данных, если после удаления осталась единственная копия. Например, у свежего снимка почти все блоки общие с исходным подтомом, запись новых данных в любой из подтомов будет увеличивать размер уникальных данных в нём, и удаление общих данных в одном подтоме тоже увеличит размер уникальных данных в другом подтоме.
</p>
<p>Чтобы применить ограничение к группе квот, используйте команду <code>btrfs qgroup limit</code>. В зависимости от использования вы можете использовать либо общий лимит, либо лимит на уникальные данные (<code>-e</code>), либо лимит на сжатые данные (<code>-c</code>).
Чтобы посмотреть использование и лимиты для заданного пути в файловой системе, используйте
</p>
<pre># btrfs qgroup show -reF <i>путь</i>
</pre>
<h3>
<span id=".D0.98.D0.BD.D1.82.D0.B5.D1.80.D0.B2.D0.B0.D0.BB_.D0.B7.D0.B0.D0.BF.D0.B8.D1.81.D0.B8_.D0.BD.D0.B0_.D0.B4.D0.B8.D1.81.D0.BA"></span><span class="mw-headline" id="Интервал_записи_на_диск">Интервал записи на диск</span>
</h3>
<p>Периодичность записи данных на диск диктуется самой Btrfs и общесистемными настройками. По умолчанию Btrfs устанавливает интервал между контрольными точками в 30 секунд, через который новые данные записываются на диск. Это можно изменить, добавив опцию монтирования <code>commit</code> в <code>/etc/fstab</code> для раздела Btrfs.
</p>
<pre>LABEL=arch64 / btrfs defaults,compress=zstd,commit=120 0 0
</pre>
<p>Общесистемные настройки также влияют на этот интервал. Это включает в себя файлы в <code>/proc/sys/vm/*</code> и выходит за рамки данной вики-статьи. Документация ядра о них доступна по адресу <a rel="nofollow" class="external free" href="https://docs.kernel.org/admin-guide/sysctl/vm.html">https://docs.kernel.org/admin-guide/sysctl/vm.html</a>.
</p>
<h3><span class="mw-headline" id="SSD_TRIM">SSD TRIM</span></h3>
<p>Файловая система Btrfs может освобождать неиспользуемые блоки с твердотельного накопителя, поддерживающего команду TRIM. Поддерживается асинхронный discard, который доступен в виде опции монтирования <code>discard=async</code> и включен по умолчанию в <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=linux">linux</a></span> 6.2. Незанятые экстенты не освобождаются сразу, а группируются и освобождаются позже в отдельном потоке, что улучшает задержки при записи на диск.
</p>
<p>Асинхронный discard можно безопасно использовать вместе с периодическим TRIM <a rel="nofollow" class="external autonumber" href="https://lists.fedoraproject.org/archives/list/devel@lists.fedoraproject.org/thread/MLZIPQUXMJFRVSFJS6B2ACDKTYNSX3AX/">[7]</a>.
</p>
<p>Дополнительная информация о включении и использовании TRIM есть в разделе <a href="../ru/Solid_state_drive.html#TRIM" class="mw-redirect" title="Твердотельные накопители">Твердотельные накопители#TRIM</a>.
</p>
<h2>
<span id=".D0.98.D1.81.D0.BF.D0.BE.D0.BB.D1.8C.D0.B7.D0.BE.D0.B2.D0.B0.D0.BD.D0.B8.D0.B5"></span><span class="mw-headline" id="Использование">Использование</span>
</h2>
<h3>
<span id=".D0.A4.D0.B0.D0.B9.D0.BB_.D0.BF.D0.BE.D0.B4.D0.BA.D0.B0.D1.87.D0.BA.D0.B8"></span><span class="mw-headline" id="Файл_подкачки">Файл подкачки</span>
</h3>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> Не поддерживаются файлы подкачки на файловых системах, которые охватывают несколько устройств; подробнее об ограничениях можно почитать в <span class="plainlinks archwiki-template-man" title="$ man 5 btrfs"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/btrfs.5#SWAPFILE_SUPPORT">btrfs(5) § SWAPFILE SUPPORT</a></span>.</div>
<p>Правильный способ инициализации файла подкачки — сначала создать подтом, который <i>не будет использоваться для снимков</i>, и уже внутри него создать файл:
</p>
<pre># btrfs subvolume create /swap
</pre>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Совет:</strong> Рассмотрите возможность создания подтома непосредственно под подтомом верхнего уровня, например <code>@swap</code>. Затем убедитесь, что <a href="#%D0%9C%D0%BE%D0%BD%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_%D0%BF%D0%BE%D0%B4%D1%82%D0%BE%D0%BC%D0%BE%D0%B2">подтом смонтирован</a> в <code>/swap</code> (или любое другое доступное место).</div>
<p>Создайте файл подкачки:
</p>
<pre># btrfs filesystem mkswapfile --size 4g --uuid clear /swap/swapfile
</pre>
<p>Без опции <code>--size</code> по умолчанию будет создан файл размером 2 ГиБ.
</p>
<p>Включите файл подкачки:
</p>
<pre># swapon /swap/swapfile
</pre>
<p>Наконец, отредактируйте файл <a href="../ru/Fstab.html" title="Fstab (Русский)">fstab</a>, добавив в него новую запись для этого файла подкачки:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/fstab</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">/swap/swapfile none swap defaults 0 0
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> Также можно создать файл подкачки вручную, <a href="#%D0%9E%D1%82%D0%BA%D0%BB%D1%8E%D1%87%D0%B5%D0%BD%D0%B8%D0%B5_CoW">отключив CoW</a> для него и выполнив шаги, описанные в разделе <a href="../ru/Swap.html#%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D1%84%D0%B0%D0%B9%D0%BB%D0%B0_%D0%BF%D0%BE%D0%B4%D0%BA%D0%B0%D1%87%D0%BA%D0%B8" class="mw-redirect" title="Файл подкачки">Файл подкачки#Создание файла подкачки</a>. Альтернативный метод описан в <span class="plainlinks archwiki-template-man" title="$ man 5 btrfs"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/btrfs.5#SWAPFILE_SUPPORT">btrfs(5) § SWAPFILE SUPPORT</a></span>.</div>
<p>Чтобы использовать файл подкачки для гибернации, вам может понадобиться выполнить действия, описанные в статье <a href="../ru/Power_management/Suspend_and_hibernate.html" class="mw-redirect" title="Ждущий и спящий режимы">Ждущий и спящий режимы</a>.
</p>
<h3>
<span id=".D0.9E.D1.82.D0.BE.D0.B1.D1.80.D0.B0.D0.B6.D0.B5.D0.BD.D0.B8.D0.B5_.D0.B7.D0.B0.D0.BD.D1.8F.D1.82.D0.BE.D0.B3.D0.BE.2F.D1.81.D0.B2.D0.BE.D0.B1.D0.BE.D0.B4.D0.BD.D0.BE.D0.B3.D0.BE_.D0.BC.D0.B5.D1.81.D1.82.D0.B0"></span><span class="mw-headline" id="Отображение_занятого/свободного_места">Отображение занятого/свободного места</span>
</h3>
<p>Стандартные пользовательские инструменты linux, такие как <span class="plainlinks archwiki-template-man" title="$ man 1 df"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/df.1">df(1)</a></span>, будут неточно отображать свободное пространство на разделе Btrfs. Рекомендуется использовать <code>btrfs filesystem usage</code> для чтения информации о разделах Btrfs. Например, для получения полной статистики:
</p>
<pre># btrfs filesystem usage <i>/точка/монтирования</i>
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> Команда <code>btrfs filesystem usage</code> в настоящее время работает некорректно с <code>RAID5/RAID6</code>.</div>
<p>В качестве альтернативы, <code>btrfs filesystem df</code> позволяет быстро проверить использование выделенного пространства без необходимости запуска от имени root:
</p>
<pre>$ btrfs filesystem df <i>/точка/монтирования</i>
</pre>
<p>Смотрите <a rel="nofollow" class="external autonumber" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/FAQ.html#How_much_free_space_do_I_have.3F">[8]</a> для более подробной информации.
</p>
<p>Те же ограничения относятся к инструментам, анализирующим использование места в подмножестве файловой системы, таким как <span class="plainlinks archwiki-template-man" title="$ man 1 du"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/du.1">du(1)</a></span> или <span class="plainlinks archwiki-template-man" title="$ man 1 ncdu"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/ncdu.1">ncdu(1)</a></span>, поскольку они не учитывают ссылки, снимки и сжатие. Вместо них используйте альтернативы с подержкой Btrfs — <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/btdu/">btdu</a></span><sup><small>AUR</small></sup> и <a href="#%D0%9F%D1%80%D0%BE%D1%81%D0%BC%D0%BE%D1%82%D1%80_%D1%82%D0%B8%D0%BF%D0%BE%D0%B2_%D0%B8_%D0%BA%D0%BE%D1%8D%D1%84%D1%84%D0%B8%D1%86%D0%B8%D0%B5%D0%BD%D1%82%D0%BE%D0%B2_%D1%81%D0%B6%D0%B0%D1%82%D0%B8%D1%8F">compsize</a>.
</p>
<h3>
<span id=".D0.94.D0.B5.D1.84.D1.80.D0.B0.D0.B3.D0.BC.D0.B5.D0.BD.D1.82.D0.B0.D1.86.D0.B8.D1.8F"></span><span class="mw-headline" id="Дефрагментация">Дефрагментация</span>
</h3>
<p>Btrfs поддерживает онлайн-дефрагментацию, которую можно включить опцией монтирования <code>autodefrag</code>, смотрите <span class="plainlinks archwiki-template-man" title="$ man 5 btrfs"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/btrfs.5#MOUNT_OPTIONS">btrfs(5) § MOUNT OPTIONS</a></span>. Чтобы вручную запустить дефрагментацию корневой файловой системы, используйте:
</p>
<pre># btrfs filesystem defragment -r /
</pre>
<p>Использование этой команды без ключа <code>-r</code> приведёт к дефрагментации только метаданных, хранящихся в указанном подтоме. Это позволяет дефрагментировать один файл, просто указав путь.
</p>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Важно:</strong> Дефрагментация файла, имеющего CoW-копию (либо снимок, либо копию, созданную с помощью <code>cp</code> или bcp), плюс использование переключателя <code>-c</code> с алгоритмом сжатия может привести к появлению двух не связанных друг с другом файлов, что приведёт к увеличению использования места на диске.</div>
<h3><span class="mw-headline" id="RAID">RAID</span></h3>
<p><a href="#%D0%A4%D0%B0%D0%B9%D0%BB%D0%BE%D0%B2%D0%B0%D1%8F_%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D0%B0_%D0%BD%D0%B0_%D0%BD%D0%B5%D1%81%D0%BA%D0%BE%D0%BB%D1%8C%D0%BA%D0%B8%D1%85_%D1%83%D1%81%D1%82%D1%80%D0%BE%D0%B9%D1%81%D1%82%D0%B2%D0%B0%D1%85">#Файловая система на нескольких устройствах</a> может использовать «RAID». Примечательными особенностями, которые отличают Btrfs RAID от <a href="../en/RAID.html" class="mw-redirect" title="RAID (Русский)">mdadm</a>, являются самовосстанавливающиеся избыточные массивы и онлайн-балансировка. Дополнительная информация доступна на <a rel="nofollow" class="external text" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/Using_Btrfs_with_Multiple_Devices.html">вики-странице Btrfs</a>. В Btrfs sysadmin page также <a rel="nofollow" class="external text" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/SysadminGuide.html#RAID_and_data_replication">есть раздел</a> с более подробной технической информацией.
</p>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Важно:</strong> В коде Parity RAID (RAID 5/6) есть несколько серьёзных ошибок, приводящих к потере данных. Более подробную информацию смотрите на <a rel="nofollow" class="external text" href="https://btrfs.readthedocs.io/en/latest/btrfs-man5.html#raid56-status-and-recommended-practices">странице RAID5/6</a> в документации Btrfs и в сообщении об ошибке в <a rel="nofollow" class="external text" href="https://lore.kernel.org/linux-btrfs/8695beeb-f991-28c4-cf6b-8c92339e468f@inwind.it/">linux-btrfs mailing list</a>. В июне 2020 года был опубликован <a rel="nofollow" class="external text" href="https://lore.kernel.org/linux-btrfs/20200627030614.GW10769@hungrycats.org/">полный список текущих проблем</a> и <a rel="nofollow" class="external text" href="https://lore.kernel.org/linux-btrfs/20200627032414.GX10769@hungrycats.org/">полезное руководство по восстановлению</a>.</div>
<h4><span class="mw-headline" id="Scrub">Scrub</span></h4>
<p>В <a rel="nofollow" class="external text" href="https://btrfs.readthedocs.io/en/latest/Glossary.html">Btrfs Wiki Glossary</a> говорится, что Btrfs scrub — это «онлайн-инструмент проверки файловой системы. Считывает все данные и метаданные в файловой системе, использует контрольные суммы и дубликаты копий из RAID-хранилища для выявления и восстановления повреждённых данных».
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> Запущенный процесс scrub помешает уходу системы в сон, подробнее в <a rel="nofollow" class="external text" href="https://lore.kernel.org/linux-btrfs/20140227190656.GA28338@merlins.org/">этой теме</a>.</div>
<h5>
<span id=".D0.97.D0.B0.D0.BF.D1.83.D1.81.D0.BA_.D0.B2.D1.80.D1.83.D1.87.D0.BD.D1.83.D1.8E"></span><span class="mw-headline" id="Запуск_вручную">Запуск вручную</span>
</h5>
<p>Чтобы запустить scrub в фоне:
</p>
<pre># btrfs scrub start /
</pre>
<p>Чтобы проверить состояние scrub, работающего в фоне:
</p>
<pre># btrfs scrub status /
</pre>
<h5>
<span id=".D0.97.D0.B0.D0.BF.D1.83.D1.81.D0.BA_.D1.81_.D0.BF.D0.BE.D0.BC.D0.BE.D1.89.D1.8C.D1.8E_.D1.81.D0.BB.D1.83.D0.B6.D0.B1.D1.8B_.D0.B8.D0.BB.D0.B8_.D1.82.D0.B0.D0.B9.D0.BC.D0.B5.D1.80.D0.B0"></span><span class="mw-headline" id="Запуск_с_помощью_службы_или_таймера">Запуск с помощью службы или таймера</span>
</h5>
<p>Пакет <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=btrfs-progs">btrfs-progs</a></span> предоставляет юнит <code>btrfs-scrub@.timer</code>, запускающий ежемесячную проверку указанной точки монтирования. <a href="../ru/Help:Reading.html#%D0%A3%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5_%D1%8E%D0%BD%D0%B8%D1%82%D0%B0%D0%BC%D0%B8_systemd" class="mw-redirect" title="Включите">Включите</a> таймер, указав экранированный путь, например, <code>btrfs-scrub@-.timer</code> для <code>/</code> и <code>btrfs-scrub@home.timer</code> для <code>/home</code>. Вы можете использовать <code>systemd-escape -p <i>/путь/к/точке/монтирования</i></code> для экранирования пути, подробности смотрите в <span class="plainlinks archwiki-template-man" title="$ man 1 systemd-escape"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/systemd-escape.1">systemd-escape(1)</a></span>.
</p>
<p>Вы также можете <a href="../ru/Help:Reading.html#%D0%A3%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5_%D1%8E%D0%BD%D0%B8%D1%82%D0%B0%D0%BC%D0%B8_systemd" class="mw-redirect" title="Запустить">запустить</a> scrub через службу <code>btrfs-scrub@.service</code> (тоже указав экранированный путь). Преимущество этого способа перед простым запуском команды <code>btrfs scrub</code> (от имени root) в том, что результаты проверки будут записаны в <a href="../ru/Systemd/Journal.html" title="Systemd (Русский)/Journal (Русский)">журнал systemd</a>.
</p>
<p>На больших NVMe-дисках с недостаточным охлаждением (например, в ноутбуке) scrub может считывать данные достаточно быстро и долго, чтобы диск сильно нагрелся. Если вы запускаете scrub с помощью systemd, вы можете легко ограничить скорость проверки с помощью опции <code>IOReadBandwidthMax</code>, описанной в <span class="plainlinks archwiki-template-man" title="$ man 5 systemd.resource-control"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/systemd.resource-control.5">systemd.resource-control(5)</a></span>, используя <a href="../ru/Systemd.html#Drop-in_%D1%84%D0%B0%D0%B9%D0%BB%D1%8B" class="mw-redirect" title="Drop-in файл">drop-in файл</a>.
</p>
<h4>
<span id=".D0.91.D0.B0.D0.BB.D0.B0.D0.BD.D1.81.D0.B8.D1.80.D0.BE.D0.B2.D0.BA.D0.B0"></span><span class="mw-headline" id="Балансировка">Балансировка</span>
</h4>
<p>«Балансировка повторно пропускает все данные в файловой системе через аллокатор. В первую очередь он предназначен для перебалансировки данных в файловой системе между устройствами, когда устройство добавляется или удаляется. Балансировка восстанавливает недостающие копии для избыточных уровней RAID, если устройство вышло из строя». <a rel="nofollow" class="external autonumber" href="https://btrfs.readthedocs.io/en/latest/Glossary.html">[9]</a> Смотрите <a rel="nofollow" class="external text" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/FAQ.html#What_does_.22balance.22_do.3F">Btrfs FAQ</a>.
</p>
<p>В файловой системе с одним устройством балансировка может быть также полезна для (временного) уменьшения количества выделенных, но неиспользуемых (мета)чанков данных. Иногда это необходимо для решения <a rel="nofollow" class="external text" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/FAQ.html#Help.21_Btrfs_claims_I.27m_out_of_space.2C_but_it_looks_like_I_should_have_lots_left.21">проблем «filesystem full»</a>.
</p>
<pre># btrfs balance start --bg /
# btrfs balance status /
</pre>
<h3>
<span id=".D0.A1.D0.BD.D0.B8.D0.BC.D0.BA.D0.B8"></span><span class="mw-headline" id="Снимки">Снимки</span>
</h3>
<p>«Снимок (снапшот) — это просто подтом, который имеет общие данные (и метаданные) с другим подтомом, используя возможности COW в Btrfs». (<a rel="nofollow" class="external text" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/SysadminGuide.html#Snapshots">Btrfs Wiki SysadminGuide</a>)
</p>
<p>Создание снимка:
</p>
<pre># btrfs subvolume snapshot <i>источник</i> [<i>назначение</i>/]<i>название</i>
</pre>
<p>Для создания снимка, доступного только для чтения, добавьте флаг <code>-r</code>. Чтобы из снимка, доступного только для чтения, создать его версию, доступную для записи, просто создайте его снимок.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> 
<ul>
<li>Можно преобразовать снимок, доступный только для чтения, в снимок с возможностью записи командой <code>btrfs property set -f -ts '/путь/к/снимку' ro false</code>. Однако это не рекомендуется, поскольку это <a rel="nofollow" class="external text" href="https://lore.kernel.org/linux-btrfs/06e92a0b-e71b-eb21-edb5-9d2a5513b718@gmail.com/">вызывает проблемы</a> с любой будущей инкрементной отправкой/получением. Создание нового снимка с возможностью записи предотвращает такие проблемы.</li>
<li>Снимки не являются рекурсивными. Каждый вложенный подтом будет пустым каталогом внутри снимка.</li>
</ul>
</div>
<h3>
<span id=".D0.9E.D1.82.D0.BF.D1.80.D0.B0.D0.B2.D0.BA.D0.B0.2F.D0.BF.D0.BE.D0.BB.D1.83.D1.87.D0.B5.D0.BD.D0.B8.D0.B5"></span><span class="mw-headline" id="Отправка/получение">Отправка/получение</span>
</h3>
<p>Подтом может быть отправлен в стандартный вывод или в файл с помощью команды <code>send</code>. Обычно это используется для передачи в btrfs-команду <code>receive</code>. Например, для отправки снимка с именем <code>/root_backup</code> (это может быть снимок, который вы сделали ранее из <code>/</code>) в <code>/backup</code>, можно выполнить следующую команду:
</p>
<pre># btrfs send /root_backup | btrfs receive /backup
</pre>
<p>Отправляемый снимок <i>должен</i> быть доступен только для чтения. Приведённая выше команда полезна для копирования подтома на внешнее устройство (например, USB-диск, смонтированный по адресу <code>/backup</code> выше).
</p>
<p>На принимающей стороне подтом будет создан автоматически; создавать его вручную не нужно.
</p>
<p>Другой пример, который создаёт <code>/mnt/arch-v2/subvolumes/@var</code>:
</p>
<pre># btrfs send --proto 2 --compressed-data '/mnt/arch/snapshots/@var' | btrfs receive '/mnt/arch-v2/subvolumes/'
</pre>
<p>Параметры <code>--proto 2</code> и <code>--compressed-data</code> позволяют передавать данные более эффективно (если они хранятся в сжатом виде).
</p>
<p>Вы также можете отправить только разницу между двумя снимками. Например, если вы уже отправили копию <code>root_backup</code> выше и сделали новый снимок, доступный только для чтения, с именем <code>root_backup_new</code>, то для отправки только изменённых данных в <code>/backup</code> можно выполнить следующую команду:
</p>
<pre># btrfs send -p /root_backup /root_backup_new | btrfs receive /backup
</pre>
<p>После этого в <code>/backup</code> появится новый подтом <code>root_backup_new</code>.
</p>
<p>Смотрите <a rel="nofollow" class="external text" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/Incremental_Backup.html">статью Incremental Backup на Btrfs Wiki</a> и раздел <a href="#%D0%98%D0%BD%D0%BA%D1%80%D0%B5%D0%BC%D0%B5%D0%BD%D1%82%D0%BD%D0%BE%D0%B5_%D1%80%D0%B5%D0%B7%D0%B5%D1%80%D0%B2%D0%BD%D0%BE%D0%B5_%D0%BA%D0%BE%D0%BF%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_%D0%BD%D0%B0_%D0%B2%D0%BD%D0%B5%D1%88%D0%BD%D0%B8%D0%B9_%D0%B4%D0%B8%D1%81%D0%BA">#Инкрементное резервное копирование на внешний диск</a> о том, как использовать это для инкрементного резервного копирования, и об инструментах, автоматизирующих этот процесс.
</p>
<h3>
<span id=".D0.94.D0.B5.D0.B4.D1.83.D0.BF.D0.BB.D0.B8.D0.BA.D0.B0.D1.86.D0.B8.D1.8F"></span><span class="mw-headline" id="Дедупликация">Дедупликация</span>
</h3>
<p>С помощью копирования при записи (CoW) Btrfs может копировать файлы или целые подтома без фактического копирования данных. Однако каждый раз, когда файл изменяется, создаётся новая полноценная копия. Дедупликация делает ещё один шаг вперед, определяя блоки данных с общими последовательностями и объединяя их в экстент с той же семантикой копирования при записи.
</p>
<p>Инструменты для дедупликации: <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=duperemove">duperemove</a></span> и <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=bees">bees</a></span>. Также может потребоваться просто дедуплицировать данные на уровне файлов, используя, например, <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=rmlint">rmlint</a></span>, <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/jdupes/">jdupes</a></span><sup><small>AUR</small></sup> или <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/dduper-git/">dduper-git</a></span><sup><small>AUR</small></sup>. Обзор возможностей этих программ и дополнительную информацию можно найти в <a rel="nofollow" class="external text" href="https://btrfs.readthedocs.io/en/latest/Deduplication.html">Btrfs Wiki</a>.
</p>
<h3>
<span id=".D0.98.D0.B7.D0.BC.D0.B5.D0.BD.D0.B5.D0.BD.D0.B8.D0.B5_.D1.80.D0.B0.D0.B7.D0.BC.D0.B5.D1.80.D0.B0"></span><span class="mw-headline" id="Изменение_размера">Изменение размера</span>
</h3>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Важно:</strong> Во избежание потери данных убедитесь, что вы сделали резервную копию данных перед изменением размера.</div>
<p>Вы можете увеличить файловую систему до максимального доступного пространства или указать точный размер. Убедитесь, что вы увеличили размер устройства или логического тома, прежде чем пытаться увеличить размер файловой системы.
При указании точного размера файловой системы убедитесь, что новый размер удовлетворяет следующим условиям:
</p>
<ul>
<li>Новый размер должен быть больше размера существующих данных; в противном случае произойдет потеря данных.</li>
<li>Новый размер должен быть равен или меньше текущего размера устройства, поскольку размер файловой системы не может выходить за пределы доступного пространства.</li>
</ul>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> Если вы планируете также уменьшить размер логического тома, на котором находится файловая система, убедитесь, что вы уменьшили размер файловой системы до того, как попытаетесь уменьшить размер устройства или логического тома.</div>
<p>Чтобы увеличить размер файловой системы до максимально доступного размера устройства:
</p>
<pre># btrfs filesystem resize max /
</pre>
<p>Чтобы расширить файловую систему до указанного размера:
</p>
<pre># btrfs filesystem resize <i>размер</i> /
</pre>
<p>Замените <code><i>размер</i></code> на желаемый размер в байтах. Вы также можете указать единицу измерения, например K (кибибайты), M (мебибайты) или G (гибибайты). В качестве альтернативы можно указать увеличение или уменьшение текущего размера, дополнив значение знаком плюс (+) или минус (-) соответственно:
</p>
<pre># btrfs filesystem resize +<i>размер</i> /
# btrfs filesystem resize -<i>размер</i> /
</pre>
<h2>
<span id=".D0.98.D0.B7.D0.B2.D0.B5.D1.81.D1.82.D0.BD.D1.8B.D0.B5_.D0.BF.D1.80.D0.BE.D0.B1.D0.BB.D0.B5.D0.BC.D1.8B"></span><span class="mw-headline" id="Известные_проблемы">Известные проблемы</span>
</h2>
<p>Перед использованием Btrfs стоит узнать об имеющихся ограничениях.
</p>
<h3>
<span id=".D0.A8.D0.B8.D1.84.D1.80.D0.BE.D0.B2.D0.B0.D0.BD.D0.B8.D0.B5"></span><span class="mw-headline" id="Шифрование">Шифрование</span>
</h3>
<p>Btrfs не имеет встроенной поддержки шифрования, но это <a rel="nofollow" class="external text" href="https://lwn.net/Articles/700487/">может</a> появиться в будущем. Пользователи могут зашифровать раздел перед запуском <code>mkfs.btrfs</code>. Смотрите <a href="../en/Dm-crypt/Encrypting_an_entire_system.html" title="Dm-crypt/Encrypting an entire system">dm-crypt/Encrypting an entire system</a>.
</p>
<p>Существующие файловые системы Btrfs могут использовать что-то вроде <a href="../en/EncFS.html" class="mw-redirect" title="EncFS (Русский)">EncFS</a> или <a href="../en/VeraCrypt.html" title="VeraCrypt">VeraCrypt</a>, хотя, возможно, без некоторых возможностей Btrfs.
</p>
<h3>
<span id=".D0.9F.D1.80.D0.BE.D0.B1.D0.BB.D0.B5.D0.BC.D1.8B_.D0.BF.D1.80.D0.BE.D0.B2.D0.B5.D1.80.D0.BA.D0.B8_btrfs"></span><span class="mw-headline" id="Проблемы_проверки_btrfs">Проблемы проверки btrfs</span>
</h3>
<p>Инструмент <code>btrfs check</code> имеет известные проблемы и не должен запускаться без чтения дополнительной информации, смотрите раздел <a href="#%D0%9F%D1%80%D0%BE%D0%B2%D0%B5%D1%80%D0%BA%D0%B0_%D1%84%D0%B0%D0%B9%D0%BB%D0%BE%D0%B2%D0%BE%D0%B9_%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D1%8B">#Проверка файловой системы</a>.
</p>
<h2>
<span id=".D0.A1.D0.BE.D0.B2.D0.B5.D1.82.D1.8B_.D0.B8_.D1.80.D0.B5.D0.BA.D0.BE.D0.BC.D0.B5.D0.BD.D0.B4.D0.B0.D1.86.D0.B8.D0.B8"></span><span class="mw-headline" id="Советы_и_рекомендации">Советы и рекомендации</span>
</h2>
<h3>
<span id=".D0.94.D0.B8.D1.81.D0.BA_Btrfs_.D0.B1.D0.B5.D0.B7_.D1.80.D0.B0.D0.B7.D0.B4.D0.B5.D0.BB.D0.BE.D0.B2"></span><span class="mw-headline" id="Диск_Btrfs_без_разделов">Диск Btrfs без разделов</span>
</h3>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Важно:</strong> Такой тип установки не очень подходит для загрузочного устройства, поэтому вместо этого лучше настроить Btrfs на обычном разделе и дополнительно создать отдельный <a href="../ru/EFI_system_partition.html" class="mw-redirect" title="Системный раздел EFI">системный раздел EFI</a>. Кроме того, GRUB настоятельно не рекомендует установку на диск без разделов.</div>
<p>Btrfs можно разместить на всём устройстве целиком, без использования разметки разделов <a href="../ru/Partitioning.html#%D0%93%D0%BB%D0%B0%D0%B2%D0%BD%D0%B0%D1%8F_%D0%B7%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D0%BE%D1%87%D0%BD%D0%B0%D1%8F_%D0%B7%D0%B0%D0%BF%D0%B8%D1%81%D1%8C_(MBR)" title="Partitioning (Русский)">MBR</a> или <a href="../ru/Partitioning.html#%D0%A2%D0%B0%D0%B1%D0%BB%D0%B8%D1%86%D0%B0_%D1%80%D0%B0%D0%B7%D0%B4%D0%B5%D0%BB%D0%BE%D0%B2_GUID" title="Partitioning (Русский)">GPT</a>, используя <a href="#%D0%9F%D0%BE%D0%B4%D1%82%D0%BE%D0%BC%D0%B0">подтома</a> для имитации разделов. Однако отказываться от разделов не обязательно, достаточно просто <a href="#%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D1%84%D0%B0%D0%B9%D0%BB%D0%BE%D0%B2%D0%BE%D0%B9_%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D1%8B">создать файловую систему Btrfs</a> на существующем <a href="../ru/Partitioning.html" title="Partitioning (Русский)">разделе</a>, созданном обычным способом. Существуют некоторые ограничения при установке без разделов:
</p>
<ul>
<li>Невозможно разместить другие <a href="../ru/File_systems.html" class="mw-redirect" title="Файловые системы">файловые системы</a> на другом разделе того же диска.</li>
<li>В связи с предыдущим пунктом размещение <a href="../ru/EFI_system_partition.html" title="EFI system partition (Русский)">системного раздела EFI</a> на этом диске невозможно. Для загрузки с <a href="../ru/Unified_Extensible_Firmware_Interface.html" title="Unified Extensible Firmware Interface (Русский)">UEFI</a> необходимо другое устройство.</li>
</ul>
<p>Чтобы удалить существующую таблицу разделов и вместо неё записать файловую систему Btrfs, выполните следующую команду:
</p>
<pre># mkfs.btrfs /dev/sd<i>X</i>
</pre>
<p>Указывайте путь к устройству целиком (например, <code>/dev/sda</code>), а не к отдельному разделу (<code>/dev/sda1</code>). Второй вариант отформатирует лишь указанный раздел, а не заменит всю разметку. Поскольку корневым разделом является Btrfs, убедитесь, что <code>btrfs</code> скомпилирован в ядро, или поместите <code>btrfs</code> в <a href="../ru/Mkinitcpio.html#MODULES" title="Mkinitcpio (Русский)">mkinitcpio MODULES</a> и <a href="../ru/Mkinitcpio.html#%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D0%B7%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D0%BE%D1%87%D0%BD%D0%BE%D0%B3%D0%BE_%D0%BE%D0%B1%D1%80%D0%B0%D0%B7%D0%B0" title="Mkinitcpio (Русский)">пересоберите образ initramfs</a>.
</p>
<p>Установите <a href="../ru/Arch_boot_process.html#%D0%97%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D1%87%D0%B8%D0%BA" class="mw-redirect" title="Загрузчик">загрузчик</a> как на <a href="../ru/Partitioning.html#%D0%93%D0%BB%D0%B0%D0%B2%D0%BD%D0%B0%D1%8F_%D0%B7%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D0%BE%D1%87%D0%BD%D0%B0%D1%8F_%D0%B7%D0%B0%D0%BF%D0%B8%D1%81%D1%8C_(MBR)" title="Partitioning (Русский)">MBR</a>-устройство. Смотрите <a href="../ru/Syslinux.html#%D0%A0%D1%83%D1%87%D0%BD%D0%B0%D1%8F_%D1%83%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0" title="Syslinux (Русский)">Syslinux (Русский)#Ручная установка</a> или <a href="../ru/GRUB.html#%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0_BIOS-%D0%B2%D0%B5%D1%80%D1%81%D0%B8%D0%B8_%D0%B7%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D1%87%D0%B8%D0%BA%D0%B0" title="GRUB (Русский)">GRUB (Русский)#Установка BIOS-версии загрузчика</a>. Если ядро не загружается с ошибкой <code>Failed to mount /sysroot.</code>, добавьте <code>GRUB_PRELOAD_MODULES="btrfs"</code> в <code>/etc/default/grub</code> и <a href="../ru/GRUB.html#%D0%90%D0%B2%D1%82%D0%BE%D0%BC%D0%B0%D1%82%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B0%D1%8F_%D0%BA%D0%BE%D0%BD%D1%84%D0%B8%D0%B3%D1%83%D1%80%D0%B0%D1%86%D0%B8%D1%8F_(grub-mkconfig)" title="GRUB (Русский)">пересоздайте файл настроек GRUB</a>.
</p>
<h3>
<span id=".D0.9F.D1.80.D0.B5.D0.BE.D0.B1.D1.80.D0.B0.D0.B7.D0.BE.D0.B2.D0.B0.D0.BD.D0.B8.D0.B5_Ext3.2F4_.D0.B2_Btrfs"></span><span class="mw-headline" id="Преобразование_Ext3/4_в_Btrfs">Преобразование Ext3/4 в Btrfs</span>
</h3>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Важно:</strong> В списке рассылки btrfs есть много сообщений о некорректном преобразовании. Убедитесь, что у вас есть <i>рабочие</i> резервные копии всех данных, которые вы не можете позволить себе потерять. Смотрите страницу <a rel="nofollow" class="external text" href="https://btrfs.readthedocs.io/en/latest/Convert.html">Convert</a> на Btrfs wiki для получения дополнительной информации.</div>
<p>Загрузитесь с установочного образа, а затем выполните конвертацию:
</p>
<pre># btrfs-convert /dev/<i>раздел</i>
</pre>
<p>Смонтируйте раздел и проверьте целостность файлов на преобразованном разделе. Обязательно измените <code>/etc/fstab</code>, чтобы отразить изменения (<b>type</b> на <code>btrfs</code> и <b>fs_passno</b> [последнее поле] на <code>0</code>, поскольку Btrfs не выполняет проверку файловой системы при загрузке). Также обратите внимание, что UUID раздела изменился, поэтому обновите fstab соответствующим образом при использовании UUID. Выполните <code>chroot</code> в систему и перенастройте загрузчик на использование преобразованного раздела (смотрите статью <a href="../ru/Install_Arch_Linux_from_existing_Linux.html" class="mw-redirect" title="Установка Arch из другого дистрибутива">Установка Arch из другого дистрибутива</a>). Если вы преобразуете корневую файловую систему, то, пока вы ещё в chroot, запустите <code>mkinitcpio -p linux</code> для пересоздания образа initramfs, иначе система не сможет успешно загрузиться.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> Если что-то пошло не так или не удалось смонтировать или записать файлы на недавно преобразованной файловой системе, всегда есть возможность отката, пока резервный подтом <code>/ext2_saved</code> всё ещё присутствует. Для отката используйте команду <code>btrfs-convert -r /dev/<i>раздел</i></code>, которая отменит все изменения в новой файловой системе Btrfs.</div>
<p>Убедившись в отсутствии проблем, завершите преобразование, удалив резервный подтом <code>ext2_saved</code>. Обратите внимание, что без него вы не сможете вернуться к ext3/4.
</p>
<pre># btrfs subvolume delete /ext2_saved
</pre>
<p>Наконец, выполните <a href="#%D0%91%D0%B0%D0%BB%D0%B0%D0%BD%D1%81%D0%B8%D1%80%D0%BE%D0%B2%D0%BA%D0%B0">балансировку</a>, чтобы перераспределить место.
</p>
<p>Помните, что некоторые приложения, которые были установлены ранее, должны быть адаптированы к Btrfs.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> Преобразование Ext3/4 в Btrfs — долгая операция. Например, для файловой системы 4 ТиБ на обычном HDD она может занять до 10 часов.</div>
<h3>
<span id=".D0.92.D0.BE.D1.81.D1.81.D1.82.D0.B0.D0.BD.D0.BE.D0.B2.D0.BB.D0.B5.D0.BD.D0.B8.D0.B5_.D0.BF.D0.BE.D0.B2.D1.80.D0.B5.D0.B6.D0.B4.D1.91.D0.BD.D0.BD.D0.BE.D0.B9_.D1.84.D0.B0.D0.B9.D0.BB.D0.BE.D0.B2.D0.BE.D0.B9_.D1.81.D0.B8.D1.81.D1.82.D0.B5.D0.BC.D1.8B"></span><span class="mw-headline" id="Восстановление_повреждённой_файловой_системы">Восстановление повреждённой файловой системы</span>
</h3>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Важно:</strong> Инструмент <code>btrfs check</code> имеет известные проблемы, смотрите раздел <a href="#%D0%9F%D1%80%D0%BE%D0%B2%D0%B5%D1%80%D0%BA%D0%B0_%D1%84%D0%B0%D0%B9%D0%BB%D0%BE%D0%B2%D0%BE%D0%B9_%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D1%8B">#Проверка файловой системы</a>.</div>
<p><i>btrfs-check</i> не может быть использован на смонтированной файловой системе. Чтобы иметь возможность использовать <i>btrfs-check</i> без загрузки с live USB, добавьте его в initramfs:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/mkinitcpio.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">BINARIES=(btrfs)</pre>
<p>Затем <a href="../ru/Mkinitcpio.html#%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D0%B7%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D0%BE%D1%87%D0%BD%D0%BE%D0%B3%D0%BE_%D0%BE%D0%B1%D1%80%D0%B0%D0%B7%D0%B0" title="Mkinitcpio (Русский)">пересоберите образ initramfs</a>.
</p>
<p>Теперь, когда возникнут проблемы с загрузкой, эта утилита будет доступна в initramfs и позволит выполнить восстановление.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> Если проверка вынуждена инвалидировать кэш пространства (и/или другие кэши?), то это нормально, если последующая загрузка зависнет на некоторое время (может появиться консольное сообщение о зависании btrfs-transaction). Система должна восстановиться после этого через некоторое время.</div>
<p>Дополнительная информация доступна в <span class="plainlinks archwiki-template-man" title="$ man 8 btrfs-check"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/btrfs-check.8">btrfs-check(8)</a></span>.
</p>
<h3>
<span id=".D0.97.D0.B0.D0.B3.D1.80.D1.83.D0.B7.D0.BA.D0.B0_.D0.B2_.D1.81.D0.BD.D0.B8.D0.BC.D0.BE.D0.BA"></span><span class="mw-headline" id="Загрузка_в_снимок">Загрузка в снимок</span>
</h3>
<p>Для загрузки в снимок применяется та же процедура, что и для монтирования подтома в качестве корневого раздела, как описано в разделе <a href="#%D0%9C%D0%BE%D0%BD%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_%D0%BF%D0%BE%D0%B4%D1%82%D0%BE%D0%BC%D0%B0_%D0%B2_%D0%BA%D0%B0%D1%87%D0%B5%D1%81%D1%82%D0%B2%D0%B5_%D0%BA%D0%BE%D1%80%D0%BD%D1%8F">#Монтирование подтома в качестве корня</a>, поскольку снимки можно монтировать как подтома.
</p>
<ul>
<li>При использовании <a href="../ru/GRUB.html" title="GRUB (Русский)">GRUB</a> вы можете автоматически добавить снимки Btrfs в меню загрузки при регенерации файла настроек с помощью <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=grub-btrfs">grub-btrfs</a></span> или <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/grub-btrfs-git/">grub-btrfs-git</a></span><sup><small>AUR</small></sup>.</li>
<li>При использовании <a href="../ru/REFInd.html" title="REFInd (Русский)">rEFInd</a> вы можете автоматически заполнить меню загрузчика снимками Btrfs с помощью <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/refind-btrfs/">refind-btrfs</a></span><sup><small>AUR</small></sup> после <a href="../ru/Systemd.html#%D0%98%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_%D1%8E%D0%BD%D0%B8%D1%82%D0%BE%D0%B2" title="Systemd (Русский)">включения</a> службы <code>refind-btrfs.service</code>.</li>
</ul>
<h3>
<span id=".D0.98.D1.81.D0.BF.D0.BE.D0.BB.D1.8C.D0.B7.D0.BE.D0.B2.D0.B0.D0.BD.D0.B8.D0.B5_.D0.BF.D0.BE.D0.B4.D1.82.D0.BE.D0.BC.D0.BE.D0.B2_Btrfs_.D0.B2_systemd-nspawn"></span><span class="mw-headline" id="Использование_подтомов_Btrfs_в_systemd-nspawn">Использование подтомов Btrfs в systemd-nspawn</span>
</h3>
<p>Смотрите <a href="../en/Systemd-nspawn.html#Use_Btrfs_subvolume_as_container_root" title="Systemd-nspawn">Systemd-nspawn#Use Btrfs subvolume as container root</a> и <a href="../en/Systemd-nspawn.html#Use_temporary_Btrfs_snapshot_of_container" title="Systemd-nspawn">Systemd-nspawn#Use temporary Btrfs snapshot of container</a>.
</p>
<h3>
<span id=".D0.A3.D0.BC.D0.B5.D0.BD.D1.8C.D1.88.D0.B5.D0.BD.D0.B8.D0.B5_.D1.87.D0.B0.D1.81.D1.82.D0.BE.D1.82.D1.8B_.D0.B7.D0.B0.D0.BF.D0.B8.D1.81.D0.B8_.D0.BC.D0.B5.D1.82.D0.B0.D0.B4.D0.B0.D0.BD.D0.BD.D1.8B.D1.85_.D0.BF.D1.80.D0.B8_.D0.BE.D0.B1.D0.BD.D0.BE.D0.B2.D0.BB.D0.B5.D0.BD.D0.B8.D0.B8_.D0.B2.D1.80.D0.B5.D0.BC.D0.B5.D0.BD.D0.B8_.D0.B4.D0.BE.D1.81.D1.82.D1.83.D0.BF.D0.B0"></span><span class="mw-headline" id="Уменьшение_частоты_записи_метаданных_при_обновлении_времени_доступа">Уменьшение частоты записи метаданных при обновлении времени доступа</span>
</h3>
<p>Из-за того, что Btrfs использует копирование при записи, простое чтение файла может вызвать копирование метаданных. Уменьшение частоты обновления времени доступа может устранить это непредвиденное использование диска и увеличить производительность. Опции монтирования, связанные с управлением временем доступа, описаны в разделе <a href="../ru/Fstab.html#%D0%9F%D0%B0%D1%80%D0%B0%D0%BC%D0%B5%D1%82%D1%80%D1%8B_atime" title="Fstab (Русский)">fstab (Русский)#Параметры atime</a>.
</p>
<h3>
<span id=".D0.98.D0.BD.D0.BA.D1.80.D0.B5.D0.BC.D0.B5.D0.BD.D1.82.D0.BD.D0.BE.D0.B5_.D1.80.D0.B5.D0.B7.D0.B5.D1.80.D0.B2.D0.BD.D0.BE.D0.B5_.D0.BA.D0.BE.D0.BF.D0.B8.D1.80.D0.BE.D0.B2.D0.B0.D0.BD.D0.B8.D0.B5_.D0.BD.D0.B0_.D0.B2.D0.BD.D0.B5.D1.88.D0.BD.D0.B8.D0.B9_.D0.B4.D0.B8.D1.81.D0.BA"></span><span class="mw-headline" id="Инкрементное_резервное_копирование_на_внешний_диск">Инкрементное резервное копирование на внешний диск</span>
</h3>
<p>Следующие пакеты используют <code>btrfs send</code> и <code>btrfs receive</code> для инкрементной отправки резервных копий на внешний диск. Обратитесь к их документации, чтобы увидеть различия в реализации, возможностях и требованиях.
</p>
<ul><li>
<b>btrbk</b> — Инструмент для создания снимков и удалённых резервных копий подтомов Btrfs.</li></ul>
<dl><dd>
<a rel="nofollow" class="external free" href="https://github.com/digint/btrbk">https://github.com/digint/btrbk</a> || <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=btrbk">btrbk</a></span>
</dd></dl>
<ul><li>
<b>snap-sync</b> — Использование снимков <a href="../en/Snapper.html" title="Snapper">Snapper</a> для резервного копирования на внешний диск или удалённую машину.</li></ul>
<dl><dd>
<a rel="nofollow" class="external free" href="https://github.com/wesbarnett/snap-sync">https://github.com/wesbarnett/snap-sync</a> || <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=snap-sync">snap-sync</a></span>
</dd></dl>
<ul><li>
<b>snapsync</b> — Инструмент синхронизации для <a href="../en/Snapper.html" title="Snapper">Snapper</a>.</li></ul>
<dl><dd>
<a rel="nofollow" class="external free" href="https://github.com/doudou/snapsync">https://github.com/doudou/snapsync</a> || <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/ruby-snapsync/">ruby-snapsync</a></span><sup><small>AUR</small></sup>
</dd></dl>
<p>Следующий пакет позволяет создавать резервные копии снимков snapper на файловые системы, отличные от Btrfs.
</p>
<ul><li>
<b>snapborg</b> — borgmatic-подобный инструмент, который интегрирует снимки snapper с резервными копиями <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=borg">borg</a></span>.</li></ul>
<dl><dd>
<a rel="nofollow" class="external free" href="https://github.com/enzingerm/snapborg">https://github.com/enzingerm/snapborg</a> || <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/snapborg/">snapborg</a></span><sup><small>AUR</small></sup>
</dd></dl>
<h3>
<span id=".D0.90.D0.B2.D1.82.D0.BE.D0.BC.D0.B0.D1.82.D0.B8.D1.87.D0.B5.D1.81.D0.BA.D0.B8.D0.B5_.D1.81.D0.BD.D0.B8.D0.BC.D0.BA.D0.B8"></span><span class="mw-headline" id="Автоматические_снимки">Автоматические снимки</span>
</h3>
<p>Для управления снимками Btrfs и автоматического их создания можно использовать менеджер снимков, например <a href="../en/Snapper.html" title="Snapper">Snapper</a>, <a href="../en/Timeshift.html" title="Timeshift">Timeshift</a> или <a href="../en/Yabsnap.html" title="Yabsnap">Yabsnap</a>.
</p>
<h2>
<span id=".D0.A0.D0.B5.D1.88.D0.B5.D0.BD.D0.B8.D0.B5_.D0.BF.D1.80.D0.BE.D0.B1.D0.BB.D0.B5.D0.BC"></span><span class="mw-headline" id="Решение_проблем">Решение проблем</span>
</h2>
<p>Смотрите также <a rel="nofollow" class="external text" href="https://btrfs.readthedocs.io/en/latest/trouble-index.html">Btrfs Troubleshooting pages</a> и <a rel="nofollow" class="external text" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/Problem_FAQ.html">Btrfs Problem FAQ</a>.
</p>
<h3><span class="mw-headline" id="GRUB">GRUB</span></h3>
<h4>
<span id=".D0.A1.D0.BC.D0.B5.D1.89.D0.B5.D0.BD.D0.B8.D0.B5_.D1.80.D0.B0.D0.B7.D0.B4.D0.B5.D0.BB.D0.B0"></span><span class="mw-headline" id="Смещение_раздела">Смещение раздела</span>
</h4>
<p>Проблема со смещением может возникнуть при попытке внедрить <code>core.img</code> в диск с разделами. Это означает, что <a href="../Special:Diff/319474.html" title="Special:Diff/319474">можно</a> внедрить <code>core.img</code> от GRUB в пул Btrfs на диске без разделов (например, <code>/dev/sd<i>X</i></code>) напрямую.
</p>
<p><a href="../ru/GRUB.html" title="GRUB (Русский)">GRUB</a> может загружать разделы Btrfs, однако модуль может быть больше, чем у других <a href="../ru/File_systems.html" title="File systems (Русский)">файловых систем</a>. В результате файл <code>core.img</code>, который создаёт <code>grub-install</code>, может не поместиться в первые 63 сектора (31.5KiB) диска между MBR и первым разделом. Современные инструменты разметки, такие как <code>fdisk</code> и <code>gdisk</code>, позволяют избежать этой проблемы, смещая первый раздел примерно на 1 или 2 МиБ.
</p>
<h4>
<span id=".D0.9A.D0.BE.D1.80.D0.BD.D0.B5.D0.B2.D0.B0.D1.8F_.D1.84.D0.B0.D0.B9.D0.BB.D0.BE.D0.B2.D0.B0.D1.8F_.D1.81.D0.B8.D1.81.D1.82.D0.B5.D0.BC.D0.B0_.D0.BD.D0.B5_.D0.BD.D0.B0.D0.B9.D0.B4.D0.B5.D0.BD.D0.B0"></span><span class="mw-headline" id="Корневая_файловая_система_не_найдена">Корневая файловая система не найдена</span>
</h4>
<p>Если возникает ошибка <code>error no such device: root</code> при загрузке с RAID-массива, то отредактируйте /usr/share/grub/grub-mkconfig_lib и уберите обе кавычки из строки <code>echo "  search --no-floppy --fs-uuid --set=root ${hints} ${fs_uuid}"</code>. Пересоздайте файл настроек GRUB, и после этого система должна загрузиться без ошибок.
</p>
<h3>
<span id=".D0.A2.D0.B0.D0.B9.D0.BC.D0.B0.D1.83.D1.82_.D0.BC.D0.BE.D0.BD.D1.82.D0.B8.D1.80.D0.BE.D0.B2.D0.B0.D0.BD.D0.B8.D1.8F"></span><span class="mw-headline" id="Таймаут_монтирования">Таймаут монтирования</span>
</h3>
<p>Иногда, особенно на больших массивах RAID1, монтирование может прерваться во время загрузки с подобным сообщением в журнале:
</p>
<pre>Jan 25 18:05:12 host systemd[1]: storage.mount: Mounting timed out. Terminating.
Jan 25 18:05:46 host systemd[1]: storage.mount: Mount process exited, code=killed, status=15/TERM
Jan 25 18:05:46 host systemd[1]: storage.mount: Failed with result 'timeout'.
Jan 25 18:05:46 host systemd[1]: Failed to mount /storage.
Jan 25 18:05:46 host systemd[1]: Startup finished in 32.943s (firmware) + 3.097s (loader) + 7.247s (kernel)&gt;
Jan 25 18:05:46 host kernel: BTRFS error (device sda): open_ctree failed</pre>
<p>Это можно легко обойти, установив более длительный таймаут с помощью специфичной для systemd опции монтирования <code>x-systemd.mount-timeout</code> в <a href="../ru/Fstab.html" title="Fstab (Русский)">fstab</a>. Например:
</p>
<pre>/dev/sda                /storage    btrfs       rw,relatime,x-systemd.mount-timeout=5min  0 0
</pre>
<h3><span class="mw-headline" id="BTRFS:_open_ctree_failed">BTRFS: open_ctree failed</span></h3>
<p>По состоянию на ноябрь 2014 года, похоже, существует ошибка в <a href="../ru/Systemd.html" title="Systemd (Русский)">systemd</a> или <a href="../ru/Mkinitcpio.html" title="Mkinitcpio (Русский)">mkinitcpio</a>, вызывающая следующую ошибку, если Btrfs размещён на нескольких устройствах и используется хук <code>btrfs</code> в <code>mkinitcpio.conf</code>:
</p>
<pre>BTRFS: open_ctree failed
mount: wrong fs type, bad option, bad superblock on /dev/sdb2, missing codepage or helper program, or other error

In some cases useful info is found in syslog - try dmesg|tail or so.

You are now being dropped into an emergency shell.
</pre>
<p>Обходным решением является удаление <code>btrfs</code> из массива <code>HOOKS</code> в <code>/etc/mkinitcpio.conf</code> и добавление <code>btrfs</code> в массив <code>MODULES</code>. Затем <a href="../ru/Mkinitcpio.html#%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D0%B7%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D0%BE%D1%87%D0%BD%D0%BE%D0%B3%D0%BE_%D0%BE%D0%B1%D1%80%D0%B0%D0%B7%D0%B0" title="Mkinitcpio (Русский)">пересоберите образ initramfs</a> и перезагрузитесь.
</p>
<p>Вы получите ту же ошибку, если попытаетесь смонтировать raid-массив без одного из устройств. В этом случае необходимо добавить опцию монтирования <code>degraded</code> в <code>/etc/fstab</code>. Если в массиве находится корневая файловая система, вы также должны добавить <code>rootflags=degraded</code> в <a href="../ru/Kernel_parameters.html" class="mw-redirect" title="Параметры ядра">параметры ядра</a>.
</p>
<p>По состоянию на август 2016 года потенциальным обходным решением этой ошибки является монтирование массива только по одному диску в <code>/etc/fstab</code> и разрешение Btrfs обнаруживать и добавлять остальные диски автоматически. Похоже, что сбою способствуют групповые идентификаторы, такие как UUID и LABEL. Например, массив RAID1 из двух устройств, состоящий из 'disk1' и disk2', будет иметь присвоенный ему UUID, но вместо UUID будет использоваться только <code>/dev/mapper/disk1</code> в <code>/etc/fstab</code>. Более подробное объяснение смотрите в <a rel="nofollow" class="external text" href="https://web.archive.org/web/20161108175034/http://blog.samcater.com/fix-for-btrfs-open_ctree-failed-when-running-root-fs-on-raid-1-or-raid10-arch-linux/">этой статье</a>.
</p>
<p>Другим возможным обходным решением является удаление хука <code>udev</code> в <a href="../ru/Mkinitcpio.html#%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0" title="Mkinitcpio (Русский)">mkinitcpio.conf</a> и замена его хуком <code>systemd</code>. В этом случае <code>btrfs</code> <i>не</i> должен находиться в массивах <code>HOOKS</code> или <code>MODULES</code>.
</p>
<p>Смотрите <a rel="nofollow" class="external text" href="https://bbs.archlinux.org/viewtopic.php?id=189845">тему на форуме</a> и <a rel="nofollow" class="external text" href="https://bugs.archlinux.org/task/42884">FS#42884</a> для более подробной информации.
</p>
<h3>
<span id=".D0.9F.D1.80.D0.BE.D0.B2.D0.B5.D1.80.D0.BA.D0.B0_.D1.84.D0.B0.D0.B9.D0.BB.D0.BE.D0.B2.D0.BE.D0.B9_.D1.81.D0.B8.D1.81.D1.82.D0.B5.D0.BC.D1.8B"></span><span class="mw-headline" id="Проверка_файловой_системы">Проверка файловой системы</span>
</h3>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Важно:</strong> Поскольку Btrfs находится в стадии интенсивной разработки, особенно команда <code>btrfs check</code>, настоятельно рекомендуется создать <a href="../ru/System_maintenance.html#%D0%A0%D0%B5%D0%B7%D0%B5%D1%80%D0%B2%D0%BD%D0%BE%D0%B5_%D0%BA%D0%BE%D0%BF%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5" title="System maintenance (Русский)">резервную копию</a> и проконсультироваться с <span class="plainlinks archwiki-template-man" title="$ man 8 btrfs-check"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/btrfs-check.8">btrfs-check(8)</a></span> перед выполнением <code>btrfs check</code> с ключом <code>--repair</code>.</div>
<p>Команда <span class="plainlinks archwiki-template-man" title="$ man 8 btrfs-check"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/btrfs-check.8">btrfs-check(8)</a></span> может быть использована для проверки или восстановления размонтированной файловой системы Btrfs. Однако этот инструмент ещё не доработан и не может исправить некоторые ошибки файловой системы, даже те, которые не делают файловую систему немонтируемой.
</p>
<h3>
<span id=".D0.94.D0.B8.D1.81.D0.BA_.D0.BF.D0.BE.D1.81.D1.82.D0.BE.D1.8F.D0.BD.D0.BD.D0.BE_.D0.B0.D0.BA.D1.82.D0.B8.D0.B2.D0.B5.D0.BD"></span><span class="mw-headline" id="Диск_постоянно_активен">Диск постоянно активен</span>
</h3>
<p>Начиная с версии <a href="../ru/Kernel.html" class="mw-redirect" title="Ядра">ядра</a> 6.2, по умолчанию используется опция монтирования <code>discard=async</code>. <a rel="nofollow" class="external text" href="https://lore.kernel.org/linux-btrfs/Y%2F%2Bn1wS%2F4XAH7X1p@nz/#r">Сообщалось</a>, что это приводит к постоянной активности некоторых дисков даже при бездействии, поскольку discard-очередь заполняется быстрее, чем обрабатывается. Это может привести к повышенному энергопотреблению, особенно на NVMe-накопителях.
</p>
<p>Начиная с версии ядра 6.3, для решения этой проблемы стандартный лимит <code>iops_limit</code> для discard был изменён со 100 на 1000. На старых версиях ядра можно вручную установить нужное значение:
</p>
<pre># echo 1000 &gt; /sys/fs/btrfs/<i>uuid</i>/discard/iops_limit
</pre>
<p>Где <code><i>uuid</i></code> — это UUID файловой системы Btrfs. Со значением <code>1000</code> можно поэкспериментировать.
</p>
<p>Чтобы значение устанавливалось при загрузке системы, можно использовать <a href="../ru/Systemd.html#systemd-tmpfiles_%E2%80%94_%D0%B2%D1%80%D0%B5%D0%BC%D0%B5%D0%BD%D0%BD%D1%8B%D0%B5_%D1%84%D0%B0%D0%B9%D0%BB%D1%8B" title="Systemd (Русский)">systemd-tmpfiles</a>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/tmpfiles.d/btrfs-discard.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">w /sys/fs/btrfs/<i>uuid</i>/discard/iops_limit - - - - 1000
</pre>
<p>Или можно полностью отключить асинхронный discard, добавив опцию монтирования <code>nodiscard</code> в файл <a href="../ru/Fstab.html" title="Fstab (Русский)">fstab</a>, а вместо него использовать <a href="../ru/Solid_state_drive.html#%D0%9F%D0%B5%D1%80%D0%B8%D0%BE%D0%B4%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B8%D0%B9_TRIM" title="Solid state drive (Русский)">периодический TRIM</a>.
</p>
<h2>
<span id=".D0.A1.D0.BC.D0.BE.D1.82.D1.80.D0.B8.D1.82.D0.B5_.D1.82.D0.B0.D0.BA.D0.B6.D0.B5"></span><span class="mw-headline" id="Смотрите_также">Смотрите также</span>
</h2>
<ul>
<li>
<b>Официальный сайт</b>
<ul>
<li><a rel="nofollow" class="external text" href="https://btrfs.readthedocs.io">Документация Btrfs</a></li>
<li><a rel="nofollow" class="external text" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/">Btrfs Wiki (архив)</a></li>
</ul>
</li>
<li>
<b>О производительности</b>
<ul>
<li><a rel="nofollow" class="external text" href="https://superuser.com/questions/432188/should-i-put-my-multi-device-btrfs-filesystem-on-disk-partitions-or-raw-devices">Btrfs on raw disks?</a></li>
<li><a rel="nofollow" class="external text" href="https://lore.kernel.org/linux-btrfs/CAKcLGm_MKEdTiHFBd-b-v2sN5gJmgFRqsykzWRXTVqUw4O6Acw@mail.gmail.com/">Varying leafsize and nodesize in Btrfs</a></li>
<li><a rel="nofollow" class="external text" href="https://lore.kernel.org/linux-btrfs/jgui4j$th5$1@dough.gmane.org/">Btrfs support for efficient SSD operation (data blocks alignment)</a></li>
<li><a rel="nofollow" class="external text" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/FAQ.html#Is_Btrfs_optimized_for_SSD.3F">Is Btrfs optimized for SSDs?</a></li>
<li><a rel="nofollow" class="external text" href="https://blog.erdemagaoglu.com/post/4605524309/lzo-vs-snappy-vs-lzf-vs-zlib-a-comparison-of">Lzo vs. zLib</a></li>
</ul>
</li>
<li>
<b>Разное</b>
<ul>
<li><a href="https://www.funtoo.org/BTRFS_Fun" class="extiw" title="funtoo:BTRFS Fun">Funtoo:BTRFS Fun</a></li>
<li>
<a rel="nofollow" class="external text" href="https://www.phoronix.com/scan.php?page=news_item&amp;px=MTA0ODU">Ави Миллер представляет Btrfs</a> на SCALE 10x, январь 2012 г.</li>
<li>
<a rel="nofollow" class="external text" href="https://www.phoronix.com/scan.php?page=news_item&amp;px=MTA4Mzc">Резюме выступления Криса Мейсона</a> с LFCS 2012 г.</li>
<li>
<a rel="nofollow" class="external text" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=35054394c4b3cecd52577c2662c84da1f3e73525">Btrfs: stop providing a bmap operation to avoid swapfile corruptions</a> 2009-01-21</li>
<li><a rel="nofollow" class="external text" href="https://marc.merlins.org/perso/btrfs/post_2014-03-22_Btrfs-Tips_-Doing-Fast-Incremental-Backups-With-Btrfs-Send-and-Receive.html">Doing Fast Incremental Backups With Btrfs Send and Receive</a></li>
</ul>
</li>
</ul>
</div>
</div>
					<div id="catlinks" class="catlinks" data-mw="interface"><div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../Special:Categories.html" title="Special:Categories">Category</a>: <ul><li><a href="../ru/Category:File_systems.html" title="Category:File systems (Русский)">File systems (Русский)</a></li></ul>
</div></div>
				</div>
			</main>
			
		</div>
		<div class="mw-footer-container">
			
<footer id="footer" class="mw-footer" role="contentinfo" style="margin: 0">
	<ul id="footer-info">
	<li data-nosnippet="">Retrieved from "<a dir="ltr" href="https://wiki.archlinux.org/index.php?title=Btrfs_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)&amp;oldid=809413">https://wiki.archlinux.org/index.php?title=Btrfs_(Русский)&amp;oldid=809413</a>"</li>
<li id="footer-info-lastmod"> This page was last edited on 26 May 2024, at 20:29.</li>
	<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="https://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.3 or later</a> unless otherwise noted.</li>
<br>
</ul>

	<ul id="footer-places">
	<li id="footer-places-privacy"><a href="https://terms.archlinux.org/docs/privacy-policy/">Privacy policy</a></li>
	<li id="footer-places-about"><a href="../en/ArchWiki:About.html">About ArchWiki</a></li>
	<li id="footer-places-disclaimers"><a href="../en/ArchWiki:General_disclaimer.html">Disclaimers</a></li>
	<li id="footer-places-archwiki-code-of-conduct"><a href="https://terms.archlinux.org/docs/code-of-conduct/" class="extiw" title="archlinux-service-agreements:code-of-conduct">Code of conduct</a></li>
	<li id="footer-places-archwiki-terms-of-service"><a href="https://terms.archlinux.org/docs/terms-of-service/" class="extiw" title="archlinux-service-agreements:terms-of-service">Terms of service</a></li>
</ul>

	<ul id="footer-icons" class="noprint">
	<li id="footer-copyrightico"><a href="https://www.gnu.org/copyleft/fdl.html"><img src="/resources/assets/licenses/gnu-fdl.png" alt="GNU Free Documentation License 1.3 or later" width="88" height="31" loading="lazy"></a></li>
	<li id="footer-poweredbyico"><img src="/resources/assets/poweredby_mediawiki_88x31.png" srcset="/resources/assets/poweredby_mediawiki_132x47.png 1.5x, /resources/assets/poweredby_mediawiki_176x62.png 2x" width="88" height="31" loading="lazy"></li>
</ul>

</footer>

		</div>
	</div> 
</div> 
<div class="vector-settings" id="p-dock-bottom">
	<ul>
		<li>
		<button class="cdx-button cdx-button--icon-only vector-limited-width-toggle" id=""><span class="vector-icon mw-ui-icon-fullScreen mw-ui-icon-wikimedia-fullScreen"></span>

<span>Toggle limited content width</span>
</button>
</li>
	</ul>
</div>
</body>
</html>
