<!DOCTYPE html>
<html class="client-nojs vector-feature-language-in-header-enabled vector-feature-language-in-main-page-header-disabled vector-feature-sticky-header-disabled vector-feature-page-tools-pinned-disabled vector-feature-toc-pinned-clientpref-1 vector-feature-main-menu-pinned-disabled vector-feature-limited-width-clientpref-1 vector-feature-limited-width-content-enabled vector-feature-custom-font-size-clientpref-0 vector-feature-client-preferences-disabled vector-feature-client-prefs-pinned-disabled vector-feature-night-mode-disabled skin-theme-clientpref-day vector-toc-available" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>nginx (Русский) - ArchWiki</title>
<link rel="stylesheet" href="../ArchWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<meta name="generator" content="MediaWiki 1.42.3">
<meta name="referrer" content="no-referrer-when-downgrade">
<meta name="robots" content="max-image-preview:standard">
<meta name="format-detection" content="telephone=no">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=0.25, maximum-scale=5.0">
<link rel="icon" href="/favicon.ico">
<link rel="search" type="application/opensearchdescription+xml" href="/opensearch_desc.php" title="ArchWiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.archlinux.org/api.php?action=rsd">
<link rel="license" href="https://www.gnu.org/copyleft/fdl.html">
<link rel="alternate" type="application/atom+xml" title="ArchWiki Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="skin-vector skin-vector-search-vue mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-Nginx_Русский rootpage-Nginx_Русский skin-vector-2022 action-view skin--responsive">
<a class="mw-jump-link" href="#bodyContent">Jump to content</a>
<div class="vector-header-container">
	</div>
<div class="mw-page-container">
	<div class="mw-page-container-inner">
		<div class="vector-column-start">
			<div class="vector-main-menu-container">
		</div>
	<div class="vector-sticky-pinned-container">
				<nav id="mw-panel-toc" role="navigation" aria-label="Contents" data-event-name="ui.sidebar-toc" class="mw-table-of-contents-container vector-toc-landmark">
					<div id="vector-toc-pinned-container" class="vector-pinned-container">
					<div id="vector-toc" class="vector-toc vector-pinnable-element">
	<div class="vector-pinnable-header vector-toc-pinnable-header vector-pinnable-header-pinned" data-feature-name="toc-pinned" data-pinnable-element-id="vector-toc">
	<h2 class="vector-pinnable-header-label">Contents</h2>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-pin-button" data-event-name="pinnable-header.vector-toc.pin">move to sidebar</button>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-unpin-button" data-event-name="pinnable-header.vector-toc.unpin">hide</button>
</div>


	<ul class="vector-toc-contents" id="mw-panel-toc-list">
		<li id="toc-mw-content-text" class="vector-toc-list-item vector-toc-level-1">
			<a href="#" class="vector-toc-link">
				<div class="vector-toc-text">Beginning</div>
			</a>
		</li>
		<li id="toc-Установка" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">1</span>Установка</div>
		</a>
		
		<ul id="toc-Установка-sublist" class="vector-toc-list">
		</ul>
	</li>
	<li id="toc-Запуск" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#%D0%97%D0%B0%D0%BF%D1%83%D1%81%D0%BA">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">2</span>Запуск</div>
		</a>
		
		<ul id="toc-Запуск-sublist" class="vector-toc-list">
		</ul>
	</li>
	<li id="toc-Настройка" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">3</span>Настройка</div>
		</a>
		
			<button aria-controls="toc-Настройка-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Настройка subsection</span>
			</button>
		
		<ul id="toc-Настройка-sublist" class="vector-toc-list">
			<li id="toc-Пример_настройки" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%9F%D1%80%D0%B8%D0%BC%D0%B5%D1%80_%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B8">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.1</span>Пример настройки</div>
			</a>
			
			<ul id="toc-Пример_настройки-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Основные_настройки" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%9E%D1%81%D0%BD%D0%BE%D0%B2%D0%BD%D1%8B%D0%B5_%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B8">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.2</span>Основные настройки</div>
			</a>
			
			<ul id="toc-Основные_настройки-sublist" class="vector-toc-list">
				<li id="toc-Процессы_и_соединения" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#%D0%9F%D1%80%D0%BE%D1%86%D0%B5%D1%81%D1%81%D1%8B_%D0%B8_%D1%81%D0%BE%D0%B5%D0%B4%D0%B8%D0%BD%D0%B5%D0%BD%D0%B8%D1%8F">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.2.1</span>Процессы и соединения</div>
			</a>
			
			<ul id="toc-Процессы_и_соединения-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Запуск_под_другим_пользователем" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#%D0%97%D0%B0%D0%BF%D1%83%D1%81%D0%BA_%D0%BF%D0%BE%D0%B4_%D0%B4%D1%80%D1%83%D0%B3%D0%B8%D0%BC_%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D1%82%D0%B5%D0%BB%D0%B5%D0%BC">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.2.2</span>Запуск под другим пользователем</div>
			</a>
			
			<ul id="toc-Запуск_под_другим_пользователем-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Блоки_server" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#%D0%91%D0%BB%D0%BE%D0%BA%D0%B8_server">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.2.3</span>Блоки server</div>
			</a>
			
			<ul id="toc-Блоки_server-sublist" class="vector-toc-list">
				<li id="toc-Управление_блоками_server" class="vector-toc-list-item vector-toc-level-4">
			<a class="vector-toc-link" href="#%D0%A3%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5_%D0%B1%D0%BB%D0%BE%D0%BA%D0%B0%D0%BC%D0%B8_server">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.2.3.1</span>Управление блоками server</div>
			</a>
			
			<ul id="toc-Управление_блоками_server-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-TLS" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#TLS">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.2.4</span>TLS</div>
			</a>
			
			<ul id="toc-TLS-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Пользовательские_каталоги" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#%D0%9F%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D1%82%D0%B5%D0%BB%D1%8C%D1%81%D0%BA%D0%B8%D0%B5_%D0%BA%D0%B0%D1%82%D0%B0%D0%BB%D0%BE%D0%B3%D0%B8">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.2.5</span>Пользовательские каталоги</div>
			</a>
			
			<ul id="toc-Пользовательские_каталоги-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-FastCGI" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#FastCGI">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.3</span>FastCGI</div>
			</a>
			
			<ul id="toc-FastCGI-sublist" class="vector-toc-list">
				<li id="toc-Реализация_PHP" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#%D0%A0%D0%B5%D0%B0%D0%BB%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F_PHP">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.3.1</span>Реализация PHP</div>
			</a>
			
			<ul id="toc-Реализация_PHP-sublist" class="vector-toc-list">
				<li id="toc-Настройка_nginx" class="vector-toc-list-item vector-toc-level-4">
			<a class="vector-toc-link" href="#%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0_nginx">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.3.1.1</span>Настройка nginx</div>
			</a>
			
			<ul id="toc-Настройка_nginx-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Проверка_конфигурации" class="vector-toc-list-item vector-toc-level-4">
			<a class="vector-toc-link" href="#%D0%9F%D1%80%D0%BE%D0%B2%D0%B5%D1%80%D0%BA%D0%B0_%D0%BA%D0%BE%D0%BD%D1%84%D0%B8%D0%B3%D1%83%D1%80%D0%B0%D1%86%D0%B8%D0%B8">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.3.1.2</span>Проверка конфигурации</div>
			</a>
			
			<ul id="toc-Проверка_конфигурации-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Реализация_CGI" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#%D0%A0%D0%B5%D0%B0%D0%BB%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F_CGI">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.3.2</span>Реализация CGI</div>
			</a>
			
			<ul id="toc-Реализация_CGI-sublist" class="vector-toc-list">
				<li id="toc-fcgiwrap" class="vector-toc-list-item vector-toc-level-4">
			<a class="vector-toc-link" href="#fcgiwrap">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.3.2.1</span>fcgiwrap</div>
			</a>
			
			<ul id="toc-fcgiwrap-sublist" class="vector-toc-list">
				<li id="toc-Несколько_рабочих_потоков" class="vector-toc-list-item vector-toc-level-5">
			<a class="vector-toc-link" href="#%D0%9D%D0%B5%D1%81%D0%BA%D0%BE%D0%BB%D1%8C%D0%BA%D0%BE_%D1%80%D0%B0%D0%B1%D0%BE%D1%87%D0%B8%D1%85_%D0%BF%D0%BE%D1%82%D0%BE%D0%BA%D0%BE%D0%B2">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.3.2.1.1</span>Несколько рабочих потоков</div>
			</a>
			
			<ul id="toc-Несколько_рабочих_потоков-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Настройка_nginx_2" class="vector-toc-list-item vector-toc-level-4">
			<a class="vector-toc-link" href="#%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0_nginx_2">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.3.2.2</span>Настройка nginx</div>
			</a>
			
			<ul id="toc-Настройка_nginx_2-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
	</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Установка_в_chroot" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0_%D0%B2_chroot">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">4</span>Установка в chroot</div>
		</a>
		
			<button aria-controls="toc-Установка_в_chroot-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Установка в chroot subsection</span>
			</button>
		
		<ul id="toc-Установка_в_chroot-sublist" class="vector-toc-list">
			<li id="toc-Создание_необходимых_устройств" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D0%BD%D0%B5%D0%BE%D0%B1%D1%85%D0%BE%D0%B4%D0%B8%D0%BC%D1%8B%D1%85_%D1%83%D1%81%D1%82%D1%80%D0%BE%D0%B9%D1%81%D1%82%D0%B2">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">4.1</span>Создание необходимых устройств</div>
			</a>
			
			<ul id="toc-Создание_необходимых_устройств-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Создание_необходимых_каталогов" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D0%BD%D0%B5%D0%BE%D0%B1%D1%85%D0%BE%D0%B4%D0%B8%D0%BC%D1%8B%D1%85_%D0%BA%D0%B0%D1%82%D0%B0%D0%BB%D0%BE%D0%B3%D0%BE%D0%B2">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">4.2</span>Создание необходимых каталогов</div>
			</a>
			
			<ul id="toc-Создание_необходимых_каталогов-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Заполнение_chroot" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%97%D0%B0%D0%BF%D0%BE%D0%BB%D0%BD%D0%B5%D0%BD%D0%B8%D0%B5_chroot">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">4.3</span>Заполнение chroot</div>
			</a>
			
			<ul id="toc-Заполнение_chroot-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Отредактируйте_nginx.service_для_запуска_chroot" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%9E%D1%82%D1%80%D0%B5%D0%B4%D0%B0%D0%BA%D1%82%D0%B8%D1%80%D1%83%D0%B9%D1%82%D0%B5_nginx.service_%D0%B4%D0%BB%D1%8F_%D0%B7%D0%B0%D0%BF%D1%83%D1%81%D0%BA%D0%B0_chroot">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">4.4</span>Отредактируйте nginx.service для запуска chroot</div>
			</a>
			
			<ul id="toc-Отредактируйте_nginx.service_для_запуска_chroot-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Советы_и_рекомендации" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#%D0%A1%D0%BE%D0%B2%D0%B5%D1%82%D1%8B_%D0%B8_%D1%80%D0%B5%D0%BA%D0%BE%D0%BC%D0%B5%D0%BD%D0%B4%D0%B0%D1%86%D0%B8%D0%B8">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">5</span>Советы и рекомендации</div>
		</a>
		
			<button aria-controls="toc-Советы_и_рекомендации-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Советы и рекомендации subsection</span>
			</button>
		
		<ul id="toc-Советы_и_рекомендации-sublist" class="vector-toc-list">
			<li id="toc-Запуск_без_привилегий_через_systemd" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%97%D0%B0%D0%BF%D1%83%D1%81%D0%BA_%D0%B1%D0%B5%D0%B7_%D0%BF%D1%80%D0%B8%D0%B2%D0%B8%D0%BB%D0%B5%D0%B3%D0%B8%D0%B9_%D1%87%D0%B5%D1%80%D0%B5%D0%B7_systemd">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">5.1</span>Запуск без привилегий через systemd</div>
			</a>
			
			<ul id="toc-Запуск_без_привилегий_через_systemd-sublist" class="vector-toc-list">
				<li id="toc-Порт" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#%D0%9F%D0%BE%D1%80%D1%82">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">5.1.1</span>Порт</div>
			</a>
			
			<ul id="toc-Порт-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-PID-файл" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#PID-%D1%84%D0%B0%D0%B9%D0%BB">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">5.1.2</span>PID-файл</div>
			</a>
			
			<ul id="toc-PID-файл-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-/var/lib/nginx/*" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#/var/lib/nginx/*">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">5.1.3</span>/var/lib/nginx/*</div>
			</a>
			
			<ul id="toc-/var/lib/nginx/*-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Права_каталогов_и_файлов_журналов" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#%D0%9F%D1%80%D0%B0%D0%B2%D0%B0_%D0%BA%D0%B0%D1%82%D0%B0%D0%BB%D0%BE%D0%B3%D0%BE%D0%B2_%D0%B8_%D1%84%D0%B0%D0%B9%D0%BB%D0%BE%D0%B2_%D0%B6%D1%83%D1%80%D0%BD%D0%B0%D0%BB%D0%BE%D0%B2">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">5.1.4</span>Права каталогов и файлов журналов</div>
			</a>
			
			<ul id="toc-Права_каталогов_и_файлов_журналов-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Альтернативный_скрипт_для_systemd" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%90%D0%BB%D1%8C%D1%82%D0%B5%D1%80%D0%BD%D0%B0%D1%82%D0%B8%D0%B2%D0%BD%D1%8B%D0%B9_%D1%81%D0%BA%D1%80%D0%B8%D0%BF%D1%82_%D0%B4%D0%BB%D1%8F_systemd">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">5.2</span>Альтернативный скрипт для systemd</div>
			</a>
			
			<ul id="toc-Альтернативный_скрипт_для_systemd-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Nginx_beautifier" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Nginx_beautifier">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">5.3</span>Nginx beautifier</div>
			</a>
			
			<ul id="toc-Nginx_beautifier-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Более_удобное_управление_заголовками" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%91%D0%BE%D0%BB%D0%B5%D0%B5_%D1%83%D0%B4%D0%BE%D0%B1%D0%BD%D0%BE%D0%B5_%D1%83%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5_%D0%B7%D0%B0%D0%B3%D0%BE%D0%BB%D0%BE%D0%B2%D0%BA%D0%B0%D0%BC%D0%B8">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">5.4</span>Более удобное управление заголовками</div>
			</a>
			
			<ul id="toc-Более_удобное_управление_заголовками-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Решение_проблем" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#%D0%A0%D0%B5%D1%88%D0%B5%D0%BD%D0%B8%D0%B5_%D0%BF%D1%80%D0%BE%D0%B1%D0%BB%D0%B5%D0%BC">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">6</span>Решение проблем</div>
		</a>
		
			<button aria-controls="toc-Решение_проблем-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Решение проблем subsection</span>
			</button>
		
		<ul id="toc-Решение_проблем-sublist" class="vector-toc-list">
			<li id="toc-Валидация_конфигурации" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%92%D0%B0%D0%BB%D0%B8%D0%B4%D0%B0%D1%86%D0%B8%D1%8F_%D0%BA%D0%BE%D0%BD%D1%84%D0%B8%D0%B3%D1%83%D1%80%D0%B0%D1%86%D0%B8%D0%B8">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">6.1</span>Валидация конфигурации</div>
			</a>
			
			<ul id="toc-Валидация_конфигурации-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Ошибка:_Страница,_которую_вы_ищете,_временно_недоступна._Пожалуйста,_попробуйте_позже._(502_Bad_Gateway)" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%9E%D1%88%D0%B8%D0%B1%D0%BA%D0%B0:_%D0%A1%D1%82%D1%80%D0%B0%D0%BD%D0%B8%D1%86%D0%B0,_%D0%BA%D0%BE%D1%82%D0%BE%D1%80%D1%83%D1%8E_%D0%B2%D1%8B_%D0%B8%D1%89%D0%B5%D1%82%D0%B5,_%D0%B2%D1%80%D0%B5%D0%BC%D0%B5%D0%BD%D0%BD%D0%BE_%D0%BD%D0%B5%D0%B4%D0%BE%D1%81%D1%82%D1%83%D0%BF%D0%BD%D0%B0._%D0%9F%D0%BE%D0%B6%D0%B0%D0%BB%D1%83%D0%B9%D1%81%D1%82%D0%B0,_%D0%BF%D0%BE%D0%BF%D1%80%D0%BE%D0%B1%D1%83%D0%B9%D1%82%D0%B5_%D0%BF%D0%BE%D0%B7%D0%B6%D0%B5._(502_Bad_Gateway)">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">6.2</span>Ошибка: Страница, которую вы ищете, временно недоступна. Пожалуйста, попробуйте позже. (502 Bad Gateway)</div>
			</a>
			
			<ul id="toc-Ошибка:_Страница,_которую_вы_ищете,_временно_недоступна._Пожалуйста,_попробуйте_позже._(502_Bad_Gateway)-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Ошибка:_No_input_file_specified" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%9E%D1%88%D0%B8%D0%B1%D0%BA%D0%B0:_No_input_file_specified">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">6.3</span>Ошибка: No input file specified</div>
			</a>
			
			<ul id="toc-Ошибка:_No_input_file_specified-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Warning:_Could_not_build_optimal_types_hash" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Warning:_Could_not_build_optimal_types_hash">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">6.4</span>Warning: Could not build optimal types_hash</div>
			</a>
			
			<ul id="toc-Warning:_Could_not_build_optimal_types_hash-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Cannot_assign_requested_address" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Cannot_assign_requested_address">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">6.5</span>Cannot assign requested address</div>
			</a>
			
			<ul id="toc-Cannot_assign_requested_address-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Смотрите_также" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#%D0%A1%D0%BC%D0%BE%D1%82%D1%80%D0%B8%D1%82%D0%B5_%D1%82%D0%B0%D0%BA%D0%B6%D0%B5">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">7</span>Смотрите также</div>
		</a>
		
		<ul id="toc-Смотрите_также-sublist" class="vector-toc-list">
		</ul>
	</li>
</ul>
</div>

					</div>
		</nav>
			</div>
		</div>
		<div class="mw-content-container">
			<main id="content" class="mw-body" role="main" style="margin: 0">
				<header class="mw-body-header vector-page-titlebar">
					<nav role="navigation" aria-label="Contents" class="vector-toc-landmark">
						
<div id="vector-page-titlebar-toc" class="vector-dropdown vector-page-titlebar-toc vector-button-flush-left">
	<input type="checkbox" id="vector-page-titlebar-toc-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-vector-page-titlebar-toc" class="vector-dropdown-checkbox " aria-label="Toggle the table of contents">
	<label id="vector-page-titlebar-toc-label" for="vector-page-titlebar-toc-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--icon-only " aria-hidden="true"><span class="vector-icon mw-ui-icon-listBullet mw-ui-icon-wikimedia-listBullet"></span>

<span class="vector-dropdown-label-text">Toggle the table of contents</span>
	</label>
	<div class="vector-dropdown-content">


							<div id="vector-page-titlebar-toc-unpinned-container" class="vector-unpinned-container">
			</div>
		
	</div>
</div>

					</nav>
					<h1 id="firstHeading" class="firstHeading mw-first-heading">nginx (Русский)</h1>
							
<div id="p-lang-btn" class="vector-dropdown mw-portlet mw-portlet-lang">
	<input type="checkbox" id="p-lang-btn-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-p-lang-btn" class="vector-dropdown-checkbox mw-interlanguage-selector" aria-label="Go to an article in another language. Available in 4 languages">
	<label id="p-lang-btn-label" for="p-lang-btn-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--action-progressive mw-portlet-lang-heading-4" aria-hidden="true"><span class="vector-icon mw-ui-icon-language-progressive mw-ui-icon-wikimedia-language-progressive"></span>

<span class="vector-dropdown-label-text">4 languages</span>
	</label>
	<div class="vector-dropdown-content">

		<div class="vector-menu-content">
			
			<ul class="vector-menu-content-list">
				
				<li class="interlanguage-link interwiki-de mw-list-item"><a href="https://wiki.archlinux.de/title/Nginx" title="Nginx – Deutsch" lang="de" hreflang="de" class="interlanguage-link-target"><span>Deutsch</span></a></li>
<li class="interlanguage-link interwiki-en mw-list-item"><a href="../en/Nginx.html" title="Nginx – English" lang="en" hreflang="en" class="interlanguage-link-target"><span>English</span></a></li>
<li class="interlanguage-link interwiki-ja mw-list-item"><a href="https://wiki.archlinux.jp/index.php/Nginx" title="Nginx – 日本語" lang="ja" hreflang="ja" class="interlanguage-link-target"><span>日本語</span></a></li>
<li class="interlanguage-link interwiki-zh-hans mw-list-item"><a href="https://wiki.archlinuxcn.org/wiki/Nginx" title="Nginx – 中文（简体）" lang="zh-Hans" hreflang="zh-Hans" class="interlanguage-link-target"><span>中文（简体）</span></a></li>
			</ul>
			
		</div>

	</div>
</div>
</header>
				<div class="vector-column-end">
					<div class="vector-sticky-pinned-container">
						<nav class="vector-page-tools-landmark" aria-label="Page tools">
							<div id="vector-page-tools-pinned-container" class="vector-pinned-container">
				
							</div>
		</nav>
						<nav class="vector-client-prefs-landmark" aria-label="Appearance">
						</nav>
					</div>
				</div>
				<div id="bodyContent" class="vector-body" aria-labelledby="firstHeading" data-mw-ve-target-container>
					<div class="vector-body-before-content">
							<div class="mw-indicators">
		</div>

						<div id="siteSub" class="noprint">From ArchWiki</div>
					</div>
					<div id="contentSub"><div id="mw-content-subtitle"></div></div>
					
					
					<div id="mw-content-text" class="mw-body-content">
<div class="mw-content-ltr mw-parser-output" lang="ru" dir="ltr">
<p><span>
</span>
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Состояние перевода:</strong> На этой странице представлен перевод статьи <a href="../en/Nginx.html" title="Nginx">nginx</a>. Дата последней синхронизации: 18 июля 2022. Вы можете <a href="../ru/ArchWiki:Translation_Team.html" title="ArchWiki:Translation Team (Русский)">помочь</a> синхронизировать перевод, если в английской версии произошли <a rel="nofollow" class="external text" href="https://wiki.archlinux.org/index.php?title=Nginx&amp;diff=0&amp;oldid=738354">изменения</a>.</div>
<p><a href="https://en.wikipedia.org/wiki/ru:nginx" class="extiw" title="wikipedia:ru:nginx">nginx</a> (произносится "э́нжин-э́кс" или "э́нжин-и́кс") — это свободный высокопроизводительный HTTP-сервер с открытым исходным кодом, а также обратный прокси и IMAP/POP3 прокси-сервер, написанный Игорем Сысоевым в 2005 году. nginx получил широкое распространение благодаря своей стабильности, богатой функциональности, простой настройке и низкому потреблению ресурсов.
</p>
<p>Данная статья описывает установку nginx и интеграцию с <a href="../en/PHP.html" class="mw-redirect" title="PHP (Русский)">PHP</a> через <a href="#FastCGI">#FastCGI</a>.
</p>
<meta property="mw:PageProp/toc">
<h2>
<span id=".D0.A3.D1.81.D1.82.D0.B0.D0.BD.D0.BE.D0.B2.D0.BA.D0.B0"></span><span class="mw-headline" id="Установка">Установка</span>
</h2>
<p><a href="../ru/Help:Reading.html#%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0_%D0%BF%D0%B0%D0%BA%D0%B5%D1%82%D0%BE%D0%B2" class="mw-redirect" title="Установите">Установите</a> один из пакетов:
</p>
<ul>
<li>
<span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=nginx-mainline">nginx-mainline</a></span> - основная ветка: новые возможности, обновления и исправления ошибок.</li>
<li>
<span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=nginx">nginx</a></span> - стабильная ветка; только исправления серьёзных ошибок.</li>
<li>
<span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/angie/">angie</a></span><sup><small>AUR</small></sup> - форк, предполагает подмену nginx на месте без переработки конфигурации с расширением возможностей.</li>
</ul>
<p>Рекомендуется использовать основную (mainline) ветку. Основная причина для использования стабильной ветки — возможная несовместимость со сторонними модулями или непреднамеренное появление ошибок при реализации новых функций.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> Все модули nginx, доступные в <a href="../ru/Official_repositories.html" title="Official repositories (Русский)">официальных репозиториях</a>, в качестве зависимости требуют пакет <i>nginx</i> (а не <i>nginx-mainline</i>). Возможно, стоит просмотреть список модулей на наличие тех, которые вам могут понадобиться, прежде чем принимать решение о выборе между <i>nginx</i> и <i>nginx-mainline</i>. Модули для <i>nginx-mainline</i> можно найти в <a href="../ru/Arch_User_Repository.html" title="Arch User Repository (Русский)">пользовательском репозитории Arch</a>.</div>
<p>Если для обеспечения дополнительной безопасности вы хотите установить nginx в chroot-окружении, смотрите раздел <a href="#%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0_%D0%B2_chroot">#Установка в chroot</a>.
</p>
<h2>
<span id=".D0.97.D0.B0.D0.BF.D1.83.D1.81.D0.BA"></span><span class="mw-headline" id="Запуск">Запуск</span>
</h2>
<p><a href="../ru/Help:Reading.html#%D0%A3%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5_%D1%8E%D0%BD%D0%B8%D1%82%D0%B0%D0%BC%D0%B8_systemd" class="mw-redirect" title="Запустите/включите">Запустите/включите</a> службу <code>nginx.service</code> или <code>angie.service</code>, если вы используете Angie.
</p>
<p>Страница по умолчанию, доступная по адресу <a rel="nofollow" class="external free" href="http://127.0.0.1">http://127.0.0.1</a> располагается в <code>/usr/share/nginx/html/index.html</code>.
</p>
<h2>
<span id=".D0.9D.D0.B0.D1.81.D1.82.D1.80.D0.BE.D0.B9.D0.BA.D0.B0"></span><span class="mw-headline" id="Настройка">Настройка</span>
</h2>
<p>Первые шаги по настройке и использованию nginx описаны в официальном <a rel="nofollow" class="external text" href="https://nginx.org/ru/docs/beginners_guide.html">руководстве для начинающих</a>. Вы можете настроить сервер, редактируя файлы в <code>/etc/nginx/</code>; главный файл настроек расположен в <code>/etc/nginx/nginx.conf</code>.
</p>
<p>Более подробную информацию можно прочитать на странице <a rel="nofollow" class="external text" href="https://wiki.nginx.org/Configuration">Nginx Configuration Examples</a><sup title="Статус последней проверки: domain name not resolved">[<a href="https://en.wikipedia.org/wiki/ru:%D0%92%D0%B8%D0%BA%D0%B8%D0%BF%D0%B5%D0%B4%D0%B8%D1%8F:%D0%9C%D1%91%D1%80%D1%82%D0%B2%D1%8B%D0%B5_%D1%81%D1%81%D1%8B%D0%BB%D0%BA%D0%B8" class="extiw" title="wikipedia:ru:Википедия:Мёртвые ссылки">устаревшая ссылка</a> 2024-07-30 ⓘ]</sup> и в <a rel="nofollow" class="external text" href="https://nginx.org/ru/docs/">официальной документации</a>.
</p>
<p>Приведенные далее примеры покрывают большинство типичных потребностей. Предполагается, что вы используете стандартное место расположения веб-документов (<code>/usr/share/nginx/html</code>). Если это не так, замените путь на свой.
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Совет:</strong> DigitalOcean предоставляет <a rel="nofollow" class="external text" href="https://nginxconfig.io/">инструмент для настройки nginx</a>.</div>
<h3>
<span id=".D0.9F.D1.80.D0.B8.D0.BC.D0.B5.D1.80_.D0.BD.D0.B0.D1.81.D1.82.D1.80.D0.BE.D0.B9.D0.BA.D0.B8"></span><span class="mw-headline" id="Пример_настройки">Пример настройки</span>
</h3>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/nginx/nginx.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">user http;
worker_processes auto;
worker_cpu_affinity auto;

events {
    multi_accept on;
    worker_connections 1024;
}

http {
    charset utf-8;
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    server_tokens off;
    log_not_found off;
    types_hash_max_size 4096;
    client_max_body_size 16M;

    # MIME
    include mime.types;
    default_type application/octet-stream;

    # журналы
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log warn;

    # загрузка дополнительных файлов конфигурации
    include /etc/nginx/conf.d/*.conf;
    include /etc/nginx/sites-enabled/*;
}
</pre>
<h3>
<span id=".D0.9E.D1.81.D0.BD.D0.BE.D0.B2.D0.BD.D1.8B.D0.B5_.D0.BD.D0.B0.D1.81.D1.82.D1.80.D0.BE.D0.B9.D0.BA.D0.B8"></span><span class="mw-headline" id="Основные_настройки">Основные настройки</span>
</h3>
<h4>
<span id=".D0.9F.D1.80.D0.BE.D1.86.D0.B5.D1.81.D1.81.D1.8B_.D0.B8_.D1.81.D0.BE.D0.B5.D0.B4.D0.B8.D0.BD.D0.B5.D0.BD.D0.B8.D1.8F"></span><span class="mw-headline" id="Процессы_и_соединения">Процессы и соединения</span>
</h4>
<p>Вы должны выбрать подходящее значение для <code>worker_processes</code>. Этот параметр определяет сколько одновременных соединений сможет принимать nginx и сколько процессоров он сможет при этом использовать. Как правило, это значение устанавливают равным количеству аппаратных потоков в системе. Однако, начиная с версий 1.3.8 и 1.2.5, в качестве значения <code>worker_processes</code> вы также можете задать <code>auto</code>, при этом nginx попытается автоматически подобрать оптимальное значение (<a rel="nofollow" class="external text" href="https://nginx.org/ru/docs/ngx_core_module.html#worker_processes">источник</a>).
</p>
<p>Максимальное количество одновременных соединений, которое nginx сможет принимать, вычисляется как <code>max_clients = worker_processes * worker_connections</code>.
</p>
<h4>
<span id=".D0.97.D0.B0.D0.BF.D1.83.D1.81.D0.BA_.D0.BF.D0.BE.D0.B4_.D0.B4.D1.80.D1.83.D0.B3.D0.B8.D0.BC_.D0.BF.D0.BE.D0.BB.D1.8C.D0.B7.D0.BE.D0.B2.D0.B0.D1.82.D0.B5.D0.BB.D0.B5.D0.BC"></span><span class="mw-headline" id="Запуск_под_другим_пользователем">Запуск под другим пользователем</span>
</h4>
<p>По умолчанию запускается мастер-процесс <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=nginx">nginx</a></span> от имени <code>root</code>, а он в свою очередь запускает рабочие процессы от имени пользователя <code>http</code>. Для запуска рабочих процессов от имени другого пользователя измените значение директивы <code>user</code> в файле <code>nginx.conf</code>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/nginx/nginx.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">user <i>пользователь</i> [<i>группа</i>];
</pre>
<p>Если группа не указана, будет использоваться группа, совпадающая с указанным именем пользователя.
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Совет:</strong> Можно запустить nginx без прав <code>root</code> через <a href="../ru/Systemd.html" title="Systemd (Русский)">systemd</a>. Смотрите <a href="#%D0%97%D0%B0%D0%BF%D1%83%D1%81%D0%BA_%D0%B1%D0%B5%D0%B7_%D0%BF%D1%80%D0%B8%D0%B2%D0%B8%D0%BB%D0%B5%D0%B3%D0%B8%D0%B9_%D1%87%D0%B5%D1%80%D0%B5%D0%B7_systemd">#Запуск без привилегий через systemd</a>.</div>
<h4>
<span id=".D0.91.D0.BB.D0.BE.D0.BA.D0.B8_server"></span><span class="mw-headline" id="Блоки_server">Блоки server</span>
</h4>
<p>Посредством добавления блоков <code>server</code> в файл настроек возможно обслуживать сразу несколько доменов одновременно. Эти блоки работают аналогично "VirtualHosts" в <a href="../en/Apache_HTTP_Server.html" class="mw-redirect" title="Apache HTTP Server (Русский)">Apache</a>.
Смотрите также <a rel="nofollow" class="external text" href="https://www.nginx.com/resources/wiki/start/topics/examples/server_blocks/">примеры в официальной документации</a>.
</p>
<p>В этом примере сервер принимает запросы для двух доменов: <code>domainname1.dom</code> и <code>domainname2.dom</code>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/nginx/nginx.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">...
server {
    listen 80;
    listen [::]:80;
    server_name domainname1.dom;
    root /usr/share/nginx/domainname1.dom/html;
    location / {
        index index.php index.html index.htm;
    }
}

server {
    listen 80;
    listen [::]:80;
    server_name domainname2.dom;
    root /usr/share/nginx/domainname2.dom/html;
    ...
}
</pre>
<p><a href="../ru/Help:Reading.html#%D0%A3%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5_%D1%8E%D0%BD%D0%B8%D1%82%D0%B0%D0%BC%D0%B8_systemd" class="mw-redirect" title="Перезапустите">Перезапустите</a> службу <code>nginx.service</code>, чтобы изменения вступили в силу.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> Убедитесь, что указанные домены существуют и указывают на IP-адрес устройства, на котором запущен nginx. Вы можете настроить DNS-сервер, например <a href="../en/BIND.html" title="BIND">BIND</a> или <a href="../en/Dnsmasq.html" class="mw-redirect" title="Dnsmasq (Русский)">dnsmasq</a>, или посмотрите варианты <a href="../ru/Network_configuration.html#%D0%A0%D0%B0%D0%B7%D1%80%D0%B5%D1%88%D0%B5%D0%BD%D0%B8%D0%B5_%D0%B8%D0%BC%D1%91%D0%BD_%D0%B2_%D0%BB%D0%BE%D0%BA%D0%B0%D0%BB%D1%8C%D0%BD%D0%BE%D0%B9_%D1%81%D0%B5%D1%82%D0%B8" title="Network configuration (Русский)">разрешения имён в локальной сети</a>.</div>
<h5>
<span id=".D0.A3.D0.BF.D1.80.D0.B0.D0.B2.D0.BB.D0.B5.D0.BD.D0.B8.D0.B5_.D0.B1.D0.BB.D0.BE.D0.BA.D0.B0.D0.BC.D0.B8_server"></span><span class="mw-headline" id="Управление_блоками_server">Управление блоками server</span>
</h5>
<p>Для удобства можно поместить разные блоки <code>server</code> в разные файлы. Это также позволит включать и отключать отдельные сайты.
</p>
<p>Создайте следующие каталоги:
</p>
<pre># mkdir /etc/nginx/sites-available
# mkdir /etc/nginx/sites-enabled
</pre>
<p>Внутри каталога <code>sites-available</code> создайте файл, содержащий один или несколько блоков server:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/nginx/sites-available/example.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;

    ...
}
</pre>
<p>В файле <code>nginx.conf</code> конце блока <code>http</code> добавьте строку <code>include sites-enabled/*;</code>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/nginx/nginx.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">http {
    ...
    include sites-enabled/*;
}
</pre>
<p>Чтобы включить сайт, в каталоге <code>sites-enabled</code> создайте символическую ссылку на связанный с ним файл:
</p>
<pre># ln -s /etc/nginx/sites-available/example.conf /etc/nginx/sites-enabled/example.conf
</pre>
<p>А чтобы отключить сайт, удалите её:
</p>
<pre># unlink /etc/nginx/sites-enabled/example.conf
</pre>
<p><a href="../ru/Help:Reading.html#%D0%A3%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5_%D1%8E%D0%BD%D0%B8%D1%82%D0%B0%D0%BC%D0%B8_systemd" class="mw-redirect" title="Перезапустите">Перезапустите</a> службу <code>nginx.service</code> или перезагрузите конфигурацию (reload), чтобы изменения вступили в силу.
</p>
<h4><span class="mw-headline" id="TLS">TLS</span></h4>
<p><span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=openssl">openssl</a></span> предоставляет поддержку TLS/SSL и установлен по умолчанию на установленных Arch.
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Совет:</strong> 
<ul>
<li>Перед тем как настраивать SSL, вы можете почитать документацию <a rel="nofollow" class="external text" href="https://nginx.org/ru/docs/http/ngx_http_ssl_module.html#ssl_certificate">ngx_http_ssl_module</a>
</li>
<li>
<a href="../ru/Certbot.html" title="Certbot (Русский)">Let's Encrypt</a> — это бесплатный, автоматизированный и открытый центр сертификации. Есть плагин для получения доверенных SSL-сертификатов прямо из командной строки и автоматической настройки.</li>
<li>На сайте Mozilla есть полезная <a href="https://wiki.mozilla.org/Security/Server_Side_TLS" class="extiw" title="mozillawiki:Security/Server Side TLS">статья про TLS</a>, а также <a rel="nofollow" class="external text" href="https://mozilla.github.io/server-side-tls/ssl-config-generator/">инструмент</a>, помогающий составить безопасную конфигурацию.</li>
</ul>
</div>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Важно:</strong> Если вы планируете развернуть SSL/TLS, вы должны знать, что некоторые вариации и реализации <a rel="nofollow" class="external text" href="https://weakdh.org/#affected">всё ещё</a> <a href="https://en.wikipedia.org/wiki/Transport_Layer_Security#Attacks_against_TLS.2FSSL" class="extiw" title="wikipedia:Transport Layer Security">подвержены атакам</a>. За дополнительной информацией о текущих подверженных версиях этих реализаций SSL/TLS и как применить нужные настройки к nginx посетите <a rel="nofollow" class="external free" href="https://disablessl3.com/">https://disablessl3.com/</a> и <a rel="nofollow" class="external free" href="https://weakdh.org/sysadmin.html">https://weakdh.org/sysadmin.html</a>
</div>
<p>Создайте секретный ключ и самоподписанный сертификат. Это подходит для большинства случаев, в которых не требуется  <a href="https://en.wikipedia.org/wiki/Certificate_signing_request" class="extiw" title="wikipedia:Certificate signing request">CSR</a>:
</p>
<pre># cd /etc/nginx/
# openssl req -new -x509 -nodes -newkey rsa:4096 -keyout nginx.key -out nginx.crt -days 1095
# chmod 400 nginx.key
# chmod 444 nginx.crt
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong>  Опция -days является необязательной, а RSA keysize можно уменьшить до 2048 (по умолчанию).</div>
<p>Если же вам нужно создать <a href="https://en.wikipedia.org/wiki/Certificate_signing_request" class="extiw" title="wikipedia:Certificate signing request">CSR</a>, то следуйте данным инструкциям по созданию ключа, вместо приведённых выше:
</p>
<pre># openssl genpkey -algorithm RSA -pkeyopt rsa_keygen_bits:4096 -out nginx.key
# chmod 400 nginx.key
# openssl req -new -sha256 -key nginx.key -out nginx.csr
# openssl x509 -req -days 1095 -in nginx.csr -signkey nginx.key -out nginx.crt
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> Подробнее о доступных опциях <i>openssl</i> можно узнать в man-странице <span class="plainlinks archwiki-template-man" title="$ man 1ssl openssl"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/openssl.1ssl">openssl(1ssl)</a></span> или в <a rel="nofollow" class="external text" href="https://www.openssl.org/docs/">документации на официальном сайте</a>.</div>
<p>В качестве отправкой точки для создания конфигурации TLS в <code>/etc/nginx/nginx.conf</code> можно использовать <a rel="nofollow" class="external text" href="https://ssl-config.mozilla.org/#server=nginx">генератор настроек SSL от Mozilla</a>.
</p>
<p><a href="../ru/Help:Reading.html#%D0%A3%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5_%D1%8E%D0%BD%D0%B8%D1%82%D0%B0%D0%BC%D0%B8_systemd" class="mw-redirect" title="Перезапустите">Перезапустите</a> службу <code>nginx</code>, чтобы изменения вступили в силу.
</p>
<h4>
<span id=".D0.9F.D0.BE.D0.BB.D1.8C.D0.B7.D0.BE.D0.B2.D0.B0.D1.82.D0.B5.D0.BB.D1.8C.D1.81.D0.BA.D0.B8.D0.B5_.D0.BA.D0.B0.D1.82.D0.B0.D0.BB.D0.BE.D0.B3.D0.B8"></span><span class="mw-headline" id="Пользовательские_каталоги">Пользовательские каталоги</span>
</h4>
<p>Чтобы сделать Apache-подобные адреса вида <code>~пользователь</code>, указывающие на пользовательские каталоги <code>~/public_html</code>, используйте подобную конфигурацию. (Примечание: если вы планируете использовать PHP, то связанный с ним location должен стоять первым.)
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/nginx/nginx.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">...
server {
    ...
    # Обработка файлов PHP в пользовательских каталогах, например http://example.com/~user/test.php
    location ~ ^/~(.+?)(/.+\.php)$ {
        alias          /home/$1/public_html$2;
        fastcgi_pass   unix:/run/php-fpm/php-fpm.sock;
        fastcgi_index  index.php;
        include        fastcgi.conf;
    }

    # Пользовательские каталоги, например http://example.com/~user/
    location ~ ^/~(.+?)(/.*)?$ {
        alias     /home/$1/public_html$2;
        index     index.html index.htm;
        autoindex on;
    }
    ...
}
...
</pre>
<p>Подробнее о настройке PHP в <code>nginx</code> смотрите в разделе <a href="#%D0%A0%D0%B5%D0%B0%D0%BB%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F_PHP">#Реализация PHP</a>.
</p>
<p><a href="../ru/Help:Reading.html#%D0%A3%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5_%D1%8E%D0%BD%D0%B8%D1%82%D0%B0%D0%BC%D0%B8_systemd" class="mw-redirect" title="Перезапустите">Перезапустите</a> службу <code>nginx.service</code>, чтобы изменения вступили в силу.
</p>
<h3><span class="mw-headline" id="FastCGI">FastCGI</span></h3>
<p>FastCGI или просто FCGI — это протокол, являющийся интерфейсом между веб-сервером и интерактивными программами. Это модифицированный CGI (<i>Common Gateway Interface</i>), главная цель которого — снизить накладные расходы, связанные со взаимодействием веб сервера и CGI программ, тем самым позволяя серверу обрабатывать большее количество запросов одновременно.
</p>
<p>Технология FastCGI встроена в nginx для работы со многими внешними инструментами, например, Perl, <a href="../en/PHP.html" class="mw-redirect" title="PHP (Русский)">PHP</a> и <a href="../ru/Python.html" title="Python (Русский)">Python</a>.
</p>
<h4>
<span id=".D0.A0.D0.B5.D0.B0.D0.BB.D0.B8.D0.B7.D0.B0.D1.86.D0.B8.D1.8F_PHP"></span><span class="mw-headline" id="Реализация_PHP">Реализация PHP</span>
</h4>
<p>В качестве FastCGI-сервера для PHP рекомендуется использовать <a rel="nofollow" class="external text" href="https://php-fpm.org/">PHP-FPM</a>.
</p>
<p><a href="../ru/Help:Reading.html#%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0_%D0%BF%D0%B0%D0%BA%D0%B5%D1%82%D0%BE%D0%B2" class="mw-redirect" title="Установите">Установите</a> пакет <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=php-fpm">php-fpm</a></span> и проверьте корректность настроек <a href="../en/PHP.html" class="mw-redirect" title="PHP (Русский)">PHP</a>.
Основным конфигурационным файлом PHP-FPM является <code>/etc/php/php-fpm.conf</code>. <a href="../ru/Help:Reading.html#%D0%A3%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5_%D1%8E%D0%BD%D0%B8%D1%82%D0%B0%D0%BC%D0%B8_systemd" class="mw-redirect" title="Включите">Включите</a> и <a href="../ru/Help:Reading.html#%D0%A3%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5_%D1%8E%D0%BD%D0%B8%D1%82%D0%B0%D0%BC%D0%B8_systemd" class="mw-redirect" title="Запустите">запустите</a> <a href="../ru/Systemd.html" title="Systemd (Русский)">systemd</a> службу <code>php-fpm</code>.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> 
<ul>
<li>Если вы <a href="#%D0%97%D0%B0%D0%BF%D1%83%D1%81%D0%BA_%D0%BF%D0%BE%D0%B4_%D0%B4%D1%80%D1%83%D0%B3%D0%B8%D0%BC_%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D1%82%D0%B5%D0%BB%D0%B5%D0%BC">запускаете nginx под другим пользователем</a>, убедитесь, что Unix-сокет PHP-FPM доступен этому пользователю, или используйте TCP-сокет.</li>
<li>Если вы запускаете nginx в изолированном окружении (к примеру, chroot находится в <code>/srv/nginx-jail</code>, веб-документы расположены в <code>/srv/nginx-jail/www</code>), то вы должны в <code>/etc/php/php-fpm.conf</code> добавить опции <code>chroot /srv/nginx-jail</code> и <code>listen = /srv/nginx-jail/run/php-fpm/php-fpm.sock</code> внутри секции пула (по умолчанию это <code>[www]</code>). Создайте каталог для файла сокета, если его нет. Более того, для модулей, которые динамически связаны с зависимостями, вам нужно будет скопировать эти зависимости в chroot (например, для php-imagick вам нужно будет скопировать в chroot библиотеки ImageMagick, но не сам imagick.so).</li>
</ul>
</div>
<h5>
<span id=".D0.9D.D0.B0.D1.81.D1.82.D1.80.D0.BE.D0.B9.D0.BA.D0.B0_nginx"></span><span class="mw-headline" id="Настройка_nginx">Настройка nginx</span>
</h5>
<p>Внутри каждого блока <code>server</code>, который обслуживает веб-приложение PHP, должен находиться блок <code>location</code> <a rel="nofollow" class="external autonumber" href="https://www.nginx.com/resources/wiki/start/topics/examples/phpfcgi/">[1]</a>, например:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/nginx/sites-available/example.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">server {
    root /usr/share/nginx/html;

    location / {
        index index.html index.htm index.php;
    }

    location ~ \.php$ {
        # 404
        try_files $fastcgi_script_name =404;

        # default fastcgi_params
        include fastcgi_params;

        # fastcgi settings
        fastcgi_pass			unix:/run/php-fpm/php-fpm.sock;
        fastcgi_index			index.php;
        fastcgi_buffers			8 16k;
        fastcgi_buffer_size		32k;

        # fastcgi params
        fastcgi_param DOCUMENT_ROOT	$realpath_root;
        fastcgi_param SCRIPT_FILENAME	$realpath_root$fastcgi_script_name;
        #fastcgi_param PHP_ADMIN_VALUE	"open_basedir=$base/:/usr/lib/php/:/tmp/";
    }
}
</pre>
<p>Если требуется обрабатывать другие расширения наряду с PHP (например <i>.html</i> и <i>.htm</i>):
</p>
<pre>location ~ [^/]\.(php|html|htm)(/|$) {
    ...
}
</pre>
<p>Все расширения, обрабатываемые в php-fpm должны быть также явно добавлены в
<code>/etc/php/php-fpm.d/www.conf</code>:
</p>
<pre>security.limit_extensions = .php .html .htm
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> Аргумент <code>fastcgi_pass</code> должен быть определен как TCP-сокет или сокет Unix выбранным FastCGI сервером в его конфигурационном файле. <b>По умолчанию</b> для <code>php-fpm</code> используется сокет
<pre>fastcgi_pass unix:/run/php-fpm/php-fpm.sock;
</pre>
<p>Вы можете использовать также общий TCP-сокет:
</p>
<pre>fastcgi_pass 127.0.0.1:9000;
</pre>
Однако, доменные сокеты Unix должны работать быстрее.</div>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Совет:</strong> Если несколько блоков <code>server</code> используют одну и ту же конфигурацию PHP-FPM, можно вынести общие настройки в отдельный файл для удобства, например <code>php_fastcgi.conf</code>:
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/nginx/php_fastcgi.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">location ~ \.php$ {
    # 404
    try_files $fastcgi_script_name =404;

    # default fastcgi_params
    include fastcgi_params;

    # fastcgi settings
    ...
}
</pre>
<p>И затем подключать этот файл в тех блоках server, в которых нужна обработка PHP:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/nginx/sites-available/example.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">server {
    server_name example.com;
    ...

    include /etc/nginx/php_fastcgi.conf;
}
</pre>
</div>
<h5>
<span id=".D0.9F.D1.80.D0.BE.D0.B2.D0.B5.D1.80.D0.BA.D0.B0_.D0.BA.D0.BE.D0.BD.D1.84.D0.B8.D0.B3.D1.83.D1.80.D0.B0.D1.86.D0.B8.D0.B8"></span><span class="mw-headline" id="Проверка_конфигурации">Проверка конфигурации</span>
</h5>
<p><a href="../ru/Help:Reading.html#%D0%A3%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5_%D1%8E%D0%BD%D0%B8%D1%82%D0%B0%D0%BC%D0%B8_systemd" class="mw-redirect" title="Перезапустите">Перезапустите</a> службы <code>php-fpm</code> и <code>nginx</code> после изменения настроек, чтобы изменения вступили в силу.
</p>
<p>Чтобы проверить работу FastCGI, создайте новый файл <i>.php</i> внутри каталога веб-документов, содержащий:
</p>
<pre>&lt;?php
  phpinfo();
?&gt;
</pre>
<p>При открытии файла в браузере должна отобразиться информационная страница с текущими настройками PHP.
</p>
<h4>
<span id=".D0.A0.D0.B5.D0.B0.D0.BB.D0.B8.D0.B7.D0.B0.D1.86.D0.B8.D1.8F_CGI"></span><span class="mw-headline" id="Реализация_CGI">Реализация CGI</span>
</h4>
<p>Эта реализация нужна для CGI-приложений.
</p>
<h5><span class="mw-headline" id="fcgiwrap">fcgiwrap</span></h5>
<p><a href="../ru/Help:Reading.html#%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0_%D0%BF%D0%B0%D0%BA%D0%B5%D1%82%D0%BE%D0%B2" class="mw-redirect" title="Установите">Установите</a> <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=fcgiwrap">fcgiwrap</a></span>. Настроить его можно путём <a href="../ru/Systemd.html#%D0%A0%D0%B5%D0%B4%D0%B0%D0%BA%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_%D1%84%D0%B0%D0%B9%D0%BB%D0%BE%D0%B2_%D1%8E%D0%BD%D0%B8%D1%82%D0%BE%D0%B2" title="Systemd (Русский)">редактирования юнита</a> <code>fcgiwrap.socket</code>. <a href="../ru/Help:Reading.html#%D0%A3%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5_%D1%8E%D0%BD%D0%B8%D1%82%D0%B0%D0%BC%D0%B8_systemd" class="mw-redirect" title="Включите">Включите</a> и <a href="../ru/Help:Reading.html#%D0%A3%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5_%D1%8E%D0%BD%D0%B8%D1%82%D0%B0%D0%BC%D0%B8_systemd" class="mw-redirect" title="Запустите">запустите</a> <code>fcgiwrap.socket</code>.
</p>
<h6>
<span id=".D0.9D.D0.B5.D1.81.D0.BA.D0.BE.D0.BB.D1.8C.D0.BA.D0.BE_.D1.80.D0.B0.D0.B1.D0.BE.D1.87.D0.B8.D1.85_.D0.BF.D0.BE.D1.82.D0.BE.D0.BA.D0.BE.D0.B2"></span><span class="mw-headline" id="Несколько_рабочих_потоков">Несколько рабочих потоков</span>
</h6>
<p>Если вы хотите породить несколько рабочих потоков, вам рекомендуется использовать <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/multiwatch/">multiwatch</a></span><sup><small>AUR</small></sup>, который умеет отслеживать упавшие подпроцессы и перезапускать их. Вам нужно использовать <code>spawn-fcgi</code>, чтобы создать доменный сокет Unix, так как multiwatch не может обрабатывать сокеты, созданные <a href="../ru/Systemd.html" title="Systemd (Русский)">systemd</a>, однако, <i>fcgiwrap</i> сама по себе не вызывает никаких проблем, если вызывается непосредственно из юнит-файла.
</p>
<p>Сделайте <a href="../ru/Systemd.html#%D0%97%D0%B0%D0%BC%D0%B5%D1%89%D0%B5%D0%BD%D0%B8%D0%B5_%D1%84%D0%B0%D0%B9%D0%BB%D0%B0_%D1%8E%D0%BD%D0%B8%D1%82%D0%B0" title="Systemd (Русский)">замещение файла юнита</a> <code>fcgiwrap.service</code> (и юнита <code>fcgiwrap.socket</code>, если он есть), и отредактируйте строку <code>ExecStart</code> в соответствии с вашими нуждами. В примере показан юнит файл, который использует <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/multiwatch/">multiwatch</a></span><sup><small>AUR</small></sup>. Убедитесь, что <code>fcgiwrap.socket</code> не включен и не запущен, потому что он будет конфликтовать с этим юнитом:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/fcgiwrap.service</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Unit]
Description=Simple CGI Server
After=nss-user-lookup.target

[Service]
ExecStartPre=/bin/rm -f /run/fcgiwrap.socket
ExecStart=/usr/bin/spawn-fcgi -u http -g http -s /run/fcgiwrap.sock -n -- /usr/bin/multiwatch -f 10 -- /usr/sbin/fcgiwrap
ExecStartPost=/usr/bin/chmod 660 /run/fcgiwrap.sock
PrivateTmp=true
Restart=on-failure

[Install]
WantedBy=multi-user.target</pre>
<p>Выберите подходящий <code>-f 10</code>, чтобы изменить количество порождаемых подпроцессов.
</p>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Важно:</strong> Строка <code>ExecStartPost</code> требуется из-за странного поведения, которое я наблюдаю при использовании опции <code>-M 660</code> для <code>spawn-fcgi</code>. Устанавливается неправильный режим. Может это баг?</div>
<h5>
<span id=".D0.9D.D0.B0.D1.81.D1.82.D1.80.D0.BE.D0.B9.D0.BA.D0.B0_nginx_2"></span><span class="mw-headline" id="Настройка_nginx_2">Настройка nginx</span>
</h5>
<p>В каталоге <code>/etc/nginx</code> скопируйте файл <code>fastcgi_params</code> в <code>fcgiwrap_params</code>. В файле <code>fcgiwrap_params</code> удалите строки, которые устанавливают <code>SCRIPT_NAME</code> и <code>DOCUMENT_ROOT</code>.
</p>
<p>Внутри каждого блока <code>server</code> CGI-приложения должен находиться вложенный блок <code>location</code>:
</p>
<pre>location ~ \.cgi$ {
     include       fcgiwrap_params;
     fastcgi_param DOCUMENT_ROOT /srv/www/cgi-bin/;
     fastcgi_param SCRIPT_NAME   myscript.cgi;
     fastcgi_pass  unix:/run/fcgiwrap.sock;
}
</pre>
<p>Сокетом по умолчанию для <code>fcgiwrap</code> является <code>/run/fcgiwrap.sock</code>.
</p>
<p>Вместо параметров <code>DOCUMENT_ROOT</code> и <code>SCRIPT_NAME</code> можно использовать более короткую альтернативу <code>fastcgi_param SCRIPT_FILENAME /srv/www/cgi-bin/myscript.cgi</code>. При её использовании не понадобится копировать <code>fastcgi_params</code> в <code>fcgiwrap_params</code> и удалять строки <code>DOCUMENT_ROOT</code> and <code>SCRIPT_NAME</code>.
</p>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Важно:</strong> Если используются SCRIPT_NAME и DOCUMENT_ROOT, fcgiwrap будет <i>отклонять</i> любые другие fastcgi_param, установленные в nginx. Вы должны использовать SCRIPT_FILENAME для того, чтобы другие параметры (например, PATH_INFO) могли быть установлены через конфигурацию Nginx. <a rel="nofollow" class="external text" href="https://github.com/gnosek/fcgiwrap/issues/3">Подробнее на GitHub.</a>
</div>
<p>Если вы продолжаете получать ошибку <code>502 - bad Gateway</code>, проверьте, передаёт ли ли ваше CGI-приложение mime-тип содержимого. Для html это должно быть <code>Content-type: text/html</code>.
</p>
<p>Если вы получаете ошибки 403, убедитесь, что CGI-файл доступен для чтения и выполнения пользователю <code>http</code> и что каждая родительская папка доступна ему для чтения.
</p>
<h2>
<span id=".D0.A3.D1.81.D1.82.D0.B0.D0.BD.D0.BE.D0.B2.D0.BA.D0.B0_.D0.B2_chroot"></span><span class="mw-headline" id="Установка_в_chroot">Установка в chroot</span>
</h2>
<p>Установка nginx в <a href="../ru/Chroot.html" class="mw-redirect" title="Change root (Русский)">chroot</a> добавляет дополнительный уровень безопасности. Для максимальной безопасности chroot должен включать только файлы, необходимые для запуска сервера nginx, при этом все файлы должны иметь по возможности максимально ограниченные права доступа. Например, как можно больше файлов должно принадлежать пользователю root, а таким каталогам, как <code>/usr/bin</code> должен быть установлен запрет на чтение и запись.
</p>
<p>Arch поставляется с пользователем <code>http</code> и группой по умолчанию, от имени которых запускается сервер. Измененный корневой каталог будет находиться в <code>/srv/http</code>.
</p>
<p>Существует perl-скрипт для создания chroot-окружения, который доступен в <a rel="nofollow" class="external text" href="https://gist.github.com/4365696">jail.pl gist</a>. Вы можете либо использовать его, либо следовать дальнейшим инструкциям из этой статьи. Скрипт требует прав суперпользователя для работы. Вам нужно будет раскомментировать строку, перед тем, как он сможет выполнять какие-либо изменения.
</p>
<h3>
<span id=".D0.A1.D0.BE.D0.B7.D0.B4.D0.B0.D0.BD.D0.B8.D0.B5_.D0.BD.D0.B5.D0.BE.D0.B1.D1.85.D0.BE.D0.B4.D0.B8.D0.BC.D1.8B.D1.85_.D1.83.D1.81.D1.82.D1.80.D0.BE.D0.B9.D1.81.D1.82.D0.B2"></span><span class="mw-headline" id="Создание_необходимых_устройств">Создание необходимых устройств</span>
</h3>
<p>Для nginx нужны <code>/dev/null</code>, <code>/dev/random</code> и <code>/dev/urandom</code>. Чтобы установить их в chroot мы создадим каталог <code>/dev</code> и добавим устройства с помощью <i>mknod</i>. Избегайте монтирования всех устройств в <code>/dev</code>: тогда, даже если chroot будет скомпрометирован, атакующий должен будет выбраться из chroot-окружения чтобы добраться до важных устройств, например <code>/dev/sda1</code>.
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Совет:</strong> Убедитесь, что <code>/src/http</code> примонтирован без опции no-dev</div>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Совет:</strong> Смотрите <span class="plainlinks archwiki-template-man" title="$ man 1 mknod"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/mknod.1">mknod(1)</a></span> и <code>ls -l /dev/{null,random,urandom}</code>, чтобы лучше понять опции <i>mknod</i>.</div>
<pre># export JAIL=/srv/http
# mkdir $JAIL/dev
# mknod -m 0666 $JAIL/dev/null c 1 3
# mknod -m 0666 $JAIL/dev/random c 1 8
# mknod -m 0444 $JAIL/dev/urandom c 1 9
</pre>
<h3>
<span id=".D0.A1.D0.BE.D0.B7.D0.B4.D0.B0.D0.BD.D0.B8.D0.B5_.D0.BD.D0.B5.D0.BE.D0.B1.D1.85.D0.BE.D0.B4.D0.B8.D0.BC.D1.8B.D1.85_.D0.BA.D0.B0.D1.82.D0.B0.D0.BB.D0.BE.D0.B3.D0.BE.D0.B2"></span><span class="mw-headline" id="Создание_необходимых_каталогов">Создание необходимых каталогов</span>
</h3>
<p>Для работы nginx требует определенный набор файлов. Перед тем, как их копировать, создайте для них соответствующие каталоги. Предполагается, что ваш корневой каталог веб-документов nginx находится в <code>/srv/http/www</code>.
</p>
<pre># mkdir -p $JAIL/etc/nginx/logs
# mkdir -p $JAIL/usr/{lib,bin}
# mkdir -p $JAIL/usr/share/nginx
# mkdir -p $JAIL/var/{log,lib}/nginx
# mkdir -p $JAIL/www/cgi-bin
# mkdir -p $JAIL/{run,tmp}
# cd $JAIL; ln -s usr/lib lib
# cd $JAIL; ln -s usr/lib lib64
# cd $JAIL/usr; ln -s lib lib64
</pre>
<p>Затем смонтируйте <code>$JAIL/tmp</code> и <code>$JAIL/run</code> как tmpfs-ы. Размер должен быть ограничен, чтобы быть уверенным, что атакующий не сможет занять всю доступную RAM.
</p>
<pre># mount -t tmpfs none $JAIL/run -o 'noexec,size=1M'
# mount -t tmpfs none $JAIL/tmp -o 'noexec,size=100M'
</pre>
<p>Для того, чтобы монтирование выполнялось автоматически при загрузке системы, добавьте следующие записи в <code>/etc/fstab</code>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/fstab</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;"> tmpfs   /srv/http/run   tmpfs   rw,noexec,relatime,size=1024k   0       0
 tmpfs   /srv/http/tmp   tmpfs   rw,noexec,relatime,size=102400k 0       0
</pre>
<h3>
<span id=".D0.97.D0.B0.D0.BF.D0.BE.D0.BB.D0.BD.D0.B5.D0.BD.D0.B8.D0.B5_chroot"></span><span class="mw-headline" id="Заполнение_chroot">Заполнение chroot</span>
</h3>
<p>Сначала скопируйте простые файлы.
</p>
<pre># cp -r /usr/share/nginx/* $JAIL/usr/share/nginx
# cp -r /usr/share/nginx/html/* $JAIL/www
# cp /usr/bin/nginx $JAIL/usr/bin/
# cp -r /var/lib/nginx $JAIL/var/lib/nginx
</pre>
<p>Теперь скопируйте нужные библиотеки. Используйте <i>ldd</i>, чтобы отобразить их и скопируйте все файлы в правильное место. Копирование предпочтительнее, чем создание жестких ссылок, потому, что даже если атакующий получит права записи в файлы, они не смогут уничтожить или изменить системные файлы вне chroot-окружения.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">$ ldd /usr/bin/nginx</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">linux-vdso.so.1 (0x00007fffc41fe000)
libpthread.so.0 =&gt; /usr/lib/libpthread.so.0 (0x00007f57ec3e8000)
libcrypt.so.1 =&gt; /usr/lib/libcrypt.so.1 (0x00007f57ec1b1000)
libstdc++.so.6 =&gt; /usr/lib/libstdc++.so.6 (0x00007f57ebead000)
libm.so.6 =&gt; /usr/lib/libm.so.6 (0x00007f57ebbaf000)
libpcre.so.1 =&gt; /usr/lib/libpcre.so.1 (0x00007f57eb94c000)
libssl.so.1.0.0 =&gt; /usr/lib/libssl.so.1.0.0 (0x00007f57eb6e0000)
libcrypto.so.1.0.0 =&gt; /usr/lib/libcrypto.so.1.0.0 (0x00007f57eb2d6000)
libdl.so.2 =&gt; /usr/lib/libdl.so.2 (0x00007f57eb0d2000)
libz.so.1 =&gt; /usr/lib/libz.so.1 (0x00007f57eaebc000)
libGeoIP.so.1 =&gt; /usr/lib/libGeoIP.so.1 (0x00007f57eac8d000)
libgcc_s.so.1 =&gt; /usr/lib/libgcc_s.so.1 (0x00007f57eaa77000)
libc.so.6 =&gt; /usr/lib/libc.so.6 (0x00007f57ea6ca000)
/lib64/ld-linux-x86-64.so.2 (0x00007f57ec604000)</pre>
<p>Для файлов, находящихся в <code>/usr/lib</code>, вы можете воспользоваться следующей командой:
</p>
<pre># cp $(ldd /usr/bin/nginx | grep /usr/lib | sed -sre 's/(.+)(\/usr\/lib\/\S+).+/\2/g') $JAIL/usr/lib
</pre>
<p>А для <code>ld-linux-x86-64.so</code> — следующей командой:
</p>
<pre># cp /lib64/ld-linux-x86-64.so.2 $JAIL/lib
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> Не пытайтесь скопировать <code>linux-vdso.so</code> — это не настоящая библиотека и ее не существует в <code>/usr/lib</code>.</div>
<p>Копируйте другие необходимые библиотеки и системные файлы.
</p>
<pre># cp /usr/lib/libnss_* $JAIL/usr/lib
# cp -rfvL /etc/{services,localtime,nsswitch.conf,nscd.conf,protocols,hosts,ld.so.cache,ld.so.conf,resolv.conf,host.conf,nginx} $JAIL/etc
</pre>
<p>Создайте файлы пользователей и групп в chroot-окружении. Таким образом, в chroot-окружении будут доступны только указанные пользователи, и никакая информация о пользователях из основной системы не будет доступна атакующему, получившему доступ в chroot-окружение.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">$JAIL/etc/group</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">http:x:33:
nobody:x:99:
</pre>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">$JAIL/etc/passwd</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">http:x:33:33:http:/:/bin/false
nobody:x:99:99:nobody:/:/bin/false
</pre>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">$JAIL/etc/shadow</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">http:x:14871::::::
nobody:x:14871::::::
</pre>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">$JAIL/etc/gshadow</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">http:::
nobody:::
</pre>
<pre># touch $JAIL/etc/shells
# touch $JAIL/run/nginx.pid
</pre>
<p>Наконец, сделайте права доступа максимально ограниченными. Как можно больше должно принадлежать суперпользователю и быть закрытым для записи.
</p>
<pre># chown -R root:root $JAIL/

# chown -R http:http $JAIL/www
# chown -R http:http $JAIL/etc/nginx
# chown -R http:http $JAIL/var/{log,lib}/nginx
# chown http:http $JAIL/run/nginx.pid

# find $JAIL/ -gid 0 -uid 0 -type d -print | xargs chmod -rw
# find $JAIL/ -gid 0 -uid 0 -type d -print | xargs chmod +x
# find $JAIL/etc -gid 0 -uid 0 -type f -print | xargs chmod -x
# find $JAIL/usr/bin -type f -print | xargs chmod ug+rx
# find $JAIL/ -group http -user http -print | xargs chmod o-rwx
# chmod +rw $JAIL/tmp
# chmod +rw $JAIL/run
</pre>
<p>Если ваш сервер будет принимать входящие соединения на 80 порту (или любому другому порту в диапазоне [1-1023]), дайте исполняемому файлу внутри chroot права на использование этих портов без прав суперпользователя.
</p>
<pre># setcap 'cap_net_bind_service=+ep' $JAIL/usr/bin/nginx
</pre>
<h3>
<span id=".D0.9E.D1.82.D1.80.D0.B5.D0.B4.D0.B0.D0.BA.D1.82.D0.B8.D1.80.D1.83.D0.B9.D1.82.D0.B5_nginx.service_.D0.B4.D0.BB.D1.8F_.D0.B7.D0.B0.D0.BF.D1.83.D1.81.D0.BA.D0.B0_chroot"></span><span class="mw-headline" id="Отредактируйте_nginx.service_для_запуска_chroot">Отредактируйте nginx.service для запуска chroot</span>
</h3>
<p>Сделайте <a href="../ru/Systemd.html#%D0%97%D0%B0%D0%BC%D0%B5%D1%89%D0%B5%D0%BD%D0%B8%D0%B5_%D1%84%D0%B0%D0%B9%D0%BB%D0%B0_%D1%8E%D0%BD%D0%B8%D1%82%D0%B0" title="Systemd (Русский)">замещение файла юнита</a> <code>nginx.service</code> — тогда обновление nginx не изменит ваш файл <i>.service</i>.
</p>
<p>Юнит systemd должен быть настроен так, чтобы запускать nginx в chroot от имени пользователя http и хранить pid-файл в chroot.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> Я не уверен, нужно ли хранить pid-файл в chroot.</div>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/nginx.service</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Unit]
Description=A high performance web server and a reverse proxy server
After=network.target

[Service]
Type=forking
PIDFile=/srv/http/run/nginx.pid
ExecStartPre=/usr/bin/chroot --userspec=http:http /srv/http /usr/bin/nginx -t -q -g 'pid /run/nginx.pid; daemon on; master_process on;'
ExecStart=/usr/bin/chroot --userspec=http:http /srv/http /usr/bin/nginx -g 'pid /run/nginx.pid; daemon on; master_process on;'
ExecReload=/usr/bin/chroot --userspec=http:http /srv/http /usr/bin/nginx -g 'pid /run/nginx.pid; daemon on; master_process on;' -s reload
ExecStop=/usr/bin/chroot --userspec=http:http /srv/http /usr/bin/nginx -g 'pid /run/nginx.pid;' -s quit

[Install]
WantedBy=multi-user.target</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> Обновление nginx с помощью pacman не обновит установленную в chroot копию. Вы должны вручную выполнять обновления, повторяя указанные выше шаги по переносу файлов. Не забудьте также обновить библиотеки, которые использует nginx.</div>
<p>Теперь вы можете спокойно удалить nginx, установленный вне chroot.
</p>
<pre># pacman -Rsc nginx
</pre>
<p>Если вы не удалили nginx, установленный вне chroot, проверьте, что работающий процесс nginx — это действительно именно тот, что в находится chroot. Для этого посмотрите, куда указывает символическая ссылка <code>/proc/<i>PID</i>/root</code>: она должна указывать на <code>/srv/http</code>, а не на <code>/</code>.
</p>
<pre># ps -C nginx | awk '{print $1}' | sed 1d | while read -r PID; do ls -l /proc/$PID/root; done
</pre>
<h2>
<span id=".D0.A1.D0.BE.D0.B2.D0.B5.D1.82.D1.8B_.D0.B8_.D1.80.D0.B5.D0.BA.D0.BE.D0.BC.D0.B5.D0.BD.D0.B4.D0.B0.D1.86.D0.B8.D0.B8"></span><span class="mw-headline" id="Советы_и_рекомендации">Советы и рекомендации</span>
</h2>
<h3>
<span id=".D0.97.D0.B0.D0.BF.D1.83.D1.81.D0.BA_.D0.B1.D0.B5.D0.B7_.D0.BF.D1.80.D0.B8.D0.B2.D0.B8.D0.BB.D0.B5.D0.B3.D0.B8.D0.B9_.D1.87.D0.B5.D1.80.D0.B5.D0.B7_systemd"></span><span class="mw-headline" id="Запуск_без_привилегий_через_systemd">Запуск без привилегий через systemd</span>
</h3>
<p>Создайте <a href="../ru/Systemd.html#Drop-in_%D1%84%D0%B0%D0%B9%D0%BB%D1%8B" class="mw-redirect" title="Drop-in файл">drop-in файл</a> для службы <code>nginx.service</code> и пропишите в нём секцию <code>[Service]</code> с опцими <code>User</code> и (опционально) <code>Group</code>, чтобы запустить службу от имени указанного вами непривилегированного пользователя:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/nginx.service.d/user.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Service]
User=<i>пользователь</i>
Group=<i>группа</i></pre>
<p>Также можно запретить повышение привилегий:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/nginx.service.d/user.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Service]
...
NoNewPrivileges=yes</pre>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Совет:</strong> Подробнее о повышающих безопасность опциях можно почитать в <span class="plainlinks archwiki-template-man" title="$ man 5 systemd.exec"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/systemd.exec.5">systemd.exec(5)</a></span>.</div>
<p>После этого нужно убедиться, что <code><i>пользователь</i></code> имеет доступ ко всем необходимым ресурсам. Следуйте инструкциям, описанным в следующих разделах, и затем <a href="../ru/Help:Reading.html#%D0%A3%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5_%D1%8E%D0%BD%D0%B8%D1%82%D0%B0%D0%BC%D0%B8_systemd" class="mw-redirect" title="Запустите">запустите</a> nginx.
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Совет:</strong> Аналогичные настройки можно применить и для <a href="#FastCGI">сервера FastCGI</a>.</div>
<h4>
<span id=".D0.9F.D0.BE.D1.80.D1.82"></span><span class="mw-headline" id="Порт">Порт</span>
</h4>
<p>По умолчанию Linux запрещает не-root процессам слушать порты ниже 1024. Можно использовать порт выше 1024:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/nginx/nginx.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">server {
        listen 8080;
}
</pre>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Совет:</strong> Если вы хотите, чтобы nginx всё равно был доступен на порту 80 или 443, можно настроить <a href="../ru/Category:Firewalls.html" title="Category:Firewalls (Русский)">межсетевой экран</a> для перенаправления запросов с порта 80 или 444 на порт, который использует nginx.</div>
<p>Или можно выдать процессу nginx привилегию CAP_NET_BIND_SERVICE, которая позволит ему использовать порты ниже 1024:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/nginx.service.d/user.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Service]
...
CapabilityBoundingSet=
CapabilityBoundingSet=CAP_NET_BIND_SERVICE
AmbientCapabilities=
AmbientCapabilities=CAP_NET_BIND_SERVICE</pre>
<p>Или можно использовать активацию сокетов systemd. В этом случае systemd будет прослушивать порты и, когда будет установлено соединение, запустит nginx, передав сокет в качестве дескриптора файла. Это означает, что процессу nginx не нужны особые привилегии, так как сокет уже существует на момент запуска. Этот подход опирается на использование внутренней переменной окружения, которую nginx использует для передачи сокетов <a rel="nofollow" class="external autonumber" href="https://trac.nginx.org/nginx/ticket/237">[2]</a>, и поэтому официально не поддерживается. Вместо установки <code>CapabilityBoundingSet</code> и <code>AmbientCapabilities</code> переопределите переменную окружения <code>NGINX</code>, чтобы сообщить процессу nginx, какие файловые дескрипторы будут передаваться сокетам:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/nginx.service.d/user.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Service]
...
Environment=NGINX=3:4;</pre>
<p>На каждый прослушиваемый порт будет приходиться один сокет, начиная с файлового дескриптора 3, поэтому в данном примере мы говорим nginx ожидать два сокета. Теперь создайте юнит <code>nginx.socket</code>, указав, какие порты прослушивать:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/nginx.socket</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Socket]
ListenStream=0.0.0.0:80
ListenStream=0.0.0.0:443
After=network.target
Requires=network.target

[Install]
WantedBy=sockets.target</pre>
<p>Сокеты будут передаваться в порядке, определённом в этом юните, поэтому порт 80 будет файловым дескриптором 3, а порт 443 — файловым дескриптором 4. Если вы ранее включали или запускали службу <code>nginx.service</code>, вам нужно остановить её и включить вместо неё <code>nginx.socket</code>. При запуске системы nginx не будет запущен, но запустится, когда вы зайдете на сайт в браузере. Благодаря этому можно дополнительно защитить службу; например, во многих случаях вы можете установить <code>PrivateNetwork=True</code> в файле службы, блокируя nginx от внешней сети, поскольку сокета, созданного systemd, достаточно для обслуживания веб-сайта. Обратите внимание, что при этом в журналы службы nginx будет выведено предупреждение: <code>2020/08/29 19:33:20 [notice] 254#254: using inherited sockets from "3:4;"</code>
</p>
<h4>
<span id="PID-.D1.84.D0.B0.D0.B9.D0.BB"></span><span class="mw-headline" id="PID-файл">PID-файл</span>
</h4>
<p>По умолчанию <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=nginx">nginx</a></span> использует <code>/run/nginx.pid</code>. Нужно будет создать каталог, в котором <i>пользователь</i> будет иметь право записи, и перенастроить запись PID-файла туда. Например, можно использовать <a href="../ru/Systemd.html#systemd-tmpfiles_%E2%80%94_%D0%B2%D1%80%D0%B5%D0%BC%D0%B5%D0%BD%D0%BD%D1%8B%D0%B5_%D1%84%D0%B0%D0%B9%D0%BB%D1%8B" title="Systemd (Русский)">systemd-tmpfiles</a>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/tmpfiles.d/nginx.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">d /run/nginx 0775 root <i>группа</i> - -</pre>
<p>Примените изменения:
</p>
<pre># systemd-tmpfiles --create
</pre>
<p><a href="../ru/Systemd.html#%D0%A0%D0%B5%D0%B4%D0%B0%D0%BA%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_%D1%84%D0%B0%D0%B9%D0%BB%D0%BE%D0%B2_%D1%8E%D0%BD%D0%B8%D1%82%D0%BE%D0%B2" class="mw-redirect" title="Отредактируйте">Отредактируйте</a> параметры службы, связанные с PID-файлом:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/nginx.service.d/user.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Service]
...
PIDFile=/run/nginx/nginx.pid
ExecStart=
ExecStart=/usr/bin/nginx -g 'pid /run/nginx/nginx.pid; error_log stderr;'
ExecReload=
ExecReload=/usr/bin/nginx -s reload -g 'pid /run/nginx/nginx.pid;'</pre>
<h4>
<span id=".2Fvar.2Flib.2Fnginx.2F.2A"></span><span class="mw-headline" id="/var/lib/nginx/*">/var/lib/nginx/*</span>
</h4>
<p>Некоторые каталоги в каталоге <code>/var/lib/nginx</code> должны быть инициализированы путём запуска nginx от имени <code>root</code>. Для этого не обязательно запускать весь сервер, nginx сделает это при <a href="#%D0%92%D0%B0%D0%BB%D0%B8%D0%B4%D0%B0%D1%86%D0%B8%D1%8F_%D0%BA%D0%BE%D0%BD%D1%84%D0%B8%D0%B3%D1%83%D1%80%D0%B0%D1%86%D0%B8%D0%B8">проверке конфигурации</a>. Так что просто запустите её — и готово.
</p>
<h4>
<span id=".D0.9F.D1.80.D0.B0.D0.B2.D0.B0_.D0.BA.D0.B0.D1.82.D0.B0.D0.BB.D0.BE.D0.B3.D0.BE.D0.B2_.D0.B8_.D1.84.D0.B0.D0.B9.D0.BB.D0.BE.D0.B2_.D0.B6.D1.83.D1.80.D0.BD.D0.B0.D0.BB.D0.BE.D0.B2"></span><span class="mw-headline" id="Права_каталогов_и_файлов_журналов">Права каталогов и файлов журналов</span>
</h4>
<p>После запуска проверки конфигурации будет создан журнал, принадлежащий <code>root</code>. Удалите журналы в <code>/var/log/nginx</code>.
</p>
<p>Пользователю, от имени которого будет работать служба, nginx нужно выдать разрешение на запись в <code>/var/log/nginx</code>. Для этого может понадобиться <a href="../ru/File_permissions_and_attributes.html#%D0%98%D0%B7%D0%BC%D0%B5%D0%BD%D0%B5%D0%BD%D0%B8%D0%B5_%D1%80%D0%B0%D0%B7%D1%80%D0%B5%D1%88%D0%B5%D0%BD%D0%B8%D0%B9" title="File permissions and attributes (Русский)">изменить права</a> и/или владельца каталога.
</p>
<h3>
<span id=".D0.90.D0.BB.D1.8C.D1.82.D0.B5.D1.80.D0.BD.D0.B0.D1.82.D0.B8.D0.B2.D0.BD.D1.8B.D0.B9_.D1.81.D0.BA.D1.80.D0.B8.D0.BF.D1.82_.D0.B4.D0.BB.D1.8F_systemd"></span><span class="mw-headline" id="Альтернативный_скрипт_для_systemd">Альтернативный скрипт для systemd</span>
</h3>
<p>В systemd есть встроенная возможность запуска через chroot. <a rel="nofollow" class="external autonumber" href="http://0pointer.de/blog/projects/changing-roots.html">[3]</a>. Для примера используем такие настройки <a rel="nofollow" class="external text" href="https://nginx.org/ru/docs/ngx_core_module.html#user">пользователя, группы</a> и pid:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/nginx/nginx.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">user http;
pid /run/nginx.pid;</pre>
<p>Абсолютный путь к файлу настроек будет <code>/srv/http/etc/nginx/nginx.conf</code>.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/nginx.service</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Unit]
Description=nginx (Chroot)
After=network.target

[Service]
Type=forking
PIDFile=/srv/http/run/nginx.pid
RootDirectory=/srv/http
ExecStartPre=/usr/bin/nginx -t -c /etc/nginx/nginx.conf
ExecStart=/usr/bin/nginx -c /etc/nginx/nginx.conf
ExecReload=/usr/bin/nginx -c /etc/nginx/nginx.conf -s reload
ExecStop=/usr/bin/nginx -c /etc/nginx/nginx.conf -s stop

[Install]
WantedBy=multi-user.target</pre>
<p>Указывать стандартный путь к файлу настроек необязательно, nginx по умолчанию использует <code> -c /etc/nginx/nginx.conf</code>, но, возможно, явное прописывание является хорошей идеей.
</p>
<p>Также можно запускать <b>только</b> <code>ExecStart</code> внутри chroot с параметром <code>RootDirectoryStartOnly</code> заданным как <code>yes</code> (смотрите <span class="plainlinks archwiki-template-man" title="$ man 5 systemd.service"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/systemd.service.5">systemd.service(5)</a></span>) или запустить его до того, как точка монтирования станет эффективной или будет доступен путь systemd (смотрите <span class="plainlinks archwiki-template-man" title="$ man 5 systemd.path"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/systemd.path.5">systemd.path(5)</a></span>).
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/nginx.path</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Unit]
Description=nginx (Chroot) path
[Path]
PathExists=/srv/http/site/Public_html
[Install]
WantedBy=default.target</pre>
<p><a href="../ru/Help:Reading.html#%D0%A3%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5_%D1%8E%D0%BD%D0%B8%D1%82%D0%B0%D0%BC%D0%B8_systemd" class="mw-redirect" title="Включите">Включите</a> созданный юнит <code>nginx.path</code> и в юните <code>nginx.service</code> измените строку <code>WantedBy=default.target</code> на <code>WantedBy=nginx.path</code>.
</p>
<p>Параметр <code>PIDFile</code> в файле юнита позволяет systemd следить за процессом (требуется абсолютный путь). Если это нежелательно, вы можете изменить тип на oneshot и удалить упоминание pid-файла из файла юнита.
</p>
<h3><span class="mw-headline" id="Nginx_beautifier">Nginx beautifier</span></h3>
<p><span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/nginxbeautifier/">nginxbeautifier</a></span><sup><small>AUR</small></sup> — это инструмент командной строки, используемый для улучшения и форматирования конфигурационных файлов nginx.
</p>
<h3>
<span id=".D0.91.D0.BE.D0.BB.D0.B5.D0.B5_.D1.83.D0.B4.D0.BE.D0.B1.D0.BD.D0.BE.D0.B5_.D1.83.D0.BF.D1.80.D0.B0.D0.B2.D0.BB.D0.B5.D0.BD.D0.B8.D0.B5_.D0.B7.D0.B0.D0.B3.D0.BE.D0.BB.D0.BE.D0.B2.D0.BA.D0.B0.D0.BC.D0.B8"></span><span class="mw-headline" id="Более_удобное_управление_заголовками">Более удобное управление заголовками</span>
</h3>
<p>Nginx имеет довольно неинтуитивную систему управления HTTP-заголовками: они могут быть определены только в одном контексте, любые другие заголовки игнорируются. Чтобы исправить это, можно установить модуль <a rel="nofollow" class="external text" href="https://github.com/openresty/headers-more-nginx-module#more_set_headers">headers-more-nginx</a>.
</p>
<p><a href="../ru/Help:Reading.html#%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0_%D0%BF%D0%B0%D0%BA%D0%B5%D1%82%D0%BE%D0%B2" class="mw-redirect" title="Установите">Установите</a> пакет <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=nginx-mod-headers-more">nginx-mod-headers-more</a></span>. Модуль будет установлен в каталог <code>/usr/lib/nginx/modules</code>.
</p>
<p>Чтобы загрузить модуль, добавьте следующее в начало основного конфигурационного файла nginx.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/nginx/nginx.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">load_module "/usr/lib/nginx/modules/ngx_http_headers_more_filter_module.so";
...</pre>
<h2>
<span id=".D0.A0.D0.B5.D1.88.D0.B5.D0.BD.D0.B8.D0.B5_.D0.BF.D1.80.D0.BE.D0.B1.D0.BB.D0.B5.D0.BC"></span><span class="mw-headline" id="Решение_проблем">Решение проблем</span>
</h2>
<h3>
<span id=".D0.92.D0.B0.D0.BB.D0.B8.D0.B4.D0.B0.D1.86.D0.B8.D1.8F_.D0.BA.D0.BE.D0.BD.D1.84.D0.B8.D0.B3.D1.83.D1.80.D0.B0.D1.86.D0.B8.D0.B8"></span><span class="mw-headline" id="Валидация_конфигурации">Валидация конфигурации</span>
</h3>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># nginx -t</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: configuration file /etc/nginx/nginx.conf test is successful
</pre>
<h3>
<span id=".D0.9E.D1.88.D0.B8.D0.B1.D0.BA.D0.B0:_.D0.A1.D1.82.D1.80.D0.B0.D0.BD.D0.B8.D1.86.D0.B0.2C_.D0.BA.D0.BE.D1.82.D0.BE.D1.80.D1.83.D1.8E_.D0.B2.D1.8B_.D0.B8.D1.89.D0.B5.D1.82.D0.B5.2C_.D0.B2.D1.80.D0.B5.D0.BC.D0.B5.D0.BD.D0.BD.D0.BE_.D0.BD.D0.B5.D0.B4.D0.BE.D1.81.D1.82.D1.83.D0.BF.D0.BD.D0.B0._.D0.9F.D0.BE.D0.B6.D0.B0.D0.BB.D1.83.D0.B9.D1.81.D1.82.D0.B0.2C_.D0.BF.D0.BE.D0.BF.D1.80.D0.BE.D0.B1.D1.83.D0.B9.D1.82.D0.B5_.D0.BF.D0.BE.D0.B7.D0.B6.D0.B5._.28502_Bad_Gateway.29"></span><span class="mw-headline" id="Ошибка:_Страница,_которую_вы_ищете,_временно_недоступна._Пожалуйста,_попробуйте_позже._(502_Bad_Gateway)">Ошибка: Страница, которую вы ищете, временно недоступна. Пожалуйста, попробуйте позже. (502 Bad Gateway)</span>
</h3>
<p>Это из-за того, что сервер FastCGI не запущен или используемый сокет имеет неправильные права доступа.
</p>
<p>Попробуйте <a rel="nofollow" class="external text" href="https://stackoverflow.com/questions/4252368/nginx-502-bad-gateway/16497957#16497957">этот ответ</a>, чтобы исправить 502 ошибку.
</p>
<p>В Arch Linux, файлом настройки, упомянутом по ссылке выше, является <code>/etc/php/php-fpm.conf</code>.
</p>
<h3>
<span id=".D0.9E.D1.88.D0.B8.D0.B1.D0.BA.D0.B0:_No_input_file_specified"></span><span class="mw-headline" id="Ошибка:_No_input_file_specified">Ошибка: No input file specified</span>
</h3>
<p>1. Убедитесь, что переменная <code>open_basedir</code> в <code>/etc/php/php.ini</code> содержит путь, который соответствует аргументу <code>root</code> в <code>nginx.conf</code> (обычно <code>/usr/share/nginx/</code>). Если в качестве FastCGI-сервера используется <a rel="nofollow" class="external text" href="https://php-fpm.org/">PHP-FPM</a>, можно попробовать добавить <code>fastcgi_param PHP_ADMIN_VALUE "open_basedir=$document_root/:/tmp/:/proc/";</code> в тот блок <code>location</code>, который используется для обработки php-файлов.
</p>
<p>2. Другой причиной может быть то, что задан неправильный аргумент <code>root</code> в секции <code>location ~ \.php$</code> в <code>nginx.conf</code>. Убедитесь, что <code>root</code> указывает на ту же директорию, что и в <code>location /</code> на том же сервере. Либо вы можете просто задать параметр root глобально, не переопределяя его в каких-либо location секциях.
</p>
<p>3. Проверьте права доступа: например, пользователь/группа <code>http</code>, биты разрешений <code>755</code> для каталогов и <code>644</code> для файлов. Имейте в виду, что все родительские каталоги тоже должны иметь корректные права доступа. Как массово изменить права всего дерева каталогов, описано в разделе <a href="../ru/File_permissions_and_attributes.html#%D0%9C%D0%B0%D1%81%D1%81%D0%BE%D0%B2%D0%BE%D0%B5_%D0%B8%D0%B7%D0%BC%D0%B5%D0%BD%D0%B5%D0%BD%D0%B8%D0%B5_%D1%80%D0%B0%D0%B7%D1%80%D0%B5%D1%88%D0%B5%D0%BD%D0%B8%D0%B9" class="mw-redirect" title="Разрешения и атрибуты файлов">Разрешения и атрибуты файлов#Массовое изменение разрешений</a>.
</p>
<p>4. Возможно, у вас не установлена переменная <code>SCRIPT_FILENAME</code>, содержащая полный путь до ваших скриптов. Если конфигурация nginx (<code>fastcgi_param SCRIPT_FILENAME</code>) правильная, то эта ошибка означает, что php не смог загрузить запрашиваемый скрипт. Часто это просто оказывается ошибкой прав доступа, и вы можете запустить php-cgi с правами root:
</p>
<pre># spawn-fcgi -a 127.0.0.1 -p 9000 -f /usr/bin/php-cgi
</pre>
<p>или вам следует создать группу и пользователя для запуска php-cgi:
</p>
<pre># groupadd www
# useradd -g www www
# chmod +w /srv/www/nginx/html
# chown -R www:www /srv/www/nginx/html
# spawn-fcgi -a 127.0.0.1 -p 9000 -u www -g www -f /usr/bin/php-cgi
</pre>
<p>5. Если вы используете chroot, убедитесь, что опция <code>chroot</code> в файле <code>/etc/php-fpm/php-fpm.d/www.conf</code> имеет корректное значение.
</p>
<h3><span class="mw-headline" id="Warning:_Could_not_build_optimal_types_hash">Warning: Could not build optimal types_hash</span></h3>
<p>Если при запуске <code>nginx.service</code> в журнале появляется такое сообщение:
</p>
<pre>[warn] 18872#18872: could not build optimal types_hash, you should increase either types_hash_max_size: 1024 or types_hash_bucket_size: 64; ignoring types_hash_bucket_size
</pre>
<p>то попробуйте увеличить значения этих параметров в блоке <code>http</code> <a rel="nofollow" class="external autonumber" href="https://nginx.org/en/docs/http/ngx_http_core_module.html#types_hash_max_size">[4]</a> <a rel="nofollow" class="external autonumber" href="https://nginx.org/en/docs/http/server_names.html">[5]</a>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/nginx/nginx.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">http {
    types_hash_max_size 4096;
    server_names_hash_bucket_size 128;
    ...
}
</pre>
<h3><span class="mw-headline" id="Cannot_assign_requested_address">Cannot assign requested address</span></h3>
<p>Полный текст ошибки в <a href="../ru/Systemd.html#%D0%98%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_%D1%8E%D0%BD%D0%B8%D1%82%D0%BE%D0%B2" title="Systemd (Русский)">статусе юнита</a> <code>nginx.service</code>:
</p>
<pre>[emerg] 460#460: bind() to A.B.C.D:443 failed (99: Cannot assign requested address)
</pre>
<p>Даже если файл юнита nginx настроен на запуск после <code>network.target</code> с помощью systemd, nginx может попытаться прослушивать адрес, который настроен, но ещё не добавлен ни к одному интерфейсу. Убедиться, что проблема именно в этом, можно, попытавшись <a href="../ru/Help:Reading.html#%D0%A3%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5_%D1%8E%D0%BD%D0%B8%D1%82%D0%B0%D0%BC%D0%B8_systemd" class="mw-redirect" title="Запустить">запустить</a> nginx вручную (тем самым показав, что IP-адрес настроен правильно). Настройка nginx на прослушивание всех адресов решит эту проблему. Если же в вашем случае обязательно требуется прослушивание конкретного адреса, одним из возможных решений является перенастройка systemd.
</p>
<p>Чтобы запустить nginx только после того, как все настроенные сетевые устройства будут запущены и получат IP-адреса, добавьте <code>network-online.target</code> к строке <code>After=</code> в файле <code>nginx.service</code> и <a href="../ru/Help:Reading.html#%D0%A3%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5_%D1%8E%D0%BD%D0%B8%D1%82%D0%B0%D0%BC%D0%B8_systemd" class="mw-redirect" title="Запустите/включите">запустите/включите</a> <code>systemd-networkd-wait-online.service</code>.
</p>
<h2>
<span id=".D0.A1.D0.BC.D0.BE.D1.82.D1.80.D0.B8.D1.82.D0.B5_.D1.82.D0.B0.D0.BA.D0.B6.D0.B5"></span><span class="mw-headline" id="Смотрите_также">Смотрите также</span>
</h2>
<ul>
<li><a href="../en/WebDAV.html#nginx" title="WebDAV">Использование WebDAV с nginx</a></li>
<li><a rel="nofollow" class="external text" href="https://www.nginx.com/resources/wiki/start/topics/tutorials/config_pitfalls/">nginx configuration pitfalls</a></li>
<li><a rel="nofollow" class="external text" href="https://calomel.org/nginx.html">Very good in-depth 2014 look at nginx security and Reverse Proxying</a></li>
<li><a rel="nofollow" class="external text" href="https://www.tecmint.com/install-nginx-php-mysql-with-mariadb-engine-and-phpmyadmin-in-arch-linux/">Installing LEMP (nginx, PHP, MySQL with MariaDB engine and PhpMyAdmin) in Arch Linux</a></li>
<li><a href="../ru/Certbot.html#Nginx" title="Certbot (Русский)">Certbot (Русский)#Nginx</a></li>
</ul>
</div>
</div>
					<div id="catlinks" class="catlinks" data-mw="interface">
<div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../Special:Categories.html" title="Special:Categories">Category</a>: <ul><li><a href="../ru/Category:Web_server.html" title="Category:Web server (Русский)">Web server (Русский)</a></li></ul>
</div>
<div id="mw-hidden-catlinks" class="mw-hidden-catlinks mw-hidden-cats-hidden">Hidden category: <ul><li><a href="../en/Category:Pages_with_dead_links.html" title="Category:Pages with dead links">Pages with dead links</a></li></ul>
</div>
</div>
				</div>
			</main>
			
		</div>
		<div class="mw-footer-container">
			
<footer id="footer" class="mw-footer" role="contentinfo" style="margin: 0">
	<ul id="footer-info">
	<li data-nosnippet="">Retrieved from "<a dir="ltr" href="https://wiki.archlinux.org/index.php?title=Nginx_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)&amp;oldid=813423">https://wiki.archlinux.org/index.php?title=Nginx_(Русский)&amp;oldid=813423</a>"</li>
<li id="footer-info-lastmod"> This page was last edited on 30 July 2024, at 15:06.</li>
	<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="https://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.3 or later</a> unless otherwise noted.</li>
<br>
</ul>

	<ul id="footer-places">
	<li id="footer-places-privacy"><a href="https://terms.archlinux.org/docs/privacy-policy/">Privacy policy</a></li>
	<li id="footer-places-about"><a href="../en/ArchWiki:About.html">About ArchWiki</a></li>
	<li id="footer-places-disclaimers"><a href="../en/ArchWiki:General_disclaimer.html">Disclaimers</a></li>
	<li id="footer-places-archwiki-code-of-conduct"><a href="https://terms.archlinux.org/docs/code-of-conduct/" class="extiw" title="archlinux-service-agreements:code-of-conduct">Code of conduct</a></li>
	<li id="footer-places-archwiki-terms-of-service"><a href="https://terms.archlinux.org/docs/terms-of-service/" class="extiw" title="archlinux-service-agreements:terms-of-service">Terms of service</a></li>
</ul>

	<ul id="footer-icons" class="noprint">
	<li id="footer-copyrightico"><a href="https://www.gnu.org/copyleft/fdl.html"><img src="/resources/assets/licenses/gnu-fdl.png" alt="GNU Free Documentation License 1.3 or later" width="88" height="31" loading="lazy"></a></li>
	<li id="footer-poweredbyico"><img src="/resources/assets/poweredby_mediawiki_88x31.png" srcset="/resources/assets/poweredby_mediawiki_132x47.png 1.5x, /resources/assets/poweredby_mediawiki_176x62.png 2x" width="88" height="31" loading="lazy"></li>
</ul>

</footer>

		</div>
	</div> 
</div> 
<div class="vector-settings" id="p-dock-bottom">
	<ul>
		<li>
		<button class="cdx-button cdx-button--icon-only vector-limited-width-toggle" id=""><span class="vector-icon mw-ui-icon-fullScreen mw-ui-icon-wikimedia-fullScreen"></span>

<span>Toggle limited content width</span>
</button>
</li>
	</ul>
</div>
</body>
</html>
