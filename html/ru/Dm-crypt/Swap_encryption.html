<!DOCTYPE html>
<html class="client-nojs vector-feature-language-in-header-enabled vector-feature-language-in-main-page-header-disabled vector-feature-sticky-header-disabled vector-feature-page-tools-pinned-disabled vector-feature-toc-pinned-clientpref-1 vector-feature-main-menu-pinned-disabled vector-feature-limited-width-clientpref-1 vector-feature-limited-width-content-enabled vector-feature-custom-font-size-clientpref-0 vector-feature-appearance-pinned-clientpref-1 vector-feature-night-mode-enabled skin-theme-clientpref-day vector-toc-available" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>dm-crypt (Русский)/Swap encryption (Русский) - ArchWiki</title>
<link rel="stylesheet" href="../../ArchWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<meta name="generator" content="MediaWiki 1.43.1">
<meta name="referrer" content="no-referrer-when-downgrade">
<meta name="robots" content="max-image-preview:standard">
<meta name="format-detection" content="telephone=no">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=0.25, maximum-scale=5.0">
<link rel="search" type="application/opensearchdescription+xml" href="/rest.php/v1/search" title="ArchWiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.archlinux.org/api.php?action=rsd">
<link rel="license" href="https://www.gnu.org/copyleft/fdl.html">
<link rel="alternate" type="application/atom+xml" title="ArchWiki Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="skin--responsive skin-vector skin-vector-search-vue mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-Dm-crypt_Русский_Swap_encryption_Русский rootpage-Dm-crypt_Русский skin-vector-2022 action-view">
<a class="mw-jump-link" href="#bodyContent">Jump to content</a>
<div class="vector-header-container">
	</div>
<div class="mw-page-container">
	<div class="mw-page-container-inner">
		<div class="vector-column-start">
			<div class="vector-main-menu-container">
		</div>
	<div class="vector-sticky-pinned-container">
				<nav id="mw-panel-toc" aria-label="Contents" data-event-name="ui.sidebar-toc" class="mw-table-of-contents-container vector-toc-landmark">
					<div id="vector-toc-pinned-container" class="vector-pinned-container">
					<div id="vector-toc" class="vector-toc vector-pinnable-element">
	<div class="vector-pinnable-header vector-toc-pinnable-header vector-pinnable-header-pinned" data-feature-name="toc-pinned" data-pinnable-element-id="vector-toc">
	<h2 class="vector-pinnable-header-label">Contents</h2>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-pin-button" data-event-name="pinnable-header.vector-toc.pin">move to sidebar</button>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-unpin-button" data-event-name="pinnable-header.vector-toc.unpin">hide</button>
</div>


	<ul class="vector-toc-contents" id="mw-panel-toc-list">
		<li id="toc-mw-content-text" class="vector-toc-list-item vector-toc-level-1">
			<a href="#" class="vector-toc-link">
				<div class="vector-toc-text">Beginning</div>
			</a>
		</li>
		<li id="toc-Без_поддержки_гибернации" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#%D0%91%D0%B5%D0%B7_%D0%BF%D0%BE%D0%B4%D0%B4%D0%B5%D1%80%D0%B6%D0%BA%D0%B8_%D0%B3%D0%B8%D0%B1%D0%B5%D1%80%D0%BD%D0%B0%D1%86%D0%B8%D0%B8">
			<div class="vector-toc-text">
				<span class="vector-toc-numb">1</span>
				<span>Без поддержки гибернации</span>
			</div>
		</a>
		
			<button aria-controls="toc-Без_поддержки_гибернации-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Без поддержки гибернации subsection</span>
			</button>
		
		<ul id="toc-Без_поддержки_гибернации-sublist" class="vector-toc-list">
			<li id="toc-UUID_и_LABEL" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#UUID_%D0%B8_LABEL">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">1.1</span>
					<span>UUID и LABEL</span>
				</div>
			</a>
			
			<ul id="toc-UUID_и_LABEL-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Отключение_гибернации_в_графических_средах" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%9E%D1%82%D0%BA%D0%BB%D1%8E%D1%87%D0%B5%D0%BD%D0%B8%D0%B5_%D0%B3%D0%B8%D0%B1%D0%B5%D1%80%D0%BD%D0%B0%D1%86%D0%B8%D0%B8_%D0%B2_%D0%B3%D1%80%D0%B0%D1%84%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B8%D1%85_%D1%81%D1%80%D0%B5%D0%B4%D0%B0%D1%85">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">1.2</span>
					<span>Отключение гибернации в графических средах</span>
				</div>
			</a>
			
			<ul id="toc-Отключение_гибернации_в_графических_средах-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-С_поддержкой_гибернации" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#%D0%A1_%D0%BF%D0%BE%D0%B4%D0%B4%D0%B5%D1%80%D0%B6%D0%BA%D0%BE%D0%B9_%D0%B3%D0%B8%D0%B1%D0%B5%D1%80%D0%BD%D0%B0%D1%86%D0%B8%D0%B8">
			<div class="vector-toc-text">
				<span class="vector-toc-numb">2</span>
				<span>С поддержкой гибернации</span>
			</div>
		</a>
		
			<button aria-controls="toc-С_поддержкой_гибернации-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle С поддержкой гибернации subsection</span>
			</button>
		
		<ul id="toc-С_поддержкой_гибернации-sublist" class="vector-toc-list">
			<li id="toc-Использование_swap-файла" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%98%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_swap-%D1%84%D0%B0%D0%B9%D0%BB%D0%B0">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">2.1</span>
					<span>Использование swap-файла</span>
				</div>
			</a>
			
			<ul id="toc-Использование_swap-файла-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Использование_swap-раздела" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%98%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_swap-%D1%80%D0%B0%D0%B7%D0%B4%D0%B5%D0%BB%D0%B0">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">2.2</span>
					<span>Использование swap-раздела</span>
				</div>
			</a>
			
			<ul id="toc-Использование_swap-раздела-sublist" class="vector-toc-list">
				<li id="toc-Использование_TPM" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#%D0%98%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_TPM">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">2.2.1</span>
					<span>Использование TPM</span>
				</div>
			</a>
			
			<ul id="toc-Использование_TPM-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Использование_дополнительной_парольной_фразы_или_ключевого_файла" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#%D0%98%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_%D0%B4%D0%BE%D0%BF%D0%BE%D0%BB%D0%BD%D0%B8%D1%82%D0%B5%D0%BB%D1%8C%D0%BD%D0%BE%D0%B9_%D0%BF%D0%B0%D1%80%D0%BE%D0%BB%D1%8C%D0%BD%D0%BE%D0%B9_%D1%84%D1%80%D0%B0%D0%B7%D1%8B_%D0%B8%D0%BB%D0%B8_%D0%BA%D0%BB%D1%8E%D1%87%D0%B5%D0%B2%D0%BE%D0%B3%D0%BE_%D1%84%D0%B0%D0%B9%D0%BB%D0%B0">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">2.2.2</span>
					<span>Использование дополнительной парольной фразы или ключевого файла</span>
				</div>
			</a>
			
			<ul id="toc-Использование_дополнительной_парольной_фразы_или_ключевого_файла-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Расшифровка_раздела_в_initramfs" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#%D0%A0%D0%B0%D1%81%D1%88%D0%B8%D1%84%D1%80%D0%BE%D0%B2%D0%BA%D0%B0_%D1%80%D0%B0%D0%B7%D0%B4%D0%B5%D0%BB%D0%B0_%D0%B2_initramfs">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">2.2.3</span>
					<span>Расшифровка раздела в initramfs</span>
				</div>
			</a>
			
			<ul id="toc-Расшифровка_раздела_в_initramfs-sublist" class="vector-toc-list">
				<li id="toc-mkinitcpio" class="vector-toc-list-item vector-toc-level-4">
			<a class="vector-toc-link" href="#mkinitcpio">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">2.2.3.1</span>
					<span>mkinitcpio</span>
				</div>
			</a>
			
			<ul id="toc-mkinitcpio-sublist" class="vector-toc-list">
				<li id="toc-initramfs_на_базе_systemd" class="vector-toc-list-item vector-toc-level-5">
			<a class="vector-toc-link" href="#initramfs_%D0%BD%D0%B0_%D0%B1%D0%B0%D0%B7%D0%B5_systemd">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">2.2.3.1.1</span>
					<span>initramfs на базе systemd</span>
				</div>
			</a>
			
			<ul id="toc-initramfs_на_базе_systemd-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-initramfs_на_базе_busybox" class="vector-toc-list-item vector-toc-level-5">
			<a class="vector-toc-link" href="#initramfs_%D0%BD%D0%B0_%D0%B1%D0%B0%D0%B7%D0%B5_busybox">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">2.2.3.1.2</span>
					<span>initramfs на базе busybox</span>
				</div>
			</a>
			
			<ul id="toc-initramfs_на_базе_busybox-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-dracut" class="vector-toc-list-item vector-toc-level-4">
			<a class="vector-toc-link" href="#dracut">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">2.2.3.2</span>
					<span>dracut</span>
				</div>
			</a>
			
			<ul id="toc-dracut-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
	</ul>
		</li>
		<li id="toc-LVM_внутри_LUKS" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#LVM_%D0%B2%D0%BD%D1%83%D1%82%D1%80%D0%B8_LUKS">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">2.3</span>
					<span>LVM внутри LUKS</span>
				</div>
			</a>
			
			<ul id="toc-LVM_внутри_LUKS-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Известные_проблемы" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#%D0%98%D0%B7%D0%B2%D0%B5%D1%81%D1%82%D0%BD%D1%8B%D0%B5_%D0%BF%D1%80%D0%BE%D0%B1%D0%BB%D0%B5%D0%BC%D1%8B">
			<div class="vector-toc-text">
				<span class="vector-toc-numb">3</span>
				<span>Известные проблемы</span>
			</div>
		</a>
		
		<ul id="toc-Известные_проблемы-sublist" class="vector-toc-list">
		</ul>
	</li>
</ul>
</div>

					</div>
		</nav>
			</div>
		</div>
		<div class="mw-content-container">
			<main id="content" class="mw-body" style="margin: 0">
				<header class="mw-body-header vector-page-titlebar">
					<nav aria-label="Contents" class="vector-toc-landmark">
						
<div id="vector-page-titlebar-toc" class="vector-dropdown vector-page-titlebar-toc vector-button-flush-left">
	<input type="checkbox" id="vector-page-titlebar-toc-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-vector-page-titlebar-toc" class="vector-dropdown-checkbox " aria-label="Toggle the table of contents">
	<label id="vector-page-titlebar-toc-label" for="vector-page-titlebar-toc-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--icon-only " aria-hidden="true"><span class="vector-icon mw-ui-icon-listBullet mw-ui-icon-wikimedia-listBullet"></span>

<span class="vector-dropdown-label-text">Toggle the table of contents</span>
	</label>
	<div class="vector-dropdown-content">


							<div id="vector-page-titlebar-toc-unpinned-container" class="vector-unpinned-container">
			</div>
		
	</div>
</div>

					</nav>
					<h1 id="firstHeading" class="firstHeading mw-first-heading">dm-crypt (Русский)/Swap encryption (Русский)</h1>
							
<div id="p-lang-btn" class="vector-dropdown mw-portlet mw-portlet-lang">
	<input type="checkbox" id="p-lang-btn-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-p-lang-btn" class="vector-dropdown-checkbox mw-interlanguage-selector" aria-label="Go to an article in another language. Available in 6 languages">
	<label id="p-lang-btn-label" for="p-lang-btn-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--action-progressive mw-portlet-lang-heading-6" aria-hidden="true"><span class="vector-icon mw-ui-icon-language-progressive mw-ui-icon-wikimedia-language-progressive"></span>

<span class="vector-dropdown-label-text">6 languages</span>
	</label>
	<div class="vector-dropdown-content">

		<div class="vector-menu-content">
			
			<ul class="vector-menu-content-list">
				
				<li class="interlanguage-link interwiki-en mw-list-item"><a href="../../en/Dm-crypt/Swap_encryption.html" title="Dm-crypt/Swap encryption – English" lang="en" hreflang="en" data-title="Dm-crypt/Swap encryption" data-language-autonym="English" data-language-local-name="English" class="interlanguage-link-target"><span>English</span></a></li>
<li class="interlanguage-link interwiki-es mw-list-item"><a href="../../es/Dm-crypt/Swap_encryption.html" title="Dm-crypt (Español)/Swap encryption – español" lang="es" hreflang="es" data-title="Dm-crypt (Español)/Swap encryption" data-language-autonym="Español" data-language-local-name="español" class="interlanguage-link-target"><span>Español</span></a></li>
<li class="interlanguage-link interwiki-ja mw-list-item"><a href="https://wiki.archlinux.jp/index.php/Dm-crypt/%E3%82%B9%E3%83%AF%E3%83%83%E3%83%97%E3%81%AE%E6%9A%97%E5%8F%B7%E5%8C%96" title="Dm-crypt/スワップの暗号化 – 日本語" lang="ja" hreflang="ja" data-title="Dm-crypt/スワップの暗号化" data-language-autonym="日本語" data-language-local-name="日本語" class="interlanguage-link-target"><span>日本語</span></a></li>
<li class="interlanguage-link interwiki-pl mw-list-item"><a href="../../pl/Dm-crypt/Swap_encryption.html" title="Dm-crypt (Polski)/Swap encryption – polski" lang="pl" hreflang="pl" data-title="Dm-crypt (Polski)/Swap encryption" data-language-autonym="Polski" data-language-local-name="polski" class="interlanguage-link-target"><span>Polski</span></a></li>
<li class="interlanguage-link interwiki-pt mw-list-item"><a href="../../pt/Dm-crypt/Swap_encryption.html" title="Dm-crypt (Português)/Swap encryption – português" lang="pt" hreflang="pt" data-title="Dm-crypt (Português)/Swap encryption" data-language-autonym="Português" data-language-local-name="português" class="interlanguage-link-target"><span>Português</span></a></li>
<li class="interlanguage-link interwiki-uk mw-list-item"><a href="../../uk/Dm-crypt/Swap_encryption.html" title="Dm-crypt (Українська)/Swap encryption – українська" lang="uk" hreflang="uk" data-title="Dm-crypt (Українська)/Swap encryption" data-language-autonym="Українська" data-language-local-name="українська" class="interlanguage-link-target"><span>Українська</span></a></li>
			</ul>
			
		</div>

	</div>
</div>
</header>
				<div class="vector-column-end">
					<div class="vector-sticky-pinned-container">
						<nav class="vector-page-tools-landmark" aria-label="Page tools">
							<div id="vector-page-tools-pinned-container" class="vector-pinned-container">
				
							</div>
		</nav>
						<nav class="vector-appearance-landmark" aria-label="Appearance">
							<div id="vector-appearance-pinned-container" class="vector-pinned-container">
				<div id="vector-appearance" class="vector-appearance vector-pinnable-element">
	<div class="vector-pinnable-header vector-appearance-pinnable-header vector-pinnable-header-pinned" data-feature-name="appearance-pinned" data-pinnable-element-id="vector-appearance" data-pinned-container-id="vector-appearance-pinned-container" data-unpinned-container-id="vector-appearance-unpinned-container">
	<div class="vector-pinnable-header-label">Appearance</div>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-pin-button" data-event-name="pinnable-header.vector-appearance.pin">move to sidebar</button>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-unpin-button" data-event-name="pinnable-header.vector-appearance.unpin">hide</button>
</div>


</div>

							</div>
		</nav>
					</div>
				</div>
				<div id="bodyContent" class="vector-body" aria-labelledby="firstHeading" data-mw-ve-target-container>
					<div class="vector-body-before-content">
							<div class="mw-indicators">
		</div>

						<div id="siteSub" class="noprint">From ArchWiki</div>
					</div>
					<div id="contentSub"><div id="mw-content-subtitle"><div class="subpages">&lt; <bdi dir="ltr"><a href="../../ru/Dm-crypt.html" title="Dm-crypt (Русский)">Dm-crypt (Русский)</a></bdi>
</div></div></div>
					
					
					<div id="mw-content-text" class="mw-body-content">
<div class="mw-content-ltr mw-parser-output" lang="ru" dir="ltr">
<p><span>
</span>
</p>
<p><b>Шифрование подкачки при помощи dm-crypt.</b> В зависимости от требований могут использоваться различные методы шифрования раздела <a href="../../ru/Swap.html" title="Swap (Русский)">подкачки</a> (свопа), которые описаны ниже. Настройка, при которой шифрование подкачки пересоздаётся при каждой загрузке (с новым ключом), обеспечивает более высокую защиту данных, поскольку предотвращает утечку чувствительной информации, которая могла быть выгружена в подкачку и сколько угодно длительное время не была перезаписана случайным образом другими данными поверх данной информации. Однако такое перешифрование при каждом новом запуске системы также делает невозможным использование функции гибернации (suspend-to-disk).
В данной статье рассмотрены способы шифрования свопа как с поддержкой <a href="../../ru/Power_management/Suspend_and_hibernate.html" title="Power management (Русский)/Suspend and hibernate (Русский)">гипернации</a> так и без неё.
</p>
<meta property="mw:PageProp/toc">
<h2>
<span id=".D0.91.D0.B5.D0.B7_.D0.BF.D0.BE.D0.B4.D0.B4.D0.B5.D1.80.D0.B6.D0.BA.D0.B8_.D0.B3.D0.B8.D0.B1.D0.B5.D1.80.D0.BD.D0.B0.D1.86.D0.B8.D0.B8"></span><span class="mw-headline" id="Без_поддержки_гибернации">Без поддержки гибернации</span>
</h2>
<p>В системах, где гибернация (suspend-to-disk) не требуется, можно настроить <code>/etc/crypttab</code> так, чтобы при загрузке раздел подкачки расшифровывался с использованием случайного пароля и обычного dm-crypt. Случайный пароль удаляется при выключении, оставляя в разделе подкачки только зашифрованные, недоступные данные.
</p>
<p>Чтобы включить эту функцию, просто раскомментируйте строку, начинающуюся с <code>swap</code> в <code>/etc/crypttab</code>. Замените параметр устройства на имя вашего раздела подкачки. Например, это будет выглядеть примерно так:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/crypttab</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;"># &lt;name&gt;  &lt;device&gt;     &lt;password&gt;     &lt;options&gt;
swap      /dev/sd<i>X#</i>    /dev/urandom   swap,cipher=aes-xts-plain64,size=512,sector-size=4096</pre>
<p>Это сопоставит <code>/dev/sd<i>X#</i></code> (параметр, который требуется отредактировать) с <code>/dev/mapper/swap</code> как раздел подкачки, который можно добавить в <code>/etc/fstab</code> как обычный swap. Если у вас ранее был незашифрованный раздел подкачки, не забудьте его отключить — или переиспользуйте соответствующую запись в <a href="../../ru/Fstab.html" title="Fstab (Русский)">fstab</a>, изменив устройство на <code>/dev/mapper/swap</code>. Значения по умолчанию подходят для большинства случаев. Другие параметры и объяснение колонок смотрите в <span class="plainlinks archwiki-template-man" title="$ man 5 crypttab"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/crypttab.5">crypttab(5)</a></span>, а также в <a rel="nofollow" class="external text" href="https://gitlab.com/cryptsetup/cryptsetup/wikis/FrequentlyAskedQuestions#2-setup">FAQ cryptsetup, пункт 2.3</a>.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> При использовании твёрдотельных накопителей типа NVMe, устройства вида <code>/dev/nvme#n#p#</code> аналогичны <code>/dev/sdX#</code>, а устройства вида <code>/dev/nvme#n#</code> — <code>/dev/sdX</code>.</div>
<p><br>
</p>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Важно:</strong> Все данные на указанном устройстве будут безвозвратно <b>удалены</b>. Использование простых имён устройств ядра небезопасно, поскольку порядок их назначения (например, <code>/dev/sda</code>, <code>/dev/sdb</code>) может изменяться при каждой загрузке. Возможные варианты:
<ul>
<li>Использовать пути <code>by-id</code> и <code>by-path</code>. Однако они тоже чувствительны к изменениям оборудования. См. <a href="../../ru/Persistent_block_device_naming.html#by-id_%D0%B8_by-path" title="Persistent block device naming (Русский)">Persistent block device naming (Русский)#by-id и by-path</a>.</li>
<li>Использовать <a href="../../en/Persistent_block_device_naming.html#by-partlabel" class="mw-redirect" title="PARTLABEL">PARTLABEL</a>.</li>
<li>Использовать имя логического тома <a href="../../en/LVM.html" class="mw-redirect" title="LVM (Русский)">LVM</a>.</li>
<li>Использовать метод, описанный в <a href="#UUID_%D0%B8_LABEL">#UUID и LABEL</a>. Метки и <a href="../../en/Persistent_block_device_naming.html#by-uuid" title="Persistent block device naming">UUID</a> <b>нельзя</b> использовать напрямую, поскольку при каждом запуске устройство подкачки пересоздаётся и перешифровывается с помощью <code>mkswap</code>, см. <a rel="nofollow" class="external text" href="https://gitlab.com/cryptsetup/cryptsetup/wikis/FrequentlyAskedQuestions#2-setup">FAQ cryptsetup</a>.</li>
</ul>
</div>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> Иногда настройка раздела подкачки может завершиться сбоем, см. <a rel="nofollow" class="external text" href="https://github.com/systemd/systemd/issues/10179">systemd issue 10179</a>.</div>
<p>Чтобы использовать постоянное имя устройства <code>by-id</code> вместо простого имени ядра, сначала определите устройство подкачки:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># find -L /dev/disk -samefile /dev/<i>sdaX</i></pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">/dev/disk/by-id/ata-WDC_WD2500BEVT-22ZCT0_WD-WXE908VF0470-part<i>X</i>
/dev/disk/by-id/wwn-0x60015ee0000b237f-part<i>X</i>
</pre>
<p>Затем используйте один из найденных путей в качестве постоянной ссылки на раздел (вместо <code>/dev/sd<i>X#</i></code>):
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/crypttab</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;"># &lt;name&gt;  &lt;device&gt;                                                         &lt;password&gt;     &lt;options&gt;
swap      /dev/disk/by-id/ata-WDC_WD2500BEVT-22ZCT0_WD-WXE908VF0470-partX  /dev/urandom   swap,cipher=aes-xts-plain64,size=512,sector-size=4096</pre>
<p>После перезагрузки, активировав зашифрованный swap, можно увидеть с помощью <code>swapon -s</code>, что для него создано устройство типа <code>/dev/dm-1</code>, а команда <code>lsblk</code> покажет тип <b>crypt</b> в колонке <code>FSTYPE</code>. Из-за нового шифрования при каждом запуске UUID для <code>/dev/mapper/swap</code> будет постоянно меняться.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> Если выбранный для подкачки раздел ранее использовался как LUKS-устройство, crypttab не перезапишет его, чтобы создать swap. Это сделано для предотвращения потери данных из-за ошибочной идентификации. Чтобы использовать такой раздел, необходимо <a href="../../en/Dm-crypt/Drive_preparation.html#Wipe_LUKS_header" title="Dm-crypt/Drive preparation">стереть заголовок LUKS</a> один раз.</div>
<h3>
<span id="UUID_.D0.B8_LABEL"></span><span class="mw-headline" id="UUID_и_LABEL">UUID и LABEL</span>
</h3>
<p>Опасно использовать crypttab swap с простыми именами устройств, такими как <code>/dev/sdX#</code> или даже <code>/dev/disk/by-id/ata-SERIAL-partX</code>. Небольшое изменение в разметке или порядке устройств может привести к тому, что <code>/etc/crypttab</code> при следующей загрузке отформатирует важные данные. То же самое касается PARTUUID, если вы решите использовать этот раздел для других целей, но забудете удалить запись из crypttab.
</p>
<p>Надёжнее использовать UUID или LABEL. По умолчанию это не работает, потому что dm-crypt и <code>mkswap</code> перезапишут содержимое раздела, включая UUID и LABEL. Однако можно задать смещение, чтобы создать небольшую фиктивную файловую систему, которая будет служить только для хранения постоянной метки.
</p>
<p>Создайте <a href="../../ru/File_systems.html" class="mw-redirect" title="Файловая система">файловую систему</a> с нужной меткой:
</p>
<pre># mkfs.ext2 -L <i>cryptswap</i> /dev/sd<i>X#</i> 1M
</pre>
<p>Нетипичный параметр после имени устройства ограничивает размер файловой системы до 1 MiB, оставляя место для зашифрованной подкачки позади неё.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># blkid /dev/sdX#</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">/dev/sdX#: LABEL="cryptswap" UUID="b72c384e-bd3c-49aa-b7a7-a28ea81a2605" TYPE="ext2"</pre>
<p>Теперь <code>/dev/sdX#</code> можно легко идентифицировать по UUID или LABEL, даже если имя устройства или номер раздела изменятся. Останется только указать записи в <code>/etc/crypttab</code> и <code>/etc/fstab</code>. Пример с другими параметрами шифрования:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/crypttab</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;"># &lt;name&gt; &lt;device&gt;         &lt;password&gt;    &lt;options&gt;
swap     LABEL=<i>cryptswap</i>  /dev/urandom  swap,offset=2048,cipher=aes-xts-plain64,size=512,sector-size=4096</pre>
<p>Обратите внимание на смещение: оно составляет 2048 секторов по 512 байт (не зависит от сектора dm-crypt), то есть 1 MiB. Таким образом, шифрованный swap не повредит метку/UUID файловой системы, и соблюдается выравнивание данных.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/fstab</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;"># &lt;filesystem&gt;    &lt;dir&gt;  &lt;type&gt;  &lt;options&gt;  &lt;dump&gt;  &lt;pass&gt;
/dev/mapper/swap  none   swap    defaults   0       0</pre>
<p>С такой настройкой cryptswap будет использовать только раздел с указанной LABEL, независимо от его имени в системе. Если вы решите использовать этот раздел для других целей, форматирование удалит метку, и <code>/etc/crypttab</code> больше не будет его использовать при загрузке.
</p>
<h3>
<span id=".D0.9E.D1.82.D0.BA.D0.BB.D1.8E.D1.87.D0.B5.D0.BD.D0.B8.D0.B5_.D0.B3.D0.B8.D0.B1.D0.B5.D1.80.D0.BD.D0.B0.D1.86.D0.B8.D0.B8_.D0.B2_.D0.B3.D1.80.D0.B0.D1.84.D0.B8.D1.87.D0.B5.D1.81.D0.BA.D0.B8.D1.85_.D1.81.D1.80.D0.B5.D0.B4.D0.B0.D1.85"></span><span class="mw-headline" id="Отключение_гибернации_в_графических_средах">Отключение гибернации в графических средах</span>
</h3>
<p>Графические окружения могут не определять автоматически, что раздел подкачки зашифрован случайным образом и не может быть использован для гибернации.
</p>
<p>В <a href="../../ru/Xfce.html" title="Xfce (Русский)">Xfce</a> можно скрыть кнопки <i>Гибернация</i> и <i>Гибридный сон</i> следующими командами:
</p>
<pre>$ xfconf-query -c xfce4-session -np /shutdown/ShowHibernate -t bool -s false
$ xfconf-query -c xfce4-session -np /shutdown/ShowHybridSleep -t bool -s false
</pre>
<h2>
<span id=".D0.A1_.D0.BF.D0.BE.D0.B4.D0.B4.D0.B5.D1.80.D0.B6.D0.BA.D0.BE.D0.B9_.D0.B3.D0.B8.D0.B1.D0.B5.D1.80.D0.BD.D0.B0.D1.86.D0.B8.D0.B8"></span><span class="mw-headline" id="С_поддержкой_гибернации">С поддержкой гибернации</span>
</h2>
<p>Ниже описаны три альтернативных метода настройки зашифрованной подкачки с возможностью гибернации. При использовании любого из них нужно учитывать, что важные данные, выгруженные в подкачку, могут сохраняться там длительное время (до случайной перезаписи новыми данными поверх старых). Если данный риск критичный, рассмотрите возможность настройки системного задания, которое будет повторно шифровать swap, например, при каждом выключении системы, наряду с выбранным методом.
</p>
<h3>
<span id=".D0.98.D1.81.D0.BF.D0.BE.D0.BB.D1.8C.D0.B7.D0.BE.D0.B2.D0.B0.D0.BD.D0.B8.D0.B5_swap-.D1.84.D0.B0.D0.B9.D0.BB.D0.B0"></span><span class="mw-headline" id="Использование_swap-файла">Использование swap-файла</span>
</h3>
<p>Файл подкачки может располагаться в файловой системе внутри зашифрованного устройства. Следуйте инструкциям по созданию swap-файла из <a href="../../ru/Swap.html#%D0%A4%D0%B0%D0%B9%D0%BB_%D0%BF%D0%BE%D0%B4%D0%BA%D0%B0%D1%87%D0%BA%D0%B8" title="Swap (Русский)">Swap (Русский)#Файл подкачки</a> и настройте гибернацию согласно <a href="../../ru/Power_management/Suspend_and_hibernate.html#%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0_initramfs" title="Power management (Русский)/Suspend and hibernate (Русский)">Power management (Русский)/Suspend and hibernate (Русский)#Настройка initramfs</a>.
</p>
<p>При использовании <a href="../../ru/Mkinitcpio.html#%D0%94%D0%BE%D1%81%D1%82%D1%83%D0%BF%D0%BD%D1%8B%D0%B5_%D1%85%D1%83%D0%BA%D0%B8" title="Mkinitcpio (Русский)">initrd на базе systemd</a> и зашифрованной корневой файловой системы это может быть очень простым и гибким способом шифрования swap. После настройки <a href="../../en/Dm-crypt/Encrypting_an_entire_system.html" title="Dm-crypt/Encrypting an entire system">зашифрованной корневой файловой системы</a> можно создать swap-файл, активировать его и добавить в <code>/etc/fstab</code> — он будет работать с гибернацией без дополнительной настройки.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> При использовании параметра ядра <code>resume=</code> он должен указывать на уже расшифрованное/смонтированное устройство, содержащее файловую систему с файлом подкачки.</div>
<h3>
<span id=".D0.98.D1.81.D0.BF.D0.BE.D0.BB.D1.8C.D0.B7.D0.BE.D0.B2.D0.B0.D0.BD.D0.B8.D0.B5_swap-.D1.80.D0.B0.D0.B7.D0.B4.D0.B5.D0.BB.D0.B0"></span><span class="mw-headline" id="Использование_swap-раздела">Использование swap-раздела</span>
</h3>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> Чтобы использовать раздел, который в данный момент используется системой, необходимо сначала его отключить с помощью <code>swapoff /dev/<i>device</i></code> от имени root и убедиться, что в <a href="../../en/Dm-crypt/System_configuration.html#crypttab" class="mw-redirect" title="Crypttab">/etc/crypttab</a> отсутствует строка, ссылающаяся на это устройство.</div>
<p>Используйте <span class="plainlinks archwiki-template-man" title="$ man 8 cryptsetup-luksFormat"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/cryptsetup-luksFormat.8">cryptsetup-luksFormat(8)</a></span>, чтобы создать зашифрованный контейнер для раздела подкачки:
</p>
<pre># cryptsetup luksFormat --label swap /dev/<i>device</i>
</pre>
<p>Откройте контейнер под именем <code>/dev/mapper/swap</code>:
</p>
<pre># cryptsetup open /dev/disk/by-label/swap swap
</pre>
<p>Создайте файловую систему swap внутри отображённого раздела:
</p>
<pre># mkswap /dev/mapper/swap
</pre>
<p>Если вы не используете <a href="../../en/Systemd.html#GPT_partition_automounting" title="Systemd">systemd#GPT partition automounting</a>, добавьте отображённый раздел в <code>/etc/fstab</code>, добавив следующую строку:
</p>
<pre>/dev/mapper/swap none swap defaults 0 0
</pre>
<p>Чтобы настроить систему на восстановление из гибернации, используйте параметр ядра <code>resume=/dev/mapper/swap</code>. Подробности см. в <a href="../../en/Power_management/Suspend_and_hibernate.html#Pass_hibernate_location_to_initramfs" title="Power management/Suspend and hibernate">Power management/Suspend and hibernate#Pass hibernate location to initramfs</a>.
</p>
<h4>
<span id=".D0.98.D1.81.D0.BF.D0.BE.D0.BB.D1.8C.D0.B7.D0.BE.D0.B2.D0.B0.D0.BD.D0.B8.D0.B5_TPM"></span><span class="mw-headline" id="Использование_TPM">Использование TPM</span>
</h4>
<p>Далее описывается способ автоматической расшифровки swap с помощью ключа, хранящегося в <a href="../../en/Trusted_Platform_Module.html" class="mw-redirect" title="TPM">TPM</a>.
</p>
<p>Вы можете использовать <a href="../../en/Systemd-cryptenroll.html#Trusted_Platform_Module" title="Systemd-cryptenroll">systemd-cryptenroll</a>, чтобы записать ключ в LUKS-контейнер и TPM, а затем удалить ранее созданный слот с паролем:
</p>
<pre># systemd-cryptenroll --tpm2-device auto /dev/<i>device</i>
# systemd-cryptenroll --wipe-slot password /dev/<i>device</i>
</pre>
<p>Проверьте результат:
</p>
<pre># systemd-cryptenroll /dev/<i>device</i>
SLOT TYPE
   0 tpm2
</pre>
<h4>
<span id=".D0.98.D1.81.D0.BF.D0.BE.D0.BB.D1.8C.D0.B7.D0.BE.D0.B2.D0.B0.D0.BD.D0.B8.D0.B5_.D0.B4.D0.BE.D0.BF.D0.BE.D0.BB.D0.BD.D0.B8.D1.82.D0.B5.D0.BB.D1.8C.D0.BD.D0.BE.D0.B9_.D0.BF.D0.B0.D1.80.D0.BE.D0.BB.D1.8C.D0.BD.D0.BE.D0.B9_.D1.84.D1.80.D0.B0.D0.B7.D1.8B_.D0.B8.D0.BB.D0.B8_.D0.BA.D0.BB.D1.8E.D1.87.D0.B5.D0.B2.D0.BE.D0.B3.D0.BE_.D1.84.D0.B0.D0.B9.D0.BB.D0.B0"></span><span class="mw-headline" id="Использование_дополнительной_парольной_фразы_или_ключевого_файла">Использование дополнительной парольной фразы или ключевого файла</span>
</h4>
<p>У <a href="#%D0%98%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_swap-%D1%80%D0%B0%D0%B7%D0%B4%D0%B5%D0%BB%D0%B0">основной настройки</a>, приведённой выше, есть недостаток: требуется вручную вводить дополнительную парольную фразу для swap-раздела при каждой загрузке.
</p>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Важно:</strong> Не используйте эту настройку с ключевым файлом, если <code>/boot</code> не зашифрован. См. информацию об уязвимости <a rel="nofollow" class="external text" href="https://wiki.archlinux.org/index.php?title=Talk:Dm-crypt&amp;oldid=255742#Suspend_to_disk_instructions_are_insecure">здесь</a>. В качестве альтернативы используйте ключевой файл, зашифрованный через gnupg, как описано здесь: <a rel="nofollow" class="external free" href="https://bbs.archlinux.org/viewtopic.php?id=120181">https://bbs.archlinux.org/viewtopic.php?id=120181</a>
</div>
<h4>
<span id=".D0.A0.D0.B0.D1.81.D1.88.D0.B8.D1.84.D1.80.D0.BE.D0.B2.D0.BA.D0.B0_.D1.80.D0.B0.D0.B7.D0.B4.D0.B5.D0.BB.D0.B0_.D0.B2_initramfs"></span><span class="mw-headline" id="Расшифровка_раздела_в_initramfs">Расшифровка раздела в initramfs</span>
</h4>
<p>Для восстановления из гибернации с зашифрованного swap-раздела он должен быть расшифрован в initramfs.
</p>
<h5><span class="mw-headline" id="mkinitcpio">mkinitcpio</span></h5>
<h6>
<span id="initramfs_.D0.BD.D0.B0_.D0.B1.D0.B0.D0.B7.D0.B5_systemd"></span><span class="mw-headline" id="initramfs_на_базе_systemd">initramfs на базе systemd</span>
</h6>
<p>При использовании initramfs на базе systemd с хуком <a href="../../en/Dm-crypt/System_configuration.html#Using_systemd-cryptsetup-generator" class="mw-redirect" title="Sd-encrypt">sd-encrypt</a> из mkinitcpio, вы можете:
</p>
<ul>
<li>указать соответствующий параметр ядра <code>rd.luks.uuid=</code> для расшифровки swap-раздела, см. <a href="../../en/Dm-crypt/System_configuration.html#rd.luks.uuid" title="Dm-crypt/System configuration">Dm-crypt/System configuration#rd.luks.uuid</a>, или</li>
<li>отредактировать <code>crypttab.initramfs</code> и <a href="../../en/Mkinitcpio.html#Image_creation_and_activation" class="mw-redirect" title="Regenerate the initramfs">пересобрать initramfs</a>.</li>
</ul>
<p>Пример для устройства swap, расшифровываемого через TPM:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/crypttab.initramfs</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">swap UUID=56f8ee97-54b3-4a65-9282-688deb922527 none tpm2-device=auto</pre>
<h6>
<span id="initramfs_.D0.BD.D0.B0_.D0.B1.D0.B0.D0.B7.D0.B5_busybox"></span><span class="mw-headline" id="initramfs_на_базе_busybox">initramfs на базе busybox</span>
</h6>
<p>При использовании стандартного initramfs на базе busybox с хуком <a href="../../en/Dm-crypt/System_configuration.html#Using_encrypt_hook" title="Dm-crypt/System configuration">encrypt</a> следуйте приведённым ниже инструкциям.
</p>
<p>Если swap-устройство находится на другом физическом диске, отличном от корневой файловой системы, хук <code>encrypt</code> не сможет его открыть. В этом случае восстановление из гибернации произойдёт до того, как будет доступен <code>/etc/crypttab</code>, поэтому необходимо создать собственный хук в <code>/etc/mkinitcpio.conf</code>, чтобы открыть LUKS-устройство подкачки до момента восстановления.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> Этот раздел применим только при использовании <code>encrypt</code>-хука, который может разблокировать только одно устройство (<a rel="nofollow" class="external text" href="https://gitlab.archlinux.org/archlinux/mkinitcpio/mkinitcpio/-/issues/231">archlinux/mkinitcpio/mkinitcpio#231</a>). При использовании <code>sd-encrypt</code> можно разблокировать несколько устройств, см. <a href="../../en/Dm-crypt/System_configuration.html#Using_systemd-cryptsetup-generator" title="Dm-crypt/System configuration">dm-crypt/System configuration#Using systemd-cryptsetup-generator</a>.</div>
<p>Теперь нужно создать хук, который будет открывать swap при загрузке. Вы можете либо <a href="../../en/Help:Reading.html#Installation_of_packages" class="mw-redirect" title="Install">установить</a> и настроить <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/mkinitcpio-openswap/">mkinitcpio-openswap</a></span><sup><small>AUR</small></sup>, либо выполнить следующие шаги вручную. Создайте файл хука со следующей функцией:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/initcpio/hooks/openswap</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">run_hook ()
{
    cryptsetup open /dev/<i>device</i> swap
}
</pre>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Важно:</strong> Монтирование файловой системы <a rel="nofollow" class="external text" href="https://docs.kernel.org/power/swsusp.html">может быть опасным и разрушительным</a>. Ключевой файл не должен считываться с файловой системы, которая была смонтирована во время перехода в гибернацию.</div>
<div class="noprint archwiki-template-message">
<p><span class="mw-default-size" typeof="mw:File"><span><img src="../../File:Tango-view-fullscreen.svg" decoding="async" width="48" height="48" class="mw-file-element"></span></span><b>This article or section needs expansion.</b></p>
<div>
<b>Reason:</b> Добавьте инструкции, которые позволят избежать потери данных. (Discuss in <a rel="nofollow" class="external text" href="../../ru/Talk:Dm-crypt/Swap_encryption.html">Talk:Dm-crypt (Русский)/Swap encryption (Русский)</a>)</div>
</div>
<p>Для открытия swap-устройства вручную с вводом пароля:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/initcpio/hooks/openswap</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">run_hook ()
{
    ## Необязательно: защита от гонок
    x=0;
    while [ ! -b /dev/mapper/<i>root-device</i> ] &amp;&amp; [ $x -le 10 ]; do
       x=$((x+1))
       sleep .2
    done
    ## Конец необязательного блока

    mkdir crypto_key_device
    mount /dev/mapper/<i>root-device</i> crypto_key_device
    cryptsetup open --key-file crypto_key_device/<i>path-to-the-key</i> /dev/<i>device</i> swap
    umount crypto_key_device
}</pre>
<p>для открытия swap-устройства с использованием ключевого файла, размещённого на зашифрованном корневом разделе.
</p>
<p>На некоторых компьютерах возможны состояния гонки, при которых `mkinitcpio` пытается смонтировать устройство до завершения расшифровки или до появления устройства в `/dev`. Комментарии в блоке <i>Optional</i> добавляют задержку до 2 секунд, чтобы дождаться готовности корневого устройства.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> Если swap расположен на SSD и требуется поддержка discard/TRIM, необходимо добавить параметр <code>--allow-discards</code> в команду `cryptsetup` в хуке `openswap`. См. <a href="../../en/Dm-crypt/Specialties.html#Discard/TRIM_support_for_solid_state_drives_(SSD)" title="Dm-crypt/Specialties">Dm-crypt/Specialties#Discard/TRIM support for solid state drives (SSD)</a> или <a href="../../en/Solid_state_drive.html" class="mw-redirect" title="SSD">SSD</a> для подробностей. Также необходимо указать параметр `discard` в `fstab` для соответствующего устройства.</div>
<p>Затем создайте и отредактируйте файл установки хука:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/initcpio/install/openswap</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">build ()
{
   add_runscript
}
help ()
{
cat&lt;&lt;HELPEOF
  Этот хук открывает зашифрованный раздел подкачки /dev/<i>device</i> в /dev/mapper/swap
HELPEOF
}
</pre>
<p>Добавьте хук <code>openswap</code> в массив <code>HOOKS</code> в файле <code>/etc/mkinitcpio.conf</code>, перед <code>filesystem</code>, но после <code>encrypt</code>. Не забудьте также добавить хук <code>resume</code> после <code>openswap</code>:
</p>
<pre>HOOKS=(... encrypt openswap resume filesystems ...)
</pre>
<p><a href="../../en/Mkinitcpio.html#Image_creation_and_activation" class="mw-redirect" title="Regenerate the initramfs">Пересоберите initramfs</a>.
</p>
<p>При следующей загрузке хук <code>openswap</code> откроет раздел подкачки, и ядро сможет использовать его для восстановления. Если вы используете специальные хуки для гибернации, убедитесь, что они идут <b>после</b> <code>openswap</code> в массиве <code>HOOKS</code>. Обратите внимание, что если swap открывается в initrd, то запись о нём в <code>/etc/crypttab</code> больше не требуется.
</p>
<h5><span class="mw-headline" id="dracut">dracut</span></h5>
<p>Создайте файл ключа:
</p>
<pre># dd bs=512 count=4 if=/dev/random iflag=fullblock | install -m 0600 /dev/stdin /etc/cryptsetup-keys.d/swap.key
</pre>
<p>Добавьте ключ в LUKS:
</p>
<pre># cryptsetup luksAddKey /dev/<i>device</i> /etc/cryptsetup-keys.d/swap.key
</pre>
<p>Настройте `dracut` так, чтобы он включал модуль <code>resume</code> и добавлял ключ в initramfs (см. также <a href="../../en/Dracut.html#Hibernation" title="Dracut">dracut#Hibernation</a>):
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/dracut.conf.d/resume-from-hibernate.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">add_dracutmodules+=" resume "
install_items+=" /etc/cryptsetup-keys.d/swap.key "</pre>
<p><a href="../../en/Dracut.html#Usage" title="Dracut">Пересоберите initramfs</a>.
</p>
<p>Добавьте параметры <code>rd.luks.name</code> и <code>rd.luks.key</code> (подставив UUID раздела swap) в командную строку ядра. Пример строки загрузки:
</p>
<pre>kernel /vmlinuz-linux cryptdevice=/dev/sda2:root root=/dev/mapper/root resume=/dev/mapper/swap rd.luks.name=fd839505-3213-4603-9a70-c5a96a24768f=swap rd.luks.key=/etc/cryptsetup-keys.d/swap.key ro
</pre>
<h3>
<span id="LVM_.D0.B2.D0.BD.D1.83.D1.82.D1.80.D0.B8_LUKS"></span><span class="mw-headline" id="LVM_внутри_LUKS">LVM внутри LUKS</span>
</h3>
<p>Если том подкачки находится в группе томов, которая активируется в initramfs, просто следуйте инструкциям из <a href="../../ru/Power_management/Suspend_and_hibernate.html#%D0%93%D0%B8%D0%B1%D0%B5%D1%80%D0%BD%D0%B0%D1%86%D0%B8%D1%8F" title="Power management (Русский)/Suspend and hibernate (Русский)">Power management (Русский)/Suspend and hibernate (Русский)#Гибернация</a>.
</p>
<h2>
<span id=".D0.98.D0.B7.D0.B2.D0.B5.D1.81.D1.82.D0.BD.D1.8B.D0.B5_.D0.BF.D1.80.D0.BE.D0.B1.D0.BB.D0.B5.D0.BC.D1.8B"></span><span class="mw-headline" id="Известные_проблемы">Известные проблемы</span>
</h2>
<ul><li>
<code>Stopped (with error) /dev/dm-1</code> в логах. См. <a rel="nofollow" class="external text" href="https://github.com/systemd/systemd/issues/1620">systemd issue 1620</a>.</li></ul>
</div>
</div>
					<div id="catlinks" class="catlinks" data-mw="interface">
<div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../../Special:Categories.html" title="Special:Categories">Category</a>: <ul><li><a href="../../ru/Category:Data-at-rest_encryption.html" title="Category:Data-at-rest encryption (Русский)">Data-at-rest encryption (Русский)</a></li></ul>
</div>
<div id="mw-hidden-catlinks" class="mw-hidden-catlinks mw-hidden-cats-hidden">Hidden category: <ul><li><a href="../../en/Category:Pages_or_sections_flagged_with_Template:Expansion.html" title="Category:Pages or sections flagged with Template:Expansion">Pages or sections flagged with Template:Expansion</a></li></ul>
</div>
</div>
				</div>
			</main>
			
		</div>
		<div class="mw-footer-container">
			
<footer id="footer" class="mw-footer" style="margin: 0">
	<ul id="footer-info">
	<li data-nosnippet="">Retrieved from "<a dir="ltr" href="https://wiki.archlinux.org/index.php?title=Dm-crypt_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)/Swap_encryption_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)&amp;oldid=834871">https://wiki.archlinux.org/index.php?title=Dm-crypt_(Русский)/Swap_encryption_(Русский)&amp;oldid=834871</a>"</li>
<li id="footer-info-lastmod"> This page was last edited on 30 May 2025, at 09:41.</li>
	<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="https://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.3 or later</a> unless otherwise noted.</li>
<br>
</ul>

	<ul id="footer-places">
	<li id="footer-places-privacy"><a href="https://terms.archlinux.org/docs/privacy-policy/">Privacy policy</a></li>
	<li id="footer-places-about"><a href="../../en/ArchWiki:About.html">About ArchWiki</a></li>
	<li id="footer-places-disclaimers"><a href="../../en/ArchWiki:General_disclaimer.html">Disclaimers</a></li>
	<li id="footer-places-archwiki-code-of-conduct"><a href="https://terms.archlinux.org/docs/code-of-conduct/" class="extiw" title="archlinux-service-agreements:code-of-conduct">Code of conduct</a></li>
	<li id="footer-places-archwiki-terms-of-service"><a href="https://terms.archlinux.org/docs/terms-of-service/" class="extiw" title="archlinux-service-agreements:terms-of-service">Terms of service</a></li>
</ul>

	<ul id="footer-icons" class="noprint">
	<li id="footer-copyrightico"><a href="https://www.gnu.org/copyleft/fdl.html" class="cdx-button cdx-button--fake-button cdx-button--size-large cdx-button--fake-button--enabled"><img src="/resources/assets/licenses/gnu-fdl.png" alt="GNU Free Documentation License 1.3 or later" width="88" height="31" loading="lazy"></a></li>
	<li id="footer-poweredbyico"><img src="/resources/assets/poweredby_mediawiki.svg" width="88" height="31" loading="lazy"></li>
</ul>

</footer>

		</div>
	</div> 
</div> 
<div class="vector-settings" id="p-dock-bottom">
	<ul></ul>
</div>
</body>
</html>
