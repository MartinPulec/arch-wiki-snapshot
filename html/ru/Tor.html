<!DOCTYPE html>
<html class="client-nojs vector-feature-language-in-header-enabled vector-feature-language-in-main-page-header-disabled vector-feature-sticky-header-disabled vector-feature-page-tools-pinned-disabled vector-feature-toc-pinned-clientpref-1 vector-feature-main-menu-pinned-disabled vector-feature-limited-width-clientpref-1 vector-feature-limited-width-content-enabled vector-feature-custom-font-size-clientpref-0 vector-feature-client-preferences-disabled vector-feature-client-prefs-pinned-disabled vector-feature-night-mode-disabled skin-theme-clientpref-day vector-toc-available" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>Tor (Русский) - ArchWiki</title>
<link rel="stylesheet" href="../ArchWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<meta name="generator" content="MediaWiki 1.42.1">
<meta name="referrer" content="no-referrer-when-downgrade">
<meta name="robots" content="max-image-preview:standard">
<meta name="format-detection" content="telephone=no">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=0.25, maximum-scale=5.0">
<link rel="icon" href="/favicon.ico">
<link rel="search" type="application/opensearchdescription+xml" href="/opensearch_desc.php" title="ArchWiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.archlinux.org/api.php?action=rsd">
<link rel="license" href="https://www.gnu.org/copyleft/fdl.html">
<link rel="alternate" type="application/atom+xml" title="ArchWiki Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="skin-vector skin-vector-search-vue mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-Tor_Русский rootpage-Tor_Русский skin-vector-2022 action-view skin--responsive">
<a class="mw-jump-link" href="#bodyContent">Jump to content</a>
<div class="vector-header-container">
	</div>
<div class="mw-page-container">
	<div class="mw-page-container-inner">
		<div class="vector-column-start">
			<div class="vector-main-menu-container">
		</div>
	<div class="vector-sticky-pinned-container">
				<nav id="mw-panel-toc" role="navigation" aria-label="Contents" data-event-name="ui.sidebar-toc" class="mw-table-of-contents-container vector-toc-landmark">
					<div id="vector-toc-pinned-container" class="vector-pinned-container">
					<div id="vector-toc" class="vector-toc vector-pinnable-element">
	<div class="vector-pinnable-header vector-toc-pinnable-header vector-pinnable-header-pinned" data-feature-name="toc-pinned" data-pinnable-element-id="vector-toc">
	<h2 class="vector-pinnable-header-label">Contents</h2>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-pin-button" data-event-name="pinnable-header.vector-toc.pin">move to sidebar</button>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-unpin-button" data-event-name="pinnable-header.vector-toc.unpin">hide</button>
</div>


	<ul class="vector-toc-contents" id="mw-panel-toc-list">
		<li id="toc-mw-content-text" class="vector-toc-list-item vector-toc-level-1">
			<a href="#" class="vector-toc-link">
				<div class="vector-toc-text">Beginning</div>
			</a>
		</li>
		<li id="toc-Установка" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">1</span>Установка</div>
		</a>
		
		<ul id="toc-Установка-sublist" class="vector-toc-list">
		</ul>
	</li>
	<li id="toc-Использование" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#%D0%98%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">2</span>Использование</div>
		</a>
		
		<ul id="toc-Использование-sublist" class="vector-toc-list">
		</ul>
	</li>
	<li id="toc-Настройка" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">3</span>Настройка</div>
		</a>
		
			<button aria-controls="toc-Настройка-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Настройка subsection</span>
			</button>
		
		<ul id="toc-Настройка-sublist" class="vector-toc-list">
			<li id="toc-Настройка_Tor_Relay" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0_Tor_Relay">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.1</span>Настройка Tor Relay</div>
			</a>
			
			<ul id="toc-Настройка_Tor_Relay-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Tor_ControlPort" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Tor_ControlPort">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.2</span>Tor ControlPort</div>
			</a>
			
			<ul id="toc-Tor_ControlPort-sublist" class="vector-toc-list">
				<li id="toc-Cookie-файл_Tor_Control" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Cookie-%D1%84%D0%B0%D0%B9%D0%BB_Tor_Control">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.2.1</span>Cookie-файл Tor Control</div>
			</a>
			
			<ul id="toc-Cookie-файл_Tor_Control-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Пароль_Tor_Control" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#%D0%9F%D0%B0%D1%80%D0%BE%D0%BB%D1%8C_Tor_Control">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.2.2</span>Пароль Tor Control</div>
			</a>
			
			<ul id="toc-Пароль_Tor_Control-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Tor_ControlSocket" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Tor_ControlSocket">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.2.3</span>Tor ControlSocket</div>
			</a>
			
			<ul id="toc-Tor_ControlSocket-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Проверка_Tor_Control" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#%D0%9F%D1%80%D0%BE%D0%B2%D0%B5%D1%80%D0%BA%D0%B0_Tor_Control">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.2.4</span>Проверка Tor Control</div>
			</a>
			
			<ul id="toc-Проверка_Tor_Control-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Использование_системной_службы_Tor_в_браузере" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%98%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D0%BD%D0%BE%D0%B9_%D1%81%D0%BB%D1%83%D0%B6%D0%B1%D1%8B_Tor_%D0%B2_%D0%B1%D1%80%D0%B0%D1%83%D0%B7%D0%B5%D1%80%D0%B5">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.3</span>Использование системной службы Tor в браузере</div>
			</a>
			
			<ul id="toc-Использование_системной_службы_Tor_в_браузере-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Запуск_Tor_в_chroot" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#%D0%97%D0%B0%D0%BF%D1%83%D1%81%D0%BA_Tor_%D0%B2_chroot">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">4</span>Запуск Tor в chroot</div>
		</a>
		
		<ul id="toc-Запуск_Tor_в_chroot-sublist" class="vector-toc-list">
		</ul>
	</li>
	<li id="toc-Запуск_Tor_в_контейнере_systemd-nspawn" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#%D0%97%D0%B0%D0%BF%D1%83%D1%81%D0%BA_Tor_%D0%B2_%D0%BA%D0%BE%D0%BD%D1%82%D0%B5%D0%B9%D0%BD%D0%B5%D1%80%D0%B5_systemd-nspawn">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">5</span>Запуск Tor в контейнере systemd-nspawn</div>
		</a>
		
			<button aria-controls="toc-Запуск_Tor_в_контейнере_systemd-nspawn-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Запуск Tor в контейнере systemd-nspawn subsection</span>
			</button>
		
		<ul id="toc-Запуск_Tor_в_контейнере_systemd-nspawn-sublist" class="vector-toc-list">
			<li id="toc-Установка_и_настройка_хоста" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0_%D0%B8_%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0_%D1%85%D0%BE%D1%81%D1%82%D0%B0">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">5.1</span>Установка и настройка хоста</div>
			</a>
			
			<ul id="toc-Установка_и_настройка_хоста-sublist" class="vector-toc-list">
				<li id="toc-Виртуальный_сетевой_интерфейс" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#%D0%92%D0%B8%D1%80%D1%82%D1%83%D0%B0%D0%BB%D1%8C%D0%BD%D1%8B%D0%B9_%D1%81%D0%B5%D1%82%D0%B5%D0%B2%D0%BE%D0%B9_%D0%B8%D0%BD%D1%82%D0%B5%D1%80%D1%84%D0%B5%D0%B9%D1%81">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">5.1.1</span>Виртуальный сетевой интерфейс</div>
			</a>
			
			<ul id="toc-Виртуальный_сетевой_интерфейс-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Запуск_и_включение_systemd-nspawn" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#%D0%97%D0%B0%D0%BF%D1%83%D1%81%D0%BA_%D0%B8_%D0%B2%D0%BA%D0%BB%D1%8E%D1%87%D0%B5%D0%BD%D0%B8%D0%B5_systemd-nspawn">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">5.1.2</span>Запуск и включение systemd-nspawn</div>
			</a>
			
			<ul id="toc-Запуск_и_включение_systemd-nspawn-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Настройка_контейнера" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0_%D0%BA%D0%BE%D0%BD%D1%82%D0%B5%D0%B9%D0%BD%D0%B5%D1%80%D0%B0">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">5.2</span>Настройка контейнера</div>
			</a>
			
			<ul id="toc-Настройка_контейнера-sublist" class="vector-toc-list">
				<li id="toc-Запуск_и_включение_systemd-networkd" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#%D0%97%D0%B0%D0%BF%D1%83%D1%81%D0%BA_%D0%B8_%D0%B2%D0%BA%D0%BB%D1%8E%D1%87%D0%B5%D0%BD%D0%B8%D0%B5_systemd-networkd">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">5.2.1</span>Запуск и включение systemd-networkd</div>
			</a>
			
			<ul id="toc-Запуск_и_включение_systemd-networkd-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Настройка_Tor" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0_Tor">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">5.3</span>Настройка Tor</div>
			</a>
			
			<ul id="toc-Настройка_Tor-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Веб-сёрфинг" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#%D0%92%D0%B5%D0%B1-%D1%81%D1%91%D1%80%D1%84%D0%B8%D0%BD%D0%B3">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">6</span>Веб-сёрфинг</div>
		</a>
		
			<button aria-controls="toc-Веб-сёрфинг-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Веб-сёрфинг subsection</span>
			</button>
		
		<ul id="toc-Веб-сёрфинг-sublist" class="vector-toc-list">
			<li id="toc-Firefox" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Firefox">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">6.1</span>Firefox</div>
			</a>
			
			<ul id="toc-Firefox-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Chromium" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Chromium">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">6.2</span>Chromium</div>
			</a>
			
			<ul id="toc-Chromium-sublist" class="vector-toc-list">
				<li id="toc-Отладка" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#%D0%9E%D1%82%D0%BB%D0%B0%D0%B4%D0%BA%D0%B0">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">6.2.1</span>Отладка</div>
			</a>
			
			<ul id="toc-Отладка-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Расширения" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#%D0%A0%D0%B0%D1%81%D1%88%D0%B8%D1%80%D0%B5%D0%BD%D0%B8%D1%8F">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">6.2.2</span>Расширения</div>
			</a>
			
			<ul id="toc-Расширения-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Electron" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Electron">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">6.2.3</span>Electron</div>
			</a>
			
			<ul id="toc-Electron-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Luakit" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Luakit">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">6.3</span>Luakit</div>
			</a>
			
			<ul id="toc-Luakit-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-HTTP-прокси" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#HTTP-%D0%BF%D1%80%D0%BE%D0%BA%D1%81%D0%B8">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">7</span>HTTP-прокси</div>
		</a>
		
			<button aria-controls="toc-HTTP-прокси-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle HTTP-прокси subsection</span>
			</button>
		
		<ul id="toc-HTTP-прокси-sublist" class="vector-toc-list">
			<li id="toc-Tor" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Tor">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">7.1</span>Tor</div>
			</a>
			
			<ul id="toc-Tor-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Firefox_2" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Firefox_2">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">7.2</span>Firefox</div>
			</a>
			
			<ul id="toc-Firefox_2-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Privoxy" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Privoxy">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">7.3</span>Privoxy</div>
			</a>
			
			<ul id="toc-Privoxy-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Обмен_мгновенными_сообщениями" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#%D0%9E%D0%B1%D0%BC%D0%B5%D0%BD_%D0%BC%D0%B3%D0%BD%D0%BE%D0%B2%D0%B5%D0%BD%D0%BD%D1%8B%D0%BC%D0%B8_%D1%81%D0%BE%D0%BE%D0%B1%D1%89%D0%B5%D0%BD%D0%B8%D1%8F%D0%BC%D0%B8">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">8</span>Обмен мгновенными сообщениями</div>
		</a>
		
			<button aria-controls="toc-Обмен_мгновенными_сообщениями-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Обмен мгновенными сообщениями subsection</span>
			</button>
		
		<ul id="toc-Обмен_мгновенными_сообщениями-sublist" class="vector-toc-list">
			<li id="toc-Pidgin" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Pidgin">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.1</span>Pidgin</div>
			</a>
			
			<ul id="toc-Pidgin-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Irssi" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Irssi">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.2</span>Irssi</div>
			</a>
			
			<ul id="toc-Irssi-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Pacman" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#Pacman">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">9</span>Pacman</div>
		</a>
		
		<ul id="toc-Pacman-sublist" class="vector-toc-list">
		</ul>
	</li>
	<li id="toc-Java" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#Java">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">10</span>Java</div>
		</a>
		
		<ul id="toc-Java-sublist" class="vector-toc-list">
		</ul>
	</li>
	<li id="toc-Запуск_сервера_Tor" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#%D0%97%D0%B0%D0%BF%D1%83%D1%81%D0%BA_%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80%D0%B0_Tor">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">11</span>Запуск сервера Tor</div>
		</a>
		
			<button aria-controls="toc-Запуск_сервера_Tor-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Запуск сервера Tor subsection</span>
			</button>
		
		<ul id="toc-Запуск_сервера_Tor-sublist" class="vector-toc-list">
			<li id="toc-Мост" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%9C%D0%BE%D1%81%D1%82">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">11.1</span>Мост</div>
			</a>
			
			<ul id="toc-Мост-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Передающий_узел" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%9F%D0%B5%D1%80%D0%B5%D0%B4%D0%B0%D1%8E%D1%89%D0%B8%D0%B9_%D1%83%D0%B7%D0%B5%D0%BB">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">11.2</span>Передающий узел</div>
			</a>
			
			<ul id="toc-Передающий_узел-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Выходной_узел" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%92%D1%8B%D1%85%D0%BE%D0%B4%D0%BD%D0%BE%D0%B9_%D1%83%D0%B7%D0%B5%D0%BB">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">11.3</span>Выходной узел</div>
			</a>
			
			<ul id="toc-Выходной_узел-sublist" class="vector-toc-list">
				<li id="toc-Настройка_2" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0_2">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">11.3.1</span>Настройка</div>
			</a>
			
			<ul id="toc-Настройка_2-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Пример_настройки_100-мегабитного_выходного_узла" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#%D0%9F%D1%80%D0%B8%D0%BC%D0%B5%D1%80_%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B8_100-%D0%BC%D0%B5%D0%B3%D0%B0%D0%B1%D0%B8%D1%82%D0%BD%D0%BE%D0%B3%D0%BE_%D0%B2%D1%8B%D1%85%D0%BE%D0%B4%D0%BD%D0%BE%D0%B3%D0%BE_%D1%83%D0%B7%D0%BB%D0%B0">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">11.3.2</span>Пример настройки 100-мегабитного выходного узла</div>
			</a>
			
			<ul id="toc-Пример_настройки_100-мегабитного_выходного_узла-sublist" class="vector-toc-list">
				<li id="toc-Tor_2" class="vector-toc-list-item vector-toc-level-4">
			<a class="vector-toc-link" href="#Tor_2">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">11.3.2.1</span>Tor</div>
			</a>
			
			<ul id="toc-Tor_2-sublist" class="vector-toc-list">
				<li id="toc-Количество_соединений" class="vector-toc-list-item vector-toc-level-5">
			<a class="vector-toc-link" href="#%D0%9A%D0%BE%D0%BB%D0%B8%D1%87%D0%B5%D1%81%D1%82%D0%B2%D0%BE_%D1%81%D0%BE%D0%B5%D0%B4%D0%B8%D0%BD%D0%B5%D0%BD%D0%B8%D0%B9">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">11.3.2.1.1</span>Количество соединений</div>
			</a>
			
			<ul id="toc-Количество_соединений-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Привилегированные_порты" class="vector-toc-list-item vector-toc-level-5">
			<a class="vector-toc-link" href="#%D0%9F%D1%80%D0%B8%D0%B2%D0%B8%D0%BB%D0%B5%D0%B3%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%BD%D1%8B%D0%B5_%D0%BF%D0%BE%D1%80%D1%82%D1%8B">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">11.3.2.1.2</span>Привилегированные порты</div>
			</a>
			
			<ul id="toc-Привилегированные_порты-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Конфигурация" class="vector-toc-list-item vector-toc-level-5">
			<a class="vector-toc-link" href="#%D0%9A%D0%BE%D0%BD%D1%84%D0%B8%D0%B3%D1%83%D1%80%D0%B0%D1%86%D0%B8%D1%8F">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">11.3.2.1.3</span>Конфигурация</div>
			</a>
			
			<ul id="toc-Конфигурация-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-nyx" class="vector-toc-list-item vector-toc-level-4">
			<a class="vector-toc-link" href="#nyx">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">11.3.2.2</span>nyx</div>
			</a>
			
			<ul id="toc-nyx-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-iptables" class="vector-toc-list-item vector-toc-level-4">
			<a class="vector-toc-link" href="#iptables">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">11.3.2.3</span>iptables</div>
			</a>
			
			<ul id="toc-iptables-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-pdnsd" class="vector-toc-list-item vector-toc-level-4">
			<a class="vector-toc-link" href="#pdnsd">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">11.3.2.4</span>pdnsd</div>
			</a>
			
			<ul id="toc-pdnsd-sublist" class="vector-toc-list">
				<li id="toc-Uncensored_DNS" class="vector-toc-list-item vector-toc-level-5">
			<a class="vector-toc-link" href="#Uncensored_DNS">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">11.3.2.4.1</span>Uncensored DNS</div>
			</a>
			
			<ul id="toc-Uncensored_DNS-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Проверка_работоспособности_узла" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#%D0%9F%D1%80%D0%BE%D0%B2%D0%B5%D1%80%D0%BA%D0%B0_%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%BE%D1%81%D0%BF%D0%BE%D1%81%D0%BE%D0%B1%D0%BD%D0%BE%D1%81%D1%82%D0%B8_%D1%83%D0%B7%D0%BB%D0%B0">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">11.3.3</span>Проверка работоспособности узла</div>
			</a>
			
			<ul id="toc-Проверка_работоспособности_узла-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
	</ul>
	</li>
	<li id="toc-TorDNS" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#TorDNS">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">12</span>TorDNS</div>
		</a>
		
			<button aria-controls="toc-TorDNS-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle TorDNS subsection</span>
			</button>
		
		<ul id="toc-TorDNS-sublist" class="vector-toc-list">
			<li id="toc-Перенаправление_всех_DNS-запросов_через_TorDNS" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%9F%D0%B5%D1%80%D0%B5%D0%BD%D0%B0%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5_%D0%B2%D1%81%D0%B5%D1%85_DNS-%D0%B7%D0%B0%D0%BF%D1%80%D0%BE%D1%81%D0%BE%D0%B2_%D1%87%D0%B5%D1%80%D0%B5%D0%B7_TorDNS">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">12.1</span>Перенаправление всех DNS-запросов через TorDNS</div>
			</a>
			
			<ul id="toc-Перенаправление_всех_DNS-запросов_через_TorDNS-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Torsocks" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#Torsocks">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">13</span>Torsocks</div>
		</a>
		
		<ul id="toc-Torsocks-sublist" class="vector-toc-list">
		</ul>
	</li>
	<li id="toc-«Торификация»" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#%C2%AB%D0%A2%D0%BE%D1%80%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D1%8F%C2%BB">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">14</span>«Торификация»</div>
		</a>
		
		<ul id="toc-«Торификация»-sublist" class="vector-toc-list">
		</ul>
	</li>
	<li id="toc-Советы_и_рекомендации" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#%D0%A1%D0%BE%D0%B2%D0%B5%D1%82%D1%8B_%D0%B8_%D1%80%D0%B5%D0%BA%D0%BE%D0%BC%D0%B5%D0%BD%D0%B4%D0%B0%D1%86%D0%B8%D0%B8">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">15</span>Советы и рекомендации</div>
		</a>
		
			<button aria-controls="toc-Советы_и_рекомендации-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Советы и рекомендации subsection</span>
			</button>
		
		<ul id="toc-Советы_и_рекомендации-sublist" class="vector-toc-list">
			<li id="toc-Привилегии" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%9F%D1%80%D0%B8%D0%B2%D0%B8%D0%BB%D0%B5%D0%B3%D0%B8%D0%B8">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">15.1</span>Привилегии</div>
			</a>
			
			<ul id="toc-Привилегии-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Решение_проблем" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#%D0%A0%D0%B5%D1%88%D0%B5%D0%BD%D0%B8%D0%B5_%D0%BF%D1%80%D0%BE%D0%B1%D0%BB%D0%B5%D0%BC">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">16</span>Решение проблем</div>
		</a>
		
			<button aria-controls="toc-Решение_проблем-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Решение проблем subsection</span>
			</button>
		
		<ul id="toc-Решение_проблем-sublist" class="vector-toc-list">
			<li id="toc-Проблема_с_параметром_User" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%9F%D1%80%D0%BE%D0%B1%D0%BB%D0%B5%D0%BC%D0%B0_%D1%81_%D0%BF%D0%B0%D1%80%D0%B0%D0%BC%D0%B5%D1%82%D1%80%D0%BE%D0%BC_User">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">16.1</span>Проблема с параметром User</div>
			</a>
			
			<ul id="toc-Проблема_с_параметром_User-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Проблемы_с_прокси_в_Tor_Browser" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%9F%D1%80%D0%BE%D0%B1%D0%BB%D0%B5%D0%BC%D1%8B_%D1%81_%D0%BF%D1%80%D0%BE%D0%BA%D1%81%D0%B8_%D0%B2_Tor_Browser">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">16.2</span>Проблемы с прокси в Tor Browser</div>
			</a>
			
			<ul id="toc-Проблемы_с_прокси_в_Tor_Browser-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Пустой_чёрный_экран_в_tor-browser" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%9F%D1%83%D1%81%D1%82%D0%BE%D0%B9_%D1%87%D1%91%D1%80%D0%BD%D1%8B%D0%B9_%D1%8D%D0%BA%D1%80%D0%B0%D0%BD_%D0%B2_tor-browser">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">16.3</span>Пустой чёрный экран в tor-browser</div>
			</a>
			
			<ul id="toc-Пустой_чёрный_экран_в_tor-browser-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Смотрите_также" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#%D0%A1%D0%BC%D0%BE%D1%82%D1%80%D0%B8%D1%82%D0%B5_%D1%82%D0%B0%D0%BA%D0%B6%D0%B5">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">17</span>Смотрите также</div>
		</a>
		
		<ul id="toc-Смотрите_также-sublist" class="vector-toc-list">
		</ul>
	</li>
</ul>
</div>

					</div>
		</nav>
			</div>
		</div>
		<div class="mw-content-container">
			<main id="content" class="mw-body" role="main" style="margin: 0">
				<header class="mw-body-header vector-page-titlebar">
					<nav role="navigation" aria-label="Contents" class="vector-toc-landmark">
						
<div id="vector-page-titlebar-toc" class="vector-dropdown vector-page-titlebar-toc vector-button-flush-left">
	<input type="checkbox" id="vector-page-titlebar-toc-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-vector-page-titlebar-toc" class="vector-dropdown-checkbox " aria-label="Toggle the table of contents">
	<label id="vector-page-titlebar-toc-label" for="vector-page-titlebar-toc-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--icon-only " aria-hidden="true"><span class="vector-icon mw-ui-icon-listBullet mw-ui-icon-wikimedia-listBullet"></span>

<span class="vector-dropdown-label-text">Toggle the table of contents</span>
	</label>
	<div class="vector-dropdown-content">


							<div id="vector-page-titlebar-toc-unpinned-container" class="vector-unpinned-container">
			</div>
		
	</div>
</div>

					</nav>
					<h1 id="firstHeading" class="firstHeading mw-first-heading"><span class="mw-page-title-main">Tor (Русский)</span></h1>
							
<div id="p-lang-btn" class="vector-dropdown mw-portlet mw-portlet-lang">
	<input type="checkbox" id="p-lang-btn-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-p-lang-btn" class="vector-dropdown-checkbox mw-interlanguage-selector" aria-label="Go to an article in another language. Available in 4 languages">
	<label id="p-lang-btn-label" for="p-lang-btn-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--action-progressive mw-portlet-lang-heading-4" aria-hidden="true"><span class="vector-icon mw-ui-icon-language-progressive mw-ui-icon-wikimedia-language-progressive"></span>

<span class="vector-dropdown-label-text">4 languages</span>
	</label>
	<div class="vector-dropdown-content">

		<div class="vector-menu-content">
			
			<ul class="vector-menu-content-list">
				
				<li class="interlanguage-link interwiki-de mw-list-item"><a href="https://wiki.archlinux.de/title/Tor" title="Tor – Deutsch" lang="de" hreflang="de" class="interlanguage-link-target"><span>Deutsch</span></a></li>
<li class="interlanguage-link interwiki-en mw-list-item"><a href="../en/Tor.html" title="Tor – English" lang="en" hreflang="en" class="interlanguage-link-target"><span>English</span></a></li>
<li class="interlanguage-link interwiki-ja mw-list-item"><a href="https://wiki.archlinux.jp/index.php/Tor" title="Tor – 日本語" lang="ja" hreflang="ja" class="interlanguage-link-target"><span>日本語</span></a></li>
<li class="interlanguage-link interwiki-zh-hans mw-list-item"><a href="https://wiki.archlinuxcn.org/wiki/Tor" title="Tor – 中文（简体）" lang="zh-Hans" hreflang="zh-Hans" class="interlanguage-link-target"><span>中文（简体）</span></a></li>
			</ul>
			
		</div>

	</div>
</div>
</header>
				<div class="vector-column-end">
					<div class="vector-sticky-pinned-container">
						<nav class="vector-page-tools-landmark" aria-label="Page tools">
							<div id="vector-page-tools-pinned-container" class="vector-pinned-container">
				
							</div>
		</nav>
						<nav class="vector-client-prefs-landmark" aria-label="Appearance">
						</nav>
					</div>
				</div>
				<div id="bodyContent" class="vector-body" aria-labelledby="firstHeading" data-mw-ve-target-container>
					<div class="vector-body-before-content">
							<div class="mw-indicators">
		</div>

						<div id="siteSub" class="noprint">From ArchWiki</div>
					</div>
					<div id="contentSub"><div id="mw-content-subtitle"></div></div>
					
					
					<div id="mw-content-text" class="mw-body-content">
<div class="mw-content-ltr mw-parser-output" lang="ru" dir="ltr">
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Состояние перевода:</strong> На этой странице представлен перевод статьи <a href="../en/Tor.html" title="Tor">Tor</a>. Дата последней синхронизации: 19 июля 2024. Вы можете <a href="../ru/ArchWiki:Translation_Team.html" title="ArchWiki:Translation Team (Русский)">помочь</a> синхронизировать перевод, если в английской версии произошли <a rel="nofollow" class="external text" href="https://wiki.archlinux.org/index.php?title=Tor&amp;diff=0&amp;oldid=812615">изменения</a>.</div>
<div class="archwiki-template-meta-related-articles">
<p>Ссылки по теме</p>
<ul>
<li><a href="../ru/GNUnet.html" title="GNUnet (Русский)">GNUnet (Русский)</a></li>
<li><a href="../ru/I2P.html" title="I2P (Русский)">I2P (Русский)</a></li>
<li><a href="../en/List_of_applications/Internet.html#Anonymizing_networks" class="mw-redirect" title="Freenet">Freenet</a></li>
</ul>
</div>
<p><a rel="nofollow" class="external text" href="https://www.torproject.org">Tor Project</a> (<i>T</i>he <i>o</i>nion <i>r</i>outing) — открытая реализация <a href="https://en.wikipedia.org/wiki/ru:%D0%9B%D1%83%D0%BA%D0%BE%D0%B2%D0%B0%D1%8F_%D0%BC%D0%B0%D1%80%D1%88%D1%80%D1%83%D1%82%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F" class="extiw" title="wikipedia:ru:Луковая маршрутизация">луковой маршрутизации</a>, предоставляющая доступ к анонимной прокси-сети. Основная цель — сохранить <a href="https://en.wikipedia.org/wiki/ru:%D0%90%D0%BD%D0%BE%D0%BD%D0%B8%D0%BC%D0%BD%D0%BE%D1%81%D1%82%D1%8C#.D0.98.D0.BD.D1.82.D0.B5.D1.80.D0.BD.D0.B5.D1.82_.D0.B8_.D0.90.D0.BD.D0.BE.D0.BD.D0.B8.D0.BC.D0.BD.D0.BE.D1.81.D1.82.D1.8C" class="extiw" title="wikipedia:ru:Анонимность">анонимность</a> пользователя в интернете, обеспечив защиту от <a href="https://en.wikipedia.org/wiki/ru:%D0%90%D1%82%D0%B0%D0%BA%D0%B0_%D1%81_%D0%B8%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%D0%BC_%D0%B0%D0%BD%D0%B0%D0%BB%D0%B8%D0%B7%D0%B0_%D1%82%D1%80%D0%B0%D1%84%D0%B8%D0%BA%D0%B0" class="extiw" title="wikipedia:ru:Атака с использованием анализа трафика">анализа трафика</a>.
</p>
<p>Пользователи сети Tor запускают на своих машинах «луковый прокси» (onion proxy), который предоставляет программам-клиентам SOCKS-интерфейс. Прокси подключается к сети Tor, периодически согласовывая виртуальный канал через неё. Tor использует многослойную криптографию (отсюда аналогия с луком), последовательно обеспечивая секретность на каждом промежуточном маршрутизаторе.
</p>
<p>В процессе работы луковый прокси управляет сетевым трафиком, обеспечивая анонимность конечного пользователя. Трафик зашифровывается, пересылается через узлы сети Tor и дешифруется на последнем узле перед отправкой на целевой сервер. Цена обеспечения анонимности — низкая скорость работы по сравнению с обычным прямым соединением из-за большого количества перенаправлений трафика. Кроме того, хотя Tor обеспечивает защиту от анализа трафика, он не позволяет предотвратить атаки на опознание трафика (traffic confirmation) на границах сети Tor (то есть в точках входа и выхода из сети). Подробнее смотрите <a href="https://en.wikipedia.org/wiki/ru:Tor" class="extiw" title="wikipedia:ru:Tor">Wikipedia:ru:Tor</a>.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> Сам по себе Tor <b>не</b> обеспечивает полную анонимность. Есть целый ряд подводных камней, которые нужно учитывать при работе с Tor (смотрите <a rel="nofollow" class="external text" href="https://support.torproject.org/ru/#faq_staying-anonymous">Может ли Tor обеспечить мне полную анонимность?</a>).</div>
<meta property="mw:PageProp/toc">
<h2>
<span id=".D0.A3.D1.81.D1.82.D0.B0.D0.BD.D0.BE.D0.B2.D0.BA.D0.B0"></span><span class="mw-headline" id="Установка">Установка</span>
</h2>
<p><a href="../ru/Help:Reading.html#%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0_%D0%BF%D0%B0%D0%BA%D0%B5%D1%82%D0%BE%D0%B2" class="mw-redirect" title="Установите">Установите</a> пакет <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=torbrowser-launcher">torbrowser-launcher</a></span> для использования <a rel="nofollow" class="external text" href="https://www.torproject.org/ru/download/">Tor Browser</a> — это единственный официально поддерживаемый способ для анонимного веб-сёрфинга через Tor.
</p>
<p>Если вы планируете использовать Tor с другими приложениями или запустить свой собственный onion-сервис, установите пакет <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=tor">tor</a></span> — данная статья в основном посвящена его использованию.
</p>
<p><i>Nyx</i> — консольная утилита для мониторинга Tor. Позволяет отслеживать использование пропускной способности, детали соединений, а также редактировать настройки на лету. Для её использования <a href="../ru/Help:Reading.html#%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0_%D0%BF%D0%B0%D0%BA%D0%B5%D1%82%D0%BE%D0%B2" class="mw-redirect" title="Установите">установите</a> пакет <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=nyx">nyx</a></span>.
</p>
<h2>
<span id=".D0.98.D1.81.D0.BF.D0.BE.D0.BB.D1.8C.D0.B7.D0.BE.D0.B2.D0.B0.D0.BD.D0.B8.D0.B5"></span><span class="mw-headline" id="Использование">Использование</span>
</h2>
<p><a href="../ru/Help:Reading.html#%D0%A3%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5_%D1%8E%D0%BD%D0%B8%D1%82%D0%B0%D0%BC%D0%B8_systemd" class="mw-redirect" title="Запустите/включите">Запустите/включите</a> службу <code>tor.service</code>. Также можно запустить вручную от имени пользователя <code>tor</code>:
</p>
<pre>[tor]$ /usr/bin/tor
</pre>
<p>Чтобы программа работала через Tor, настройте её использовать <code>127.0.0.1</code> или <code>localhost</code> в качестве SOCKS5-прокси на порте <code>9050</code> (для Tor со стандартными настройками).
</p>
<p>Прокси позволяет удалённо выполнять разрешение доменных имён: используйте <code>socks5<b>h</b>://localhost:9050</code> для отправки DNS-запросов с выходного узла (вместо <code>socks5</code> для локальных запросов).
</p>
<p>Проверить работу Tor можно на странице <a rel="nofollow" class="external free" href="https://check.torproject.org/">https://check.torproject.org/</a>.
</p>
<h2>
<span id=".D0.9D.D0.B0.D1.81.D1.82.D1.80.D0.BE.D0.B9.D0.BA.D0.B0"></span><span class="mw-headline" id="Настройка">Настройка</span>
</h2>
<p>По умолчанию Tor считывает настройки из файла <code>/etc/tor/torrc</code>, а если он отсутствует, то из <code>$HOME/.torrc</code>. Информация о настройках доступна в руководстве <span class="plainlinks archwiki-template-man" title="$ man 1 tor"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/tor.1">tor(1)</a></span>. Настройки по умолчанию должны подходить для большинства пользователей.
</p>
<p>После изменения настроек службу <code>tor.service</code> необходимо <a href="../ru/Help:Reading.html#%D0%A3%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5_%D1%8E%D0%BD%D0%B8%D1%82%D0%B0%D0%BC%D0%B8_systemd" class="mw-redirect" title="Перезагрузите">перезагрузить</a>.
</p>
<h3>
<span id=".D0.9D.D0.B0.D1.81.D1.82.D1.80.D0.BE.D0.B9.D0.BA.D0.B0_Tor_Relay"></span><span class="mw-headline" id="Настройка_Tor_Relay">Настройка Tor Relay</span>
</h3>
<p>Максимальное доступное для Tor количество открытых файловых дескрипторов задаётся параметром <code>LimitNOFILE</code> в файле <code>tor.service</code>. Для быстрых ретрансляторов имеет смысл увеличить это значение.
</p>
<p>Если на вашей системе не запущен веб-сервер и вы не задавали значение <code>AccountingMax</code> (определяет максимальный объём передаваемых данных), рассмотрите возможность установки параметра <code>ORPort</code> в значение <code>443</code> и/или <code>DirPort</code> в значение <code>80</code>. Многие пользователи Tor находятся за жёсткими межсетевыми экранами, которые разрешают им только веб-сёрфинг, и такая настройка позволит им использовать ваш ретранслятор. Если порты <code>80</code> и <code>443</code> уже заняты, то подойдут <code>22</code>, <code>110</code>, <code>143</code> и <code>9001</code> <a rel="nofollow" class="external autonumber" href="https://community.torproject.org/ru/relay/setup/">[1]</a>. Порты с номерами до 1024 являются системными, и для их использования Tor должен быть запущен с привилегиями суперпользователя; задайте параметры <code>User=root</code> в юните <code>tor.service</code> и <code>User tor</code> в файле <code>torrc</code>.
</p>
<p>Также будет полезно глянуть <a rel="nofollow" class="external text" href="https://blog.torproject.org/lifecycle-new-relay/">документацию Tor</a> о жизненном цикле ретрансляторов.
</p>
<h3><span class="mw-headline" id="Tor_ControlPort">Tor ControlPort</span></h3>
<p>Как правило, особой необходимости открывать <i>ControlPort</i> не возникает, но некоторым программам это может потребоваться для получения низкоуровневого доступа к узлу.
</p>
<p>Через открытый ControlPort внешние приложения смогут отслеживать состояние вашего узла, корректировать настройки, а также получать информацию о состоянии сети Tor и виртуальных каналов.
</p>
<p>Добавьте следующую строку в файл <code>torrc</code>:
</p>
<pre>ControlPort 9051
</pre>
<p>Разумеется, доступ к ControlPort должен предоставляться только доверенным пользователям. Ограничение доступа осуществляется либо с помощью cookie-файла, либо паролем, либо обоими способами одновременно.
</p>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Важно:</strong> Предоставляйте пароль или cookie только доверенным процессам и пользователям, поскольку они могут быть использованы для изменения произвольных параметров в настройках службы.</div>
<h4>
<span id="Cookie-.D1.84.D0.B0.D0.B9.D0.BB_Tor_Control"></span><span class="mw-headline" id="Cookie-файл_Tor_Control">Cookie-файл Tor Control</span>
</h4>
<p>Добавьте к файлу <code>torrc</code> следующие строки:
</p>
<pre>CookieAuthentication 1
CookieAuthFile /var/lib/tor/control_auth_cookie
CookieAuthFileGroupReadable 1
DataDirectoryGroupReadable 1
</pre>
<p><a href="../ru/Help:Reading.html#%D0%A3%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5_%D1%8E%D0%BD%D0%B8%D1%82%D0%B0%D0%BC%D0%B8_systemd" class="mw-redirect" title="Перезапустите">Перезапустите</a> службу <code>tor.service</code> для применения изменений.
</p>
<p>Доступ к ControlPort будет ограничен набором файловых разрешений cookie-файла и каталога data.
</p>
<p>Добавьте нужных пользователей в <a href="../ru/Users_and_groups.html#%D0%A3%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5_%D0%B3%D1%80%D1%83%D0%BF%D0%BF%D0%B0%D0%BC%D0%B8" title="Users and groups (Русский)">группу</a> <code>tor</code>, чтобы они получили доступ к cookie-файлу.
</p>
<p>Проверить права доступа можно такой командой:
</p>
<pre>$ stat -c%a /var/lib/tor /var/lib/tor/control_auth_cookie
</pre>
<p>Она должна вывести значения <code>750</code> и <code>640</code>.
</p>
<h4>
<span id=".D0.9F.D0.B0.D1.80.D0.BE.D0.BB.D1.8C_Tor_Control"></span><span class="mw-headline" id="Пароль_Tor_Control">Пароль Tor Control</span>
</h4>
<p>Преобразуйте пароль из представления в виде открытого текста в хэш:
</p>
<pre>$ set +o history                  # отключить историю команд bash
$ tor --hash-password <i>пароль</i>
$ set -o history                  # включить историю команд bash
</pre>
<p>Добавьте этот хэш к файлу <code>torrc</code>:
</p>
<pre>HashedControlPassword <i>хэш</i>
</pre>
<p>Команда <code>set +o history</code> отключает сохранение истории в файл <code>$HISTFILE</code>, чтобы при выполнении команды <code>tor --hash-password</code> в нём не сохранилось значение пароля открытым текстом.
</p>
<h4><span class="mw-headline" id="Tor_ControlSocket">Tor ControlSocket</span></h4>
<p>Tor ControlSocket имеет примерно то же назначение, что и <a href="#Tor_ControlPort">#Tor ControlPort</a>, с той лишь разницей, что прослушивается не TCP-сокет, а <a href="https://en.wikipedia.org/wiki/ru:%D0%A1%D0%BE%D0%BA%D0%B5%D1%82_%D0%B4%D0%BE%D0%BC%D0%B5%D0%BD%D0%B0_Unix" class="extiw" title="wikipedia:ru:Сокет домена Unix">сокет домена</a> Unix.
</p>
<p>Если какой-то программе нужен доступ к Tor ControlSocket, добавьте следующие строки к файлу <code>torrc</code>:
</p>
<pre>ControlSocket /var/lib/tor/control_socket
ControlSocketsGroupWritable 1
DataDirectoryGroupReadable 1
CacheDirectoryGroupReadable 1             # обходное решение для бага #26913
</pre>
<p>Добавьте запускающего программу пользователя <a href="../ru/Users_and_groups.html#%D0%A3%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5_%D0%B3%D1%80%D1%83%D0%BF%D0%BF%D0%B0%D0%BC%D0%B8" title="Users and groups (Русский)">группу</a> <code>tor</code>.
</p>
<p>Затем <a href="../ru/Help:Reading.html#%D0%A3%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5_%D1%8E%D0%BD%D0%B8%D1%82%D0%B0%D0%BC%D0%B8_systemd" class="mw-redirect" title="Перезапустите">перезапустите</a> службу <code>tor.service</code> и саму программу.
</p>
<p>Чтобы проверить права доступа у сокета:
</p>
<pre>$ stat -c%a /var/lib/tor /var/lib/tor/control_socket
</pre>
<p>Команда должна вывести значения <code>750</code> и <code>660</code>.
</p>
<h4>
<span id=".D0.9F.D1.80.D0.BE.D0.B2.D0.B5.D1.80.D0.BA.D0.B0_Tor_Control"></span><span class="mw-headline" id="Проверка_Tor_Control">Проверка Tor Control</span>
</h4>
<p>Чтобы проверить ControlPort, используйте входящую в пакет <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=gnu-netcat">gnu-netcat</a></span> утилиту <i>nc</i>:
</p>
<pre>$ echo -e 'PROTOCOLINFO\r\n' | nc 127.0.0.1 9051
</pre>
<p>Для проверки ControlSocket можно использовать <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=socat">socat</a></span>:
</p>
<pre>$ echo -e 'PROTOCOLINFO\r\n' | socat - UNIX-CLIENT:/var/lib/tor/control_socket
</pre>
<p>Обе команды должны вывести
</p>
<pre>250-PROTOCOLINFO 1
250-AUTH METHODS=COOKIE,SAFECOOKIE,HASHEDPASSWORD COOKIEFILE="/var/lib/tor/control_auth_cookie"
250-VERSION Tor="0.4.8.12"
250 OK
514 Authentication required.
</pre>
<p>Информация о доступных командах есть в документации: <a rel="nofollow" class="external text" href="https://spec.torproject.org/control-spec/commands.html">The Tor Control Protocol</a>.
</p>
<h3>
<span id=".D0.98.D1.81.D0.BF.D0.BE.D0.BB.D1.8C.D0.B7.D0.BE.D0.B2.D0.B0.D0.BD.D0.B8.D0.B5_.D1.81.D0.B8.D1.81.D1.82.D0.B5.D0.BC.D0.BD.D0.BE.D0.B9_.D1.81.D0.BB.D1.83.D0.B6.D0.B1.D1.8B_Tor_.D0.B2_.D0.B1.D1.80.D0.B0.D1.83.D0.B7.D0.B5.D1.80.D0.B5"></span><span class="mw-headline" id="Использование_системной_службы_Tor_в_браузере">Использование системной службы Tor в браузере</span>
</h3>
<p>По умолчанию Tor Browser запускает свой собственный экземпляр Tor, но можно перенастроить его на использование системной службы Tor.
Актуальная инструкция о том, как это сделать, есть в запускающем скрипте, который обычно находится в <code>~/.local/share/torbrowser/tbb/x86_64/tor-browser/Browser/start-tor-browser</code>.
</p>
<p>По состоянию на версию <code>0.3.7</code> действия такие:
</p>
<ol>
<li>В файле <code>/etc/tor/torrc</code> возьмите адрес и порт из настройки <code>SOCKSPort</code>. Если адрес не указан, по умолчанию используется <code>127.0.0.1</code>; если порт не указан, по умолчанию используется <code>9050</code>.</li>
<li>Выполните шаги, описанные в разделах <a href="#Tor_ControlPort">#Tor ControlPort</a> и <a href="#%D0%9F%D0%B0%D1%80%D0%BE%D0%BB%D1%8C_Tor_Control">#Пароль Tor Control</a>, и скопируйте ControlPort и пароль для дальнейшего использования.</li>
<li>В Tor Browser откройте <code>about:config</code> и измените следующие параметры:<pre># ПАРАМЕТР                                 ЗНАЧЕНИЕ
# network.proxy.socks                      &lt;адрес SOCKS&gt;
# network.proxy.socks_port                 &lt;порт SOCKS&gt;
# extensions.torbutton.inserted_button     true
# extensions.torbutton.launch_warning      false
# extensions.torbutton.loglevel            2
# extensions.torbutton.logmethod           0
# extensions.torlauncher.control_port      &lt;ControlPort&gt;
# extensions.torlauncher.loglevel          2
# extensions.torlauncher.logmethod         0
# extensions.torlauncher.prompt_at_startup false
# extensions.torlauncher.start_tor         false</pre>
</li>
<li>В запускающем скрипте, который обычно находится в <code>~/.local/share/torbrowser/tbb/x86_64/tor-browser/Browser/start-tor-browser</code>, найдите и измените строку с паролем, заменив <code>secret</code> на заданный вами пароль Tor Control: <pre>setControlPortPasswd ${TOR_CONTROL_PASSWD:='"secret"'}</pre>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Важно:</strong> Не трогайте кавычки вокруг пароля, они должны быть именно в таком виде — двойные кавычки внутри одинарных кавычек.</div>
</li>
<li>Перезапустите Tor Browser. Если всё хорошо, на странице запуска должно быть сообщение о том, что браузер не контролирует соединение Tor, а в журнале службы <code>tor.service</code> должна появиться строка <code>New control connection opened from <i>адрес</i></code>.</li>
</ol>
<h2>
<span id=".D0.97.D0.B0.D0.BF.D1.83.D1.81.D0.BA_Tor_.D0.B2_chroot"></span><span class="mw-headline" id="Запуск_Tor_в_chroot">Запуск Tor в chroot</span>
</h2>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> Подключение по telnet на локальный ControlPort окажется невозможным, если Tor был запущен в chroot.</div>
<p>Для повышения безопасности вы можете захотеть запускать Tor в <a href="../ru/Chroot.html" title="Chroot (Русский)">chroot</a>. Следующий скрипт создаст подходящее окружение chroot в каталоге <code>/opt/torchroot</code>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">~/torchroot-setup.sh</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">#!/bin/sh
export TORCHROOT=/opt/torchroot

mkdir -p $TORCHROOT
mkdir -p $TORCHROOT/etc/tor
mkdir -p $TORCHROOT/dev
mkdir -p $TORCHROOT/usr/bin
mkdir -p $TORCHROOT/usr/lib
mkdir -p $TORCHROOT/usr/share/tor
mkdir -p $TORCHROOT/var/lib
mkdir -p $TORCHROOT/var/log/tor/

ln -s /usr/lib  $TORCHROOT/lib
cp /etc/hosts           $TORCHROOT/etc/
cp /etc/host.conf       $TORCHROOT/etc/
cp /etc/localtime       $TORCHROOT/etc/
cp /etc/nsswitch.conf   $TORCHROOT/etc/
cp /etc/resolv.conf     $TORCHROOT/etc/

cp /usr/bin/tor         $TORCHROOT/usr/bin/
cp /usr/share/tor/geoip* $TORCHROOT/usr/share/tor/
cp /lib/libnss* /lib/libnsl* /lib/ld-linux-*.so* /lib/libresolv* /lib/libgcc_s.so* $TORCHROOT/usr/lib/
cp $(ldd /usr/bin/tor | awk '{print $3}'|grep --color=never "^/") $TORCHROOT/usr/lib/

### /var/log/tor/notices.log необходим только в том случае, если вы запускаете hidden service
# cp /var/log/tor/notices.log $TORCHROOT/var/log/tor/

cp -r /var/lib/tor      $TORCHROOT/var/lib/
cp /etc/tor/torrc       $TORCHROOT/etc/tor/

chown tor:tor $TORCHROOT
chmod 700 $TORCHROOT
chown -R tor:tor $TORCHROOT/var/lib/tor
chown -R tor:tor $TORCHROOT/var/log/tor

sh -c "grep --color=never ^tor /etc/passwd &gt; $TORCHROOT/etc/passwd"
sh -c "grep --color=never ^tor /etc/group &gt; $TORCHROOT/etc/group"

mknod -m 644 $TORCHROOT/dev/random c 1 8
mknod -m 644 $TORCHROOT/dev/urandom c 1 9
mknod -m 666 $TORCHROOT/dev/null c 1 3

if [ "$(uname -m)" = "x86_64" ]; then
  cp /usr/lib/ld-linux-x86-64.so* $TORCHROOT/usr/lib/.
  ln -sr /usr/lib64 $TORCHROOT/lib64
  ln -s $TORCHROOT/usr/lib ${TORCHROOT}/usr/lib64
fi
</pre>
<p>После выполнения скрипта от пользователя root вы можете запустить Tor в окружении chroot командой:
</p>
<pre># chroot --userspec=tor:tor /opt/torchroot /usr/bin/tor
</pre>
<p>Или, если вы запускаете Tor через systemd, вы можете создать <a href="../ru/Systemd.html#Drop-in_%D1%84%D0%B0%D0%B9%D0%BB%D1%8B" class="mw-redirect" title="Drop-in файл">drop-in файл</a> для службы <code>tor.service</code>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/tor.service.d/chroot.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Service]
User=root
ExecStart=
ExecStart=/usr/bin/sh -c "chroot --userspec=tor:tor /opt/torchroot /usr/bin/tor -f /etc/tor/torrc"
KillSignal=SIGINT</pre>
<h2>
<span id=".D0.97.D0.B0.D0.BF.D1.83.D1.81.D0.BA_Tor_.D0.B2_.D0.BA.D0.BE.D0.BD.D1.82.D0.B5.D0.B9.D0.BD.D0.B5.D1.80.D0.B5_systemd-nspawn"></span><span class="mw-headline" id="Запуск_Tor_в_контейнере_systemd-nspawn">Запуск Tor в контейнере systemd-nspawn</span>
</h2>
<p>В этом примере мы создадим контейнер <a href="../en/Systemd-nspawn.html" class="mw-redirect" title="Systemd-nspawn (Русский)">systemd-nspawn</a> с виртуальным сетевым macvlan-интерфейсом. Контейнер будет называться <code>tor-exit</code>.
</p>
<p>В статьях <a href="../en/Systemd-nspawn.html" title="Systemd-nspawn">systemd-nspawn</a> и <a href="../ru/Systemd-networkd.html" title="Systemd-networkd (Русский)">systemd-networkd</a> можно найти полную информацию о работе и настройке соответствующих программ.
</p>
<h3>
<span id=".D0.A3.D1.81.D1.82.D0.B0.D0.BD.D0.BE.D0.B2.D0.BA.D0.B0_.D0.B8_.D0.BD.D0.B0.D1.81.D1.82.D1.80.D0.BE.D0.B9.D0.BA.D0.B0_.D1.85.D0.BE.D1.81.D1.82.D0.B0"></span><span class="mw-headline" id="Установка_и_настройка_хоста">Установка и настройка хоста</span>
</h3>
<p>Контейнер будет размещаться в каталоге <code>/srv/container</code>:
</p>
<pre># mkdir -p /srv/container/tor-exit
</pre>
<p><a href="../ru/Help:Reading.html#%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0_%D0%BF%D0%B0%D0%BA%D0%B5%D1%82%D0%BE%D0%B2" class="mw-redirect" title="Установите">Установите</a> пакет <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=arch-install-scripts">arch-install-scripts</a></span>, чтобы получить доступ к утилите <i>pacstrap</i>.
</p>
<p>С помощью <i>pacstrap</i> установите в каталог контейнера пакеты <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=base">base</a></span>, <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=tor">tor</a></span> и <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=nyx">nyx</a></span> (подробнее см. статью об <a href="../en/Systemd-nspawn.html#Create_and_boot_a_minimal_Arch_Linux_container" title="Systemd-nspawn">установке Arch Linux в контейнер</a>):
</p>
<pre># pacstrap -K -сi /srv/container/tor-exit base tor nyx
</pre>
<p>Если зарегистрировать контейнер на хосте, то в дальнейшем с ним можно будет взаимодействовать извне с помощью команды <code>machinectl</code>. Для этого необходимо создать символическую ссылку на контейнер в каталоге <code>/var/lib/container/</code>. Создайте каталог, если он отсутствует:
</p>
<pre># mkdir -p /var/lib/container
</pre>
<p>и поместите в него символическую ссылку на контейнер (см. <a href="../en/Systemd-nspawn.html#Management" title="Systemd-nspawn">systemd-nspawn#Management</a>):
</p>
<pre># ln -s /srv/container/tor-exit /var/lib/container/tor-exit
</pre>
<h4>
<span id=".D0.92.D0.B8.D1.80.D1.82.D1.83.D0.B0.D0.BB.D1.8C.D0.BD.D1.8B.D0.B9_.D1.81.D0.B5.D1.82.D0.B5.D0.B2.D0.BE.D0.B9_.D0.B8.D0.BD.D1.82.D0.B5.D1.80.D1.84.D0.B5.D0.B9.D1.81"></span><span class="mw-headline" id="Виртуальный_сетевой_интерфейс">Виртуальный сетевой интерфейс</span>
</h4>
<p>Создайте drop-in-файл настроек контейнера:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/nspawn/tor-exit.nspawn</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Service]
MACVLAN=<i>интерфейс</i>

[Exec]
LimitNOFILE=65536</pre>
<p>Опция <code>MACVLAN=<i>интерфейс</i></code> создаёт macvlan-интерфейс с названием <code>mv-<i>интерфейс</i></code> и привязывает его к контейнеру, подробнее см. <a href='../en/Systemd-nspawn.html#Use_a_"macvlan"_or_"ipvlan"_interface' title="Systemd-nspawn">systemd-nspawn#Use a "macvlan" or "ipvlan" interface</a>. Это полезно с точки зрения безопасности, поскольку контейнеру можно назначить приватный IP-адрес, а настоящий адрес машины из контейнера виден не будет. Так можно, например, скрыть DNS-запросы.
</p>
<p>Опция <code>LimitNOFILE=65536</code> позволит открывать большее <a href="#%D0%9A%D0%BE%D0%BB%D0%B8%D1%87%D0%B5%D1%81%D1%82%D0%B2%D0%BE_%D1%81%D0%BE%D0%B5%D0%B4%D0%B8%D0%BD%D0%B5%D0%BD%D0%B8%D0%B9">#Количество соединений</a> одновременно.
</p>
<p>Наконец, сохраните сетевые настройки <a href="../ru/Systemd-networkd.html" title="Systemd-networkd (Русский)">systemd-networkd</a> в файле <code>/srv/container/tor-exit/etc/systemd/network/mv-<i>интерфейс</i>.network</code>.
</p>
<h4>
<span id=".D0.97.D0.B0.D0.BF.D1.83.D1.81.D0.BA_.D0.B8_.D0.B2.D0.BA.D0.BB.D1.8E.D1.87.D0.B5.D0.BD.D0.B8.D0.B5_systemd-nspawn"></span><span class="mw-headline" id="Запуск_и_включение_systemd-nspawn">Запуск и включение systemd-nspawn</span>
</h4>
<p><a href="../ru/Help:Reading.html#%D0%A3%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5_%D1%8E%D0%BD%D0%B8%D1%82%D0%B0%D0%BC%D0%B8_systemd" class="mw-redirect" title="Запустите/включите">Запустите/включите</a> службу <code>systemd-nspawn@tor-exit.service</code>.
</p>
<h3>
<span id=".D0.9D.D0.B0.D1.81.D1.82.D1.80.D0.BE.D0.B9.D0.BA.D0.B0_.D0.BA.D0.BE.D0.BD.D1.82.D0.B5.D0.B9.D0.BD.D0.B5.D1.80.D0.B0"></span><span class="mw-headline" id="Настройка_контейнера">Настройка контейнера</span>
</h3>
<p>Чтобы войти в контейнер, выполните (см. <a href="../en/Systemd-nspawn.html#machinectl" title="Systemd-nspawn">systemd-nspawn#machinectl</a>):
</p>
<pre># machinectl login tor-exit
</pre>
<h4>
<span id=".D0.97.D0.B0.D0.BF.D1.83.D1.81.D0.BA_.D0.B8_.D0.B2.D0.BA.D0.BB.D1.8E.D1.87.D0.B5.D0.BD.D0.B8.D0.B5_systemd-networkd"></span><span class="mw-headline" id="Запуск_и_включение_systemd-networkd">Запуск и включение systemd-networkd</span>
</h4>
<p><a href="../ru/Help:Reading.html#%D0%A3%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5_%D1%8E%D0%BD%D0%B8%D1%82%D0%B0%D0%BC%D0%B8_systemd" class="mw-redirect" title="Запустите/включите">Запустите/включите</a> службу <code>systemd-networkd.service</code>. Команда <code>networkctl</code> отобразит список сетевых интерфейсов контейнера, если <code>systemd-networkd</code> настроен корректно.
</p>
<h3>
<span id=".D0.9D.D0.B0.D1.81.D1.82.D1.80.D0.BE.D0.B9.D0.BA.D0.B0_Tor"></span><span class="mw-headline" id="Настройка_Tor">Настройка Tor</span>
</h3>
<p>Смотрите раздел <a href="#%D0%97%D0%B0%D0%BF%D1%83%D1%81%D0%BA_%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80%D0%B0_Tor">#Запуск сервера Tor</a>.
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Совет:</strong> Файлы контейнера удобнее редактировать с хоста вашим любимым редактором.</div>
<h2>
<span id=".D0.92.D0.B5.D0.B1-.D1.81.D1.91.D1.80.D1.84.D0.B8.D0.BD.D0.B3"></span><span class="mw-headline" id="Веб-сёрфинг">Веб-сёрфинг</span>
</h2>
<p>Единственный способ оставаться анонимным при просмотре страниц в интернете — использовать <i>Tor Browser Bundle</i>, который использует пропатченную версию <a href="../ru/Firefox.html" title="Firefox (Русский)">Firefox</a>. Его можно установить с помощью пакета <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=torbrowser-launcher">torbrowser-launcher</a></span>.
</p>
<p>Также можно использовать Tor с обычными браузерами: в разделах <a href="#Firefox">#Firefox</a> и <a href="#Chromium">#Chromium</a> объясняется, как настроить их на работу через Tor. Обратите внимание, что даже в режиме приватного просмотра это не гарантирует анонимности: <a rel="nofollow" class="external text" href="https://support.torproject.org/ru/glossary/browser-fingerprinting/">отпечатки</a>, плагины, DNS-утечки и прочие недочёты могут привести к раскрытию вашего IP-адреса или личности <a rel="nofollow" class="external autonumber" href="https://support.torproject.org/ru/#tbb_tbb-9">[2]</a>.
</p>
<h3><span class="mw-headline" id="Firefox">Firefox</span></h3>
<p><i>Настройки &gt; Основные &gt; Настройки сети &gt; Настроить...</i>, выберите пункт <i>Ручная настройка прокси</i>, после чего укажите узел SOCKS <code>localhost</code> на порте <code>9050</code> (SOCKS v5). Чтобы перенаправить все DNS-запросы в сеть Tor, выберите пункт <i>Отправлять DNS-запросы через прокси при использовании SOCKS 5</i>.
</p>
<h3><span class="mw-headline" id="Chromium">Chromium</span></h3>
<p>Запустите Chromium с такими параметрами:
</p>
<pre>$ chromium --proxy-server="socks5://<i>мой-прокси</i>:8080" --host-resolver-rules="MAP * ~NOTFOUND , EXCLUDE <i>мой-прокси</i>"
</pre>
<p>Флаг <code>--proxy-server="socks5://<i>мой-прокси</i>:8080"</code> означает, что все <code>http://</code> и <code>https://</code> запросы будут посылаться через прокси-сервер <code>"<i>мой-прокси</i>:8080"</code> посредством протокола SOCKS пятой версии. Разрешение имён для этих запросов будет выполняться прокси-сервером, а не браузером локально.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> Проксирование <code>ftp://</code> через SOCKS-прокси на данный момент не реализовано <a rel="nofollow" class="external autonumber" href="https://www.chromium.org/developers/design-documents/network-stack/socks-proxy">[3]</a>.</div>
<p>Флаг <code>--proxy-server</code> влияет только на загрузку URL-страниц. Однако в Chromium есть и другие компоненты, которые могут попытаться выполнить DNS-разрешение напрямую. Наиболее важный их этих компонентов — <i>DNS-prefetcher</i>. Если DNS-prefetcher не отключён, то браузер будет посылать DNS-запросы напрямую, минуя SOCKS5-сервер. Prefetcher и другие компоненты можно отключить, но такой подход неудобен и ненадёжен, поскольку придётся отслеживать каждый элемент Chromium, который может захотеть посылать DNS-запросы самостоятельно.
</p>
<p>Для комплексного решения этой проблемы используется флаг <code>--host-resolver-rules="MAP * ~NOTFOUND , EXCLUDE <i>мой-прокси</i>"</code>, который представляет собой ловушку для посылаемых через обычную сеть DNS-запросов. Каждое выполняемое локально разрешение DNS теперь будет привязано к (нерабочему) адресу <code>~NOTFOUND</code> (можно представить его как адрес <code>0.0.0.0</code>). Указание <code>"EXCLUDE"</code> создаёт исключение для прокси-сервера <code>"<i>мой-прокси</i>"</code>, потому что без этого Chromium не сможет выполнять разрешение адреса самого́ прокси-сервера SOCKS и все запросы будут завершаться неудачей с ответом <code>PROXY_CONNECTION_FAILED</code>.
</p>
<p>Также, чтобы предотвратить <a rel="nofollow" class="external text" href="https://ipleak.net/#webrtcleak">утечки WebRTC</a>, можно установить расширение браузера <a rel="nofollow" class="external text" href="https://chrome.google.com/webstore/detail/webrtc-network-limiter/npeicpdbkakmehahjeeohfdhnlpdklia">WebRTC Network Limiter</a>.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> Для приложений <a href="https://en.wikipedia.org/wiki/ru:Electron_(%D1%84%D1%80%D0%B5%D0%B9%D0%BC%D0%B2%D0%BE%D1%80%D0%BA)" class="extiw" title="wikipedia:ru:Electron (фреймворк)">Electron</a> флаг <code>--host-resolver-rules</code> указывать не нужно.</div>
<h4>
<span id=".D0.9E.D1.82.D0.BB.D0.B0.D0.B4.D0.BA.D0.B0"></span><span class="mw-headline" id="Отладка">Отладка</span>
</h4>
<p>В случае возникновения каких-либо проблем в первую очередь нужно проверить настройки прокси, введя адрес <code>chrome://net-internals/#proxy</code>.
</p>
<p>Затем нужно изучить вкладку настроек DNS, чтобы убедиться, что Chromium не выполняет локальное разрешение DNS: <code>chrome://net-internals/#dns</code>.
</p>
<h4>
<span id=".D0.A0.D0.B0.D1.81.D1.88.D0.B8.D1.80.D0.B5.D0.BD.D0.B8.D1.8F"></span><span class="mw-headline" id="Расширения">Расширения</span>
</h4>
<p>Как и для Firefox, вы можете установить удобный переключатель прокси вроде <a rel="nofollow" class="external text" href="https://chrome.google.com/webstore/detail/dpplabbmogkhghncfbfdeeokoefdjegm">Proxy SwitchySharp</a>.
</p>
<p>После установки перейдите на его панель настроек. Под вкладкой <i>Proxy Profiles</i> добавьте новый профиль <i>Tor</i>, уберите отметку с опции <i>Use the same proxy server for all protocols</i>, затем добавьте <i>localhost</i> в качестве хоста SOCKS, порт <i>9050</i>, и выберите <i>SOCKS v5</i>.
</p>
<p>При желании можно включить опцию быстрого переключения на вкладке настроек <i>General</i>. Тогда переключаться между нормальной навигацией и сетью Tor можно будет одним кликом на иконке Proxy SwitchySharp.
</p>
<h4><span class="mw-headline" id="Electron">Electron</span></h4>
<p>Смотрите <a href="#Chromium">#Chromium</a>.
</p>
<h3><span class="mw-headline" id="Luakit">Luakit</span></h3>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> Вас будет легко опознать по редкой строке <code>user-agent</code>; также могут возникнуть проблемы с Flash, JavaScript и т.д.</div>
<p>Выполните:
</p>
<pre>$ torsocks luakit
</pre>
<h2>
<span id="HTTP-.D0.BF.D1.80.D0.BE.D0.BA.D1.81.D0.B8"></span><span class="mw-headline" id="HTTP-прокси">HTTP-прокси</span>
</h2>
<p>В Tor можно работать через встроенный туннелированный HTTP-прокси или сторонний прокси вроде <a href="../en/Privoxy.html" title="Privoxy">Privoxy</a>. Тем не менее, разработчики Tor рекомендуют использовать библиотеку SOCKS5, если ваш браузер её поддерживает.
</p>
<h3><span class="mw-headline" id="Tor">Tor</span></h3>
<p>Добавьте следующую строку в файл <code>torrc</code>, чтобы запустить HTTP-прокси на порте <code>8118</code> на <code>localhost</code>:
</p>
<pre>HTTPTunnelPort 127.0.0.1:8118
</pre>
<p>Подробнее смотрите <a rel="nofollow" class="external text" href="https://2019.www.torproject.org/docs/tor-manual.html.en#HTTPTunnelPort">руководство Tor</a>.
</p>
<h3><span class="mw-headline" id="Firefox_2">Firefox</span></h3>
<p>Расширение браузера <a rel="nofollow" class="external text" href="https://addons.mozilla.org/firefox/addon/foxyproxy-standard/">FoxyProxy</a> позволяет назначить несколько прокси-серверов как для всех HTTP-запросов в целом, так и для отдельных сайтов. После установки расширения перезапустите браузер и вручную настройте использование прокси по адресу <code>localhost:8118</code>, где должен работать <a href="../en/Privoxy.html" title="Privoxy">Privoxy</a>. Эти настройки находятся в меню <i>Add &gt; Standard proxy type</i>. Выберите метку прокси-сервера (например, <code>Tor</code>) и введите хост и порт в поля <i>HTTP Proxy</i> и <i>SSL Proxy</i>. Для проверки правильности работы Tor посетите страницу <a rel="nofollow" class="external text" href="https://check.torproject.org/">Tor Check</a>.
</p>
<h3><span class="mw-headline" id="Privoxy">Privoxy</span></h3>
<p>Privoxy также можно использовать с другими приложениями, например мессенджерами (<a href="../en/List_of_applications/Internet.html#XMPP_clients" class="mw-redirect" title="Jabber">Jabber</a>, <a href="../en/Arch_IRC_channels.html" class="mw-redirect" title="IRC">IRC</a>). Приложения, которые поддерживают HTTP-прокси, можно подключить к Privoxy (то есть на адрес <code>127.0.0.1:8118</code>). Чтобы использовать SOCKS-прокси напрямую, направьте ваше приложение в Tor (адрес по умолчанию <code>127.0.0.1:9050</code>). Следует иметь в виду, что приложение может самостоятельно выполнять DNS-разрешение, что приведёт к утечке информации. В этом случае можно попробовать использовать SOCKS4A (например, с Privoxy).
</p>
<h2>
<span id=".D0.9E.D0.B1.D0.BC.D0.B5.D0.BD_.D0.BC.D0.B3.D0.BD.D0.BE.D0.B2.D0.B5.D0.BD.D0.BD.D1.8B.D0.BC.D0.B8_.D1.81.D0.BE.D0.BE.D0.B1.D1.89.D0.B5.D0.BD.D0.B8.D1.8F.D0.BC.D0.B8"></span><span class="mw-headline" id="Обмен_мгновенными_сообщениями">Обмен мгновенными сообщениями</span>
</h2>
<p>Для использования мессенджера через Tor не нужен HTTP-прокси вроде <a href="../en/Privoxy.html" title="Privoxy">Privoxy</a>. Мы используем напрямую демон Tor, по умолчанию прослушивающий порт 9050.
</p>
<h3><span class="mw-headline" id="Pidgin">Pidgin</span></h3>
<p><a href="../en/Pidgin.html" class="mw-redirect" title="Pidgin (Русский)">Pidgin</a> можно настроить на работу через Tor глобально или для отдельных аккаунтов. Для глобальных настроек используйте пункт меню <i>Средства -&gt; Настройки -&gt; Прокси</i>. Чтобы настроить использование Tor для одного аккаунта, перейдите в <i>Уч.записи &gt; Управление учётными записями</i>, выберите нужный аккаунт, нажмите <i>Изменить</i>, после чего на вкладке <i>Прокси</i> укажите следующие параметры:
</p>
<ul>
<li>Тип прокси: SOCKS 5</li>
<li>Узел: 127.0.0.1</li>
<li>Порт: 9050</li>
</ul>
<h3><span class="mw-headline" id="Irssi">Irssi</span></h3>
<div class="noprint archwiki-template-message">
<p><span class="mw-default-size" typeof="mw:File"><span><img src="../File:View-refresh-red.svg" decoding="async" width="48" height="48" class="mw-file-element"></span></span><b>This article or section is out of date.</b></p>
<div>
<b>Reason:</b> <code>cap_sasl.pl</code> сломался с обновлением <i>perl</i> 5.20; кроме того, SSL не работает с <code>torsocks</code>. (Discuss in <a rel="nofollow" class="external text" href="../ru/Talk:Tor.html">Talk:Tor (Русский)</a>)</div>
</div>
<p>Libera Chat рекомендует подключаться напрямую к <code>.onion</code>. Для этого также потребуется SASL для идентификации NickServ в процессе соединения; подробности можно найти в статье <a href="../en/Irssi.html#Authenticating_with_SASL" title="Irssi">Irssi#Authenticating with SASL</a>. Запустите irssi:
</p>
<pre>$ torsocks irssi
</pre>
<p>Задайте ваши идентификационные данные для сервиса <a href="https://en.wikipedia.org/wiki/ru:IRC-%D1%81%D0%B5%D1%80%D0%B2%D0%B8%D1%81%D1%8B" class="extiw" title="wikipedia:ru:IRC-сервисы">nickserv</a>, которые будут считываться при создании соединения. Поддерживаются механизмы аутентификации ECDSA-NIST256P-CHALLENGE (см. <a rel="nofollow" class="external text" href="https://github.com/kaniini/ecdsatool/blob/master/example-for-cap_sasl.pl">ecdsatool</a>) и PLAIN. DH-BLOWFISH больше <a rel="nofollow" class="external text" href="https://libera.chat/guides/sasl">не поддерживается</a>.
</p>
<pre>/sasl set <i>сеть</i> <i>имя-пользователя</i> <i>пароль</i> <i>механизм</i>
</pre>
<p>Отключите CTCP и DCC и задайте фальшивое имя хоста, чтобы скрыть настоящее: <a rel="nofollow" class="external autonumber" href="https://web.archive.org/web/20160123165938/https://encrypteverything.ca/IRC_Anonymity_Guide">[4]</a>
</p>
<pre>/ignore * CTCPS
/ignore * DCC
/set hostname <i>фальшивый_хост</i>
</pre>
<p>Подключитесь к Libera Chat:
</p>
<pre>/connect -network <i>network</i> libera75jm6of4wxpxt4aynol3xjmbtxgfyjpu34ss4d7r7q2v5zrpyd.onion
</pre>
<p>Дополнительную информацию можно найти в статьях <a rel="nofollow" class="external text" href="https://libera.chat/guides/connect#accessing-liberachat-via-tor">Accessing Libera.Chat Via Tor</a>, <a rel="nofollow" class="external text" href="https://libera.chat/guides/sasl">Using SASL</a> и <a rel="nofollow" class="external text" href="https://trac.torproject.org/projects/tor/wiki/doc/TorifyHOWTO/IrcSilc">IRC/SILC Wiki article</a>.
</p>
<h2><span class="mw-headline" id="Pacman">Pacman</span></h2>
<p>Через сеть Tor можно выполнять загрузочные операции <a href="../ru/Pacman.html" title="Pacman (Русский)">pacman</a> — синхронизировать базы данных репозиториев, скачивать пакеты и открытые ключи.
</p>
<p>Преимущества:
</p>
<ul>
<li>Если кто-то отслеживает интернет-соединение вашей машины, то он не увидит выполняемые обновления. Соответственно, нельзя будет определить, какие пакеты установлены, какие из них устарели и как часто выполняется обновление. Но следует учитывать, что атакующий всё ещё может опознать используемое программное обеспечение и узнать его версию другими способами. Например, проанализировав исходящие пакеты вашего HTTP-сервера и просканировав его порт, можно будет определить наличие работающего HTTP-сервера и его версию.</li>
<li>Если зеркало для скачивания находится не в onion-домене, то скомпрометированный выходной узел может обнаружить попытку обновления и решить атаковать вашу машину. Однако при этом атакующий скорее всего не будет знать, какую именно машину он атакует.</li>
<li>Атакующий может попытаться убедить вашу машину, что доступных обновлений нет, чтобы не позволить применить обновления безопасности. При обновлении через Tor сделать это будет крайне непросто, поскольку в анонимной сети почти невозможно определить конкретно вашу машину.</li>
</ul>
<p>Недостатки:
</p>
<ul><li>Более длительное время обновления из-за высокого значения задержки и низкой пропускной способности сети Tor. Это может быть значительным недостатком с точки зрения безопасности, если обновление нужно выполнить как можно быстрее, особенно на машинах, подключённых напрямую к интернету. Например, если уязвимость серьёзная и её легко обнаружить и использовать, то злоумышленники часто стараются атаковать как можно больше уязвимых систем максимально быстро, чтобы успеть до применения обновлений безопасности.</li></ul>
<p>Надёжность обновлений через Tor:
</p>
<ul>
<li>Не нужно полагаться на работоспособность DNS.</li>
<li>Вы зависите от состояния сети Tor и особенно выходных узлов (например, они могут блокировать обновления).</li>
<li>Вы зависите от правильной работы демона Tor. Например, если на диске закончилось свободное место, то демон Tor может отказаться работать. «Reserved blocks gid» в ext4, квоты на использование дискового пространства и некоторые другие меры помогут решить эту проблему.</li>
<li>Если вы находитесь в стране, где Tor блокируется или в которой почти или совсем нет пользователей Tor, то вам придётся использовать мост (Tor bridge).</li>
</ul>
<p>Замечание по поводу GPG: по умолчанию pacman считает надёжными только те ключи, которые подписаны либо лично вами (делается командой <code>pacman-key --lsign-key</code>), либо тремя из пяти мастер-ключей Arch. Если вредоносный выходной узел попробует заменить пакет на другой, подписанный его ключом, pacman не позволит пользователю установить такой пакет.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> Для других дистрибутивов на основе Arch, а также неофициальных репозиториев и AUR это утверждение может оказаться неверным.</div>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/pacman.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">...
XferCommand = /usr/bin/curl --socks5-hostname localhost:9050 --location --continue-at - --fail --output %o %u
...</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> Во время обработки подписей баз данных иногда можно получить ошибку 404. Это зависит от <a href="../ru/Pacman/Package_signing.html#%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0_pacman" class="mw-redirect" title="Pacman/Подпись пакета">настроек pacman</a> и как правило безвредно.
</div>
<h2><span class="mw-headline" id="Java">Java</span></h2>
<p>Чтобы заставить приложение Java <a rel="nofollow" class="external text" href="https://docs.oracle.com/javase/8/docs/technotes/guides/net/proxies.html">проксировать</a> все соединения через Tor, задайте следующую опцию командной строки:
</p>
<pre>export JAVA_OPTIONS="$JAVA_OPTIONS -DsocksProxyHost=localhost -DsocksProxyPort=9050"
</pre>
<h2>
<span id=".D0.97.D0.B0.D0.BF.D1.83.D1.81.D0.BA_.D1.81.D0.B5.D1.80.D0.B2.D0.B5.D1.80.D0.B0_Tor"></span><span class="mw-headline" id="Запуск_сервера_Tor">Запуск сервера Tor</span>
</h2>
<p>Сеть Tor существует благодаря пользователям, которые создают и обслуживают узлы сети, предоставляют свою пропускную способность и запускают onion-сервисы. Есть несколько способов внести свой вклад в работу сети.
</p>
<h3>
<span id=".D0.9C.D0.BE.D1.81.D1.82"></span><span class="mw-headline" id="Мост">Мост</span>
</h3>
<p>Мост Tor (Tor bridge) — передающий узел сети, адрес которого не содержится в открытом каталоге узлов Tor. Благодаря этому мосты могут остаться доступны для желающих подключиться к Tor, даже если правительство или интернет-провайдер блокирует все публичные узлы Tor. На странице <a rel="nofollow" class="external free" href="https://bridges.torproject.org/">https://bridges.torproject.org/</a> объясняется, как узнать адреса мостов.
</p>
<p>Для запуска моста достаточно следующих четырёх строк в файле <code>torrc</code>:
</p>
<pre>SOCKSPort 0
ORPort 443
BridgeRelay 1
ExitRelay 0
</pre>
<p>Смотрите также <a rel="nofollow" class="external text" href="https://2019.www.torproject.org/docs/bridges#RunningABridge">Running a Tor Bridge</a> и <a rel="nofollow" class="external text" href="https://community.torproject.org/ru/relay/setup/bridge/archlinux/">пример запуска моста с obfs4</a>.
</p>
<h3>
<span id=".D0.9F.D0.B5.D1.80.D0.B5.D0.B4.D0.B0.D1.8E.D1.89.D0.B8.D0.B9_.D1.83.D0.B7.D0.B5.D0.BB"></span><span class="mw-headline" id="Передающий_узел">Передающий узел</span>
</h3>
<p>В режиме передатчика (relay) ваша машина будет работать в качестве входного (entry node) или промежуточного (forwarding relay) узла сети. В отличие от моста, адрес передающей машины будет опубликован в каталоге узлов Tor. Задача передающего узла заключается в пересылке пакетов к другим передатчикам или выходным узлам, но не напрямую в интернет.
</p>
<p>Файл настроек передающего узла с пропускной способностью не менее 20 Кбит/с должен выглядеть так:
</p>
<pre>Nickname <i>название-узла-Tor</i>
ORPort 9001                    # Этот TCP-порт должен быть открыт или проброшен в вашем сетевом экране
BandwidthRate 20 KB            # Ограничить скорость передачи величиной 20 Kбит/с
BandwidthBurst 50 KB           # Но разрешить пиковые значения до 50 Kбит/с
ExitRelay 0                    # Запретить отправку пакетов в обычную сеть
</pre>
<h3>
<span id=".D0.92.D1.8B.D1.85.D0.BE.D0.B4.D0.BD.D0.BE.D0.B9_.D1.83.D0.B7.D0.B5.D0.BB"></span><span class="mw-headline" id="Выходной_узел">Выходной узел</span>
</h3>
<p>Чтобы запрос из сети Tor попал в обычный интернет, необходим выходной узел (exit relay). Важно понимать, что кто бы ни посылал запрос, для получателя всё будет выглядеть так, будто отправителем является именно выходной узел. Поэтому запуск выходного узла считается наименее безопасным в плане возможных проблем с законом. Если вы размышляете над его запуском, то стоит изучить <a rel="nofollow" class="external text" href="https://blog.torproject.org/tips-running-exit-node/">советы и рекомендации</a> от создателей проекта.
</p>
<h4>
<span id=".D0.9D.D0.B0.D1.81.D1.82.D1.80.D0.BE.D0.B9.D0.BA.D0.B0_2"></span><span class="mw-headline" id="Настройка_2">Настройка</span>
</h4>
<p>В файле <code>torrc</code> можно настроить перечень разрешённых на выходном узле сервисов.
</p>
<p>Сделать узел выходным:
</p>
<pre>ExitRelay 1
</pre>
<p>Разрешить весь трафик:
</p>
<pre>ExitPolicy accept *:*
</pre>
<p>Разрешить только соединения через IRC-порты 6660-6667 и запретить всё остальное:
</p>
<pre>ExitPolicy accept *:6660-6667,reject *:*
</pre>
<p>По умолчанию Tor настроен блокировать определённые порты. В файле <code>torrc</code> можно внести корректировки в этот список. Пример разрешения порта NNTP:
</p>
<pre>ExitPolicy accept *:119
</pre>
<h4>
<span id=".D0.9F.D1.80.D0.B8.D0.BC.D0.B5.D1.80_.D0.BD.D0.B0.D1.81.D1.82.D1.80.D0.BE.D0.B9.D0.BA.D0.B8_100-.D0.BC.D0.B5.D0.B3.D0.B0.D0.B1.D0.B8.D1.82.D0.BD.D0.BE.D0.B3.D0.BE_.D0.B2.D1.8B.D1.85.D0.BE.D0.B4.D0.BD.D0.BE.D0.B3.D0.BE_.D1.83.D0.B7.D0.BB.D0.B0"></span><span class="mw-headline" id="Пример_настройки_100-мегабитного_выходного_узла">Пример настройки 100-мегабитного выходного узла</span>
</h4>
<p>Если у вас скоростной выходной узел (более 100 Мбит/с) с <code>ORPort 443</code> и <code>DirPort 80</code>, вам могут пригодиться следующие рекомендации по настройке Tor вместе с межсетевым экраном <a href="../ru/Iptables.html" title="Iptables (Русский)">iptables</a> и DNS-кэшем <a href="../en/Pdnsd.html" title="Pdnsd">pdnsd</a>. Настоятельно рекомендуется <i>предварительно</i> изучить статью <a rel="nofollow" class="external text" href="https://community.torproject.org/ru/relay/setup/post-install/">Пост-установка и советы по обслуживанию</a>.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> В разделе <a href="#%D0%97%D0%B0%D0%BF%D1%83%D1%81%D0%BA_Tor_%D0%B2_%D0%BA%D0%BE%D0%BD%D1%82%D0%B5%D0%B9%D0%BD%D0%B5%D1%80%D0%B5_systemd-nspawn">#Запуск Tor в контейнере systemd-nspawn</a> описана установка Tor в контейнер <code>systemd-nspawn</code>.</div>
<h5><span class="mw-headline" id="Tor_2">Tor</span></h5>
<h6>
<span id=".D0.9A.D0.BE.D0.BB.D0.B8.D1.87.D0.B5.D1.81.D1.82.D0.B2.D0.BE_.D1.81.D0.BE.D0.B5.D0.B4.D0.B8.D0.BD.D0.B5.D0.BD.D0.B8.D0.B9"></span><span class="mw-headline" id="Количество_соединений">Количество соединений</span>
</h6>
<p>По умолчанию Tor может обрабатывать до 8192 соединений одновременно. Можно увеличить это значение <a rel="nofollow" class="external autonumber" href="https://support.torproject.org/ru/#relay-operators_packaged-tor">[5]</a>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/tor.service.d/increase-file-limits.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Service]
LimitNOFILE=65536</pre>
<p>Чтобы увеличение лимита сработало, вам также может понадобиться добавить следующие строки:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/security/limits.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">...
tor     soft    nofile    65536
tor     hard    nofile    65536
@tor    soft    nofile    65536
@tor    hard    nofile    65536
</pre>
<p>Чтобы узнать текущее значение <code>nofile</code>, выполните команду <code>ulimit -Hn</code> от имени пользователя <code>tor</code>.
</p>
<h6>
<span id=".D0.9F.D1.80.D0.B8.D0.B2.D0.B8.D0.BB.D0.B5.D0.B3.D0.B8.D1.80.D0.BE.D0.B2.D0.B0.D0.BD.D0.BD.D1.8B.D0.B5_.D0.BF.D0.BE.D1.80.D1.82.D1.8B"></span><span class="mw-headline" id="Привилегированные_порты">Привилегированные порты</span>
</h6>
<p>Чтобы разрешить Tor использовать привилегированные порты, службу <code>tor.service</code> нужно запускать от root. Не забудьте также добавить параметр <code>User tor</code> в файле <code>/etc/tor/torrc</code>, чтобы понизить привилегии после запуска.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/tor.service.d/start-as-root.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Service]
User=root</pre>
<h6>
<span id=".D0.9A.D0.BE.D0.BD.D1.84.D0.B8.D0.B3.D1.83.D1.80.D0.B0.D1.86.D0.B8.D1.8F"></span><span class="mw-headline" id="Конфигурация">Конфигурация</span>
</h6>
<p>Образец файла настроек выходного узла Tor:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/tor/torrc</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">SOCKSPort 0                                       ## Только узел, без запуска локального прокси-сервера SOCKS

Log notice stdout                                 ## Стандартное поведение Tor

ControlPort 9051                                  ## Для соединения nyx
CookieAuthentication 1                            ## Для соединения nyx

ORPort 443                                        ## Служба tor.service должна быть запущена от root

Address $IP                                       ## IP-адрес или FQDN
Nickname $NICKNAME                                ## Название узла, отображаемое в <a rel="nofollow" class="external text" href="https://metrics.torproject.org/rs.html">Tor Relay Search</a>

RelayBandwidthRate 500 Mbits                      ## bytes/KBytes/MBytes/GBytes/KBits/MBits/GBits
RelayBandwidthBurst 1000 MBits                    ## bytes/KBytes/MBytes/GBytes/KBits/MBits/GBits

ContactInfo $E-MAIL                               ## <a rel="nofollow" class="external text" href="https://gitlab.torproject.org/tpo/community/relays/-/issues/18">Tor Relay good practices</a> предлагает указать email

DirPort 80                                        ## Служба tor.service должна быть запущена от root
DirPortFrontPage /etc/tor/tor-exit-notice.html    ## <a rel="nofollow" class="external text" href="https://gitlab.torproject.org/tpo/core/tor/-/raw/main/contrib/operator-tools/tor-exit-notice.html">Оригинал</a>

MyFamily $($KEYID),$($KEYID)...                   ## Не забудьте знак $ перед keyid ;)

ExitPolicy reject XXX.XXX.XXX.XXX/XX:*            ## Заблокировать отдельный домен или IP-адрес в дополнение к стандартной политике

User tor                                          ## Изменяет пользователя на tor после запуска от root

DisableDebuggerAttachment 0                       ## Для соединения nyx

### Производительность ###
AvoidDiskWrites 1                                 ## Уменьшение износа SSD
DisableAllSwap 1                                  ## Служба tor.service должна быть запущена от root
HardwareAccel 1                                   ## Использование аппаратной поддержки OpenSSL
NumCPUs 2                                         ## Запуск в двух потоках</pre>
<p>Информацию об использованных здесь опциях можно найти в <span class="plainlinks archwiki-template-man" title="$ man 1 tor"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/tor.1">tor(1)</a></span>.
</p>
<p>Tor по умолчанию запускает SOCKS-прокси на порте 9050 — даже если вы не говорили ему этого делать. Укажите параметр <code>SOCKSPort 0</code>, если планируете использовать Tor только в качестве передатчика без запуска работающих через прокси-сервер локальных приложений.
</p>
<p><code>Log notice stdout</code> перенаправляет логи в поток стандартного вывода stdout, что тоже является настройкой Tor по умолчанию.
</p>
<p><code>ControlPort 9051</code>, <code>CookieAuthentication 1</code> и <code>DisableDebuggerAttachment 0</code> позволят использовать <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=nyx">nyx</a></span> для мониторинга.
</p>
<p><code>ORPort 443</code> и <code>DirPort 80</code> говорит Tor прослушивать порты 443 и 80.
</p>
<p><code>DirPortFrontPage</code> выводит <a rel="nofollow" class="external text" href="https://gitlab.torproject.org/tpo/core/tor/-/raw/main/contrib/operator-tools/tor-exit-notice.html">страницу приветствия</a> при установлении соединения на порте 80.
</p>
<p><code>ExitPolicy reject XXX.XXX.XXX.XXX/XX:*</code> позволяет заблокировать соединения к определённым адресам; укажите здесь внешний IP-адрес и маску подсети вашего выходного узла (обычно можно узнать командой <code>ip addr</code>) для запрета подключения к нему и к соседним хостам через этот выходной узел, чтобы злоумышленник не смог воспользоваться ими для обхода правил сетевого экрана.
</p>
<p><code>AvoidDiskWrites 1</code> уменьшает количество записей на диск и износ SSD.
</p>
<p><code>DisableAllSwap 1</code> попытается заблокировать все текущие и будущие страницы памяти, чтобы их нельзя было выгрузить в подкачку.
</p>
<p>Если команда <code>grep aes /proc/cpuinfo</code> возвращает какой-то результат, то ваш CPU поддерживает AES-инструкции. Если соответствующий модуль был загружен (<code>lsmod | grep aes</code>), то параметр <code>HardwareAccel 1</code> включит встроенное аппаратное ускорение шифрования, подробнее: <a rel="nofollow" class="external free" href="https://www.torservers.net/wiki/setup/server#aes-ni_crypto_acceleration">https://www.torservers.net/wiki/setup/server#aes-ni_crypto_acceleration</a>
</p>
<p><code>ORPort 443</code>, <code>DirPort 80</code> и <code>DisableAllSwap 1</code> требуют запуска службы Tor от root, как описано в разделе <a href="#%D0%9F%D1%80%D0%B8%D0%B2%D0%B8%D0%BB%D0%B5%D0%B3%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%BD%D1%8B%D0%B5_%D0%BF%D0%BE%D1%80%D1%82%D1%8B">#Привилегированные порты</a>.
</p>
<p><code>User tor</code> понижает привилегии после запуска службы от имени root.
</p>
<h5><span class="mw-headline" id="nyx">nyx</span></h5>
<p>Если в файле <code>/etc/tor/torrc</code> указаны параметры <code>ControlPort 9051</code> и <code>CookieAuthentication 1</code>, то можно запустить <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=nyx">nyx</a></span> от имени пользователя <code>tor</code>:
</p>
<pre>[tor]$ nyx
</pre>
<p>Чтобы просматривать список соединений Tor с помощью <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=nyx">nyx</a></span>, нужно также указать параметр <code>DisableDebuggerAttachment 0</code>.
</p>
<p>Чтобы запустить <code>nyx</code> от другого пользователя (не <code>tor</code>), изучите раздел <a href="#Cookie-%D1%84%D0%B0%D0%B9%D0%BB_Tor_Control">#Cookie-файл Tor Control</a>.
</p>
<h5><span class="mw-headline" id="iptables">iptables</span></h5>
<p>Установите и изучите работу с <a href="../ru/Iptables.html" title="Iptables (Русский)">iptables</a>. Вместо использования <a href="../ru/Simple_stateful_firewall.html" title="Simple stateful firewall (Русский)">экрана с контекстной фильтрацией</a>, которому на выходном узле пришлось бы отслеживать тысячи соединений, мы настроим межсетевой экран без отслеживания контекста.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/iptables/iptables.rules</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">*raw
-A PREROUTING -j NOTRACK
-A OUTPUT -j NOTRACK
COMMIT

*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [0:0]
-A INPUT -p tcp ! --syn -j ACCEPT
-A INPUT -p udp -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -p tcp --dport 443 -j ACCEPT
-A INPUT -p tcp --dport 80 -j ACCEPT
-A INPUT -i lo -j ACCEPT
COMMIT</pre>
<p><code>-A PREROUTING -j NOTRACK</code> и <code>-A OUTPUT -j NOTRACK</code> отключит отслеживание соединений в таблице <code>raw</code>.
</p>
<p><code>:INPUT DROP [0:0]</code> — цель (target) цепочки <code>INPUT</code> по умолчанию; отбрасывает входящий трафик, который не был отдельно разрешён опцией <code>ACCEPT</code>.
</p>
<p><code>:FORWARD DROP [0:0]</code> — цель цепочки <code>FORWARD</code> по умолчанию; используется для обычных маршрутизаторов, но не подходит для «луковых».
</p>
<p><code>:OUTPUT ACCEPT [0:0]</code> — цель цепочки <code>OUTPUT</code> по умолчанию; разрешает все исходящие соединения.
</p>
<p><code>-A INPUT -p tcp ! --syn -j ACCEPT</code> разрешает уже установленные по перечисленным ниже правилам входящие TCP соединения, а также TCP соединения от выходного узла.
</p>
<p><code>-A INPUT -p udp -j ACCEPT</code> разрешает все входящие UDP соединения, т.к. мы не используем отслеживание соединений (connection tracking).
</p>
<p><code>-A INPUT -p icmp -j ACCEPT</code> разрешает <a href="https://en.wikipedia.org/wiki/ru:ICMP" class="extiw" title="wikipedia:ru:ICMP">ICMP</a>-пакеты.
</p>
<p><code>-A INPUT -p tcp --dport 443 -j ACCEPT</code> разрешает входящие соединения на <code>ORPort</code>.
</p>
<p><code>-A INPUT -p tcp --dport 80 -j ACCEPT</code> разрешает входящие соединения на <code>DirPort</code>.
</p>
<p><code>-A INPUT -i lo -j ACCEPT</code> разрешает входящие соединения на петлевой интерфейс.
</p>
<h5><span class="mw-headline" id="pdnsd">pdnsd</span></h5>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Важно:</strong> Предполагается, что у вас доверенный (не цензурируемый) DNS-сервер.</div>
<p>Вы можете использовать <a href="../en/Pdnsd.html" title="Pdnsd">pdnsd</a> для локального кэширования DNS-запросов, тогда выходной узел сможет быстрее выполнять разрешение и посылать меньшее количество запросов внешнему DNS-серверу.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/pdnsd.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">...
perm_cache=102400                       ## (Значение по умолчанию)*100 = 1 Мбайт * 100 = 100 Мбайт
...
server {
    label= "resolvconf";
    file = "/etc/pdnsd-resolv.conf";    ## Желательно не использовать файл /etc/resolv.conf
    timeout=4;                          ## Период ожидания ответа сервера; может быть значительно меньше, чем глобальное время ожидания
    uptest=query;                       ## Проверять доступность сервера, посылая пустые DNS-запросы
    query_test_name=".";                ## Используется, если удалённый сервер игнорирует пустые запросы
    interval=10m;                       ## Выполнять тестирование каждые 10 минут
    purge_cache=off;                    ## Игнорировать параметр TTL
    edns_query=yes;                     ## Использовать EDNS для исходящих запросов, чтобы разрешить UDP-сообщения длиннее 512 байт; может вызвать проблемы на некоторых устаревших системах
    preset=off;                         ## Перед проверкой состояния сервера предполагать, что он выключен
 }
...</pre>
<p>Такая настройка позволит кэшировать локально до 100 Мбайт DNS-запросов.
</p>
<h6><span class="mw-headline" id="Uncensored_DNS">Uncensored DNS</span></h6>
<p>Если ваш обычный DNS-сервер каким-то образом цензурируется или работает нестабильно, вы можете выбрать <a href="../ru/Domain_name_resolution.html#%D0%A1%D1%82%D0%BE%D1%80%D0%BE%D0%BD%D0%BD%D0%B8%D0%B5_%D1%81%D0%BB%D1%83%D0%B6%D0%B1%D1%8B_DNS" class="mw-redirect" title="Alternative DNS services (Русский)">альтернативный DNS-сервер</a>; добавьте нужный в отдельный раздел server в файле <code>/etc/pdnsd.conf</code> (смотрите <a href="../en/Pdnsd.html#DNS_servers" title="Pdnsd">Pdnsd#DNS servers</a>).
</p>
<h4>
<span id=".D0.9F.D1.80.D0.BE.D0.B2.D0.B5.D1.80.D0.BA.D0.B0_.D1.80.D0.B0.D0.B1.D0.BE.D1.82.D0.BE.D1.81.D0.BF.D0.BE.D1.81.D0.BE.D0.B1.D0.BD.D0.BE.D1.81.D1.82.D0.B8_.D1.83.D0.B7.D0.BB.D0.B0"></span><span class="mw-headline" id="Проверка_работоспособности_узла">Проверка работоспособности узла</span>
</h4>
<p>Сначала проверьте, запустился ли <code>tor.service</code> и нет ли в его <a href="../ru/Systemd/Journal.html" title="Systemd (Русский)/Journal (Русский)">журнале</a> ошибок.
</p>
<p>Если ошибок нет, можно запустить <code>nyx</code>, чтобы убедиться, что узел устанавливает соединения. Не беспокойтесь, если поначалу ваш <a rel="nofollow" class="external text" href="https://blog.torproject.org/lifecycle-new-relay">новый узел</a> работает медленно; это нормально. Примерно через 3 часа узел должен быть опубликован и стать доступен для поиска через <a rel="nofollow" class="external text" href="https://metrics.torproject.org/rs.html#search">Relay Search</a>.
</p>
<h2><span class="mw-headline" id="TorDNS">TorDNS</span></h2>
<p>Можно посылать DNS-запросы с помощью команды <code>tor-resolve</code>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">$ tor-resolve archlinux.org</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">66.211.214.131
</pre>
<p>Начиная с версий 0.2.x в Tor появился механизм перенаправления DNS-запросов. Чтобы его включить, добавьте строки ниже в файл настроек и <a href="../ru/Help:Reading.html#%D0%A3%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5_%D1%8E%D0%BD%D0%B8%D1%82%D0%B0%D0%BC%D0%B8_systemd" class="mw-redirect" title="Перезапустите">перезапустите</a> демон Tor:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/tor/torrc</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">DNSPort 9053
AutomapHostsOnResolve 1
AutomapHostsSuffixes .exit,.onion
</pre>
<p>Теперь Tor будет принимать запросы на порт 9053 как обычный DNS-сервер и выполнять разрешение доменов через сеть Tor.
</p>
<p>Ограничение TorDNS в том, что через него можно выполнить разрешение только A, AAAA и PTR записей; MX и NS запросы будут проигнорированы. Дополнительную информацию можно найти в <a rel="nofollow" class="external text" href="https://techstdout.boum.org/TorDns/">документации TorDNS</a> для Debian.
</p>
<h3>
<span id=".D0.9F.D0.B5.D1.80.D0.B5.D0.BD.D0.B0.D0.BF.D1.80.D0.B0.D0.B2.D0.BB.D0.B5.D0.BD.D0.B8.D0.B5_.D0.B2.D1.81.D0.B5.D1.85_DNS-.D0.B7.D0.B0.D0.BF.D1.80.D0.BE.D1.81.D0.BE.D0.B2_.D1.87.D0.B5.D1.80.D0.B5.D0.B7_TorDNS"></span><span class="mw-headline" id="Перенаправление_всех_DNS-запросов_через_TorDNS">Перенаправление всех DNS-запросов через TorDNS</span>
</h3>
<p>Вашу систему можно настроить посылать <i>все</i> запросы A, AAAA и PTR записей через TorDNS вне зависимости от того, используется ли Tor для соединения с конечной целью. Для этого настройте систему использовать адрес <code>127.0.0.1</code> в качестве DNS-сервера и отредактируйте строку <code>DNSPort</code> в файле <code>/etc/tor/torrc</code>:
</p>
<pre>DNSPort 53
</pre>
<p>Альтернативное решение — использовать локальный кэширующий DNS-сервер, вроде <a href="../en/Dnsmasq.html" class="mw-redirect" title="Dnsmasq (Русский)">dnsmasq</a> или <a href="../en/Pdnsd.html" title="Pdnsd">pdnsd</a>. Кэш DNS позволит несколько компенсировать низкую скорость TorDNS по сравнению с обычными DNS-серверами. Далее приведены инструкции по настройке <i>dnsmasq</i>. Имейте в виду, что если dnsmasq запускается через <i>NetworkManager</i>, то его настройки находятся в другом месте (смотрите раздел <a href="../en/NetworkManager.html#dnsmasq" title="NetworkManager">NetworkManager#dnsmasq</a>).
</p>
<p>Укажите Tor прослушивать DNS-запросы на порте 9053 и <a href="../ru/Help:Reading.html#%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0_%D0%BF%D0%B0%D0%BA%D0%B5%D1%82%D0%BE%D0%B2" class="mw-redirect" title="Установите">установите</a> пакет <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=dnsmasq">dnsmasq</a></span>.
</p>
<p>Задайте следующую конфигурацию dnsmasq:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/dnsmasq.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">no-resolv
port=53
server=127.0.0.1#9053
listen-address=127.0.0.1</pre>
<p>Теперь dnsmasq будет принимать локальные запросы и использовать TorDNS в качестве посредника. Отредактируйте файл <code>/etc/resolv.conf</code>, чтобы система опрашивала только сервер dnsmasq:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/resolv.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">nameserver 127.0.0.1
</pre>
<p><a href="../ru/Help:Reading.html#%D0%A3%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5_%D1%8E%D0%BD%D0%B8%D1%82%D0%B0%D0%BC%D0%B8_systemd" class="mw-redirect" title="Запустите">Запустите</a> демон dnsmasq.
</p>
<p>Наконец, если вы используете <a href="../ru/Dhcpcd.html" title="Dhcpcd (Русский)">dhcpcd</a>, укажите ему не изменять настройки в файле <code>resolv.conf</code>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/dhcpcd.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">nohook resolv.conf
</pre>
<p>Если строка <code>nohook</code> уже есть, то добавьте в неё <code>resolv.conf</code> через запятую.
</p>
<h2><span class="mw-headline" id="Torsocks">Torsocks</span></h2>
<p><span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=torsocks">torsocks</a></span> позволяет заставить приложение работать через сеть Tor без необходимости корректировать настройки самого́ приложения. Выдержка из <span class="plainlinks archwiki-template-man" title="$ man 1 torsocks"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/torsocks.1">torsocks(1)</a></span>:
</p>
<p><i>torsocks — обёртка между библиотекой torsocks и приложением с целью сделать каждое интернет-соединение проходящим через сеть Tor.</i>
</p>
<p>Имейте в виду, что эта обёртка намеренно запрещает некоторые системные вызовы, поэтому некоторые приложения не смогут полноценно работать с ней. Смотрите <a rel="nofollow" class="external text" href="https://stackoverflow.com/questions/46634215/torsocks-and-unsupported-syscalls">torsocks-and-unsupported-syscalls</a>.
</p>
<p>Примеры использования:
</p>
<pre>$ torsocks elinks checkip.dyndns.org
$ torsocks wget -qO- <a rel="nofollow" class="external free" href="https://check.torproject.org/">https://check.torproject.org/</a> | grep -i congratulations
</pre>
<h2>
<span id=".C2.AB.D0.A2.D0.BE.D1.80.D0.B8.D1.84.D0.B8.D0.BA.D0.B0.D1.86.D0.B8.D1.8F.C2.BB"></span><span class="mw-headline" id="«Торификация»">«Торификация»</span>
</h2>
<p>В некоторых случаях более безопасно (и часто проще) выполнить сквозную «торификацию» всей системы вместо настройки отдельных приложений на использование SOCKS-порта Tor и отслеживания утечек DNS. Для полной торификации сетевой экран <a href="../ru/Iptables.html" title="Iptables (Русский)">iptables</a> настраивают на пересылку всех исходящих пакетов (кроме собственно трафика Tor) на <i>TransPort</i>. В этом случае приложения не нужно настраивать для работы через Tor, хотя работа через <i>SOCKSPort</i> всё ещё возможна. Торификация также работает и для DNS (<i>DNSPort</i>), но при этом нужно учитывать, что Tor поддерживает только протокол TCP, и, за исключением DNS-запросов, UDP-пакеты через Tor посылаться не могут. Следовательно, они должны блокироваться для предотвращения утечек.
</p>
<p>Торификация через iptables даёт сравнительно надёжную защиту, но она не является полноценной заменой приложениям виртуализированной торификации вроде Whonix или TorVM <a rel="nofollow" class="external autonumber" href="https://www.whonix.org/wiki/Comparison_with_Others">[6]</a>. Торификация также не позволяет скрыть отпечаток браузера (fingerprint), поэтому рекомендуется воспользоваться «амнезийным» решением вроде <a rel="nofollow" class="external text" href="https://tails.net/">Tails</a>. Приложения всё ещё могут узнать имя хоста, MAC-адрес, серийный номер, часовой пояс вашего компьютера и другие данные, а с root-привилегиями смогут даже отключить сетевой экран целиком. Другими словами, полная торификация через iptables защищает от случайных соединений и DNS-утечек неправильно настроенного программного обеспечения, но не от вредоносных программ или ПО с серьёзными уязвимостями.
</p>
<p>При работе через <a href="https://en.wikipedia.org/wiki/ru:%D0%9F%D1%80%D0%BE%D0%BA%D1%81%D0%B8-%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80#.D0.92.D0.B8.D0.B4.D1.8B_.D0.BF.D1.80.D0.BE.D0.BA.D1.81.D0.B8-.D1.81.D0.B5.D1.80.D0.B2.D0.B5.D1.80.D0.BE.D0.B2" class="extiw" title="wikipedia:ru:Прокси-сервер">прозрачный прокси-сервер</a> появляется вероятность случайно запустить сеанс Tor дважды — на клиенте и на прокси, и таким образом получить «Tor поверх Tor». Такая схема работы обладает непредсказуемым поведением и потенциально небезопасна. В теории, трафик пользователя будет выполнять шесть прыжков вместо обычных трёх, но нет никакой гарантии, что дополнительные прыжки не совпадут с тремя изначальными — например, в другом порядке. Разработчики Tor считают, что это небезопасно <a rel="nofollow" class="external autonumber" href="https://support.torproject.org/ru/misc/#misc_misc-11">[7]</a>
<a rel="nofollow" class="external autonumber" href="https://gitlab.torproject.org/legacy/trac/-/wikis/doc/TorifyHOWTO#tor-over-tor">[8]</a>.
</p>
<p>Ниже приведён файл настроек для утилит <code>iptables-restore</code> и <code>ip6tables-restore</code> (используются <a href="../ru/Systemd.html" title="Systemd (Русский)">службами</a> <code>iptables.service</code> и <code>ip6tables.service</code> соответственно).
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> Правила в таблице NAT принудительно перенаправляют исходящие соединения на TransPort или DNSPort, и блокируют всё, что торифицировать не удаётся.
<ul>
<li>Флагами <code>--ipv6</code> и <code>--ipv4</code> задаются правила для конкретных версий протокола <a href="https://en.wikipedia.org/wiki/ru:IP" class="extiw" title="wikipedia:ru:IP">IP</a>. Таким образом, утилиты <code>iptables-restore</code> и <code>ip6tables-restore</code> могут использовать один и тот же файл настроек.</li>
<li>В случае явного указания флага <code>--ipv6</code> или <code>--ipv4</code> утилита <code>ip*tables-restore</code> будет игнорировать правило, если оно установлено для другой версии протокола.</li>
<li>
<code>ip6tables</code> не поддерживает флаг <code>--reject-with</code>.</li>
</ul>
<p>Убедитесь, что в файле <code>torrc</code> есть следующие строки:
</p>
<pre>SOCKSPort 9050
DNSPort 5353
TransPort 9040
</pre>
<p>Подробнее смотрите руководство <span class="plainlinks archwiki-template-man" title="$ man 8 iptables"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/iptables.8">iptables(8)</a></span>.
</p>
</div>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> Если вы получили ошибку <code>iptables-restore: unable to initialize table 'nat'</code>, то нужно загрузить некоторые модули ядра:
<pre># modprobe ip_tables iptable_nat ip_conntrack iptable-filter ipt_state
</pre>
</div>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/iptables/iptables.rules</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">*nat
:PREROUTING ACCEPT [6:2126]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [17:6239]
:POSTROUTING ACCEPT [6:408]

-A PREROUTING ! -i lo -p udp -m udp --dport 53 -j REDIRECT --to-ports 5353
-A PREROUTING ! -i lo -p tcp -m tcp --tcp-flags FIN,SYN,RST,ACK SYN -j REDIRECT --to-ports 9040
-A OUTPUT -o lo -j RETURN
--ipv4 -A OUTPUT -d 192.168.0.0/16 -j RETURN
-A OUTPUT -m owner --uid-owner "tor" -j RETURN
-A OUTPUT -p udp -m udp --dport 53 -j REDIRECT --to-ports 5353
-A OUTPUT -p tcp -m tcp --tcp-flags FIN,SYN,RST,ACK SYN -j REDIRECT --to-ports 9040
COMMIT

*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT DROP [0:0]

-A INPUT -i lo -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
--ipv4 -A INPUT -p tcp -j REJECT --reject-with tcp-reset
--ipv4 -A INPUT -p udp -j REJECT --reject-with icmp-port-unreachable
--ipv4 -A INPUT -j REJECT --reject-with icmp-proto-unreachable
--ipv6 -A INPUT -j REJECT
--ipv4 -A OUTPUT -d 127.0.0.0/8 -j ACCEPT
--ipv4 -A OUTPUT -d 192.168.0.0/16 -j ACCEPT
--ipv6 -A OUTPUT -d ::1/8 -j ACCEPT
-A OUTPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A OUTPUT -m owner --uid-owner "tor" -j ACCEPT
--ipv4 -A OUTPUT -j REJECT --reject-with icmp-port-unreachable
--ipv6 -A OUTPUT -j REJECT
COMMIT
</pre>
<p>Данный файл также подходит для утилиты <code>ip6tables-restore</code>. Создайте символическую ссылку на него:
</p>
<pre># ln -s /etc/iptables/iptables.rules /etc/iptables/ip6tables.rules
</pre>
<p>Убедитесь, что Tor работает, и <a href="../ru/Help:Reading.html#%D0%A3%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5_%D1%8E%D0%BD%D0%B8%D1%82%D0%B0%D0%BC%D0%B8_systemd" class="mw-redirect" title="Запустите/включите">запустите/включите</a> службы <code>iptables</code> и <code>ip6tables</code>.
</p>
<p>При необходимости можно <a href="../ru/Systemd.html#%D0%A0%D0%B5%D0%B4%D0%B0%D0%BA%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_%D1%84%D0%B0%D0%B9%D0%BB%D0%BE%D0%B2_%D1%8E%D0%BD%D0%B8%D1%82%D0%BE%D0%B2" title="Systemd (Русский)">добавить указания</a> <code>Requires=iptables.service</code> и <code>Requires=ip6tables.service</code> к любому юниту systemd (например, к <a href="../ru/Display_manager.html" title="Display manager (Русский)">экранному менеджеру</a>), чтобы выбранный процесс запускался строго после включения межсетевого экрана.
</p>
<h2>
<span id=".D0.A1.D0.BE.D0.B2.D0.B5.D1.82.D1.8B_.D0.B8_.D1.80.D0.B5.D0.BA.D0.BE.D0.BC.D0.B5.D0.BD.D0.B4.D0.B0.D1.86.D0.B8.D0.B8"></span><span class="mw-headline" id="Советы_и_рекомендации">Советы и рекомендации</span>
</h2>
<h3>
<span id=".D0.9F.D1.80.D0.B8.D0.B2.D0.B8.D0.BB.D0.B5.D0.B3.D0.B8.D0.B8"></span><span class="mw-headline" id="Привилегии">Привилегии</span>
</h3>
<p>Если необходимо запустить Tor от обычного пользователя и при этом использовать порты меньше 1024, то можно воспользоваться функциональностью ядра для выдачи процессу <code>/usr/bin/tor</code> <a href="../ru/Capabilities.html" title="Capabilities (Русский)">привилегии</a> прослушивать привилегированные порты:
</p>
<pre># setcap CAP_NET_BIND_SERVICE=+eip /usr/bin/tor
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> После обновления пакета Tor эти разрешения сбросятся. Создайте <a href="../ru/Pacman.html#%D0%A5%D1%83%D0%BA%D0%B8" title="Pacman (Русский)">хук pacman</a> для автоматической выдачи привилегии после обновления.</div>
<p>Если вы используете службу systemd, то выдать Tor соответствующие разрешения можно также через настройки системного демона. Это удобно тем, что их не нужно восстанавливать после каждого обновления Tor:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/tor.service.d/netcap.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Service]
CapabilityBoundingSet=
CapabilityBoundingSet=CAP_NET_BIND_SERVICE
AmbientCapabilities=
AmbientCapabilities=CAP_NET_BIND_SERVICE</pre>
<p>Подробности можно найти на странице <a rel="nofollow" class="external text" href="https://superuser.com/questions/710253/allow-non-root-process-to-bind-to-port-80-and-443">superuser.com</a>.
</p>
<h2>
<span id=".D0.A0.D0.B5.D1.88.D0.B5.D0.BD.D0.B8.D0.B5_.D0.BF.D1.80.D0.BE.D0.B1.D0.BB.D0.B5.D0.BC"></span><span class="mw-headline" id="Решение_проблем">Решение проблем</span>
</h2>
<h3>
<span id=".D0.9F.D1.80.D0.BE.D0.B1.D0.BB.D0.B5.D0.BC.D0.B0_.D1.81_.D0.BF.D0.B0.D1.80.D0.B0.D0.BC.D0.B5.D1.82.D1.80.D0.BE.D0.BC_User"></span><span class="mw-headline" id="Проблема_с_параметром_User">Проблема с параметром User</span>
</h3>
<p>Если не удалось запустить демон Tor, выполните следующую команду от root (или воспользуйтесь утилитой <a href="../ru/Sudo.html" title="Sudo (Русский)">sudo</a>):
</p>
<pre># tor
</pre>
<p>Ошибка
</p>
<pre>May 23 00:27:24.624 [warn] Error setting groups to gid 43: "Operation not permitted".
May 23 00:27:24.624 [warn] If you set the "User" option, you must start Tor as root.
May 23 00:27:24.624 [warn] Failed to parse/validate config: Problem with User value. See logs for details.
May 23 00:27:24.624 [err] Reading config failed--see warnings above.
</pre>
<p>означает проблемы с параметром User. Скорее всего, один или несколько файлов/каталогов в каталоге <code>/var/lib/tor</code> не принадлежат пользователю <code>tor</code>. Это можно определить с помощью команды <i>find</i>:
</p>
<pre># find /var/lib/tor/ '!' -user tor
</pre>
<p>Для всех выведенных файлов и каталогов нужно поменять параметр владельца. Можно сделать это индивидуально для каждого файла
</p>
<pre># chown tor:tor /var/lib/tor/<i>имя_файла</i>
</pre>
<p>или отредактировать все сразу командой
</p>
<pre># chown -R -v tor:tor /var/lib/tor
</pre>
<p>Теперь Tor должен запуститься без проблем.
</p>
<p>Если запустить службу всё же не удаётся, запустите её от root. Измените имя пользователя в файле <code>/etc/tor/torrc</code>:
</p>
<pre>User tor
</pre>
<p>Затем <a href="../ru/Systemd.html#%D0%A0%D0%B5%D0%B4%D0%B0%D0%BA%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_%D1%84%D0%B0%D0%B9%D0%BB%D0%BE%D0%B2_%D1%8E%D0%BD%D0%B8%D1%82%D0%BE%D0%B2" class="mw-redirect" title="Отредактируйте">отредактируйте</a> юнит <code>tor.service</code>:
</p>
<pre>[Service]
User=root
Group=root
Type=simple
</pre>
<p>В дальнейшем процесс будет запускаться от пользователя <code>tor</code>, поэтому измените UID и GID файлов на <code>tor</code> и добавьте разрешение на запись:
</p>
<pre># chown -R tor:tor /var/lib/tor/
# chmod -R 700 /var/lib/tor
</pre>
<p>Выполните <a href="../ru/Help:Reading.html#%D0%A3%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5_%D1%8E%D0%BD%D0%B8%D1%82%D0%B0%D0%BC%D0%B8_systemd" title="Help:Reading (Русский)">daemon-reload</a> для применения изменений и, наконец, <a href="../ru/Help:Reading.html#%D0%A3%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5_%D1%8E%D0%BD%D0%B8%D1%82%D0%B0%D0%BC%D0%B8_systemd" class="mw-redirect" title="Запустите">запустите</a> <code>tor.service</code>.
</p>
<h3>
<span id=".D0.9F.D1.80.D0.BE.D0.B1.D0.BB.D0.B5.D0.BC.D1.8B_.D1.81_.D0.BF.D1.80.D0.BE.D0.BA.D1.81.D0.B8_.D0.B2_Tor_Browser"></span><span class="mw-headline" id="Проблемы_с_прокси_в_Tor_Browser">Проблемы с прокси в Tor Browser</span>
</h3>
<p>Tor Browser обычно нормально работает без дополнительных настроек. Если установленный/настроенный прокси выдаёт ошибку «Прокси-сервер отказывается принимать соединения» при попытке открытия любого сайта, попробуйте сбросить настройки, переместив или удалив каталог <code>~/.local/share/torbrowser/</code>.
</p>
<h3>
<span id=".D0.9F.D1.83.D1.81.D1.82.D0.BE.D0.B9_.D1.87.D1.91.D1.80.D0.BD.D1.8B.D0.B9_.D1.8D.D0.BA.D1.80.D0.B0.D0.BD_.D0.B2_tor-browser"></span><span class="mw-headline" id="Пустой_чёрный_экран_в_tor-browser">Пустой чёрный экран в tor-browser</span>
</h3>
<p>При работе с <a href="../en/AppArmor.html" title="AppArmor">AppArmor</a> для доступа к ресурсам необходимо внести изменения в профиль Tor Browser <a rel="nofollow" class="external autonumber" href="https://unix.stackexchange.com/questions/550074/debian-tor-browser-showing-a-black-screen/550246#550246">[9]</a>, <a rel="nofollow" class="external autonumber" href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=942901">[10]</a>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/apparmor.d/local/torbrowser.Browser.firefox</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">owner /{dev,run}/shm/org.mozilla.*.* rw,
</pre>
<h2>
<span id=".D0.A1.D0.BC.D0.BE.D1.82.D1.80.D0.B8.D1.82.D0.B5_.D1.82.D0.B0.D0.BA.D0.B6.D0.B5"></span><span class="mw-headline" id="Смотрите_также">Смотрите также</span>
</h2>
<ul>
<li><a rel="nofollow" class="external text" href="https://community.torproject.org/onion-services/setup/">Как настроить свой onion-сервис</a></li>
<li><a rel="nofollow" class="external text" href="https://tb-manual.torproject.org/circumvention/">Использование подключаемых транспортов для обхода блокировки Tor</a></li>
<li><a rel="nofollow" class="external text" href="https://gitlab.torproject.org/tpo/community/relays/-/issues/18">Tor Relay Operator best practices</a></li>
<li><a rel="nofollow" class="external text" href="https://gitlab.torproject.org/legacy/trac">Старая вики</a></li>
</ul>
</div>
</div>
					<div id="catlinks" class="catlinks" data-mw="interface">
<div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../Special:Categories.html" title="Special:Categories">Category</a>: <ul><li><a href="../ru/Category:Anonymity_networks.html" title="Category:Anonymity networks (Русский)">Anonymity networks (Русский)</a></li></ul>
</div>
<div id="mw-hidden-catlinks" class="mw-hidden-catlinks mw-hidden-cats-hidden">Hidden category: <ul><li><a href="../en/Category:Pages_or_sections_flagged_with_Template:Out_of_date.html" title="Category:Pages or sections flagged with Template:Out of date">Pages or sections flagged with Template:Out of date</a></li></ul>
</div>
</div>
				</div>
			</main>
			
		</div>
		<div class="mw-footer-container">
			
<footer id="footer" class="mw-footer" role="contentinfo" style="margin: 0">
	<ul id="footer-info">
	<li data-nosnippet="">Retrieved from "<a dir="ltr" href="https://wiki.archlinux.org/index.php?title=Tor_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)&amp;oldid=813170">https://wiki.archlinux.org/index.php?title=Tor_(Русский)&amp;oldid=813170</a>"</li>
<li id="footer-info-lastmod"> This page was last edited on 29 July 2024, at 07:02.</li>
	<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="https://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.3 or later</a> unless otherwise noted.</li>
<br>
</ul>

	<ul id="footer-places">
	<li id="footer-places-privacy"><a href="https://terms.archlinux.org/docs/privacy-policy/">Privacy policy</a></li>
	<li id="footer-places-about"><a href="../en/ArchWiki:About.html">About ArchWiki</a></li>
	<li id="footer-places-disclaimers"><a href="../en/ArchWiki:General_disclaimer.html">Disclaimers</a></li>
	<li id="footer-places-archwiki-code-of-conduct"><a href="https://terms.archlinux.org/docs/code-of-conduct/" class="extiw" title="archlinux-service-agreements:code-of-conduct">Code of conduct</a></li>
	<li id="footer-places-archwiki-terms-of-service"><a href="https://terms.archlinux.org/docs/terms-of-service/" class="extiw" title="archlinux-service-agreements:terms-of-service">Terms of service</a></li>
</ul>

	<ul id="footer-icons" class="noprint">
	<li id="footer-copyrightico"><a href="https://www.gnu.org/copyleft/fdl.html"><img src="/resources/assets/licenses/gnu-fdl.png" alt="GNU Free Documentation License 1.3 or later" width="88" height="31" loading="lazy"></a></li>
	<li id="footer-poweredbyico"><img src="/resources/assets/poweredby_mediawiki_88x31.png" srcset="/resources/assets/poweredby_mediawiki_132x47.png 1.5x, /resources/assets/poweredby_mediawiki_176x62.png 2x" width="88" height="31" loading="lazy"></li>
</ul>

</footer>

		</div>
	</div> 
</div> 
<div class="vector-settings" id="p-dock-bottom">
	<ul>
		<li>
		<button class="cdx-button cdx-button--icon-only vector-limited-width-toggle" id=""><span class="vector-icon mw-ui-icon-fullScreen mw-ui-icon-wikimedia-fullScreen"></span>

<span>Toggle limited content width</span>
</button>
</li>
	</ul>
</div>
</body>
</html>
