<!DOCTYPE html>
<html class="client-nojs vector-feature-language-in-header-enabled vector-feature-language-in-main-page-header-disabled vector-feature-sticky-header-disabled vector-feature-page-tools-pinned-disabled vector-feature-toc-pinned-clientpref-1 vector-feature-main-menu-pinned-disabled vector-feature-limited-width-clientpref-1 vector-feature-limited-width-content-enabled vector-feature-custom-font-size-clientpref-0 vector-feature-appearance-pinned-clientpref-1 vector-feature-night-mode-disabled skin-theme-clientpref-day vector-toc-available" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>nftables (Русский) - ArchWiki</title>
<link rel="stylesheet" href="../ArchWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<meta name="generator" content="MediaWiki 1.43.0">
<meta name="referrer" content="no-referrer-when-downgrade">
<meta name="robots" content="max-image-preview:standard">
<meta name="format-detection" content="telephone=no">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=0.25, maximum-scale=5.0">
<link rel="search" type="application/opensearchdescription+xml" href="/rest.php/v1/search" title="ArchWiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.archlinux.org/api.php?action=rsd">
<link rel="license" href="https://www.gnu.org/copyleft/fdl.html">
<link rel="alternate" type="application/atom+xml" title="ArchWiki Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="skin--responsive skin-vector skin-vector-search-vue mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-Nftables_Русский rootpage-Nftables_Русский skin-vector-2022 action-view">
<a class="mw-jump-link" href="#bodyContent">Jump to content</a>
<div class="vector-header-container">
	</div>
<div class="mw-page-container">
	<div class="mw-page-container-inner">
		<div class="vector-column-start">
			<div class="vector-main-menu-container">
		</div>
	<div class="vector-sticky-pinned-container">
				<nav id="mw-panel-toc" aria-label="Contents" data-event-name="ui.sidebar-toc" class="mw-table-of-contents-container vector-toc-landmark">
					<div id="vector-toc-pinned-container" class="vector-pinned-container">
					<div id="vector-toc" class="vector-toc vector-pinnable-element">
	<div class="vector-pinnable-header vector-toc-pinnable-header vector-pinnable-header-pinned" data-feature-name="toc-pinned" data-pinnable-element-id="vector-toc">
	<h2 class="vector-pinnable-header-label">Contents</h2>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-pin-button" data-event-name="pinnable-header.vector-toc.pin">move to sidebar</button>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-unpin-button" data-event-name="pinnable-header.vector-toc.unpin">hide</button>
</div>


	<ul class="vector-toc-contents" id="mw-panel-toc-list">
		<li id="toc-mw-content-text" class="vector-toc-list-item vector-toc-level-1">
			<a href="#" class="vector-toc-link">
				<div class="vector-toc-text">Beginning</div>
			</a>
		</li>
		<li id="toc-Установка" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0">
			<div class="vector-toc-text">
				<span class="vector-toc-numb">1</span>
				<span>Установка</span>
			</div>
		</a>
		
		<ul id="toc-Установка-sublist" class="vector-toc-list">
		</ul>
	</li>
	<li id="toc-Использование" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#%D0%98%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5">
			<div class="vector-toc-text">
				<span class="vector-toc-numb">2</span>
				<span>Использование</span>
			</div>
		</a>
		
			<button aria-controls="toc-Использование-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Использование subsection</span>
			</button>
		
		<ul id="toc-Использование-sublist" class="vector-toc-list">
			<li id="toc-Простой_межсетевой_экран" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%9F%D1%80%D0%BE%D1%81%D1%82%D0%BE%D0%B9_%D0%BC%D0%B5%D0%B6%D1%81%D0%B5%D1%82%D0%B5%D0%B2%D0%BE%D0%B9_%D1%8D%D0%BA%D1%80%D0%B0%D0%BD">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">2.1</span>
					<span>Простой межсетевой экран</span>
				</div>
			</a>
			
			<ul id="toc-Простой_межсетевой_экран-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Настройка" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0">
			<div class="vector-toc-text">
				<span class="vector-toc-numb">3</span>
				<span>Настройка</span>
			</div>
		</a>
		
			<button aria-controls="toc-Настройка-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Настройка subsection</span>
			</button>
		
		<ul id="toc-Настройка-sublist" class="vector-toc-list">
			<li id="toc-Таблицы" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%A2%D0%B0%D0%B1%D0%BB%D0%B8%D1%86%D1%8B">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">3.1</span>
					<span>Таблицы</span>
				</div>
			</a>
			
			<ul id="toc-Таблицы-sublist" class="vector-toc-list">
				<li id="toc-Создание_таблицы" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D1%82%D0%B0%D0%B1%D0%BB%D0%B8%D1%86%D1%8B">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">3.1.1</span>
					<span>Создание таблицы</span>
				</div>
			</a>
			
			<ul id="toc-Создание_таблицы-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Просмотр_таблиц" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#%D0%9F%D1%80%D0%BE%D1%81%D0%BC%D0%BE%D1%82%D1%80_%D1%82%D0%B0%D0%B1%D0%BB%D0%B8%D1%86">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">3.1.2</span>
					<span>Просмотр таблиц</span>
				</div>
			</a>
			
			<ul id="toc-Просмотр_таблиц-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Просмотр_цепочек_и_правил_в_таблице" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#%D0%9F%D1%80%D0%BE%D1%81%D0%BC%D0%BE%D1%82%D1%80_%D1%86%D0%B5%D0%BF%D0%BE%D1%87%D0%B5%D0%BA_%D0%B8_%D0%BF%D1%80%D0%B0%D0%B2%D0%B8%D0%BB_%D0%B2_%D1%82%D0%B0%D0%B1%D0%BB%D0%B8%D1%86%D0%B5">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">3.1.3</span>
					<span>Просмотр цепочек и правил в таблице</span>
				</div>
			</a>
			
			<ul id="toc-Просмотр_цепочек_и_правил_в_таблице-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Удаление_таблицы" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#%D0%A3%D0%B4%D0%B0%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5_%D1%82%D0%B0%D0%B1%D0%BB%D0%B8%D1%86%D1%8B">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">3.1.4</span>
					<span>Удаление таблицы</span>
				</div>
			</a>
			
			<ul id="toc-Удаление_таблицы-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Очистка_таблицы" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#%D0%9E%D1%87%D0%B8%D1%81%D1%82%D0%BA%D0%B0_%D1%82%D0%B0%D0%B1%D0%BB%D0%B8%D1%86%D1%8B">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">3.1.5</span>
					<span>Очистка таблицы</span>
				</div>
			</a>
			
			<ul id="toc-Очистка_таблицы-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Цепочки" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%A6%D0%B5%D0%BF%D0%BE%D1%87%D0%BA%D0%B8">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">3.2</span>
					<span>Цепочки</span>
				</div>
			</a>
			
			<ul id="toc-Цепочки-sublist" class="vector-toc-list">
				<li id="toc-Создание_цепочки" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D1%86%D0%B5%D0%BF%D0%BE%D1%87%D0%BA%D0%B8">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">3.2.1</span>
					<span>Создание цепочки</span>
				</div>
			</a>
			
			<ul id="toc-Создание_цепочки-sublist" class="vector-toc-list">
				<li id="toc-Обычная_цепочка" class="vector-toc-list-item vector-toc-level-4">
			<a class="vector-toc-link" href="#%D0%9E%D0%B1%D1%8B%D1%87%D0%BD%D0%B0%D1%8F_%D1%86%D0%B5%D0%BF%D0%BE%D1%87%D0%BA%D0%B0">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">3.2.1.1</span>
					<span>Обычная цепочка</span>
				</div>
			</a>
			
			<ul id="toc-Обычная_цепочка-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Базовая_цепочка" class="vector-toc-list-item vector-toc-level-4">
			<a class="vector-toc-link" href="#%D0%91%D0%B0%D0%B7%D0%BE%D0%B2%D0%B0%D1%8F_%D1%86%D0%B5%D0%BF%D0%BE%D1%87%D0%BA%D0%B0">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">3.2.1.2</span>
					<span>Базовая цепочка</span>
				</div>
			</a>
			
			<ul id="toc-Базовая_цепочка-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Просмотр_правил" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#%D0%9F%D1%80%D0%BE%D1%81%D0%BC%D0%BE%D1%82%D1%80_%D0%BF%D1%80%D0%B0%D0%B2%D0%B8%D0%BB">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">3.2.2</span>
					<span>Просмотр правил</span>
				</div>
			</a>
			
			<ul id="toc-Просмотр_правил-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Изменение_цепочки" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#%D0%98%D0%B7%D0%BC%D0%B5%D0%BD%D0%B5%D0%BD%D0%B8%D0%B5_%D1%86%D0%B5%D0%BF%D0%BE%D1%87%D0%BA%D0%B8">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">3.2.3</span>
					<span>Изменение цепочки</span>
				</div>
			</a>
			
			<ul id="toc-Изменение_цепочки-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Удаление_цепочки" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#%D0%A3%D0%B4%D0%B0%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5_%D1%86%D0%B5%D0%BF%D0%BE%D1%87%D0%BA%D0%B8">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">3.2.4</span>
					<span>Удаление цепочки</span>
				</div>
			</a>
			
			<ul id="toc-Удаление_цепочки-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Очистка_цепочки" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#%D0%9E%D1%87%D0%B8%D1%81%D1%82%D0%BA%D0%B0_%D1%86%D0%B5%D0%BF%D0%BE%D1%87%D0%BA%D0%B8">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">3.2.5</span>
					<span>Очистка цепочки</span>
				</div>
			</a>
			
			<ul id="toc-Очистка_цепочки-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Правила" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%9F%D1%80%D0%B0%D0%B2%D0%B8%D0%BB%D0%B0">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">3.3</span>
					<span>Правила</span>
				</div>
			</a>
			
			<ul id="toc-Правила-sublist" class="vector-toc-list">
				<li id="toc-Добавление_правила" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#%D0%94%D0%BE%D0%B1%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5_%D0%BF%D1%80%D0%B0%D0%B2%D0%B8%D0%BB%D0%B0">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">3.3.1</span>
					<span>Добавление правила</span>
				</div>
			</a>
			
			<ul id="toc-Добавление_правила-sublist" class="vector-toc-list">
				<li id="toc-Выражения" class="vector-toc-list-item vector-toc-level-4">
			<a class="vector-toc-link" href="#%D0%92%D1%8B%D1%80%D0%B0%D0%B6%D0%B5%D0%BD%D0%B8%D1%8F">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">3.3.1.1</span>
					<span>Выражения</span>
				</div>
			</a>
			
			<ul id="toc-Выражения-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Удаление" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#%D0%A3%D0%B4%D0%B0%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">3.3.2</span>
					<span>Удаление</span>
				</div>
			</a>
			
			<ul id="toc-Удаление-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Множества" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%9C%D0%BD%D0%BE%D0%B6%D0%B5%D1%81%D1%82%D0%B2%D0%B0">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">3.4</span>
					<span>Множества</span>
				</div>
			</a>
			
			<ul id="toc-Множества-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Полная_перезагрузка_правил" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%9F%D0%BE%D0%BB%D0%BD%D0%B0%D1%8F_%D0%BF%D0%B5%D1%80%D0%B5%D0%B7%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D0%BA%D0%B0_%D0%BF%D1%80%D0%B0%D0%B2%D0%B8%D0%BB">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">3.5</span>
					<span>Полная перезагрузка правил</span>
				</div>
			</a>
			
			<ul id="toc-Полная_перезагрузка_правил-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Примеры" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#%D0%9F%D1%80%D0%B8%D0%BC%D0%B5%D1%80%D1%8B">
			<div class="vector-toc-text">
				<span class="vector-toc-numb">4</span>
				<span>Примеры</span>
			</div>
		</a>
		
			<button aria-controls="toc-Примеры-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Примеры subsection</span>
			</button>
		
		<ul id="toc-Примеры-sublist" class="vector-toc-list">
			<li id="toc-Рабочая_станция" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%A0%D0%B0%D0%B1%D0%BE%D1%87%D0%B0%D1%8F_%D1%81%D1%82%D0%B0%D0%BD%D1%86%D0%B8%D1%8F">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">4.1</span>
					<span>Рабочая станция</span>
				</div>
			</a>
			
			<ul id="toc-Рабочая_станция-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Сервер" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%A1%D0%B5%D1%80%D0%B2%D0%B5%D1%80">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">4.2</span>
					<span>Сервер</span>
				</div>
			</a>
			
			<ul id="toc-Сервер-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Ограничение_скорости_передачи" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%9E%D0%B3%D1%80%D0%B0%D0%BD%D0%B8%D1%87%D0%B5%D0%BD%D0%B8%D0%B5_%D1%81%D0%BA%D0%BE%D1%80%D0%BE%D1%81%D1%82%D0%B8_%D0%BF%D0%B5%D1%80%D0%B5%D0%B4%D0%B0%D1%87%D0%B8">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">4.3</span>
					<span>Ограничение скорости передачи</span>
				</div>
			</a>
			
			<ul id="toc-Ограничение_скорости_передачи-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Переход" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%9F%D0%B5%D1%80%D0%B5%D1%85%D0%BE%D0%B4">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">4.4</span>
					<span>Переход</span>
				</div>
			</a>
			
			<ul id="toc-Переход-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Несколько_сетевых_интерфейсов_с_разными_правилами" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%9D%D0%B5%D1%81%D0%BA%D0%BE%D0%BB%D1%8C%D0%BA%D0%BE_%D1%81%D0%B5%D1%82%D0%B5%D0%B2%D1%8B%D1%85_%D0%B8%D0%BD%D1%82%D0%B5%D1%80%D1%84%D0%B5%D0%B9%D1%81%D0%BE%D0%B2_%D1%81_%D1%80%D0%B0%D0%B7%D0%BD%D1%8B%D0%BC%D0%B8_%D0%BF%D1%80%D0%B0%D0%B2%D0%B8%D0%BB%D0%B0%D0%BC%D0%B8">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">4.5</span>
					<span>Несколько сетевых интерфейсов с разными правилами</span>
				</div>
			</a>
			
			<ul id="toc-Несколько_сетевых_интерфейсов_с_разными_правилами-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Маскарадинг" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%9C%D0%B0%D1%81%D0%BA%D0%B0%D1%80%D0%B0%D0%B4%D0%B8%D0%BD%D0%B3">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">4.6</span>
					<span>Маскарадинг</span>
				</div>
			</a>
			
			<ul id="toc-Маскарадинг-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-NAT_с_пробросом_портов" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#NAT_%D1%81_%D0%BF%D1%80%D0%BE%D0%B1%D1%80%D0%BE%D1%81%D0%BE%D0%BC_%D0%BF%D0%BE%D1%80%D1%82%D0%BE%D0%B2">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">4.7</span>
					<span>NAT с пробросом портов</span>
				</div>
			</a>
			
			<ul id="toc-NAT_с_пробросом_портов-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Счётчик_новых_соединений" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%A1%D1%87%D1%91%D1%82%D1%87%D0%B8%D0%BA_%D0%BD%D0%BE%D0%B2%D1%8B%D1%85_%D1%81%D0%BE%D0%B5%D0%B4%D0%B8%D0%BD%D0%B5%D0%BD%D0%B8%D0%B9">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">4.8</span>
					<span>Счётчик новых соединений</span>
				</div>
			</a>
			
			<ul id="toc-Счётчик_новых_соединений-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Динамическая_блокировка" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%94%D0%B8%D0%BD%D0%B0%D0%BC%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B0%D1%8F_%D0%B1%D0%BB%D0%BE%D0%BA%D0%B8%D1%80%D0%BE%D0%B2%D0%BA%D0%B0">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">4.9</span>
					<span>Динамическая блокировка</span>
				</div>
			</a>
			
			<ul id="toc-Динамическая_блокировка-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Советы_и_рекомендации" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#%D0%A1%D0%BE%D0%B2%D0%B5%D1%82%D1%8B_%D0%B8_%D1%80%D0%B5%D0%BA%D0%BE%D0%BC%D0%B5%D0%BD%D0%B4%D0%B0%D1%86%D0%B8%D0%B8">
			<div class="vector-toc-text">
				<span class="vector-toc-numb">5</span>
				<span>Советы и рекомендации</span>
			</div>
		</a>
		
			<button aria-controls="toc-Советы_и_рекомендации-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Советы и рекомендации subsection</span>
			</button>
		
		<ul id="toc-Советы_и_рекомендации-sublist" class="vector-toc-list">
			<li id="toc-Сохранение_текущего_набора_правил" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%A1%D0%BE%D1%85%D1%80%D0%B0%D0%BD%D0%B5%D0%BD%D0%B8%D0%B5_%D1%82%D0%B5%D0%BA%D1%83%D1%89%D0%B5%D0%B3%D0%BE_%D0%BD%D0%B0%D0%B1%D0%BE%D1%80%D0%B0_%D0%BF%D1%80%D0%B0%D0%B2%D0%B8%D0%BB">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">5.1</span>
					<span>Сохранение текущего набора правил</span>
				</div>
			</a>
			
			<ul id="toc-Сохранение_текущего_набора_правил-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Настройка_межсетевого_экрана" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0_%D0%BC%D0%B5%D0%B6%D1%81%D0%B5%D1%82%D0%B5%D0%B2%D0%BE%D0%B3%D0%BE_%D1%8D%D0%BA%D1%80%D0%B0%D0%BD%D0%B0">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">5.2</span>
					<span>Настройка межсетевого экрана</span>
				</div>
			</a>
			
			<ul id="toc-Настройка_межсетевого_экрана-sublist" class="vector-toc-list">
				<li id="toc-Одиночная_машина" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#%D0%9E%D0%B4%D0%B8%D0%BD%D0%BE%D1%87%D0%BD%D0%B0%D1%8F_%D0%BC%D0%B0%D1%88%D0%B8%D0%BD%D0%B0">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">5.2.1</span>
					<span>Одиночная машина</span>
				</div>
			</a>
			
			<ul id="toc-Одиночная_машина-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Предотвращение_атак_перебором" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%9F%D1%80%D0%B5%D0%B4%D0%BE%D1%82%D0%B2%D1%80%D0%B0%D1%89%D0%B5%D0%BD%D0%B8%D0%B5_%D0%B0%D1%82%D0%B0%D0%BA_%D0%BF%D0%B5%D1%80%D0%B5%D0%B1%D0%BE%D1%80%D0%BE%D0%BC">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">5.3</span>
					<span>Предотвращение атак перебором</span>
				</div>
			</a>
			
			<ul id="toc-Предотвращение_атак_перебором-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Журналирование_трафика" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%96%D1%83%D1%80%D0%BD%D0%B0%D0%BB%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_%D1%82%D1%80%D0%B0%D1%84%D0%B8%D0%BA%D0%B0">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">5.4</span>
					<span>Журналирование трафика</span>
				</div>
			</a>
			
			<ul id="toc-Журналирование_трафика-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Решение_проблем" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#%D0%A0%D0%B5%D1%88%D0%B5%D0%BD%D0%B8%D0%B5_%D0%BF%D1%80%D0%BE%D0%B1%D0%BB%D0%B5%D0%BC">
			<div class="vector-toc-text">
				<span class="vector-toc-numb">6</span>
				<span>Решение проблем</span>
			</div>
		</a>
		
			<button aria-controls="toc-Решение_проблем-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Решение проблем subsection</span>
			</button>
		
		<ul id="toc-Решение_проблем-sublist" class="vector-toc-list">
			<li id="toc-Работа_с_Docker" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#%D0%A0%D0%B0%D0%B1%D0%BE%D1%82%D0%B0_%D1%81_Docker">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">6.1</span>
					<span>Работа с Docker</span>
				</div>
			</a>
			
			<ul id="toc-Работа_с_Docker-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Смотрите_также" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#%D0%A1%D0%BC%D0%BE%D1%82%D1%80%D0%B8%D1%82%D0%B5_%D1%82%D0%B0%D0%BA%D0%B6%D0%B5">
			<div class="vector-toc-text">
				<span class="vector-toc-numb">7</span>
				<span>Смотрите также</span>
			</div>
		</a>
		
		<ul id="toc-Смотрите_также-sublist" class="vector-toc-list">
		</ul>
	</li>
</ul>
</div>

					</div>
		</nav>
			</div>
		</div>
		<div class="mw-content-container">
			<main id="content" class="mw-body" style="margin: 0">
				<header class="mw-body-header vector-page-titlebar">
					<nav aria-label="Contents" class="vector-toc-landmark">
						
<div id="vector-page-titlebar-toc" class="vector-dropdown vector-page-titlebar-toc vector-button-flush-left">
	<input type="checkbox" id="vector-page-titlebar-toc-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-vector-page-titlebar-toc" class="vector-dropdown-checkbox " aria-label="Toggle the table of contents">
	<label id="vector-page-titlebar-toc-label" for="vector-page-titlebar-toc-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--icon-only " aria-hidden="true"><span class="vector-icon mw-ui-icon-listBullet mw-ui-icon-wikimedia-listBullet"></span>

<span class="vector-dropdown-label-text">Toggle the table of contents</span>
	</label>
	<div class="vector-dropdown-content">


							<div id="vector-page-titlebar-toc-unpinned-container" class="vector-unpinned-container">
			</div>
		
	</div>
</div>

					</nav>
					<h1 id="firstHeading" class="firstHeading mw-first-heading">nftables (Русский)</h1>
							
<div id="p-lang-btn" class="vector-dropdown mw-portlet mw-portlet-lang">
	<input type="checkbox" id="p-lang-btn-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-p-lang-btn" class="vector-dropdown-checkbox mw-interlanguage-selector" aria-label="Go to an article in another language. Available in 5 languages">
	<label id="p-lang-btn-label" for="p-lang-btn-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--action-progressive mw-portlet-lang-heading-5" aria-hidden="true"><span class="vector-icon mw-ui-icon-language-progressive mw-ui-icon-wikimedia-language-progressive"></span>

<span class="vector-dropdown-label-text">5 languages</span>
	</label>
	<div class="vector-dropdown-content">

		<div class="vector-menu-content">
			
			<ul class="vector-menu-content-list">
				
				<li class="interlanguage-link interwiki-de mw-list-item"><a href="https://wiki.archlinux.de/title/Nftables" title="Nftables – Deutsch" lang="de" hreflang="de" data-title="Nftables" data-language-autonym="Deutsch" data-language-local-name="Deutsch" class="interlanguage-link-target"><span>Deutsch</span></a></li>
<li class="interlanguage-link interwiki-en mw-list-item"><a href="../en/Nftables.html" title="Nftables – English" lang="en" hreflang="en" data-title="Nftables" data-language-autonym="English" data-language-local-name="English" class="interlanguage-link-target"><span>English</span></a></li>
<li class="interlanguage-link interwiki-es mw-list-item"><a href="../es/Nftables.html" title="Nftables – español" lang="es" hreflang="es" data-title="Nftables" data-language-autonym="Español" data-language-local-name="español" class="interlanguage-link-target"><span>Español</span></a></li>
<li class="interlanguage-link interwiki-ja mw-list-item"><a href="https://wiki.archlinux.jp/index.php/Nftables" title="Nftables – 日本語" lang="ja" hreflang="ja" data-title="Nftables" data-language-autonym="日本語" data-language-local-name="日本語" class="interlanguage-link-target"><span>日本語</span></a></li>
<li class="interlanguage-link interwiki-zh-hans mw-list-item"><a href="https://wiki.archlinuxcn.org/wiki/Nftables" title="Nftables – 中文（简体）" lang="zh-Hans" hreflang="zh-Hans" data-title="Nftables" data-language-autonym="中文（简体）" data-language-local-name="中文（简体）" class="interlanguage-link-target"><span>中文（简体）</span></a></li>
			</ul>
			
		</div>

	</div>
</div>
</header>
				<div class="vector-column-end">
					<div class="vector-sticky-pinned-container">
						<nav class="vector-page-tools-landmark" aria-label="Page tools">
							<div id="vector-page-tools-pinned-container" class="vector-pinned-container">
				
							</div>
		</nav>
						<nav class="vector-appearance-landmark" aria-label="Appearance">
							<div id="vector-appearance-pinned-container" class="vector-pinned-container">
				<div id="vector-appearance" class="vector-appearance vector-pinnable-element">
	<div class="vector-pinnable-header vector-appearance-pinnable-header vector-pinnable-header-pinned" data-feature-name="appearance-pinned" data-pinnable-element-id="vector-appearance" data-pinned-container-id="vector-appearance-pinned-container" data-unpinned-container-id="vector-appearance-unpinned-container">
	<div class="vector-pinnable-header-label">Appearance</div>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-pin-button" data-event-name="pinnable-header.vector-appearance.pin">move to sidebar</button>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-unpin-button" data-event-name="pinnable-header.vector-appearance.unpin">hide</button>
</div>


</div>

							</div>
		</nav>
					</div>
				</div>
				<div id="bodyContent" class="vector-body" aria-labelledby="firstHeading" data-mw-ve-target-container>
					<div class="vector-body-before-content">
							<div class="mw-indicators">
		</div>

						<div id="siteSub" class="noprint">From ArchWiki</div>
					</div>
					<div id="contentSub"><div id="mw-content-subtitle"></div></div>
					
					
					<div id="mw-content-text" class="mw-body-content">
<div class="mw-content-ltr mw-parser-output" lang="ru" dir="ltr">
<p><span>
</span>
</p>
<div class="archwiki-template-meta-related-articles">
<p>Ссылки по теме</p>
<ul>
<li><a href="../ru/Iptables.html" title="Iptables (Русский)">iptables (Русский)</a></li>
<li><a href="../en/Firewalld.html" title="Firewalld">Firewalld</a></li>
</ul>
</div>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Состояние перевода:</strong> На этой странице представлен перевод статьи <a href="../en/Nftables.html" title="Nftables">nftables</a>. Дата последней синхронизации: 11 июля 2021. Вы можете <a href="../ru/ArchWiki:Translation_Team.html" title="ArchWiki:Translation Team (Русский)">помочь</a> синхронизировать перевод, если в английской версии произошли <a rel="nofollow" class="external text" href="https://wiki.archlinux.org/index.php?title=Nftables&amp;diff=0&amp;oldid=687332">изменения</a>.</div>
<p><a rel="nofollow" class="external text" href="https://netfilter.org/projects/nftables/">nftables</a> — проект netfilter, разработанный для замены существующего фреймворка {ip,ip6,arp,eb}tables. Предоставляет новую систему фильтрации пакетов, пользовательскую утилиту ntf, а также слой совместимости с {ip,ip6}tables. nftables использует существующие хуки, отслеживание соединений, очереди в пространстве пользователя и подсистему логирования netfilter.
</p>
<p>nftables состоит из трёх основных частей: низкоуровневая реализация в ядре, библиотека libnl, которая обеспечивает <a href="https://en.wikipedia.org/wiki/Netlink" class="extiw" title="wikipedia:Netlink">netlink</a>-взаимодействие, и пользовательский фронтенд nftables. Ядро предоставляет интерфейс настройки netlink, а также занимается runtime-выполнением наборов правил. Библиотека libnl содержит низкоуровневые функции для взаимодействия с ядром. Фронтенд nftables — то, с чем пользователь взаимодействует утилитой nft.
</p>
<p>Подробную информацию о nftables можно найти на <a rel="nofollow" class="external text" href="https://wiki.nftables.org/wiki-nftables/index.php/Main_Page">вики-странице</a> проекта.
</p>
<meta property="mw:PageProp/toc">
<h2>
<span id=".D0.A3.D1.81.D1.82.D0.B0.D0.BD.D0.BE.D0.B2.D0.BA.D0.B0"></span><span class="mw-headline" id="Установка">Установка</span>
</h2>
<p><a href="../ru/Help:Reading.html#%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0_%D0%BF%D0%B0%D0%BA%D0%B5%D1%82%D0%BE%D0%B2" class="mw-redirect" title="Установите">Установите</a> пакет <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=nftables">nftables</a></span> или git-версию <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/nftables-git/">nftables-git</a></span><sup><small>AUR</small></sup>.
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Совет:</strong> Большинство <a href="../ru/Iptables.html#%D0%A4%D1%80%D0%BE%D0%BD%D1%82%D0%B5%D0%BD%D0%B4%D1%8B" title="Iptables (Русский)">фронтендов</a> iptables не предлагают прямой или косвенной поддержки nftables, хотя подобная возможность предусмотрена <a rel="nofollow" class="external autonumber" href="https://www.spinics.net/lists/netfilter/msg58215.html">[1]</a>. <a href="../en/Firewalld.html" title="Firewalld">firewalld</a> — единственный графический фронтенд со встроенной поддержкой как iptables, так и nftables <a rel="nofollow" class="external autonumber" href="https://firewalld.org/2018/07/nftables-backend">[2]</a>.</div>
<h2>
<span id=".D0.98.D1.81.D0.BF.D0.BE.D0.BB.D1.8C.D0.B7.D0.BE.D0.B2.D0.B0.D0.BD.D0.B8.D0.B5"></span><span class="mw-headline" id="Использование">Использование</span>
</h2>
<p>В nftables <b>не</b> различаются временные правила, добавленные из командной строки, и постоянные, загруженные из файла или сохранённые в файл.
</p>
<p>Все правила должны создаваться или загружаться утилитой <code>nft</code>. Подробнее о работе с ней см. раздел <a href="#%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0">#Настройка</a>.
</p>
<p>Текущий набор правил можно узнать командой:
</p>
<pre># nft list ruleset
</pre>
<h3>
<span id=".D0.9F.D1.80.D0.BE.D1.81.D1.82.D0.BE.D0.B9_.D0.BC.D0.B5.D0.B6.D1.81.D0.B5.D1.82.D0.B5.D0.B2.D0.BE.D0.B9_.D1.8D.D0.BA.D1.80.D0.B0.D0.BD"></span><span class="mw-headline" id="Простой_межсетевой_экран">Простой межсетевой экран</span>
</h3>
<p>В пакет <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=nftables">nftables</a></span> входит простая и надёжная конфигурация экрана, сохранённая в файле <code>/etc/nftables.conf</code>.
</p>
<p>Служба <code>nftables.service</code> загрузит эти правила при <a href="../ru/Help:Reading.html#%D0%A3%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5_%D1%8E%D0%BD%D0%B8%D1%82%D0%B0%D0%BC%D0%B8_systemd" class="mw-redirect" title="Запустите">запуске</a> или <a href="../ru/Help:Reading.html#%D0%A3%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5_%D1%8E%D0%BD%D0%B8%D1%82%D0%B0%D0%BC%D0%B8_systemd" class="mw-redirect" title="Включите">включении</a>.
</p>
<h2>
<span id=".D0.9D.D0.B0.D1.81.D1.82.D1.80.D0.BE.D0.B9.D0.BA.D0.B0"></span><span class="mw-headline" id="Настройка">Настройка</span>
</h2>
<p>Утилита nft выполняет большую часть обработки правил перед передачей их ядру. Правила объединяются в цепочки, которые, в свою очередь, входят в состав таблиц. В последующих разделах описано создание и модифицирование этих структур.
</p>
<p>Прочитать правила из файла можно с помощью опции <code>-f</code>/<code>--file</code>:
</p>
<pre># nft --file <i>имя-файла</i>
</pre>
<p>Обратите внимание, что уже загруженные на этот момент правила <b>не</b> будут при этом автоматически стёрты.
</p>
<p>Полный список команд можно найти в руководстве <span class="plainlinks archwiki-template-man" title="$ man 8 nft"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/nft.8">nft(8)</a></span>.
</p>
<h3>
<span id=".D0.A2.D0.B0.D0.B1.D0.BB.D0.B8.D1.86.D1.8B"></span><span class="mw-headline" id="Таблицы">Таблицы</span>
</h3>
<p>Таблицы содержат <a href="#%D0%A6%D0%B5%D0%BF%D0%BE%D1%87%D0%BA%D0%B8">#Цепочки</a>. В отличие от iptables, в nftables отсутствуют встроенные таблицы. Количество таблиц и их имена определяется пользователем. Тем не менее, каждая таблица имеет только одно семейство адресации и применяется к пакетам только этого семейства. Таблицы могут относиться к одному из пяти семейств.
</p>
<table class="wikitable">
<tbody>
<tr>
<th>семейство nftables</th>
<th>утилита iptables
</th>
</tr>
<tr>
<td>ip</td>
<td>iptables
</td>
</tr>
<tr>
<td>ip6</td>
<td>ip6tables
</td>
</tr>
<tr>
<td>inet</td>
<td>iptables и ip6tables
</td>
</tr>
<tr>
<td>arp</td>
<td>arptables
</td>
</tr>
<tr>
<td>bridge</td>
<td>ebtables
</td>
</tr>
</tbody>
</table>
<p><code>ip</code> (т.е. IPv4) — семейство по умолчанию; используется, если семейство не было указано.
</p>
<p>Семейство <code>inet</code> объединяет протоколы IPv4 и IPv6, что позволяет унифицировать семейства <code>ip</code> и <code>ip6</code> и упростить создание правил.
</p>
<p>Описание остальных семейств адресации вы найдёте в руководстве <span class="plainlinks archwiki-template-man" title="$ man 8 nft"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/nft.8#ADDRESS_FAMILIES">nft(8) § ADDRESS FAMILIES</a></span>.
</p>
<p>В командах ниже параметр <code><i>семейство</i></code> будет указываться не всегда; если его нет, то подразумевается семейство <code>ip</code>.
</p>
<h4>
<span id=".D0.A1.D0.BE.D0.B7.D0.B4.D0.B0.D0.BD.D0.B8.D0.B5_.D1.82.D0.B0.D0.B1.D0.BB.D0.B8.D1.86.D1.8B"></span><span class="mw-headline" id="Создание_таблицы">Создание таблицы</span>
</h4>
<p>Добавить новую таблицу:
</p>
<pre># nft add table <i>семейство</i> <i>таблица</i>
</pre>
<h4>
<span id=".D0.9F.D1.80.D0.BE.D1.81.D0.BC.D0.BE.D1.82.D1.80_.D1.82.D0.B0.D0.B1.D0.BB.D0.B8.D1.86"></span><span class="mw-headline" id="Просмотр_таблиц">Просмотр таблиц</span>
</h4>
<p>Вывести список таблиц:
</p>
<pre># nft list tables
</pre>
<h4>
<span id=".D0.9F.D1.80.D0.BE.D1.81.D0.BC.D0.BE.D1.82.D1.80_.D1.86.D0.B5.D0.BF.D0.BE.D1.87.D0.B5.D0.BA_.D0.B8_.D0.BF.D1.80.D0.B0.D0.B2.D0.B8.D0.BB_.D0.B2_.D1.82.D0.B0.D0.B1.D0.BB.D0.B8.D1.86.D0.B5"></span><span class="mw-headline" id="Просмотр_цепочек_и_правил_в_таблице">Просмотр цепочек и правил в таблице</span>
</h4>
<p>Вывести цепочки и правила выбранной таблицы:
</p>
<pre># nft list table <i>семейство</i> <i>таблица</i>
</pre>
<p>Например, чтобы вывести на экран правила таблицы <code>my_table</code> семейства <code>inet</code>, выполните команду:
</p>
<pre># nft list table inet my_table
</pre>
<h4>
<span id=".D0.A3.D0.B4.D0.B0.D0.BB.D0.B5.D0.BD.D0.B8.D0.B5_.D1.82.D0.B0.D0.B1.D0.BB.D0.B8.D1.86.D1.8B"></span><span class="mw-headline" id="Удаление_таблицы">Удаление таблицы</span>
</h4>
<p>Удалить таблицу со всеми цепочками:
</p>
<pre># nft delete table <i>семейство</i> <i>таблица</i>
</pre>
<h4>
<span id=".D0.9E.D1.87.D0.B8.D1.81.D1.82.D0.BA.D0.B0_.D1.82.D0.B0.D0.B1.D0.BB.D0.B8.D1.86.D1.8B"></span><span class="mw-headline" id="Очистка_таблицы">Очистка таблицы</span>
</h4>
<p>Стереть все правила в таблице:
</p>
<pre># nft flush table <i>семейство</i> <i>таблица</i>
</pre>
<h3>
<span id=".D0.A6.D0.B5.D0.BF.D0.BE.D1.87.D0.BA.D0.B8"></span><span class="mw-headline" id="Цепочки">Цепочки</span>
</h3>
<p>Цепочка содержит <a href="#%D0%9F%D1%80%D0%B0%D0%B2%D0%B8%D0%BB%D0%B0">#Правила</a>. В отличие от iptables, в nftables отсутствуют встроенные цепочки. Соответственно, если опрелённые типы или хуки фреймворка netfilter не задействованы ни в одной цепочке, то проходящие через эти цепочки пакеты обрабатываться не будут (в отличие от iptables).
</p>
<p>Есть два типа цепочек. <i>Базовая</i> цепочка является точкой входа для пакетов из сетевого стека; в ней указывается хук. <i>Обычная</i> цепочка может использоваться в качестве цели перехода и используется для лучшей организации правил.
</p>
<p>В командах ниже параметр <code><i>семейство</i></code> будет указываться не всегда; если его нет, то подразумевается семейство <code>ip</code>.
</p>
<h4>
<span id=".D0.A1.D0.BE.D0.B7.D0.B4.D0.B0.D0.BD.D0.B8.D0.B5_.D1.86.D0.B5.D0.BF.D0.BE.D1.87.D0.BA.D0.B8"></span><span class="mw-headline" id="Создание_цепочки">Создание цепочки</span>
</h4>
<h5>
<span id=".D0.9E.D0.B1.D1.8B.D1.87.D0.BD.D0.B0.D1.8F_.D1.86.D0.B5.D0.BF.D0.BE.D1.87.D0.BA.D0.B0"></span><span class="mw-headline" id="Обычная_цепочка">Обычная цепочка</span>
</h5>
<p>Добавить обычную цепочку <code><i>цепочка</i></code> в таблицу <code><i>таблица</i></code>:
</p>
<pre># nft add chain <i>семейство</i> <i>таблица</i> <i>цепочка</i>
</pre>
<p>Например, чтобы добавить обычную цепочку <code>my_tcp_chain</code> к таблице <code>my_table</code> семейства адресации <code>inet</code>, выполните:
</p>
<pre># nft add chain inet my_table my_tcp_chain
</pre>
<h5>
<span id=".D0.91.D0.B0.D0.B7.D0.BE.D0.B2.D0.B0.D1.8F_.D1.86.D0.B5.D0.BF.D0.BE.D1.87.D0.BA.D0.B0"></span><span class="mw-headline" id="Базовая_цепочка">Базовая цепочка</span>
</h5>
<p>Чтобы добавить базовую цепочку, укажите хук и значение приоритета:
</p>
<pre># nft add chain <i>семейство</i> <i>таблица</i> <i>цепочка</i> '{ type <i>тип</i> hook <i>хук</i> priority <i>приоритет</i> ; }'
</pre>
<p><code><i>тип</i></code> может принимать значения <code>filter</code>, <code>route</code> или <code>nat</code>.
</p>
<p>Для семейств адресации IPv4/IPv6/Inet <code><i>хук</i></code> может принимать значения <code>prerouting</code>, <code>input</code>, <code>forward</code>, <code>output</code> или <code>postrouting</code>. Описание других возможных хуков вы найдёте в руководстве <span class="plainlinks archwiki-template-man" title="$ man 8 nft"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/nft.8#ADDRESS_FAMILIES">nft(8) § ADDRESS FAMILIES</a></span>.
</p>
<p>Параметр <code><i>приоритет</i></code> задаётся названием приоритета или его численным значением (подробнее см. <span class="plainlinks archwiki-template-man" title="$ man 8 nft"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/nft.8#CHAINS">nft(8) § CHAINS</a></span>). Цепочки с более низкими значениями обрабатываются раньше. Значение приоритета может быть отрицательным <a rel="nofollow" class="external autonumber" href="https://wiki.nftables.org/wiki-nftables/index.php/Configuring_chains#Base_chain_types">[3]</a>.
</p>
<p>Например, добавим базовую цепочку для фильтрации входящих пакетов:
</p>
<pre># nft add chain inet my_table my_chain '{ type filter hook input priority 0; }'
</pre>
<p>Если заменить команду <code>add</code> на <code>create</code> в любом из правил выше, то цепочка тоже будет создана, но если цепочка с таким названием уже существует, то вы получите сообщение об ошибке.
</p>
<h4>
<span id=".D0.9F.D1.80.D0.BE.D1.81.D0.BC.D0.BE.D1.82.D1.80_.D0.BF.D1.80.D0.B0.D0.B2.D0.B8.D0.BB"></span><span class="mw-headline" id="Просмотр_правил">Просмотр правил</span>
</h4>
<p>Следующая команда выводит на экран все правила в цепочке:
</p>
<pre># nft list chain <i>семейство</i> <i>таблица</i> <i>цепочка</i>
</pre>
<p>Например, следующая команда выведет правила цепочки <code>my_output</code> таблицы <code>my_table</code> семейства <code>inet</code>:
</p>
<pre># nft list chain inet my_table my_output
</pre>
<h4>
<span id=".D0.98.D0.B7.D0.BC.D0.B5.D0.BD.D0.B5.D0.BD.D0.B8.D0.B5_.D1.86.D0.B5.D0.BF.D0.BE.D1.87.D0.BA.D0.B8"></span><span class="mw-headline" id="Изменение_цепочки">Изменение цепочки</span>
</h4>
<p>Для редактирования цепочки укажите её название и правила, которые нужно изменить:
</p>
<pre># nft chain <i>семейство таблица цепочка</i> '{ [ type <i>тип</i> hook <i>хук</i> device <i>устройство</i> priority <i>приоритет</i> ; policy <i>политика</i> ; ] }'
</pre>
<p>Например, для изменения политики обработки входящих пакетов цепочки исходной таблицы с <code>accept</code> на <code>drop</code> выполните команду:
</p>
<pre># nft chain inet my_table my_input '{ policy drop ; }'
</pre>
<h4>
<span id=".D0.A3.D0.B4.D0.B0.D0.BB.D0.B5.D0.BD.D0.B8.D0.B5_.D1.86.D0.B5.D0.BF.D0.BE.D1.87.D0.BA.D0.B8"></span><span class="mw-headline" id="Удаление_цепочки">Удаление цепочки</span>
</h4>
<p>Удалить цепочку:
</p>
<pre># nft delete chain <i>семейство</i> <i>таблица</i> <i>цепочка</i>
</pre>
<p>Цепочка должна быть пустой (не содержащей правил) и не должна быть целью перехода из другой цепочки.
</p>
<h4>
<span id=".D0.9E.D1.87.D0.B8.D1.81.D1.82.D0.BA.D0.B0_.D1.86.D0.B5.D0.BF.D0.BE.D1.87.D0.BA.D0.B8"></span><span class="mw-headline" id="Очистка_цепочки">Очистка цепочки</span>
</h4>
<p>Стереть все правила в цепочке:
</p>
<pre># nft flush chain <i>семейство</i> <i>таблица</i> <i>цепочка</i>
</pre>
<h3>
<span id=".D0.9F.D1.80.D0.B0.D0.B2.D0.B8.D0.BB.D0.B0"></span><span class="mw-headline" id="Правила">Правила</span>
</h3>
<p>Правила конструируются из выражений (expressions) и операторов (statements) и содержатся внутри цепочек.
</p>
<h4>
<span id=".D0.94.D0.BE.D0.B1.D0.B0.D0.B2.D0.BB.D0.B5.D0.BD.D0.B8.D0.B5_.D0.BF.D1.80.D0.B0.D0.B2.D0.B8.D0.BB.D0.B0"></span><span class="mw-headline" id="Добавление_правила">Добавление правила</span>
</h4>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Совет:</strong> Утилита <i>iptables-translate</i> поможет преобразовать правила <a href="../ru/Iptables.html" title="Iptables (Русский)">iptables</a> в формат nftables.</div>
<p>Добавить правило в цепочку:
</p>
<pre># nft add rule <i>семейство</i> <i>таблица</i> <i>цепочка</i> handle <i>маркер</i> <i>оператор</i>
</pre>
<p>Правило будет прикреплено после <code><i>маркер</i></code>, который можно не указывать. Если маркер (handle) не задать, то правило добавится в конец цепочки.
</p>
<p>Чтобы добавить правило перед определённой позицией, выполните
</p>
<pre># nft insert rule <i>семейство</i> <i>таблица</i> <i>цепочка</i> handle <i>маркер</i> <i>оператор</i>
</pre>
<p>Если <code><i>маркер</i></code> не указан, то правило добавится в начало цепочки.
</p>
<h5>
<span id=".D0.92.D1.8B.D1.80.D0.B0.D0.B6.D0.B5.D0.BD.D0.B8.D1.8F"></span><span class="mw-headline" id="Выражения">Выражения</span>
</h5>
<p>Обычно <code><i>оператор</i></code> включает некоторое выражение для сравнения и вынесения решения. Решениями могут быть <code>accept</code>, <code>drop</code>, <code>queue</code>, <code>continue</code>, <code>return</code>, <code>jump <i>цепочка</i></code> и <code>goto <i>цепочка</i></code>. Возможны и другие операторы помимо решений, подробнее смотрите <span class="plainlinks archwiki-template-man" title="$ man 8 nft"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/nft.8">nft(8)</a></span>.
</p>
<p>В nftables доступен ряд выражений, по большей части совпадающий с аналогичными в iptables. Наиболее важное отличие заключается в том, что здесь нет обобщённых или неявных параметров. Обобщённый параметр (generic match) обычно доступен для всех правил, например, параметры <code>--protocol</code> или <code>--source</code>. Неявные правила (implicit matches) относятся к конкретному протоколу, как параметр <code>--sport</code> для пакетов TCP.
</p>
<p>Ниже представлен неполный список возможных параметров:
</p>
<ul>
<li>meta    (метасущности, напр. интерфейсы)</li>
<li>icmp    (протокол ICMP)</li>
<li>icmpv6  (протокол ICMPv6)</li>
<li>ip      (протокол IP)</li>
<li>ip6     (протокол IPv6)</li>
<li>tcp     (протокол TCP)</li>
<li>udp     (протокол UDP)</li>
<li>sctp    (протокол SCTP)</li>
<li>ct      (отслеживание соединений)</li>
</ul>
<p>Ниже приведён неполный список аргументов для параметров (подробнее см. <span class="plainlinks archwiki-template-man" title="$ man 8 nft"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/nft.8">nft(8)</a></span>):
</p>
<pre>meta:
  oif &lt;интерфейс-отправитель НОМЕР&gt;
  iif &lt;интерфейс-получатель НОМЕР&gt;
  oifname &lt;интерфейс-отправитель ИМЯ&gt;
  iifname &lt;интерфейс-получатель ИМЯ&gt;

  (параметры oif и iif принимают строковые значения, которые конвертируются в номер)
  (параметры oifname и iifname более гибкие, но они медленнее из-за необходимости выполнять сравнение строк)

icmp:
  type &lt;тип icmp&gt;

icmpv6:
  type &lt;тип icmpv6&gt;

ip:
  protocol &lt;протокол&gt;
  daddr &lt;адрес получателя&gt;
  saddr &lt;адрес отправителя&gt;

ip6:
  daddr &lt;адрес получателя&gt;
  saddr &lt;адрес отправителя&gt;

tcp:
  dport &lt;порт получателя&gt;
  sport &lt;порт отправителя&gt;

udp:
  dport &lt;порт получателя&gt;
  sport &lt;порт отправителя&gt;

sctp:
  dport &lt;порт получателя&gt;
  sport &lt;порт отправителя&gt;

ct:
  state &lt;new | established | related | invalid&gt;
</pre>
<h4>
<span id=".D0.A3.D0.B4.D0.B0.D0.BB.D0.B5.D0.BD.D0.B8.D0.B5"></span><span class="mw-headline" id="Удаление">Удаление</span>
</h4>
<p>Отдельные правила могут быть удалены только с помощью маркера. Команда <code>nft --handle list</code> выведет список маркеров.
</p>
<p>Ниже приведён пример правила с маркером и команда для его удаления. Аргумент <code>--numeric</code> позволяет выводить IP-адреса в численном виде.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># nft --handle --numeric list chain inet my_table my_input</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">table inet my_table {
     chain my_input {
          type filter hook input priority 0;
          ip saddr 127.0.0.1 accept # handle 10
     }
}
</pre>
<pre># nft delete rule inet my_table my_input handle 10
</pre>
<p>Стирание всех цепочек таблицы выполняется командой <code>nft flush table</code>. Отдельные цепочки могут быть стёрты командами <code>nft flush chain</code> или <code>nft delete rule</code>.
</p>
<pre># nft flush table <i>таблица</i>
# nft flush chain <i>семейство</i> <i>таблица</i> <i>цепочка</i>
# nft delete rule <i>семейство</i> <i>таблица</i> <i>цепочка</i>
</pre>
<p>Первая команда стирает все цепочки в ip-таблице <code><i>таблица</i></code>. Вторая очищает цепочку <code><i>цепочка</i></code> в таблице <code><i>таблица</i></code> семейства <code><i>семейство</i></code>.  Третья удаляет все правила в цепочке <code><i>цепочка</i></code> в таблице <code><i>таблица</i></code> семейства <code><i>семейство</i></code>.
</p>
<h3>
<span id=".D0.9C.D0.BD.D0.BE.D0.B6.D0.B5.D1.81.D1.82.D0.B2.D0.B0"></span><span class="mw-headline" id="Множества">Множества</span>
</h3>
<p>Множества бывают <a rel="nofollow" class="external text" href="https://wiki.nftables.org/wiki-nftables/index.php/Sets">именованные и анонимные</a>. Множество объявляется фигурными скобками, в которых перечислены разделённые запятыми элементы. Анонимные множества "встраиваются" в правило и не могут быть изменены отдельно от него. Если множество необходимо модифицировать, то придётся удалить правило целиком и добавить его заново. Так, не получится удалить "http" из множества dport'ов в следующем правиле:
</p>
<pre># nft add rule ip6 filter input tcp dport {telnet, http, https} accept
</pre>
<p>Именованное множество можно изменить, а также присвоить ему тип и установить флаги. <i>sshguard</i> использует именованные множества для хранения адресов блокированных хостов.
</p>
<pre>table ip sshguard {
       set attackers {
               type ipv4_addr
               flags interval
               elements = { 1.2.3.4 }
       }
</pre>
<p>Команды для <i>добавления</i> и <i>удаления</i> элементов из множества:
</p>
<pre># nft add element ip sshguard attackers { 5.6.7.8/32 }
# nft delete element ip sshguard attackers { 1.2.3.4/32 }
</pre>
<p>Если множество имеет тип <i>ipv4_addr</i>, то помимо адреса можно указать маску сети (маска "/32" в примере не обязательна, но указана для большей ясности). Обращение к множеству из примера выше ("TABLE ip sshguard { SET attackers }") производится по имени <code>ip sshguard attackers</code>.
</p>
<h3>
<span id=".D0.9F.D0.BE.D0.BB.D0.BD.D0.B0.D1.8F_.D0.BF.D0.B5.D1.80.D0.B5.D0.B7.D0.B0.D0.B3.D1.80.D1.83.D0.B7.D0.BA.D0.B0_.D0.BF.D1.80.D0.B0.D0.B2.D0.B8.D0.BB"></span><span class="mw-headline" id="Полная_перезагрузка_правил">Полная перезагрузка правил</span>
</h3>
<p>Создать файл для новых правил:
</p>
<pre># echo "flush ruleset" &gt; /tmp/nftables 
</pre>
<p>Сбросить дамп правил в новый файл:
</p>
<pre># nft -s list ruleset &gt;&gt; /tmp/nftables
</pre>
<p>Теперь можно редактировать файл <code>/tmp/nftables</code>, создавая и изменяя правила. Применить изменения можно командой:
</p>
<pre># nft -f /tmp/nftables
</pre>
<h2>
<span id=".D0.9F.D1.80.D0.B8.D0.BC.D0.B5.D1.80.D1.8B"></span><span class="mw-headline" id="Примеры">Примеры</span>
</h2>
<h3>
<span id=".D0.A0.D0.B0.D0.B1.D0.BE.D1.87.D0.B0.D1.8F_.D1.81.D1.82.D0.B0.D0.BD.D1.86.D0.B8.D1.8F"></span><span class="mw-headline" id="Рабочая_станция">Рабочая станция</span>
</h3>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/nftables.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">flush ruleset

table inet my_table {
	set LANv4 {
		type ipv4_addr
		flags interval

		elements = { 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16, 169.254.0.0/16 }
	}
	set LANv6 {
		type ipv6_addr
		flags interval

		elements = { fd00::/8, fe80::/10 }
	}

	chain my_input_lan {
		udp sport 1900 udp dport &gt;= 1024 meta pkttype unicast limit rate 4/second burst 20 packets accept comment "Accept UPnP IGD port mapping reply"

		udp sport netbios-ns udp dport &gt;= 1024 meta pkttype unicast accept comment "Accept Samba Workgroup browsing replies"

	}

	chain my_input {
		type filter hook input priority filter; policy drop;

		iif lo accept comment "Accept any localhost traffic"
		ct state invalid drop comment "Drop invalid connections"
		ct state established,related accept comment "Accept traffic originated from us"

		meta l4proto ipv6-icmp icmpv6 type { destination-unreachable, packet-too-big, time-exceeded, parameter-problem, mld-listener-query, mld-listener-report, mld-listener-reduction, nd-router-solicit, nd-router-advert, nd-neighbor-solicit, nd-neighbor-advert, ind-neighbor-solicit, ind-neighbor-advert, mld2-listener-report } accept comment "Accept ICMPv6"
		meta l4proto icmp icmp type { destination-unreachable, router-solicitation, router-advertisement, time-exceeded, parameter-problem } accept comment "Accept ICMP"
		ip protocol igmp accept comment "Accept IGMP"

		udp dport mdns ip6 daddr ff02::fb accept comment "Accept mDNS"
		udp dport mdns ip daddr 224.0.0.251 accept comment "Accept mDNS"

		ip6 saddr @LANv6 jump my_input_lan comment "Connections from private IP address ranges"
		ip saddr @LANv4 jump my_input_lan comment "Connections from private IP address ranges"

		counter comment "Count any other traffic"
	}

	chain my_forward {
		type filter hook forward priority filter; policy drop;
		# Drop everything forwarded to us. We do not forward. That is routers job.
	}

	chain my_output {
		type filter hook output priority filter; policy accept;
		# Accept every outbound connection
	}

}
</pre>
<h3>
<span id=".D0.A1.D0.B5.D1.80.D0.B2.D0.B5.D1.80"></span><span class="mw-headline" id="Сервер">Сервер</span>
</h3>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/nftables.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">flush ruleset

table inet my_table {
	set LANv4 {
		type ipv4_addr
		flags interval

		elements = { 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16, 169.254.0.0/16 }
	}
	set LANv6 {
		type ipv6_addr
		flags interval

		elements = { fd00::/8, fe80::/10 }
	}

	chain my_input_lan {
		meta l4proto { tcp, udp } th dport 2049 accept comment "Accept NFS"

		udp dport netbios-ns accept comment "Accept NetBIOS Name Service (nmbd)"
		udp dport netbios-dgm accept comment "Accept NetBIOS Datagram Service (nmbd)"
		tcp dport netbios-ssn accept comment "Accept NetBIOS Session Service (smbd)"
		tcp dport microsoft-ds accept comment "Accept Microsoft Directory Service (smbd)"

		udp sport { bootpc, 4011 } udp dport { bootps, 4011 } accept comment "Accept PXE"
		udp dport tftp accept comment "Accept TFTP"
	}

	chain my_input {
		type filter hook input priority filter; policy drop;

		iif lo accept comment "Accept any localhost traffic"
		ct state invalid drop comment "Drop invalid connections"
		ct state established,related accept comment "Accept traffic originated from us"

		meta l4proto ipv6-icmp icmpv6 type { destination-unreachable, packet-too-big, time-exceeded, parameter-problem, mld-listener-query, mld-listener-report, mld-listener-reduction, nd-router-solicit, nd-router-advert, nd-neighbor-solicit, nd-neighbor-advert, ind-neighbor-solicit, ind-neighbor-advert, mld2-listener-report } accept comment "Accept ICMPv6"
		meta l4proto icmp icmp type { destination-unreachable, router-solicitation, router-advertisement, time-exceeded, parameter-problem } accept comment "Accept ICMP"
		ip protocol igmp accept comment "Accept IGMP"

		udp dport mdns ip6 daddr ff02::fb accept comment "Accept mDNS"
		udp dport mdns ip daddr 224.0.0.251 accept comment "Accept mDNS"

		ip6 saddr @LANv6 jump my_input_lan comment "Connections from private IP address ranges"
		ip saddr @LANv4 jump my_input_lan comment "Connections from private IP address ranges"

		tcp dport ssh accept comment "Accept SSH on port 22"

		tcp dport ipp accept comment "Accept IPP/IPPS on port 631"

		tcp dport { http, https, 8008, 8080 } accept comment "Accept HTTP (ports 80, 443, 8008, 8080)"

		udp sport bootpc udp dport bootps ip saddr 0.0.0.0 ip daddr 255.255.255.255 accept comment "Accept DHCPDISCOVER (for DHCP-Proxy)"
	}

	chain my_forward {
		type filter hook forward priority filter; policy drop;
		# Drop everything forwarded to us. We do not forward. That is routers job.
	}

	chain my_output {
		type filter hook output priority filter; policy accept;
		# Accept every outbound connection
	}

}
</pre>
<h3>
<span id=".D0.9E.D0.B3.D1.80.D0.B0.D0.BD.D0.B8.D1.87.D0.B5.D0.BD.D0.B8.D0.B5_.D1.81.D0.BA.D0.BE.D1.80.D0.BE.D1.81.D1.82.D0.B8_.D0.BF.D0.B5.D1.80.D0.B5.D0.B4.D0.B0.D1.87.D0.B8"></span><span class="mw-headline" id="Ограничение_скорости_передачи">Ограничение скорости передачи</span>
</h3>
<pre>table inet my_table {
	chain my_input {
		type filter hook input priority filter; policy drop;

		iif lo accept comment "Accept any localhost traffic"
		ct state invalid drop comment "Drop invalid connections"

		meta l4proto icmp icmp type echo-request limit rate over 10/second burst 4 packets drop comment "No ping floods"
		meta l4proto ipv6-icmp icmpv6 type echo-request limit rate over 10/second burst 4 packets drop comment "No ping floods"

		ct state established,related accept comment "Accept traffic originated from us"

		meta l4proto ipv6-icmp icmpv6 type { destination-unreachable, packet-too-big, time-exceeded, parameter-problem, mld-listener-query, mld-listener-report, mld-listener-reduction, nd-router-solicit, nd-router-advert, nd-neighbor-solicit, nd-neighbor-advert, ind-neighbor-solicit, ind-neighbor-advert, mld2-listener-report } accept comment "Accept ICMPv6"
		meta l4proto icmp icmp type { destination-unreachable, router-solicitation, router-advertisement, time-exceeded, parameter-problem } accept comment "Accept ICMP"
		ip protocol igmp accept comment "Accept IGMP"

		tcp dport ssh ct state new limit rate 15/minute accept comment "Avoid brute force on SSH"

	}

}
</pre>
<h3>
<span id=".D0.9F.D0.B5.D1.80.D0.B5.D1.85.D0.BE.D0.B4"></span><span class="mw-headline" id="Переход">Переход</span>
</h3>
<p>Если вы используете переходы (jumps), то целевая цепочка должна быть описана до перехода. Иначе будет получена ошибка <code>Error: Could not process rule: No such file or directory</code>.
</p>
<pre>table inet my_table {
    chain web {
        tcp dport http accept
        tcp dport 8080 accept
    }
    chain my_input {
        type filter hook input priority filter;
        ip saddr 10.0.2.0/24 jump web
        drop
    }
}
</pre>
<h3>
<span id=".D0.9D.D0.B5.D1.81.D0.BA.D0.BE.D0.BB.D1.8C.D0.BA.D0.BE_.D1.81.D0.B5.D1.82.D0.B5.D0.B2.D1.8B.D1.85_.D0.B8.D0.BD.D1.82.D0.B5.D1.80.D1.84.D0.B5.D0.B9.D1.81.D0.BE.D0.B2_.D1.81_.D1.80.D0.B0.D0.B7.D0.BD.D1.8B.D0.BC.D0.B8_.D0.BF.D1.80.D0.B0.D0.B2.D0.B8.D0.BB.D0.B0.D0.BC.D0.B8"></span><span class="mw-headline" id="Несколько_сетевых_интерфейсов_с_разными_правилами">Несколько сетевых интерфейсов с разными правилами</span>
</h3>
<p>Если у вашей системы несколько сетевых интерфейсов и вы хотите использовать для них разные наборы правил, то создайте фильтрующую цепочку-диспетчер, а после неё опишите цепочки для сетевых интерфейсов. Например, пусть ваша машина выступает в качестве домашнего маршрутизатора и вы желаете запустить веб-сервер, доступный по локальной сети (интерфейс <code>enp3s0</code>), но не из публичного интернета (интерфейс <code>enp2s0</code>). Создайте таблицу вроде этой:
</p>
<pre>table inet my_table {
  chain my_input { # this chain serves as a dispatcher
    type filter hook input priority filter;

    iif lo accept # always accept loopback
    iifname enp2s0 jump my_input_public
    iifname enp3s0 jump my_input_private

    reject with icmpx type port-unreachable # refuse traffic from all other interfaces
  }
  chain my_input_public { # rules applicable to public interface interface
    ct state {established,related} accept
    ct state invalid drop
    udp dport bootpc accept
    tcp dport bootpc accept
    reject with icmpx type port-unreachable # all other traffic
  }
  chain my_input_private {
    ct state {established,related} accept
    ct state invalid drop
    udp dport bootpc accept
    tcp dport bootpc accept
    tcp port http accept
    tcp port https accept
    reject with icmpx type port-unreachable # all other traffic
  }
  chain my_output { # we let everything out
    type filter hook output priority filter;
    accept
  }
}
</pre>
<p>Можно поступить иначе - задать только одну строку <code>iifname</code>, например для интерфейса веб-сервера, а правила для остальных интерфейсов вместо диспетчеризации описать в одном месте.
</p>
<h3>
<span id=".D0.9C.D0.B0.D1.81.D0.BA.D0.B0.D1.80.D0.B0.D0.B4.D0.B8.D0.BD.D0.B3"></span><span class="mw-headline" id="Маскарадинг">Маскарадинг</span>
</h3>
<p>В nftables есть специальное ключевое слово <code>masquerade</code>, "позволяющее автоматически изменять адрес источника на адрес интерфейса-отправителя" <a rel="nofollow" class="external autonumber" href="https://wiki.nftables.org/wiki-nftables/index.php/Performing_Network_Address_Translation_%28NAT%29#Masquerading">[4]</a>. Это особенно удобно в ситуациях, когда IP-адрес интерфейса непредсказуем или нестабилен — например, исходящий интерфейс маршрутизатора, подключённого к нескольким интернет-провайдерам. <a href="https://en.wikipedia.org/wiki/ru:%D0%9C%D0%B0%D1%81%D0%BA%D0%B0%D1%80%D0%B0%D0%B4%D0%B8%D0%BD%D0%B3" class="extiw" title="wikipedia:ru:Маскарадинг">Маскарадинг</a> позволяет не переписывать правила межсетевого экрана для трансляции сетевых адресов (NAT) при каждом изменении IP-адреса интерфейса.
</p>
<p>Правила работы маскарадинга:
</p>
<ul>
<li>опция <code>masquerading</code> в ядре Linux должна быть включена (в стандартном ядре она включена по умолчанию); в противном случае задайте параметр ядра <code>CONFIG_NFT_MASQ=m</code>.</li>
<li>ключевое слово <code>masquerade</code> может использоваться только в цепочке типа <code>nat</code>.</li>
<li>masquerading является подвидом <a href="https://en.wikipedia.org/wiki/Network_Address_Translation#SNAT" class="extiw" title="wikipedia:Network Address Translation">SNAT</a>, поэтому работает только для исходящих пакетов.</li>
</ul>
<p>Пример правил межсетевого экрана для машины с двумя интерфейсами, локальным <code>enp3s0</code> и публичным <code>enp2s0</code>:
</p>
<pre>table inet my_nat {
  chain my_masquerade {
    type nat hook postrouting priority srcnat;
    oifname "enp2s0" masquerade
  }
}
</pre>
<p>Поскольку таблица выше относится к типу <code>inet</code>, то маскарадингу подвергаются пакеты и IPv4, и IPv6. Чтобы ограничить маскарадинг только IPv4-пакетами (т.к. у IPv6 большое пространство адресов и NAT не требуется) либо добавьте выражение <code>meta nfproto ipv4</code> перед <code>oifname "enp2s0" masquerade</code>, либо измените тип таблицы на <code>ip</code>.
</p>
<h3>
<span id="NAT_.D1.81_.D0.BF.D1.80.D0.BE.D0.B1.D1.80.D0.BE.D1.81.D0.BE.D0.BC_.D0.BF.D0.BE.D1.80.D1.82.D0.BE.D0.B2"></span><span class="mw-headline" id="NAT_с_пробросом_портов">NAT с пробросом портов</span>
</h3>
<p>Ниже приведён пример проброса портов 22 и 80 на адрес <code><i>ip-адрес_получателя</i></code>. Необходимо предварительно с помощью <a href="../en/Sysctl.html" title="Sysctl">sysctl</a> установить параметры <code>net.ipv4.ip_forward</code> и <code>net.ipv4.conf.<i>wan_интерфейс</i>.forwarding</code> на <code>1</code>.
</p>
<pre>table ip my_nat {
  chain my_prerouting {
    type nat hook prerouting priority dstnat;

    tcp dport { ssh, http } dnat to <i>destination_ip</i>
  }

  chain my_postrouting {
    type nat hook postrouting priority srcnat;

    ip daddr <i>destination_ip</i> masquerade
  }
}
</pre>
<h3>
<span id=".D0.A1.D1.87.D1.91.D1.82.D1.87.D0.B8.D0.BA_.D0.BD.D0.BE.D0.B2.D1.8B.D1.85_.D1.81.D0.BE.D0.B5.D0.B4.D0.B8.D0.BD.D0.B5.D0.BD.D0.B8.D0.B9"></span><span class="mw-headline" id="Счётчик_новых_соединений">Счётчик новых соединений</span>
</h3>
<p>Следующий сниппет позволяет считать открытые HTTPS-соединения:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/nftables.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">table inet filter {
    set https {
        type ipv4_addr;
        flags dynamic;
        size 65536;
        timeout 60m;
    }

    chain input {
        type filter hook input priority filter;
        ct state new tcp dport 443 update @https { ip saddr counter }
    }
}
</pre>
<p>Текущее значение счётчика можно вывести командой <code>nft list set inet filter https</code>.
</p>
<h3>
<span id=".D0.94.D0.B8.D0.BD.D0.B0.D0.BC.D0.B8.D1.87.D0.B5.D1.81.D0.BA.D0.B0.D1.8F_.D0.B1.D0.BB.D0.BE.D0.BA.D0.B8.D1.80.D0.BE.D0.B2.D0.BA.D0.B0"></span><span class="mw-headline" id="Динамическая_блокировка">Динамическая блокировка</span>
</h3>
<p>Следующий сниппет позволяет в течение минуты отклонять все HTTPS-соединения от адресов, которые превысили лимит в 10 запросов на соединение в секунду:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/nftables.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">table inet dev {
    set blackhole {
        type ipv4_addr;
        flags dynamic, timeout;
        size 65536;
    }

    chain input {
        ct state new tcp dport 443 \
                meter flood size 128000 { ip saddr timeout 10s limit rate over 10/second } \
                add @blackhole { ip saddr timeout 1m }

        ip saddr @blackhole counter drop
    }
}
</pre>
<p>Для вывода заблокированных адресов выполните <code>nft list set inet dev blackhole</code>.
</p>
<h2>
<span id=".D0.A1.D0.BE.D0.B2.D0.B5.D1.82.D1.8B_.D0.B8_.D1.80.D0.B5.D0.BA.D0.BE.D0.BC.D0.B5.D0.BD.D0.B4.D0.B0.D1.86.D0.B8.D0.B8"></span><span class="mw-headline" id="Советы_и_рекомендации">Советы и рекомендации</span>
</h2>
<h3>
<span id=".D0.A1.D0.BE.D1.85.D1.80.D0.B0.D0.BD.D0.B5.D0.BD.D0.B8.D0.B5_.D1.82.D0.B5.D0.BA.D1.83.D1.89.D0.B5.D0.B3.D0.BE_.D0.BD.D0.B0.D0.B1.D0.BE.D1.80.D0.B0_.D0.BF.D1.80.D0.B0.D0.B2.D0.B8.D0.BB"></span><span class="mw-headline" id="Сохранение_текущего_набора_правил">Сохранение текущего набора правил</span>
</h3>
<p>Вывод команды <code>nft list ruleset</code> можно использовать в качестве входных данных для других команд. Текущий набор правил можно сохранить в файл, а позже — загрузить их из него.
</p>
<pre># nft -s list ruleset | tee <i>название_файла</i>
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Примечание:</strong> Команда <code>nft list</code> не выводит определения переменных. Если в файле <code>/etc/nftables.conf</code> есть какие-либо переменные, то в выводе команды вы их не увидите — все переменные будут заменены на значения.
</div>
<h3>
<span id=".D0.9D.D0.B0.D1.81.D1.82.D1.80.D0.BE.D0.B9.D0.BA.D0.B0_.D0.BC.D0.B5.D0.B6.D1.81.D0.B5.D1.82.D0.B5.D0.B2.D0.BE.D0.B3.D0.BE_.D1.8D.D0.BA.D1.80.D0.B0.D0.BD.D0.B0"></span><span class="mw-headline" id="Настройка_межсетевого_экрана">Настройка межсетевого экрана</span>
</h3>
<p>См. также <a href="../ru/Simple_stateful_firewall.html" class="mw-redirect" title="Настройка межсетевого экрана">Настройка межсетевого экрана</a>.
</p>
<h4>
<span id=".D0.9E.D0.B4.D0.B8.D0.BD.D0.BE.D1.87.D0.BD.D0.B0.D1.8F_.D0.BC.D0.B0.D1.88.D0.B8.D0.BD.D0.B0"></span><span class="mw-headline" id="Одиночная_машина">Одиночная машина</span>
</h4>
<p>Сотрите текущий набор правил:
</p>
<pre># nft flush ruleset
</pre>
<p>Добавьте таблицу:
</p>
<pre># nft add table inet my_table
</pre>
<p>Добавьте базовые цепочки input, forward и output. Политика для входящих и пересылаемых пакетов должна быть drop. Политика для исходящих пакетов — accept.
</p>
<pre># nft add chain inet my_table my_input '{ type filter hook input priority 0 ; policy drop ; }'
# nft add chain inet my_table my_forward '{ type filter hook forward priority 0 ; policy drop ; }'
# nft add chain inet my_table my_output '{ type filter hook output priority 0 ; policy accept ; }'
</pre>
<p>Добавьте две обычные цепочки, которые будут обрабатывать пакеты протоколов TCP и UDP:
</p>
<pre># nft add chain inet my_table my_tcp_chain
# nft add chain inet my_table my_udp_chain
</pre>
<p>Разрешите related и established трафик:
</p>
<pre># nft add rule inet my_table my_input ct state related,established accept
</pre>
<p>Разрешите трафик на петлевой интерфейс:
</p>
<pre># nft add rule inet my_table my_input iif lo accept
</pre>
<p>Заблокируйте invalid трафик:
</p>
<pre># nft add rule inet my_table my_input ct state invalid drop
</pre>
<p>Разрешите пакеты ICMP и IGMP:
</p>
<pre># nft add rule inet my_table my_input meta l4proto ipv6-icmp icmpv6 type '{ destination-unreachable, packet-too-big, time-exceeded, parameter-problem, mld-listener-query, mld-listener-report, mld-listener-reduction, nd-router-solicit, nd-router-advert, nd-neighbor-solicit, nd-neighbor-advert, ind-neighbor-solicit, ind-neighbor-advert, mld2-listener-report }' accept
# nft add rule inet my_table my_input meta l4proto icmp icmp type '{ destination-unreachable, router-solicitation, router-advertisement, time-exceeded, parameter-problem }' accept
# nft add rule inet my_table my_input ip protocol igmp accept
</pre>
<p>Новый UDP-трафик будет передаваться цепочке <code>my_udp_chain</code>:
</p>
<pre># nft add rule inet my_table my_input meta l4proto udp ct state new jump my_udp_chain
</pre>
<p>Новый TCP-трафик будет передаваться цепочке <code>my_tcp_chain</code>:
</p>
<pre># nft add rule inet my_table my_input 'meta l4proto tcp tcp flags &amp; (fin|syn|rst|ack) == syn ct state new jump my_tcp_chain'
</pre>
<p>Заблокировать весь трафик, который не обрабатывается другими правилами:
</p>
<pre># nft add rule inet my_table my_input meta l4proto udp reject
# nft add rule inet my_table my_input meta l4proto tcp reject with tcp reset
# nft add rule inet my_table my_input counter reject with icmpx type port-unreachable
</pre>
<p>В этом месте необходимо выбрать, какие порты будут оставаться открытыми для входящих соединений, обрабатываемых цепочками <code>my_tcp_chain</code> и <code>my_udp_chain</code>. Например, открыть соединения для веб-сервера:
</p>
<pre># nft add rule inet my_table my_tcp_chain tcp dport 80 accept
</pre>
<p>Разрешить HTTPS-соединения для веб-сервера на порте 443:
</p>
<pre># nft add rule inet my_table my_tcp_chain tcp dport 443 accept
</pre>
<p>Разрешить SSH-трафик на порт 22:
</p>
<pre># nft add rule inet my_table my_tcp_chain tcp dport 22 accept
</pre>
<p>Разрешить входящие DNS-запросы:
</p>
<pre># nft add rule inet my_table my_tcp_chain tcp dport 53 accept
# nft add rule inet my_table my_udp_chain udp dport 53 accept
</pre>
<p>В конце не забудьте сохранить набор правил, чтобы они стали постоянными.
</p>
<h3>
<span id=".D0.9F.D1.80.D0.B5.D0.B4.D0.BE.D1.82.D0.B2.D1.80.D0.B0.D1.89.D0.B5.D0.BD.D0.B8.D0.B5_.D0.B0.D1.82.D0.B0.D0.BA_.D0.BF.D0.B5.D1.80.D0.B5.D0.B1.D0.BE.D1.80.D0.BE.D0.BC"></span><span class="mw-headline" id="Предотвращение_атак_перебором">Предотвращение атак перебором</span>
</h3>
<p><a href="../en/Sshguard.html" title="Sshguard">Sshguard</a> может обнаруживать атаки перебором и модифицировать сетевые экраны, временно помещая IP-адреса в чёрный список. Описание настройки nftables для работы с sshguard можно найти в статье <a href="../en/Sshguard.html#nftables" title="Sshguard">Sshguard#nftables</a>.
</p>
<h3>
<span id=".D0.96.D1.83.D1.80.D0.BD.D0.B0.D0.BB.D0.B8.D1.80.D0.BE.D0.B2.D0.B0.D0.BD.D0.B8.D0.B5_.D1.82.D1.80.D0.B0.D1.84.D0.B8.D0.BA.D0.B0"></span><span class="mw-headline" id="Журналирование_трафика">Журналирование трафика</span>
</h3>
<p>Действие <code>log</code> позволяет вести журнал пакетов. Простейшее правило для сохранения информации обо всём поступающем трафике:
</p>
<pre># nft add rule inet filter input log
</pre>
<p>Подробнее см. <a rel="nofollow" class="external text" href="https://wiki.nftables.org/wiki-nftables/index.php/Logging_traffic">nftables wiki</a>.
</p>
<h2>
<span id=".D0.A0.D0.B5.D1.88.D0.B5.D0.BD.D0.B8.D0.B5_.D0.BF.D1.80.D0.BE.D0.B1.D0.BB.D0.B5.D0.BC"></span><span class="mw-headline" id="Решение_проблем">Решение проблем</span>
</h2>
<h3>
<span id=".D0.A0.D0.B0.D0.B1.D0.BE.D1.82.D0.B0_.D1.81_Docker"></span><span class="mw-headline" id="Работа_с_Docker">Работа с Docker</span>
</h3>
<p><i>nftables</i> может создавать помехи сетевой работе контейнеров <a href="../ru/Docker.html" title="Docker (Русский)">Docker</a> (возможно, и другим средствам виртуализации тоже). В частности, политика <code>drop</code> цепочки <code>forward</code> блокирует пакеты, источником которых является docker. Если вы не хотите удалять эту цепочку, то сделайте следующее:
</p>
<ol>
<li>
<a href="../ru/Help:Reading.html#%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0_%D0%BF%D0%B0%D0%BA%D0%B5%D1%82%D0%BE%D0%B2" class="mw-redirect" title="Установите">Установите</a> пакет <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=iptables-nft">iptables-nft</a></span>; он содержит iptables-совместимый интерфейс nftables, который docker сможет использовать.</li>
<li>Модифицируйте цепочку <code>forward</code> таблицы <code>inet</code>:
<dl><dd><pre>chain forward {
  type filter hook forward priority security; policy drop;
  mark 1 accept
}
</pre></dd></dl>
</li>
<li>Добавьте цепочку DOCKER-USER в таблицу <code>ip filter</code>, чтобы помечать (mark) пакеты docker:
<dl><dd><pre>table ip filter {
  chain DOCKER-USER {
    mark set 1
  }
}
</pre></dd></dl>
</li>
</ol>
<p>Теперь сгенерированные контейнером docker пакеты будут маркироваться и пересылаться дальше, поскольку docker уже их отфильтровал (цепочка <code>forward</code> в docker использует политику <code>drop</code>).
</p>
<h2>
<span id=".D0.A1.D0.BC.D0.BE.D1.82.D1.80.D0.B8.D1.82.D0.B5_.D1.82.D0.B0.D0.BA.D0.B6.D0.B5"></span><span class="mw-headline" id="Смотрите_также">Смотрите также</span>
</h2>
<ul>
<li>
<a rel="nofollow" class="external text" href="https://wiki.nftables.org/">netfilter nftables</a> — документация от разработчиков проекта netfilter</li>
<li>
<a href="https://wiki.debian.org/nftables" class="extiw" title="debian:nftables">debian:nftables</a> — статья на Debian-wiki</li>
<li>
<a href="https://wiki.gentoo.org/wiki/nftables" class="extiw" title="gentoo:nftables">gentoo:nftables</a> — статья на Gentoo-wiki</li>
<li>
<a rel="nofollow" class="external text" href="https://lwn.net/Articles/324251/">First release of nftables</a>  — выход nftables (2009)</li>
<li>
<a rel="nofollow" class="external text" href="https://home.regit.org/netfilter-en/nftables-quick-howto/">nftables quick howto</a> — советы и подсказки</li>
<li>
<a rel="nofollow" class="external text" href="https://lwn.net/Articles/564095/">The return of nftables</a> — обновление nftables (2013)</li>
<li>
<a rel="nofollow" class="external text" href="https://developers.redhat.com/blog/2016/10/28/what-comes-after-iptables-its-successor-of-course-nftables/">What comes after "iptables"?</a> — nftables со временем заменит iptables</li>
</ul>
</div>
</div>
					<div id="catlinks" class="catlinks" data-mw="interface"><div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../Special:Categories.html" title="Special:Categories">Category</a>: <ul><li><a href="../ru/Category:Firewalls.html" title="Category:Firewalls (Русский)">Firewalls (Русский)</a></li></ul>
</div></div>
				</div>
			</main>
			
		</div>
		<div class="mw-footer-container">
			
<footer id="footer" class="mw-footer" style="margin: 0">
	<ul id="footer-info">
	<li data-nosnippet="">Retrieved from "<a dir="ltr" href="https://wiki.archlinux.org/index.php?title=Nftables_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)&amp;oldid=769264">https://wiki.archlinux.org/index.php?title=Nftables_(Русский)&amp;oldid=769264</a>"</li>
<li id="footer-info-lastmod"> This page was last edited on 25 February 2023, at 06:31.</li>
	<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="https://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.3 or later</a> unless otherwise noted.</li>
<br>
</ul>

	<ul id="footer-places">
	<li id="footer-places-privacy"><a href="https://terms.archlinux.org/docs/privacy-policy/">Privacy policy</a></li>
	<li id="footer-places-about"><a href="../en/ArchWiki:About.html">About ArchWiki</a></li>
	<li id="footer-places-disclaimers"><a href="../en/ArchWiki:General_disclaimer.html">Disclaimers</a></li>
	<li id="footer-places-archwiki-code-of-conduct"><a href="https://terms.archlinux.org/docs/code-of-conduct/" class="extiw" title="archlinux-service-agreements:code-of-conduct">Code of conduct</a></li>
	<li id="footer-places-archwiki-terms-of-service"><a href="https://terms.archlinux.org/docs/terms-of-service/" class="extiw" title="archlinux-service-agreements:terms-of-service">Terms of service</a></li>
</ul>

	<ul id="footer-icons" class="noprint">
	<li id="footer-copyrightico"><a href="https://www.gnu.org/copyleft/fdl.html" class="cdx-button cdx-button--fake-button cdx-button--size-large cdx-button--fake-button--enabled"><img src="/resources/assets/licenses/gnu-fdl.png" alt="GNU Free Documentation License 1.3 or later" width="88" height="31" loading="lazy"></a></li>
	<li id="footer-poweredbyico"><img src="/resources/assets/poweredby_mediawiki.svg" width="88" height="31" loading="lazy"></li>
</ul>

</footer>

		</div>
	</div> 
</div> 
<div class="vector-settings" id="p-dock-bottom">
	<ul></ul>
</div>
</body>
</html>
