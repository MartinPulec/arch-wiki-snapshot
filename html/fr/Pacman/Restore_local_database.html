<!DOCTYPE html>
<html class="client-nojs vector-feature-language-in-header-enabled vector-feature-language-in-main-page-header-disabled vector-feature-sticky-header-disabled vector-feature-page-tools-pinned-disabled vector-feature-toc-pinned-clientpref-1 vector-feature-main-menu-pinned-disabled vector-feature-limited-width-clientpref-1 vector-feature-limited-width-content-enabled vector-feature-custom-font-size-clientpref-0 vector-feature-client-preferences-disabled vector-feature-client-prefs-pinned-disabled vector-feature-night-mode-disabled skin-theme-clientpref-day vector-toc-available" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>pacman (Français)/Restore local database (Français) - ArchWiki</title>
<link rel="stylesheet" href="../../ArchWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<meta name="generator" content="MediaWiki 1.42.1">
<meta name="referrer" content="no-referrer-when-downgrade">
<meta name="robots" content="max-image-preview:standard">
<meta name="format-detection" content="telephone=no">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=0.25, maximum-scale=5.0">
<link rel="icon" href="/favicon.ico">
<link rel="search" type="application/opensearchdescription+xml" href="/opensearch_desc.php" title="ArchWiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.archlinux.org/api.php?action=rsd">
<link rel="license" href="https://www.gnu.org/copyleft/fdl.html">
<link rel="alternate" type="application/atom+xml" title="ArchWiki Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="skin-vector skin-vector-search-vue mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-Pacman_Français_Restore_local_database_Français rootpage-Pacman_Français skin-vector-2022 action-view skin--responsive">
<a class="mw-jump-link" href="#bodyContent">Jump to content</a>
<div class="vector-header-container">
	</div>
<div class="mw-page-container">
	<div class="mw-page-container-inner">
		<div class="vector-column-start">
			<div class="vector-main-menu-container">
		</div>
	<div class="vector-sticky-pinned-container">
				<nav id="mw-panel-toc" role="navigation" aria-label="Contents" data-event-name="ui.sidebar-toc" class="mw-table-of-contents-container vector-toc-landmark">
					<div id="vector-toc-pinned-container" class="vector-pinned-container">
					<div id="vector-toc" class="vector-toc vector-pinnable-element">
	<div class="vector-pinnable-header vector-toc-pinnable-header vector-pinnable-header-pinned" data-feature-name="toc-pinned" data-pinnable-element-id="vector-toc">
	<h2 class="vector-pinnable-header-label">Contents</h2>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-pin-button" data-event-name="pinnable-header.vector-toc.pin">move to sidebar</button>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-unpin-button" data-event-name="pinnable-header.vector-toc.unpin">hide</button>
</div>


	<ul class="vector-toc-contents" id="mw-panel-toc-list">
		<li id="toc-mw-content-text" class="vector-toc-list-item vector-toc-level-1">
			<a href="#" class="vector-toc-link">
				<div class="vector-toc-text">Beginning</div>
			</a>
		</li>
		<li id="toc-Générer_la_liste_de_récupération_des_paquets" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#G%C3%A9n%C3%A9rer_la_liste_de_r%C3%A9cup%C3%A9ration_des_paquets">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">1</span>Générer la liste de récupération des paquets</div>
		</a>
		
		<ul id="toc-Générer_la_liste_de_récupération_des_paquets-sublist" class="vector-toc-list">
		</ul>
	</li>
	<li id="toc-Effectuer_la_récupération" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#Effectuer_la_r%C3%A9cup%C3%A9ration">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">2</span>Effectuer la récupération</div>
		</a>
		
		<ul id="toc-Effectuer_la_récupération-sublist" class="vector-toc-list">
		</ul>
	</li>
</ul>
</div>

					</div>
		</nav>
			</div>
		</div>
		<div class="mw-content-container">
			<main id="content" class="mw-body" role="main" style="margin: 0">
				<header class="mw-body-header vector-page-titlebar">
					<nav role="navigation" aria-label="Contents" class="vector-toc-landmark">
						
<div id="vector-page-titlebar-toc" class="vector-dropdown vector-page-titlebar-toc vector-button-flush-left">
	<input type="checkbox" id="vector-page-titlebar-toc-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-vector-page-titlebar-toc" class="vector-dropdown-checkbox " aria-label="Toggle the table of contents">
	<label id="vector-page-titlebar-toc-label" for="vector-page-titlebar-toc-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--icon-only " aria-hidden="true"><span class="vector-icon mw-ui-icon-listBullet mw-ui-icon-wikimedia-listBullet"></span>

<span class="vector-dropdown-label-text">Toggle the table of contents</span>
	</label>
	<div class="vector-dropdown-content">


							<div id="vector-page-titlebar-toc-unpinned-container" class="vector-unpinned-container">
			</div>
		
	</div>
</div>

					</nav>
					<h1 id="firstHeading" class="firstHeading mw-first-heading">pacman (Français)/Restore local database (Français)</h1>
							
<div id="p-lang-btn" class="vector-dropdown mw-portlet mw-portlet-lang">
	<input type="checkbox" id="p-lang-btn-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-p-lang-btn" class="vector-dropdown-checkbox mw-interlanguage-selector" aria-label="Go to an article in another language. Available in 6 languages">
	<label id="p-lang-btn-label" for="p-lang-btn-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--action-progressive mw-portlet-lang-heading-6" aria-hidden="true"><span class="vector-icon mw-ui-icon-language-progressive mw-ui-icon-wikimedia-language-progressive"></span>

<span class="vector-dropdown-label-text">6 languages</span>
	</label>
	<div class="vector-dropdown-content">

		<div class="vector-menu-content">
			
			<ul class="vector-menu-content-list">
				
				<li class="interlanguage-link interwiki-en mw-list-item"><a href="../../en/Pacman/Restore_local_database.html" title="Pacman/Restore local database – English" lang="en" hreflang="en" class="interlanguage-link-target"><span>English</span></a></li>
<li class="interlanguage-link interwiki-es mw-list-item"><a href="../../es/Pacman/Restore_local_database.html" title="Pacman (Español)/Restore local database – español" lang="es" hreflang="es" class="interlanguage-link-target"><span>Español</span></a></li>
<li class="interlanguage-link interwiki-ja mw-list-item"><a href="https://wiki.archlinux.jp/index.php/Pacman/%E3%83%AD%E3%83%BC%E3%82%AB%E3%83%AB%E3%83%87%E3%83%BC%E3%82%BF%E3%83%99%E3%83%BC%E3%82%B9%E3%81%AE%E5%BE%A9%E5%85%83" title="Pacman/ローカルデータベースの復元 – 日本語" lang="ja" hreflang="ja" class="interlanguage-link-target"><span>日本語</span></a></li>
<li class="interlanguage-link interwiki-pt mw-list-item"><a href="../../pt/Pacman/Restore_local_database.html" title="Pacman (Português)/Restore local database – português" lang="pt" hreflang="pt" class="interlanguage-link-target"><span>Português</span></a></li>
<li class="interlanguage-link interwiki-ru mw-list-item"><a href="../../ru/Pacman/Restore_local_database.html" title="Pacman (Русский)/Restore local database – русский" lang="ru" hreflang="ru" class="interlanguage-link-target"><span>Русский</span></a></li>
<li class="interlanguage-link interwiki-zh-hans mw-list-item"><a href="https://wiki.archlinuxcn.org/wiki/Pacman/Restore_local_database" title="Pacman/Restore local database – 中文（简体）" lang="zh-Hans" hreflang="zh-Hans" class="interlanguage-link-target"><span>中文（简体）</span></a></li>
			</ul>
			
		</div>

	</div>
</div>
</header>
				<div class="vector-column-end">
					<div class="vector-sticky-pinned-container">
						<nav class="vector-page-tools-landmark" aria-label="Page tools">
							<div id="vector-page-tools-pinned-container" class="vector-pinned-container">
				
							</div>
		</nav>
						<nav class="vector-client-prefs-landmark" aria-label="Appearance">
						</nav>
					</div>
				</div>
				<div id="bodyContent" class="vector-body" aria-labelledby="firstHeading" data-mw-ve-target-container>
					<div class="vector-body-before-content">
							<div class="mw-indicators">
		</div>

						<div id="siteSub" class="noprint">From ArchWiki</div>
					</div>
					<div id="contentSub"><div id="mw-content-subtitle"><div class="subpages">&lt; <a href="../../fr/Pacman.html" title="Pacman (Français)">Pacman (Français)</a>
</div></div></div>
					
					
					<div id="mw-content-text" class="mw-body-content">
<div class="mw-content-ltr mw-parser-output" lang="fr" dir="ltr">
<p><span>
</span>
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>État de la traduction:</strong> Cet article est la version francophone de <a href="../../en/Pacman/Restore_local_database.html" title="Pacman/Restore local database">pacman/Restore local database</a>. Date de la dernière traduction: 2024-02-29. Vous pouvez aider à synchroniser la traduction s'il y a eu des <a rel="nofollow" class="external text" href="https://wiki.archlinux.org/index.php?title=Pacman/Restore_local_database&amp;diff=0&amp;oldid=804026">changements</a> dans la version anglaise.</div>
<p>Signes indiquant que pacman a besoin d'une restauration de la base de données locale :
</p>
<ul>
<li>
<code>pacman -Q</code> n'indique rien, et <code>pacman -Syu</code> indique à tort que le système est à jour.</li>
<li>Lorsque l'on essaie d'installer un paquet à l'aide de <code>pacman -S package</code> et produit une liste des dépendances déjà satisfaites.</li>
</ul>
<p>La base de données de pacman sur les logiciels installés, <code>/var/lib/pacman/local</code>, a probablement été corrompue ou supprimée. Bien que cela soit un sérieux problème, il est possible de la restaurer en suivant les instructions ci-dessous.
</p>
<p>Vérifiez tout d'abord que le fichier de log de pacman est bien présent :
</p>
<pre>$ ls /var/log/pacman.log
</pre>
<p>S'il n'existe pas, on ne pourra pas continuer avec cette méthode. Vous pouvez éventuellement utiliser <a rel="nofollow" class="external text" href="https://bbs.archlinux.org/viewtopic.php?pid=670876">le script de détection des paquets de Xyne</a> pour recréer le base de donnée. Sinon, la solution la plus probable est de réinstaller l'ensemble du système.
</p>
<h2>
<span id="G.C3.A9n.C3.A9rer_la_liste_de_r.C3.A9cup.C3.A9ration_des_paquets"></span><span class="mw-headline" id="Générer_la_liste_de_récupération_des_paquets">Générer la liste de récupération des paquets</span>
</h2>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Attention:</strong> Si pour une raison quelconque le cache <a href="../../fr/Pacman.html" title="Pacman (Français)">pacman</a> ou la destination <a href="../../fr/Makepkg.html" title="Makepkg (Français)">makepkg</a> contient des paquets pour d'autres architectures, supprimez-les avant de continuer.</div>
<p><a href="../../fr/Help:Reading.html#Installation_de_paquets" class="mw-redirect" title="Installez">Installez</a> le paquet <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=pacman-contrib">pacman-contrib</a></span> pour obtenir <i>paclog-pkglist</i>.
</p>
<p>Créez le script de filtrage des logs et rendez-le <a href="../../fr/Help:Reading.html#Rendre_ex%C3%A9cutable" class="mw-redirect" title="Exécutable">exécutable</a> :
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">pacrecover</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">#!/bin/bash -e

. /etc/makepkg.conf

PKGCACHE=$((grep -m 1 '^CacheDir' /etc/pacman.conf || echo 'CacheDir = /var/cache/pacman/pkg') | sed 's/CacheDir = //')

pkgdirs=("$@" "$PKGDEST" "$PKGCACHE")

while read -r -a parampart; do
  pkgname="${parampart[0]}-${parampart[1]}-*.pkg.tar.{xz,zst}"
  for pkgdir in ${pkgdirs[@]}; do
    pkgpath="$pkgdir"/$pkgname
    [ -f $pkgpath ] &amp;&amp; { echo $pkgpath; break; };
  done || echo ${parampart[0]} 1&gt;&amp;2
done
</pre>
<p>Exécutez le script (en passant éventuellement des répertoires supplémentaires avec des paquets en tant que paramètres) :
</p>
<pre>$ paclog-pkglist /var/log/pacman.log | ./pacrecover &gt;files.list 2&gt;pkglist.orig
</pre>
<p>De cette manière, deux fichiers seront créés : <code>files.list</code> avec les fichiers des paquets encore présents sur la machine et <code>pkglist.orig</code>, à partir duquel les paquets doivent être téléchargés. L'opération ultérieure peut entraîner des incohérences entre les fichiers des anciennes versions du paquet, encore présents sur la machine, et les fichiers trouvés dans la nouvelle version. Ces disparités devront être corrigées manuellement.
</p>
<p>Voici un moyen de restreindre automatiquement la deuxième liste aux paquets disponibles dans un dépôt :
</p>
<pre>$ { cat pkglist.orig; pacman -Slq; } | sort | uniq -d &gt; pkglist
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> Si cela échoue avec <code>failed to initialise alpm library</code>, vérifiez si <code>/var/lib/pacman/local/ALPM_DB_VERSION</code> existe - si ce n'est pas le cas, exécutez <code>pacman-db-upgrade</code> en tant que root suivi de <code>pacman -Sy</code> puis <b>réessayez la commande précédente</b>.</div>
<p>Vérifiez si certains paquets de <i>base</i> sont manquants et ajoutez-les à la liste :
</p>
<pre>$ comm -23 &lt;(pacman -Sgq base | sort) pkglist.orig &gt;&gt; pkglist
</pre>
<p>Procédez une fois que le contenu des deux listes vous semble satisfaisant, car elles seront utilisées pour restaurer la base de données des paquets installés par pacman ; <code>/var/lib/pacman/local/</code>.
</p>
<h2>
<span id="Effectuer_la_r.C3.A9cup.C3.A9ration"></span><span class="mw-headline" id="Effectuer_la_récupération">Effectuer la récupération</span>
</h2>
<p>Créez la <a href="../../en/Bash/Functions.html" title="Bash/Functions">fonction Bash</a> pour la récupération :
</p>
<pre> recovery-pacman() {
    pacman "$@"  \
    --log /dev/null   \
    --noscriptlet     \
    --dbonly          \
    --overwrite "*"   \
    --nodeps          \
    --needed
}
</pre>
<p><code>--log /dev/null</code> permet d'éviter de polluer inutilement les logs de pacman, <code>--needed</code> permet de gagner du temps en sautant les paquets déjà présents dans la base de données, <code>--nodeps</code> permet d'installer les paquets mis en cache, même si les paquets en cours d'installation dépendent de versions plus récentes. Le reste des options permet à <b>pacman</b> de fonctionner sans lire/écrire le système de fichiers.
</p>
<p>Alimenter la base de données de synchronisation :
</p>
<pre># pacman -Sy
</pre>
<p>Lancez la génération de la base de données en installant les fichiers de paquets disponibles localement à partir de <code>files.list</code>:
</p>
<pre># recovery-pacman -U $(&lt; files.list)
</pre>
<p>Installer le reste à partir de <code>pkglist</code>:
</p>
<pre># recovery-pacman -S $(&lt; pkglist)
</pre>
<p>Mettez à jour la base de données locale de manière que les paquets qui ne sont pas requis par un autre paquet soient marqués comme explicitement installés et les autres comme des dépendances. Vous devrez faire très attention à l'avenir lorsque vous supprimerez des paquets, la base de données originale ayant été perdue, c'est le mieux que nous puissions faire.
</p>
<pre># pacman -D --asdeps $(pacman -Qq)
# pacman -D --asexplicit $(pacman -Qtq)
</pre>
<p>Facultativement, vérifier que tous les paquets installés ne sont pas corrompus :
</p>
<pre># pacman -Qk
</pre>
<p>Accessoirement, voir <a href="../../fr/Pacman/Tips_and_tricks.html#Recherche_des_fichiers_n'appartenant_%C3%A0_aucun_paquet" title="Pacman (Français)/Tips and tricks (Français)">pacman (Français)/Tips and tricks (Français)#Recherche des fichiers n'appartenant à aucun paquet</a>.
</p>
<p>Mettez à jour tous les paquets :
</p>
<pre># pacman -Su
</pre>
</div>
</div>
					<div id="catlinks" class="catlinks" data-mw="interface"><div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../../Special:Categories.html" title="Special:Categories">Category</a>: <ul><li><a href="../../fr/Category:Package_manager.html" title="Category:Package manager (Français)">Package manager (Français)</a></li></ul>
</div></div>
				</div>
			</main>
			
		</div>
		<div class="mw-footer-container">
			
<footer id="footer" class="mw-footer" role="contentinfo" style="margin: 0">
	<ul id="footer-info">
	<li data-nosnippet="">Retrieved from "<a dir="ltr" href="https://wiki.archlinux.org/index.php?title=Pacman_(Fran%C3%A7ais)/Restore_local_database_(Fran%C3%A7ais)&amp;oldid=804421">https://wiki.archlinux.org/index.php?title=Pacman_(Français)/Restore_local_database_(Français)&amp;oldid=804421</a>"</li>
<li id="footer-info-lastmod"> This page was last edited on 24 March 2024, at 13:48.</li>
	<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="https://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.3 or later</a> unless otherwise noted.</li>
<br>
</ul>

	<ul id="footer-places">
	<li id="footer-places-privacy"><a href="https://terms.archlinux.org/docs/privacy-policy/">Privacy policy</a></li>
	<li id="footer-places-about"><a href="../../en/ArchWiki:About.html">About ArchWiki</a></li>
	<li id="footer-places-disclaimers"><a href="../../en/ArchWiki:General_disclaimer.html">Disclaimers</a></li>
	<li id="footer-places-archwiki-code-of-conduct"><a href="https://terms.archlinux.org/docs/code-of-conduct/" class="extiw" title="archlinux-service-agreements:code-of-conduct">Code of conduct</a></li>
	<li id="footer-places-archwiki-terms-of-service"><a href="https://terms.archlinux.org/docs/terms-of-service/" class="extiw" title="archlinux-service-agreements:terms-of-service">Terms of service</a></li>
</ul>

	<ul id="footer-icons" class="noprint">
	<li id="footer-copyrightico"><a href="https://www.gnu.org/copyleft/fdl.html"><img src="/resources/assets/licenses/gnu-fdl.png" alt="GNU Free Documentation License 1.3 or later" width="88" height="31" loading="lazy"></a></li>
	<li id="footer-poweredbyico"><img src="/resources/assets/poweredby_mediawiki_88x31.png" srcset="/resources/assets/poweredby_mediawiki_132x47.png 1.5x, /resources/assets/poweredby_mediawiki_176x62.png 2x" width="88" height="31" loading="lazy"></li>
</ul>

</footer>

		</div>
	</div> 
</div> 
<div class="vector-settings" id="p-dock-bottom">
	<ul>
		<li>
		<button class="cdx-button cdx-button--icon-only vector-limited-width-toggle" id=""><span class="vector-icon mw-ui-icon-fullScreen mw-ui-icon-wikimedia-fullScreen"></span>

<span>Toggle limited content width</span>
</button>
</li>
	</ul>
</div>
</body>
</html>
