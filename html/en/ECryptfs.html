<!DOCTYPE html>
<html class="client-nojs vector-feature-language-in-header-enabled vector-feature-language-in-main-page-header-disabled vector-feature-sticky-header-disabled vector-feature-page-tools-pinned-disabled vector-feature-toc-pinned-clientpref-1 vector-feature-main-menu-pinned-disabled vector-feature-limited-width-clientpref-1 vector-feature-limited-width-content-enabled vector-feature-zebra-design-disabled vector-feature-custom-font-size-clientpref-disabled vector-feature-client-preferences-disabled vector-feature-typography-survey-disabled vector-toc-available" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>eCryptfs - ArchWiki</title>
<link rel="stylesheet" href="../ArchWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<meta name="generator" content="MediaWiki 1.41.1">
<meta name="referrer" content="no-referrer-when-downgrade">
<meta name="robots" content="max-image-preview:standard">
<meta name="format-detection" content="telephone=no">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=0.25, maximum-scale=5.0">
<link rel="icon" href="/favicon.ico">
<link rel="search" type="application/opensearchdescription+xml" href="/opensearch_desc.php" title="ArchWiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.archlinux.org/api.php?action=rsd">
<link rel="license" href="https://www.gnu.org/copyleft/fdl.html">
<link rel="alternate" type="application/atom+xml" title="ArchWiki Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="skin-vector skin-vector-search-vue mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-ECryptfs rootpage-ECryptfs skin-vector-2022 action-view skin--responsive">
<a class="mw-jump-link" href="#bodyContent">Jump to content</a>
<div class="vector-header-container">
	</div>
<div class="mw-page-container">
	<div class="mw-page-container-inner">
		<div class="vector-main-menu-container">
		</div>
	<input type="checkbox" id="vector-toc-collapsed-checkbox" class="vector-menu-checkbox">
			<nav id="mw-panel-toc" role="navigation" aria-label="Contents" data-event-name="ui.sidebar-toc" class="mw-table-of-contents-container vector-toc-landmark vector-sticky-pinned-container">
				<div id="vector-toc-pinned-container" class="vector-pinned-container">
				<div id="vector-toc" class="vector-toc vector-pinnable-element">
	<div class="vector-pinnable-header vector-toc-pinnable-header vector-pinnable-header-pinned" data-feature-name="toc-pinned" data-pinnable-element-id="vector-toc">
	<h2 class="vector-pinnable-header-label">Contents</h2>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-pin-button" data-event-name="pinnable-header.vector-toc.pin">move to sidebar</button>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-unpin-button" data-event-name="pinnable-header.vector-toc.unpin">hide</button>
</div>


	<ul class="vector-toc-contents" id="mw-panel-toc-list">
		<li id="toc-mw-content-text" class="vector-toc-list-item vector-toc-level-1">
			<a href="#" class="vector-toc-link">
				<div class="vector-toc-text">Beginning</div>
			</a>
		</li>
		<li id="toc-Basics" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#Basics">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">1</span>Basics</div>
		</a>
		
			<button aria-controls="toc-Basics-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Basics subsection</span>
			</button>
		
		<ul id="toc-Basics-sublist" class="vector-toc-list">
			<li id="toc-Deficiencies" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Deficiencies">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">1.1</span>Deficiencies</div>
			</a>
			
			<ul id="toc-Deficiencies-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Setup_&amp;_mounting" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#Setup_&amp;_mounting">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">2</span>Setup &amp; mounting</div>
		</a>
		
			<button aria-controls="toc-Setup_&amp;_mounting-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Setup &amp; mounting subsection</span>
			</button>
		
		<ul id="toc-Setup_&amp;_mounting-sublist" class="vector-toc-list">
			<li id="toc-Ubuntu_tools" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Ubuntu_tools">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.1</span>Ubuntu tools</div>
			</a>
			
			<ul id="toc-Ubuntu_tools-sublist" class="vector-toc-list">
				<li id="toc-Encrypting_a_data_directory" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Encrypting_a_data_directory">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.1.1</span>Encrypting a data directory</div>
			</a>
			
			<ul id="toc-Encrypting_a_data_directory-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Encrypting_a_home_directory" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Encrypting_a_home_directory">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.1.2</span>Encrypting a home directory</div>
			</a>
			
			<ul id="toc-Encrypting_a_home_directory-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Mounting" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Mounting">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.1.3</span>Mounting</div>
			</a>
			
			<ul id="toc-Mounting-sublist" class="vector-toc-list">
				<li id="toc-Manually" class="vector-toc-list-item vector-toc-level-4">
			<a class="vector-toc-link" href="#Manually">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.1.3.1</span>Manually</div>
			</a>
			
			<ul id="toc-Manually-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Auto-mounting" class="vector-toc-list-item vector-toc-level-4">
			<a class="vector-toc-link" href="#Auto-mounting">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.1.3.2</span>Auto-mounting</div>
			</a>
			
			<ul id="toc-Auto-mounting-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
	</ul>
		</li>
		<li id="toc-ecryptfs-simple" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#ecryptfs-simple">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.2</span>ecryptfs-simple</div>
			</a>
			
			<ul id="toc-ecryptfs-simple-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Manual_setup" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Manual_setup">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.3</span>Manual setup</div>
			</a>
			
			<ul id="toc-Manual_setup-sublist" class="vector-toc-list">
				<li id="toc-With_configuration_files" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#With_configuration_files">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.3.1</span>With configuration files</div>
			</a>
			
			<ul id="toc-With_configuration_files-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Raw_mount_command" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Raw_mount_command">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.3.2</span>Raw mount command</div>
			</a>
			
			<ul id="toc-Raw_mount_command-sublist" class="vector-toc-list">
				<li id="toc-Mounting_2" class="vector-toc-list-item vector-toc-level-4">
			<a class="vector-toc-link" href="#Mounting_2">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.3.2.1</span>Mounting</div>
			</a>
			
			<ul id="toc-Mounting_2-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Auto-mounting_2" class="vector-toc-list-item vector-toc-level-4">
			<a class="vector-toc-link" href="#Auto-mounting_2">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.3.2.2</span>Auto-mounting</div>
			</a>
			
			<ul id="toc-Auto-mounting_2-sublist" class="vector-toc-list">
				<li id="toc-Optional_step" class="vector-toc-list-item vector-toc-level-5">
			<a class="vector-toc-link" href="#Optional_step">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.3.2.2.1</span>Optional step</div>
			</a>
			
			<ul id="toc-Optional_step-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
	</ul>
		</li>
	</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Usage" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#Usage">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">3</span>Usage</div>
		</a>
		
			<button aria-controls="toc-Usage-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Usage subsection</span>
			</button>
		
		<ul id="toc-Usage-sublist" class="vector-toc-list">
			<li id="toc-Symlinking_into_the_encrypted_directory" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Symlinking_into_the_encrypted_directory">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.1</span>Symlinking into the encrypted directory</div>
			</a>
			
			<ul id="toc-Symlinking_into_the_encrypted_directory-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Removal_of_encryption" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Removal_of_encryption">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.2</span>Removal of encryption</div>
			</a>
			
			<ul id="toc-Removal_of_encryption-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Backup" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Backup">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.3</span>Backup</div>
			</a>
			
			<ul id="toc-Backup-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Known_issues" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#Known_issues">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">4</span>Known issues</div>
		</a>
		
			<button aria-controls="toc-Known_issues-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Known issues subsection</span>
			</button>
		
		<ul id="toc-Known_issues-sublist" class="vector-toc-list">
			<li id="toc-Mounting_may_fail_on_a_remote_host_when_connecting_via_Mosh" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Mounting_may_fail_on_a_remote_host_when_connecting_via_Mosh">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">4.1</span>Mounting may fail on a remote host when connecting via Mosh</div>
			</a>
			
			<ul id="toc-Mounting_may_fail_on_a_remote_host_when_connecting_via_Mosh-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-See_also" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#See_also">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">5</span>See also</div>
		</a>
		
		<ul id="toc-See_also-sublist" class="vector-toc-list">
		</ul>
	</li>
</ul>
</div>

				</div>
	</nav>
		
		<div class="mw-content-container">
			<main id="content" class="mw-body" role="main" style="margin: 0">
				<header class="mw-body-header vector-page-titlebar">
					<label id="vector-toc-collapsed-button" class="cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet vector-button-flush-left cdx-button--icon-only" for="vector-toc-collapsed-checkbox" role="button" aria-controls="vector-toc" tabindex="0" title="Table of Contents">
						<span class="vector-icon mw-ui-icon-wikimedia-listBullet"></span>
						<span>Toggle the table of contents</span>
					</label>
					<nav role="navigation" aria-label="Contents" class="vector-toc-landmark">
						
<div id="vector-page-titlebar-toc" class="vector-dropdown vector-page-titlebar-toc vector-button-flush-left">
	<input type="checkbox" id="vector-page-titlebar-toc-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-vector-page-titlebar-toc" class="vector-dropdown-checkbox " aria-label="Toggle the table of contents">
	<label id="vector-page-titlebar-toc-label" for="vector-page-titlebar-toc-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--icon-only " aria-hidden="true"><span class="vector-icon mw-ui-icon-listBullet mw-ui-icon-wikimedia-listBullet"></span>

<span class="vector-dropdown-label-text">Toggle the table of contents</span>
	</label>
	<div class="vector-dropdown-content">


							<div id="vector-page-titlebar-toc-unpinned-container" class="vector-unpinned-container">
			</div>
		
	</div>
</div>

					</nav>
					<h1 id="firstHeading" class="firstHeading mw-first-heading">eCryptfs</h1>
							
<div id="p-lang-btn" class="vector-dropdown mw-portlet mw-portlet-lang">
	<input type="checkbox" id="p-lang-btn-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-p-lang-btn" class="vector-dropdown-checkbox mw-interlanguage-selector" aria-label="Go to an article in another language. Available in 2 languages">
	<label id="p-lang-btn-label" for="p-lang-btn-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--action-progressive mw-portlet-lang-heading-2" aria-hidden="true"><span class="vector-icon mw-ui-icon-language-progressive mw-ui-icon-wikimedia-language-progressive"></span>

<span class="vector-dropdown-label-text">2 languages</span>
	</label>
	<div class="vector-dropdown-content">

		<div class="vector-menu-content">
			
			<ul class="vector-menu-content-list">
				
				<li class="interlanguage-link interwiki-ja mw-list-item"><a href="https://wiki.archlinux.jp/index.php/ECryptfs" title="ECryptfs – 日本語" lang="ja" hreflang="ja" class="interlanguage-link-target"><span>日本語</span></a></li>
<li class="interlanguage-link interwiki-ru mw-list-item"><a href="../ru/ECryptfs.html" title="ECryptfs – русский" lang="ru" hreflang="ru" class="interlanguage-link-target"><span>Русский</span></a></li>
			</ul>
			
		</div>

	</div>
</div>
</header>
				<div class="vector-column-end">
					<nav class="vector-page-tools-landmark vector-sticky-pinned-container" aria-label="Page tools">
						<div id="vector-page-tools-pinned-container" class="vector-pinned-container">
			
						</div>
	</nav>
				</div>
				<div id="bodyContent" class="vector-body" aria-labelledby="firstHeading" data-mw-ve-target-container>
					<div class="vector-body-before-content">
							<div class="mw-indicators">
		</div>

						<div id="siteSub" class="noprint">From ArchWiki</div>
					</div>
					<div id="contentSub"><div id="mw-content-subtitle"></div></div>
					
					
					<div id="mw-content-text" class="mw-body-content mw-content-ltr" lang="en" dir="ltr">
<div class="mw-parser-output">
<p><span>
</span>
This article describes basic usage of <a rel="nofollow" class="external text" href="https://launchpad.net/ecryptfs">eCryptfs</a>. It guides you through the process of creating a private and secure encrypted directory within your home directory to store sensitive files and private data.
</p>
<p>In implementation eCryptfs differs from <a href="../en/Dm-crypt.html" title="Dm-crypt">dm-crypt</a>, which provides a <i>block device encryption layer</i>, while eCryptfs is an actual file-system – a <a href="https://en.wikipedia.org/wiki/Cryptographic_filesystems" class="extiw" title="wikipedia:Cryptographic filesystems">stacked cryptographic file system</a>. For comparison of the two you can refer to <a href="../en/Data-at-rest_encryption.html#Block_device_vs_stacked_filesystem_encryption" title="Data-at-rest encryption">Data-at-rest encryption#Block device vs stacked filesystem encryption</a>. One distinguished feature is that the encryption is stacked on an existing filesystem; eCryptfs can be mounted onto any single existing directory and does not require a separate partition (or size pre-allocation).
</p>
<meta property="mw:PageProp/toc">
<h2><span class="mw-headline" id="Basics">Basics</span></h2>
<p>As mentioned in the summary eCryptfs does not require special on-disk storage allocation effort, such as a separate partition or pre-allocated space. Instead, you can mount eCryptfs on top of any single directory to protect it. That includes, for example, a user's entire home directory or single dedicated directories within it. All cryptographic metadata is stored in the headers of files, so encrypted data can be easily moved, stored for backup and recovered. There are other advantages, but there are also drawbacks, for instance eCryptfs is not suitable for encrypting complete partitions which also means you cannot protect swap space with it (but you can, of course, combine it with <a href="../en/Dm-crypt/Swap_encryption.html" title="Dm-crypt/Swap encryption">Dm-crypt/Swap encryption</a>). If you are just starting to set up disk encryption, swap encryption and other points to consider are covered in <a href="../en/Data-at-rest_encryption.html#Preparation" title="Data-at-rest encryption">Data-at-rest encryption#Preparation</a>.
</p>
<p>To familiarize with eCryptfs a few points:
</p>
<ul>
<li>As a stacked filesystem, a mounting of an eCryptfs directory refers to mounting a (stacked) encrypted directory to another <b>un</b>encrypted mount point (directory) at Linux kernel runtime.</li>
<li>It is possible to share an encrypted directory between users. However, the encryption is linked to one passphrase so this must be shared as well. It is also possible to share a directory with differently encrypted files (different passphrases).</li>
<li>Several eCryptfs terms are used throughout the documentation:
<ul>
<li>The encrypted directory is referred to as the <b>lower</b> and the unencrypted as the <b>upper</b> directory throughout the eCryptfs documentation and this article. While not relevant for this article, the <a href="../en/Overlay_filesystem.html" title="Overlay filesystem">Overlay filesystem</a> introduced with Linux 3.18 uses <a rel="nofollow" class="external text" href="https://docs.kernel.org/filesystems/overlayfs.html#upper-and-lower">the same upper/lower nomenclature</a> for the stacking of filesystems.</li>
<li>The <b>mount</b> passphrase (or key) is what gives access to the encrypted files, i.e. unlocks the encryption. eCryptfs uses the term <b>wrapped</b> passphrase to refer to the cryptographically secured mount passphrase.</li>
<li>
<code>FEKEK</code> refers to a <b>F</b>ile's <b>E</b>ncryption <b>K</b>ey <b>E</b>ncryption <b>K</b>ey (see <a rel="nofollow" class="external text" href="https://docs.kernel.org/security/keys/ecryptfs.html">kernel documentation</a>).</li>
<li>
<code>FNEK</code> refers to a <b>F</b>ile <b>N</b>ame <b>E</b>ncryption <b>K</b>ey, a key to (optionally) encrypt the filenames stored in the encrypted directory.</li>
</ul>
</li>
</ul>
<p>Before using eCryptfs, the following disadvantages should be checked for applicability.
</p>
<h3><span class="mw-headline" id="Deficiencies">Deficiencies</span></h3>
<ul><li>Ease of use</li></ul>
<dl><dd>The <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=ecryptfs-utils">ecryptfs-utils</a></span> package provides several different ways of setting up eCryptfs. The high-level <a href="#Ubuntu_tools">#Ubuntu tools</a> are the easiest to use, but they hard-code the lower directory path and other settings, limiting their usefulness. The package also includes low-level tools which are fully configurable, but they are somewhat more difficult to use compared to alternatives like <a href="../en/EncFS.html" title="EncFS">EncFS</a>.</dd></dl>
<ul><li>File name length</li></ul>
<dl><dd>File names longer than 143 bytes cannot be encrypted (with the <code>FNEK</code> option) when stacked on a filesystem with a maximum file name length of 255 bytes.<a rel="nofollow" class="external autonumber" href="https://bugs.launchpad.net/ecryptfs/+bug/344878">[1]</a> This can break some programs in your home directory (for example <a href="https://en.wikipedia.org/wiki/Symfony" class="extiw" title="wikipedia:Symfony">Symfony</a> caching).</dd></dl>
<ul><li>Network storage mounts</li></ul>
<dl><dd>eCryptfs has long-standing <a rel="nofollow" class="external text" href="https://bugs.launchpad.net/ecryptfs/+bug/277578">bugs</a> when used on top of NFS and possibly other networked filesystems, for example, <a href="#Mounting_may_fail_on_a_remote_host_when_connecting_via_Mosh">#Mounting may fail on a remote host when connecting via Mosh</a>. It is always possible to use eCryptfs on a local directory and then copy the encrypted files from the local directory to a network host. However, if you want to set up eCryptfs directly on top of an NFS mount, with no local copy of the files, eCryptfs may crash or behave incorrectly. If in doubt, <a href="../en/EncFS.html" title="EncFS">EncFS</a> may be a better choice in this case.</dd></dl>
<ul><li>Sparse files</li></ul>
<dl><dd>
<a href="https://en.wikipedia.org/wiki/Sparse_file" class="extiw" title="wikipedia:Sparse file">Sparse files</a> written to eCryptfs will produce larger, non-sparse encrypted files in the lower directory. For example, in an eCryptfs directory running <code>truncate -s 1G file.img</code> creates a 1GB encrypted file on the underlying filesystem, with the corresponding resource (disk space, data throughput) requirements. If the same file were created on an unencrypted filesystem or a filesystem using <a href="../en/Data-at-rest_encryption.html#Block_device_encryption" title="Data-at-rest encryption">block device encryption</a>, it would only take a few kilobytes.</dd></dl>
<dl><dd>This should be considered before encrypting large portions of the directory structure, though in most cases the disadvantages will be minor. If you need to use large sparse files, you can work around this issue by putting the sparse files in an unencrypted directory or using block device encryption for them.</dd></dl>
<h2>
<span id="Setup_.26_mounting"></span><span class="mw-headline" id="Setup_&amp;_mounting">Setup &amp; mounting</span>
</h2>
<p>Before starting setup, check the eCryptfs documentation. The software is distributed with a very comprehensive set of <a rel="nofollow" class="external text" href="https://www.ecryptfs.org/documentation">manual pages</a>.
</p>
<p>eCryptfs has been included in Linux since version 2.6.19. Start by loading the <code>ecryptfs</code> module:
</p>
<pre># modprobe ecryptfs
</pre>
<p>To actually mount an eCryptfs filesystem, you need to use userspace tools provided by the <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=ecryptfs-utils">ecryptfs-utils</a></span> package. Unfortunately, due to the poor design of these tools, you must choose between three ways of setting up eCryptfs, each with different tradeoffs:
</p>
<ol>
<li>Use the high-level <a href="#Ubuntu_tools">#Ubuntu tools</a>, which sets things up automatically, but requires the lower directory to be <code>~/.Private/</code>, and allows only one encrypted filesystem per user.</li>
<li>Use <a href="#ecryptfs-simple">ecryptfs-simple</a>, which is an easy way to mount eCryptfs filesystems using any lower directory and upper directory.</li>
<li>
<a href="#Manual_setup">#Manual setup</a>, which involves separate steps for loading the passphrase and mounting eCryptfs, but allows complete control over the directories and encryption settings.</li>
</ol>
<h3><span class="mw-headline" id="Ubuntu_tools">Ubuntu tools</span></h3>
<p>Most of the user-friendly convenience tools installed by the <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=ecryptfs-utils">ecryptfs-utils</a></span> package assume that a very specific eCryptfs setup is being used, namely the one that is officially used by Ubuntu (where it can be selected as an option during installation). Unfortunately, these choices are not just default options, but are actually hard-coded in the tools. If this setup does not suit your needs, then you cannot use the convenience tools and will have to follow the steps at <a href="#Manual_setup">#Manual setup</a> instead.
</p>
<p>The setup used by these tools is as follows:
</p>
<ul>
<li>each user can have <b>only one encrypted directory</b> that is managed by these tools:
<ul>
<li>either full <code>$HOME</code> directory encryption, or</li>
<li>a single encrypted data directory (by default <code>~/Private/</code>, but this can be customized).</li>
</ul>
</li>
<li>the <b>lower directory</b> for each user is always <code>~/.Private/</code><div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> In the case of full home dir encryption, this will be a symlink to the actual location at <code>/home/.ecryptfs/<i>username</i>/.Private/</code>.</div>
</li>
<li>the <b>encryption options</b> used are:
<ul>
<li>
<i>cipher:</i> AES</li>
<li>
<i>key length:</i> 16 bytes (128 bits)</li>
<li>
<i>key management scheme:</i> passphrase</li>
<li>
<i>plaintext passthrough:</i> enabled</li>
</ul>
</li>
<li>the <b>configuration / control info</b> for the encrypted directory is stored in a bunch of files at <code>~/.ecryptfs/</code><div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> In the case of full home dir encryption, this will be a symlink to the actual location at <code>/home/.ecryptfs/<i>username</i>/.ecryptfs/</code>.</div>
<ul>
<li>
<code>Private.mnt</code> <i>[plain text file]</i> - contains the path where the upper directory should be mounted (e.g. <code>/home/lucy</code> or <code>/home/lucy/Private</code>)</li>
<li>
<code>Private.sig</code> <i>[plain text file]</i> - contains the signature used to identify the mount passphrase in the kernel keyring</li>
<li>
<code>wrapped-passphrase</code> <i>[binary file]</i> - the mount passphrase, encrypted with the login passphrase</li>
<li>
<code>auto-mount</code>, <code>auto-umount</code> <i>[empty files]</i> - if they exist, the <code>pam_ecryptfs.so</code> module will (assuming it is loaded) automatically mount/unmount this encrypted directory when the user logs in/out</li>
</ul>
</li>
</ul>
<h4><span class="mw-headline" id="Encrypting_a_data_directory">Encrypting a data directory</span></h4>
<p>For a full <code>$HOME</code> directory encryption see <a href="#Encrypting_a_home_directory">#Encrypting a home directory</a>
</p>
<p>Before the data directory encryption is setup, decide whether it should later be mounted manually or automatically with the user log-in.
</p>
<p>To encrypt a single data directory as a user and mount it manually later, run:
</p>
<pre>$ ecryptfs-setup-private --nopwcheck --noautomount
</pre>
<p>and follow the instructions. The option <code>--nopwcheck</code> enables you to choose a passphrase different to the user login passphrase and the option <code>--noautomount</code> is self-explanatory. So, if you want to setup the encrypted directory automatically on log-in later, just <i>leave out</i> both options right away.
</p>
<p>The script will automatically create the <code>~/.Private/</code> and <code>~/.ecryptfs/</code> directory structures as described in the box above. It will also ask for two passphrases:
</p>
<dl>
<dt>login passphrase</dt>
<dd>This is the password you will have to enter each time you want to mount the encrypted directory. If you want auto-mounting on login to work, it has to be the same password you use to login to your user account.</dd>
</dl>
<dl>
<dt>mount passphrase</dt>
<dd>This is used to derive the actual file encryption master key. Thus, you should not enter a custom one unless you know what you are doing - instead press Enter to let it auto-generate a secure random one. It will be encrypted using the login passphrase and stored in this encrypted form in <code>~/.ecryptfs/wrapped-passphrase</code>. Later it will automatically be decrypted ("unwrapped") again in RAM when needed, so you never have to enter it manually. Make sure this file does not get lost, otherwise you can never access your encrypted folder again! You may want to run <code>ecryptfs-unwrap-passphrase</code> to see the mount passphrase in unencrypted form, write it down on a piece of paper, and keep it in a safe (or similar), so you can use it to recover your encrypted data in case the <code>wrapped-passphrase</code> file is accidentally lost, corrupted, or you forget the login passphrase.</dd>
</dl>
<p>The mount point ("upper directory") for the encrypted folder will be at <code>~/Private/</code> by default. However, you can manually change this right after the setup command has finished running, by doing:
</p>
<pre>$ mv ~/Private <i>/path/to/new/folder</i>
$ echo <i>/path/to/new/folder</i> &gt; ~/.ecryptfs/Private.mnt
</pre>
<p>To actually use your encrypted folder, you will have to mount it - see <a href="#Mounting">#Mounting</a> below.
</p>
<h4><span class="mw-headline" id="Encrypting_a_home_directory">Encrypting a home directory</span></h4>
<p>The wrapper script <code>ecryptfs-migrate-home</code> will set up an encrypted home directory for a user and take care of migrating any existing files they have in their not yet encrypted home directory.
</p>
<p>To run it, the user must be logged out and own no processes. The best way to achieve this is to log the user out, log into a console as the root user, and check that <code>ps -U <i>username</i></code> returns no output.  You also need to ensure that you have <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=rsync">rsync</a></span>, <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=lsof">lsof</a></span>, and <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=which">which</a></span> installed. Once the prerequisites have been met, run:
</p>
<pre># modprobe ecryptfs
# ecryptfs-migrate-home -u <i>username</i>
</pre>
<p>and follow the instructions. After the wrapper script is complete, follow the instructions for auto-mounting - see <a href="#Auto-mounting">#Auto-mounting</a> below. To complete this process, it is imperative that the user logs in <i>before</i> the next reboot.
</p>
<p>Once everything is working, the unencrypted backup of the user's home directory, which is saved to <code>/home/<i>username</i>.<i>random_characters</i></code>, should be deleted.
</p>
<h4><span class="mw-headline" id="Mounting">Mounting</span></h4>
<h5><span class="mw-headline" id="Manually">Manually</span></h5>
<p>Executing the wrapper
</p>
<pre>$ ecryptfs-mount-private
</pre>
<p>and entering the passphrase is all needed to mount the encrypted directory to the <i>upper directory</i> <code>~/Private/</code>, described in <a href="#Ubuntu_tools">#Ubuntu tools</a>.
</p>
<p>Likewise, executing
</p>
<pre>$ ecryptfs-umount-private
</pre>
<p>will unmount it again.
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> If it is not required to access the private data permanently during a user session, maybe define an <a href="../en/Bash.html#Aliases" class="mw-redirect" title="Alias">alias</a> to speed the manual step up.</div>
<p>The tools include another script useful in accessing the encrypted <code>.Private</code> data or home directory. Executing  <code>ecryptfs-recover-private</code> as root will search the system (or an optional specific path) for the directory, interactively query the passphrase for it, and mount the directory. It can, for example, be used from a live-CD or different system to access the encrypted data in case of a recovery. Note that if booting from an Arch Linux ISO you must first install the <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=ecryptfs-utils">ecryptfs-utils</a></span>. Further, it will only be able to mount <code>.Private</code> directories created with the Ubuntu tools.
</p>
<h5><span class="mw-headline" id="Auto-mounting">Auto-mounting</span></h5>
<p>The default way to auto-mount an encrypted directory is via <a href="../en/Pam_mount.html" title="Pam mount">PAM</a>. See <span class="plainlinks archwiki-template-man" title="$ man 8 pam_ecryptfs"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/pam_ecryptfs.8">pam_ecryptfs(8)</a></span> and - for more details - 'PAM MODULE' in:
</p>
<pre>/usr/share/doc/ecryptfs-utils/README
</pre>
<p>For auto-mounting, it is required that the encrypted directory passphrase is identical to the user's log-in password.
</p>
<p>Use these steps to set up auto-mounting:
</p>
<p>1. Check if <code>~/.ecryptfs/auto-mount</code>, <code>~/.ecryptfs/auto-umount</code> and <code>~/.ecryptfs/wrapped-passphrase</code> exist (these are automatically created by <i>ecryptfs-setup-private</i>).
</p>
<p>2. Add <i>ecryptfs</i> to the pam-stack exactly as following to allow transparent unwrapping of the passphrase on login:
</p>
<p>Open <code>/etc/pam.d/system-auth</code> and <i>after</i> the line containing <code>auth required pam_unix.so</code> (or <code>auth [default=die] pam_faillock.so authfail</code> if present) add:
</p>
<pre>auth [success=1 default=ignore] pam_succeed_if.so service = systemd-user quiet
auth    required    pam_ecryptfs.so unwrap
</pre>
<p>Next, <i>above</i> the line containing <code>password required pam_unix.so</code> (or <code>-password [success=1 default=ignore] pam_systemd_home.so</code> if present) insert:
</p>
<pre>password    optional    pam_ecryptfs.so
</pre>
<p>And finally, <i>after</i> the line <code>session required pam_unix.so</code> add:
</p>
<pre>session [success=1 default=ignore] pam_succeed_if.so service = systemd-user quiet
session    optional    pam_ecryptfs.so unwrap
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> The <code>pam_succeed_if.so</code> instructions tells the process to <i>skip the next line</i> if the service requesting authentication is <code>systemd-user</code>, that runs parallel to your user session and also authenticates through PAM. Should the home directory be mounted a second time, PAM would be unable to unmount it. This is referenced as a <a rel="nofollow" class="external text" href="https://bbs.archlinux.org/viewtopic.php?id=194509">break</a> with systemd and bugs are filed against it : <a rel="nofollow" class="external autonumber" href="https://bugs.freedesktop.org/show_bug.cgi?id=72759">[2]</a> <a rel="nofollow" class="external autonumber" href="https://nwrickert2.wordpress.com/2013/12/16/systemd-user-manager-ecryptfs-and-opensuse-13-1/">[3]</a><sup title="Last check status: 410">[<a href="https://en.wikipedia.org/wiki/Wikipedia:Link_rot" class="extiw" title="wikipedia:Wikipedia:Link rot">dead link</a> 2023-10-29 ⓘ]</sup> <a rel="nofollow" class="external autonumber" href="https://bugs.launchpad.net/ubuntu/+source/ecryptfs-utils/+bug/313812/comments/43">[4]</a> <a rel="nofollow" class="external autonumber" href="https://lists.alioth.debian.org/pipermail/pkg-systemd-maintainers/2014-October/004088.html">[5]</a>. The method exposed here is a workaround.</div>
<p>3. Re-login and check output of <i>mount</i> which should now contain a mountpoint, e.g.:
</p>
<pre>/home/<i>username</i>/.Private on /home/<i>username</i>/Private type ecryptfs (...)
</pre>
<p>for the user's encrypted directory. It should be perfectly readable at <code>~/Private/</code>.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> The above changes to <code>system-auth</code> enable auto-mounting for normal login. If you switch users instead using <code>su -l</code>, you need to apply similar changes also to <code>/etc/pam.d/su-l</code>.</div>
<p>The latter should be automatically unmounted and made unavailable when the user logs off.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> If you use systemd-user <a href="../en/Systemd/User.html#Automatic_start-up_of_systemd_user_instances" title="Systemd/User">lingering</a> services, or other separate processes that survive after you logout, your home directory will not get unmounted until they exit. This is intended, because the user processes should always be able to save their state.</div>
<h3><span class="mw-headline" id="ecryptfs-simple">ecryptfs-simple</span></h3>
<p>Use <a rel="nofollow" class="external text" href="https://xyne.dev/projects/ecryptfs-simple/">ecryptfs-simple</a> if you just want to use eCryptfs to mount arbitrary directories the way you can with <a href="../en/EncFS.html" title="EncFS">EncFS</a>. ecryptfs-simple does not require root privileges or entries in <code>/etc/fstab</code>, nor is it limited to hard-coded directories such as <code>~/.Private/</code>. The package is available to be <a href="../en/Help:Reading.html#Installation_of_packages" class="mw-redirect" title="Install">installed</a> as <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/ecryptfs-simple/">ecryptfs-simple</a></span><sup><small>AUR</small></sup> and from <a rel="nofollow" class="external text" href="https://xyne.dev/repos/">Xyne's repos</a>.
</p>
<p>As the name implies, usage is simple:
</p>
<p>Simple mounting:
</p>
<pre>$ ecryptfs-simple /path/to/foo /path/to/bar
</pre>
<p>Automatic mounting: prompts for options on the first mount of a directory then reloads them next time:
</p>
<pre>$ ecryptfs-simple -a /path/to/foo /path/to/bar
</pre>
<p>Unmounting by source directory:
</p>
<pre>$ ecryptfs-simple -u /path/to/foo
</pre>
<p>Unmounting by mountpoint:
</p>
<pre>$ ecryptfs-simple -u /path/to/bar
</pre>
<h3><span class="mw-headline" id="Manual_setup">Manual setup</span></h3>
<p>The following details instructions to set up eCryptfs encrypted directories manually. This involves two steps. First, the passphrase is processed and loaded into the kernel keyring. Second, the filesystem is actually mounted using the key from the keyring.
</p>
<p>There are two ways to add the passphrase to the kernel keyring in the first step. The simpler option is <code>ecryptfs-add-passphrase</code>, which uses a single passphrase to encrypt the files. The disadvantage is that you cannot change the passphrase later. It works like this:
</p>
<pre>$ ecryptfs-add-passphrase
Passphrase:
Inserted auth tok with sig [78c6f0645fe62da0] into the user session keyring
</pre>
<p>You can also pipe a passphrase into <code>ecryptfs-add-passphrase -</code>. Keep in mind that if you leave your passphrase in a file, it will usually defeat the purpose of using encryption.
</p>
<p>As an alternative to a plain passphrase, you can use a "wrapped passphrase", where the files are encrypted using a randomly generated key, which is itself encrypted with your passphrase and stored in a file. In this case, you can change your passphrase by unwrapping the key file with your old passphrase and rewrapping it using your new passphrase.
</p>
<p>In the following we <a rel="nofollow" class="external text" href="https://stackoverflow.com/a/3980713">prompt</a> for the wrapping passphrase and do a generation similar to the <a rel="nofollow" class="external text" href="https://bazaar.launchpad.net/~ecryptfs/ecryptfs/trunk/view/head:/src/utils/ecryptfs-setup-private#L96">source</a> and then use <i>ecryptfs-wrap-passphrase</i> to wrap it with the given password to <code>~/.ecryptfs/wrapped-passphrase</code>:
</p>
<pre>$ mkdir ~/.ecryptfs
$ ( stty -echo; printf "Passphrase: " 1&gt;&amp;2; read PASSWORD; stty echo; echo 1&gt;&amp;2; head -c 48 /dev/random | base64; echo "$PASSWORD"; ) \
  | ecryptfs-wrap-passphrase ~/.ecryptfs/wrapped-passphrase &gt;/dev/null
</pre>
<p>Do not use a passphrase with more than 64 characters as this will result in an error later when using <code>ecryptfs-insert-wrapped-passphrase-into-keyring</code>.
</p>
<p>Next, we can enter our passphrase to load the key into the keyring:
</p>
<pre>$ ( stty -echo; printf "Passphrase: " 1&gt;&amp;2; read PASSWORD; stty echo; echo $PASSWORD; ) | ecryptfs-insert-wrapped-passphrase-into-keyring ~/.ecryptfs/wrapped-passphrase -
Inserted auth tok with sig [7c5d3dd8a1b49db0] into the user session keyring
</pre>
<p>In either case, when you successfully add the passphrase to the kernel keyring, you will get a "key signature" like <code>78c6f0645fe62da0</code> which you will need in the next step.
</p>
<p>There are two different ways of manually mounting eCryptfs, described in the following sections. The first way, using <code>mount.ecryptfs_private</code>, can be run as a regular user and involves setting up some configuration files. This method does not allow you to change the encryption settings, such as key size. The second way is to use a raw <code>mount</code> command, which gives you complete control over all settings, but requires you to either run it as root, or add an entry to <code>/etc/fstab</code> which lets a user mount eCryptfs.
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> The following examples use an encrypted directory (<code>.secret</code>) different to the default, hard-coded <code>.Private</code> in the Ubuntu tools. This is on purpose to avoid problems of erroneous <a href="#Auto-mounting">#Auto-mounting</a> when the system has PAM setup for it, as well as problems with other tools using the hard-coded defaults.</div>
<h4><span class="mw-headline" id="With_configuration_files">With configuration files</span></h4>
<p>This method involves running <code>mount.ecryptfs_private</code> from the <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=ecryptfs-utils">ecryptfs-utils</a></span> package, after first loading your passphrase. This binary requires no root privileges to work by default.
</p>
<p>First choose a name for your configuration files in <code>~/.ecryptfs/</code> and decide on the lower and upper directories. In this example we use <code>secret</code> for the configuration files, put in encrypted data in <code>~/.secret/</code>, and mount the decrypted files at <code>~/secret/</code>. Create the required directories:
</p>
<pre>$ mkdir ~/.secret ~/secret ~/.ecryptfs
</pre>
<p>Now specify the directories in <code>~/.ecryptfs/secret.conf</code>, using full paths. Its format looks like the one in <code>/etc/fstab</code> without the mount options:
</p>
<pre>$ echo "$HOME/.secret $HOME/secret ecryptfs" &gt; ~/.ecryptfs/secret.conf
</pre>
<p>Write the key signature you got from <code>ecryptfs-add-passphrase</code> or <code>ecryptfs-insert-wrapped-passphrase-into-keyring</code> (see above) into <code>~/.ecryptfs/secret.sig</code>:
</p>
<pre>$ echo 78c6f0645fe62da0 &gt; ~/.ecryptfs/secret.sig
</pre>
<p>If you also want to enable filename encryption, add a second passphrase to the keyring (or reuse the first passphrase) and <b>append</b> its key signature to <code>~/.ecryptfs/secret.sig</code>:
</p>
<pre> $ echo 326a6d3e2a5d444a &gt;&gt; ~/.ecryptfs/secret.sig
</pre>
<p>Finally, mount <code>~/.secret/</code> on <code>~/secret/</code>:
</p>
<pre>$ mount.ecryptfs_private secret
</pre>
<p>When you are done, unmount it:
</p>
<pre>$ umount.ecryptfs_private secret
</pre>
<h4><span class="mw-headline" id="Raw_mount_command">Raw mount command</span></h4>
<p>By running the actual <code>mount</code> command manually, you get complete control over the encryption options. The disadvantage is that you need to either run <code>mount</code> as root, or add an entry to <code>/etc/fstab</code> for each eCryptfs directory so users can mount them.
</p>
<p>First create your private directories. In this example, we use the same ones as the previous section:
</p>
<pre>$ mkdir -m 700 ~/.secret
$ mkdir -m 500 ~/secret
</pre>
<p>To summarize:
</p>
<ul>
<li>Actual encrypted data will be stored in the lower <code>~/.secret/</code> directory</li>
<li>While mounted, decrypted data will be available in <code>~/secret/</code> directory
<ul>
<li>While not mounted nothing can be written to this directory</li>
<li>While mounted it has the same permissions as the lower directory</li>
</ul>
</li>
</ul>
<p>Now, supposed you have created the <a href="#Manual_setup">wrapped keyphrase</a> above, you need to insert the encryption key once to the root user's keyring:
</p>
<pre># ( stty -echo; printf "Passphrase: " 1&gt;&amp;2; read PASSWORD; stty echo; echo $PASSWORD; ) | ecryptfs-insert-wrapped-passphrase-into-keyring /home/<i>username</i>/.ecryptfs/wrapped-passphrase -
Inserted auth tok with sig [7c5d3dd8a1b49db0] into the user session keyring
</pre>
<p>so that the following mount command succeeds:
</p>
<pre># mount <b>-i</b> -t ecryptfs /home/<i>username</i>/.secret /home/<i>username</i>/secret -o ecryptfs_sig=7c5d3dd8a1b49db0,ecryptfs_fnek_sig=7c5d3dd8a1b49db0,ecryptfs_cipher=aes,ecryptfs_key_bytes=32,ecryptfs_unlink_sigs
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> As of 2022, this command does not work because of a bug in systemd (see <a rel="nofollow" class="external text" href="https://bugs.archlinux.org/task/55943">FS#55943</a>). A <a rel="nofollow" class="external text" href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=870126#10">workaround</a> is to run <code>keyctl link @u @s</code> before mounting.</div>
<ul>
<li>
<code>ecryptfs_sig</code> sets the data passphrase key signature.</li>
<li>
<code>ecryptfs_fnek_sig</code> sets the filename passphrase key signature; you can omit this option if you do not want to encrypt filenames.</li>
<li>
<code>ecryptfs_key_bytes</code> can be 16, 24, or 32 to change the encryption key size.</li>
<li>
<code>ecryptfs_unlink_sigs</code> will remove the passphrase(s) from the keyring when you unmount, so you have to add the passphrase(s) back again in order to re-mount the filesystem.</li>
<li>There are a few other options listed in <span class="plainlinks archwiki-template-man" title="$ man 7 ecryptfs"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/ecryptfs.7#OPTIONS">ecryptfs(7) § OPTIONS</a></span>.</li>
</ul>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> There is a <code>mount.ecryptfs</code> tool, which you can run as root to enter the mount settings interactively. Once you have used it to mount eCryptfs, you can check <code>/etc/mtab</code> to find out what options it used.</div>
<p>Once you have chosen the right mount options, you can add an entry to <code>/etc/fstab</code> so regular users can mount eCryptfs on these directories. Copy the mount options to a new <code>/etc/fstab</code> entry and add the options <code>user</code> and <code>noauto</code>. The full entry will look similar to (bold entries added):
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/fstab</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">/home/<i>username</i>/.secret /home/<i>username</i>/secret ecryptfs <b>noauto</b>,<b>user</b>,ecryptfs_sig=7c5d3dd8a1b49db0,ecryptfs_fnek_sig=7c5d3dd8a1b49db0,ecryptfs_cipher=aes,ecryptfs_key_bytes=32,ecryptfs_unlink_sigs <b>0 0</b></pre>
<ul>
<li>The <code>noauto</code> option is important, because otherwise systemd will error trying to mount the entry directly on boot.</li>
<li>The <code>user</code> option enables to mount the directory as a user.
<ul><li>The user mount will default to option <code>noexec</code>. If you want to have at least executable files in your private directory, you can add <code>exec</code> to the fstab options.</li></ul>
</li>
</ul>
<p>The setup is now complete and the directory should be mountable by the user.
</p>
<h5><span class="mw-headline" id="Mounting_2">Mounting</span></h5>
<p>To mount the encrypted directory as the user, the passphrase must be unwrapped and made available in the user's keyring. Following above section example:
</p>
<pre>$ ecryptfs-insert-wrapped-passphrase-into-keyring ~/.ecryptfs/wrapped-passphrase
Passphrase:
Inserted auth tok with sig [7c5d3dd8a1b49db0] into the user session keyring
</pre>
<p>Now the directory can be mounted without the mount helper questions:
</p>
<pre>$ mount <b>-i</b> ~/secret
</pre>
<p>and files be placed into the <code>secret</code> directory. The above two steps are necessary every time to mount the directory manually.
</p>
<p>To unmount it again:
</p>
<pre>$ umount ~/secret
</pre>
<p>To finalize, the preliminary passphrase to wrap the encryption passphrase may be changed:
</p>
<pre>$ ecryptfs-rewrap-passphrase ~/.ecryptfs/wrapped-passphrase
Old wrapping passphrase:
New wrapping passphrase:
New wrapping passphrase (again):
</pre>
<p>The unmounting should also clear the keyring, to check the user's keyring or clear it manually:
</p>
<pre>$ keyctl list @u
$ keyctl clear @u
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> One should remember that <code>/etc/fstab</code> is for system-wide partitions only and should not generally be used for user-specific mounts.</div>
<h5><span class="mw-headline" id="Auto-mounting_2">Auto-mounting</span></h5>
<p>Different methods can be employed to automount the previously defined user-mount in <code>/etc/fstab</code> on login. As a first general step, follow point (1) and (2) of <a href="#Auto-mounting">#Auto-mounting</a>.
</p>
<p>Then, if you login via console, a simple way is to specify the <a href="#Mounting_2">user-interactive</a> <i>mount</i> and <i>umount</i> in the user's shell configuration files, for example <a href="../en/Bash.html#Configuration_files" title="Bash">Bash#Configuration files</a>.
</p>
<div class="noprint archwiki-template-message">
<p><span class="mw-default-size" typeof="mw:File"><span><img src="../File:Inaccurate.svg" decoding="async" width="48" height="48" class="mw-file-element"></span></span><b>The factual accuracy of this article or section is disputed.</b></p>
<div>
<b>Reason:</b> <br>- the section should be more generic than it is now<br>
- the described method does not work for users, for encountered problems: (Discuss in <a href="../en/Talk:ECryptfs.html#Automounting" title="Talk:ECryptfs">Talk:ECryptfs#Automounting</a>)</div>
</div>
<p>Another method is to automount the eCryptfs directory on user login using <a href="../en/Pam_mount.html" title="Pam mount">pam_mount</a>. To configure this method, add the following lines to <code>/etc/security/pam_mount.conf.xml</code>:
</p>
<pre>&lt;luserconf name=".pam_mount.conf.xml" /&gt;
&lt;mntoptions require="" /&gt; 
&lt;lclmount&gt;mount -i %(VOLUME) "%(before=\"-o\" OPTIONS)"&lt;/lclmount&gt; 
</pre>
<p>Please prefer writing manually these lines instead of simply copy/pasting them (especially the lclmount line). Otherwise, you might get some corrupted characters.
Explanation:
</p>
<ul>
<li>the first line indicates where the user-based configuration file is located (here <code>~/.pam_mount.conf.xml</code>)</li>
<li>the second line overwrites the default required mount options which are unnecessary ("nosuid,nodev")</li>
<li>the last line indicates which mount command to run (eCryptfs needs the <code>-i</code> switch).</li>
</ul>
<p>Then set the volume definition, preferably to <code>~/.pam_mount.conf.xml</code>:
</p>
<pre>&lt;pam_mount&gt;
    &lt;volume noroot="1" fstype="ecryptfs" path="/home/<i>username</i>/.secret/" mountpoint="/home/<i>username</i>/secret/" /&gt;
&lt;/pam_mount&gt;
</pre>
<p>"noroot" is needed because the encryption key will be added to the user's keyring.
</p>
<p>Finally, edit <code>/etc/pam.d/system-login</code> as described in the <a href="../en/Pam_mount.html" title="Pam mount">pam_mount</a> article.
</p>
<h6><span class="mw-headline" id="Optional_step">Optional step</span></h6>
<p>To avoid needlessly wasting time unwrapping the passphrase, you can create a script that will check <i>pmvarrun</i> to see the number of open sessions:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/usr/local/bin/doecryptfs</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">#!/bin/sh
exit $(/usr/sbin/pmvarrun -u$PAM_USER -o0)</pre>
<p>With the following line added before the eCryptfs unwrap module in your PAM stack:
</p>
<pre>auth    [success=ignore default=1]    pam_exec.so     quiet /usr/local/bin/doecryptfs
auth    required                      pam_ecryptfs.so unwrap
</pre>
<p>The article suggests adding these to <code>/etc/pam.d/login</code>, but the changes will need to be added to all other places you login, such as <code>/etc/pam.d/kde</code>.
</p>
<h2><span class="mw-headline" id="Usage">Usage</span></h2>
<div class="noprint archwiki-template-message">
<p><span class="mw-default-size" typeof="mw:File"><span><img src="../File:Tango-view-fullscreen.svg" decoding="async" width="48" height="48" class="mw-file-element"></span></span><b>This article or section needs expansion.</b></p>
<div>
<b>Reason:</b> Content that still may to be covered:
<p>- point to the above "Setup &amp; Mounting" section for how to mount and unmount [this section here will cover all other (i.e. setup-independent) usage info]<br>
- reference ecryptfs tools not used/mentioned in the prior sections (e.g. with a short link to the online manpages and mention of the other tools usage, as it seems useful (not covered yet are, e.g. ecryptfs-stat, ecryptfs-find, ecryptfs-rewrite-file.) <br>
- mention the options to share an encrypted folder between users and to place non-encrypted files or folders in the encrypted container ("pass-through")
(references for the points: <a rel="nofollow" class="external autonumber" href="https://wiki.archlinux.org/index.php?title&amp;61;Talk:ECryptfs&amp;oldid&amp;61;347981">[6]</a> and (maybe) <a rel="nofollow" class="external autonumber" href="https://wiki.archlinux.org/index.php?title&amp;61;ECryptfs&amp;oldid&amp;61;291214">[7]</a>)
</p>
 (Discuss in <a href="../en/Talk:ECryptfs.html#Major_restructuring/rewrite" title="Talk:ECryptfs">Talk:ECryptfs#Major_restructuring/rewrite</a>)</div>
</div>
<h3><span class="mw-headline" id="Symlinking_into_the_encrypted_directory">Symlinking into the encrypted directory</span></h3>
<p>Besides using your private directory as storage for sensitive files, and private data, you can also use it to protect application data. <a href="../en/Firefox.html" title="Firefox">Firefox</a> for example has an internal password manager, but the browsing history and cache can also be sensitive. Protecting it is easy:
</p>
<pre>$ mv ~/.mozilla ~/Private/mozilla
$ ln -s ~/Private/mozilla ~/.mozilla
</pre>
<h3><span class="mw-headline" id="Removal_of_encryption">Removal of encryption</span></h3>
<p>There are no special steps involved, if you want to remove your private directory. Make sure it is un-mounted and delete the respective lower directory (e.g. <code>~/.Private/</code>), along with all the encrypted files. After also removing the related encryption signatures and configuration in <code>~/.ecryptfs/</code>, all is gone.
</p>
<p>If you were using the <a href="#Ubuntu_tools">#Ubuntu tools</a> to setup a single directory encryption, you can directly follow the steps detailed by:
</p>
<pre>$ ecryptfs-setup-private --undo
</pre>
<p>and follow the instructions.
</p>
<h3><span class="mw-headline" id="Backup">Backup</span></h3>
<p>If you want to move a file out of the private directory just move it to the new destination while <code>~/Private/</code> is mounted.
</p>
<p>With eCryptfs the cryptographic metadata is stored in the header of the files. Setup variants explained in this article separate the directory with encrypted data from the mount point. The unencrypted mount point is fully transparent and available for a backup. Obviously this has to be considered for automated backups, if one has to avoid leaking sensitive unencrypted data into a backup.
</p>
<p>You can do backups, or incremental backups, of the encrypted (e.g. <code>~/.Private/</code>) directory, treating it like any other directory.
</p>
<p>Further points to note:
</p>
<ul>
<li>If you used the Ubuntu tools for <a href="#Encrypting_a_home_directory">#Encrypting a home directory</a>, be aware the location of the lower directory with the encrypted files is <i>outside</i> the regular user's <code>$HOME</code> at <code>/home/.ecryptfs/<i>username</i>/.Private/</code>.</li>
<li>It should be ensured to include the eCryptfs setup files (located in <code>~/.ecryptfs/</code> usually) into the regular or a separate backup.</li>
<li>If you use special filesystem mount options, for example <code>ecryptfs_xattr</code>, do extra checks on restore integrity.</li>
</ul>
<h2><span class="mw-headline" id="Known_issues">Known issues</span></h2>
<h3><span class="mw-headline" id="Mounting_may_fail_on_a_remote_host_when_connecting_via_Mosh">Mounting may fail on a remote host when connecting via Mosh</span></h3>
<p>This is a <a rel="nofollow" class="external text" href="https://github.com/mobile-shell/mosh/issues/529">known issue</a> of <a rel="nofollow" class="external text" href="https://mosh.org/">Mosh</a> server, which does not keep the eCryptfs <code>/home</code> directory mounted.
</p>
<h2><span class="mw-headline" id="See_also">See also</span></h2>
<ul>
<li>
<a rel="nofollow" class="external text" href="https://ecryptfs.org/documentation.html">eCryptfs</a> - Manpages and project home</li>
<li>
<a rel="nofollow" class="external text" href="https://defuse.ca/audits/ecryptfs.htm">Security audit</a> of eCryptfs by Taylor Hornby (January 22, 2014).</li>
<li>
<a rel="nofollow" class="external text" href="https://sysphere.org/~anrxc/j/articles/ecryptfs/index.html">eCryptfs and $HOME</a> by Adrian C. (anrxc) - Article with installation instructions and discussion of eCryptfs usage</li>
<li>
<a rel="nofollow" class="external text" href="https://www.chromium.org/chromium-os/chromiumos-design-docs/protecting-cached-user-data">Chromium data protection</a> (November 2009) - Design document detailing encryption options for Chromium OS, including explanation on its eCryptfs usage</li>
<li>
<a rel="nofollow" class="external text" href="http://ecryptfs.sourceforge.net/ecryptfs.pdf">eCryptfs design</a> by Michael Halcrow (May 2005) - Original design document detailing and discussing eCryptfs</li>
</ul>
</div>
</div>
					<div id="catlinks" class="catlinks" data-mw="interface">
<div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../Special:Categories.html" title="Special:Categories">Categories</a>: <ul>
<li><a href="../en/Category:Data-at-rest_encryption.html" title="Category:Data-at-rest encryption">Data-at-rest encryption</a></li>
<li><a href="../en/Category:Stackable_file_systems.html" title="Category:Stackable file systems">Stackable file systems</a></li>
</ul>
</div>
<div id="mw-hidden-catlinks" class="mw-hidden-catlinks mw-hidden-cats-hidden">Hidden categories: <ul>
<li><a href="../en/Category:Pages_with_dead_links.html" title="Category:Pages with dead links">Pages with dead links</a></li>
<li><a href="../en/Category:Pages_or_sections_flagged_with_Template:Accuracy.html" title="Category:Pages or sections flagged with Template:Accuracy">Pages or sections flagged with Template:Accuracy</a></li>
<li><a href="../en/Category:Pages_or_sections_flagged_with_Template:Expansion.html" title="Category:Pages or sections flagged with Template:Expansion">Pages or sections flagged with Template:Expansion</a></li>
</ul>
</div>
</div>
				</div>
			</main>
			
		</div>
		<div class="mw-footer-container">
			
<footer id="footer" class="mw-footer" role="contentinfo" style="margin: 0">
	<ul id="footer-info">
	<li data-nosnippet="">Retrieved from "<a dir="ltr" href="https://wiki.archlinux.org/index.php?title=ECryptfs&amp;oldid=791646">https://wiki.archlinux.org/index.php?title=ECryptfs&amp;oldid=791646</a>"</li>
<li id="footer-info-lastmod"> This page was last edited on 1 November 2023, at 17:22.</li>
	<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="https://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.3 or later</a> unless otherwise noted.</li>
<br>
</ul>

	<ul id="footer-places">
	<li id="footer-places-privacy"><a href="https://terms.archlinux.org/docs/privacy-policy/">Privacy policy</a></li>
	<li id="footer-places-about"><a href="../en/ArchWiki:About.html">About ArchWiki</a></li>
	<li id="footer-places-disclaimers"><a href="../en/ArchWiki:General_disclaimer.html">Disclaimers</a></li>
</ul>

	<ul id="footer-icons" class="noprint">
	<li id="footer-copyrightico"><a href="https://www.gnu.org/copyleft/fdl.html"><img src="/resources/assets/licenses/gnu-fdl.png" alt="GNU Free Documentation License 1.3 or later" width="88" height="31" loading="lazy"></a></li>
	<li id="footer-poweredbyico"><img src="/resources/assets/poweredby_mediawiki_88x31.png" srcset="/resources/assets/poweredby_mediawiki_132x47.png 1.5x, /resources/assets/poweredby_mediawiki_176x62.png 2x" width="88" height="31" loading="lazy"></li>
</ul>

</footer>

		</div>
	</div> 
</div> 
<div class="vector-settings" id="p-dock-bottom">
	<ul>
		<li>
		
		<button class="cdx-button cdx-button--icon-only vector-limited-width-toggle" id=""><span class="vector-icon mw-ui-icon-fullScreen mw-ui-icon-wikimedia-fullScreen"></span>

<span>Toggle limited content width</span>
</button>
</li>
	</ul>
</div>
</body>
</html>
