<!DOCTYPE html>
<html class="client-nojs vector-feature-language-in-header-enabled vector-feature-language-in-main-page-header-disabled vector-feature-sticky-header-disabled vector-feature-page-tools-pinned-disabled vector-feature-toc-pinned-clientpref-1 vector-feature-main-menu-pinned-disabled vector-feature-limited-width-clientpref-1 vector-feature-limited-width-content-enabled vector-feature-custom-font-size-clientpref-0 vector-feature-client-preferences-disabled vector-feature-client-prefs-pinned-disabled vector-feature-night-mode-disabled skin-theme-clientpref-day vector-toc-available" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>Virtual user mail system with Postfix, Dovecot and Roundcube - ArchWiki</title>
<link rel="stylesheet" href="../ArchWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<meta name="generator" content="MediaWiki 1.42.1">
<meta name="referrer" content="no-referrer-when-downgrade">
<meta name="robots" content="max-image-preview:standard">
<meta name="format-detection" content="telephone=no">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=0.25, maximum-scale=5.0">
<link rel="icon" href="/favicon.ico">
<link rel="search" type="application/opensearchdescription+xml" href="/opensearch_desc.php" title="ArchWiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.archlinux.org/api.php?action=rsd">
<link rel="license" href="https://www.gnu.org/copyleft/fdl.html">
<link rel="alternate" type="application/atom+xml" title="ArchWiki Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="skin-vector skin-vector-search-vue mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-Virtual_user_mail_system_with_Postfix_Dovecot_and_Roundcube rootpage-Virtual_user_mail_system_with_Postfix_Dovecot_and_Roundcube skin-vector-2022 action-view skin--responsive">
<a class="mw-jump-link" href="#bodyContent">Jump to content</a>
<div class="vector-header-container">
	</div>
<div class="mw-page-container">
	<div class="mw-page-container-inner">
		<div class="vector-column-start">
			<div class="vector-main-menu-container">
		</div>
	<div class="vector-sticky-pinned-container">
				<nav id="mw-panel-toc" role="navigation" aria-label="Contents" data-event-name="ui.sidebar-toc" class="mw-table-of-contents-container vector-toc-landmark">
					<div id="vector-toc-pinned-container" class="vector-pinned-container">
					<div id="vector-toc" class="vector-toc vector-pinnable-element">
	<div class="vector-pinnable-header vector-toc-pinnable-header vector-pinnable-header-pinned" data-feature-name="toc-pinned" data-pinnable-element-id="vector-toc">
	<h2 class="vector-pinnable-header-label">Contents</h2>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-pin-button" data-event-name="pinnable-header.vector-toc.pin">move to sidebar</button>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-unpin-button" data-event-name="pinnable-header.vector-toc.unpin">hide</button>
</div>


	<ul class="vector-toc-contents" id="mw-panel-toc-list">
		<li id="toc-mw-content-text" class="vector-toc-list-item vector-toc-level-1">
			<a href="#" class="vector-toc-link">
				<div class="vector-toc-text">Beginning</div>
			</a>
		</li>
		<li id="toc-Installation" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#Installation">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">1</span>Installation</div>
		</a>
		
		<ul id="toc-Installation-sublist" class="vector-toc-list">
		</ul>
	</li>
	<li id="toc-Configuration" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#Configuration">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">2</span>Configuration</div>
		</a>
		
			<button aria-controls="toc-Configuration-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Configuration subsection</span>
			</button>
		
		<ul id="toc-Configuration-sublist" class="vector-toc-list">
			<li id="toc-User" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#User">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.1</span>User</div>
			</a>
			
			<ul id="toc-User-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Database" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Database">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.2</span>Database</div>
			</a>
			
			<ul id="toc-Database-sublist" class="vector-toc-list">
				<li id="toc-PostfixAdmin" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#PostfixAdmin">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.2.1</span>PostfixAdmin</div>
			</a>
			
			<ul id="toc-PostfixAdmin-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-SSL_certificate" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#SSL_certificate">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.3</span>SSL certificate</div>
			</a>
			
			<ul id="toc-SSL_certificate-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Postfix" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Postfix">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.4</span>Postfix</div>
			</a>
			
			<ul id="toc-Postfix-sublist" class="vector-toc-list">
				<li id="toc-Setting_up_Postfix" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Setting_up_Postfix">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.4.1</span>Setting up Postfix</div>
			</a>
			
			<ul id="toc-Setting_up_Postfix-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Create_the_file_structure" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Create_the_file_structure">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.4.2</span>Create the file structure</div>
			</a>
			
			<ul id="toc-Create_the_file_structure-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Dovecot" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Dovecot">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.5</span>Dovecot</div>
			</a>
			
			<ul id="toc-Dovecot-sublist" class="vector-toc-list">
				<li id="toc-DH_parameters" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#DH_parameters">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.5.1</span>DH parameters</div>
			</a>
			
			<ul id="toc-DH_parameters-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-PostfixAdmin_2" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#PostfixAdmin_2">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.6</span>PostfixAdmin</div>
			</a>
			
			<ul id="toc-PostfixAdmin_2-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Roundcube" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Roundcube">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.7</span>Roundcube</div>
			</a>
			
			<ul id="toc-Roundcube-sublist" class="vector-toc-list">
				<li id="toc-Apache_configuration" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Apache_configuration">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.7.1</span>Apache configuration</div>
			</a>
			
			<ul id="toc-Apache_configuration-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Roundcube:_Change_Password_Plugin" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Roundcube:_Change_Password_Plugin">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.7.2</span>Roundcube: Change Password Plugin</div>
			</a>
			
			<ul id="toc-Roundcube:_Change_Password_Plugin-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Fire_it_up" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#Fire_it_up">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">3</span>Fire it up</div>
		</a>
		
		<ul id="toc-Fire_it_up-sublist" class="vector-toc-list">
		</ul>
	</li>
	<li id="toc-Testing" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#Testing">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">4</span>Testing</div>
		</a>
		
			<button aria-controls="toc-Testing-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Testing subsection</span>
			</button>
		
		<ul id="toc-Testing-sublist" class="vector-toc-list">
			<li id="toc-Error_response" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Error_response">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">4.1</span>Error response</div>
			</a>
			
			<ul id="toc-Error_response-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-See_that_you_have_received_a_email" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#See_that_you_have_received_a_email">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">4.2</span>See that you have received a email</div>
			</a>
			
			<ul id="toc-See_that_you_have_received_a_email-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Optional_Items" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#Optional_Items">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">5</span>Optional Items</div>
		</a>
		
			<button aria-controls="toc-Optional_Items-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Optional Items subsection</span>
			</button>
		
		<ul id="toc-Optional_Items-sublist" class="vector-toc-list">
			<li id="toc-Quota" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Quota">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">5.1</span>Quota</div>
			</a>
			
			<ul id="toc-Quota-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Autocreate_and_autosubscribe_folders_in_Dovecot" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Autocreate_and_autosubscribe_folders_in_Dovecot">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">5.2</span>Autocreate and autosubscribe folders in Dovecot</div>
			</a>
			
			<ul id="toc-Autocreate_and_autosubscribe_folders_in_Dovecot-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Dovecot_public_folder_and_global_ACLs" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Dovecot_public_folder_and_global_ACLs">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">5.3</span>Dovecot public folder and global ACLs</div>
			</a>
			
			<ul id="toc-Dovecot_public_folder_and_global_ACLs-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Fighting_Spam" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Fighting_Spam">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">5.4</span>Fighting Spam</div>
			</a>
			
			<ul id="toc-Fighting_Spam-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Sidenotes" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#Sidenotes">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">6</span>Sidenotes</div>
		</a>
		
			<button aria-controls="toc-Sidenotes-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Sidenotes subsection</span>
			</button>
		
		<ul id="toc-Sidenotes-sublist" class="vector-toc-list">
			<li id="toc-Alternative_vmail_folder_structure" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Alternative_vmail_folder_structure">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">6.1</span>Alternative vmail folder structure</div>
			</a>
			
			<ul id="toc-Alternative_vmail_folder_structure-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Troubleshooting" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#Troubleshooting">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">7</span>Troubleshooting</div>
		</a>
		
			<button aria-controls="toc-Troubleshooting-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Troubleshooting subsection</span>
			</button>
		
		<ul id="toc-Troubleshooting-sublist" class="vector-toc-list">
			<li id="toc-IMAP/POP3_client_failing_to_receive_mails" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#IMAP/POP3_client_failing_to_receive_mails">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">7.1</span>IMAP/POP3 client failing to receive mails</div>
			</a>
			
			<ul id="toc-IMAP/POP3_client_failing_to_receive_mails-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Roundcube_not_able_to_delete_emails_or_view_any_'standard'_folders" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Roundcube_not_able_to_delete_emails_or_view_any_'standard'_folders">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">7.2</span>Roundcube not able to delete emails or view any 'standard' folders</div>
			</a>
			
			<ul id="toc-Roundcube_not_able_to_delete_emails_or_view_any_'standard'_folders-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-LMTP_/_Sieve" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#LMTP_/_Sieve">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">7.3</span>LMTP / Sieve</div>
			</a>
			
			<ul id="toc-LMTP_/_Sieve-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Are_your_emails_sent_to_gmail_users_ending_up_in_their_junk/spam_folders?" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Are_your_emails_sent_to_gmail_users_ending_up_in_their_junk/spam_folders?">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">7.4</span>Are your emails sent to gmail users ending up in their junk/spam folders?</div>
			</a>
			
			<ul id="toc-Are_your_emails_sent_to_gmail_users_ending_up_in_their_junk/spam_folders?-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id='toc-Sending_and_receiving_mails_broken,_logs_mentioning_"transport_maps_lookup_failure"_along_with_"unsupported_dictionary_type:_hash"' class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href='#Sending_and_receiving_mails_broken,_logs_mentioning_"transport_maps_lookup_failure"_along_with_"unsupported_dictionary_type:_hash"'>
				<div class="vector-toc-text">
				<span class="vector-toc-numb">7.5</span>Sending and receiving mails broken, logs mentioning "transport_maps lookup failure" along with "unsupported dictionary type: hash"</div>
			</a>
			
			<ul id='toc-Sending_and_receiving_mails_broken,_logs_mentioning_"transport_maps_lookup_failure"_along_with_"unsupported_dictionary_type:_hash"-sublist' class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-See_also" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#See_also">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">8</span>See also</div>
		</a>
		
		<ul id="toc-See_also-sublist" class="vector-toc-list">
		</ul>
	</li>
</ul>
</div>

					</div>
		</nav>
			</div>
		</div>
		<div class="mw-content-container">
			<main id="content" class="mw-body" role="main" style="margin: 0">
				<header class="mw-body-header vector-page-titlebar">
					<nav role="navigation" aria-label="Contents" class="vector-toc-landmark">
						
<div id="vector-page-titlebar-toc" class="vector-dropdown vector-page-titlebar-toc vector-button-flush-left">
	<input type="checkbox" id="vector-page-titlebar-toc-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-vector-page-titlebar-toc" class="vector-dropdown-checkbox " aria-label="Toggle the table of contents">
	<label id="vector-page-titlebar-toc-label" for="vector-page-titlebar-toc-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--icon-only " aria-hidden="true"><span class="vector-icon mw-ui-icon-listBullet mw-ui-icon-wikimedia-listBullet"></span>

<span class="vector-dropdown-label-text">Toggle the table of contents</span>
	</label>
	<div class="vector-dropdown-content">


							<div id="vector-page-titlebar-toc-unpinned-container" class="vector-unpinned-container">
			</div>
		
	</div>
</div>

					</nav>
					<h1 id="firstHeading" class="firstHeading mw-first-heading"><span class="mw-page-title-main">Virtual user mail system with Postfix, Dovecot and Roundcube</span></h1>
							
<div id="p-lang-btn" class="vector-dropdown mw-portlet mw-portlet-lang">
	<input type="checkbox" id="p-lang-btn-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-p-lang-btn" class="vector-dropdown-checkbox mw-interlanguage-selector" aria-label="Go to an article in another language. Available in 1 language">
	<label id="p-lang-btn-label" for="p-lang-btn-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--action-progressive mw-portlet-lang-heading-1" aria-hidden="true"><span class="vector-icon mw-ui-icon-language-progressive mw-ui-icon-wikimedia-language-progressive"></span>

<span class="vector-dropdown-label-text">1 language</span>
	</label>
	<div class="vector-dropdown-content">

		<div class="vector-menu-content">
			
			<ul class="vector-menu-content-list">
				
				<li class="interlanguage-link interwiki-ja mw-list-item"><a href="https://wiki.archlinux.jp/index.php/%E4%BB%AE%E6%83%B3%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E3%83%A1%E3%83%BC%E3%83%AB%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0" title="仮想ユーザーメールシステム – 日本語" lang="ja" hreflang="ja" class="interlanguage-link-target"><span>日本語</span></a></li>
			</ul>
			
		</div>

	</div>
</div>
</header>
				<div class="vector-column-end">
					<div class="vector-sticky-pinned-container">
						<nav class="vector-page-tools-landmark" aria-label="Page tools">
							<div id="vector-page-tools-pinned-container" class="vector-pinned-container">
				
							</div>
		</nav>
						<nav class="vector-client-prefs-landmark" aria-label="Appearance">
						</nav>
					</div>
				</div>
				<div id="bodyContent" class="vector-body" aria-labelledby="firstHeading" data-mw-ve-target-container>
					<div class="vector-body-before-content">
							<div class="mw-indicators">
		</div>

						<div id="siteSub" class="noprint">From ArchWiki</div>
					</div>
					<div id="contentSub"><div id="mw-content-subtitle"></div></div>
					
					
					<div id="mw-content-text" class="mw-body-content">
<div class="mw-content-ltr mw-parser-output" lang="en" dir="ltr">
<div class="archwiki-template-meta-related-articles">
<p>Related articles</p>
<ul>
<li><a href="../en/Courier_Mail_Server.html" class="mw-redirect" title="Courier MTA">Courier MTA</a></li>
<li><a href="../en/OpenDKIM.html" title="OpenDKIM">OpenDKIM</a></li>
<li><a href="../en/Postfix.html" title="Postfix">Postfix</a></li>
<li><a href="../en/SOGo.html" title="SOGo">SOGo</a></li>
<li><a href="../en/Dovecot.html" title="Dovecot">Dovecot</a></li>
</ul>
</div>
<div class="noprint archwiki-template-message">
<p><span class="mw-default-size" typeof="mw:File"><span><img src="../File:Merge-arrows-2.svg" decoding="async" width="36" height="40" class="mw-file-element"></span></span><b>This article or section is a candidate for merging with <a href="../en/Postfix.html" title="Postfix">Postfix</a>.</b></p>
<div>
<b>Notes:</b> Article duplicates <a href="../en/Postfix.html" title="Postfix">Postfix</a>, <a href="../en/Dovecot.html" title="Dovecot">Dovecot</a> and <a href="../en/Roundcube.html" title="Roundcube">Roundcube</a> and mainly consists of config snippets intended to be copy'n'pasted. (Discuss in <a rel="nofollow" class="external text" href="../en/Talk:Virtual_user_mail_system_with_Postfix,_Dovecot_and_Roundcube.html">Talk:Virtual user mail system with Postfix, Dovecot and Roundcube</a>)</div>
</div>
<p>This article describes how to set up a virtual user mail system, i.e. where the senders and recipients do not correspond to the Linux system users.
</p>
<p>Roughly, the components used in this article are <a href="../en/Postfix.html" title="Postfix">Postfix</a> as the mail server, <a href="../en/Dovecot.html" title="Dovecot">Dovecot</a> as the IMAP server, <a href="../en/Roundcube.html" title="Roundcube">Roundcube</a> as the webmail interface and PostfixAdmin as the administration interface to manage it all.
</p>
<p>In the end, the provided solution will allow you to use the best currently available security mechanisms, you will be able to send mails using SMTP and SMTPS and receive mails using POP3, POP3S, IMAP and IMAPS. Additionally, configuration will be easy thanks to PostfixAdmin and users will be able to login using Roundcube.
</p>
<meta property="mw:PageProp/toc">
<h2><span class="mw-headline" id="Installation">Installation</span></h2>
<p>Before you start, you must have both a working MySQL server as described in <a href="../en/MySQL.html" title="MySQL">MySQL</a> and a working Postfix server as described in <a href="../en/Postfix.html" title="Postfix">Postfix</a>.
</p>
<p><a href="../en/Help:Reading.html#Installation_of_packages" class="mw-redirect" title="Install">Install</a> the <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=postfix-mysql">postfix-mysql</a></span>, <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=dovecot">dovecot</a></span>, and <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=roundcubemail">roundcubemail</a></span> packages.
</p>
<h2><span class="mw-headline" id="Configuration">Configuration</span></h2>
<h3><span class="mw-headline" id="User">User</span></h3>
<p>For security reasons, a new user should be created to store the mails:
</p>
<pre># groupadd -g 5000 vmail
# useradd -u 5000 -g vmail -s /usr/bin/nologin -d /home/vmail -m vmail
</pre>
<p>A gid and uid of 5000 is used in both cases so that we do not run into conflicts with regular users. All your mail will then be stored in <code>/home/vmail</code>. You could change the home directory to something like <code>/var/mail/vmail</code> but be careful to change this in any configuration below as well.
</p>
<h3><span class="mw-headline" id="Database">Database</span></h3>
<p>You will need to create an empty database and corresponding user. In this article, the user <i>postfix_user</i> will have read/write access to the database <i>postfix_db</i> using <i>hunter2</i> as password. You are expected to create the database and user yourself, and give the user permission to use the database, as shown in the following code.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">$ mysql -u root -p</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">CREATE DATABASE postfix_db;
GRANT ALL ON postfix_db.* TO 'postfix_user'@'localhost' IDENTIFIED BY 'hunter2';
FLUSH PRIVILEGES;
</pre>
<div class="noprint archwiki-template-message">
<p><span class="mw-default-size" typeof="mw:File"><span><img src="../File:Tango-view-fullscreen.svg" decoding="async" width="48" height="48" class="mw-file-element"></span></span><b>This article or section needs expansion.</b></p>
<div>
<b>Reason:</b> Further manual database installation is missing. So far, the only way to follow this article is by installing PostfixAdmin with Apache, MySQL and PHP. (Discuss in <a rel="nofollow" class="external text" href="../en/Talk:Virtual_user_mail_system_with_Postfix,_Dovecot_and_Roundcube.html">Talk:Virtual user mail system with Postfix, Dovecot and Roundcube</a>)</div>
</div>
<p>Now you can go to the PostfixAdmin's setup page, let PostfixAdmin create the needed tables and create the users in there.
</p>
<h4><span class="mw-headline" id="PostfixAdmin">PostfixAdmin</span></h4>
<p>See <a href="../en/PostfixAdmin.html" title="PostfixAdmin">PostfixAdmin</a>.
</p>
<h3><span class="mw-headline" id="SSL_certificate">SSL certificate</span></h3>
<p>You will need a SSL certificate for all encrypted mail communications (SMTPS/IMAPS/POP3S). If you do not have one, create one:
</p>
<pre># cd /etc/ssl/private/
# openssl req -new -x509 -nodes -newkey rsa:4096 -keyout vmail.key -out vmail.crt -days 1460 #days are optional
# chmod 400 vmail.key
# chmod 444 vmail.crt
</pre>
<p>Alternatively, create a free trusted certificate using <a href="../en/Certbot.html" class="mw-redirect" title="Let's Encrypt">Let's Encrypt</a>. The private key will be in <code>/etc/letsencrypt/live/<i>yourdomain</i>/privkey.pem</code>, the certificate in <code>/etc/letsencrypt/live/<i>yourdomain</i>/fullchain.pem</code>. Either change the configuration accordingly, or symlink the keys to <code>/etc/ssl/private</code>:
</p>
<pre># ln -s /etc/letsencrypt/live/<i>yourdomain</i>/privkey.pem /etc/ssl/private/vmail.key
# ln -s /etc/letsencrypt/live/<i>yourdomain</i>/fullchain.pem /etc/ssl/private/vmail.crt
</pre>
<h3><span class="mw-headline" id="Postfix">Postfix</span></h3>
<p>Before you copy &amp; paste the configuration below, check if <code>relay_domains</code> has already been set. If you leave more than one active, you will receive warnings during runtime.
</p>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> <code>relay_domains</code> can be dangerous. You usually do not want Postfix to forward mail of strangers. <code>$mydestination</code> is a sane default value. Double check its value before running postfix! See <a rel="nofollow" class="external free" href="http://www.postfix.org/BASIC_CONFIGURATION_README.html#relay_to">http://www.postfix.org/BASIC_CONFIGURATION_README.html#relay_to</a>
</div> 
<p>Also follow <a href="../en/Postfix.html#Secure_SMTP_(receiving)" title="Postfix">Postfix#Secure SMTP (receiving)</a> pointing to the files you created in <a href="#SSL_certificate">#SSL certificate</a>.
</p>
<h4><span class="mw-headline" id="Setting_up_Postfix">Setting up Postfix</span></h4>
<p>To <code>/etc/postfix/main.cf</code> append:
</p>
<pre>relay_domains = $mydestination
virtual_alias_maps = proxy:mysql:/etc/postfix/virtual_alias_maps.cf
virtual_mailbox_domains = proxy:mysql:/etc/postfix/virtual_mailbox_domains.cf
virtual_mailbox_maps = proxy:mysql:/etc/postfix/virtual_mailbox_maps.cf
virtual_mailbox_base = /home/vmail
virtual_mailbox_limit = 512000000
virtual_minimum_uid = 5000
virtual_transport = virtual
virtual_uid_maps = static:5000
virtual_gid_maps = static:5000
local_transport = virtual
local_recipient_maps = $virtual_mailbox_maps
transport_maps = lmdb:/etc/postfix/transport

smtpd_sasl_auth_enable = yes
smtpd_sasl_type = dovecot
smtpd_sasl_path = /var/run/dovecot/auth-client
smtpd_recipient_restrictions = permit_mynetworks, permit_sasl_authenticated, reject_unauth_destination
smtpd_relay_restrictions = permit_mynetworks, permit_sasl_authenticated, reject_unauth_destination
smtpd_sasl_security_options = noanonymous
smtpd_sasl_tls_security_options = $smtpd_sasl_security_options
smtpd_tls_security_level = may
smtpd_tls_auth_only = yes
smtpd_tls_received_header = yes
smtpd_tls_cert_file = /etc/ssl/private/vmail.crt
smtpd_tls_key_file = /etc/ssl/private/vmail.key
smtpd_sasl_local_domain = $mydomain
smtpd_tls_loglevel = 1
smtp_tls_security_level = may
smtp_tls_loglevel = 1
</pre>
<ul><li>In the configuration above <code>virtual_mailbox_domains</code> is a list of the domains that you want to receive mail for. This CANNOT contain the domain that is set in <code>mydestination</code>. That is why we left <code>mydestination</code> to be localhost only.</li></ul>
<ul><li>
<code>virtual_mailbox_maps</code> will contain the information of virtual users and their mailbox locations. We are using a hash file to store the more permanent maps, and these will then override the forwards in the MySQL database.</li></ul>
<ul><li>
<code>virtual_mailbox_base</code> is the base directory where the virtual mailboxes will be stored.</li></ul>
<p>The <code>virtual_uid_maps</code> and <code>virtual_gid_maps</code> are the real system user IDs that the virtual mails will be owned by. This is for storage purposes. 
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> Since we will be using a web interface (Roundcube), and do not want people accessing this by any other means, we will be creating this account later without providing any login access.</div>
<h4><span class="mw-headline" id="Create_the_file_structure">Create the file structure</span></h4>
<p>Those new additional settings reference a lot of files that do not even exist yet. We will create them with the following steps.
</p>
<p>If you were setting up your database with PostfixAdmin and created the database schema through PostfixAdmin, you can create the following files. Do not forget to change the password:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/postfix/virtual_alias_maps.cf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">user = postfix_user
password = hunter2
hosts = localhost
dbname = postfix_db
table = alias
select_field = goto
where_field = address
</pre>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/postfix/virtual_mailbox_domains.cf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">user = postfix_user
password = hunter2
hosts = localhost
dbname = postfix_db
table = domain
select_field = domain
where_field = domain
</pre>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/postfix/virtual_mailbox_maps.cf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">user = postfix_user
password = hunter2
hosts = localhost
dbname = postfix_db
table = mailbox
select_field = maildir
where_field = username
</pre>
<p>For alias domains functionality adjust the following files:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/postfix/main.cf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">virtual_alias_maps = proxy:mysql:/etc/postfix/virtual_alias_maps.cf,proxy:mysql:/etc/postfix/virtual_alias_domains_maps.cf
virtual_alias_domains = proxy:mysql:/etc/postfix/virtual_alias_domains.cf
</pre>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/postfix/virtual_alias_domains_maps.cf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">user = postfix_user
password = hunter2
hosts = localhost
dbname = postfix_db
query = SELECT goto FROM alias,alias_domain WHERE alias_domain.alias_domain = '%d' and alias.address = CONCAT('%u', '@', alias_domain.target_domain) AND alias.active = '1' AND alias_domain.active='1'
</pre>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/postfix/virtual_alias_domains.cf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">user = postfix_user
password = hunter2
hosts = localhost
dbname = postfix_db
query = SELECT alias_domain FROM alias_domain WHERE alias_domain='%s' AND active = '1'
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong>  For setups without using PostfixAdmin, create the following files.</div>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/postfix/virtual_alias_maps.cf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">user = postfix_user
password = hunter2
hosts = localhost
dbname = postfix_db
table = domains
select_field = virtual
where_field = domain
</pre>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/postfix/virtual_mailbox_domains.cf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">user = postfix_user
password = hunter2
hosts = localhost
dbname = postfix_db
table = forwardings
select_field = destination
where_field = source
</pre>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/postfix/virtual_mailbox_maps.cf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">user = postfix_user
password = hunter2
hosts = localhost
dbname = postfix_db
table = users
select_field = concat(domain,'/',email,'/')
where_field = email
</pre>
<p>Run <i>postmap</i> on <i>transport</i> to generate its db:
</p>
<pre># postmap /etc/postfix/transport
</pre>
<h3><span class="mw-headline" id="Dovecot">Dovecot</span></h3>
<p>Instead of using the provided Dovecot example configuration file, we will create our own <code>/etc/dovecot/dovecot.conf</code>. Please note that the user and group here might be vmail <b>instead of postfix</b>!
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/dovecot/dovecot.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">protocols = imap pop3
auth_mechanisms = plain
passdb {
    driver = sql
    args = /etc/dovecot/dovecot-sql.conf
}
userdb {
    driver = sql
    args = /etc/dovecot/dovecot-sql.conf
}
 
service auth {
    unix_listener auth-client {
        group = postfix
        mode = 0660
        user = postfix
    }
    user = root
}

mail_home = /home/vmail/%d/%n
mail_location = maildir:~

ssl_cert = &lt;/etc/ssl/private/vmail.crt
ssl_key = &lt;/etc/ssl/private/vmail.key
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> If you instead want to modify <code>dovecot.conf.sample</code>, beware that the default configuration file imports the content of <code>conf.d/*.conf</code>. Those files call other files that are not present in our configuration.</div>
<p>Now we create <code>/etc/dovecot/dovecot-sql.conf</code>, which we just referenced in the configuration above. Use the following contents and check if everything is set accordingly to your system's configuration.
</p>
<p>If you used PostfixAdmin, then you add the following:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/dovecot/dovecot-sql.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">driver = mysql
connect = host=localhost dbname=postfix_db user=postfix_user password=hunter2
# It is highly recommended to not use deprecated MD5-CRYPT. Read more at http://wiki2.dovecot.org/Authentication/PasswordSchemes
default_pass_scheme = SHA512-CRYPT
# Get the mailbox
user_query = SELECT '/home/vmail/%d/%n' as home, 'maildir:/home/vmail/%d/%n' as mail, 5000 AS uid, 5000 AS gid, concat('dirsize:storage=',  quota) AS quota FROM mailbox WHERE username = '%u' AND active = '1'
# Get the password
password_query = SELECT username as user, password, '/home/vmail/%d/%n' as userdb_home, 'maildir:/home/vmail/%d/%n' as userdb_mail, 5000 as  userdb_uid, 5000 as userdb_gid FROM mailbox WHERE username = '%u' AND active = '1'
# If using client certificates for authentication, comment the above and uncomment the following
#password_query = SELECT null AS password, ‘%u’ AS user
</pre>
<p>Without having used PostfixAdmin you can use:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/dovecot/dovecot-sql.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">driver = mysql
connect = host=localhost dbname=postfix_db user=postfix_user password=hunter2
# It is highly recommended to not use deprecated MD5-CRYPT. Read more at http://wiki2.dovecot.org/Authentication/PasswordSchemes
default_pass_scheme = SHA512-CRYPT
# Get the mailbox
user_query = SELECT '/home/vmail/%d/%n' as home, 'maildir:/home/vmail/%d/%n' as mail, 5000 AS uid, 5000 AS gid, concat('dirsize:storage=',  quota) AS quota FROM users WHERE email = '%u'
# Get the password
password_query = SELECT email as user, password, '/home/vmail/%d/%n' as userdb_home, 'maildir:/home/vmail/%d/%n' as userdb_mail, 5000 as  userdb_uid, 5000 as userdb_gid FROM users WHERE email = '%u'
# If using client certificates for authentication, comment the above and uncomment the following
#password_query = SELECT null AS password, ‘%u’ AS user
</pre>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> Visit <a rel="nofollow" class="external free" href="https://wiki2.dovecot.org/Variables">https://wiki2.dovecot.org/Variables</a> to learn more about Dovecot variables.</div>
<h4><span class="mw-headline" id="DH_parameters">DH parameters</span></h4>
<p>With v2.3 you are required to provide <code>ssl_dh = <i>/path/to/dh.pem</i></code> yourself.
</p>
<p>To generate a new DH parameters file (this will take a long time):
</p>
<pre># openssl dhparam -out /etc/dovecot/dh.pem 4096
</pre>
<p>then add the file to <code>/etc/dovecot/dovecot.conf</code>
</p>
<pre>ssl_dh = &lt;/etc/dovecot/dh.pem
</pre>
<h3><span class="mw-headline" id="PostfixAdmin_2">PostfixAdmin</span></h3>
<p>See <a href="../en/PostfixAdmin.html" title="PostfixAdmin">PostfixAdmin</a>.
</p>
<p>Note: To match the configuration in this file, config.inc.php should contain the following.
</p>
<pre>   # /etc/webapps/postfixadmin/config.inc.php
   ...
   $CONF['domain_path'] = 'YES';
   $CONF['domain_in_mailbox'] = 'NO';
   ...
</pre>
<h3><span class="mw-headline" id="Roundcube">Roundcube</span></h3>
<p>See <a href="../en/Roundcube.html" title="Roundcube">Roundcube</a>.
</p>
<p>Make sure that both <code>extension=pdo_mysql</code> and <code>extension=iconv</code> are uncommented in your <code>php.ini</code> file. Also check the <code>.htaccess</code> for access restrictions. Assuming that localhost is your current host, navigate a browser to <code><a rel="nofollow" class="external free" href="http://localhost/roundcube/installer/">http://localhost/roundcube/installer/</a></code> and follow the instructions. 
</p>
<p>Roundcube needs a separate database to work. You should not use the same database for Roundcube and PostfixAdmin. Create a second database <code>roundcube_db</code> and a new user named <code>roundcube_user</code>.
</p>
<p>While running the installer ...
</p>
<ul>
<li>For the address of the IMAP host, i.e. <code>imap_host</code>, use <code>ssl://localhost/</code> or <code>tls://localhost/</code> and not just <code>localhost</code>.</li>
<li>Use port <code>993</code>. Likewise with SMTP.</li>
<li>For the address of the SMTP host, i.e. <code>smtp_host</code>, use <code>tls://localhost/</code> and port <code>587</code> if you used STARTTLS. Use <code>ssl://localhost/</code> with port <code>465</code> if you used SMTPS.  If there is a failure to establish a session, try using <code>tls://yourservername</code> instead, replacing <code>yourservername</code> with the name of your server.</li>
<li>See <a href="#Postfix">#Postfix</a> for an explanation on that.</li>
<li>Make sure the resulting configuration file has <code>$config['smtp_user'] = '%u';</code> and <code>$config['smtp_pass'] = '%p';</code> lines in it or you will not be able to send email.</li>
</ul>
<p>The post install process is similar to any other webapp like <a href="../en/PhpMyAdmin.html" title="PhpMyAdmin">PhpMyAdmin</a> or PostFixAdmin. The configuration file is in <code>/etc/webapps/roundcubemail/config/config.inc.php</code> which works as an override over <code>defaults.inc.php</code>.
</p>
<h4><span class="mw-headline" id="Apache_configuration">Apache configuration</span></h4>
<p>If you are using Apache, copy the example configuration file to your webserver configuration directory.
</p>
<pre># cp /etc/webapps/roundcubemail/apache.conf /etc/httpd/conf/extra/httpd-roundcubemail.conf
</pre>
<p>Add the following line in
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/httpd/conf/httpd.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">Include conf/extra/httpd-roundcubemail.conf
</pre>
<h4><span class="mw-headline" id="Roundcube:_Change_Password_Plugin">Roundcube: Change Password Plugin</span></h4>
<p>To let users change their passwords from within Roundcube, do the following:
</p>
<p>Enable the password plugin by adding this line to
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/webapps/roundcubemail/config/config.inc.php</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">$config['plugins'] = ['password'];
</pre>
<p>Configure the password plugin and make sure you alter the settings accordingly:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/usr/share/webapps/roundcubemail/plugins/password/config.inc.php</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">&lt;?php

$config['password_driver'] = 'sql';
$config['password_db_dsn'] = 'mysql://&lt;postfix_database_user&gt;:&lt;password&gt;@localhost/&lt;postfix_database_name&gt;';
// If you are not using dovecot specify another algorithm explicitly e.g 'sha256-crypt'
$config['password_algorithm'] = 'dovecot';
// For dovecot salted passwords only (above must be set to 'dovecot')
// $config['password_algorithm_prefix'] = 'true';
// $config['password_dovecotpw'] = '/usr/bin/doveadm pw';
// $config['password_dovecotpw_method'] = 'SHA512-CRYPT';
// $config['password_dovecotpw_with_method'] = true;
$config['password_query'] = 'UPDATE mailbox SET password=%P WHERE username=%u';
</pre>
<p>Make sure this file is readable only by the <code>http</code> user and group since it contains sensitive information:
</p>
<pre># chown http:http /usr/share/webapps/roundcubemail/plugins/password/config.inc.php
# chmod o-r /usr/share/webapps/roundcubemail/plugins/password/config.inc.php
</pre>
<h2><span class="mw-headline" id="Fire_it_up">Fire it up</span></h2>
<p>All necessary daemons should be started in order to test the configuration. <a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Start">Start</a> both <code>postfix</code> and <code>dovecot</code>.
</p>
<p>Now for testing purposes, create a domain and mail account in PostfixAdmin. Try to login to this account using Roundcube. Now send yourself a mail.
</p>
<h2><span class="mw-headline" id="Testing">Testing</span></h2>
<div class="noprint archwiki-template-message">
<p><span class="mw-default-size" typeof="mw:File"><span><img src="../File:Tango-edit-clear.svg" decoding="async" width="48" height="48" class="mw-file-element"></span></span><b>This article or section needs language, wiki syntax or style improvements. See <a href="../en/Help:Style.html" title="Help:Style">Help:Style</a> for reference.</b></p>
<div>
<b>Reason:</b> Needs some cleanup. There are probably more general ways to write this. (Discuss in <a rel="nofollow" class="external text" href="../en/Talk:Virtual_user_mail_system_with_Postfix,_Dovecot_and_Roundcube.html">Talk:Virtual user mail system with Postfix, Dovecot and Roundcube</a>)</div>
</div>
<p>Now lets see if Postfix is going to deliver mail for our test user.
</p>
<pre>nc servername 25
helo testmail.org
mail from:&lt;test@testmail.org&gt;
rcpt to:&lt;cactus@virtualdomain.tld&gt;
data
This is a test email.
.
quit
</pre>
<h3><span class="mw-headline" id="Error_response">Error response</span></h3>
<pre>451 4.3.0 &lt;lisi@test.com&gt;:Temporary lookup failure
</pre>
<p>Maybe you have entered the wrong user/password for MySQL or the MySQL socket is not in the right place.
</p>
<p>This error will also occur if you neglect to run newaliases at least once before starting postfix. MySQL is not required for local only usage of postfix.
</p>
<pre>550 5.1.1 &lt;email@spam.me&gt;: Recipient address rejected: User unknown in virtual mailbox table.
</pre>
<p>Double check content of mysql_virtual_mailboxes.cf and check the main.cf for mydestination
</p>
<h3><span class="mw-headline" id="See_that_you_have_received_a_email">See that you have received a email</span></h3>
<p>Now type <code>$ find /home/vmailer</code>.
</p>
<p>You should see something like the following:
</p>
<pre>/home/vmailer/virtualdomain.tld/cactus@virtualdomain.tld
/home/vmailer/virtualdomain.tld/cactus@virtualdomain.tld/tmp
/home/vmailer/virtualdomain.tld/cactus@virtualdomain.tld/cur
/home/vmailer/virtualdomain.tld/cactus@virtualdomain.tld/new
/home/vmailer/virtualdomain.tld/cactus@virtualdomain.tld/new/1102974226.2704_0.bonk.testmail.org
</pre>
<p>The key is the last entry. This is an actual email, if you see that, it is working.
</p>
<h2><span class="mw-headline" id="Optional_Items">Optional Items</span></h2>
<p>Although these items are not required, they definitely add more completeness to your setup
</p>
<h3><span class="mw-headline" id="Quota">Quota</span></h3>
<p>To enable mailbox quota support by dovecot, do the following: 
</p>
<ul><li>First add the following lines to /etc/dovecot/dovecot.conf</li></ul>
<pre>dict {
	quotadict = mysql:/etc/dovecot/dovecot-dict-sql.conf.ext
}
service dict {
	unix_listener dict {
		group = vmail
		mode = 0660
		user = vmail
	}
	user = root
}
service quota-warning {
	executable = script /usr/local/bin/quota-warning.sh
	user = vmail
	unix_listener quota-warning {
		group = vmail
		mode = 0660
		user = vmail
	}
}	
mail_plugins=quota
protocol pop3 {
	 mail_plugins = quota
	 pop3_client_workarounds = outlook-no-nuls oe-ns-eoh
	 pop3_uidl_format = %08Xu%08Xv
}
protocol lda {
	mail_plugins = quota
	postmaster_address = postmaster@yourdomain.com
}
protocol imap {
	mail_plugins = $mail_plugins imap_quota
	mail_plugin_dir = /usr/lib/dovecot/modules
}
plugin {
       quota = dict:User quota::proxy::quotadict
       quota_rule2 = Trash:storage=+10%%
       quota_warning = storage=100%% quota-warning +100 %u
       quota_warning2 = storage=95%% quota-warning +95 %u
       quota_warning3 = storage=80%% quota-warning +80 %u
       quota_warning4 = -storage=100%% quota-warning -100 %u # user is no longer over quota
}
</pre>
<ul><li>Create a new file /etc/dovecot/dovecot-dict-sql.conf.ext with the following code:</li></ul>
<pre>connect = host=localhost dbname=yourdb user=youruser password=yourpassword
map {
	pattern = priv/quota/storage
	table = quota2
	username_field = username
	value_field = bytes
}
map {
	pattern = priv/quota/messages
	table = quota2
	username_field = username
	value_field = messages
}
</pre>
<ul><li>Create a warning script /usr/local/bin/quota-warning.sh and make sure it is executable. This warning script works with postfix lmtp configuration as well.</li></ul>
<pre>#!/bin/sh
BOUNDARY="$1"
USER="$2"
MSG=""
if [[ "$BOUNDARY" = "+100" ]]; then
    MSG="Your mailbox is now overfull (&gt;100%). In order for your account to continue functioning properly, you need to remove some emails NOW."
elif [[ "$BOUNDARY" = "+95" ]]; then
    MSG="Your mailbox is now over 95% full. Please remove some emails ASAP."
elif [[ "$BOUNDARY" = "+80" ]]; then
    MSG="Your mailbox is now over 80% full. Please consider removing some emails to save space."
elif [[ "$BOUNDARY" = "-100" ]]; then
    MSG="Your mailbox is now back to normal (&lt;100%)."
fi
 
cat &lt;&lt; EOF | /usr/lib/dovecot/dovecot-lda -d $USER -o "plugin/quota=maildir:User quota:noenforcing"
From: postmaster@yourdomain.com
Subject: Email Account Quota Warning

Dear User,

$MSG

Best regards,
Your Mail System
EOF
</pre>
<ul><li>Edit the user_query line and add iterat_query in dovecot-sql.conf as following:</li></ul>
<pre> user_query = SELECT '/home/vmail/%d/%n' as home, 'maildir:/home/vmail/%d/%n' as mail, 5000 AS uid, 5000 AS gid, concat('*:bytes=', quota) AS quota_rule FROM mailbox WHERE username = '%u' AND active = '1'
 iterate_query = SELECT username AS user FROM mailbox
</pre>
<ul><li>Set up LDA as described above under SpamAssassin. If you are not using SpamAssassin, the pipe should look like this in /etc/postfix/master.cf :</li></ul>
<pre> dovecot    unix  -       n       n       -       -       pipe
 flags=DRhu user=vmail:vmail argv=/usr/lib/dovecot/deliver -f ${sender} -d ${recipient}
</pre>
<p>As above activate it in Postfix main.cf
</p>
<pre> virtual_transport = dovecot
</pre>
<ul><li>You can set up quota per each mailbox in postfixadmin. Make sure the relevant lines in config.inc.php look like this:</li></ul>
<pre>$CONF['quota'] = 'YES';
$CONF['quota_multiplier'] = '1024000';
</pre>
<p>Restart postfix and dovecot services. If things go well, you should be able to list all users' quota and usage by the this command:
</p>
<pre>doveadm quota get -A
</pre>
<p>You should be able to see the quota in roundcube too.
</p>
<h3><span class="mw-headline" id="Autocreate_and_autosubscribe_folders_in_Dovecot">Autocreate and autosubscribe folders in Dovecot</span></h3>
<p>To automatically create the "usual" mail hierarchy, modify your <code>/etc/dovecot/dovecot.conf</code> as follows, editing to your specific needs.
</p>
<pre>namespace inbox {
  type = private
  separator = /
  prefix =
  inbox = yes
}
namespace inbox {
  mailbox Drafts {
    auto = subscribe
    special_use = \Drafts
  }
  mailbox Junk {
   auto = subscribe
   special_use = \Junk
 }
 mailbox Trash {
   auto = subscribe
   special_use = \Trash
 }
 mailbox Sent {
   auto = subscribe
   special_use = \Sent
 }
}</pre>
<h3><span class="mw-headline" id="Dovecot_public_folder_and_global_ACLs">Dovecot public folder and global ACLs</span></h3>
<p>In this section we enable IMAP namespace public folders combined with global and per-folder <a href="../en/Access_Control_Lists.html" class="mw-redirect" title="ACL">ACLs</a>.
</p>
<p>First, add the following lines to <code>/etc/dovecot/dovecot.conf</code>:
</p>
<pre>### ACLs
mail_plugins = acl
protocol imap {
  mail_plugins = $mail_plugins imap_acl
}
plugin {
 acl = vfile
 # With global ACL files in /etc/dovecot/dovecot-acls file (v2.2.11+):
 acl = vfile:/etc/dovecot/dovecot-acl
}

### Public Mailboxes
namespace {
 type = public
 separator = /
 prefix = public/
 location = maildir:/home/vmail/public:INDEXPVT=~/public
 subscriptions = no
 list = children
}</pre>
<p>Create the root directory <code>/home/vmail/public</code> and the folders you want to publicly share, for example (the period is required!) <code>/home/vmail/public/.example-1</code>.
</p>
<p>Change the ownership of all files in the root directory:
</p>
<pre>$ chown -R vmail:vmail /home/vmail/public
</pre>
<p>Finally, create and modify your global ACL file to allow users access to these folders:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/dovecot/dovecot-acl</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">public/* user=admin@example.com lrwstipekxa</pre>
<p>In the above example, user <code>admin@example.com</code> has access to, and can do anything to, all the public folders. Edit to fit your specific needs.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> 
<ul>
<li>
<code>lrwstipekxa</code> are the permissions being granted. Visit the Dovecot wiki for further details.</li>
<li>Make sure the user subscribes to the folders in the client they are using.</li>
</ul>
</div>
<h3><span class="mw-headline" id="Fighting_Spam">Fighting Spam</span></h3>
<p>To use SpamAssassin, you <b>must</b> set it up <a href="../en/SpamAssassin.html#Using_a_SQL_database" title="SpamAssassin">with a SQL database</a>. Otherwise user scores and filter data won't be saved as users are virtual and don't have home directories where to save these.
</p>
<p>As an alternative to SpamAssassin, consider <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=rspamd">rspamd</a></span>. Out of the box, it delivers an amazing amount of spam reduction, greylisting, etc and includes a nifty webui. See also <a rel="nofollow" class="external autonumber" href="https://thomas-leister.de/en/mailserver-debian-stretch/">[1]</a>.
</p>
<h2><span class="mw-headline" id="Sidenotes">Sidenotes</span></h2>
<h3><span class="mw-headline" id="Alternative_vmail_folder_structure">Alternative vmail folder structure</span></h3>
<p>Instead of having a directory structure like <code>/home/vmail/example.com/user@example.com</code> you can have cleaner subdirectories (without the additional domain name) by replacing <code>select_field</code> and <code>where_field</code> with:
</p>
<pre>query = SELECT CONCAT(SUBSTRING_INDEX(email,'@',-1),'/',SUBSTRING_INDEX(email,'@',1),'/') FROM users WHERE email='%s'</pre>
<h2><span class="mw-headline" id="Troubleshooting">Troubleshooting</span></h2>
<h3>
<span id="IMAP.2FPOP3_client_failing_to_receive_mails"></span><span class="mw-headline" id="IMAP/POP3_client_failing_to_receive_mails">IMAP/POP3 client failing to receive mails</span>
</h3>
<p>If you get similar errors, take a look into <code>/var/log/mail.log</code> or run <code>journalctl -xn --unit postfix.service</code> as root to find out more.
</p>
<p>It may turn out that the Maildir <code>/home/vmail/mail@domain.tld</code> is just being created if there is at least one email waiting. Otherwise there would not be any need for the directory creation before.
</p>
<h3>
<span id="Roundcube_not_able_to_delete_emails_or_view_any_.27standard.27_folders"></span><span class="mw-headline" id="Roundcube_not_able_to_delete_emails_or_view_any_'standard'_folders">Roundcube not able to delete emails or view any 'standard' folders</span>
</h3>
<p>Ensure that the Roundcube config.inc.php file contains the following:
</p>
<pre>$config['default_imap_folders'] = ['INBOX', 'Drafts', 'Sent', 'Junk', 'Trash'];
$config['create_default_folders'] = true;
$config['protect_default_folders'] = true;</pre>
<h3>
<span id="LMTP_.2F_Sieve"></span><span class="mw-headline" id="LMTP_/_Sieve">LMTP / Sieve</span>
</h3>
<p>Is LMTP not connecting to sieve? Ensure that your server is not routing the messages locally. This can be set in <code> /etc/postfix/main.cf</code>:
</p>
<pre>mydestination =</pre>
<h3>
<span id="Are_your_emails_sent_to_gmail_users_ending_up_in_their_junk.2Fspam_folders.3F"></span><span class="mw-headline" id="Are_your_emails_sent_to_gmail_users_ending_up_in_their_junk/spam_folders?">Are your emails sent to gmail users ending up in their junk/spam folders?</span>
</h3>
<p>Google gmail (and most other large email providers) will send your emails straight into your recipients junk / spam folder if you have not implemented SPF / DKIM / DMARC policies. (Hint: Rspamd, via the link above, shows you how to set this up, and will DKIM sign your emails.)
</p>
<h3>
<span id="Sending_and_receiving_mails_broken.2C_logs_mentioning_.22transport_maps_lookup_failure.22_along_with_.22unsupported_dictionary_type:_hash.22"></span><span class="mw-headline" id='Sending_and_receiving_mails_broken,_logs_mentioning_"transport_maps_lookup_failure"_along_with_"unsupported_dictionary_type:_hash"'>Sending and receiving mails broken, logs mentioning "transport_maps lookup failure" along with "unsupported dictionary type: hash"</span>
</h3>
<p><a rel="nofollow" class="external text" href="https://gitlab.archlinux.org/archlinux/packaging/packages/postfix/-/commit/2ebb2274ab0481a8c70c2fded9126a30b0f228d3">Postfix 3.9.0</a> removed support for the "hash" transport map type. To fix this, <a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Stop">stop</a> <code>postfix.service</code> and edit <code>/etc/postfix/main.cf</code> by replacing all instances of <code>hash:</code> with <code>lmdb:</code>. Then save the file, delete <code>/etc/postfix/transport.db</code> and regenerate it with the new format using <code>postmap /etc/postfix/transport</code>. After that, you can <a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Start">start</a> <code>postfix.service</code>.
</p>
<h2><span class="mw-headline" id="See_also">See also</span></h2>
<ul><li><a href="https://wiki.gentoo.org/wiki/Complete_Virtual_Mail_Server" class="extiw" title="gentoo:Complete Virtual Mail Server">Gentoo:Complete Virtual Mail Server</a></li></ul>
</div>
</div>
					<div id="catlinks" class="catlinks" data-mw="interface">
<div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../Special:Categories.html" title="Special:Categories">Category</a>: <ul><li><a href="../en/Category:Mail_server.html" title="Category:Mail server">Mail server</a></li></ul>
</div>
<div id="mw-hidden-catlinks" class="mw-hidden-catlinks mw-hidden-cats-hidden">Hidden categories: <ul>
<li><a href="../en/Category:Pages_or_sections_flagged_with_Template:Merge.html" title="Category:Pages or sections flagged with Template:Merge">Pages or sections flagged with Template:Merge</a></li>
<li><a href="../en/Category:Pages_or_sections_flagged_with_Template:Expansion.html" title="Category:Pages or sections flagged with Template:Expansion">Pages or sections flagged with Template:Expansion</a></li>
<li><a href="../en/Category:Pages_or_sections_flagged_with_Template:Style.html" title="Category:Pages or sections flagged with Template:Style">Pages or sections flagged with Template:Style</a></li>
</ul>
</div>
</div>
				</div>
			</main>
			
		</div>
		<div class="mw-footer-container">
			
<footer id="footer" class="mw-footer" role="contentinfo" style="margin: 0">
	<ul id="footer-info">
	<li data-nosnippet="">Retrieved from "<a dir="ltr" href="https://wiki.archlinux.org/index.php?title=Virtual_user_mail_system_with_Postfix,_Dovecot_and_Roundcube&amp;oldid=806121">https://wiki.archlinux.org/index.php?title=Virtual_user_mail_system_with_Postfix,_Dovecot_and_Roundcube&amp;oldid=806121</a>"</li>
<li id="footer-info-lastmod"> This page was last edited on 16 April 2024, at 06:45.</li>
	<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="https://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.3 or later</a> unless otherwise noted.</li>
<br>
</ul>

	<ul id="footer-places">
	<li id="footer-places-privacy"><a href="https://terms.archlinux.org/docs/privacy-policy/">Privacy policy</a></li>
	<li id="footer-places-about"><a href="../en/ArchWiki:About.html">About ArchWiki</a></li>
	<li id="footer-places-disclaimers"><a href="../en/ArchWiki:General_disclaimer.html">Disclaimers</a></li>
	<li id="footer-places-archwiki-code-of-conduct"><a href="https://terms.archlinux.org/docs/code-of-conduct/" class="extiw" title="archlinux-service-agreements:code-of-conduct">Code of conduct</a></li>
	<li id="footer-places-archwiki-terms-of-service"><a href="https://terms.archlinux.org/docs/terms-of-service/" class="extiw" title="archlinux-service-agreements:terms-of-service">Terms of service</a></li>
</ul>

	<ul id="footer-icons" class="noprint">
	<li id="footer-copyrightico"><a href="https://www.gnu.org/copyleft/fdl.html"><img src="/resources/assets/licenses/gnu-fdl.png" alt="GNU Free Documentation License 1.3 or later" width="88" height="31" loading="lazy"></a></li>
	<li id="footer-poweredbyico"><img src="/resources/assets/poweredby_mediawiki_88x31.png" srcset="/resources/assets/poweredby_mediawiki_132x47.png 1.5x, /resources/assets/poweredby_mediawiki_176x62.png 2x" width="88" height="31" loading="lazy"></li>
</ul>

</footer>

		</div>
	</div> 
</div> 
<div class="vector-settings" id="p-dock-bottom">
	<ul>
		<li>
		<button class="cdx-button cdx-button--icon-only vector-limited-width-toggle" id=""><span class="vector-icon mw-ui-icon-fullScreen mw-ui-icon-wikimedia-fullScreen"></span>

<span>Toggle limited content width</span>
</button>
</li>
	</ul>
</div>
</body>
</html>
