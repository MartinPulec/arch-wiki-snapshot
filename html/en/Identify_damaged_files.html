<!DOCTYPE html>
<html class="client-nojs vector-feature-language-in-header-enabled vector-feature-language-in-main-page-header-disabled vector-feature-sticky-header-disabled vector-feature-page-tools-pinned-disabled vector-feature-toc-pinned-clientpref-1 vector-feature-main-menu-pinned-disabled vector-feature-limited-width-clientpref-1 vector-feature-limited-width-content-enabled vector-feature-custom-font-size-clientpref-0 vector-feature-client-preferences-disabled vector-feature-client-prefs-pinned-disabled vector-feature-night-mode-disabled skin-theme-clientpref-day vector-toc-available" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>Identify damaged files - ArchWiki</title>
<link rel="stylesheet" href="../ArchWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<meta name="generator" content="MediaWiki 1.42.1">
<meta name="referrer" content="no-referrer-when-downgrade">
<meta name="robots" content="max-image-preview:standard">
<meta name="format-detection" content="telephone=no">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=0.25, maximum-scale=5.0">
<link rel="icon" href="/favicon.ico">
<link rel="search" type="application/opensearchdescription+xml" href="/opensearch_desc.php" title="ArchWiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.archlinux.org/api.php?action=rsd">
<link rel="license" href="https://www.gnu.org/copyleft/fdl.html">
<link rel="alternate" type="application/atom+xml" title="ArchWiki Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="skin-vector skin-vector-search-vue mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-Identify_damaged_files rootpage-Identify_damaged_files skin-vector-2022 action-view skin--responsive">
<a class="mw-jump-link" href="#bodyContent">Jump to content</a>
<div class="vector-header-container">
	</div>
<div class="mw-page-container">
	<div class="mw-page-container-inner">
		<div class="vector-column-start">
			<div class="vector-main-menu-container">
		</div>
	<div class="vector-sticky-pinned-container">
				<nav id="mw-panel-toc" role="navigation" aria-label="Contents" data-event-name="ui.sidebar-toc" class="mw-table-of-contents-container vector-toc-landmark">
					<div id="vector-toc-pinned-container" class="vector-pinned-container">
					<div id="vector-toc" class="vector-toc vector-pinnable-element">
	<div class="vector-pinnable-header vector-toc-pinnable-header vector-pinnable-header-pinned" data-feature-name="toc-pinned" data-pinnable-element-id="vector-toc">
	<h2 class="vector-pinnable-header-label">Contents</h2>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-pin-button" data-event-name="pinnable-header.vector-toc.pin">move to sidebar</button>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-unpin-button" data-event-name="pinnable-header.vector-toc.unpin">hide</button>
</div>


	<ul class="vector-toc-contents" id="mw-panel-toc-list">
		<li id="toc-mw-content-text" class="vector-toc-list-item vector-toc-level-1">
			<a href="#" class="vector-toc-link">
				<div class="vector-toc-text">Beginning</div>
			</a>
		</li>
		<li id="toc-Filesystems" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#Filesystems">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">1</span>Filesystems</div>
		</a>
		
			<button aria-controls="toc-Filesystems-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Filesystems subsection</span>
			</button>
		
		<ul id="toc-Filesystems-sublist" class="vector-toc-list">
			<li id="toc-btrfs" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#btrfs">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">1.1</span>btrfs</div>
			</a>
			
			<ul id="toc-btrfs-sublist" class="vector-toc-list">
				<li id="toc-Find_damaged_files" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Find_damaged_files">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">1.1.1</span>Find damaged files</div>
			</a>
			
			<ul id="toc-Find_damaged_files-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Ext2,_ext3,_and_ext4" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Ext2,_ext3,_and_ext4">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">1.2</span>Ext2, ext3, and ext4</div>
			</a>
			
			<ul id="toc-Ext2,_ext3,_and_ext4-sublist" class="vector-toc-list">
				<li id="toc-Debug_the_filesystem" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Debug_the_filesystem">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">1.2.1</span>Debug the filesystem</div>
			</a>
			
			<ul id="toc-Debug_the_filesystem-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Find_damaged_files_2" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Find_damaged_files_2">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">1.2.2</span>Find damaged files</div>
			</a>
			
			<ul id="toc-Find_damaged_files_2-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-JFS" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#JFS">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">1.3</span>JFS</div>
			</a>
			
			<ul id="toc-JFS-sublist" class="vector-toc-list">
				<li id="toc-Debug_the_filesystem_2" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Debug_the_filesystem_2">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">1.3.1</span>Debug the filesystem</div>
			</a>
			
			<ul id="toc-Debug_the_filesystem_2-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Find_damaged_files_3" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Find_damaged_files_3">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">1.3.2</span>Find damaged files</div>
			</a>
			
			<ul id="toc-Find_damaged_files_3-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-ReiserFS_and_Reiser4" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#ReiserFS_and_Reiser4">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">1.4</span>ReiserFS and Reiser4</div>
			</a>
			
			<ul id="toc-ReiserFS_and_Reiser4-sublist" class="vector-toc-list">
				<li id="toc-Debug_the_filesystem_3" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Debug_the_filesystem_3">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">1.4.1</span>Debug the filesystem</div>
			</a>
			
			<ul id="toc-Debug_the_filesystem_3-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Find_damaged_files_4" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Find_damaged_files_4">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">1.4.2</span>Find damaged files</div>
			</a>
			
			<ul id="toc-Find_damaged_files_4-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-XFS" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#XFS">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">1.5</span>XFS</div>
			</a>
			
			<ul id="toc-XFS-sublist" class="vector-toc-list">
				<li id="toc-Debug_the_filesystem_4" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Debug_the_filesystem_4">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">1.5.1</span>Debug the filesystem</div>
			</a>
			
			<ul id="toc-Debug_the_filesystem_4-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Find_damaged_files_5" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Find_damaged_files_5">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">1.5.2</span>Find damaged files</div>
			</a>
			
			<ul id="toc-Find_damaged_files_5-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Force_the_disk_to_reallocate_bad_block" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#Force_the_disk_to_reallocate_bad_block">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">2</span>Force the disk to reallocate bad block</div>
		</a>
		
		<ul id="toc-Force_the_disk_to_reallocate_bad_block-sublist" class="vector-toc-list">
		</ul>
	</li>
	<li id="toc-See_also" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#See_also">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">3</span>See also</div>
		</a>
		
		<ul id="toc-See_also-sublist" class="vector-toc-list">
		</ul>
	</li>
</ul>
</div>

					</div>
		</nav>
			</div>
		</div>
		<div class="mw-content-container">
			<main id="content" class="mw-body" role="main" style="margin: 0">
				<header class="mw-body-header vector-page-titlebar">
					<nav role="navigation" aria-label="Contents" class="vector-toc-landmark">
						
<div id="vector-page-titlebar-toc" class="vector-dropdown vector-page-titlebar-toc vector-button-flush-left">
	<input type="checkbox" id="vector-page-titlebar-toc-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-vector-page-titlebar-toc" class="vector-dropdown-checkbox " aria-label="Toggle the table of contents">
	<label id="vector-page-titlebar-toc-label" for="vector-page-titlebar-toc-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--icon-only " aria-hidden="true"><span class="vector-icon mw-ui-icon-listBullet mw-ui-icon-wikimedia-listBullet"></span>

<span class="vector-dropdown-label-text">Toggle the table of contents</span>
	</label>
	<div class="vector-dropdown-content">


							<div id="vector-page-titlebar-toc-unpinned-container" class="vector-unpinned-container">
			</div>
		
	</div>
</div>

					</nav>
					<h1 id="firstHeading" class="firstHeading mw-first-heading"><span class="mw-page-title-main">Identify damaged files</span></h1>
							
<div id="p-lang-btn" class="vector-dropdown mw-portlet mw-portlet-lang">
	<input type="checkbox" id="p-lang-btn-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-p-lang-btn" class="vector-dropdown-checkbox mw-interlanguage-selector" aria-label="Go to an article in another language. Available in 1 language">
	<label id="p-lang-btn-label" for="p-lang-btn-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--action-progressive mw-portlet-lang-heading-1" aria-hidden="true"><span class="vector-icon mw-ui-icon-language-progressive mw-ui-icon-wikimedia-language-progressive"></span>

<span class="vector-dropdown-label-text">1 language</span>
	</label>
	<div class="vector-dropdown-content">

		<div class="vector-menu-content">
			
			<ul class="vector-menu-content-list">
				
				<li class="interlanguage-link interwiki-ja mw-list-item"><a href="https://wiki.archlinux.jp/index.php/%E6%8C%87%E5%AE%9A%E3%83%96%E3%83%AD%E3%83%83%E3%82%AF%E3%81%8C%E3%81%A9%E3%81%AE%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AB%E5%B1%9E%E3%81%99%E3%82%8B%E3%81%8B%E8%AA%BF%E3%81%B9%E3%82%8B" title="指定ブロックがどのファイルに属するか調べる – 日本語" lang="ja" hreflang="ja" class="interlanguage-link-target"><span>日本語</span></a></li>
			</ul>
			
		</div>

	</div>
</div>
</header>
				<div class="vector-column-end">
					<div class="vector-sticky-pinned-container">
						<nav class="vector-page-tools-landmark" aria-label="Page tools">
							<div id="vector-page-tools-pinned-container" class="vector-pinned-container">
				
							</div>
		</nav>
						<nav class="vector-client-prefs-landmark" aria-label="Appearance">
						</nav>
					</div>
				</div>
				<div id="bodyContent" class="vector-body" aria-labelledby="firstHeading" data-mw-ve-target-container>
					<div class="vector-body-before-content">
							<div class="mw-indicators">
		</div>

						<div id="siteSub" class="noprint">From ArchWiki</div>
					</div>
					<div id="contentSub"><div id="mw-content-subtitle"></div></div>
					
					
					<div id="mw-content-text" class="mw-body-content">
<div class="mw-content-ltr mw-parser-output" lang="en" dir="ltr">
<div class="archwiki-template-meta-related-articles">
<p>Related articles</p>
<ul>
<li><a href="../en/Badblocks.html" title="Badblocks">badblocks</a></li>
<li><a href="../en/File_recovery.html" title="File recovery">File recovery</a></li>
</ul>
</div>
<p>This article gives details on how to find out which file owns a given <a href="https://en.wikipedia.org/wiki/Disk_sector" class="extiw" title="wikipedia:Disk sector">disk sector</a>. The main purpose for doing so is finding out which file was damaged in the event a storage device develops any <a href="https://en.wikipedia.org/wiki/Bad_sector" class="extiw" title="wikipedia:Bad sector">bad sectors</a> (that way you will know if you lost anything important).
</p>
<p>For most of these commands you will have to be either root or a user that has direct read access to the drive you are checking (being a member of the disk group should be enough). As usual, a current backup is always a good idea, especially if imminent drive failure is suspected. <a href="../en/S.M.A.R.T..html" title="S.M.A.R.T.">S.M.A.R.T.</a> can help determining that.
</p>
<meta property="mw:PageProp/toc">
<h2><span class="mw-headline" id="Filesystems">Filesystems</span></h2>
<h3><span class="mw-headline" id="btrfs">btrfs</span></h3>
<p>Unlike other filesystem types, <a href="../en/Btrfs.html" title="Btrfs">btrfs</a> has native support for reporting on damaged files. When scrubbing a partition, <i>btrfs</i> reads all data and metadata blocks and verifies checksums. It automatically repairs corrupted blocks if there is a correct copy available in a RAID configuration. <i>btrfs</i> also reports any unreadable sector along with the affected file via system log.
</p>
<h4><span class="mw-headline" id="Find_damaged_files">Find damaged files</span></h4>
<p>First of all, let us <a href="../en/Btrfs.html#Scrub" title="Btrfs">scrub</a> the damaged partition:
</p>
<pre># btrfs scrub start -Bd /dev/sdxy</pre>
<p>The same partition can be scrubbed when mounted by providing its mount point:
</p>
<pre># btrfs scrub start -Bd /mnt/point</pre>
<p>Scrub reports can be retrieved as many times as need with the <code>status</code> subcommand:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># btrfs scrub status /mnt/point</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">scrub status for e11013b3-b244-4d1a-a9c7-3956db1a699c
        scrub started at Thu Apr 23 19:07:45 2015 and finished after 372 seconds
        total bytes scrubbed: 301.13GiB with 1 errors
        error details: read=1
        corrected errors: 0, uncorrectable errors: 1, unverified errors: 0</pre>
<p>When done, search the kernel log for I/O errors:
</p>
<div class="noprint archwiki-template-message">
<p><span class="mw-default-size" typeof="mw:File"><span><img src="../File:Inaccurate.svg" decoding="async" width="48" height="48" class="mw-file-element"></span></span><b>The factual accuracy of this article or section is disputed.</b></p>
<div>
<b>Reason:</b> Is the sector still included? (Discuss in <a href="../en/Talk:Identify_damaged_files.html#Btrfs_section_may_need_updating" title="Talk:Identify damaged files">Talk:Identify damaged files#Btrfs section may need updating</a>)</div>
</div>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># journalctl --output=cat --grep='BTRFS .* i/o error' | sort | uniq | less</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">Jan 16 23:14:19 my_server kernel: BTRFS: i/o error at logical 398602014720 on dev /dev/sdxy, sector <b>4621320</b>, root 5, inode 23839, offset 4378624, length 4096, links 1 (path: <b>my/damaged/file</b>)</pre>
<p>The output above reveals that sector <code>4621320</code> could not be read and it contains data for file <code>my/damaged/file</code>. The sector number can be directly used with <a href="../en/Hdparm.html" title="Hdparm">hdparm</a> when reallocating (see <a href="#Force_the_disk_to_reallocate_bad_block">#Force the disk to reallocate bad block</a>).
</p>
<h3>
<span id="Ext2.2C_ext3.2C_and_ext4"></span><span class="mw-headline" id="Ext2,_ext3,_and_ext4">Ext2, ext3, and ext4</span>
</h3>
<h4><span class="mw-headline" id="Debug_the_filesystem">Debug the filesystem</span></h4>
<p>The <i>tune2fs</i> command will give you access to all the low level structures within any ext2/<a href="../en/Ext3.html" title="Ext3">ext3</a>/<a href="../en/Ext4.html" title="Ext4">ext4</a> filesystem. 
</p>
<p>The first thing we want to do is get the block size from the filesystem in question. Just run:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># tune2fs -l /dev/sdxy | grep Block</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">Block count:              29119820
<b>Block size:               4096</b>
</pre>
<p>In this case 4096 is the block size being used (it appears to be the default).
</p>
<p>If you did not run <a href="../en/Badblocks.html" title="Badblocks">badblocks</a> using the block size that your filesystem is using then you will need to convert your block number(s) to match it (remember to use the block number(s) relative to the partition they are on).
</p>
<p>i.e. block number 100 with a block size of 1024 bytes becomes block number 25 at 4096 bytes. The formula is:
</p>
<pre>(original block number) / ((filesystem block size) / (badblocks block size))
</pre>
<p>Now the entire point of running this program (for the purpose of this article) is to get the <i>inode</i> number. Before continuing to debug it, unmount the partition. Then, run the command:
</p>
<pre># debugfs
</pre>
<p>Then in the <code>debugfs</code> console, use the <code>open</code> command on the <i>ext</i> partition containing the bad sector:
</p>
<pre>debugfs:  open /dev/sdxy
</pre>
<p>Finally, use the <code>testb</code> command to get information about the block in question (in this example block 1000):
</p>
<pre>debugfs:  testb <i>blocknumber</i>
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> If <code>debugfs</code> says that block is not in use then that means the block is not allocated and is being used as free space. In that case this is a good thing as it means nothing important was damaged.</div>
<p>If the block is in use then run this command to get the <i>inode</i> number
</p>
<pre>icheck <i>blocknumber</i>
</pre>
<p>This will return two numbers. The block number and the <i>inode</i> number.
</p>
<h4><span class="mw-headline" id="Find_damaged_files_2">Find damaged files</span></h4>
<p>Use the <i>inode</i> number (second number from the <code>icheck</code> command) with the <code>ncheck</code> command:
</p>
<pre>ncheck <i>inodenumber</i>
</pre>
<p>The <code>debugfs</code> console will give you the full pathname to the file using the bad block. Now you will know what was actually damaged.
</p>
<p>If the <i>inode</i> number is very small and <code>ncheck</code> fails to return a path then it is probably the journal itself that is damaged. To delete the journal simply run this command on the partition:
</p>
<pre># tune2fs -O ^has_journal /dev/sdxy
</pre>
<p>Run the <code>testb</code> command again from the <code>debugfs</code> console on the bad block and it should be no longer marked as used if it was indeed used by the journal. To build a new journal run:
</p>
<pre># tune2fs -j /dev/sdxy
</pre>
<h3><span class="mw-headline" id="JFS">JFS</span></h3>
<h4><span class="mw-headline" id="Debug_the_filesystem_2">Debug the filesystem</span></h4>
<p>The <i>jfs_debugfs</i> command will give you access to all the low level structures within any <a href="../en/JFS.html" title="JFS">JFS</a> filesystem. Other filesystems such as the <a href="../en/Ext3.html" title="Ext3">ext3</a> and <a href="../en/Ext4.html" title="Ext4">ext4</a> filesystems have similar tools. It is probably a good idea to <i>umount</i> any filesystem before you run this on them. To use it just run:
</p>
<pre># jfs_debugfs /dev/sdxy
</pre>
<p>This puts you into a command console. The first thing you should note is your aggregate block size. This is (presumably) the block size the filesystem is using. <a href="../en/JFS.html" title="JFS">JFS</a> seems to default to 4096 bytes.
</p>
<p>If you did not run <a href="../en/Badblocks.html" title="Badblocks">badblocks</a> using the block size that your filesystem is using then you will need to convert your block number(s) to match it (remember to use the block number(s) relative to the partition they are on).
</p>
<p>i.e. block number 100 with a block size of 1024 bytes becomes block number 25 at 4096 bytes. The formula is:
</p>
<pre>(original block number) / ((filesystem block size) / (badblocks block size))
</pre>
<p>Now the entire point of running this program (for the purpose of this article) is to get the <i>inode</i> number. To do this run the command:
</p>
<pre>d <i>blocknumber</i> 0 i
</pre>
<p>The syntax is the <code>d</code> command for display, the block number, the offset (just set it to 0), and the display format <code>i</code> for <i>inode</i>.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> If you get an error then that means the block is not allocated and is being used as free space. In that case this is a good thing as it means nothing important was damaged.</div>
<p>The decimal number that <code>di_number</code> is set to is the one we want. From here you type <code>x</code> to exit out of the display mode. Repeat the display command for each bad block that you have and note all of their <i>inode</i> numbers. For more info on the <i>inode</i> such as permissions and filetype type:
</p>
<pre>i <i>inodenumber</i>
</pre>
<p>When you have all the <i>inode</i> numbers type <code>q</code> to quit.
</p>
<h4><span class="mw-headline" id="Find_damaged_files_3">Find damaged files</span></h4>
<p>Finally to find the damaged file you can simply use the gnu <a href="../en/Core_utilities.html#Essentials" class="mw-redirect" title="Find">find</a> utility. Mount your filesystem and run:
</p>
<pre># find / -inum <i>inodenumber</i>
</pre>
<p>Substitute <code>/</code> for the mountpoint of the filesystem that the <i>inode</i> belongs to. If you search root and have more than one filesystem mounted you can find multiple files with the same <i>inode</i> number on different filesystems, plus <a href="../en/Core_utilities.html#Essentials" class="mw-redirect" title="Find">find</a> will take significantly longer. Remember, an <i>inode</i> is only unique to the filesystem that it is in.
</p>
<h3><span class="mw-headline" id="ReiserFS_and_Reiser4">ReiserFS and Reiser4</span></h3>
<h4><span class="mw-headline" id="Debug_the_filesystem_3">Debug the filesystem</span></h4>
<p>The <i>debugreiserfs</i> command will give you access to all the low level structures within any ReiserFS/<a href="../en/Reiser4.html" title="Reiser4">Reiser4</a> filesystem. 
</p>
<p>The first thing we want to do is get the block size from the filesystem in question. Just run:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># debugreiserfs /dev/sdxy | grep '^Blocksize'</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;"><b>Blocksize: 4096</b>
</pre>
<p>In this case 4096 is the block size being used (it appears to be the default).
</p>
<p>If you did not run <a href="../en/Badblocks.html" title="Badblocks">badblocks</a> using the block size that your filesystem is using then you will need to convert your block number(s) to match it (remember to use the block number(s) relative to the partition they are on).
</p>
<p>i.e. block number 100 with a block size of 1024 bytes becomes block number 25 at 4096 bytes. The formula is:
</p>
<pre>(original block number) / ((filesystem block size) / (badblocks block size))
</pre>
<p>Now the entire point of running this program (for the purpose of this article) is to get the <i>inode</i> number. Before continuing to debug it, unmount the partition. Then, run the command:
</p>
<h4><span class="mw-headline" id="Find_damaged_files_4">Find damaged files</span></h4>
<ol><li>debugreiserfs -1 <i>blocknumber</i> /dev/sdxy</li></ol>
<p>This will return the information for what reiser filesystems refer to as a "leaf node". If you see a line stating <code>Looks like unformatted</code> then likely this means that the bad block belongs to free space and nothing important was damaged. If that line is absent and there is more output but no filenames then it likely means damage was done to a filesystem structure (at which point it might be a good idea to run at least a read-only fsck to see what is going on).
</p>
<p>If you see a <code>Name</code> column with filenames returned under it then it is possible any of these could be damaged (note: there may or may not be a way to more precisely narrow down the exact file damaged). The inode number(s) for listed file(s) seems to be the second number within square brackets listed under the <code>Object key</code> column (this is solely for informational purposes since we already have the filenames).
</p>
<p>Realistically if you do have a damaged block then you will likely receive an Input/Output error. In this case you can try mounting the bad partition and then running this command on the mount point (per the smartmontools guide):
</p>
<pre># tar -cO /mydir | cat &gt;/dev/null
</pre>
<h3><span class="mw-headline" id="XFS">XFS</span></h3>
<h4><span class="mw-headline" id="Debug_the_filesystem_4">Debug the filesystem</span></h4>
<p>The <i>xfs_info</i> command will give you basic information about an <a href="../en/XFS.html" title="XFS">XFS</a> formatted partition and the <i>xfs_db</i> command will give you access to all the low level structures within any <a href="../en/XFS.html" title="XFS">XFS</a> filesystem.
</p>
<p>The first thing we want to do is get the block size from the filesystem in question. Just run:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># xfs_info /dev/sdxy | grep bsize</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">data     =                       <b>bsize=4096</b>   blocks=127739, imaxpct=25
naming   =version 2              <b>bsize=4096</b>   ascii-ci=0 ftype=1
log      =internal               <b>bsize=4096</b>   blocks=855, version=2</pre>
<p>In this case 4096 is the block size being used (it appears to be the default).
</p>
<p>If you did not run <a href="../en/Badblocks.html" title="Badblocks">badblocks</a> using the block size that your filesystem is using then you will need to convert your block number(s) to match it (remember to use the block number(s) relative to the partition they are on).
</p>
<p>i.e. block number 100 with a block size of 1024 bytes becomes block number 25 at 4096 bytes. The formula is:
</p>
<pre>(original block number) / ((filesystem block size) / (badblocks block size))
</pre>
<p>Now the entire point of running this program (for the purpose of this article) is to get the <i>inode</i> number. Before continuing to debug it, unmount the partition. Then, run the command:
</p>
<pre># xfs_db -c 'blockget -b <b>blocknumber'</b> /dev/sdxy
</pre>
<p>You should get output similar to this:
</p>
<pre>   setting block 0/9 to data
   setting <b>inode to 131</b> for block 0/9
   <b>inode 131</b> block 9 at offset 0
</pre>
<p>In this example we now know the inode is 131 and can proceed to the next section 
</p>
<p>If instead you do not get an inode number in your output but do see the word <i>free</i> then likely this means that the bad block belongs to free space and nothing important was damaged.
</p>
<h4><span class="mw-headline" id="Find_damaged_files_5">Find damaged files</span></h4>
<p>Finally to find the damaged file you can simply use the gnu <a href="../en/Core_utilities.html#Essentials" class="mw-redirect" title="Find">find</a> utility. Mount your filesystem and run:
</p>
<pre># find / -inum <i>inodenumber</i>
</pre>
<p>Substitute <code>/</code> for the mountpoint of the filesystem that the <i>inode</i> belongs to. If you search root and have more than one filesystem mounted you can find multiple files with the same <i>inode</i> number on different filesystems, plus <a href="../en/Core_utilities.html#Essentials" class="mw-redirect" title="Find">find</a> will take significantly longer. Remember, an <i>inode</i> is only unique to the filesystem that it is in.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> According to <span class="plainlinks archwiki-template-man" title="$ man 8 xfs_db"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/xfs_db.8">xfs_db(8)</a></span> the <code>blockuse -n</code> command can be used in conjuction with <code>blockget -n -c <i>blocknumber</i></code> in order to print file names. Testing this did not produce the desired results though it may be worth trying anyway since it is faster than the find method.
<pre># xfs_db -c 'blockget -n -b <i>blocknumber</i>' -c 'blockuse -n' /dev/sd<i>Xy</i>
</pre>
</div>
<h2><span class="mw-headline" id="Force_the_disk_to_reallocate_bad_block">Force the disk to reallocate bad block</span></h2>
<p>First you will want to see how many badblocks the harddrive is aware of through the <a href="../en/S.M.A.R.T..html#smartctl" class="mw-redirect" title="Smartctl">smartctl</a> command:
</p>
<pre># smartctl -t long /dev/sdx
</pre>
<p>Wait until test completes, then:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># smartctl -l selftest /dev/sdx</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">ID# ATTRIBUTE_NAME          FLAG     VALUE WORST THRESH TYPE      UPDATED  WHEN_FAILED RAW_VALUE
<b>  5 Reallocated_Sector_Ct   0x0033   100   100   005    Pre-fail  Always       -       0</b>
<b>196 Reallocated_Event_Count 0x0032   100   100   000    Old_age   Always       -       0</b>
197 Current_Pending_Sector  0x0022   100   100   000    Old_age   Always       -       0
<b>198 Offline_Uncorrectable   0x0008   100   100   000    Old_age   Offline      -       0</b></pre>
<p>To make the harddrive transparently map out the badblock with a spare good sector you will have to simply write zeros to the bad block using the <a href="../en/Dd.html" title="Dd">dd</a> command as root. Remember that with this command you have to work with the same block size as your filesystem and the block has to be relative to the partition the filesystem is on and <b>not</b> the harddrive as a whole:
</p>
<pre># dd if=/dev/zero of=/dev/sdxy bs=4096 count=1 seek=2269012
$ sync</pre>
<p>Alternatively, <a href="../en/Hdparm.html" title="Hdparm">hdparm</a> provides a couple of nice and simple options to read and write a given sector (4621327, in the following example):
</p>
<pre># hdparm --read-sector 4621327 /dev/sdxy
# hdparm --repair-sector 4621327 --yes-i-know-what-i-am-doing /dev/sdxy</pre>
<p>You can see if the harddrive did indeed map out an additional bad sector by checking with the <a href="../en/S.M.A.R.T..html#smartctl" class="mw-redirect" title="Smartctl">smartctl</a> command and seeing if the reallocated sector or event count went up:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># smartctl -A /dev/sdx</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">ID# ATTRIBUTE_NAME          FLAG     VALUE WORST THRESH TYPE      UPDATED  WHEN_FAILED RAW_VALUE
<b>  5 Reallocated_Sector_Ct   0x0033   100   100   005    Pre-fail  Always       -       1</b>
<b>196 Reallocated_Event_Count 0x0032   100   100   000    Old_age   Always       -       1</b>
197 Current_Pending_Sector  0x0022   100   100   000    Old_age   Always       -       0
<b>198 Offline_Uncorrectable   0x0008   100   100   000    Old_age   Offline      -       1</b></pre>
<p>To get <code>Offline_Uncorrectable</code> to go back to 0 you need to run a SMART long test and a selftest:
</p>
<pre># smartctl -t long /dev/sdx
</pre>
<p>Wait until test completes, then:
</p>
<pre># smartctl -l selftest /dev/sdx
</pre>
<h2><span class="mw-headline" id="See_also">See also</span></h2>
<ul>
<li>
<a rel="nofollow" class="external text" href="https://strugglers.net/~andy/blog/2021/07/24/resolving-a-sector-offset-to-a-logical-volume/">Tracing a disk's sector number through md and LVM to a filesystem</a> by Andy Smith of BitFolk</li>
<li><a rel="nofollow" class="external text" href="https://www.smartmontools.org/wiki/BadBlockHowto">EXT2/3 badblocks howto</a></li>
</ul>
</div>
</div>
					<div id="catlinks" class="catlinks" data-mw="interface">
<div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../Special:Categories.html" title="Special:Categories">Category</a>: <ul><li><a href="../en/Category:File_systems.html" title="Category:File systems">File systems</a></li></ul>
</div>
<div id="mw-hidden-catlinks" class="mw-hidden-catlinks mw-hidden-cats-hidden">Hidden category: <ul><li><a href="../en/Category:Pages_or_sections_flagged_with_Template:Accuracy.html" title="Category:Pages or sections flagged with Template:Accuracy">Pages or sections flagged with Template:Accuracy</a></li></ul>
</div>
</div>
				</div>
			</main>
			
		</div>
		<div class="mw-footer-container">
			
<footer id="footer" class="mw-footer" role="contentinfo" style="margin: 0">
	<ul id="footer-info">
	<li data-nosnippet="">Retrieved from "<a dir="ltr" href="https://wiki.archlinux.org/index.php?title=Identify_damaged_files&amp;oldid=798119">https://wiki.archlinux.org/index.php?title=Identify_damaged_files&amp;oldid=798119</a>"</li>
<li id="footer-info-lastmod"> This page was last edited on 24 January 2024, at 20:49.</li>
	<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="https://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.3 or later</a> unless otherwise noted.</li>
<br>
</ul>

	<ul id="footer-places">
	<li id="footer-places-privacy"><a href="https://terms.archlinux.org/docs/privacy-policy/">Privacy policy</a></li>
	<li id="footer-places-about"><a href="../en/ArchWiki:About.html">About ArchWiki</a></li>
	<li id="footer-places-disclaimers"><a href="../en/ArchWiki:General_disclaimer.html">Disclaimers</a></li>
	<li id="footer-places-archwiki-code-of-conduct"><a href="https://terms.archlinux.org/docs/code-of-conduct/" class="extiw" title="archlinux-service-agreements:code-of-conduct">Code of conduct</a></li>
	<li id="footer-places-archwiki-terms-of-service"><a href="https://terms.archlinux.org/docs/terms-of-service/" class="extiw" title="archlinux-service-agreements:terms-of-service">Terms of service</a></li>
</ul>

	<ul id="footer-icons" class="noprint">
	<li id="footer-copyrightico"><a href="https://www.gnu.org/copyleft/fdl.html"><img src="/resources/assets/licenses/gnu-fdl.png" alt="GNU Free Documentation License 1.3 or later" width="88" height="31" loading="lazy"></a></li>
	<li id="footer-poweredbyico"><img src="/resources/assets/poweredby_mediawiki_88x31.png" srcset="/resources/assets/poweredby_mediawiki_132x47.png 1.5x, /resources/assets/poweredby_mediawiki_176x62.png 2x" width="88" height="31" loading="lazy"></li>
</ul>

</footer>

		</div>
	</div> 
</div> 
<div class="vector-settings" id="p-dock-bottom">
	<ul>
		<li>
		<button class="cdx-button cdx-button--icon-only vector-limited-width-toggle" id=""><span class="vector-icon mw-ui-icon-fullScreen mw-ui-icon-wikimedia-fullScreen"></span>

<span>Toggle limited content width</span>
</button>
</li>
	</ul>
</div>
</body>
</html>
