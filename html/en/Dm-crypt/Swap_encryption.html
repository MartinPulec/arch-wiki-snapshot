<!DOCTYPE html>
<html class="client-nojs vector-feature-language-in-header-enabled vector-feature-language-in-main-page-header-disabled vector-feature-sticky-header-disabled vector-feature-page-tools-pinned-disabled vector-feature-toc-pinned-clientpref-1 vector-feature-main-menu-pinned-disabled vector-feature-limited-width-clientpref-1 vector-feature-limited-width-content-enabled vector-feature-custom-font-size-clientpref-0 vector-feature-client-preferences-disabled vector-feature-client-prefs-pinned-disabled vector-feature-night-mode-disabled skin-theme-clientpref-day vector-toc-available" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>dm-crypt/Swap encryption - ArchWiki</title>
<link rel="stylesheet" href="../../ArchWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<meta name="generator" content="MediaWiki 1.42.1">
<meta name="referrer" content="no-referrer-when-downgrade">
<meta name="robots" content="max-image-preview:standard">
<meta name="format-detection" content="telephone=no">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=0.25, maximum-scale=5.0">
<link rel="icon" href="/favicon.ico">
<link rel="search" type="application/opensearchdescription+xml" href="/opensearch_desc.php" title="ArchWiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.archlinux.org/api.php?action=rsd">
<link rel="license" href="https://www.gnu.org/copyleft/fdl.html">
<link rel="alternate" type="application/atom+xml" title="ArchWiki Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="skin-vector skin-vector-search-vue mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-Dm-crypt_Swap_encryption rootpage-Dm-crypt skin-vector-2022 action-view skin--responsive">
<a class="mw-jump-link" href="#bodyContent">Jump to content</a>
<div class="vector-header-container">
	</div>
<div class="mw-page-container">
	<div class="mw-page-container-inner">
		<div class="vector-column-start">
			<div class="vector-main-menu-container">
		</div>
	<div class="vector-sticky-pinned-container">
				<nav id="mw-panel-toc" role="navigation" aria-label="Contents" data-event-name="ui.sidebar-toc" class="mw-table-of-contents-container vector-toc-landmark">
					<div id="vector-toc-pinned-container" class="vector-pinned-container">
					<div id="vector-toc" class="vector-toc vector-pinnable-element">
	<div class="vector-pinnable-header vector-toc-pinnable-header vector-pinnable-header-pinned" data-feature-name="toc-pinned" data-pinnable-element-id="vector-toc">
	<h2 class="vector-pinnable-header-label">Contents</h2>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-pin-button" data-event-name="pinnable-header.vector-toc.pin">move to sidebar</button>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-unpin-button" data-event-name="pinnable-header.vector-toc.unpin">hide</button>
</div>


	<ul class="vector-toc-contents" id="mw-panel-toc-list">
		<li id="toc-mw-content-text" class="vector-toc-list-item vector-toc-level-1">
			<a href="#" class="vector-toc-link">
				<div class="vector-toc-text">Beginning</div>
			</a>
		</li>
		<li id="toc-Without_suspend-to-disk_support" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#Without_suspend-to-disk_support">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">1</span>Without suspend-to-disk support</div>
		</a>
		
			<button aria-controls="toc-Without_suspend-to-disk_support-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Without suspend-to-disk support subsection</span>
			</button>
		
		<ul id="toc-Without_suspend-to-disk_support-sublist" class="vector-toc-list">
			<li id="toc-UUID_and_LABEL" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#UUID_and_LABEL">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">1.1</span>UUID and LABEL</div>
			</a>
			
			<ul id="toc-UUID_and_LABEL-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Disabling_hibernation_in_desktop_environments" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Disabling_hibernation_in_desktop_environments">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">1.2</span>Disabling hibernation in desktop environments</div>
			</a>
			
			<ul id="toc-Disabling_hibernation_in_desktop_environments-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-With_suspend-to-disk_support" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#With_suspend-to-disk_support">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">2</span>With suspend-to-disk support</div>
		</a>
		
			<button aria-controls="toc-With_suspend-to-disk_support-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle With suspend-to-disk support subsection</span>
			</button>
		
		<ul id="toc-With_suspend-to-disk_support-sublist" class="vector-toc-list">
			<li id="toc-LVM_on_LUKS" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#LVM_on_LUKS">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.1</span>LVM on LUKS</div>
			</a>
			
			<ul id="toc-LVM_on_LUKS-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Using_a_swap_partition" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Using_a_swap_partition">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.2</span>Using a swap partition</div>
			</a>
			
			<ul id="toc-Using_a_swap_partition-sublist" class="vector-toc-list">
				<li id="toc-mkinitcpio_hook" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#mkinitcpio_hook">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.2.1</span>mkinitcpio hook</div>
			</a>
			
			<ul id="toc-mkinitcpio_hook-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-dracut" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#dracut">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.2.2</span>dracut</div>
			</a>
			
			<ul id="toc-dracut-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Using_a_swap_file" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Using_a_swap_file">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.3</span>Using a swap file</div>
			</a>
			
			<ul id="toc-Using_a_swap_file-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Known_issues" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#Known_issues">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">3</span>Known issues</div>
		</a>
		
		<ul id="toc-Known_issues-sublist" class="vector-toc-list">
		</ul>
	</li>
</ul>
</div>

					</div>
		</nav>
			</div>
		</div>
		<div class="mw-content-container">
			<main id="content" class="mw-body" role="main" style="margin: 0">
				<header class="mw-body-header vector-page-titlebar">
					<nav role="navigation" aria-label="Contents" class="vector-toc-landmark">
						
<div id="vector-page-titlebar-toc" class="vector-dropdown vector-page-titlebar-toc vector-button-flush-left">
	<input type="checkbox" id="vector-page-titlebar-toc-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-vector-page-titlebar-toc" class="vector-dropdown-checkbox " aria-label="Toggle the table of contents">
	<label id="vector-page-titlebar-toc-label" for="vector-page-titlebar-toc-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--icon-only " aria-hidden="true"><span class="vector-icon mw-ui-icon-listBullet mw-ui-icon-wikimedia-listBullet"></span>

<span class="vector-dropdown-label-text">Toggle the table of contents</span>
	</label>
	<div class="vector-dropdown-content">


							<div id="vector-page-titlebar-toc-unpinned-container" class="vector-unpinned-container">
			</div>
		
	</div>
</div>

					</nav>
					<h1 id="firstHeading" class="firstHeading mw-first-heading">dm-crypt/Swap encryption</h1>
							
<div id="p-lang-btn" class="vector-dropdown mw-portlet mw-portlet-lang">
	<input type="checkbox" id="p-lang-btn-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-p-lang-btn" class="vector-dropdown-checkbox mw-interlanguage-selector" aria-label="Go to an article in another language. Available in 5 languages">
	<label id="p-lang-btn-label" for="p-lang-btn-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--action-progressive mw-portlet-lang-heading-5" aria-hidden="true"><span class="vector-icon mw-ui-icon-language-progressive mw-ui-icon-wikimedia-language-progressive"></span>

<span class="vector-dropdown-label-text">5 languages</span>
	</label>
	<div class="vector-dropdown-content">

		<div class="vector-menu-content">
			
			<ul class="vector-menu-content-list">
				
				<li class="interlanguage-link interwiki-es mw-list-item"><a href="../../es/Dm-crypt/Swap_encryption.html" title="Dm-crypt (Español)/Swap encryption – español" lang="es" hreflang="es" class="interlanguage-link-target"><span>Español</span></a></li>
<li class="interlanguage-link interwiki-ja mw-list-item"><a href="https://wiki.archlinux.jp/index.php/Dm-crypt/%E3%82%B9%E3%83%AF%E3%83%83%E3%83%97%E3%81%AE%E6%9A%97%E5%8F%B7%E5%8C%96" title="Dm-crypt/スワップの暗号化 – 日本語" lang="ja" hreflang="ja" class="interlanguage-link-target"><span>日本語</span></a></li>
<li class="interlanguage-link interwiki-pl mw-list-item"><a href="../../pl/Dm-crypt/Swap_encryption.html" title="Dm-crypt (Polski)/Swap encryption – polski" lang="pl" hreflang="pl" class="interlanguage-link-target"><span>Polski</span></a></li>
<li class="interlanguage-link interwiki-pt mw-list-item"><a href="../../pt/Dm-crypt/Swap_encryption.html" title="Dm-crypt (Português)/Swap encryption – português" lang="pt" hreflang="pt" class="interlanguage-link-target"><span>Português</span></a></li>
<li class="interlanguage-link interwiki-uk mw-list-item"><a href="../../uk/Dm-crypt/Swap_encryption.html" title="Dm-crypt (Українська)/Swap encryption – українська" lang="uk" hreflang="uk" class="interlanguage-link-target"><span>Українська</span></a></li>
			</ul>
			
		</div>

	</div>
</div>
</header>
				<div class="vector-column-end">
					<div class="vector-sticky-pinned-container">
						<nav class="vector-page-tools-landmark" aria-label="Page tools">
							<div id="vector-page-tools-pinned-container" class="vector-pinned-container">
				
							</div>
		</nav>
						<nav class="vector-client-prefs-landmark" aria-label="Appearance">
						</nav>
					</div>
				</div>
				<div id="bodyContent" class="vector-body" aria-labelledby="firstHeading" data-mw-ve-target-container>
					<div class="vector-body-before-content">
							<div class="mw-indicators">
		</div>

						<div id="siteSub" class="noprint">From ArchWiki</div>
					</div>
					<div id="contentSub"><div id="mw-content-subtitle"><div class="subpages">&lt; <a href="../../en/Dm-crypt.html" title="Dm-crypt">Dm-crypt</a>
</div></div></div>
					
					
					<div id="mw-content-text" class="mw-body-content">
<div class="mw-content-ltr mw-parser-output" lang="en" dir="ltr">
<p><span>
</span>
Depending on requirements, different methods may be used to encrypt the <a href="../../en/Swap.html" title="Swap">swap</a> partition which are described in the following. A setup where the swap encryption is re-initialised on reboot (with a new encryption) provides higher data protection, because it avoids sensitive file fragments which may have been swapped out a long time ago without being overwritten. However, re-encrypting swap also forbids using a suspend-to-disk feature generally.
</p>
<meta property="mw:PageProp/toc">
<h2><span class="mw-headline" id="Without_suspend-to-disk_support">Without suspend-to-disk support</span></h2>
<p>In systems where suspend-to-disk (hibernation) is not a desired feature, <code>/etc/crypttab</code> can be set up to decrypt the swap partition with a random password with plain dm-crypt at boot-time. The random password is discarded on shutdown, leaving behind only encrypted, inaccessible data in the swap device.
</p>
<p>To enable this feature, simply uncomment the line beginning with <code>swap</code> in <code>/etc/crypttab</code>. Change the device parameter to the name of your swap device. For example, it will look something like this:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/crypttab</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;"># &lt;name&gt;  &lt;device&gt;     &lt;password&gt;     &lt;options&gt;
swap      /dev/sd<i>X#</i>    /dev/urandom   swap,cipher=aes-xts-plain64,size=512,sector-size=4096</pre>
<p>This will map <code>/dev/sd<i>X#</i></code> to <code>/dev/mapper/swap</code> as a swap partition that can be added in <code>/etc/fstab</code> like a normal swap. If you had a non-encrypted swap partition before, do not forget to disable it - or re-use its <a href="../../en/Fstab.html" title="Fstab">fstab</a> entry by changing the device to <code>/dev/mapper/swap</code>. The default options should be sufficient for most usage. For other options and an explanation of each column, see <span class="plainlinks archwiki-template-man" title="$ man 5 crypttab"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/crypttab.5">crypttab(5)</a></span> as well as <a rel="nofollow" class="external text" href="https://gitlab.com/cryptsetup/cryptsetup/wikis/FrequentlyAskedQuestions#2-setup">point cryptsetup FAQ 2.3</a>.
</p>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> All contents of the named device will be permanently <b>deleted</b>. It is dangerous to use the kernel's simple naming for a swap device, since their naming order (<i>e.g.</i> <code>/dev/sda</code>, <code>/dev/sdb</code>) changes upon each boot. Options are:
<ul>
<li>Use <code>by-id</code> and <code>by-path</code> paths. However, these are both are susceptible to hardware changes. See <a href="../../en/Persistent_block_device_naming.html#by-id_and_by-path" title="Persistent block device naming">Persistent block device naming#by-id and by-path</a>.</li>
<li>Use <a href="../../en/Persistent_block_device_naming.html#by-partlabel" class="mw-redirect" title="PARTLABEL">PARTLABEL</a>.</li>
<li>Use an <a href="../../en/LVM.html" title="LVM">LVM</a> logical volume's name.</li>
<li>Use the method described in <a href="#UUID_and_LABEL">#UUID and LABEL</a>. Labels and <a href="../../en/Persistent_block_device_naming.html#by-uuid" title="Persistent block device naming">UUIDS</a> <b>cannot</b> be used directly because of the recreation and re-encryption of the swap device on every boot with <code>mkswap</code>, see <a rel="nofollow" class="external text" href="https://gitlab.com/cryptsetup/cryptsetup/wikis/FrequentlyAskedQuestions#2-setup">cryptsetup FAQ</a>.</li>
</ul>
</div>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> Swap partition setup can sometimes fail, see <a rel="nofollow" class="external text" href="https://github.com/systemd/systemd/issues/10179">systemd issue 10179</a>.</div>
<p>To use a <code>by-id</code> persistent device naming instead of kernel simple naming, first identify the swap device:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># find -L /dev/disk -samefile /dev/<i>sdaX</i></pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">/dev/disk/by-id/ata-WDC_WD2500BEVT-22ZCT0_WD-WXE908VF0470-part<i>X</i>
/dev/disk/by-id/wwn-0x60015ee0000b237f-part<i>X</i>
</pre>
<p>Then use as a persistent reference for the <code>/dev/sd<i>X#</i></code> example partition (if two results are returned as above, choose either one of them):
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/crypttab</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;"># &lt;name&gt;  &lt;device&gt;                                                         &lt;password&gt;     &lt;options&gt;
swap      /dev/disk/by-id/ata-WDC_WD2500BEVT-22ZCT0_WD-WXE908VF0470-partX  /dev/urandom   swap,cipher=aes-xts-plain64,size=512,sector-size=4096</pre>
<p>After a reboot to activate the encrypted swap, you will note that running <code>swapon -s</code> shows an arbitrary device mapper entry (e.g. <code>/dev/dm-1</code>) for it, while the <code>lsblk</code> command shows <b>crypt</b> in the <code>FSTYPE</code> column. Due to fresh encryption each boot, the UUID for <code>/dev/mapper/swap</code> will change every time.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> If the partition chosen for swap was previously a LUKS partition, crypttab will not overwrite the partition to create a swap partition. This is a safety measure to prevent data loss from accidental mis-identification of the swap partition in crypttab. In order to use such a partition the <a href="../../en/Dm-crypt/Drive_preparation.html#Wipe_LUKS_header" title="Dm-crypt/Drive preparation">LUKS header must be overwritten</a> once.</div>
<h3><span class="mw-headline" id="UUID_and_LABEL">UUID and LABEL</span></h3>
<p>It is dangerous to use crypttab swap with simple kernel device names like <code>/dev/sdX#</code> or even <code>/dev/disk/by-id/ata-SERIAL-partX</code>. A small change in your device names or partitioning layout and <code>/etc/crypttab</code> will see your valuable data formatted on the next boot. Same if you use PARTUUID and then decide to use that partition for something else without removing the crypttab entry first.
</p>
<p>It is more reliable to identify the correct partition by giving it a genuine UUID or LABEL. By default that does not work because dm-crypt and <code>mkswap</code> would simply overwrite any content on that partition which would remove the UUID and LABEL too; however, it is possible to specify a swap offset. This allows you to create a very small, empty, bogus filesystem with no other purpose than providing a persistent UUID or LABEL for the swap encryption.
</p>
<p>Create a <a href="../../en/File_systems.html" class="mw-redirect" title="Filesystem">filesystem</a> with label of your choice:
</p>
<pre># mkfs.ext2 -L <i>cryptswap</i> /dev/sd<i>X#</i> 1M
</pre>
<p>The unusual parameter after the device name limits the filesystem size to 1 MiB, leaving room for encrypted swap behind it.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># blkid /dev/sdX#</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">/dev/sdX#: LABEL="cryptswap" UUID="b72c384e-bd3c-49aa-b7a7-a28ea81a2605" TYPE="ext2"</pre>
<p>With this, <code>/dev/sdX#</code> now can easily be identified either by UUID or LABEL, regardless of how its device name or even partition number might change in the future. All that is left are the <code>/etc/crypttab</code> and <code>/etc/fstab</code> entries. For example, using different encryption options:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/crypttab</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;"># &lt;name&gt; &lt;device&gt;         &lt;password&gt;    &lt;options&gt;
swap     LABEL=<i>cryptswap</i>  /dev/urandom  swap,offset=2048,cipher=aes-xts-plain64,size=512,sector-size=4096</pre>
<p>Note the offset: it is 2048 sectors of 512 bytes (it is not affected by the dm-crypt sector size), thus 1 MiB. This way the encrypted swap will not affect the filesystem LABEL/UUID, and data alignment works out as well.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/fstab</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;"># &lt;filesystem&gt;    &lt;dir&gt;  &lt;type&gt;  &lt;options&gt;  &lt;dump&gt;  &lt;pass&gt;
/dev/mapper/swap  none   swap    defaults   0       0</pre>
<p>Using this setup, the cryptswap will only try to use the partition with the corresponding LABEL, regardless of what its device name may be. Should you decide to use the partition for something else, by formatting it the cryptswap LABEL would also be gone, so <code>/etc/crypttab</code> will not overwrite it on your next boot.
</p>
<h3><span class="mw-headline" id="Disabling_hibernation_in_desktop_environments">Disabling hibernation in desktop environments</span></h3>
<p>Desktop environments may not automatically detect that a swap partition is randomly encrypted and cannot be used for suspend-to-disk.
</p>
<p><a href="../../en/Xfce.html" title="Xfce">Xfce</a> can be configured to hide its <i>Hibernate</i> button by running this command:
</p>
<pre>$ xfconf-query -c xfce4-session -np /shutdown/ShowHibernate -t bool -s false
</pre>
<h2><span class="mw-headline" id="With_suspend-to-disk_support">With suspend-to-disk support</span></h2>
<p>To be able to resume after suspending the computer to disk (hibernate), it is required to keep the swap space intact. Therefore, it is required to have a pre-existent LUKS swap partition or file, which can be stored on the disk or input manually at startup.
</p>
<p>The following three methods are alternatives for setting up an encrypted swap for suspend-to-disk. If you apply any of them, be aware that critical data swapped out by the system may potentially stay in the swap over a long period (i.e. until it is overwritten). To reduce this risk consider setting up a system job which re-encrypts swap, e.g. each time the system is going into a regular shut-down, along with the method of your choice.
</p>
<h3><span class="mw-headline" id="LVM_on_LUKS">LVM on LUKS</span></h3>
<p>If the swap volume is in a volume group that gets activated in initramfs, simply follow the instructions in <a href="../../en/Power_management/Suspend_and_hibernate.html#Hibernation" title="Power management/Suspend and hibernate">Power management/Suspend and hibernate#Hibernation</a>.
</p>
<h3><span class="mw-headline" id="Using_a_swap_partition">Using a swap partition</span></h3>
<p>If you want to use a partition which is currently used by the system, you have to disable it first:
</p>
<pre># swapoff /dev/<i>device</i>
</pre>
<p>Also make sure you remove any line in <code>/etc/crypttab</code> pointing to this device.
</p>
<p>If you are reusing an existing swap <a href="../../en/Partitioning.html" class="mw-redirect" title="Partition">partition</a>, and if the partition is on a GPT partition table, you will need use <a href="../../en/GPT_fdisk.html" class="mw-redirect" title="Gdisk">gdisk</a> to set the <a href="../../en/GPT_fdisk.html#Prevent_GPT_partition_automounting" class="mw-redirect" title="Gdisk">partition attribute 63 "do not automount"</a> on it. This will prevent systemd-gpt-auto-generator from discovering and enabling the partition at boot.
</p>
<p>The following setup has the disadvantage of having to insert an additional passphrase for the swap partition manually on every boot.
</p>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> Do not use this setup with a key file if <code>/boot</code> is unencrypted. Please read about the issue reported <a rel="nofollow" class="external text" href="https://wiki.archlinux.org/index.php?title=Talk:Dm-crypt&amp;oldid=255742#Suspend_to_disk_instructions_are_insecure">here</a>. Alternatively, use a gnupg-encrypted keyfile as per <a rel="nofollow" class="external free" href="https://bbs.archlinux.org/viewtopic.php?id=120181">https://bbs.archlinux.org/viewtopic.php?id=120181</a>
</div>
<p>To format the encrypted container for the swap partition, create a keyslot for a user-memorizable passphrase.
</p>
<pre># cryptsetup luksFormat /dev/<i>device</i>
</pre>
<p>Open the partition in <code>/dev/mapper</code>:
</p>
<pre># cryptsetup open /dev/<i>device</i> swapDevice
</pre>
<p>Create a swap filesystem inside the mapped partition:
</p>
<pre># mkswap /dev/mapper/swapDevice
</pre>
<p>Add the mapped partition to <code>/etc/fstab</code> by adding the following line:
</p>
<pre>/dev/mapper/swapDevice swap swap defaults 0 0
</pre>
<p>Set up your system to resume from <code>/dev/mapper/swapDevice</code>. For example, if you use <a href="../../en/GRUB.html" title="GRUB">GRUB</a> with kernel hibernation support, add the kernel parameter <code>resume=/dev/mapper/swapDevice</code> to GRUB by appending it to the <code>GRUB_CMDLINE_LINUX_DEFAULT</code> variable in <code>/etc/default/grub</code>. A kernel line with encrypted root and swap partitions can look like this:
</p>
<pre>kernel /vmlinuz-linux cryptdevice=/dev/sda2:rootDevice root=/dev/mapper/rootDevice resume=/dev/mapper/swapDevice ro
</pre>
<h4><span class="mw-headline" id="mkinitcpio_hook">mkinitcpio hook</span></h4>
<p>To resume from an encrypted swap partition, the encrypted partition must be unlocked in the initramfs.
</p>
<ul>
<li>When using the default busybox-based initramfs with the <a href="../../en/Dm-crypt/System_configuration.html#Using_encrypt_hook" title="Dm-crypt/System configuration">encrypt</a> hook, follow the instructions in <a href="#mkinitcpio_hook">#mkinitcpio hook</a>.</li>
<li>When using the systemd-based initramfs with the <a href="../../en/Dm-crypt/System_configuration.html#Using_systemd-cryptsetup-generator" class="mw-redirect" title="Sd-encrypt">sd-encrypt</a> mkinitcpio hook, simply specify additional <code>rd.luks</code> kernel parameters to unlock the swap partition.</li>
</ul>
<p>If the swap device is on a different device from that of the root file system, it will not be opened by the <code>encrypt</code> hook, i.e. the resume will take place before <code>/etc/crypttab</code> can be used, therefore it is required to create a hook in <code>/etc/mkinitcpio.conf</code> to open the swap LUKS device before resuming.
</p>
<div class="noprint archwiki-template-message">
<p><span class="mw-default-size" typeof="mw:File"><span><img src="../../File:Merge-arrows-2.svg" decoding="async" width="36" height="40" class="mw-file-element"></span></span><b>This article or section is a candidate for merging with <a href="../../en/Dm-crypt/Specialties.html#Multiple_non-root_partitions" title="Dm-crypt/Specialties">dm-crypt/Specialties#Multiple non-root partitions</a>.</b></p>
<div>
<b>Notes:</b> Same use case. (Discuss in <a rel="nofollow" class="external text" href="../../en/Talk:Dm-crypt/Swap_encryption.html">Talk:Dm-crypt/Swap encryption</a>)</div>
</div>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> This section is only applicable when using the <code>encrypt</code> hook, which can only unlock a single device (<a rel="nofollow" class="external text" href="https://bugs.archlinux.org/task/23182">FS#23182</a>). With <code>sd-encrypt</code> multiple devices may be unlocked, see <a href="../../en/Dm-crypt/System_configuration.html#Using_systemd-cryptsetup-generator" title="Dm-crypt/System configuration">dm-crypt/System configuration#Using systemd-cryptsetup-generator</a>.</div>
<p>Now you have to create a hook to open the swap at boot time. You can either <a href="../../en/Help:Reading.html#Installation_of_packages" class="mw-redirect" title="Install">install</a> and configure <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/mkinitcpio-openswap/">mkinitcpio-openswap</a></span><sup><small>AUR</small></sup>, or follow the following instructions. Create a hook file containing the open command:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/initcpio/hooks/openswap</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">run_hook ()
{
    cryptsetup open /dev/<i>device</i> swapDevice
}
</pre>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> Mounting the file system <a rel="nofollow" class="external text" href="https://docs.kernel.org/power/swsusp.html">is dangerous and destructive</a>. The keyfile should not be read from a file system that was mounted when the system was suspended.</div>
<div class="noprint archwiki-template-message">
<p><span class="mw-default-size" typeof="mw:File"><span><img src="../../File:Tango-view-fullscreen.svg" decoding="async" width="48" height="48" class="mw-file-element"></span></span><b>This article or section needs expansion.</b></p>
<div>
<b>Reason:</b> Add instructions that would not lead to data loss. (Discuss in <a rel="nofollow" class="external text" href="../../en/Talk:Dm-crypt/Swap_encryption.html">Talk:Dm-crypt/Swap encryption</a>)</div>
</div>
<p>for opening the swap device by typing your password or
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/initcpio/hooks/openswap</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">run_hook ()
{
    ## Optional: To avoid race conditions
    x=0;
    while [ ! -b /dev/mapper/<i>root-device</i> ] &amp;&amp; [ $x -le 10 ]; do
       x=$((x+1))
       sleep .2
    done
    ## End of optional

    mkdir crypto_key_device
    mount /dev/mapper/<i>root-device</i> crypto_key_device
    cryptsetup open --key-file crypto_key_device/<i>path-to-the-key</i> /dev/<i>device</i> swapDevice
    umount crypto_key_device
}</pre>
<p>for opening the swap device by loading a keyfile from a crypted root device.
</p>
<p>On some computers race conditions may occur when mkinitcpio tries to mount the device before the decryption process and device enumeration is completed. The commented <i>Optional</i> block will delay the boot process up to 2 seconds until the root device is ready to mount.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> If swap is on a Solid State Disk (SSD) and Discard/TRIM is desired the option <code>--allow-discards</code> has to get added to the cryptsetup line in the openswap hook above. See <a href="../../en/Dm-crypt/Specialties.html#Discard/TRIM_support_for_solid_state_drives_(SSD)" title="Dm-crypt/Specialties">Dm-crypt/Specialties#Discard/TRIM support for solid state drives (SSD)</a> or <a href="../../en/Solid_state_drive.html" class="mw-redirect" title="SSD">SSD</a> for more information on discard. Additionally you have to add the mount option 'discard' to your fstab entry for the swap device.</div>
<p>Then create and edit the hook setup file:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/initcpio/install/openswap</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">build ()
{
   add_runscript
}
help ()
{
cat&lt;&lt;HELPEOF
  This opens the swap encrypted partition /dev/<i>device</i> in /dev/mapper/swapDevice
HELPEOF
}
</pre>
<p>Add the hook <code>openswap</code> in the <code>HOOKS</code> array in <code>/etc/mkinitcpio.conf</code>, before <code>filesystem</code> but after <code>encrypt</code>. Do not forget to add the <code>resume</code> hook after <code>openswap</code>.
</p>
<pre>HOOKS=(... encrypt openswap resume filesystems ...)
</pre>
<p><a href="../../en/Mkinitcpio.html#Image_creation_and_activation" class="mw-redirect" title="Regenerate the initramfs">Regenerate the initramfs</a>.
</p>
<p>At boot time, the <code>openswap</code> hook will open the swap partition so the kernel resume may use it. If you use special hooks for resuming from hibernation, make sure they are placed <b>after</b> <code>openswap</code> in the <code>HOOKS</code> array. Please note that because of initrd opening swap, there is no entry for swapDevice in <code>/etc/crypttab</code> needed in this case.
</p>
<h4><span class="mw-headline" id="dracut">dracut</span></h4>
<p>Create a keyfile:
</p>
<pre># dd bs=512 count=4 if=/dev/random of=/etc/cryptsetup-keys.d/swap.key iflag=fullblock
</pre>
<p>Unset permissions:
</p>
<pre># chmod 0 /etc/cryptsetup-keys.d/swap.key
</pre>
<p>Add the keyfile to LUKS:
</p>
<pre># cryptsetup luksAddKey /dev/<i>device</i> /etc/cryptsetup-keys.d/swap.key
</pre>
<p>Configure dracut to include the <code>resume</code> module and add the <code>swap.key</code> file to the initramfs (See also <a href="../../en/Dracut.html#Hibernation" title="Dracut">dracut#Hibernation</a>):
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/dracut.conf.d/resume-from-hibernate.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">add_dracutmodules+=" resume "
install_items+=" /etc/cryptsetup-keys.d/swap.key "</pre>
<p><a href="../../en/Dracut.html#Usage" title="Dracut">Regenerate the initramfs</a>.
</p>
<p>Add the <code>rd.luks.name</code> and <code>rd.luks.key</code> (replace the swap's partition UUID) entries to your kernel command line.
Your kernel command might look like this now:
</p>
<pre>kernel /vmlinuz-linux cryptdevice=/dev/sda2:rootDevice root=/dev/mapper/rootDevice resume=/dev/mapper/swapDevice rd.luks.name=fd839505-3213-4603-9a70-c5a96a24768f=swapDevice rd.luks.key=/etc/cryptsetup-keys.d/swap.key ro
</pre>
<h3><span class="mw-headline" id="Using_a_swap_file">Using a swap file</span></h3>
<p>A swap file can be used to reserve swap-space within an existing partition and may also be setup inside an encrypted blockdevice's partition.
</p>
<p>Follow swap file creation instructions in <a href="../../en/Swap.html#Swap_file" title="Swap">Swap#Swap file</a> and set up hibernation according to <a href="../../en/Power_management/Suspend_and_hibernate.html#Acquire_swap_file_offset" title="Power management/Suspend and hibernate">Power management/Suspend and hibernate#Acquire swap file offset</a>.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> 
<ul>
<li>When resuming from a swapfile the <code>resume</code> parameter must point to the unlocked/mapped device that contains the file system with the swap file.</li>
<li>Ensure that the resume hook of mkinitcpio is ran after the device the swap partition lives on is unlocked by placing <code>resume</code> after <code>encrypt</code> in the <code>HOOKS</code> array.</li>
</ul>
</div>
<h2><span class="mw-headline" id="Known_issues">Known issues</span></h2>
<ul><li>
<code>Stopped (with error) /dev/dm-1</code> in logs. See <a rel="nofollow" class="external text" href="https://github.com/systemd/systemd/issues/1620">systemd issue 1620</a>.</li></ul>
</div>
</div>
					<div id="catlinks" class="catlinks" data-mw="interface">
<div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../../Special:Categories.html" title="Special:Categories">Category</a>: <ul><li><a href="../../en/Category:Data-at-rest_encryption.html" title="Category:Data-at-rest encryption">Data-at-rest encryption</a></li></ul>
</div>
<div id="mw-hidden-catlinks" class="mw-hidden-catlinks mw-hidden-cats-hidden">Hidden categories: <ul>
<li><a href="../../en/Category:Pages_or_sections_flagged_with_Template:Merge.html" title="Category:Pages or sections flagged with Template:Merge">Pages or sections flagged with Template:Merge</a></li>
<li><a href="../../en/Category:Pages_or_sections_flagged_with_Template:Expansion.html" title="Category:Pages or sections flagged with Template:Expansion">Pages or sections flagged with Template:Expansion</a></li>
</ul>
</div>
</div>
				</div>
			</main>
			
		</div>
		<div class="mw-footer-container">
			
<footer id="footer" class="mw-footer" role="contentinfo" style="margin: 0">
	<ul id="footer-info">
	<li data-nosnippet="">Retrieved from "<a dir="ltr" href="https://wiki.archlinux.org/index.php?title=Dm-crypt/Swap_encryption&amp;oldid=810580">https://wiki.archlinux.org/index.php?title=Dm-crypt/Swap_encryption&amp;oldid=810580</a>"</li>
<li id="footer-info-lastmod"> This page was last edited on 15 June 2024, at 08:08.</li>
	<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="https://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.3 or later</a> unless otherwise noted.</li>
<br>
</ul>

	<ul id="footer-places">
	<li id="footer-places-privacy"><a href="https://terms.archlinux.org/docs/privacy-policy/">Privacy policy</a></li>
	<li id="footer-places-about"><a href="../../en/ArchWiki:About.html">About ArchWiki</a></li>
	<li id="footer-places-disclaimers"><a href="../../en/ArchWiki:General_disclaimer.html">Disclaimers</a></li>
	<li id="footer-places-archwiki-code-of-conduct"><a href="https://terms.archlinux.org/docs/code-of-conduct/" class="extiw" title="archlinux-service-agreements:code-of-conduct">Code of conduct</a></li>
	<li id="footer-places-archwiki-terms-of-service"><a href="https://terms.archlinux.org/docs/terms-of-service/" class="extiw" title="archlinux-service-agreements:terms-of-service">Terms of service</a></li>
</ul>

	<ul id="footer-icons" class="noprint">
	<li id="footer-copyrightico"><a href="https://www.gnu.org/copyleft/fdl.html"><img src="/resources/assets/licenses/gnu-fdl.png" alt="GNU Free Documentation License 1.3 or later" width="88" height="31" loading="lazy"></a></li>
	<li id="footer-poweredbyico"><img src="/resources/assets/poweredby_mediawiki_88x31.png" srcset="/resources/assets/poweredby_mediawiki_132x47.png 1.5x, /resources/assets/poweredby_mediawiki_176x62.png 2x" width="88" height="31" loading="lazy"></li>
</ul>

</footer>

		</div>
	</div> 
</div> 
<div class="vector-settings" id="p-dock-bottom">
	<ul>
		<li>
		<button class="cdx-button cdx-button--icon-only vector-limited-width-toggle" id=""><span class="vector-icon mw-ui-icon-fullScreen mw-ui-icon-wikimedia-fullScreen"></span>

<span>Toggle limited content width</span>
</button>
</li>
	</ul>
</div>
</body>
</html>
