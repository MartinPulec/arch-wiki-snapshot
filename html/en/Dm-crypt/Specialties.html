<!DOCTYPE html>
<html class="client-nojs vector-feature-language-in-header-enabled vector-feature-language-in-main-page-header-disabled vector-feature-sticky-header-disabled vector-feature-page-tools-pinned-disabled vector-feature-toc-pinned-clientpref-1 vector-feature-main-menu-pinned-disabled vector-feature-limited-width-clientpref-1 vector-feature-limited-width-content-enabled vector-feature-custom-font-size-clientpref-0 vector-feature-client-preferences-disabled vector-feature-client-prefs-pinned-disabled vector-feature-night-mode-disabled skin-theme-clientpref-day vector-toc-available" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>dm-crypt/Specialties - ArchWiki</title>
<link rel="stylesheet" href="../../ArchWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<meta name="generator" content="MediaWiki 1.42.1">
<meta name="referrer" content="no-referrer-when-downgrade">
<meta name="robots" content="max-image-preview:standard">
<meta name="format-detection" content="telephone=no">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=0.25, maximum-scale=5.0">
<link rel="icon" href="/favicon.ico">
<link rel="search" type="application/opensearchdescription+xml" href="/opensearch_desc.php" title="ArchWiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.archlinux.org/api.php?action=rsd">
<link rel="license" href="https://www.gnu.org/copyleft/fdl.html">
<link rel="alternate" type="application/atom+xml" title="ArchWiki Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="skin-vector skin-vector-search-vue mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-Dm-crypt_Specialties rootpage-Dm-crypt skin-vector-2022 action-view skin--responsive">
<a class="mw-jump-link" href="#bodyContent">Jump to content</a>
<div class="vector-header-container">
	</div>
<div class="mw-page-container">
	<div class="mw-page-container-inner">
		<div class="vector-column-start">
			<div class="vector-main-menu-container">
		</div>
	<div class="vector-sticky-pinned-container">
				<nav id="mw-panel-toc" role="navigation" aria-label="Contents" data-event-name="ui.sidebar-toc" class="mw-table-of-contents-container vector-toc-landmark">
					<div id="vector-toc-pinned-container" class="vector-pinned-container">
					<div id="vector-toc" class="vector-toc vector-pinnable-element">
	<div class="vector-pinnable-header vector-toc-pinnable-header vector-pinnable-header-pinned" data-feature-name="toc-pinned" data-pinnable-element-id="vector-toc">
	<h2 class="vector-pinnable-header-label">Contents</h2>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-pin-button" data-event-name="pinnable-header.vector-toc.pin">move to sidebar</button>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-unpin-button" data-event-name="pinnable-header.vector-toc.unpin">hide</button>
</div>


	<ul class="vector-toc-contents" id="mw-panel-toc-list">
		<li id="toc-mw-content-text" class="vector-toc-list-item vector-toc-level-1">
			<a href="#" class="vector-toc-link">
				<div class="vector-toc-text">Beginning</div>
			</a>
		</li>
		<li id="toc-Securing_the_unencrypted_boot_partition" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#Securing_the_unencrypted_boot_partition">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">1</span>Securing the unencrypted boot partition</div>
		</a>
		
			<button aria-controls="toc-Securing_the_unencrypted_boot_partition-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Securing the unencrypted boot partition subsection</span>
			</button>
		
		<ul id="toc-Securing_the_unencrypted_boot_partition-sublist" class="vector-toc-list">
			<li id="toc-Booting_from_a_removable_device" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Booting_from_a_removable_device">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">1.1</span>Booting from a removable device</div>
			</a>
			
			<ul id="toc-Booting_from_a_removable_device-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-chkboot" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#chkboot">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">1.2</span>chkboot</div>
			</a>
			
			<ul id="toc-chkboot-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-mkinitcpio-chkcryptoboot" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#mkinitcpio-chkcryptoboot">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">1.3</span>mkinitcpio-chkcryptoboot</div>
			</a>
			
			<ul id="toc-mkinitcpio-chkcryptoboot-sublist" class="vector-toc-list">
				<li id="toc-Installation" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Installation">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">1.3.1</span>Installation</div>
			</a>
			
			<ul id="toc-Installation-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Technical_overview" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Technical_overview">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">1.3.2</span>Technical overview</div>
			</a>
			
			<ul id="toc-Technical_overview-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-AIDE" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#AIDE">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">1.4</span>AIDE</div>
			</a>
			
			<ul id="toc-AIDE-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-STARK" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#STARK">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">1.5</span>STARK</div>
			</a>
			
			<ul id="toc-STARK-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Using_GPG,_LUKS,_or_OpenSSL_encrypted_keyfiles" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#Using_GPG,_LUKS,_or_OpenSSL_encrypted_keyfiles">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">2</span>Using GPG, LUKS, or OpenSSL encrypted keyfiles</div>
		</a>
		
		<ul id="toc-Using_GPG,_LUKS,_or_OpenSSL_encrypted_keyfiles-sublist" class="vector-toc-list">
		</ul>
	</li>
	<li id="toc-Remote_unlocking_of_root_(or_other)_partition" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#Remote_unlocking_of_root_(or_other)_partition">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">3</span>Remote unlocking of root (or other) partition</div>
		</a>
		
			<button aria-controls="toc-Remote_unlocking_of_root_(or_other)_partition-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Remote unlocking of root (or other) partition subsection</span>
			</button>
		
		<ul id="toc-Remote_unlocking_of_root_(or_other)_partition-sublist" class="vector-toc-list">
			<li id="toc-Busybox_based_initramfs_(built_with_mkinitcpio)" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Busybox_based_initramfs_(built_with_mkinitcpio)">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.1</span>Busybox based initramfs (built with mkinitcpio)</div>
			</a>
			
			<ul id="toc-Busybox_based_initramfs_(built_with_mkinitcpio)-sublist" class="vector-toc-list">
				<li id="toc-Enabling_Wi-Fi" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Enabling_Wi-Fi">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.1.1</span>Enabling Wi-Fi</div>
			</a>
			
			<ul id="toc-Enabling_Wi-Fi-sublist" class="vector-toc-list">
				<li id="toc-Predefined_hook" class="vector-toc-list-item vector-toc-level-4">
			<a class="vector-toc-link" href="#Predefined_hook">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.1.1.1</span>Predefined hook</div>
			</a>
			
			<ul id="toc-Predefined_hook-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Custom_hook" class="vector-toc-list-item vector-toc-level-4">
			<a class="vector-toc-link" href="#Custom_hook">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.1.1.2</span>Custom hook</div>
			</a>
			
			<ul id="toc-Custom_hook-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
	</ul>
		</li>
		<li id="toc-systemd_based_initramfs_(built_with_mkinitcpio)" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#systemd_based_initramfs_(built_with_mkinitcpio)">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.2</span>systemd based initramfs (built with mkinitcpio)</div>
			</a>
			
			<ul id="toc-systemd_based_initramfs_(built_with_mkinitcpio)-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-systemd_based_initramfs_(built_with_dracut)" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#systemd_based_initramfs_(built_with_dracut)">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.3</span>systemd based initramfs (built with dracut)</div>
			</a>
			
			<ul id="toc-systemd_based_initramfs_(built_with_dracut)-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-One-time_password-less_reboot" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#One-time_password-less_reboot">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">4</span>One-time password-less reboot</div>
		</a>
		
		<ul id="toc-One-time_password-less_reboot-sublist" class="vector-toc-list">
		</ul>
	</li>
	<li id="toc-Discard/TRIM_support_for_solid_state_drives_(SSD)" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#Discard/TRIM_support_for_solid_state_drives_(SSD)">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">5</span>Discard/TRIM support for solid state drives (SSD)</div>
		</a>
		
			<button aria-controls="toc-Discard/TRIM_support_for_solid_state_drives_(SSD)-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Discard/TRIM support for solid state drives (SSD) subsection</span>
			</button>
		
		<ul id="toc-Discard/TRIM_support_for_solid_state_drives_(SSD)-sublist" class="vector-toc-list">
			<li id="toc-LUKS2" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#LUKS2">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">5.1</span>LUKS2</div>
			</a>
			
			<ul id="toc-LUKS2-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-LUKS1_and_plain_dm-crypt" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#LUKS1_and_plain_dm-crypt">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">5.2</span>LUKS1 and plain dm-crypt</div>
			</a>
			
			<ul id="toc-LUKS1_and_plain_dm-crypt-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Disable_workqueue_for_increased_solid_state_drive_(SSD)_performance" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#Disable_workqueue_for_increased_solid_state_drive_(SSD)_performance">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">6</span>Disable workqueue for increased solid state drive (SSD) performance</div>
		</a>
		
		<ul id="toc-Disable_workqueue_for_increased_solid_state_drive_(SSD)_performance-sublist" class="vector-toc-list">
		</ul>
	</li>
	<li id="toc-The_encrypt_hook_and_multiple_disks" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#The_encrypt_hook_and_multiple_disks">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">7</span>The encrypt hook and multiple disks</div>
		</a>
		
			<button aria-controls="toc-The_encrypt_hook_and_multiple_disks-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle The encrypt hook and multiple disks subsection</span>
			</button>
		
		<ul id="toc-The_encrypt_hook_and_multiple_disks-sublist" class="vector-toc-list">
			<li id="toc-Expanding_LVM_on_multiple_disks" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Expanding_LVM_on_multiple_disks">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">7.1</span>Expanding LVM on multiple disks</div>
			</a>
			
			<ul id="toc-Expanding_LVM_on_multiple_disks-sublist" class="vector-toc-list">
				<li id="toc-Adding_a_new_drive" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Adding_a_new_drive">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">7.1.1</span>Adding a new drive</div>
			</a>
			
			<ul id="toc-Adding_a_new_drive-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Extending_the_logical_volume" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Extending_the_logical_volume">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">7.1.2</span>Extending the logical volume</div>
			</a>
			
			<ul id="toc-Extending_the_logical_volume-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Modifying_the_encrypt_hook_for_multiple_partitions" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Modifying_the_encrypt_hook_for_multiple_partitions">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">7.2</span>Modifying the encrypt hook for multiple partitions</div>
			</a>
			
			<ul id="toc-Modifying_the_encrypt_hook_for_multiple_partitions-sublist" class="vector-toc-list">
				<li id="toc-Root_filesystem_spanning_multiple_partitions" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Root_filesystem_spanning_multiple_partitions">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">7.2.1</span>Root filesystem spanning multiple partitions</div>
			</a>
			
			<ul id="toc-Root_filesystem_spanning_multiple_partitions-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Multiple_non-root_partitions" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Multiple_non-root_partitions">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">7.2.2</span>Multiple non-root partitions</div>
			</a>
			
			<ul id="toc-Multiple_non-root_partitions-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Encrypted_system_using_a_detached_LUKS_header" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#Encrypted_system_using_a_detached_LUKS_header">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">8</span>Encrypted system using a detached LUKS header</div>
		</a>
		
			<button aria-controls="toc-Encrypted_system_using_a_detached_LUKS_header-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Encrypted system using a detached LUKS header subsection</span>
			</button>
		
		<ul id="toc-Encrypted_system_using_a_detached_LUKS_header-sublist" class="vector-toc-list">
			<li id="toc-Using_systemd_hook" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Using_systemd_hook">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.1</span>Using systemd hook</div>
			</a>
			
			<ul id="toc-Using_systemd_hook-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Modifying_encrypt_hook" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Modifying_encrypt_hook">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.2</span>Modifying encrypt hook</div>
			</a>
			
			<ul id="toc-Modifying_encrypt_hook-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Encrypted_/boot_and_a_detached_LUKS_header_on_USB" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#Encrypted_/boot_and_a_detached_LUKS_header_on_USB">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">9</span>Encrypted /boot and a detached LUKS header on USB</div>
		</a>
		
			<button aria-controls="toc-Encrypted_/boot_and_a_detached_LUKS_header_on_USB-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Encrypted /boot and a detached LUKS header on USB subsection</span>
			</button>
		
		<ul id="toc-Encrypted_/boot_and_a_detached_LUKS_header_on_USB-sublist" class="vector-toc-list">
			<li id="toc-Preparing_the_disk_devices" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Preparing_the_disk_devices">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">9.1</span>Preparing the disk devices</div>
			</a>
			
			<ul id="toc-Preparing_the_disk_devices-sublist" class="vector-toc-list">
				<li id="toc-Preparing_the_USB_key" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Preparing_the_USB_key">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">9.1.1</span>Preparing the USB key</div>
			</a>
			
			<ul id="toc-Preparing_the_USB_key-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-The_main_drive" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#The_main_drive">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">9.1.2</span>The main drive</div>
			</a>
			
			<ul id="toc-The_main_drive-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Installation_procedure_and_custom_encrypt_hook" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Installation_procedure_and_custom_encrypt_hook">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">9.2</span>Installation procedure and custom encrypt hook</div>
			</a>
			
			<ul id="toc-Installation_procedure_and_custom_encrypt_hook-sublist" class="vector-toc-list">
				<li id="toc-Boot_loader" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Boot_loader">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">9.2.1</span>Boot loader</div>
			</a>
			
			<ul id="toc-Boot_loader-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Changing_the_LUKS_keyfile" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Changing_the_LUKS_keyfile">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">9.3</span>Changing the LUKS keyfile</div>
			</a>
			
			<ul id="toc-Changing_the_LUKS_keyfile-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
</ul>
</div>

					</div>
		</nav>
			</div>
		</div>
		<div class="mw-content-container">
			<main id="content" class="mw-body" role="main" style="margin: 0">
				<header class="mw-body-header vector-page-titlebar">
					<nav role="navigation" aria-label="Contents" class="vector-toc-landmark">
						
<div id="vector-page-titlebar-toc" class="vector-dropdown vector-page-titlebar-toc vector-button-flush-left">
	<input type="checkbox" id="vector-page-titlebar-toc-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-vector-page-titlebar-toc" class="vector-dropdown-checkbox " aria-label="Toggle the table of contents">
	<label id="vector-page-titlebar-toc-label" for="vector-page-titlebar-toc-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--icon-only " aria-hidden="true"><span class="vector-icon mw-ui-icon-listBullet mw-ui-icon-wikimedia-listBullet"></span>

<span class="vector-dropdown-label-text">Toggle the table of contents</span>
	</label>
	<div class="vector-dropdown-content">


							<div id="vector-page-titlebar-toc-unpinned-container" class="vector-unpinned-container">
			</div>
		
	</div>
</div>

					</nav>
					<h1 id="firstHeading" class="firstHeading mw-first-heading">dm-crypt/Specialties</h1>
							
<div id="p-lang-btn" class="vector-dropdown mw-portlet mw-portlet-lang">
	<input type="checkbox" id="p-lang-btn-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-p-lang-btn" class="vector-dropdown-checkbox mw-interlanguage-selector" aria-label="Go to an article in another language. Available in 3 languages">
	<label id="p-lang-btn-label" for="p-lang-btn-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--action-progressive mw-portlet-lang-heading-3" aria-hidden="true"><span class="vector-icon mw-ui-icon-language-progressive mw-ui-icon-wikimedia-language-progressive"></span>

<span class="vector-dropdown-label-text">3 languages</span>
	</label>
	<div class="vector-dropdown-content">

		<div class="vector-menu-content">
			
			<ul class="vector-menu-content-list">
				
				<li class="interlanguage-link interwiki-es mw-list-item"><a href="../../es/Dm-crypt/Specialties.html" title="Dm-crypt (Español)/Specialties – español" lang="es" hreflang="es" class="interlanguage-link-target"><span>Español</span></a></li>
<li class="interlanguage-link interwiki-ja mw-list-item"><a href="https://wiki.archlinux.jp/index.php/Dm-crypt/%E7%89%B9%E8%A8%98%E4%BA%8B%E9%A0%85" title="Dm-crypt/特記事項 – 日本語" lang="ja" hreflang="ja" class="interlanguage-link-target"><span>日本語</span></a></li>
<li class="interlanguage-link interwiki-pl mw-list-item"><a href="../../pl/Dm-crypt/Specialties.html" title="Dm-crypt (Polski)/Specialties – polski" lang="pl" hreflang="pl" class="interlanguage-link-target"><span>Polski</span></a></li>
			</ul>
			
		</div>

	</div>
</div>
</header>
				<div class="vector-column-end">
					<div class="vector-sticky-pinned-container">
						<nav class="vector-page-tools-landmark" aria-label="Page tools">
							<div id="vector-page-tools-pinned-container" class="vector-pinned-container">
				
							</div>
		</nav>
						<nav class="vector-client-prefs-landmark" aria-label="Appearance">
						</nav>
					</div>
				</div>
				<div id="bodyContent" class="vector-body" aria-labelledby="firstHeading" data-mw-ve-target-container>
					<div class="vector-body-before-content">
							<div class="mw-indicators">
		</div>

						<div id="siteSub" class="noprint">From ArchWiki</div>
					</div>
					<div id="contentSub"><div id="mw-content-subtitle"><div class="subpages">&lt; <a href="../../en/Dm-crypt.html" title="Dm-crypt">Dm-crypt</a>
</div></div></div>
					
					
					<div id="mw-content-text" class="mw-body-content">
<div class="mw-content-ltr mw-parser-output" lang="en" dir="ltr">
<p><span>
</span>
</p>
<meta property="mw:PageProp/toc">
<h2><span class="mw-headline" id="Securing_the_unencrypted_boot_partition">Securing the unencrypted boot partition</span></h2>
<p>The <code>/boot</code> partition and the <a href="../../en/Partitioning.html#Master_Boot_Record" class="mw-redirect" title="Master Boot Record">Master Boot Record</a> are the two areas of the disk that are not encrypted, even in an <a href="../../en/Dm-crypt/Encrypting_an_entire_system.html" title="Dm-crypt/Encrypting an entire system">encrypted root</a> configuration. They cannot usually be encrypted because the <a href="../../en/Arch_boot_process.html#Boot_loader" class="mw-redirect" title="Boot loader">boot loader</a> and BIOS (respectively) are unable to unlock a dm-crypt container in order to continue the boot process. An exception is <a href="../../en/GRUB.html" title="GRUB">GRUB</a>, which gained a feature to unlock a LUKS encrypted <code>/boot</code> - see <a href="../../en/Dm-crypt/Encrypting_an_entire_system.html#Encrypted_boot_partition_(GRUB)" title="Dm-crypt/Encrypting an entire system">dm-crypt/Encrypting an entire system#Encrypted boot partition (GRUB)</a>.
</p>
<p>This section describes steps that can be taken to make the boot process more secure.
</p>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> Note that securing the <code>/boot</code> partition and MBR can mitigate numerous attacks that occur during the boot process, but systems configured this way may still be vulnerable to BIOS/UEFI/firmware tampering, hardware keyloggers, cold boot attacks, and many other threats that are beyond the scope of this article. For an overview of system-trust issues and how these relate to full-disk encryption, refer to <a rel="nofollow" class="external autonumber" href="https://www.youtube.com/watch?v=pKeiKYA03eE">[1]</a>.</div>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> When using <a href="../../en/Unified_Extensible_Firmware_Interface.html" class="mw-redirect" title="UEFI">UEFI</a>, only an <a href="../../en/EFI_system_partition.html" class="mw-redirect" title="ESP">ESP</a> needs to remain unencrypted, if using <a href="../../en/Unified_kernel_image.html" title="Unified kernel image">Unified kernel images</a> for example. You can then use <a href="../../en/Unified_Extensible_Firmware_Interface/Secure_Boot.html" class="mw-redirect" title="Secure Boot">Secure Boot</a> to make sure the boot chain has not been tampered with, which is an easy way to achieve the same result as the below methods. See <a href="../../en/Dm-crypt/Encrypting_an_entire_system.html#LUKS_on_a_partition_with_TPM2_and_Secure_Boot" title="Dm-crypt/Encrypting an entire system">dm-crypt/Encrypting an entire system#LUKS on a partition with TPM2 and Secure Boot</a>.</div>
<h3><span class="mw-headline" id="Booting_from_a_removable_device">Booting from a removable device</span></h3>
<p>Using a separate device to boot a system is a fairly straightforward procedure, and offers a significant security improvement against some kinds of attacks. Two vulnerable parts of a system employing an <a href="../../en/Dm-crypt/Encrypting_an_entire_system.html" title="Dm-crypt/Encrypting an entire system">encrypted root filesystem</a> are
</p>
<ul>
<li>the <a href="../../en/Partitioning.html#Master_Boot_Record" class="mw-redirect" title="Master Boot Record">Master Boot Record</a>, and</li>
<li>the <code>/boot</code> partition.</li>
</ul>
<p>These must be stored unencrypted in order for the system to boot. In order to protect these from tampering, it is advisable to store them on a removable medium, such as a USB drive, and boot from that drive instead of the hard disk. As long as you keep the drive with you at all times, you can be certain that those components have not been tampered with, making authentication far more secure when unlocking your system.
</p>
<p>It is assumed that you already have your system configured with a dedicated partition mounted at <code>/boot</code>. If you do not, please follow the steps in <a href="../../en/Dm-crypt/System_configuration.html#Kernel_parameters" title="Dm-crypt/System configuration">dm-crypt/System configuration#Kernel parameters</a>, substituting your hard disk for a removable drive.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> You must make sure your system supports booting from the chosen medium, be it a USB drive, an external hard drive, an SD card, or anything else.</div>
<p>Prepare the removable drive (<code>/dev/sdx</code>).
</p>
<pre># gdisk /dev/sdx #format if necessary. Alternatively, cgdisk, fdisk, cfdisk, gparted...
# mkfs.ext2 /dev/sdx1 #for BIOS systems
# mkfs.fat -F 32 /dev/sdx1 #for UEFI systems
# mount /dev/sdx1 /mnt
</pre>
<p>Copy your existing <code>/boot</code> contents to the new one.
</p>
<pre># cp -ai /boot/* /mnt/
</pre>
<p>Mount the new partition. Do not forget to update your <a href="../../en/Fstab.html" title="Fstab">fstab</a> file accordingly.
</p>
<pre># umount /boot
# umount /mnt
# mount /dev/sdx1 /boot
# genfstab -p -U / &gt; /etc/fstab
</pre>
<p>Update <a href="../../en/GRUB.html" title="GRUB">GRUB</a>. <code>grub-mkconfig</code> should detect the new partition UUID automatically, but custom menu entries may need to be updated manually.
</p>
<pre># grub-mkconfig -o /boot/grub/grub.cfg
# grub-install /dev/sdx #install to the removable device, not the hard disk. for BIOS systems
# grub-install --target=x86_64-efi --efi-directory=/boot --bootloader-id=grub #for UEFI systems
</pre>
<p>Reboot and test the new configuration. Remember to set your device boot order accordingly in your BIOS or <a href="../../en/Unified_Extensible_Firmware_Interface.html" class="mw-redirect" title="UEFI">UEFI</a>. If the system fails to boot, you should still be able to boot from the hard drive in order to correct the problem.
</p>
<h3><span class="mw-headline" id="chkboot">chkboot</span></h3>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> chkboot makes a <code>/boot</code> partition <b>tamper-evident</b>, not <b>tamper-proof</b>. By the time the chkboot script is run, you have already typed your password into a potentially compromised boot loader, kernel, or initrd. If your system fails the chkboot integrity test, no assumptions can be made about the security of your data.</div>
<p>Referring to an article from the ct-magazine (Issue 3/12, page 146, 01.16.2012, <a rel="nofollow" class="external autonumber" href="https://www.heise.de/ct/inhalt/2012/03/6/">[2]</a>) the following script checks files under <code>/boot</code> for changes of SHA-1 hash, inode, and occupied blocks on the hard drive. It also checks the <a href="../../en/Partitioning.html#Master_Boot_Record" class="mw-redirect" title="Master Boot Record">Master Boot Record</a>. The script cannot prevent certain type of attacks, but a lot are made harder. No configuration of the script itself is stored in unencrypted <code>/boot</code>. With a locked/powered-off encrypted system, this makes it harder for some attackers because it is not apparent that an automatic checksum comparison of the partition is done upon boot. However, an attacker who anticipates these precautions can manipulate the firmware to run their own code on top of your kernel and intercept file system access, e.g. to <code>boot</code>, and present the untampered files. Generally, no security measures below the level of the firmware are able to guarantee trust and tamper evidence.
</p>
<p>The script with installation instructions is <a rel="nofollow" class="external text" href="https://ftp.heise.de/pub/ct/listings/1203-146.zip">available</a> (Author: Juergen Schmidt, ju at heisec.de; License: GPLv2). There is also package <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/chkboot/">chkboot</a></span><sup><small>AUR</small></sup> to <a href="../../en/Help:Reading.html#Installation_of_packages" class="mw-redirect" title="Install">install</a>.
</p>
<p>After installing, <a href="../../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Enable">enable</a> <code>chkboot.service</code>.
</p>
<p>As <code>/usr/local/bin/chkboot_user.sh</code> needs to be executed right after login, you need to add it to the <a href="../../en/Autostarting.html" class="mw-redirect" title="Autostart">autostart</a> (e.g. under KDE -&gt; <i>System Settings -&gt; Startup and Shutdown -&gt; Autostart</i>; GNOME 3: <i>gnome-session-properties</i>).
</p>
<p>With Arch Linux, changes to <code>/boot</code> are pretty frequent, for example by new kernels rolling-in. Therefore it may be helpful to use the scripts with every full system update. One way to do so:
</p>
<pre>#!/bin/sh
#
# Note: Insert your <i>&lt;user&gt;</i> and execute it with sudo for pacman &amp; chkboot to work automagically
#
echo "Pacman update [1] Quickcheck before updating" &amp;
sudo -u <i>&lt;user&gt;</i> /usr/local/bin/chkboot_user.sh
/usr/local/bin/chkboot.sh
sudo -u <i>&lt;user&gt;</i> /usr/local/bin/chkboot_user.sh
echo "Pacman update [2] Syncing repos for pacman"
pacman -Syu
/usr/local/bin/chkboot.sh
sudo -u <i>&lt;user&gt;</i> /usr/local/bin/chkboot_user.sh
echo "Pacman update [3] All done, let us roll on ..."
</pre>
<h3><span class="mw-headline" id="mkinitcpio-chkcryptoboot">mkinitcpio-chkcryptoboot</span></h3>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> This hook does <b>not</b> encrypt <a href="../../en/GRUB.html" title="GRUB">GRUB</a>'s core (MBR) code or EFI stub, nor does it protect against situations where an attacker is able to modify the behaviour of the boot loader to compromise the kernel and/or initramfs at run-time.</div>
<p><span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/mkinitcpio-chkcryptoboot/">mkinitcpio-chkcryptoboot</a></span><sup><small>AUR</small></sup> is a <a href="../../en/Mkinitcpio.html" title="Mkinitcpio">mkinitcpio</a> hook that performs integrity checks during early-userspace and advises the user not to enter their root partition password if the system appears to have been compromised. Security is achieved through an <a href="../../en/Dm-crypt/Encrypting_an_entire_system.html#Encrypted_boot_partition_(GRUB)" title="Dm-crypt/Encrypting an entire system">encrypted boot partition</a>, which is unlocked using <a href="../../en/GRUB.html#Encrypted_/boot" title="GRUB">GRUB</a>'s <code>cryptodisk.mod</code> module, and a root filesystem partition, which is encrypted with a password different from the former. This way, the <a href="../../en/Arch_boot_process.html#initramfs" class="mw-redirect" title="Initramfs">initramfs</a> and <a href="../../en/Kernel.html" title="Kernel">kernel</a> are secured against offline tampering, and the root partition can remain secure even if the <code>/boot</code> partition password is entered on a compromised machine (provided that the chkcryptoboot hook detects the compromise, and is not itself compromised at run-time).
</p>
<p>This hook requires <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=grub">grub</a></span> release &gt;=2.00 to function, and a dedicated, LUKS encrypted <code>/boot</code> partition with its own password in order to be secure.
</p>
<h4><span class="mw-headline" id="Installation">Installation</span></h4>
<p><a href="../../en/Help:Reading.html#Installation_of_packages" class="mw-redirect" title="Install">Install</a> <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/mkinitcpio-chkcryptoboot/">mkinitcpio-chkcryptoboot</a></span><sup><small>AUR</small></sup> and edit <code>/etc/default/chkcryptoboot.conf</code>. If you want the ability of detecting if your boot partition was bypassed, edit the <code>CMDLINE_NAME</code> and <code>CMDLINE_VALUE</code> variables, with values known only to you. You can follow the advice of using two hashes as is suggested right after the installation. Also, be sure to make the appropriate changes to the <a href="../../en/Kernel_parameters.html" class="mw-redirect" title="Kernel command line">kernel command line</a> in <code>/etc/default/grub</code>. Edit the <code>HOOKS=</code> line in <code>/etc/mkinitcpio.conf</code>, and insert the <code>chkcryptoboot</code> hook <b>before</b> <code>encrypt</code>. When finished, <a href="../../en/Mkinitcpio.html#Image_creation_and_activation" class="mw-redirect" title="Regenerate the initramfs">regenerate the initramfs</a>.
</p>
<h4><span class="mw-headline" id="Technical_overview">Technical overview</span></h4>
<p><span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/mkinitcpio-chkcryptoboot/">mkinitcpio-chkcryptoboot</a></span><sup><small>AUR</small></sup> consists of an install hook and a run-time hook for mkinitcpio. The install hook runs every time the initramfs is rebuilt, and hashes the GRUB <a href="../../en/Unified_Extensible_Firmware_Interface.html" class="mw-redirect" title="EFI">EFI</a> stub (<code>$esp/EFI/grub_uefi/grubx64.efi</code>) (in the case of <a href="../../en/Unified_Extensible_Firmware_Interface.html" class="mw-redirect" title="UEFI">UEFI</a> systems) or the first 446 bytes of the disk on which GRUB is installed (in the case of BIOS systems), and stores that hash inside the initramfs located inside the encrypted <code>/boot</code> partition. When the system is booted, GRUB prompts for the <code>/boot</code> password, then the run-time hook performs the same hashing operation and compares the resulting hashes before prompting for the root partition password. If they do not match, the hook will print an error like this:
</p>
<pre>CHKCRYPTOBOOT ALERT!
CHANGES HAVE BEEN DETECTED IN YOUR BOOT LOADER EFISTUB!
YOU ARE STRONGLY ADVISED NOT TO ENTER YOUR ROOT CONTAINER PASSWORD!
Please type uppercase yes to continue:
</pre>
<p>In addition to hashing the boot loader, the hook also checks the parameters of the running kernel against those configured in <code>/etc/default/chkcryptoboot.conf</code>. This is checked both at run-time and after the boot process is done. This allows the hook to detect if GRUB's configuration was not bypassed at run-time and afterwards to detect if the entire <code>/boot</code> partition was not bypassed.
</p>
<p>For BIOS systems the hook creates a hash of GRUB's first stage boot loader (installed to the first 446 bytes of the bootdevice) to compare at the later boot processes. The main second-stage GRUB boot loader <code>core.img</code> is not checked.
</p>
<h3><span class="mw-headline" id="AIDE">AIDE</span></h3>
<p>Alternatively to above scripts, a hash check can be set up with <a href="../../en/AIDE.html" title="AIDE">AIDE</a> which can be customized via a very flexible configuration file.
</p>
<h3><span class="mw-headline" id="STARK">STARK</span></h3>
<p>While one of these methods should serve the purpose for most users, they do not address all security problems associated with the unencrypted <code>/boot</code>. One approach which endeavours to provide a fully authenticated boot chain was published with POTTS as an academic thesis to implement the <a rel="nofollow" class="external text" href="https://www1.informatik.uni-erlangen.de/stark">STARK</a> authentication framework.
</p>
<p>The POTTS proof-of-concept uses Arch Linux as a base distribution and implements a system boot chain with:
</p>
<ul>
<li>POTTS - a boot menu for a one-time authentication message prompt</li>
<li>TrustedGrub - a <a href="../../en/GRUB_Legacy.html" title="GRUB Legacy">GRUB Legacy</a> implementation which authenticates the kernel and initramfs against <a href="../../en/Trusted_Platform_Module.html" title="Trusted Platform Module">TPM chip</a> PCR registers</li>
<li>TRESOR - a kernel patch which implements AES but keeps the master-key not in RAM but in CPU registers during runtime.</li>
</ul>
<p>As part of the thesis <a rel="nofollow" class="external text" href="https://13.tc/p/potts/manual.html">installation</a> instructions based on Arch Linux (ISO as of 2013-01) have been published. If you want to try it, be aware these tools are not in standard repositories and the solution will be time consuming to maintain.
</p>
<h2>
<span id="Using_GPG.2C_LUKS.2C_or_OpenSSL_encrypted_keyfiles"></span><span class="mw-headline" id="Using_GPG,_LUKS,_or_OpenSSL_encrypted_keyfiles">Using GPG, LUKS, or OpenSSL encrypted keyfiles</span>
</h2>
<p>The following forum posts give instructions to use two factor authentication, gpg or openssl encrypted keyfiles, instead of a plaintext keyfile described earlier in this wiki article <a rel="nofollow" class="external text" href="https://bbs.archlinux.org/viewtopic.php?id=120243">System Encryption using LUKS with GPG encrypted keys</a>:
</p>
<ul>
<li>GnuPG: <a rel="nofollow" class="external text" href="https://bbs.archlinux.org/viewtopic.php?pid=943338#p943338">Post regarding GPG encrypted keys</a> This post has the generic instructions.</li>
<li>OpenSSL: <a rel="nofollow" class="external text" href="https://bbs.archlinux.org/viewtopic.php?pid=947805#p947805">Post regarding OpenSSL encrypted keys</a> This post only has the <code>ssldec</code> hooks.</li>
<li>OpenSSL: <a rel="nofollow" class="external text" href="https://bbs.archlinux.org/viewtopic.php?id=155393">Post regarding OpenSSL salted bf-cbc encrypted keys</a> This post has the <code>bfkf</code> initcpio hooks, install, and encrypted keyfile generator scripts.</li>
<li>LUKS: <a rel="nofollow" class="external text" href="https://bbs.archlinux.org/viewtopic.php?pid=1502651#p1502651">Post regarding LUKS encrypted keys</a> with a <code>lukskey</code> initcpio hook. Or <a href="#Encrypted_/boot_and_a_detached_LUKS_header_on_USB">#Encrypted /boot and a detached LUKS header on USB</a> below with a custom encrypt hook for initcpio.</li>
</ul>
<p>Note that:
</p>
<ul>
<li>You can follow the above instructions with only two primary partitions, one boot partition (required because of encryption) and one primary LVM partition. Within the LVM partition you can have as many partitions as you need, but most importantly it should contain at least root, swap, and home logical volume partitions. This has the added benefit of having only one keyfile for all your partitions, and having the ability to hibernate your computer (suspend to disk) where the swap partition is encrypted. If you decide to do so your hooks in <code>/etc/mkinitcpio.conf</code> should look like this:<pre>HOOKS=( ... usb usbinput (etwo or ssldec) encrypt (if using openssl) lvm2 resume ... )</pre> and you should add <pre>resume=/dev/&lt;VolumeGroupName&gt;/&lt;LVNameOfSwap&gt;</pre> to your <a href="../../en/Kernel_parameters.html" title="Kernel parameters">kernel parameters</a>.</li>
<li>If you need to temporarily store the unencrypted keyfile somewhere, do not store them on an unencrypted disk. Even better make sure to store them to RAM such as <code>/dev/shm</code>.</li>
<li>If you want to use a GPG encrypted keyfile, you need to use a statically compiled GnuPG version 1.4 or you could edit the hooks and use <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/gnupg1/">gnupg1</a></span><sup><small>AUR</small></sup>
</li>
<li>It is possible that an update to OpenSSL could break the custom <code>ssldec</code> mentioned in the second forum post.</li>
</ul>
<h2>
<span id="Remote_unlocking_of_root_.28or_other.29_partition"></span><span class="mw-headline" id="Remote_unlocking_of_root_(or_other)_partition">Remote unlocking of root (or other) partition</span>
</h2>
<p>Imagine a system with one or more LUKS encrypted partitions (root or others) or volumes and you need to unlock these partitions/volumes during startup. In this case you need to be able to log in from remote and provide a password during an early boot phase. This can be achieved by using one or more <a href="../../en/Mkinitcpio.html" title="Mkinitcpio">mkinitcpio</a> hook(s) that configure a network interface and start some kind of SSH server. Some packages listed below contribute various <a href="../../en/Mkinitcpio.html#Build_hooks" title="Mkinitcpio">mkinitcpio build hooks</a> to ease the configuration.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> 
<ul>
<li>Keep in mind to use kernel device names for the network interface (e.g. <code>eth0</code>) and not <a href="../../en/Udev.html" title="Udev">udev's</a> ones (e.g. <code>enp1s0</code>), as those will not work.</li>
<li>By default, Predictable Network Interface Names are activated and change the kernel device name during late boot. Use <a href="../../en/Core_utilities.html#Essentials" class="mw-redirect" title="Dmesg">dmesg</a> and look what your Network kernel module does to find the original name (e.g. <code>eth0</code>)</li>
<li>It could be necessary to add the module for your <a href="../../en/Network_configuration/Ethernet.html#Device_driver" title="Network configuration/Ethernet">ethernet</a> or <a href="../../en/Network_configuration/Wireless.html#Device_driver" title="Network configuration/Wireless">wireless</a> network card to the <a href="../../en/Mkinitcpio.html#MODULES" title="Mkinitcpio">MODULES</a> array.</li>
</ul>
</div>
<h3>
<span id="Busybox_based_initramfs_.28built_with_mkinitcpio.29"></span><span class="mw-headline" id="Busybox_based_initramfs_(built_with_mkinitcpio)">Busybox based initramfs (built with mkinitcpio)</span>
</h3>
<p>For busybox based initramfs the packages <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=mkinitcpio-netconf">mkinitcpio-netconf</a></span> and/or <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/mkinitcpio-ppp/">mkinitcpio-ppp</a></span><sup><small>AUR</small></sup> provide network connectivity. As <a href="../../en/Secure_Shell.html" class="mw-redirect" title="SSH">SSH</a> server you have the option of using either <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=mkinitcpio-dropbear">mkinitcpio-dropbear</a></span> or <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=mkinitcpio-tinyssh">mkinitcpio-tinyssh</a></span>. Those hooks do not install any shell, so you also need to <a href="../../en/Help:Reading.html#Installation_of_packages" class="mw-redirect" title="Install">install</a> the <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=mkinitcpio-utils">mkinitcpio-utils</a></span> package. The instructions below can be used in any combination of the packages above. When there are different paths, it will be noted.
</p>
<ol>
<li>If you do not have an SSH key pair yet, <a href="../../en/SSH_keys.html#Generating_an_SSH_key_pair" title="SSH keys">generate one</a> on the client system (the one which will be used to unlock the remote machine). <div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong>
<ul>
<li>
<code>tinyssh</code> only supports <a href="../../en/SSH_keys.html#Ed25519" title="SSH keys">Ed25519</a> and <a href="../../en/SSH_keys.html#ECDSA" title="SSH keys">ECDSA</a> key types without passphrase. If you chose to use <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=mkinitcpio-tinyssh">mkinitcpio-tinyssh</a></span>, you need to create/use one of these.</li>
<li>
<code>mkinitcpio-tinyssh</code> currently has a bug affecting it's use of tinyssh-convert. See <a rel="nofollow" class="external text" href="https://github.com/grazzolini/mkinitcpio-tinyssh/issues/10">Github</a> for details and a fix.</li>
<li>
<code>mkinitcpio-dropbear</code> in version 0.0.3-5 is not compatible with the current dropbear implementation that removed dss. See <a rel="nofollow" class="external text" href="https://github.com/grazzolini/mkinitcpio-dropbear/issues/8">Github</a> for details and a fix.</li>
</ul>
</div>
</li>
<li class="mw-empty-elt">
<li>Insert your SSH public key (i.e. the one you usually put onto hosts so that you can ssh in without a password, or the one you just created and which ends with <i>.pub</i>) into the remote machine's <code>/etc/dropbear/root_key</code> or <code>/etc/tinyssh/root_key</code> file. <div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> This method can later be used to add other SSH public keys as needed; In the case of simply copying the content of the remote's <code>~/.ssh/authorized_keys</code>, be sure to verify that it only contains keys you intend to be using to unlock the remote machine. When adding additional keys, regenerate your initrd as well using <code>mkinitcpio</code>. See also <a href="../../en/OpenSSH.html#Protection" title="OpenSSH">OpenSSH#Protection</a>.</div>
</li>
<li>Add all three <code>&lt;netconf and/or ppp&gt; &lt;dropbear or tinyssh&gt; encryptssh</code> <a href="../../en/Mkinitcpio.html#HOOKS" title="Mkinitcpio">hooks</a> before <code>filesystems</code> within the "HOOKS" array in <code>/etc/mkinitcpio.conf</code> (the <code>encryptssh</code> replaces the <code>encrypt</code> hook). Then <a href="../../en/Mkinitcpio.html#Image_creation_and_activation" class="mw-redirect" title="Regenerate the initramfs">regenerate the initramfs</a>. <div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> The <code>net</code> hook provided by <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=mkinitcpio-nfs-utils">mkinitcpio-nfs-utils</a></span> is <b>not</b> needed.</div>
</li>
<li>Configure the required <code>cryptdevice=</code> <a href="../../en/Dm-crypt/System_configuration.html#Kernel_parameters" title="Dm-crypt/System configuration">parameter</a> and add the <code>ip=</code> <a href="../../en/Kernel_parameters.html" title="Kernel parameters">kernel command parameter</a> to your boot loader configuration with the appropriate arguments. For example, if you want the IP address to be assigned by DHCP, you can use the following parameter: <pre>ip=dhcp</pre> This is most useful if your DHCP server is configured to always assign the same IP for this host, as otherwise accessing the system via SSH is going to be difficult. In that case, you can use a static IP: <pre>ip=192.168.1.1:::::eth0:none</pre> Alternatively, you can also specify the subnet mask and gateway required by the network:<pre>ip=192.168.1.1::192.168.1.254:255.255.255.0::eth0:none</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> As of version 0.0.4 of <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=mkinitcpio-netconf">mkinitcpio-netconf</a></span>, you can nest multiple <code>ip=</code> parameters in order to configure multiple interfaces. You cannot mix it with <code>ip=dhcp</code> (<code>ip=:::::eth0:dhcp</code>) alone. An interface needs to be specified.<pre>ip=ip=192.168.1.1:::::eth0:none:ip=172.16.1.1:::::eth1:none</pre>
</div>If using DHCP, consider adding the <code>netconf_timeout=</code> kernel parameter, to prevent netconf from trying to obtain an IP forever. For a detailed description of the <code>ip=</code> parameter, have a look at the <a href="../../en/Mkinitcpio.html#Using_net" title="Mkinitcpio">according mkinitcpio section</a>. When finished, update the configuration of your <a href="../../en/Arch_boot_process.html#Boot_loader" class="mw-redirect" title="Boot loader">boot loader</a>.</li>
<li>Finally, restart the remote system and try to <a href="../../en/OpenSSH.html#Client_usage" title="OpenSSH">ssh to it</a>, <b>explicitly stating the "root" username</b> (even if the root account is disabled on the machine, this root user is used only in the initrd for the purpose of unlocking the remote system). If you are using the <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=mkinitcpio-dropbear">mkinitcpio-dropbear</a></span> package and you also have the <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=openssh">openssh</a></span> package installed, then you most probably will not get any warnings before logging in, because it convert and use the same host keys openssh uses (except Ed25519 keys, as dropbear does not support them). In case you are using <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=mkinitcpio-tinyssh">mkinitcpio-tinyssh</a></span>, a script <code>tinyssh-convert</code> is bundled, so you can use the same keys as your <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=openssh">openssh</a></span> installation (currently only Ed25519 keys). It may be required to manually copy the host key, via <code>tinyssh-convert</code>, to <code>/etc/tinyssh/sshkeydir</code>. In either case, you should have run <a href="../../en/OpenSSH.html#Daemon_management" title="OpenSSH">the ssh daemon</a> at least once, using the provided systemd units, so the keys can be generated first. After rebooting the machine, you should be prompted for the passphrase to unlock the root device. The system will complete its boot process and you can then ssh to it <a href="../../en/OpenSSH.html#Client_usage" title="OpenSSH">as you normally would</a> (with the remote user of your choice).</li>
</ol>
<h4><span class="mw-headline" id="Enabling_Wi-Fi">Enabling Wi-Fi</span></h4>
<p>The <code>netconf</code> hook is normally used with an Ethernet connection. In case you want to setup a computer with wireless only, and unlock it via Wi-Fi, you can use a predefined hook or create a custom hook to connect to a Wi-Fi network before the <code>netconf</code> hook is run.
</p>
<h5><span class="mw-headline" id="Predefined_hook">Predefined hook</span></h5>
<p>You can install a predefined hook based on the one in this wiki:
</p>
<ol>
<li>Install <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/mkinitcpio-wifi/">mkinitcpio-wifi</a></span><sup><small>AUR</small></sup>.</li>
<li>Configure your Wi-Fi connection by creating a <i>wpa_supplicant</i> configuration with your network properties: <pre>wpa_passphrase "ESSID" "passphrase" &gt; /etc/wpa_supplicant/initcpio.conf</pre>
</li>
<li>Add the <code>wifi</code> hook before <code>netconf</code> in your <code>/etc/mkinitcpio.conf</code>. Your Wi-Fi-related modules should be auto-detected, if not: add them to the <code>MODULES</code> section.</li>
<li>Add <code>ip=:::::wlan0:dhcp</code> to the <a href="../../en/Kernel_parameters.html" title="Kernel parameters">kernel parameters</a>.</li>
<li>
<a href="../../en/Mkinitcpio.html#Image_creation_and_activation" class="mw-redirect" title="Regenerate the initramfs">Regenerate the initramfs</a>.</li>
<li>Update the configuration of your <a href="../../en/Arch_boot_process.html#Boot_loader" class="mw-redirect" title="Boot loader">boot loader</a>.</li>
</ol>
<h5><span class="mw-headline" id="Custom_hook">Custom hook</span></h5>
<p>Below example shows a setup using a USB Wi-Fi adapter, connecting to a Wi-Fi network protected with WPA2-PSK. In case you use for example WEP or another initramfs generator, you might need to adjust accordingly.
</p>
<ol>
<li>Modify <code>/etc/mkinitcpio.conf</code>:
<ul>
<li>Add the needed kernel module for your specific Wi-Fi adapter.</li>
<li>Include the <code>wpa_passphrase</code> and <code>wpa_supplicant</code> binaries.</li>
<li>Add a hook <code>wifi</code> (or a name of your choice, this is the custom hook that will be created) before the <code>net</code> hook.<pre>MODULES=(<i>module</i>)<br>BINARIES=(wpa_passphrase wpa_supplicant)<br>HOOKS=(base udev autodetect ... <b>wifi</b> net ... dropbear encryptssh ...)</pre>
</li>
</ul>
</li>
<li>Create the <code>wifi</code> hook in <code>/etc/initcpio/hooks/wifi</code>:<pre>run_hook ()<br>{<br>	# Sleep a couple of seconds so wlan0 is setup by kernel<br>	sleep 5<br><br>	# Set wlan0 to up<br>	ip link set wlan0 up<br><br>	# Associate with Wi-Fi network<br>	# 1. Save temp config file<br>	wpa_passphrase "<i>network ESSID</i>" "<i>pass phrase</i>" &gt; /tmp/wifi<br><br>	# 2. Associate<br>	wpa_supplicant -B -D nl80211,wext -i wlan0 -c /tmp/wifi<br><br>	# Sleep a couple of seconds so that wpa_supplicant finishes connecting<br>	sleep 5<br><br>	# wlan0 should now be connected and ready to be assigned an ip by the net hook<br>}<br><br>run_cleanuphook ()<br>{<br>	# Kill wpa_supplicant running in the background<br>	killall wpa_supplicant<br><br>	# Set wlan0 link down<br>	ip link set wlan0 down<br><br>	# wlan0 should now be fully disconnected from the Wi-Fi network<br>}</pre>
</li>
<li>Create the hook installation file in <code>/etc/initcpio/install/wifi</code>:<pre>build ()<br>{<br>	add_runscript<br>}<br>help ()<br>{<br>cat&lt;&lt;HELPEOF<br>	Enables Wi-Fi on boot, for dropbear ssh unlocking of disk.<br>HELPEOF<br>}</pre>
</li>
<li>Add <code>ip=:::::wlan0:dhcp</code> to the <a href="../../en/Kernel_parameters.html" title="Kernel parameters">kernel parameters</a>. Remove <code>ip=:::::eth0:dhcp</code> so it does not conflict.</li>
<li>Optionally create an additional boot entry with kernel parameter <code>ip=:::::eth0:dhcp</code>.</li>
<li>
<a href="../../en/Mkinitcpio.html#Image_creation_and_activation" class="mw-redirect" title="Regenerate the initramfs">Regenerate the initramfs</a>.</li>
<li>Update the configuration of your <a href="../../en/Arch_boot_process.html#Boot_loader" class="mw-redirect" title="Boot loader">boot loader</a>.</li>
</ol>
<p>Remember to setup <a href="../../en/Network_configuration/Wireless.html" class="mw-redirect" title="Wi-Fi">Wi-Fi</a>, so you are able to login once the system is fully booted. In case you are unable to connect to the Wi-Fi network, try increasing the sleep times a bit.
</p>
<h3>
<span id="systemd_based_initramfs_.28built_with_mkinitcpio.29"></span><span class="mw-headline" id="systemd_based_initramfs_(built_with_mkinitcpio)">systemd based initramfs (built with mkinitcpio)</span>
</h3>
<p>For systemd based initramfs the AUR package <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/mkinitcpio-systemd-extras/">mkinitcpio-systemd-extras</a></span><sup><small>AUR</small></sup> provides a collection of build hooks (aka install hooks) to achieve network connectivity and SSH login during early boot. Depending on the concrete setup this either gives you access to the initramfs environment via busybox' dash or just a password prompt.
</p>
<p>A minimal setup:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/mkinitcpio.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">HOOKS=(base systemd autodetect microcode modconf kms keyboard sd-vconsole <b>sd-network</b> block <b>sd-tinyssh</b> sd-encrypt filesystems fsck)
<b>SD_TINYSSH_COMMAND="systemd-tty-ask-password-agent --query --watch"</b></pre>
<p>When building the initramfs with <code>mkinitcpio</code> this setup copies the already existing configuration of <a href="../../en/Systemd-networkd.html" title="Systemd-networkd">systemd-networkd</a> from the main system and also tries to copy / convert existing SSH server keys from an existing TinySSH or OpenSSH installation. <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=tinyssh">tinyssh</a></span> needs to be installed (but not necessarily enabled) on the main system. There are additional configuration parameters in case <a href="../../en/Systemd-networkd.html" title="Systemd-networkd">systemd-networkd</a> is not used by the main system. See the <a rel="nofollow" class="external text" href="https://github.com/wolegis/mkinitcpio-systemd-extras/wiki">documentation</a> of <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/mkinitcpio-systemd-extras/">mkinitcpio-systemd-extras</a></span><sup><small>AUR</small></sup> for further details.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> This section used to mention <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=mkinitcpio-systemd-tool">mkinitcpio-systemd-tool</a></span> as another alternative to achieve remote login and LUKS unlocking during early startup. The approach is completely different as it requires only one additional hook <code>systemd-tool</code> and all further setup is done in special <code>[X-SystemdTool]</code> sections in systemd service files. Unfortunately, documentation about this approach and how to use the tool itself is very limited.</div>
<h3>
<span id="systemd_based_initramfs_.28built_with_dracut.29"></span><span class="mw-headline" id="systemd_based_initramfs_(built_with_dracut)">systemd based initramfs (built with dracut)</span>
</h3>
<p>If you are using <a href="../../en/Dracut.html" title="Dracut">dracut</a> instead of <a href="../../en/Mkinitcpio.html" title="Mkinitcpio">mkinitcpio</a>, you might want to check out <a rel="nofollow" class="external text" href="https://github.com/gsauthof/dracut-sshd">dracut-sshd</a> as an alternative to the above options.
</p>
<h2><span class="mw-headline" id="One-time_password-less_reboot">One-time password-less reboot</span></h2>
<p>Another method that can be used to reboot a remote, headless or otherwise inaccessible system whilst not needing to be at the terminal to type the encrypted root drive password, is to use a temporary <a href="../../en/Dm-crypt/System_configuration.html#Unlocking_with_a_keyfile" title="Dm-crypt/System configuration">keyfile</a>. This will need to be placed in a location that is accessible to the kernel at boot, the <a href="../../en/Dm-crypt/System_configuration.html#cryptkey" title="Dm-crypt/System configuration">cryptkey</a> boot parameter will be needed, and that particular keyfile will need to be registered as a valid key by way of the "cryptsetup luksAddKey" command.
</p>
<p>This can be done conveniently with the help of <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/passless-boot/">passless-boot</a></span><sup><small>AUR</small></sup>. The procedure described to setup that tool on <a rel="nofollow" class="external text" href="https://gitlab.com/Marcool04/passless-boot">the script's readme file</a> might serve as a template for setting up a home-made solution also. Do take a look at the discussion in the <a rel="nofollow" class="external text" href="https://gitlab.com/Marcool04/passless-boot#security-considerations-and-threat-model">Security considerations</a> section.
</p>
<h2>
<span id="Discard.2FTRIM_support_for_solid_state_drives_.28SSD.29"></span><span class="mw-headline" id="Discard/TRIM_support_for_solid_state_drives_(SSD)">Discard/TRIM support for solid state drives (SSD)</span>
</h2>
<p><a href="../../en/Solid_state_drive.html" title="Solid state drive">Solid state drive</a> users should be aware that, by default, TRIM commands are not enabled by the device-mapper, i.e. block-devices are mounted without the <code>discard</code> option unless you override the default.
</p>
<p>The device-mapper maintainers have made it clear that TRIM support will never be enabled by default on dm-crypt devices because of the potential security implications.<a rel="nofollow" class="external autonumber" href="http://www.saout.de/pipermail/dm-crypt/2011-September/002019.html">[3]</a><a rel="nofollow" class="external autonumber" href="http://www.saout.de/pipermail/dm-crypt/2012-April/002420.html">[4]</a> Minimal data leakage in the form of freed block information, perhaps sufficient to determine the filesystem in use, may occur on devices with TRIM enabled. An illustration and discussion of the issues arising from activating TRIM is available in the <a rel="nofollow" class="external text" href="https://asalor.blogspot.de/2011/08/trim-dm-crypt-problems.html">blog</a> of a <i>cryptsetup</i> developer. If you are worried about such factors, keep also in mind that threats may add up: for example, if your device is still encrypted with the previous (cryptsetup &lt;1.6.0) default cipher <code>--cipher aes-cbc-essiv</code>, more information leakage may occur from trimmed sector observation than with the current <a href="../../en/Dm-crypt/Device_encryption.html#Encryption_options_for_LUKS_mode" title="Dm-crypt/Device encryption">default</a>.
</p>
<p>The following cases can be distinguished:
</p>
<ul><li>The device is encrypted with default dm-crypt LUKS mode:
<ul>
<li>By default the LUKS header is stored at the beginning of the device and using TRIM is useful to protect header modifications. If for example a compromised LUKS password is revoked, without TRIM the old header will in general still be available for reading until overwritten by another operation; if the drive is stolen in the meanwhile, the attackers could in theory find a way to locate the old header and use it to decrypt the content with the compromised password. See <a rel="nofollow" class="external text" href="https://gitlab.com/cryptsetup/cryptsetup/wikis/FrequentlyAskedQuestions#5-security-aspects">cryptsetup FAQ, section 5.19 What about SSDs, Flash and Hybrid Drives?</a> and <a rel="nofollow" class="external text" href="https://www.reddit.com/r/archlinux/comments/2f370s/full_disk_encryption_on_an_ssd/ck5p5c5">Full disk encryption on an ssd</a>.</li>
<li>TRIM can be left disabled if the security issues stated at the top of this section are considered a worse threat than the above bullet.</li>
</ul>
</li></ul>
<dl><dd>See also <a href="../../en/Securely_wipe_disk.html#Flash_memory" title="Securely wipe disk">Securely wipe disk#Flash memory</a>.</dd></dl>
<ul><li>The device is encrypted with dm-crypt plain mode, or the LUKS header is stored <a href="#Encrypted_system_using_a_detached_LUKS_header">separately</a>:
<ul>
<li>If plausible deniability is required, TRIM should <b>never</b> be used because of the considerations at the top of this section, or the use of encryption will be given away.</li>
<li>If plausible deniability is not required, TRIM can be used for its performance gains, provided that the security dangers described at the top of this section are not of concern.</li>
</ul>
</li></ul>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> Before enabling TRIM on a drive, make sure the device fully supports TRIM commands, or data loss can occur. See <a href="../../en/Solid_state_drive.html#TRIM" class="mw-redirect" title="Solid State Drives">Solid State Drives#TRIM</a>.</div>
<p>Besides enabling discard support in dm-crypt, it is also required to periodically run <span class="plainlinks archwiki-template-man" title="$ man 8 fstrim"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/fstrim.8">fstrim(8)</a></span> or mount the filesystem (e.g. <code>/dev/mapper/root</code> in this example) with the <code>discard</code> option in <code>/etc/fstab</code>. For details, please refer to the <a href="../../en/Solid_state_drive.html#TRIM" class="mw-redirect" title="TRIM">TRIM</a> page.
</p>
<h3><span class="mw-headline" id="LUKS2">LUKS2</span></h3>
<p>For a LUKS2 device, TRIM support can be enabled by using the <code>--allow-discards --persistent</code> options when opening it. The <code>allow-discards</code> flag will be written into the LUKS2 header and the option will be automatically used whenever the LUKS2 device is opened.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> 
<ul>
<li>Setting new persistent flags via <code>cryptsetup --persistent</code> replaces old flags with new ones instead of adding a new flag to the already set flags. This means if you want to enable other flags too, you have to set them all at once.</li>
<li>When using OPAL encryption without dm-crypt (<span class="plainlinks archwiki-template-man" title="$ man 8 cryptsetup-luksFormat"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/cryptsetup-luksFormat.8">cryptsetup-luksFormat(8)</a></span> option <code>--hw-opal-only</code>), discard support does not need to be explicitly enabled since there is no dm-crypt layer between the file system and the disk.</li>
</ul>
</div>
<pre># cryptsetup --allow-discards --persistent open /dev/sdaX root
</pre>
<p>If the device is already opened, the <code>open</code> action will raise an error, in which case, use the <span class="plainlinks archwiki-template-man" title="$ man 8 cryptsetup-refresh"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/cryptsetup-refresh.8">cryptsetup-refresh(8)</a></span> command instead:
</p>
<pre># cryptsetup --allow-discards --persistent refresh root
</pre>
<p>You can confirm the flag is persistently set in the LUKS2 header by looking at the <code>cryptsetup luksDump</code> output:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># cryptsetup luksDump /dev/sdaX | grep Flags</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">Flags:          allow-discards
</pre>
<h3><span class="mw-headline" id="LUKS1_and_plain_dm-crypt">LUKS1 and plain dm-crypt</span></h3>
<p>For LUKS1 and plain dm-crypt, TRIM support needs to be explicitly enabled when opening the device.
</p>
<p>To enable TRIM support during boot, set the following <a href="../../en/Kernel_parameters.html" title="Kernel parameters">kernel parameters</a>.
</p>
<p>If using the <a href="../../en/Dm-crypt/System_configuration.html#Using_encrypt_hook" title="Dm-crypt/System configuration">encrypt</a> hook:
</p>
<pre>cryptdevice=/dev/sdaX:root:allow-discards
</pre>
<p>If using the <a href="../../en/Dm-crypt/System_configuration.html#Using_systemd-cryptsetup-generator" class="mw-redirect" title="Sd-encrypt">sd-encrypt</a> hook with systemd-based initramfs:
</p>
<pre>rd.luks.options=discard
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> The <code>rd.luks.options=discard</code> kernel option does not have any effect on devices included in the initramfs image's <code>/etc/crypttab</code> file (<code>/etc/crypttab.initramfs</code> on real root). You must specify option <code>discard</code> in <code>/etc/crypttab.initramfs</code>.</div>
<p>For devices unlocked via <code>/etc/crypttab</code> use option <code>discard</code>, e.g.:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/crypttab</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">luks-123abcdef-etc UUID=123abcdef-etc none discard</pre>
<p>When manually unlocking devices on the console use <code>--allow-discards</code>.
</p>
<p>For example, you can open a device with the <code>--allow-discards</code> option to execute a manual <i>fstrim</i> command:
</p>
<pre># cryptsetup --allow-discards open /dev/sdaX root
</pre>
<p>In any case, you can verify whether the device actually was opened with discards by inspecting the <code>dmsetup table</code> output:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># dmsetup table</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">luks-123abcdef-etc: 0 1234567 crypt aes-xts-plain64 000etc000 0 8:2 4096 1 allow_discards
</pre>
<h2>
<span id="Disable_workqueue_for_increased_solid_state_drive_.28SSD.29_performance"></span><span class="mw-headline" id="Disable_workqueue_for_increased_solid_state_drive_(SSD)_performance">Disable workqueue for increased solid state drive (SSD) performance</span>
</h2>
<p><a href="../../en/Solid_state_drive.html" title="Solid state drive">Solid state drive</a> users should be aware that, by default, discarding internal read and write workqueue commands are not enabled by the device-mapper, i.e. block-devices are mounted without the <code>no_read_workqueue</code> and <code>no_write_workqueue</code> option unless you override the default.
</p>
<p>The <code>no_read_workqueue</code> and <code>no_write_workqueue</code> flags were introduced by internal Cloudflare research <a rel="nofollow" class="external text" href="https://blog.cloudflare.com/speeding-up-linux-disk-encryption/">Speeding up Linux disk encryption</a> made while investigating overall encryption performance. One of the conclusions is that internal dm-crypt read and write queues decrease performance for SSD drives. While queuing disk operations makes sense for spinning drives, bypassing the queue and writing data synchronously doubled the throughput and cut the SSD drives' IO await operations latency in half. The patches were upstreamed and are available since <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=linux">linux</a></span> 5.9 and up <a rel="nofollow" class="external autonumber" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/drivers/md/dm-crypt.c?id=39d42fa96ba1b7d2544db3f8ed5da8fb0d5cb877">[5]</a>.
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=linux-zen">linux-zen</a></span> has dm-crypt workqueues <a rel="nofollow" class="external text" href="https://github.com/zen-kernel/zen-kernel/issues/282">disabled by default</a>.</div>
<p>To disable workqueue for LUKS devices unlocked via <a href="../../en/Dm-crypt/System_configuration.html#crypttab" class="mw-redirect" title="Crypttab">crypttab</a> use one or more of the desired <code>no-read-workqueue</code> or <code>no-write-workqueue</code> options. E.g.:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/crypttab</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">luks-123abcdef-etc UUID=123abcdef-etc none no-read-workqueue</pre>
<p>To disable both read and write workqueue add both flags:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/crypttab</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">luks-123abcdef-etc UUID=123abcdef-etc none no-read-workqueue,no-write-workqueue</pre>
<p>With LUKS2 you can set <code>--perf-no_read_workqueue</code> and <code>--perf-no_write_workqueue</code> as default flags for a device by opening it once with the option <code>--persistent</code>. For example:
</p>
<pre># cryptsetup --perf-no_read_workqueue --perf-no_write_workqueue --persistent open /dev/<i>sdaX</i> root
</pre>
<p>When the device is already opened, the <code>open</code> action will raise an error. You can use the <code>refresh</code> option in these cases, e.g.:
</p>
<pre># cryptsetup --perf-no_read_workqueue --perf-no_write_workqueue --persistent refresh root
</pre>
<p>You can confirm which flags are persistently set in the LUKS2 header by looking at the <code>cryptsetup luksDump</code> output:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># cryptsetup luksDump /dev/sdaX | grep Flags</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">Flags:          no-read-workqueue
</pre>
<p>In any case, you can verify whether the device actually was opened with these flags by inspecting the <code>dmsetup table</code> output:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># dmsetup table</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">luks-123abcdef-etc: 0 1234567 crypt aes-xts-plain64 000etc000 0 8:2 4096 1 no_read_workqueue
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> Setting new persistent flags via <code>cryptsetup --persistent</code> replaces old flags with new ones instead of adding a new flag to the already set flags. This means if you want to enable both <code>--perf-no_read_workqueue</code> and <code>--perf-no_write_workqueue</code> (or more) you have to set them all at once.</div>
<p>Example for setting both <code>no_read_workqueue</code> and <code>no_write_workqueue</code> with <code>cryptsetup</code>:
</p>
<pre># cryptsetup --perf-no_read_workqueue --perf-no_write_workqueue --persistent refresh root
</pre>
<p>You can confirm both flags being set by inspecting the LUKS2 <code>cryptsetup luksDump</code> output:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># cryptsetup luksDump /dev/sdaX | grep Flags</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">Flags:          no-read-workqueue no-write-workqueue
</pre>
<h2><span class="mw-headline" id="The_encrypt_hook_and_multiple_disks">The encrypt hook and multiple disks</span></h2>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> <code>sd-encrypt</code> hook supports unlocking multiple devices. They can be specified on the kernel command line or in <code>/etc/crypttab.initramfs</code>. See <a href="../../en/Dm-crypt/System_configuration.html#Using_systemd-cryptsetup-generator" title="Dm-crypt/System configuration">dm-crypt/System configuration#Using systemd-cryptsetup-generator</a>.</div>
<p>The <code>encrypt</code> hook only allows for a <b>single</b> <code>cryptdevice=</code> entry (<a rel="nofollow" class="external text" href="https://bugs.archlinux.org/task/23182">FS#23182</a>). In system setups with multiple drives this may be limiting, because <i>dm-crypt</i> has no feature to exceed the physical device. For example, take "LVM on LUKS":  The entire LVM exists inside a LUKS mapper.  This is perfectly fine for a single-drive system, since there is only one device to decrypt. But what happens when you want to increase the size of the LVM? You cannot, at least not without modifying the <code>encrypt</code> hook.
</p>
<p>The following sections briefly show alternatives to overcome the limitation. The first deals with how to expand a <a href="../../en/Dm-crypt/Encrypting_an_entire_system.html#LUKS_on_LVM" title="Dm-crypt/Encrypting an entire system">LUKS on LVM</a> setup to a new disk. The second with modifying the <code>encrypt</code> hook to unlock multiple disks in LUKS setups without LVM.
</p>
<h3><span class="mw-headline" id="Expanding_LVM_on_multiple_disks">Expanding LVM on multiple disks</span></h3>
<p>The management of multiple disks is a basic <a href="../../en/LVM.html" title="LVM">LVM</a> feature and a major reason for its partitioning flexibility. It can also be used with <i>dm-crypt</i>, but only if LVM is employed as the first mapper. In such a <a href="../../en/Dm-crypt/Encrypting_an_entire_system.html#LUKS_on_LVM" title="Dm-crypt/Encrypting an entire system">LUKS on LVM</a> setup the encrypted devices are created inside the logical volumes (with a separate passphrase/key per volume). The following covers the steps to expand that setup to another disk.
</p>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> Back up! While resizing filesystems may be standard, keep in mind that operations <b>may</b> go wrong and the following might not apply to a particular setup. Generally, extending a filesystem to free disk space is less problematic than shrinking one. This in particular applies when stacked mappers are used, as it is the case in the following example.</div>
<h4><span class="mw-headline" id="Adding_a_new_drive">Adding a new drive</span></h4>
<p>First, it may be desired to prepare a new disk according to <a href="../../en/Dm-crypt/Drive_preparation.html" title="Dm-crypt/Drive preparation">dm-crypt/Drive preparation</a>.
Second, it is partitioned as a LVM, e.g. all space is allocated to <code>/dev/sdY1</code> with partition type <code>8E00</code> (Linux LVM).
Third, the new disk/partition is attached to the existing LVM volume group, e.g.:
</p>
<pre># pvcreate /dev/sdY1
# vgextend MyStorage /dev/sdY1
</pre>
<h4><span class="mw-headline" id="Extending_the_logical_volume">Extending the logical volume</span></h4>
<p>For the next step, the final allocation of the new diskspace, the logical volume to be extended has to be unmounted. It can be performed for the <code>cryptdevice</code> root partition, but in this case the procedure has to be performed from an Arch Install ISO.
</p>
<p>In this example, it is assumed that the logical volume for <code>/home</code> (lv-name <code>homevol</code>) is going to be expanded with the fresh disk space:
</p>
<pre># umount /home
# fsck /dev/mapper/home
# cryptsetup close /dev/mapper/home
# lvextend -l +100%FREE MyStorage/homevol
</pre>
<p>Now the logical volume is extended and the LUKS container comes next:
</p>
<pre># cryptsetup open /dev/MyStorage/homevol home
# umount /home      # as a safety, in case it was automatically remounted
# cryptsetup --verbose resize home
</pre>
<p>Finally, the filesystem itself is resized:
</p>
<pre># e2fsck -f /dev/mapper/home
# resize2fs /dev/mapper/home
</pre>
<p>Done! If it went to plan, <code>/home</code> can be remounted and now includes the span to the new disk:
</p>
<pre># mount /dev/mapper/home /home
</pre>
<p>Note that the <code>cryptsetup resize</code> action does not affect encryption keys, and these have not changed.
</p>
<h3><span class="mw-headline" id="Modifying_the_encrypt_hook_for_multiple_partitions">Modifying the encrypt hook for multiple partitions</span></h3>
<p>Note that <a href="../../en/Dm-crypt/System_configuration.html#Using_systemd-cryptsetup-generator" class="mw-redirect" title="Sd-encrypt">sd-encrypt</a> supports multiple partitions out of the box. If several (or all) partitions opened this way share the same passphrase, sd-encrypt will try it for each and not ask for it multiple times. This may be an easier alternative to the following.
</p>
<h4><span class="mw-headline" id="Root_filesystem_spanning_multiple_partitions">Root filesystem spanning multiple partitions</span></h4>
<p>It is possible to modify the encrypt hook to allow multiple hard drive decrypt root (<code>/</code>) at boot. One way:
</p>
<pre># cp /usr/lib/initcpio/install/encrypt /etc/initcpio/install/encrypt2
# cp /usr/lib/initcpio/hooks/encrypt  /etc/initcpio/hooks/encrypt2
# sed -i "s/cryptdevice/cryptdevice2/" /etc/initcpio/hooks/encrypt2
# sed -i "s/cryptkey/cryptkey2/" /etc/initcpio/hooks/encrypt2
</pre>
<p>Add <code>cryptdevice2=</code> to your boot options (and <code>cryptkey2=</code> if needed), and add the <code>encrypt2</code> hook to your <a href="../../en/Mkinitcpio.html#Configuration" class="mw-redirect" title="Mkinitcpio.conf">mkinitcpio.conf</a> before rebuilding it. See <a href="../../en/Dm-crypt/System_configuration.html" title="Dm-crypt/System configuration">dm-crypt/System configuration</a>.
</p>
<h4><span class="mw-headline" id="Multiple_non-root_partitions">Multiple non-root partitions</span></h4>
<p>Maybe you have a requirement for using the <code>encrypt</code> hook on a non-root partition. Arch does not support this out of the box, however, you can easily change the cryptdev and cryptname values in <code>/lib/initcpio/hooks/encrypt</code> (the first one to your <code>/dev/sd*</code> partition, the second to the name you want to attribute). That should be enough.
</p>
<p>The big advantage is you can have everything automated, while setting up <code>/etc/crypttab</code> with an external key file (i.e. the keyfile is not on any internal hard drive partition) can be a pain - you need to make sure the USB/FireWire/... device gets mounted before the encrypted partition, which means you have to change the order of <code>/etc/fstab</code> (at least).
</p>
<p>Of course, if the <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=cryptsetup">cryptsetup</a></span> package gets upgraded, you will have to change this script again. Unlike <code>/etc/crypttab</code>, only one partition is supported, but with some further hacking one should be able to have multiple partitions unlocked.
</p>
<div class="noprint archwiki-template-message">
<p><span class="mw-default-size" typeof="mw:File"><span><img src="../../File:Inaccurate.svg" decoding="async" width="48" height="48" class="mw-file-element"></span></span><b>The factual accuracy of this article or section is disputed.</b></p>
<div>
<b>Reason:</b> Why not use the supported Grub2 right away? See also <a href="../../en/Mkinitcpio.html#Using_RAID" title="Mkinitcpio">mkinitcpio#Using RAID</a> (Discuss in <a rel="nofollow" class="external text" href="../../en/Talk:Dm-crypt/Specialties.html">Talk:Dm-crypt/Specialties</a>)</div>
</div>
<p>If you want to do this on a software RAID partition, there is one more thing you need to do. Just setting the <code>/dev/mdX</code> device in <code>/lib/initcpio/hooks/encrypt</code> is not enough; the <code>encrypt</code> hook will fail to find the key for some reason, and not prompt for a passphrase either. It looks like the RAID devices are not brought up until after the <code>encrypt</code> hook is run. You can solve this by putting the RAID array in <code>/boot/grub/menu.lst</code>, like
</p>
<pre>kernel /boot/vmlinuz-linux md=1,/dev/hda5,/dev/hdb5
</pre>
<p>If you set up your root partition as a RAID, you will notice the similarities with that setup. <a href="../../en/GRUB.html" title="GRUB">GRUB</a> can handle multiple array definitions just fine:
</p>
<pre>kernel /boot/vmlinuz-linux root=/dev/md0 ro md=0,/dev/sda1,/dev/sdb1 md=1,/dev/sda5,/dev/sdb5,/dev/sdc5
</pre>
<h2><span class="mw-headline" id="Encrypted_system_using_a_detached_LUKS_header">Encrypted system using a detached LUKS header</span></h2>
<p>This example follows the same setup as in <a href="../../en/Dm-crypt/Encrypting_an_entire_system.html#Plain_dm-crypt" title="Dm-crypt/Encrypting an entire system">dm-crypt/Encrypting an entire system#Plain dm-crypt</a>, which should be read first before following this guide.
</p>
<p>By using a detached header the encrypted blockdevice itself only carries encrypted data, which gives <a href="https://en.wikipedia.org/wiki/Deniable_encryption" class="extiw" title="wikipedia:Deniable encryption">deniable encryption</a> as long as the existence of a header is unknown to the attackers. It is similar to using <a href="../../en/Dm-crypt/Encrypting_an_entire_system.html#Plain_dm-crypt" title="Dm-crypt/Encrypting an entire system">plain dm-crypt</a>, but with the LUKS advantages such as multiple passphrases for the masterkey and key derivation. Further, using a detached header offers a form of two factor authentication with an easier setup than <a href="#Using_GPG,_LUKS,_or_OpenSSL_Encrypted_Keyfiles">using GPG or OpenSSL encrypted keyfiles</a>, while still having a built-in password prompt for multiple retries. See <a href="../../en/Data-at-rest_encryption.html#Cryptographic_metadata" title="Data-at-rest encryption">Data-at-rest encryption#Cryptographic metadata</a> for more information.
</p>
<p>See <a href="../../en/Dm-crypt/Device_encryption.html#Encryption_options_for_LUKS_mode" title="Dm-crypt/Device encryption">dm-crypt/Device encryption#Encryption options for LUKS mode</a> for encryption options before performing the first step to setup the encrypted system partition and creating a header file to use with <code>cryptsetup</code>:
</p>
<pre># dd if=/dev/zero of=header.img bs=16M count=1
# cryptsetup luksFormat --offset 32768 --header header.img /dev/sdX
</pre>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> The <code>--offset</code> option allows specifying the start of encrypted data on a device. By reserving a space at the beginning of device you have the option of later <a href="../../en/Dm-crypt/Device_encryption.html#Restore_using_cryptsetup" title="Dm-crypt/Device encryption">reattaching the LUKS header</a>. The value is specified in 512-byte sectors, see <span class="plainlinks archwiki-template-man" title="$ man 8 cryptsetup-luksFormat"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/cryptsetup-luksFormat.8">cryptsetup-luksFormat(8)</a></span> for more details.</div>
<p>Open the container:
</p>
<pre># cryptsetup open --header header.img /dev/sdX enc
</pre>
<p>Now follow the <a href="../../en/Dm-crypt/Encrypting_an_entire_system.html#Preparing_the_non-boot_partitions" title="Dm-crypt/Encrypting an entire system">LVM on LUKS setup</a> to your requirements. The same applies for <a href="../../en/Dm-crypt/Encrypting_an_entire_system.html#Preparing_the_boot_partition_4" title="Dm-crypt/Encrypting an entire system">preparing the boot partition</a> on the removable device (because if not, there is no point in having a separate header file for unlocking the encrypted disk).
Next move the <code>header.img</code> onto it:
</p>
<pre># mv header.img /mnt/boot
</pre>
<p>Follow the installation procedure up to the mkinitcpio step (you should now be <code>arch-chroot</code>ed inside the encrypted system).
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> You will notice that since the system partition only has "random" data, it does not have a partition table and by that an <code>UUID</code> or a <code>LABEL</code>. But you can still have a consistent mapping using the <a href="../../en/Persistent_block_device_naming.html#by-id_and_by-path" title="Persistent block device naming">Persistent block device naming#by-id and by-path</a>. E.g. using disk id from <code>/dev/disk/by-id/</code>.</div>
<p>There are two options for initramfs to support a detached LUKS header.
</p>
<h3><span class="mw-headline" id="Using_systemd_hook">Using systemd hook</span></h3>
<p>Set the following <a href="../../en/Kernel_parameters.html" title="Kernel parameters">kernel parameters</a>:
</p>
<pre>rd.luks.name=<i>XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX</i>=enc rd.luks.options=<i>XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX</i>=header=/header.img:<i>UUID=ZZZZZZZZ-ZZZZ-ZZZZ-ZZZZ-ZZZZZZZZZZZZ</i> rd.luks.data=<i>XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX</i>=/dev/disk/by-id/<i>your-disk_id</i>
</pre>
<ul>
<li>Replace <code><i>XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX</i></code> with the LUKS super block UUID. It can be acquired with <code>cryptsetup luksDump header.img</code> or <code>blkid -s UUID -o value header.img</code>.</li>
<li>Replace <code><i>UUID=ZZZZZZZZ-ZZZZ-ZZZZ-ZZZZ-ZZZZZZZZZZZZ</i></code> with the block device of volume in which the header file is located.</li>
</ul>
<p>Alternatively, instead of using the <code>rd.luks</code> kernel parameters, the options can be specified in a <code>/etc/crypttab.initramfs</code> file:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/crypttab.initramfs</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">enc	/dev/disk/by-id/<i>your-disk_id</i>	none	header=/header.img:<i>UUID=ZZZZZZZZ-ZZZZ-ZZZZ-ZZZZ-ZZZZZZZZZZZZ</i></pre>
<p>Next, modify <code>/etc/mkinitcpio.conf</code> <a href="../../en/Mkinitcpio.html#Common_hooks" title="Mkinitcpio">to use systemd</a> and to include the <a href="../../en/File_systems.html" class="mw-redirect" title="File system">file system</a> module for the volume in which the header is located. For example, if it is a <a href="../../en/FAT.html" title="FAT">FAT</a> volume:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/mkinitcpio.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">...
MODULES=(<b>vfat</b>)
...
HOOKS=(base <b>systemd</b> autodetect microcode modconf kms <b>keyboard</b> <b>sd-vconsole</b> block <b>sd-encrypt</b> lvm2 filesystems fsck)
...</pre>
<p><a href="../../en/Mkinitcpio.html#Image_creation_and_activation" class="mw-redirect" title="Regenerate the initramfs">Regenerate the initramfs</a> and you are done.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> 
<ul>
<li>When using <code>/etc/crypttab.initramfs</code>, no cryptsetup parameters need to be passed to the kernel command line, since <code>/etc/crypttab.initramfs</code> will be added as <code>/etc/crypttab</code> in the initramfs.</li>
<li>Refrain from using the <code>rd.luks</code> kernel parameters together with <code>/etc/crypttab.initramfs</code> as it can cause conflicts. See the warning in <a href="../../en/Dm-crypt/System_configuration.html#Using_systemd-cryptsetup-generator" title="Dm-crypt/System configuration">dm-crypt/System configuration#Using systemd-cryptsetup-generator</a> for details.</li>
</ul>
</div>
<h3><span class="mw-headline" id="Modifying_encrypt_hook">Modifying encrypt hook</span></h3>
<p>This method shows how to modify the <code>encrypt</code> hook in order to use a detached LUKS header.
Now the <code>encrypt</code> hook has to be modified to let <code>cryptsetup</code> use the separate header (<a rel="nofollow" class="external text" href="https://bugs.archlinux.org/task/42851">FS#42851</a>; base source and idea for these changes <a rel="nofollow" class="external text" href="https://bbs.archlinux.org/viewtopic.php?pid=1076346#p1076346">published on the BBS</a>). Make a copy so it is not overwritten on a <a href="../../en/Mkinitcpio.html" title="Mkinitcpio">mkinitcpio</a> update:
</p>
<pre># cp /usr/lib/initcpio/hooks/encrypt /etc/initcpio/hooks/encrypt2
# cp /usr/lib/initcpio/install/encrypt /etc/initcpio/install/encrypt2
</pre>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/initcpio/hooks/encrypt2 (around line 52)</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">warn_deprecated() {
    echo "The syntax 'root=${root}' where '${root}' is an encrypted volume is deprecated"
    echo "Use 'cryptdevice=${root}:root root=/dev/mapper/root' instead."
}

<b>local headerFlag=false</b>
for cryptopt in ${cryptoptions//,/ }; do
    case ${cryptopt} in
        allow-discards)
            cryptargs="${cryptargs} --allow-discards"
            ;;
        <b>header)
            cryptargs="${cryptargs} --header /boot/header.img"
            headerFlag=true
            ;;</b>
        *)
            echo "Encryption option '${cryptopt}' not known, ignoring." &gt;&amp;2
            ;;
    esac
done

if resolved=$(resolve_device "${cryptdev}" ${rootdelay}); then
    if <b>$headerFlag || </b>cryptsetup isLuks ${resolved} &gt;/dev/null 2&gt;&amp;1; then
        [ ${DEPRECATED_CRYPT} -eq 1 ] &amp;&amp; warn_deprecated
        dopassphrase=1</pre>
<p>Now edit the <a href="../../en/Mkinitcpio.html#Configuration" class="mw-redirect" title="Mkinitcpio.conf">mkinitcpio.conf</a> to add the <code>encrypt2</code> and <code>lvm2</code> hooks, the <code>header.img</code> to <code>FILES</code> and the <code>loop</code> to <code>MODULES</code>, apart from other configuration the system requires:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/mkinitcpio.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">...
MODULES=(<b>loop</b>)
...
FILES=(<b>/boot/header.img</b>)
...
HOOKS=(base udev autodetect microcode modconf kms <b>keyboard</b> <b>keymap</b> consolefont block <b>encrypt2</b> <b>lvm2</b> filesystems fsck)
...</pre>
<p>This is required so the LUKS header is available on boot allowing the decryption of the system, exempting us from a more complicated setup to mount another separate USB device in order to access the header. After this set up <a href="../../en/Mkinitcpio.html#Image_creation_and_activation" title="Mkinitcpio">the initramfs</a> is created.
</p>
<p>Next the <a href="../../en/Dm-crypt/Encrypting_an_entire_system.html#Configuring_the_boot_loader_4" title="Dm-crypt/Encrypting an entire system">boot loader is configured</a> to specify the <code>cryptdevice=</code> also passing the new <code>header</code> option for this setup:
</p>
<pre>cryptdevice=/dev/disk/by-id/<i>your-disk_id</i>:enc:header
</pre>
<p>To finish, following <a href="../../en/Dm-crypt/Encrypting_an_entire_system.html#Post-installation" title="Dm-crypt/Encrypting an entire system">dm-crypt/Encrypting an entire system#Post-installation</a> is particularly useful with a <code>/boot</code> partition on an USB storage medium.
</p>
<h2>
<span id="Encrypted_.2Fboot_and_a_detached_LUKS_header_on_USB"></span><span class="mw-headline" id="Encrypted_/boot_and_a_detached_LUKS_header_on_USB">Encrypted /boot and a detached LUKS header on USB</span>
</h2>
<div class="noprint archwiki-template-message">
<p><span class="mw-default-size" typeof="mw:File"><span><img src="../../File:View-refresh-red.svg" decoding="async" width="48" height="48" class="mw-file-element"></span></span><b>This article or section is out of date.</b></p>
<div>
<b>Reason:</b> This scenario was based on <a rel="nofollow" class="external autonumber" href="https://wiki.archlinux.org/index.php?title=Dm-crypt/Encrypting_an_entire_system&amp;oldid=562642#Encrypted_boot_partition_(GRUB)">[6]</a>, whose structure was then changed with <a rel="nofollow" class="external autonumber" href="https://wiki.archlinux.org/index.php?title=Dm-crypt/Encrypting_an_entire_system&amp;diff=next&amp;oldid=562642">[7]</a>. (Discuss in <a href="../../en/Talk:Dm-crypt/Specialties.html#Encrypted_/boot_and_a_detached_LUKS_header_on_USB" title="Talk:Dm-crypt/Specialties">Talk:Dm-crypt/Specialties#Encrypted /boot and a detached LUKS header on USB</a>)</div>
</div>
<p>Rather than embedding the <code>header.img</code> and keyfile into the <a href="../../en/Arch_boot_process.html#initramfs" class="mw-redirect" title="Initramfs">initramfs</a> image, this setup will make your system depend entirely on the usb key rather than just the image to boot, and on the encrypted keyfile inside of the encrypted boot partition. Since the header and keyfile are not included in the <a href="../../en/Arch_boot_process.html#initramfs" class="mw-redirect" title="Initramfs">initramfs</a> image and the custom encrypt hook is specifically for the usb's <a href="../../en/Persistent_block_device_naming.html#by-id_and_by-path" title="Persistent block device naming">by-id</a>, you will literally need the usb key to boot.
</p>
<p>For the usb drive, since you are encrypting the drive and the keyfile inside, it is preferred to cascade the ciphers as to not use the same one twice. Whether a <a href="https://en.wikipedia.org/wiki/Meet-in-the-middle_attack" class="extiw" title="wikipedia:Meet-in-the-middle attack">meet-in-the-middle</a> attack would actually be feasible is debatable. You can do twofish-serpent or serpent-twofish.
</p>
<h3><span class="mw-headline" id="Preparing_the_disk_devices">Preparing the disk devices</span></h3>
<p><code>sdb</code> will be assumed to be the USB drive, <code>sda</code> will be assumed to be the main hard drive.
</p>
<p>Prepare the devices according to <a href="../../en/Dm-crypt/Drive_preparation.html" title="Dm-crypt/Drive preparation">dm-crypt/Drive preparation</a>.
</p>
<h4><span class="mw-headline" id="Preparing_the_USB_key">Preparing the USB key</span></h4>
<p>Use <a href="../../en/GPT_fdisk.html" class="mw-redirect" title="Gdisk">gdisk</a> to partition the disk according to the layout <a href="../../en/Dm-crypt/Encrypting_an_entire_system.html#Preparing_the_disk_5" title="Dm-crypt/Encrypting an entire system">shown here</a>, with the exception that it should only include the first two partitions. So as follows:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># gdisk /dev/sdb</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">Number  Start (sector)    End (sector)  Size       Code  Name
   1            2048         1050623   512.0 MiB   EF00  EFI System
   2         1050624         1460223   200.0 MiB   8300  Linux filesystem
</pre>
<p>Before running <code>cryptsetup</code>, look at the <a href="../../en/Dm-crypt/Device_encryption.html#Encryption_options_for_LUKS_mode" title="Dm-crypt/Device encryption">Encryption options for LUKS mode</a> and <a href="../../en/Data-at-rest_encryption.html#Ciphers_and_modes_of_operation" class="mw-redirect" title="Disk encryption">Ciphers and modes of operation</a> first to select your desired settings.
</p>
<p><a href="../../en/Dm-crypt/Encrypting_an_entire_system.html#Preparing_the_boot_partition" title="Dm-crypt/Encrypting an entire system">Prepare the boot partition</a> but do not <code>mount</code> any partition yet and <a href="../../en/EFI_system_partition.html#Format_the_partition" title="EFI system partition">Format the EFI system partition</a>.
</p>
<pre># mount /dev/mapper/cryptboot /mnt
# dd if=/dev/urandom of=/mnt/key.img bs=<i>filesize</i> count=1
# cryptsetup luksFormat /mnt/key.img
# cryptsetup open /mnt/key.img lukskey
</pre>
<p><i>filesize</i> is in bytes but can be followed by a suffix such as <code>M</code>. Having too small of a file will get you a nasty <code>Requested offset is beyond real size of device /dev/loop0</code> error. As a rough reference, creating a 4M file will encrypt it successfully. You should make the file larger than the space needed since the encrypted loop device will be a little smaller than the file's size.
</p>
<p>With a big file, you can use <code>--keyfile-offset=<i>offset</i></code> and <code>--keyfile-size=<i>size</i></code> to navigate to the correct position (see <a href="https://wiki.gentoo.org/wiki/Custom_Initramfs#Encrypted_keyfile" class="extiw" title="gentoo:Custom Initramfs">Gentoo:Custom Initramfs#Encrypted keyfile</a>).
</p>
<p>Now you should have <code>lukskey</code> opened in a loop device (underneath <code>/dev/loop1</code>), mapped as <code>/dev/mapper/lukskey</code>.
</p>
<h4><span class="mw-headline" id="The_main_drive">The main drive</span></h4>
<pre># truncate -s 16M /mnt/header.img
# cryptsetup --key-file=/dev/mapper/lukskey --keyfile-offset=<i>offset</i> --keyfile-size=<i>size</i> luksFormat /dev/sda --offset 32768 --header /mnt/header.img
</pre>
<p>Pick an <i>offset</i> and <i>size</i> in bytes (8192 KiB is the maximum keyfile size for <code>cryptsetup</code>).
</p>
<pre># cryptsetup open --header /mnt/header.img --key-file=/dev/mapper/lukskey --keyfile-offset=<i>offset</i> --keyfile-size=<i>size</i> /dev/sda enc
# cryptsetup close lukskey
# umount /mnt
</pre>
<p>Follow <a href="../../en/Dm-crypt/Encrypting_an_entire_system.html#Preparing_the_logical_volumes" title="Dm-crypt/Encrypting an entire system">Preparing the logical volumes</a> to set up LVM on LUKS.
</p>
<p>See <a href="../../en/Partitioning.html#Discrete_partitions" title="Partitioning">Partitioning#Discrete partitions</a> for recommendations on the size of your partitions.
</p>
<p>Once your root partition is mounted, <code>mount</code> your encrypted boot partition as <code>/mnt/boot</code> and your EFI system partition as <code>/mnt/efi</code>.
</p>
<h3><span class="mw-headline" id="Installation_procedure_and_custom_encrypt_hook">Installation procedure and custom encrypt hook</span></h3>
<p>Follow the <a href="../../en/Installation_guide.html" title="Installation guide">installation guide</a> up to the <code>mkinitcpio</code> step but do not do it yet, and skip the partitioning, formatting, and mounting steps as they have already been done.
</p>
<p>In order to get the encrypted setup to work, you need to build your own hook, which is thankfully easy to do and here is the code you need. You will have to follow <a href="../../en/Persistent_block_device_naming.html#by-id_and_by-path" title="Persistent block device naming">Persistent block device naming#by-id and by-path</a> to figure out your own <code>by-id</code> values for the usb and main hard drive (they are linked -&gt; to <code>sda</code> or <code>sdb</code>).
</p>
<p>You should be using the <code>by-id</code> instead of just <code>sda</code> or <code>sdb</code> because <code>sdX</code> can change and this ensures it is the correct device.
</p>
<p>You can name <code>customencrypthook</code> anything you want, and custom build hooks can be placed in the <code>hooks</code> and <code>install</code> folders of <code>/etc/initcpio</code>. Keep a backup of both files (<code>cp</code> them over to the <code>/home</code> partition or your user's <code>/home</code> directory after you make one). <code>/usr/bin/ash</code> is not a typo.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/initcpio/hooks/customencrypthook</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">#!/usr/bin/ash

run_hook() {
    modprobe -a -q dm-crypt &gt;/dev/null 2&gt;&amp;1
    modprobe loop
    [ "${quiet}" = "y" ] &amp;&amp; CSQUIET="&gt;/dev/null"

    while [ ! -L '/dev/disk/by-id/<i>usbdrive</i>-part2' ]; do
     echo 'Waiting for USB'
     sleep 1
    done

    cryptsetup open /dev/disk/by-id/<i>usbdrive</i>-part2 cryptboot
    mount --mkdir /dev/mapper/cryptboot /mnt
    cryptsetup open /mnt/key.img lukskey
    cryptsetup --header /mnt/header.img --key-file=/dev/mapper/lukskey --keyfile-offset=''offset'' --keyfile-size=''size'' open /dev/disk/by-id/<i>harddrive</i> enc
    cryptsetup close lukskey
    umount /mnt
}
</pre>
<p><code><i>usbdrive</i></code> is your USB drive <code>by-id</code>, and <code><i>harddrive</i></code> is your main hard drive <code>by-id</code>.
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> You could also close <code>cryptboot</code> using <code>cryptsetup close</code>, but having it open makes it easier to mount for system updates using <a href="../../en/Pacman.html" title="Pacman">Pacman</a> and regenerating the initramfs with <a href="../../en/Mkinitcpio.html" title="Mkinitcpio">mkinitcpio</a>. The <code>/boot</code> partition must be mounted for updates that affect the <a href="../../en/Kernel.html" title="Kernel">kernel</a> or <a href="../../en/Arch_boot_process.html#initramfs" class="mw-redirect" title="Initramfs">Initramfs</a>, and the initramfs will be automatically regenerated after these updates.</div>
<pre># cp /usr/lib/initcpio/install/encrypt /etc/initcpio/install/customencrypthook
</pre>
<p>Now edit the copied file and remove the <code>help()</code> section as it is not necessary.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/mkinitcpio.conf (edit this only do not replace it, these are just excerpts of the necessary parts)</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">MODULES=(loop)
...
HOOKS=(base udev autodetect microcode modconf kms keyboard keymap consolefont block customencrypthook lvm2 filesystems fsck)</pre>
<p>The <code>files=()</code> and <code>binaries=()</code> arrays are empty, and you should not have to replace <code>HOOKS=(...)</code> array entirely just edit in <code>customencrypthook lvm2</code> after <code>block</code> and before <code>filesystems</code>, and make sure <code>systemd</code> and <code>encrypt</code> are removed.
</p>
<h4><span class="mw-headline" id="Boot_loader">Boot loader</span></h4>
<p>Finish the <a href="../../en/Installation_guide.html#Initramfs" title="Installation guide">Installation Guide</a> from the <code>mkinitcpio</code> step. To boot you would need either <a href="../../en/GRUB.html" title="GRUB">GRUB</a> or <a href="../../en/Unified_Extensible_Firmware_Interface.html#efibootmgr" class="mw-redirect" title="Efibootmgr">efibootmgr</a>. Note you can use <a href="../../en/GRUB.html" title="GRUB">GRUB</a> to support the encrypted disks by <a href="../../en/Dm-crypt/Encrypting_an_entire_system.html#Configuring_the_boot_loader" title="Dm-crypt/Encrypting an entire system">Configuring the boot loader</a> but editing the <code>GRUB_CMDLINE_LINUX</code> is not necessary for this set up.
</p>
<p>Or use direct UEFI Secure Boot by generating keys with <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/cryptboot/">cryptboot</a></span><sup><small>AUR</small></sup> then signing the initramfs and kernel and creating a bootable <i>.efi</i> file for your EFI system partition with <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/sbupdate-git/">sbupdate-git</a></span><sup><small>AUR</small></sup>. Before using cryptboot or sbupdate note this excerpt from <a href="../../en/Unified_Extensible_Firmware_Interface/Secure_Boot.html#Using_your_own_keys" class="mw-redirect" title="Secure Boot">Secure Boot#Using your own keys</a>:
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> Note that <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/cryptboot/">cryptboot</a></span><sup><small>AUR</small></sup> requires the encrypted boot partition to be specified in <code>/etc/crypttab</code> before it runs, and if you are using it in combination with <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/sbupdate-git/">sbupdate-git</a></span><sup><small>AUR</small></sup>, sbupdate expects the <code>/boot/efikeys/db.*</code> files created by cryptboot to be capitalized like <code>DB.*</code> unless otherwise configured in <code>/etc/default/sbupdate</code>. Users who do not use systemd to handle encryption may not have anything in their <code>/etc/crypttab</code> file and would need to create an entry.
</div>
<pre># efibootmgr --create --disk /dev/<i>device</i> --part <i>partition_number</i> --label "Arch Linux Signed" --loader "EFI\Arch\linux-signed.efi" --unicode
</pre>
<p>See <span class="plainlinks archwiki-template-man" title="$ man 8 efibootmgr"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/efibootmgr.8">efibootmgr(8)</a></span> for an explanation of the options.
</p>
<p>Make sure the boot order puts <code>Arch Linux Signed</code> first. If not change it with <code>efibootmgr --bootorder XXXX,YYYY,ZZZZ --unicode</code>.
</p>
<h3><span class="mw-headline" id="Changing_the_LUKS_keyfile">Changing the LUKS keyfile</span></h3>
<div class="noprint archwiki-template-message">
<p><span class="mw-default-size" typeof="mw:File"><span><img src="../../File:Merge-arrows-2.svg" decoding="async" width="36" height="40" class="mw-file-element"></span></span><b>This article or section is a candidate for merging with <a href="../../en/Dm-crypt/Device_encryption.html#Keyfiles" title="Dm-crypt/Device encryption">dm-crypt/Device encryption#Keyfiles</a>.</b></p>
<div>
<b>Notes:</b> Changing the keyfile is not a required action in this setup. (Discuss in <a rel="nofollow" class="external text" href="../../en/Talk:Dm-crypt/Specialties.html">Talk:Dm-crypt/Specialties</a>)</div>
</div>
<pre># cryptsetup --header /boot/header.img --key-file=/dev/mapper/lukskey --keyfile-offset=<i>offset</i> --keyfile-size=<i>size</i> luksChangeKey /dev/mapper/enc /dev/mapper/lukskey2 --new-keyfile-size=<i>newsize</i> --new-keyfile-offset=<i>newoffset</i>
</pre>
<p>Afterwards, <code>cryptsetup close lukskey</code> and <a href="../../en/Securely_wipe_disk.html#shred" class="mw-redirect" title="Shred">shred</a> or <a href="../../en/Securely_wipe_disk.html#dd" title="Securely wipe disk">dd</a> the old keyfile with random data before deleting it, then make sure that the new keyfile is renamed to the same name of the old one: <code>key.img</code> or other name.
</p>
</div>
</div>
					<div id="catlinks" class="catlinks" data-mw="interface">
<div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../../Special:Categories.html" title="Special:Categories">Category</a>: <ul><li><a href="../../en/Category:Data-at-rest_encryption.html" title="Category:Data-at-rest encryption">Data-at-rest encryption</a></li></ul>
</div>
<div id="mw-hidden-catlinks" class="mw-hidden-catlinks mw-hidden-cats-hidden">Hidden categories: <ul>
<li><a href="../../en/Category:Pages_or_sections_flagged_with_Template:Accuracy.html" title="Category:Pages or sections flagged with Template:Accuracy">Pages or sections flagged with Template:Accuracy</a></li>
<li><a href="../../en/Category:Pages_or_sections_flagged_with_Template:Out_of_date.html" title="Category:Pages or sections flagged with Template:Out of date">Pages or sections flagged with Template:Out of date</a></li>
<li><a href="../../en/Category:Pages_or_sections_flagged_with_Template:Merge.html" title="Category:Pages or sections flagged with Template:Merge">Pages or sections flagged with Template:Merge</a></li>
</ul>
</div>
</div>
				</div>
			</main>
			
		</div>
		<div class="mw-footer-container">
			
<footer id="footer" class="mw-footer" role="contentinfo" style="margin: 0">
	<ul id="footer-info">
	<li data-nosnippet="">Retrieved from "<a dir="ltr" href="https://wiki.archlinux.org/index.php?title=Dm-crypt/Specialties&amp;oldid=812786">https://wiki.archlinux.org/index.php?title=Dm-crypt/Specialties&amp;oldid=812786</a>"</li>
<li id="footer-info-lastmod"> This page was last edited on 23 July 2024, at 08:57.</li>
	<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="https://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.3 or later</a> unless otherwise noted.</li>
<br>
</ul>

	<ul id="footer-places">
	<li id="footer-places-privacy"><a href="https://terms.archlinux.org/docs/privacy-policy/">Privacy policy</a></li>
	<li id="footer-places-about"><a href="../../en/ArchWiki:About.html">About ArchWiki</a></li>
	<li id="footer-places-disclaimers"><a href="../../en/ArchWiki:General_disclaimer.html">Disclaimers</a></li>
	<li id="footer-places-archwiki-code-of-conduct"><a href="https://terms.archlinux.org/docs/code-of-conduct/" class="extiw" title="archlinux-service-agreements:code-of-conduct">Code of conduct</a></li>
	<li id="footer-places-archwiki-terms-of-service"><a href="https://terms.archlinux.org/docs/terms-of-service/" class="extiw" title="archlinux-service-agreements:terms-of-service">Terms of service</a></li>
</ul>

	<ul id="footer-icons" class="noprint">
	<li id="footer-copyrightico"><a href="https://www.gnu.org/copyleft/fdl.html"><img src="/resources/assets/licenses/gnu-fdl.png" alt="GNU Free Documentation License 1.3 or later" width="88" height="31" loading="lazy"></a></li>
	<li id="footer-poweredbyico"><img src="/resources/assets/poweredby_mediawiki_88x31.png" srcset="/resources/assets/poweredby_mediawiki_132x47.png 1.5x, /resources/assets/poweredby_mediawiki_176x62.png 2x" width="88" height="31" loading="lazy"></li>
</ul>

</footer>

		</div>
	</div> 
</div> 
<div class="vector-settings" id="p-dock-bottom">
	<ul>
		<li>
		<button class="cdx-button cdx-button--icon-only vector-limited-width-toggle" id=""><span class="vector-icon mw-ui-icon-fullScreen mw-ui-icon-wikimedia-fullScreen"></span>

<span>Toggle limited content width</span>
</button>
</li>
	</ul>
</div>
</body>
</html>
