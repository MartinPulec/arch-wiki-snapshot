<!DOCTYPE html>
<html class="client-nojs vector-feature-language-in-header-enabled vector-feature-language-in-main-page-header-disabled vector-feature-page-tools-pinned-disabled vector-feature-toc-pinned-clientpref-1 vector-feature-main-menu-pinned-disabled vector-feature-limited-width-clientpref-1 vector-feature-limited-width-content-enabled vector-feature-custom-font-size-clientpref-0 vector-feature-appearance-pinned-clientpref-1 vector-feature-night-mode-enabled skin-theme-clientpref-os vector-sticky-header-enabled vector-toc-available" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>Install Arch Linux on ZFS - ArchWiki</title>
<link rel="stylesheet" href="../ArchWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<meta name="generator" content="MediaWiki 1.44.2">
<meta name="referrer" content="no-referrer-when-downgrade">
<meta name="robots" content="max-image-preview:standard">
<meta name="format-detection" content="telephone=no">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=0.25, maximum-scale=5.0">
<link rel="search" type="application/opensearchdescription+xml" href="/rest.php/v1/search" title="ArchWiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.archlinux.org/api.php?action=rsd">
<link rel="license" href="https://www.gnu.org/copyleft/fdl.html">
<link rel="alternate" type="application/atom+xml" title="ArchWiki Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="skin--responsive skin-vector skin-vector-search-vue mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-Install_Arch_Linux_on_ZFS rootpage-Install_Arch_Linux_on_ZFS skin-vector-2022 action-view">
<a class="mw-jump-link" href="#bodyContent">Jump to content</a>
<div class="vector-header-container">
	</div>
<div class="mw-page-container">
	<div class="mw-page-container-inner">
		<div class="vector-column-start">
			<div class="vector-main-menu-container">
		</div>
	<div class="vector-sticky-pinned-container">
				<nav id="mw-panel-toc" aria-label="Contents" data-event-name="ui.sidebar-toc" class="mw-table-of-contents-container vector-toc-landmark">
					<div id="vector-toc-pinned-container" class="vector-pinned-container">
					<div id="vector-toc" class="vector-toc vector-pinnable-element">
	<div class="vector-pinnable-header vector-toc-pinnable-header vector-pinnable-header-pinned" data-feature-name="toc-pinned" data-pinnable-element-id="vector-toc">
	<h2 class="vector-pinnable-header-label">Contents</h2>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-pin-button" data-event-name="pinnable-header.vector-toc.pin">move to sidebar</button>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-unpin-button" data-event-name="pinnable-header.vector-toc.unpin">hide</button>
</div>


	<ul class="vector-toc-contents" id="mw-panel-toc-list">
		<li id="toc-mw-content-text" class="vector-toc-list-item vector-toc-level-1">
			<a href="#" class="vector-toc-link">
				<div class="vector-toc-text">Beginning</div>
			</a>
		</li>
		<li id="toc-Installation" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#Installation">
			<div class="vector-toc-text">
				<span class="vector-toc-numb">1</span>
				<span>Installation</span>
			</div>
		</a>
		
			<button aria-controls="toc-Installation-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Installation subsection</span>
			</button>
		
		<ul id="toc-Installation-sublist" class="vector-toc-list">
			<li id="toc-Embedding_ZFS_module_into_custom_archiso" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Embedding_ZFS_module_into_custom_archiso">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">1.1</span>
					<span>Embedding ZFS module into custom archiso</span>
				</div>
			</a>
			
			<ul id="toc-Embedding_ZFS_module_into_custom_archiso-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Partition_the_destination_drive" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#Partition_the_destination_drive">
			<div class="vector-toc-text">
				<span class="vector-toc-numb">2</span>
				<span>Partition the destination drive</span>
			</div>
		</a>
		
			<button aria-controls="toc-Partition_the_destination_drive-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Partition the destination drive subsection</span>
			</button>
		
		<ul id="toc-Partition_the_destination_drive-sublist" class="vector-toc-list">
			<li id="toc-Partition_scheme" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Partition_scheme">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">2.1</span>
					<span>Partition scheme</span>
				</div>
			</a>
			
			<ul id="toc-Partition_scheme-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Format_the_destination_disk" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#Format_the_destination_disk">
			<div class="vector-toc-text">
				<span class="vector-toc-numb">3</span>
				<span>Format the destination disk</span>
			</div>
		</a>
		
		<ul id="toc-Format_the_destination_disk-sublist" class="vector-toc-list">
		</ul>
	</li>
	<li id="toc-Setup_the_ZFS_filesystem" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#Setup_the_ZFS_filesystem">
			<div class="vector-toc-text">
				<span class="vector-toc-numb">4</span>
				<span>Setup the ZFS filesystem</span>
			</div>
		</a>
		
			<button aria-controls="toc-Setup_the_ZFS_filesystem-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Setup the ZFS filesystem subsection</span>
			</button>
		
		<ul id="toc-Setup_the_ZFS_filesystem-sublist" class="vector-toc-list">
			<li id="toc-Create_the_root_zpool" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Create_the_root_zpool">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">4.1</span>
					<span>Create the root zpool</span>
				</div>
			</a>
			
			<ul id="toc-Create_the_root_zpool-sublist" class="vector-toc-list">
				<li id="toc-Compression_and_native_encryption" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Compression_and_native_encryption">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">4.1.1</span>
					<span>Compression and native encryption</span>
				</div>
			</a>
			
			<ul id="toc-Compression_and_native_encryption-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Create_your_datasets" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Create_your_datasets">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">4.2</span>
					<span>Create your datasets</span>
				</div>
			</a>
			
			<ul id="toc-Create_your_datasets-sublist" class="vector-toc-list">
				<li id="toc-System_datasets" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#System_datasets">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">4.2.1</span>
					<span>System datasets</span>
				</div>
			</a>
			
			<ul id="toc-System_datasets-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Export/Import_your_pools" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Export/Import_your_pools">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">4.3</span>
					<span>Export/Import your pools</span>
				</div>
			</a>
			
			<ul id="toc-Export/Import_your_pools-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Configure_the_root_filesystem" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Configure_the_root_filesystem">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">4.4</span>
					<span>Configure the root filesystem</span>
				</div>
			</a>
			
			<ul id="toc-Configure_the_root_filesystem-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Install_and_configure_Arch_Linux" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#Install_and_configure_Arch_Linux">
			<div class="vector-toc-text">
				<span class="vector-toc-numb">5</span>
				<span>Install and configure Arch Linux</span>
			</div>
		</a>
		
		<ul id="toc-Install_and_configure_Arch_Linux-sublist" class="vector-toc-list">
		</ul>
	</li>
	<li id="toc-Configure_systemd_ZFS_mounts" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#Configure_systemd_ZFS_mounts">
			<div class="vector-toc-text">
				<span class="vector-toc-numb">6</span>
				<span>Configure systemd ZFS mounts</span>
			</div>
		</a>
		
		<ul id="toc-Configure_systemd_ZFS_mounts-sublist" class="vector-toc-list">
		</ul>
	</li>
	<li id="toc-Unmount_and_restart" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#Unmount_and_restart">
			<div class="vector-toc-text">
				<span class="vector-toc-numb">7</span>
				<span>Unmount and restart</span>
			</div>
		</a>
		
			<button aria-controls="toc-Unmount_and_restart-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Unmount and restart subsection</span>
			</button>
		
		<ul id="toc-Unmount_and_restart-sublist" class="vector-toc-list">
			<li id="toc-Loading_password_from_USB-Stick" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Loading_password_from_USB-Stick">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">7.1</span>
					<span>Loading password from USB-Stick</span>
				</div>
			</a>
			
			<ul id="toc-Loading_password_from_USB-Stick-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Troubleshooting" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#Troubleshooting">
			<div class="vector-toc-text">
				<span class="vector-toc-numb">8</span>
				<span>Troubleshooting</span>
			</div>
		</a>
		
			<button aria-controls="toc-Troubleshooting-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Troubleshooting subsection</span>
			</button>
		
		<ul id="toc-Troubleshooting-sublist" class="vector-toc-list">
			<li id="toc-System_fails_to_boot_due_to:_cannot_import_zroot:_no_such_pool_available" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#System_fails_to_boot_due_to:_cannot_import_zroot:_no_such_pool_available">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">8.1</span>
					<span>System fails to boot due to: cannot import zroot: no such pool available</span>
				</div>
			</a>
			
			<ul id="toc-System_fails_to_boot_due_to:_cannot_import_zroot:_no_such_pool_available-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Zpool_refuses_to_export_saying_it's_busy" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Zpool_refuses_to_export_saying_it's_busy">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">8.2</span>
					<span>Zpool refuses to export saying it's busy</span>
				</div>
			</a>
			
			<ul id="toc-Zpool_refuses_to_export_saying_it's_busy-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-See_also" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#See_also">
			<div class="vector-toc-text">
				<span class="vector-toc-numb">9</span>
				<span>See also</span>
			</div>
		</a>
		
		<ul id="toc-See_also-sublist" class="vector-toc-list">
		</ul>
	</li>
</ul>
</div>

					</div>
		</nav>
			</div>
		</div>
		<div class="mw-content-container">
			<main id="content" class="mw-body" style="margin: 0">
				<header class="mw-body-header vector-page-titlebar vector-feature-custom-font-size-clientpref--excluded">
					<nav aria-label="Contents" class="vector-toc-landmark">
						
<div id="vector-page-titlebar-toc" class="vector-dropdown vector-page-titlebar-toc vector-button-flush-left" title="Table of Contents">
	<input type="checkbox" id="vector-page-titlebar-toc-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-vector-page-titlebar-toc" class="vector-dropdown-checkbox " aria-label="Toggle the table of contents">
	<label id="vector-page-titlebar-toc-label" for="vector-page-titlebar-toc-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--icon-only " aria-hidden="true"><span class="vector-icon mw-ui-icon-listBullet mw-ui-icon-wikimedia-listBullet"></span>

<span class="vector-dropdown-label-text">Toggle the table of contents</span>
	</label>
	<div class="vector-dropdown-content">


							<div id="vector-page-titlebar-toc-unpinned-container" class="vector-unpinned-container">
			</div>
		
	</div>
</div>

					</nav>
					<h1 id="firstHeading" class="firstHeading mw-first-heading"><span class="mw-page-title-main">Install Arch Linux on ZFS</span></h1>
							
<div id="p-lang-btn" class="vector-dropdown mw-portlet mw-portlet-lang">
	<input type="checkbox" id="p-lang-btn-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-p-lang-btn" class="vector-dropdown-checkbox mw-interlanguage-selector" aria-label="Go to an article in another language. Available in 3 languages">
	<label id="p-lang-btn-label" for="p-lang-btn-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--action-progressive mw-portlet-lang-heading-3" aria-hidden="true"><span class="vector-icon mw-ui-icon-language-progressive mw-ui-icon-wikimedia-language-progressive"></span>

<span class="vector-dropdown-label-text">3 languages</span>
	</label>
	<div class="vector-dropdown-content">

		<div class="vector-menu-content">
			
			<ul class="vector-menu-content-list">
				
				<li class="interlanguage-link interwiki-it mw-list-item"><a href="../it/Install_Arch_Linux_on_ZFS.html" title="Install Arch Linux on ZFS – italiano" lang="it" hreflang="it" data-title="Install Arch Linux on ZFS" data-language-autonym="Italiano" data-language-local-name="italiano" class="interlanguage-link-target"><span>Italiano</span></a></li>
<li class="interlanguage-link interwiki-ja mw-list-item"><a href="https://wiki.archlinux.jp/index.php/ZFS_%E3%81%AB_Arch_Linux_%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB" title="ZFS に Arch Linux をインストール – 日本語" lang="ja" hreflang="ja" data-title="ZFS に Arch Linux をインストール" data-language-autonym="日本語" data-language-local-name="日本語" class="interlanguage-link-target"><span>日本語</span></a></li>
<li class="interlanguage-link interwiki-zh-hans mw-list-item"><a href="https://wiki.archlinuxcn.org/wiki/Install_Arch_Linux_on_ZFS_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)" title="Install Arch Linux on ZFS (简体中文) – 中文（简体）" lang="zh-Hans" hreflang="zh-Hans" data-title="Install Arch Linux on ZFS (简体中文)" data-language-autonym="中文（简体）" data-language-local-name="中文（简体）" class="interlanguage-link-target"><span>中文（简体）</span></a></li>
			</ul>
			
		</div>

	</div>
</div>
</header>
				<div class="vector-column-end vector-feature-custom-font-size-clientpref--excluded">
					<div class="vector-sticky-pinned-container">
						<nav class="vector-page-tools-landmark" aria-label="Page tools">
							<div id="vector-page-tools-pinned-container" class="vector-pinned-container">
				
							</div>
		</nav>
						<nav class="vector-appearance-landmark" aria-label="Appearance">
							<div id="vector-appearance-pinned-container" class="vector-pinned-container">
				<div id="vector-appearance" class="vector-appearance vector-pinnable-element">
	<div class="vector-pinnable-header vector-appearance-pinnable-header vector-pinnable-header-pinned" data-feature-name="appearance-pinned" data-pinnable-element-id="vector-appearance" data-pinned-container-id="vector-appearance-pinned-container" data-unpinned-container-id="vector-appearance-unpinned-container">
	<div class="vector-pinnable-header-label">Appearance</div>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-pin-button" data-event-name="pinnable-header.vector-appearance.pin">move to sidebar</button>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-unpin-button" data-event-name="pinnable-header.vector-appearance.unpin">hide</button>
</div>


</div>

							</div>
		</nav>
					</div>
				</div>
				<div id="bodyContent" class="vector-body" aria-labelledby="firstHeading" data-mw-ve-target-container>
					<div class="vector-body-before-content">
							<div class="mw-indicators">
		</div>

						<div id="siteSub" class="noprint">From ArchWiki</div>
					</div>
					<div id="contentSub"><div id="mw-content-subtitle"></div></div>
					
					
					<div id="mw-content-text" class="mw-body-content">
<div class="mw-content-ltr mw-parser-output" lang="en" dir="ltr">
<div class="archwiki-template-meta-related-articles">
<p>Related articles</p>
<ul>
<li><a href="../en/ZFS.html" title="ZFS">ZFS</a></li>
<li><a href="../en/ZFS/Virtual_disks.html" class="mw-redirect" title="Experimenting with ZFS">Experimenting with ZFS</a></li>
</ul>
</div>
<p>This article details the steps required to install Arch Linux onto a ZFS root filesystem.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note</strong> Blindly copying and pasting this wiki will not work. It is necessary to take the time to understand the boot process, and what is done when creating the pool and datasets. Here are some useful links:
<ul>
<li><a rel="nofollow" class="external text" href="https://www.freebsd.org/doc/handbook/zfs.html">FreeBSD ZFS Handbook</a></li>
<li><a rel="nofollow" class="external text" href="https://github.com/zfsonlinux/zfs/wiki">ZFSOnLinux wiki</a></li>
<li><a rel="nofollow" class="external text" href="http://open-zfs.org/wiki/System_Administration">OpenZFS wiki</a></li>
<li><a rel="nofollow" class="external text" href="https://pthree.org/2012/04/17/install-zfs-on-debian-gnulinux/">Aaron Toponce Install ZFS on Debian GNU/Linux</a></li>
<li><a rel="nofollow" class="external text" href="https://openzfs.github.io/openzfs-docs/Getting%20Started/Arch%20Linux/">OpenZFS documentation for Arch Linux</a></li>
</ul>
</div>
<p>Since ZFS kernel modules are out-of-tree (i.e. not included in the mainline kernel) and Arch Linux is a rolling release distribution, there will often be brief periods when the kernel-specific packages in the external repository are not in sync with those in the Arch repositories. This can sometimes result in the ZFS modules (DKMS packages) failing to compile with the latest kernel. If you always want to use the most recent kernel packages, installing Arch on ZFS might not be ideal.
</p>
<p>See <a href="../en/ZFS.html#Installation" title="ZFS">ZFS#Installation</a> for possible solutions.
</p>
<meta property="mw:PageProp/toc">
<div class="mw-heading mw-heading2"><h2 id="Installation">Installation</h2></div>
<p>To install Arch Linux on ZFS, you need to use an installation medium with the ZFS modules. This may be done using an existing Arch Linux installation, or done using a Virtual Machine, such as VirtualBox or VMware, with an active "Bi-directional share" directory defined and enabled, if you are not on an existing Arch Linux installation.
</p>
<div class="mw-heading mw-heading3"><h3 id="Embedding_ZFS_module_into_custom_archiso">Embedding ZFS module into custom archiso</h3></div>
<p>To build a custom ISO, <a href="../en/Help:Reading.html#Installation_of_packages" class="mw-redirect" title="Install">install</a> <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=archiso">archiso</a></span>. Follow <a href="../en/Archiso.html#Prepare_a_custom_profile" title="Archiso">archiso#Prepare a custom profile</a> to prepare a custom profile (named <code>archlive</code> in the following example).
</p>
<p>First, <a href="../en/Systemd.html#Editing_provided_units" class="mw-redirect" title="Edit">edit</a> the package list file <code>packages.x86_64</code> to add the <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=linux-lts">linux-lts</a></span> kernel and the following ZFS packages:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">packages.x86_64</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">...
linux-lts
linux-lts-headers
libunwind
zfs-utils
zfs-dkms
</pre>
<p>Make sure to remove <code>linux</code> and <code>broadcom-wl</code> (which would pull in the <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=linux">linux</a></span> package) from the list.
</p>
<p>You will also need to edit <code>pacman.conf</code> and append:
</p>
<pre>...
[archzfs]
SigLevel = TrustAll Optional
Server = https://github.com/archzfs/archzfs/releases/download/experimental
</pre>
<p>You will also need to edit the following files to change <code>vmlinuz-linux</code> and <code>initramfs-linux.img</code> entries to <code>vmlinuz-linux-lts</code> and <code>initramfs-linux-lts.img</code>:
</p>
<pre>archlive/airootfs/etc/mkinitcpio.d/linux.preset
archlive/efiboot/loader/entries/01-archiso-linux.conf
archlive/efiboot/loader/entries/02-archiso-speech-linux.conf
archlive/syslinux/archiso_pxe-linux.cfg
archlive/syslinux/archiso_sys-linux.cfg
archlive/grub/loopback.cfg
archlive/grub/grub.cfg
</pre>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning</strong> If you fail to edit these entries your ISO will <b>not</b> boot.</div>
<p>Now we will make an <code>isobuild</code> and <code>work</code> pair of directories to start the build process:
</p>
<pre># mkdir isobuild
# mkarchiso -v -r -w /tmp/archiso-tmp -o isobuild ~/archlive
</pre>
<p>You should now have an <code>archlinux-<i>YYYY</i>.<i>MM</i>.<i>DD</i>.x86_64.iso</code> in the <code>archlive/isobuild</code> directory.
</p>
<p>Burn this file to your installation media of choice.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note</strong> 
<ul>
<li>You may wish to recreate this media occasionally if the <code>zpool status -v</code> output shows, after an update, that the zpool needs to be updated to support newer features.</li>
<li>You should use the <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=linux-lts">linux-lts</a></span> and <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=linux-lts-headers">linux-lts-headers</a></span> for the actual installation for best compatibility. You also should use the <a href="../en/Unofficial_user_repositories.html#archzfs" title="Unofficial user repositories">unofficial archzfs repository</a> for binary packages for <i>zfs-utils</i> and <i>zfs-dkms</i> updates, not the AUR packages. If you do choose to use the AUR packages, there will be times when a new mainline and zen Linux kernel, do not support ZFS, and may break you system. Due to this, the <i>linux-lts</i> kernel is strongly recommended for the actual installation section.</li>
</ul>
</div>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning</strong> Do not redistribute these custom ISOs as they will violate the GPL and CDDL licenses!</div>
<p>Be sure to test your new ISO with a virtual machine and test the ISO. Simply run:
</p>
<pre># modprobe zfs
# zpool status
</pre>
<p>If it fails, then your zfs module did not build correctly, and you will have to try again.
</p>
<div class="mw-heading mw-heading2"><h2 id="Partition_the_destination_drive">Partition the destination drive</h2></div>
<p>ZFS supports GPT and MBR partition tables. See <a href="../en/Partitioning.html#Choosing_between_GPT_and_MBR" title="Partitioning">Partitioning#Choosing between GPT and MBR</a> for information on determining the partition table type to use. 
</p>
<p>ZFS manages its own partitions, so only a basic partition table scheme is required. The partition that will contain the ZFS filesystem should be of the type <code>bf00</code>, or "Solaris Root".
</p>
<div class="mw-heading mw-heading3"><h3 id="Partition_scheme">Partition scheme</h3></div>
<p>Although for some legacy machines you, in the past, with MBR based partitioning methods, you could create a zfs bootable root partition, it is not recommended to use ZFS in this manner due usage of GPT partitioning differences. It is recommended to use a separate /boot partition to avoid issues with bootloaders and ensure best compatibility.
</p>
<p>Using <a href="../en/GRUB.html" title="GRUB">GRUB</a> on a BIOS (or UEFI machine in legacy boot mode) machine but using a GPT partition table:
</p>
<pre>Part     Size   Type
----     ----   -------------------------
   1       2M   BIOS boot partition (ef02)
   2       1G   Linux partition (8300)
   3     XXXG   Solaris Root (bf00)
</pre>
<p>You may also use this method of partitioning with <a href="../en/GRUB.html" class="mw-redirect" title="Grub">Grub</a> and <a href="../en/REFInd.html" title="REFInd">rEFInd</a>. This method is the most recommended by the author for best compatibility with all systems.
</p>
<pre>Part     Size   Type
----     ----   -------------------------
   1       1G   EFI system partition (ef00)
   2     XXXG   Solaris Root (bf00)
</pre>
<p>You can choose to separate Linux swap partition, or using a zvol, see <a href="../en/ZFS.html#Swap_volume" title="ZFS">ZFS#Swap volume</a>, as swap.
</p>
<p>If you wish to create a traditional swap partition, see <a href="../en/Partitioning.html#Example_layouts" title="Partitioning">Partitioning#Example layouts</a>.
</p>
<div class="mw-heading mw-heading2"><h2 id="Format_the_destination_disk">Format the destination disk</h2></div>
<p>If you have opted for a boot partition as well as any other non-ZFS system partitions then format them. Do not do anything to the Solaris partition nor to the BIOS boot partition. ZFS will manage the first, and your boot loader the second.
</p>
<div class="mw-heading mw-heading2"><h2 id="Setup_the_ZFS_filesystem">Setup the ZFS filesystem</h2></div>
<p>First, make sure the ZFS modules are loaded,
</p>
<pre># modprobe zfs
</pre>
<div class="mw-heading mw-heading3"><h3 id="Create_the_root_zpool">Create the root zpool</h3></div>
<p>Create your pool and set all default dataset options. All dataset created on the zpool will inherit of each <code>-O</code> set at the zpool creation. Default options are detailed in <a rel="nofollow" class="external text" href="https://openzfs.github.io/openzfs-docs/Getting%20Started/Debian/Debian%20Buster%20Root%20on%20ZFS.html#step-2-disk-formatting">Debian Buster Root on ZFS. Step 2: Disk Formatting</a>.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note</strong> Use <code>-o ashift=9</code> for disks with a 512 byte physical sector size or <code>-o ashift=12</code> for disks with a 4096 byte physical sector size. See <code>lsblk -S -o NAME,PHY-SEC</code> to get the physical sector size of each SCSI/SATA disk. Remove <code>-S</code> if you want the same value from all devices. For NVMe drives, use <code>nvme id-ns /dev/nvmeXnY -H | grep "LBA Format"</code> to get which LBA format is in use. Most NVMe drives ship with 512-byte sectors, see <a rel="nofollow" class="external text" href="https://openzfs.github.io/openzfs-docs/Performance%20and%20Tuning/Hardware.html#nvme-low-level-formatting">OpenZFS: NVMe low level formatting</a> to switch to 4096-byte sectors.</div>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning</strong> Keep in mind that most modern devices use a 4096 byte physical sector size, even though some report 512. This is especially true for SSDs. Selecting <code>ashift=9</code> on a 4096 byte sector size (even if it reports 512) <b>will</b> incur a performance penalty. Selecting <code>ashift=12</code> on a 512 byte sector size may incur in a capacity penalty, but no performance penalty. If in doubt, for a modern drive, err on the side of <code>ashift=12</code>, or research your particular device for the appropriate value. Refer to <a rel="nofollow" class="external text" href="https://github.com/openzfs/zfs/issues/967">OpenZFS issue #967</a> for a related discussion, and <a rel="nofollow" class="external text" href="https://github.com/openzfs/zfs/issues/2497">OpenZFS issue #2497</a> for a consequence of a higher ashift value.
</div>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning</strong>  In this next section, using a standard device name such <i>/dev/nvme0n1p2</i> instead of <i>/dev/disk/by-id/&lt;device number&gt;</i> to create the zpool, may lead to import problems. If you want to learn your devices correct <i>by-id</i> prior to this section, run:
<p><code>ls -lh /dev/disk/by-id/</code>
</p>
<p>and take note of the correct <i>by-id</i> value to use rather than the standard device naming scheme such as:
</p>
<p><code>lrwxrwxrwx 1 root root  9 Aug 12 16:26 ata-ST3000DM001-9YN166_S1F0JKRR -&gt; ../../sdc</code>
</p>
</div>
<pre># zpool create -f -o ashift=12         \
             -O acltype=posixacl       \
             -O relatime=on            \
             -O xattr=sa               \
             -O dnodesize=auto       \
             -O normalization=formD    \
             -O mountpoint=none        \
             -O canmount=off           \
             -O devices=off            \
             -R /mnt                   \
             zroot /dev/disk/by-id/<i>id-to-partition-partx</i></pre>
<div class="mw-heading mw-heading4"><h4 id="Compression_and_native_encryption">Compression and native encryption</h4></div>
<p>This will enable compression and native encryption by default on all datasets:
</p>
<pre># zpool create -f -o ashift=12         \
             -O acltype=posixacl       \
             -O relatime=on            \
             -O xattr=sa               \
             -O dnodesize=auto       \
             -O normalization=formD    \
             -O mountpoint=none        \
             -O canmount=off           \
             -O devices=off            \
             -R /mnt                   \
             -O compression=lz4        \
             -O encryption=aes-256-gcm \
             -O keyformat=passphrase   \
             -O keylocation=prompt     \
             zroot /dev/disk/by-id/<i>id-to-partition-partx</i></pre>
<p>The options after <code>-O</code> control ZFS behavior. 
A detailed explanation of them can be found in the <span class="plainlinks archwiki-template-man" title="$ man 7 zfsprops"><a rel="nofollow" class="external text" href="https://openzfs.github.io/openzfs-docs/man/master/7/zfsprops.7.html">zfsprops(7)</a></span> man page.
</p>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning</strong> 
<ul>
<li>Always use id names when working with ZFS, otherwise import errors will occur.</li>
<li>Instead of by-id, consider using by-partuuid or by-uuid, as these will stay consistent even if an internal drive is moved into a USB enclosure or vice-versa (this is only possible if ZFS is used with a partition, not with a whole disk).</li>
</ul>
</div>
<div class="mw-heading mw-heading3"><h3 id="Create_your_datasets">Create your datasets</h3></div>
<p>Instead of using conventional disk partitions, ZFS has the concept of datasets to manage your storage. Unlike disk partitions, datasets have no fixed size and allow for different attributes, such as compression, to be applied per dataset. Normal ZFS datasets are mounted automatically by ZFS whilst legacy datasets are required to be mounted using fstab or with the traditional mount command.
</p>
<p>One of the most useful features of ZFS is boot environments. Boot environments allow you to create a bootable snapshot of your system that you can revert to at any time instantly by simply rebooting and booting from that boot environment. This can make doing system updates much safer and is also incredibly useful for developing and testing software. In order to be able to use a boot environment manager such as <a rel="nofollow" class="external text" href="https://github.com/b333z/beadm">beadm</a>, <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/zectl/">zectl</a></span><sup><small>AUR</small></sup> (systemd-boot), or <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/zedenv/">zedenv</a></span><sup><small>AUR</small></sup> (GRUB) to manage boot environments, your datasets must be configured properly. Key to this are that you split your data directories (such as <code>/home</code>) into datasets that are distinct from your system datasets and that you do not place data in the root of the pool as this cannot be moved afterwards.
</p>
<p>You should always create a dataset for at least your root filesystem and in nearly all cases you will also want <code>/home</code> to be in a separate dataset. You may decide you want your logs to persist over boot environments. If you are a running any software that stores data outside of <code>/home</code> (such as is the case for database servers) you should structure your datasets so that the data directories of the software you want to run are separated out from the root dataset.
</p>
<p>With these example commands, we will create a basic boot environment compatible configuration comprising of just root and <code>/home</code> datasets. It inherits default options from <a href="#Create_the_root_zpool">zpool creation.</a>
</p>
<pre># zfs create -o mountpoint=none zroot/data
# zfs create -o mountpoint=none zroot/ROOT
# zfs create -o mountpoint=/ -o canmount=noauto zroot/ROOT/default
# zfs create -o mountpoint=/home zroot/data/home
</pre>
<p>You can also create your ROOT dataset without having to specify mountpoint to / since GRUB will mount it to / anyway. That gives you possibility to boot into some old versions of root just by cloning it and putting as menuentry of GRUB. In such, you can create ROOT with the following command:
</p>
<pre># zfs create -o mountpoint=/roots/default zroot/ROOT/default
</pre>
<p>You can store <code>/root</code> in your <code>zroot/data/home</code> dataset.
</p>
<pre># zfs create -o mountpoint=/root zroot/data/home/root
</pre>
<div class="mw-heading mw-heading4"><h4 id="System_datasets">System datasets</h4></div>
<p>To create datasets for system directories, use <code>canmount=off</code>.
</p>
<p>For some examples, please read <a rel="nofollow" class="external text" href="https://openzfs.github.io/openzfs-docs/Getting%20Started/Debian/Debian%20Buster%20Root%20on%20ZFS.html#step-3-system-installation">Debian-Buster-Root-on-ZFS#step-3-system-installation</a>.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note</strong> Consider using <i>zfs-mount-generator</i> instead of <code>zfs-mount.service</code> if you mount a dataset, e.g. <code>zroot/var/log</code>, to <code>/var/log</code>. It fixes the filesystem mount ordering as described in <a rel="nofollow" class="external text" href="https://openzfs.github.io/openzfs-docs/Getting%20Started/Debian/Debian%20Buster%20Root%20on%20ZFS.html#step-5-grub-installation">Step 5.7 of Debian Buster Root on ZFS</a>.</div>
<pre># zfs create -o mountpoint=/var -o canmount=off                 zroot/var
# zfs create                                                    zroot/var/log
# zfs create -o mountpoint=/var/log/journal -o acltype=posixacl zroot/var/log/journal
# zfs create -o mountpoint=/var/lib -o canmount=off             zroot/var/lib
# zfs create                                                    zroot/var/lib/libvirt
# zfs create                                                    zroot/var/lib/docker
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note</strong> systemd-journald requires a mountpoint to be created otherwise systemd-journald.service will fail at boot <a href="../en/Systemd.html#systemd-tmpfiles-setup.service_fails_to_start_at_boot" title="Systemd">systemd#systemd-tmpfiles-setup.service fails to start at boot</a>
</div>
<div class="mw-heading mw-heading3"><h3 id="Export/Import_your_pools">
<span id="Export.2FImport_your_pools"></span>Export/Import your pools</h3></div>
<p>To validate your configurations, export then reimport all your zpools.
</p>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning</strong> Do not skip this, otherwise you will be required to use <code>-f</code> when importing your pools. This unloads the imported pool.</div>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note</strong> This might fail if you added a swap partition. You need to turn it off with the <i>swapoff</i> command.</div>
<pre># zpool export zroot
# zpool import -d /dev/disk/by-id -R /mnt zroot -N
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note</strong> <code>-d</code> is not the actual device ID, but the <code>/dev/by-id</code> directory containing the symbolic links.
<p>If this command fails and you are asked to import your pool via its numeric ID, run <code>zpool import</code> to find out the ID of your pool then use a command such as:
</p>
<pre># zpool import 9876543212345678910 -R /mnt zroot
</pre>
</div>
<p>If you used native encryption, load zfs key.
</p>
<pre># zfs load-key zroot
</pre>
<p>Manually mount your rootfs dataset because it uses <code>canmount=noauto</code>, then mount all others datasets.
</p>
<pre># zfs mount zroot/ROOT/default
# zfs mount -a
</pre>
<p>The ZFS filesystem is now ready to use.
</p>
<div class="mw-heading mw-heading3"><h3 id="Configure_the_root_filesystem">Configure the root filesystem</h3></div>
<p>If you used legacy datasets, it must be listed in <code>/etc/fstab</code>.
</p>
<p>Set the bootfs property on the descendant root filesystem so the boot loader knows where to find the operating system.
</p>
<pre># zpool set bootfs=zroot/ROOT/default zroot
</pre>
<p>If you do not have <code>/etc/zfs/zpool.cache</code>, create it:
</p>
<pre># zpool set cachefile=/etc/zfs/zpool.cache zroot
</pre>
<p>Be sure to bring the <code>zpool.cache</code> file into your new system. This is required later for the ZFS daemon to start.
</p>
<pre># mkdir -p /mnt/etc/zfs
# cp /etc/zfs/zpool.cache /mnt/etc/zfs/zpool.cache
</pre>
<div class="mw-heading mw-heading2"><h2 id="Install_and_configure_Arch_Linux">Install and configure Arch Linux</h2></div>
<p>Follow the following steps using the <a href="../en/Installation_guide.html" title="Installation guide">Installation guide</a>. It will be noted where special consideration must be taken for ZFSonLinux.
</p>
<ul><li>First mount any legacy or non-ZFS boot or system partitions using the mount command.</li></ul>
<ul><li>Install the base system.</li></ul>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note</strong> You may wish to opt for <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=linux-lts">linux-lts</a></span> for your kernel of choice during the <code>pacstrap</code> portion. Make sure to also add <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=libunwind">libunwind</a></span> to pacstrap to resolve a dependency for <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/zfs-utils/">zfs-utils</a></span><sup><small>AUR</small></sup>.</div>
<ul><li>The procedure described in <a href="../en/Installation_guide.html#Fstab" title="Installation guide">Installation guide#Fstab</a> is usually overkill for ZFS. ZFS usually auto mounts its own partitions, so we do not need ZFS partitions in <code>fstab</code> file, unless the user made legacy datasets of system directories. To generate the <code>fstab</code> for filesystems, use:</li></ul>
<pre># genfstab -U -p /mnt &gt;&gt; /mnt/etc/fstab
</pre>
<ul><li>Change root into the new system, per <a href="../en/Installation_guide.html#Chroot" title="Installation guide">Installation guide#Chroot</a>:</li></ul>
<pre># arch-chroot /mnt
</pre>
<ul><li>Edit the <code>/etc/fstab</code>:</li></ul>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note</strong> 
<ul>
<li>If you chose to create legacy datasets for system directories, keep them in this <code>fstab</code>!</li>
<li>Comment out all non-legacy datasets apart from the swap file and the EFI system partition. It is a convention to replace the swap's uuid with <code>/dev/zvol/zroot/swap</code>.</li>
</ul>
</div>
<ul><li>You need to add the <a href="../en/Unofficial_user_repositories.html#archzfs" title="Unofficial user repositories">Arch ZFS</a> repository to <code>/etc/pacman.conf</code>, <a href="../en/Pacman/Package_signing.html#Adding_unofficial_keys" class="mw-redirect" title="Package signing">sign its key</a> and <a href="../en/Help:Reading.html#Installation_of_packages" class="mw-redirect" title="Install">install</a> <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/zfs-dkms/">zfs-dkms</a></span><sup><small>AUR</small></sup> as well as <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/zfs-utils/">zfs-utils</a></span><sup><small>AUR</small></sup> within the arch-chroot before you can update the ramdisk with ZFS support.</li></ul>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note</strong> For simplicity, and better compatibility, this guide only recommends using the <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/zfs-dkms/">zfs-dkms</a></span><sup><small>AUR</small></sup> package for usage with <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=linux-lts">linux-lts</a></span>.</div>
<ul><li>When creating the initial ramdisk, first edit <code>/etc/mkinitcpio.conf</code>. Add <code>zfs</code> to <code>MODULES</code>:</li></ul>
<pre>MODULES=(zfs)
</pre>
<p>Then in <code>HOOKS</code>, add <code>zfs</code> before filesystems. Also, move <code>keyboard</code> hook before <code>zfs</code> so you can type in console if something goes wrong. You may also remove fsck (if you are not using Ext3 or Ext4). Your <code>HOOKS</code> line should look something like the following:
</p>
<pre>HOOKS=(base udev autodetect microcode modconf kms keyboard keymap consolefont block zfs filesystems)
</pre>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning</strong> Recent installations of Arch Linux uses a <a href="../en/Mkinitcpio.html" title="Mkinitcpio">systemd initramfs</a>. The ZFS hook provided by <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/zfs-utils/">zfs-utils</a></span><sup><small>AUR</small></sup> is only compatible with busybox initramfs. Unless you plan to use a different ZFS hook compatible with systemd, <b>please make sure to copy exactly the hooks above.</b> </div>
<ul><li>
<a href="../en/Mkinitcpio.html#Image_creation_and_activation" class="mw-redirect" title="Regenerate the initramfs">Regenerate the initramfs</a>.</li></ul>
<ul><li>Add ZFS to your kernel command line</li></ul>
<p>You can now set up your <a href="../en/Arch_boot_process.html#Boot_loader" class="mw-redirect" title="Boot loader">boot loader</a>. You also need to add a <a href="../en/Kernel_parameters.html" class="mw-redirect" title="Kernel parameter">kernel parameter</a> to make ZFS bootable:
</p>
<pre>root=ZFS=zroot/ROOT/default rw
</pre>
<div class="mw-heading mw-heading2"><h2 id="Configure_systemd_ZFS_mounts">Configure systemd ZFS mounts</h2></div>
<p>For your system to be able to reboot without issues, you need to enable the <code>zfs.target</code> to auto mount the pools and set the hostid.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note</strong> 
<ul>
<li>The instructions in this section assume you are still in <code>arch-chroot</code>.</li>
<li>Usage of zpool.cache is still required by zfs-utils to achieve a bootable system, although zpool.cache has been considered a candidate for deprecation [See: <a rel="nofollow" class="external free" href="https://github.com/openzfs/zfs/issues/1035">https://github.com/openzfs/zfs/issues/1035</a>], however at this time, it is still the default and recommended method to achieving a bootable system.</li>
</ul>
</div>
<p>For each pool you want automatically mounted execute:
</p>
<pre># zpool set cachefile=/etc/zfs/zpool.cache <i>pool</i>
</pre>
<p><a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Enable">Enable</a> <code>zfs.target</code>
</p>
<p>In order to mount zfs pools automatically on boot you need to <a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Enable">enable</a><code>zfs-import-cache.service</code>, <code>zfs-mount.service</code> and <code>zfs-import.target</code>.
</p>
<p>When running ZFS on root, the machine's hostid will not be available at the time of mounting the root filesystem. There are two solutions to this. You can either place your spl hostid in the <a href="../en/Kernel_parameters.html" title="Kernel parameters">kernel parameters</a> in your boot loader. For example, adding <code>spl.spl_hostid=0x00bab10c</code>, to get your number use the <code>hostid</code> command.
</p>
<p>The other, and suggested, solution is to make sure that there is a hostid in <code>/etc/hostid</code>, and then regenerate the initramfs image which will copy the hostid into the initramfs image. To write the hostid file safely you need to use the <code>zgenhostid</code> command.
</p>
<p>To use the libc-generated hostid (recommended):
</p>
<pre># zgenhostid $(hostid)
</pre>
<p>To use a custom hostid (must be hexadecimal and 8 characters long):
</p>
<pre># zgenhostid deadbeef
</pre>
<p>To let the tool generate a hostid:
</p>
<pre># zgenhostid
</pre>
<p>Do not forget to <a href="../en/Mkinitcpio.html#Image_creation_and_activation" class="mw-redirect" title="Regenerate the initramfs">regenerate the initramfs</a>.
</p>
<div class="mw-heading mw-heading2"><h2 id="Unmount_and_restart">Unmount and restart</h2></div>
<p>We are almost done! If you have a legacy boot partition:
</p>
<pre># umount /mnt/boot
</pre>
<p>Otherwise:
</p>
<pre># zfs umount -a
# zfs umount zroot/ROOT/default
# zpool export zroot
</pre>
<p>Now reboot.
</p>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning</strong> If you do not properly export the zpool, the pool will refuse to import in the ramdisk environment and you will be stuck at the busybox terminal.</div>
<div class="mw-heading mw-heading3"><h3 id="Loading_password_from_USB-Stick">Loading password from USB-Stick</h3></div>
<p>It is possible to store password on usb-stick and load it when booting:
</p>
<p>Save password on first bytes of usb-stick:
</p>
<pre># dd if=<i>your_password_file</i> bs=32 count=1 of=/dev/disk/by-id/<i>usb_stick</i>
</pre>
<p>To create partition zfs partition you can either use previous described method with password prompt or pipe with <a href="../en/Dd.html" title="Dd">dd</a>:
</p>
<pre># dd if=/dev/disk/by-id/<i>usb_stick</i> bs=32 count=1 | zfs create -o encryption=on -o keyformat=<i>passphrase</i> zroot/ROOT
</pre>
<p>Next step is modyfing zfs hook. By default zfs prompts for password. You have to change it to have it piped with dd from your pendrive. In order to do so modify <code>/usr/lib/initcpio/hooks/zfs</code> and change line:
</p>
<pre># ! eval zfs load-key "${encryptionroot}"; do
</pre>
<p>to:
</p>
<pre># ! eval dd if=/dev/disk/by-id/<i>usb_stick</i> bs=32 count=1 | zfs load-key "${encryptionroot}"; do
</pre>
<p>You are modifying your zfs hook so do not forget to <a href="../en/Mkinitcpio.html#Image_creation_and_activation" class="mw-redirect" title="Regenerate the initramfs">regenerate the initramfs</a>. Now zfs should load password from your usb-stick on boot.
</p>
<div class="mw-heading mw-heading2"><h2 id="Troubleshooting">Troubleshooting</h2></div>
<div class="mw-heading mw-heading3"><h3 id="System_fails_to_boot_due_to:_cannot_import_zroot:_no_such_pool_available">System fails to boot due to: cannot import zroot: no such pool available</h3></div>
<p>You can try the following steps and see if they can help.
</p>
<ul>
<li>Use the kernel modules from the <a href="../en/Unofficial_user_repositories.html#archzfs" title="Unofficial user repositories">archzfs repo</a> instead of the dkms version. You can go back to the dkms version after a sucessfull boot.</li>
<li>Remove the <code>/etc/zfs/zpool.cache</code> and run: <pre># zpool set cachefile=none zroot</pre>
</li>
<li>Remove the <code>/etc/hostid</code>.</li>
<li>
<a href="../en/Mkinitcpio.html#Image_creation_and_activation" class="mw-redirect" title="Regenerate the initramfs">Regenerate the initramfs</a>.</li>
</ul>
<div class="mw-heading mw-heading3"><h3 id="Zpool_refuses_to_export_saying_it's_busy">
<span id="Zpool_refuses_to_export_saying_it.27s_busy"></span>Zpool refuses to export saying it's busy</h3></div>
<p>Arch-chroot will mount specific kernelspace file systems in the system. If these are not unmounted, the zpool may refuse to dismount properly. If this happens, remount the ZFS partition and run <code>findmnt -R /mnt</code>
</p>
<p>Then run <code>umount -f <i>/path/to/partition</i></code> against the partition still mounted.
</p>
<p>This should allow the zpool to export.
</p>
<div class="mw-heading mw-heading2"><h2 id="See_also">See also</h2></div>
<ul>
<li><a rel="nofollow" class="external text" href="https://github.com/dajhorn/pkg-zfs/wiki/HOWTO-install-Ubuntu-to-a-Native-ZFS-Root-Filesystem">HOWTO install Ubuntu to a Native ZFS Root</a></li>
<li><a rel="nofollow" class="external text" href="https://lildude.co.uk/zfs-cheatsheet">ZFS cheatsheet</a></li>
<li><a href="https://www.funtoo.org/ZFS_Install_Guide" class="extiw" title="funtoo:ZFS Install Guide">Funtoo:ZFS Install Guide</a></li>
<li><a rel="nofollow" class="external text" href="https://kiljan.org/2018/09/23/a-reference-guide-to-zfs-on-arch-linux/">A reference guide to ZFS on Arch Linux</a></li>
<li><a rel="nofollow" class="external text" href="https://ramsdenj.com/2016/06/23/arch-linux-on-zfs-part-2-installation.html">Arch Linux On Zfs </a></li>
<li><a rel="nofollow" class="external text" href="https://www.youtube.com/watch?v=mLbtJQmfumI">Youtube: Open-ZFS Bootcamp</a></li>
</ul>
</div>
</div>
					<div id="catlinks" class="catlinks" data-mw="interface"><div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../Special:Categories.html" title="Special:Categories">Category</a>: <ul><li><a href="../en/Category:Installation_process.html" title="Category:Installation process">Installation process</a></li></ul>
</div></div>
				</div>
			</main>
			
		</div>
		<div class="mw-footer-container">
			
<footer id="footer" class="mw-footer" style="margin: 0">
	<ul id="footer-info">
	<li data-nosnippet="">Retrieved from "<a dir="ltr" href="https://wiki.archlinux.org/index.php?title=Install_Arch_Linux_on_ZFS&amp;oldid=853495">https://wiki.archlinux.org/index.php?title=Install_Arch_Linux_on_ZFS&amp;oldid=853495</a>"</li>
<li id="footer-info-lastmod"> This page was last edited on 18 November 2025, at 17:40.</li>
	<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="https://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.3 or later</a> unless otherwise noted.</li>
<br>
</ul>

	<ul id="footer-places">
	<li id="footer-places-privacy"><a href="https://terms.archlinux.org/docs/privacy-policy/">Privacy policy</a></li>
	<li id="footer-places-about"><a href="../en/ArchWiki:About.html">About ArchWiki</a></li>
	<li id="footer-places-disclaimers"><a href="../en/ArchWiki:General_disclaimer.html">Disclaimers</a></li>
	<li id="footer-places-archwiki-code-of-conduct"><a href="https://terms.archlinux.org/docs/code-of-conduct/" class="extiw" title="archlinux-service-agreements:code-of-conduct">Code of conduct</a></li>
	<li id="footer-places-archwiki-terms-of-service"><a href="https://terms.archlinux.org/docs/terms-of-service/" class="extiw" title="archlinux-service-agreements:terms-of-service">Terms of service</a></li>
</ul>

	<ul id="footer-icons" class="noprint">
	<li id="footer-copyrightico"><a href="https://www.gnu.org/copyleft/fdl.html" class="cdx-button cdx-button--fake-button cdx-button--size-large cdx-button--fake-button--enabled"><img src="/resources/assets/licenses/gnu-fdl.png" alt="GNU Free Documentation License 1.3 or later" width="88" height="31" loading="lazy"></a></li>
	<li id="footer-poweredbyico"><picture><source media="(min-width: 500px)" srcset="/resources/assets/poweredby_mediawiki.svg" width="88" height="31"><img src="/resources/assets/mediawiki_compact.svg" width="25" height="25" loading="lazy"></picture></li>
</ul>

</footer>

		</div>
	</div> 
</div> 
<div class="vector-header-container vector-sticky-header-container">
	<div id="vector-sticky-header" class="vector-sticky-header">
		<div class="vector-sticky-header-start">
			<div class="vector-sticky-header-icon-start vector-button-flush-left vector-button-flush-right" aria-hidden="true">
				<button class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-sticky-header-search-toggle" tabindex="-1" data-event-name="ui.vector-sticky-search-form.icon"><span class="vector-icon mw-ui-icon-search mw-ui-icon-wikimedia-search"></span>

<span>Search</span>
			</button>
		</div>
			
		<div role="search" class="vector-search-box-vue vector-search-box">
			<div class="vector-typeahead-search-container">
				<div class="cdx-typeahead-search">
					<form action="/index.php" id="vector-sticky-search-form" class="cdx-search-input cdx-search-input--has-end-button">
						<div class="cdx-search-input__input-wrapper" data-search-loc="header-moved">
							<div class="cdx-text-input cdx-text-input--has-start-icon">
								<input class="cdx-text-input__input" type="search" name="search" placeholder="Search ArchWiki">
								<span class="cdx-text-input__icon cdx-text-input__start-icon"></span>
							</div>
							<input type="hidden" name="title" value="Special:Search">
						</div>
						<button class="cdx-button cdx-search-input__end-button">Search</button>
					</form>
				</div>
			</div>
		</div>
		<div class="vector-sticky-header-context-bar">
				<nav aria-label="Contents" class="vector-toc-landmark">
						
					<div id="vector-sticky-header-toc" class="vector-dropdown mw-portlet mw-portlet-sticky-header-toc vector-sticky-header-toc vector-button-flush-left">
						<input type="checkbox" id="vector-sticky-header-toc-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-vector-sticky-header-toc" class="vector-dropdown-checkbox " aria-label="Toggle the table of contents">
						<label id="vector-sticky-header-toc-label" for="vector-sticky-header-toc-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--icon-only " aria-hidden="true"><span class="vector-icon mw-ui-icon-listBullet mw-ui-icon-wikimedia-listBullet"></span>

<span class="vector-dropdown-label-text">Toggle the table of contents</span>
						</label>
						<div class="vector-dropdown-content">
					
						<div id="vector-sticky-header-toc-unpinned-container" class="vector-unpinned-container">
						</div>
					
						</div>
					</div>
			</nav>
				<div class="vector-sticky-header-context-bar-primary" aria-hidden="true"><span class="mw-page-title-main">Install Arch Linux on ZFS</span></div>
			</div>
		</div>
		<div class="vector-sticky-header-end" aria-hidden="true">
			<div class="vector-sticky-header-icons">
				<a href="#" class="cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--icon-only" id="ca-talk-sticky-header" tabindex="-1" data-event-name="talk-sticky-header"><span class="vector-icon mw-ui-icon-speechBubbles mw-ui-icon-wikimedia-speechBubbles"></span>

<span></span>
			</a>
			<a href="#" class="cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--icon-only" id="ca-subject-sticky-header" tabindex="-1" data-event-name="subject-sticky-header"><span class="vector-icon mw-ui-icon-article mw-ui-icon-wikimedia-article"></span>

<span></span>
			</a>
			<a href="#" class="cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--icon-only" id="ca-history-sticky-header" tabindex="-1" data-event-name="history-sticky-header"><span class="vector-icon mw-ui-icon-wikimedia-history mw-ui-icon-wikimedia-wikimedia-history"></span>

<span></span>
			</a>
			<a href="#" class="cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--icon-only mw-watchlink" id="ca-watchstar-sticky-header" tabindex="-1" data-event-name="watch-sticky-header"><span class="vector-icon mw-ui-icon-wikimedia-star mw-ui-icon-wikimedia-wikimedia-star"></span>

<span></span>
			</a>
			<a href="#" class="cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--icon-only" id="ca-edit-sticky-header" tabindex="-1" data-event-name="wikitext-edit-sticky-header"><span class="vector-icon mw-ui-icon-wikimedia-wikiText mw-ui-icon-wikimedia-wikimedia-wikiText"></span>

<span></span>
			</a>
			<a href="#" class="cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--icon-only" id="ca-ve-edit-sticky-header" tabindex="-1" data-event-name="ve-edit-sticky-header"><span class="vector-icon mw-ui-icon-wikimedia-edit mw-ui-icon-wikimedia-wikimedia-edit"></span>

<span></span>
			</a>
			<a href="#" class="cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--icon-only" id="ca-viewsource-sticky-header" tabindex="-1" data-event-name="ve-edit-protected-sticky-header"><span class="vector-icon mw-ui-icon-wikimedia-editLock mw-ui-icon-wikimedia-wikimedia-editLock"></span>

<span></span>
			</a>
		</div>
			<div class="vector-sticky-header-buttons">
				<a href="#" class="cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--action-progressive" id="ca-addsection-sticky-header" tabindex="-1" data-event-name="addsection-sticky-header"><span class="vector-icon mw-ui-icon-speechBubbleAdd-progressive mw-ui-icon-wikimedia-speechBubbleAdd-progressive"></span>

<span>Add topic</span>
			</a>
		</div>
			<div class="vector-sticky-header-icon-end">
				<div class="vector-user-links">
				</div>
			</div>
		</div>
	</div>
</div>
<div class="mw-portlet mw-portlet-dock-bottom emptyPortlet" id="p-dock-bottom">
	<ul>
		
	</ul>
</div>
</body>
</html>
