<!DOCTYPE html>
<html class="client-nojs vector-feature-language-in-header-enabled vector-feature-language-in-main-page-header-disabled vector-feature-sticky-header-disabled vector-feature-page-tools-pinned-disabled vector-feature-toc-pinned-clientpref-1 vector-feature-main-menu-pinned-disabled vector-feature-limited-width-clientpref-1 vector-feature-limited-width-content-enabled vector-feature-custom-font-size-clientpref-0 vector-feature-client-preferences-disabled vector-feature-client-prefs-pinned-disabled vector-feature-night-mode-disabled skin-theme-clientpref-day vector-toc-available" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>Install Arch Linux on ZFS - ArchWiki</title>
<link rel="stylesheet" href="../ArchWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<meta name="generator" content="MediaWiki 1.42.4">
<meta name="referrer" content="no-referrer-when-downgrade">
<meta name="robots" content="max-image-preview:standard">
<meta name="format-detection" content="telephone=no">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=0.25, maximum-scale=5.0">
<link rel="icon" href="/favicon.ico">
<link rel="search" type="application/opensearchdescription+xml" href="/opensearch_desc.php" title="ArchWiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.archlinux.org/api.php?action=rsd">
<link rel="license" href="https://www.gnu.org/copyleft/fdl.html">
<link rel="alternate" type="application/atom+xml" title="ArchWiki Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="skin-vector skin-vector-search-vue mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-Install_Arch_Linux_on_ZFS rootpage-Install_Arch_Linux_on_ZFS skin-vector-2022 action-view skin--responsive">
<a class="mw-jump-link" href="#bodyContent">Jump to content</a>
<div class="vector-header-container">
	</div>
<div class="mw-page-container">
	<div class="mw-page-container-inner">
		<div class="vector-column-start">
			<div class="vector-main-menu-container">
		</div>
	<div class="vector-sticky-pinned-container">
				<nav id="mw-panel-toc" role="navigation" aria-label="Contents" data-event-name="ui.sidebar-toc" class="mw-table-of-contents-container vector-toc-landmark">
					<div id="vector-toc-pinned-container" class="vector-pinned-container">
					<div id="vector-toc" class="vector-toc vector-pinnable-element">
	<div class="vector-pinnable-header vector-toc-pinnable-header vector-pinnable-header-pinned" data-feature-name="toc-pinned" data-pinnable-element-id="vector-toc">
	<h2 class="vector-pinnable-header-label">Contents</h2>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-pin-button" data-event-name="pinnable-header.vector-toc.pin">move to sidebar</button>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-unpin-button" data-event-name="pinnable-header.vector-toc.unpin">hide</button>
</div>


	<ul class="vector-toc-contents" id="mw-panel-toc-list">
		<li id="toc-mw-content-text" class="vector-toc-list-item vector-toc-level-1">
			<a href="#" class="vector-toc-link">
				<div class="vector-toc-text">Beginning</div>
			</a>
		</li>
		<li id="toc-Acquire_installation_medium" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#Acquire_installation_medium">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">1</span>Acquire installation medium</div>
		</a>
		
			<button aria-controls="toc-Acquire_installation_medium-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Acquire installation medium subsection</span>
			</button>
		
		<ul id="toc-Acquire_installation_medium-sublist" class="vector-toc-list">
			<li id="toc-Use_an_unofficial_archiso_that_includes_ZFS_modules" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Use_an_unofficial_archiso_that_includes_ZFS_modules">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">1.1</span>Use an unofficial archiso that includes ZFS modules</div>
			</a>
			
			<ul id="toc-Use_an_unofficial_archiso_that_includes_ZFS_modules-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Use_ISOs_from_other_distros" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Use_ISOs_from_other_distros">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">1.2</span>Use ISOs from other distros</div>
			</a>
			
			<ul id="toc-Use_ISOs_from_other_distros-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Embedding_ZFS_module_into_custom_archiso" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Embedding_ZFS_module_into_custom_archiso">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">1.3</span>Embedding ZFS module into custom archiso</div>
			</a>
			
			<ul id="toc-Embedding_ZFS_module_into_custom_archiso-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Select_boot_method" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#Select_boot_method">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">2</span>Select boot method</div>
		</a>
		
			<button aria-controls="toc-Select_boot_method-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Select boot method subsection</span>
			</button>
		
		<ul id="toc-Select_boot_method-sublist" class="vector-toc-list">
			<li id="toc-Initrd_tools" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Initrd_tools">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.1</span>Initrd tools</div>
			</a>
			
			<ul id="toc-Initrd_tools-sublist" class="vector-toc-list">
				<li id="toc-zfs_hook" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#zfs_hook">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.1.1</span>zfs hook</div>
			</a>
			
			<ul id="toc-zfs_hook-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-sd-zfs_hook" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#sd-zfs_hook">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.1.2</span>sd-zfs hook</div>
			</a>
			
			<ul id="toc-sd-zfs_hook-sublist" class="vector-toc-list">
				<li id="toc-zfs-utils-poscat" class="vector-toc-list-item vector-toc-level-4">
			<a class="vector-toc-link" href="#zfs-utils-poscat">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.1.2.1</span>zfs-utils-poscat</div>
			</a>
			
			<ul id="toc-zfs-utils-poscat-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-mkinitcpio-sd-zfs" class="vector-toc-list-item vector-toc-level-4">
			<a class="vector-toc-link" href="#mkinitcpio-sd-zfs">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.1.2.2</span>mkinitcpio-sd-zfs</div>
			</a>
			
			<ul id="toc-mkinitcpio-sd-zfs-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-zfs_module" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#zfs_module">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.1.3</span>zfs module</div>
			</a>
			
			<ul id="toc-zfs_module-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Boot_loaders" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Boot_loaders">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.2</span>Boot loaders</div>
			</a>
			
			<ul id="toc-Boot_loaders-sublist" class="vector-toc-list">
				<li id="toc-Using_GRUB2" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Using_GRUB2">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.2.1</span>Using GRUB2</div>
			</a>
			
			<ul id="toc-Using_GRUB2-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Partition_the_destination_drive" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#Partition_the_destination_drive">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">3</span>Partition the destination drive</div>
		</a>
		
			<button aria-controls="toc-Partition_the_destination_drive-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Partition the destination drive subsection</span>
			</button>
		
		<ul id="toc-Partition_the_destination_drive-sublist" class="vector-toc-list">
			<li id="toc-Layout_supporting_full_system_rollback" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Layout_supporting_full_system_rollback">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.1</span>Layout supporting full system rollback</div>
			</a>
			
			<ul id="toc-Layout_supporting_full_system_rollback-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Set_up_the_ZFS_filesystem" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#Set_up_the_ZFS_filesystem">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">4</span>Set up the ZFS filesystem</div>
		</a>
		
			<button aria-controls="toc-Set_up_the_ZFS_filesystem-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Set up the ZFS filesystem subsection</span>
			</button>
		
		<ul id="toc-Set_up_the_ZFS_filesystem-sublist" class="vector-toc-list">
			<li id="toc-Enable_ZED_on_live_CD" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Enable_ZED_on_live_CD">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">4.1</span>Enable ZED on live CD</div>
			</a>
			
			<ul id="toc-Enable_ZED_on_live_CD-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Create_the_root_pool" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Create_the_root_pool">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">4.2</span>Create the root pool</div>
			</a>
			
			<ul id="toc-Create_the_root_pool-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Create_filesystems" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Create_filesystems">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">4.3</span>Create filesystems</div>
			</a>
			
			<ul id="toc-Create_filesystems-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Install_and_configure_Arch_Linux" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#Install_and_configure_Arch_Linux">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">5</span>Install and configure Arch Linux</div>
		</a>
		
			<button aria-controls="toc-Install_and_configure_Arch_Linux-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Install and configure Arch Linux subsection</span>
			</button>
		
		<ul id="toc-Install_and_configure_Arch_Linux-sublist" class="vector-toc-list">
			<li id="toc-Install_ZFS" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Install_ZFS">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">5.1</span>Install ZFS</div>
			</a>
			
			<ul id="toc-Install_ZFS-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Configure_ZFS" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Configure_ZFS">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">5.2</span>Configure ZFS</div>
			</a>
			
			<ul id="toc-Configure_ZFS-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Set_up_the_initrd" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Set_up_the_initrd">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">5.3</span>Set up the initrd</div>
			</a>
			
			<ul id="toc-Set_up_the_initrd-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Populate_the_zfs-list_cache" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Populate_the_zfs-list_cache">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">5.4</span>Populate the zfs-list cache</div>
			</a>
			
			<ul id="toc-Populate_the_zfs-list_cache-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Unmount,_export_and_reboot" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Unmount,_export_and_reboot">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">5.5</span>Unmount, export and reboot</div>
			</a>
			
			<ul id="toc-Unmount,_export_and_reboot-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
</ul>
</div>

					</div>
		</nav>
			</div>
		</div>
		<div class="mw-content-container">
			<main id="content" class="mw-body" role="main" style="margin: 0">
				<header class="mw-body-header vector-page-titlebar">
					<nav role="navigation" aria-label="Contents" class="vector-toc-landmark">
						
<div id="vector-page-titlebar-toc" class="vector-dropdown vector-page-titlebar-toc vector-button-flush-left">
	<input type="checkbox" id="vector-page-titlebar-toc-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-vector-page-titlebar-toc" class="vector-dropdown-checkbox " aria-label="Toggle the table of contents">
	<label id="vector-page-titlebar-toc-label" for="vector-page-titlebar-toc-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--icon-only " aria-hidden="true"><span class="vector-icon mw-ui-icon-listBullet mw-ui-icon-wikimedia-listBullet"></span>

<span class="vector-dropdown-label-text">Toggle the table of contents</span>
	</label>
	<div class="vector-dropdown-content">


							<div id="vector-page-titlebar-toc-unpinned-container" class="vector-unpinned-container">
			</div>
		
	</div>
</div>

					</nav>
					<h1 id="firstHeading" class="firstHeading mw-first-heading"><span class="mw-page-title-main">Install Arch Linux on ZFS</span></h1>
							
<div id="p-lang-btn" class="vector-dropdown mw-portlet mw-portlet-lang">
	<input type="checkbox" id="p-lang-btn-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-p-lang-btn" class="vector-dropdown-checkbox mw-interlanguage-selector" aria-label="Go to an article in another language. Available in 3 languages">
	<label id="p-lang-btn-label" for="p-lang-btn-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--action-progressive mw-portlet-lang-heading-3" aria-hidden="true"><span class="vector-icon mw-ui-icon-language-progressive mw-ui-icon-wikimedia-language-progressive"></span>

<span class="vector-dropdown-label-text">3 languages</span>
	</label>
	<div class="vector-dropdown-content">

		<div class="vector-menu-content">
			
			<ul class="vector-menu-content-list">
				
				<li class="interlanguage-link interwiki-it mw-list-item"><a href="../it/Install_Arch_Linux_on_ZFS.html" title="Install Arch Linux on ZFS – italiano" lang="it" hreflang="it" class="interlanguage-link-target"><span>Italiano</span></a></li>
<li class="interlanguage-link interwiki-ja mw-list-item"><a href="https://wiki.archlinux.jp/index.php/ZFS_%E3%81%AB_Arch_Linux_%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB" title="ZFS に Arch Linux をインストール – 日本語" lang="ja" hreflang="ja" class="interlanguage-link-target"><span>日本語</span></a></li>
<li class="interlanguage-link interwiki-zh-hans mw-list-item"><a href="https://wiki.archlinuxcn.org/wiki/Install_Arch_Linux_on_ZFS_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)" title="Install Arch Linux on ZFS (简体中文) – 中文（简体）" lang="zh-Hans" hreflang="zh-Hans" class="interlanguage-link-target"><span>中文（简体）</span></a></li>
			</ul>
			
		</div>

	</div>
</div>
</header>
				<div class="vector-column-end">
					<div class="vector-sticky-pinned-container">
						<nav class="vector-page-tools-landmark" aria-label="Page tools">
							<div id="vector-page-tools-pinned-container" class="vector-pinned-container">
				
							</div>
		</nav>
						<nav class="vector-client-prefs-landmark" aria-label="Appearance">
						</nav>
					</div>
				</div>
				<div id="bodyContent" class="vector-body" aria-labelledby="firstHeading" data-mw-ve-target-container>
					<div class="vector-body-before-content">
							<div class="mw-indicators">
		</div>

						<div id="siteSub" class="noprint">From ArchWiki</div>
					</div>
					<div id="contentSub"><div id="mw-content-subtitle"></div></div>
					
					
					<div id="mw-content-text" class="mw-body-content">
<div class="mw-content-ltr mw-parser-output" lang="en" dir="ltr">
<div class="archwiki-template-meta-related-articles">
<p>Related articles</p>
<ul>
<li><a href="../en/ZFS.html" title="ZFS">ZFS</a></li>
<li><a href="../en/ZFS/Virtual_disks.html" class="mw-redirect" title="Experimenting with ZFS">Experimenting with ZFS</a></li>
</ul>
</div>
<p>This article details the steps required to install Arch Linux onto a ZFS root filesystem.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> This guide assumes the reader is somewhat familiar with ZFS. If you are not, it is recommended to first read and understand <a href="../en/ZFS.html#Concepts" title="ZFS">ZFS#Concepts</a> and come back to this guide later. It might also be helpful to install ZFS on an existing system and play around with the commands first.
</div>
<p>Since ZFS kernel modules are out-of-tree (i.e. not included in the mainline kernel) and Arch Linux is a rolling release distribution, there will often be brief periods when the kernel-specific packages in the external repository are not in sync with those in the Arch repositories. This can sometimes result in the ZFS modules (DKMS packages) failing to compile with the latest kernel. If you always want to use the most recent kernel packages, installing Arch on ZFS might not be ideal.
</p>
<p>See <a href="../en/ZFS.html#Installation" title="ZFS">ZFS#Installation</a> for possible solutions.
</p>
<meta property="mw:PageProp/toc">
<h2><span class="mw-headline" id="Acquire_installation_medium">Acquire installation medium</span></h2>
<p>To install Arch Linux on ZFS, you need to use an installation medium with the ZFS modules. The easiest way would be to <a href="#Use_an_unofficial_archiso_that_includes_ZFS_modules">use an alternative iso</a> instead (assuming you trust such ISOs). You can also use ISOs from other distribution that support ZFS such as Ubuntu or NixOS or create a custom image (see below).
</p>
<h3><span class="mw-headline" id="Use_an_unofficial_archiso_that_includes_ZFS_modules">Use an unofficial archiso that includes ZFS modules</span></h3>
<p>An unofficial archiso exists that can be used directly, without the need to manually create an entire image or add ZFS modules once booted. Do note however that it includes only the linux-lts kernel and zfs-linux-lts module.
</p>
<p>See <a rel="nofollow" class="external text" href="https://github.com/r-maerz/archlinux-lts-zfs">r-maerz/archlinux-lts-zfs</a>.
</p>
<h3><span class="mw-headline" id="Use_ISOs_from_other_distros">Use ISOs from other distros</span></h3>
<p>You could also choose distros with ISO that has ZFS modules built-in since most distros should have <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=arch-install-scripts">arch-install-scripts</a></span> packaged. For example both Ubuntu ISOs and NixOS ISOs should just work. Just remember to change or skip some of the steps in the installation guide such as network configuration as needed.
</p>
<h3><span class="mw-headline" id="Embedding_ZFS_module_into_custom_archiso">Embedding ZFS module into custom archiso</span></h3>
<p>To build a custom archiso, see <a href="../en/ZFS.html#Create_an_Archiso_image_with_ZFS_support" title="ZFS">ZFS#Create an Archiso image with ZFS support</a>.
</p>
<h2><span class="mw-headline" id="Select_boot_method">Select boot method</span></h2>
<p>Since the initrd tools and boot loaders you choose to use will affect later steps of the installation process, you should decide which combinations of them to use before proceeding with installation.
</p>
<h3><span class="mw-headline" id="Initrd_tools">Initrd tools</span></h3>
<p>By default, both dracut and mkinitcpio does not support booting from a ZFS root since they do not include the necessary kernel modules and userspace tools into the initrd. You'll need to use dracut modules or mkinitcpio hooks to make initrds that can boot from a ZFS root. The initrd tool you choose to use will in turn affect the syntax of kernel parameters/cmdlines for specifying ZFS roots.
</p>
<p>Here are the options:
</p>
<h4><span class="mw-headline" id="zfs_hook">zfs hook</span></h4>
<p>The <code>zfs</code> hook is the only option when using the default busybox based initrd.
</p>
<p>To configure the <code>zfs</code> hook, simply add <code>zfs</code> before the <code>filesystems</code> hook in your <span class="plainlinks archwiki-template-man" title="$ man 5 mkinitcpio.conf"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/mkinitcpio.conf.5">mkinitcpio.conf(5)</a></span>
</p>
<p>Possible syntax of kernel parameters are:
</p>
<ul>
<li>
<code>root=zfs</code>, which determines the root filesystem using the <code>bootfs</code> property</li>
<li>
<code>root=ZFS=&lt;pool/dataset&gt;</code>, which uses a pool or a dataset as root. When a pool is specified, the root filesystem is determined based on the <code>mountpoint</code> property</li>
<li>
<code>zfs=auto</code>: same effect as <code>root=zfs</code>
</li>
<li>
<code>zfs=&lt;pool/dataset&gt;</code>: same effect as <code>root=ZFS=&lt;pool/dataset&gt;</code>
</li>
</ul>
<p>Additionally, the following kernel parameters can be set to adjust the behavior of the initrd:
</p>
<ul>
<li>
<code>zfs_force=1</code> makes the <code>zpool import</code> command use the <code>-f</code> flag</li>
<li>
<code>zfs_wait=&lt;seconds&gt;</code> waits for the devices to show up before running <code>zpool import</code>
</li>
</ul>
<h4><span class="mw-headline" id="sd-zfs_hook">sd-zfs hook</span></h4>
<p>The <code>zfs</code> hook is not compatible with systemd based initrds. Instead you should use the <code>sd-zfs</code> hook.
</p>
<p>There are 2 choices: one shipped with <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://github.com/archlinuxcn/repo/tree/master/archlinuxcn/zfs-linux-lts-poscat">zfs-utils-poscat</a></span> from <a href="../en/Unofficial_user_repositories.html#archlinuxcn" class="mw-redirect" title="Archlinuxcn">archlinuxcn</a> and one shipped with <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/mkinitcpio-sd-zfs/">mkinitcpio-sd-zfs</a></span><sup><small>AUR</small></sup><sup>[<a href="../en/Help:Procedures.html#Fix_broken_package_links" title="Help:Procedures">broken link</a>: package not found]</sup>. The former is actively maintained while the latter seems to be abandoned.
</p>
<h5><span class="mw-headline" id="zfs-utils-poscat">zfs-utils-poscat</span></h5>
<p>
To configure this hook simply add it to anywhere in the <code>HOOKS</code> array of your <code>mkinitcpio.conf</code>. A typical configuration could look like this: </p>
<pre>HOOKS=(systemd sd-zfs autodetect microcode modconf kms keyboard sd-vconsole block filesystems fsck)</pre>
<p>The supported cmdline
formats are:
</p>
<ul>
<li>
<code>root=zfs</code>, which imports all pools in initrd, searches for the first pool with the bootfs property set, and then mounts bootfs as root.</li>
<li>
<code>root=zfs:poolname</code>, which imports only the specified pool and then mounts the pool's bootfs as root.</li>
<li>
<code>root=zfs:poolname/dataset</code>, which imports only the specified pool and then mounts the specified dataset as root.</li>
</ul>
<p><br>
</p>
<h5><span class="mw-headline" id="mkinitcpio-sd-zfs">mkinitcpio-sd-zfs</span></h5>
<p>Refer to the <a rel="nofollow" class="external text" href="https://github.com/dasJ/sd-zfs">github repository</a> for documentation on configuration.
</p>
<h4><span class="mw-headline" id="zfs_module">zfs module</span></h4>
<p>If instead you'd like to use dracut for initrd then you should use the <code>zfs</code> dracut module shipped with <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/zfs-utils/">zfs-utils</a></span><sup><small>AUR</small></sup>. Check the documentation <a rel="nofollow" class="external free" href="https://openzfs.github.io/openzfs-docs/man/master/7/dracut.zfs.7.html">https://openzfs.github.io/openzfs-docs/man/master/7/dracut.zfs.7.html</a> for how to configure the zfs module.
</p>
<h3><span class="mw-headline" id="Boot_loaders">Boot loaders</span></h3>
<p>Since the task of importing ZFS pools, mounting the root filesystem and <code>pivot_root</code>ing into the new root are all handled by the UKI or vmlinuz+initrd, there's no requirements on what bootloader you can use. Indeed, even an <a href="../en/EFI_boot_stub.html" title="EFI boot stub">EFI boot stub</a> should suffice given that the kernel parameters are configured properly depending on what tools you used for your initrd (See the above section <a href="#Initrd_tools">#Initrd tools</a>)
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> All boot loaders except grub2 cannot read files from ZFS filesystems, this means unless you are using grub2, you'll need to put your UKI or vmlinuz+initrd
on a separate filesystem that's readable by your boot loader of choice. When using UEFI boot, you can reuse you <a href="../en/EFI_system_partition.html" class="mw-redirect" title="ESP">ESP</a> for storing them (in fact is is recommended to put your UKI in ESP), just remember to reserve enough space for your ESP</div>
<h4><span class="mw-headline" id="Using_GRUB2">Using GRUB2</span></h4>
<p>Grub2 is able to read ZFS filesystems, given that the pools are created with only a limited set of features enabled (see <a href="../en/ZFS.html#GRUB-compatible_pool_creation" title="ZFS">ZFS#GRUB-compatible pool creation</a>) thus is possible to place UKI/initrd on ZFS root when using Grub2.
</p>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> It is doubtful that putting UKI/initrd on ZFS root achieves much given that it should entirely be rebuildable from the ZFS root (see <a href="#Layout_supporting_full_system_rollback">#Layout supporting full system rollback</a>). Additionally, Grub2's ZFS implementation, which is entirely independent of the OpenZFS implementation, is not known for reliability.</div>
<h2><span class="mw-headline" id="Partition_the_destination_drive">Partition the destination drive</span></h2>
<p><a href="../en/Partitioning.html" title="Partitioning">Partitioning</a> is done similar to other filesystems. See the aforementioned partitioning page or the <a href="../en/Installation_guide.html#Partition_the_disks" title="Installation guide">installation guide</a> on what layout to use and how to partition disks.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> ZFS does not support swap files and using zvol for swaps has significant drawbacks: the system might <a rel="nofollow" class="external text" href="https://github.com/openzfs/zfs/issues/7734">deadlock</a> under high memory pressure and it is not possible to hibernate to zvol swaps. So it is recommended to use a separate swap partition.</div>
<h3><span class="mw-headline" id="Layout_supporting_full_system_rollback">Layout supporting full system rollback</span></h3>
<p>To be able to use ZFS to snapshot everything you need to rebuild UKI or vmlinuz+initrd (so that you can rollback your full system state), you can use the following partition layout:
</p>
<ul>
<li>Do not mount anything on <code>/boot</code>, this way the vmlinuz is placed on your root, which is a ZFS filesystem.</li>
<li>If you use the UKI, mount ESP on <code>/efi</code> and point the UKI target to <code>/efi/EFI/Linux/&lt;name of image&gt;.efi</code>.</li>
<li>If you use vmlinuz+initrd, mount ESP(UEFI) or boot partition(BIOS) on <code>/efi</code> and point the initrd target to <code>/efi/&lt;name of initrd&gt;.img</code>. Set up a pacman hook that automatically copies vmlinuz from <code>/boot/vmlinuz-*</code> to <code>/efi/</code>.</li>
</ul>
<p>To perform a rollback, just rollback your ZFS root filesystem and either regenerate your UKI or regenerate the initrd and then copy vmlinuz from <code>/boot/vmlinuz-*</code> to <code>/efi/</code> manually.
</p>
<h2><span class="mw-headline" id="Set_up_the_ZFS_filesystem">Set up the ZFS filesystem</span></h2>
<h3><span class="mw-headline" id="Enable_ZED_on_live_CD">Enable ZED on live CD</span></h3>
<p>Since this guide assumes the usage of <span class="plainlinks archwiki-template-man" title="$ man 8 zfs-mount-generator"><a rel="nofollow" class="external text" href="https://openzfs.github.io/openzfs-docs/man/master/8/zfs-mount-generator.8.html">zfs-mount-generator(8)</a></span>, we need to generate the <code>zfs-list</code> cache before first booting into our system. This requires:
</p>
<ol>
<li>Enabling <code>zfs-zed.service</code> on live CD.</li>
<li>Creating empty files at <code>/etc/zfs/zfs-list.cache/&lt;poolname&gt;</code> for every pool you intended to create using <code>touch</code>
</li>
</ol>
<h3><span class="mw-headline" id="Create_the_root_pool">Create the root pool</span></h3>
<p>See <a href="../en/ZFS.html#Creating_ZFS_pools" title="ZFS">ZFS#Creating ZFS pools</a> for detailed info. As an example, the following command creates a root pool named <code>rpool</code> on the partition <code>/dev/nvme0n1p2</code> and sets the <code>altroot</code> property to <code>/mnt</code>:
</p>
<pre># zpool create \
         -O acltype=posixacl    \
         -O relatime=on         \
         -O dnodesize=auto      \
         -O normalization=formD \
         -O compression=zstd    \
         -O mountpoint=/        \
         -R /mnt                \
         rpool /dev/nvme0n1p2</pre>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> Use the <code>altroot</code> property, which is set via the <code>-R</code> flag during pool creation or import to temporarily add a prefix to the mount points to avoid shadowing the live cd environment</div>
<h3><span class="mw-headline" id="Create_filesystems">Create filesystems</span></h3>
<p>See <a href="../en/ZFS.html#Creating_datasets" title="ZFS">ZFS#Creating datasets</a> for detailed info. Here are some considerations when choosing your dataset options and layouts: 
</p>
<ol>
<li>Most properties are inherited from parent dataset by child unless explicitly overridden.</li>
<li>The default value of the <code>mountpoint</code> property of the child is <code>&lt;mountpoint of parent&gt;/&lt;name of child&gt;</code>.</li>
</ol>
<h2><span class="mw-headline" id="Install_and_configure_Arch_Linux">Install and configure Arch Linux</span></h2>
<p>Follow the steps of installation guide from <a href="../en/Installation_guide.html#Installation" title="Installation guide">Installation guide#Installation</a> to before reboot. You should probably use the <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=linux-lts">linux-lts</a></span> kernel instead of <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=linux">linux</a></span>.
</p>
<h3><span class="mw-headline" id="Install_ZFS">Install ZFS</span></h3>
<p>Follow <a href="../en/ZFS.html#Installation" title="ZFS">ZFS#Installation</a> to install ZFS.
</p>
<h3><span class="mw-headline" id="Configure_ZFS">Configure ZFS</span></h3>
<p>Follow <a href="../en/ZFS.html#Configuration" title="ZFS">ZFS#Configuration</a> to configure ZFS related services. Note however
</p>
<ol>
<li>We are under a chroot so don't try to start systemd services, just <a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Enable">enable</a> them.</li>
<li>Skip all steps in <a href="../en/ZFS.html#zfs-mount-generator" title="ZFS">ZFS#zfs-mount-generator</a> except enabling <code>zfs-zed.service</code>. We will populate the cache later.</li>
</ol>
<h3><span class="mw-headline" id="Set_up_the_initrd">Set up the initrd</span></h3>
<p>See <a href="#Initrd_tools">#Initrd tools</a> to configure the initrd generator of your choice. Don't forget to regenerate initrd either via <code>mkinitcpio -P</code> or <code>dracut --regenerate-all</code>.
</p>
<h3><span class="mw-headline" id="Populate_the_zfs-list_cache">Populate the zfs-list cache</span></h3>
<p>Now exit the chroot. Copy <code>/etc/zfs/zfs-list.cache</code> to <code>/mnt/etc/zfs/zfs-list.cache</code>:
</p>
<pre># cp -r /etc/zfs/zfs-list.cache /mnt/etc/zfs/
</pre>
<p>This provides the cache needed by <code>zfs-mount-generator</code>.
</p>
<h3>
<span id="Unmount.2C_export_and_reboot"></span><span class="mw-headline" id="Unmount,_export_and_reboot">Unmount, export and reboot</span>
</h3>
<p>Unmount all mounted filesystems (assuming the <code>altroot</code> is <code>/mnt</code>):
</p>
<pre># umount -R /mnt
</pre>
<p>Export all pools:
</p>
<pre># zpool export -a
</pre>
<p>Reboot:
</p>
<pre># reboot
</pre>
</div>
</div>
					<div id="catlinks" class="catlinks" data-mw="interface">
<div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../Special:Categories.html" title="Special:Categories">Category</a>: <ul><li><a href="../en/Category:Installation_process.html" title="Category:Installation process">Installation process</a></li></ul>
</div>
<div id="mw-hidden-catlinks" class="mw-hidden-catlinks mw-hidden-cats-hidden">Hidden category: <ul><li><a href="../en/Category:Pages_with_broken_package_links.html" title="Category:Pages with broken package links">Pages with broken package links</a></li></ul>
</div>
</div>
				</div>
			</main>
			
		</div>
		<div class="mw-footer-container">
			
<footer id="footer" class="mw-footer" role="contentinfo" style="margin: 0">
	<ul id="footer-info">
	<li data-nosnippet="">Retrieved from "<a dir="ltr" href="https://wiki.archlinux.org/index.php?title=Install_Arch_Linux_on_ZFS&amp;oldid=824055">https://wiki.archlinux.org/index.php?title=Install_Arch_Linux_on_ZFS&amp;oldid=824055</a>"</li>
<li id="footer-info-lastmod"> This page was last edited on 26 December 2024, at 22:45.</li>
	<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="https://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.3 or later</a> unless otherwise noted.</li>
<br>
</ul>

	<ul id="footer-places">
	<li id="footer-places-privacy"><a href="https://terms.archlinux.org/docs/privacy-policy/">Privacy policy</a></li>
	<li id="footer-places-about"><a href="../en/ArchWiki:About.html">About ArchWiki</a></li>
	<li id="footer-places-disclaimers"><a href="../en/ArchWiki:General_disclaimer.html">Disclaimers</a></li>
	<li id="footer-places-archwiki-code-of-conduct"><a href="https://terms.archlinux.org/docs/code-of-conduct/" class="extiw" title="archlinux-service-agreements:code-of-conduct">Code of conduct</a></li>
	<li id="footer-places-archwiki-terms-of-service"><a href="https://terms.archlinux.org/docs/terms-of-service/" class="extiw" title="archlinux-service-agreements:terms-of-service">Terms of service</a></li>
</ul>

	<ul id="footer-icons" class="noprint">
	<li id="footer-copyrightico"><a href="https://www.gnu.org/copyleft/fdl.html"><img src="/resources/assets/licenses/gnu-fdl.png" alt="GNU Free Documentation License 1.3 or later" width="88" height="31" loading="lazy"></a></li>
	<li id="footer-poweredbyico"><img src="/resources/assets/poweredby_mediawiki_88x31.png" srcset="/resources/assets/poweredby_mediawiki_132x47.png 1.5x, /resources/assets/poweredby_mediawiki_176x62.png 2x" width="88" height="31" loading="lazy"></li>
</ul>

</footer>

		</div>
	</div> 
</div> 
<div class="vector-settings" id="p-dock-bottom">
	<ul>
		<li>
		<button class="cdx-button cdx-button--icon-only vector-limited-width-toggle" id=""><span class="vector-icon mw-ui-icon-fullScreen mw-ui-icon-wikimedia-fullScreen"></span>

<span>Toggle limited content width</span>
</button>
</li>
	</ul>
</div>
</body>
</html>
