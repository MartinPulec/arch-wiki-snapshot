<!DOCTYPE html>
<html class="client-nojs vector-feature-language-in-header-enabled vector-feature-language-in-main-page-header-disabled vector-feature-sticky-header-disabled vector-feature-page-tools-pinned-disabled vector-feature-toc-pinned-clientpref-1 vector-feature-main-menu-pinned-disabled vector-feature-limited-width-clientpref-1 vector-feature-limited-width-content-enabled vector-feature-custom-font-size-clientpref-0 vector-feature-client-preferences-disabled vector-feature-client-prefs-pinned-disabled vector-feature-night-mode-disabled skin-theme-clientpref-day vector-toc-available" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>Restic - ArchWiki</title>
<link rel="stylesheet" href="../ArchWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<meta name="generator" content="MediaWiki 1.42.3">
<meta name="referrer" content="no-referrer-when-downgrade">
<meta name="robots" content="max-image-preview:standard">
<meta name="format-detection" content="telephone=no">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=0.25, maximum-scale=5.0">
<link rel="icon" href="/favicon.ico">
<link rel="search" type="application/opensearchdescription+xml" href="/opensearch_desc.php" title="ArchWiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.archlinux.org/api.php?action=rsd">
<link rel="license" href="https://www.gnu.org/copyleft/fdl.html">
<link rel="alternate" type="application/atom+xml" title="ArchWiki Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="skin-vector skin-vector-search-vue mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-Restic rootpage-Restic skin-vector-2022 action-view skin--responsive">
<a class="mw-jump-link" href="#bodyContent">Jump to content</a>
<div class="vector-header-container">
	</div>
<div class="mw-page-container">
	<div class="mw-page-container-inner">
		<div class="vector-column-start">
			<div class="vector-main-menu-container">
		</div>
	<div class="vector-sticky-pinned-container">
				<nav id="mw-panel-toc" role="navigation" aria-label="Contents" data-event-name="ui.sidebar-toc" class="mw-table-of-contents-container vector-toc-landmark">
					<div id="vector-toc-pinned-container" class="vector-pinned-container">
					<div id="vector-toc" class="vector-toc vector-pinnable-element">
	<div class="vector-pinnable-header vector-toc-pinnable-header vector-pinnable-header-pinned" data-feature-name="toc-pinned" data-pinnable-element-id="vector-toc">
	<h2 class="vector-pinnable-header-label">Contents</h2>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-pin-button" data-event-name="pinnable-header.vector-toc.pin">move to sidebar</button>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-unpin-button" data-event-name="pinnable-header.vector-toc.unpin">hide</button>
</div>


	<ul class="vector-toc-contents" id="mw-panel-toc-list">
		<li id="toc-mw-content-text" class="vector-toc-list-item vector-toc-level-1">
			<a href="#" class="vector-toc-link">
				<div class="vector-toc-text">Beginning</div>
			</a>
		</li>
		<li id="toc-Installation" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#Installation">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">1</span>Installation</div>
		</a>
		
		<ul id="toc-Installation-sublist" class="vector-toc-list">
		</ul>
	</li>
	<li id="toc-Security" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#Security">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">2</span>Security</div>
		</a>
		
		<ul id="toc-Security-sublist" class="vector-toc-list">
		</ul>
	</li>
	<li id="toc-Scheduling" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#Scheduling">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">3</span>Scheduling</div>
		</a>
		
			<button aria-controls="toc-Scheduling-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Scheduling subsection</span>
			</button>
		
		<ul id="toc-Scheduling-sublist" class="vector-toc-list">
			<li id="toc-Systemd_timers" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Systemd_timers">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.1</span>Systemd timers</div>
			</a>
			
			<ul id="toc-Systemd_timers-sublist" class="vector-toc-list">
				<li id="toc-Create_separate_volume" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Create_separate_volume">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.1.1</span>Create separate volume</div>
			</a>
			
			<ul id="toc-Create_separate_volume-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Systemd_Service" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Systemd_Service">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.1.2</span>Systemd Service</div>
			</a>
			
			<ul id="toc-Systemd_Service-sublist" class="vector-toc-list">
				<li id="toc-Configuring_resource_constraints" class="vector-toc-list-item vector-toc-level-4">
			<a class="vector-toc-link" href="#Configuring_resource_constraints">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.1.2.1</span>Configuring resource constraints</div>
			</a>
			
			<ul id="toc-Configuring_resource_constraints-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Systemd_timer" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Systemd_timer">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.1.3</span>Systemd timer</div>
			</a>
			
			<ul id="toc-Systemd_timer-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Backup_script" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Backup_script">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.1.4</span>Backup script</div>
			</a>
			
			<ul id="toc-Backup_script-sublist" class="vector-toc-list">
				<li id="toc-Compression" class="vector-toc-list-item vector-toc-level-4">
			<a class="vector-toc-link" href="#Compression">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.1.4.1</span>Compression</div>
			</a>
			
			<ul id="toc-Compression-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Snapshot_retention" class="vector-toc-list-item vector-toc-level-4">
			<a class="vector-toc-link" href="#Snapshot_retention">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.1.4.2</span>Snapshot retention</div>
			</a>
			
			<ul id="toc-Snapshot_retention-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Configuring_niceness" class="vector-toc-list-item vector-toc-level-4">
			<a class="vector-toc-link" href="#Configuring_niceness">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.1.4.3</span>Configuring niceness</div>
			</a>
			
			<ul id="toc-Configuring_niceness-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Excludes_list" class="vector-toc-list-item vector-toc-level-4">
			<a class="vector-toc-link" href="#Excludes_list">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.1.4.4</span>Excludes list</div>
			</a>
			
			<ul id="toc-Excludes_list-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Enable" class="vector-toc-list-item vector-toc-level-4">
			<a class="vector-toc-link" href="#Enable">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.1.4.5</span>Enable</div>
			</a>
			
			<ul id="toc-Enable-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Remote_append-only_backup_repository" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Remote_append-only_backup_repository">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.2</span>Remote append-only backup repository</div>
			</a>
			
			<ul id="toc-Remote_append-only_backup_repository-sublist" class="vector-toc-list">
				<li id="toc-Setup_restricted_'rclone_serve'_over_ssh" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Setup_restricted_'rclone_serve'_over_ssh">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.2.1</span>Setup restricted 'rclone serve' over ssh</div>
			</a>
			
			<ul id="toc-Setup_restricted_'rclone_serve'_over_ssh-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Run_restic_through_rclone" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Run_restic_through_rclone">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.2.2</span>Run restic through rclone</div>
			</a>
			
			<ul id="toc-Run_restic_through_rclone-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Append-only_script" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Append-only_script">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.2.3</span>Append-only script</div>
			</a>
			
			<ul id="toc-Append-only_script-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Restoring_Backup_Data" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Restoring_Backup_Data">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.2.4</span>Restoring Backup Data</div>
			</a>
			
			<ul id="toc-Restoring_Backup_Data-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
	</ul>
	</li>
</ul>
</div>

					</div>
		</nav>
			</div>
		</div>
		<div class="mw-content-container">
			<main id="content" class="mw-body" role="main" style="margin: 0">
				<header class="mw-body-header vector-page-titlebar">
					<nav role="navigation" aria-label="Contents" class="vector-toc-landmark">
						
<div id="vector-page-titlebar-toc" class="vector-dropdown vector-page-titlebar-toc vector-button-flush-left">
	<input type="checkbox" id="vector-page-titlebar-toc-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-vector-page-titlebar-toc" class="vector-dropdown-checkbox " aria-label="Toggle the table of contents">
	<label id="vector-page-titlebar-toc-label" for="vector-page-titlebar-toc-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--icon-only " aria-hidden="true"><span class="vector-icon mw-ui-icon-listBullet mw-ui-icon-wikimedia-listBullet"></span>

<span class="vector-dropdown-label-text">Toggle the table of contents</span>
	</label>
	<div class="vector-dropdown-content">


							<div id="vector-page-titlebar-toc-unpinned-container" class="vector-unpinned-container">
			</div>
		
	</div>
</div>

					</nav>
					<h1 id="firstHeading" class="firstHeading mw-first-heading"><span class="mw-page-title-main">Restic</span></h1>
							
<div id="p-lang-btn" class="vector-dropdown mw-portlet mw-portlet-lang">
	<input type="checkbox" id="p-lang-btn-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-p-lang-btn" class="vector-dropdown-checkbox mw-interlanguage-selector" aria-label="Go to an article in another language. Available in 1 language">
	<label id="p-lang-btn-label" for="p-lang-btn-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--action-progressive mw-portlet-lang-heading-1" aria-hidden="true"><span class="vector-icon mw-ui-icon-language-progressive mw-ui-icon-wikimedia-language-progressive"></span>

<span class="vector-dropdown-label-text">1 language</span>
	</label>
	<div class="vector-dropdown-content">

		<div class="vector-menu-content">
			
			<ul class="vector-menu-content-list">
				
				<li class="interlanguage-link interwiki-ja mw-list-item"><a href="https://wiki.archlinux.jp/index.php/Restic" title="Restic – 日本語" lang="ja" hreflang="ja" class="interlanguage-link-target"><span>日本語</span></a></li>
			</ul>
			
		</div>

	</div>
</div>
</header>
				<div class="vector-column-end">
					<div class="vector-sticky-pinned-container">
						<nav class="vector-page-tools-landmark" aria-label="Page tools">
							<div id="vector-page-tools-pinned-container" class="vector-pinned-container">
				
							</div>
		</nav>
						<nav class="vector-client-prefs-landmark" aria-label="Appearance">
						</nav>
					</div>
				</div>
				<div id="bodyContent" class="vector-body" aria-labelledby="firstHeading" data-mw-ve-target-container>
					<div class="vector-body-before-content">
							<div class="mw-indicators">
		</div>

						<div id="siteSub" class="noprint">From ArchWiki</div>
					</div>
					<div id="contentSub"><div id="mw-content-subtitle"></div></div>
					
					
					<div id="mw-content-text" class="mw-body-content">
<div class="mw-content-ltr mw-parser-output" lang="en" dir="ltr">
<div class="archwiki-template-meta-related-articles">
<p>Related articles</p>
<ul>
<li><a href="../en/System_backup.html" title="System backup">System backup</a></li>
<li><a href="../en/Disk_cloning.html" title="Disk cloning">Disk cloning</a></li>
<li><a href="../en/System_maintenance.html#Backup" title="System maintenance">System maintenance#Backup</a></li>
<li><a href="../en/File_recovery.html" title="File recovery">File recovery</a></li>
</ul>
</div>
<p>This page discusses the restic<a rel="nofollow" class="external autonumber" href="https://restic.readthedocs.io/en/latest/">[1]</a> backup tool, provides a 'quick start' guide, and suggests best practices in the context of Arch Linux.
</p>
<p>Restic's main features and benefits are: 
</p>
<ul>
<li>encrypted backups</li>
<li>remote backups</li>
<li>built-in support for compression</li>
<li>efficient storage (chunk-based increments, data is not duplicated)</li>
<li>gives flexibility to use a custom scheduler like cron or systemd</li>
<li>written in Go, providing stand-alone binaries</li>
</ul>
<meta property="mw:PageProp/toc">
<h2><span class="mw-headline" id="Installation">Installation</span></h2>
<p><a href="../en/Help:Reading.html#Installation_of_packages" class="mw-redirect" title="Install">Install</a> <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=restic">restic</a></span>, then initialise a repository in an empty directory (for local backups) with: 
</p>
<pre>$ restic init --repo <i>/path/to/backup/directory/</i>
</pre>
<p>See official tutorial<a rel="nofollow" class="external autonumber" href="https://restic.readthedocs.io/en/latest/010_introduction.html">[2]</a>.
</p>
<h2><span class="mw-headline" id="Security">Security</span></h2>
<p>Restic uses symmetric encryption for repositories. This introduces some issues with scheduled backups<a rel="nofollow" class="external autonumber" href="https://github.com/restic/restic/issues/533">[3]</a><a rel="nofollow" class="external autonumber" href="https://github.com/restic/restic/issues/2666">[4]</a>, as the key would generally have to be stored in plain text for an automated process to be able to create the backup.
</p>
<p>Restic does support the idea of a script to fetch the password (<code>--password-command</code> option), e.g. from a key vault of some sort. But to be able to unlock the key vault or secret store you would also likely have to hard-code credentials somewhere. Ideally there would be asymmetric encryption that allows to create snapshots with a public key (used in an automated script by restic) yet only decrypt the snapshot with a private key, but this is not supported.
</p>
<div class="noprint archwiki-template-message">
<p><span class="mw-default-size" typeof="mw:File"><span><img src="../File:Tango-view-fullscreen.svg" decoding="async" width="48" height="48" class="mw-file-element"></span></span><b>This article or section needs expansion.</b></p>
<div>
<b>Reason:</b> 
<ul>
<li>Mention restic key management</li>
<li>If a second-factor like a FIDO key is mentioned, it is more secure to use its secrets directly as a restic key, e.g. a FIDO2 resident-key setup for restic or (simpler) HMAC-SHA challenge-response to use directly or to unlock a password-store and retrieve the restic secret (e.g. with keepassxc-cli, pass) at runtime.</li>
</ul>
 (Discuss in <a rel="nofollow" class="external text" href="../en/Talk:Restic.html">Talk:Restic</a>)</div>
</div>
<p>If the system/data partitions to be backed up are not <a href="../en/Data-at-rest_encryption.html" title="Data-at-rest encryption">encrypted at rest</a>, you may work around exposing the plain text repository password by storing it in a file on a <a href="../en/Dm-crypt.html" class="mw-redirect" title="LUKS">LUKS</a> encrypted volume. The volume would be decrypted on boot using a passphrase or FIDO key (see <a href="../en/Universal_2nd_Factor.html" title="Universal 2nd Factor">Universal 2nd Factor</a>) such as <a href="../en/YubiKey.html" title="YubiKey">YubiKey</a> provided by the user. You can configure it in crypttab (see <a href="../en/Dm-crypt.html" title="Dm-crypt">dm-crypt</a>) and <a href="../en/Fstab.html" title="Fstab">fstab</a>. 
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> Restic repositories (backups) do not need to be encrypted with LUKS. Restic encrypts data by default.</div>
<h2><span class="mw-headline" id="Scheduling">Scheduling</span></h2>
<h3><span class="mw-headline" id="Systemd_timers">Systemd timers</span></h3>
<p>Unlike other tools like timeshift<a rel="nofollow" class="external autonumber" href="https://github.com/teejee2008/timeshift">[5]</a>, restic does not include a scheduling capability. You are expected to either use <a href="../en/Cron.html" title="Cron">cron</a> or <a href="../en/Systemd/Timers.html" class="mw-redirect" title="Systemd timer">systemd timers</a>.
</p>
<p>You can use a ready project like <a rel="nofollow" class="external text" href="https://github.com/erikw/restic-automatic-backup-scheduler">restic-automatic-backup-scheduler</a> or follow this example that creates local (full) system backups and should be run as the <a href="../en/Users_and_groups.html#Overview" class="mw-redirect" title="Root user">root user</a>.
</p>
<p>The example assumes there is an existing directory where an existing restic repository has been initialised (see <a href="#Installation">#Installation</a>).
</p>
<h4><span class="mw-headline" id="Create_separate_volume">Create separate volume</span></h4>
<p>This step is optional, but it is a good idea to mount a separate volume there to prevent the automated backup process from potentially consuming all space available to the OS.
</p>
<p>The first restic backup will have to clone the entire OS, so the minimum amount of space required is equal to the space taken up by the OS (subject to path exclusions described below) or any other directory that you decide to backup.
</p>
<p>Of course, you need space for any additional incremental changes in the future so it is a good idea to create a volume with 2 or even 3 times the size of the data being backed up. E.g. if <code>/</code> takes up <code>55G</code> then you can create <code>/mnt/restic</code> with <code>110G</code>.
</p>
<h4><span class="mw-headline" id="Systemd_Service">Systemd Service</span></h4>
<p>You will need a service unit. <a href="../en/Help:Reading.html#Append,_add,_create,_edit" class="mw-redirect" title="Create">Create</a> one:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/restic-backup.service</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Unit]
Description=Backup system

[Service]
ExecStart=systemd-inhibit /usr/local/bin/restic-backup</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> The service will be invoked by the timer below but can also be <a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Start">started</a> on demand for any unplanned snapshots. <span class="plainlinks archwiki-template-man" title="$ man 1 systemd-inhibit"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/systemd-inhibit.1">systemd-inhibit(1)</a></span> is optional but recommended to prevent accidental shutdown of the system while a backup is being created.</div>
<h5><span class="mw-headline" id="Configuring_resource_constraints">Configuring resource constraints</span></h5>
<p>Using systemd gives you the option to put resource constraints on the backup process. E.g. you can limit the amount of memory and / or CPU. This is something you would configure in the systemd service unit. See <span class="plainlinks archwiki-template-man" title="$ man 5 systemd.resource-control"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/systemd.resource-control.5">systemd.resource-control(5)</a></span>.
</p>
<p>Another way to constrain the resources used by restic is to use the <code>GOMAXPROCS</code> environment variable as described in the <a rel="nofollow" class="external text" href="https://restic.readthedocs.io/en/latest/047_tuning_backup_parameters.html#cpu-usage">official documentation</a>.
</p>
<h4><span class="mw-headline" id="Systemd_timer">Systemd timer</span></h4>
<p>You will also need a timer unit (this one runs every 15 min):
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/restic-backup.timer</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Unit]
Description=Timer for full system backups

[Timer]
OnBootSec=5min
OnUnitActiveSec=15min
Unit=restic-backup.service

[Install]
WantedBy=timers.target</pre>
<h4><span class="mw-headline" id="Backup_script">Backup script</span></h4>
<p>You will also want to create a small shell script to pass in all the required options, for example:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/usr/local/bin/restic-backup</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">#!/bin/bash

if [[ -n $(pgrep 'restic' | grep 'restic backup') ]]; then
  echo 'restic is already running...' 1&gt;&amp;2
  exit 0
fi

set -e
set -v

export RESTIC_REPOSITORY='/mnt/restic'
export RESTIC_PASSWORD_COMMAND='/usr/local/bin/get-restic-password'
export RESTIC_COMPRESSION='off'
export RESTIC_CACHE_DIR=~/.cache/restic

mkdir -p "${RESTIC_CACHE_DIR}"

restic unlock 
restic backup / --exclude-file=/etc/restic/excludes.txt --tag scheduled 
restic check --with-cache --read-data-subset=5G
restic forget --prune --keep-hourly 24 --keep-daily 30 --keep-monthly 6 --keep-weekly 4 --keep-yearly 3
</pre>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/usr/local/bin/get-restic-password</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">#!/bin/bash
echo VerySecurePassword123
</pre>
<pre># chmod 744 /usr/local/bin/restic-backup
# chmod 700 /usr/local/bin/get-restic-password
</pre>
<h5><span class="mw-headline" id="Compression">Compression</span></h5>
<p>You might want to consider <a rel="nofollow" class="external text" href="https://restic.readthedocs.io/en/latest/047_tuning_backup_parameters.html#compression">enabling compression in restic</a> to save space if you are backing up data that is not already compressed (like large text files).
</p>
<h5><span class="mw-headline" id="Snapshot_retention">Snapshot retention</span></h5>
<p>Adjust the <code>restic forget --prune --keep-hourly 24 --keep-daily 30 --keep-monthly 6 --keep-weekly 4 --keep-yearly 3</code> values in the script above if wanted.
</p>
<h5><span class="mw-headline" id="Configuring_niceness">Configuring niceness</span></h5>
<p>You may also wish to tweak niceness of the backup process. If you are running backups often you will likely want to reduce the resource usage to prevent it from affecting interactive use. However, you should check how long the backups are taking and make sure they are not overlapping (i.e. a new backup being started when the previous one has not finished).
</p>
<p>You can do that with <span class="plainlinks archwiki-template-man" title="$ man 1 nice"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/nice.1">nice(1)</a></span>. You may want to adjust the backup scrip by adding nice to the beginning of the resource intensive commands e.g.:
</p>
<pre># nice -n 19 restic backup ...
# nice -n 19 restic check ...
</pre>
<p>Alternatively if you are using <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=ananicy-cpp">ananicy-cpp</a></span> you may want to ensure that the niceness is configured in its configuration file(s) under <code>/etc/ananicy.d/</code>.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/ananicy.d/00-types.types</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">{"type":"file-sync","nice":19,"ionice":7}
</pre>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/ananicy.d/99-custom/file-sync/restic.rules</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">{"name": "restic", "type": "file-sync"}
</pre>
<p>Refer to the <a rel="nofollow" class="external text" href="https://restic.readthedocs.io/en/latest/faq.html?highlight=nice#how-to-prioritize-restic-s-io-and-cpu-time">restic FAQ</a> for more information.
</p>
<h5><span class="mw-headline" id="Excludes_list">Excludes list</span></h5>
<p>Add the excludes file under <code>/etc/restic</code> e.g.:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/restic/excludes.txt</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">/data/**
/dev/**
/home/*/**/*.pyc
/home/*/**/__pycache__/**
/home/*/**/node_modules/**
/home/*/.cache/**
/home/*/.local/lib/python*/site-packages/**
/home/*/.mozilla/firefox/*/Cache/**
/lost+found/**
/media/**
/mnt/**
/proc/**
/root/**
/run/**
/swapfile
/sys/**
/tmp/**
/var/cache/**
/var/cache/pacman/pkg/**
/var/lib/docker/**
/var/lib/libvirt/**
/var/lock/**
/var/log/**
/var/run/**
</pre>
<h5><span class="mw-headline" id="Enable">Enable</span></h5>
<p>Do not forget to <a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Enable">enable</a> the <code>restic-backup.timer</code>.
</p>
<p><br>
</p>
<h3><span class="mw-headline" id="Remote_append-only_backup_repository">Remote append-only backup repository</span></h3>
<p>As with most backup solutions, restic backups can usually be modified by the user that executes the backup. This makes the backup data vulnerable to manipulation and threats like ransomware. While the above example runs the backup as root and thereby prevents trivial modification by local unprivileged users, a compromise of the system will allow malware to delete/overwrite the backup data as well, even if that data is in a remote repository (since the local user authenticates to the remote repository). In order to setup a secure backup solution that cannot be modified, restic can be used in combination with <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=rclone">rclone</a></span> to make use of its append-only feature run on a restricted remote system.
</p>
<h4>
<span id="Setup_restricted_.27rclone_serve.27_over_ssh"></span><span class="mw-headline" id="Setup_restricted_'rclone_serve'_over_ssh">Setup restricted 'rclone serve' over ssh</span>
</h4>
<p>The following will restrict the user to the specified command, effectively allowing only the addition of new data to the path <code>/home/myuser/backup</code> while preventing the modification of existing files.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/ssh/sshd_config</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">/etc/ssh/sshd_config
Match user myuser
  ForceCommand rclone serve restic --stdio --append-only ./backup
</pre>
<h4><span class="mw-headline" id="Run_restic_through_rclone">Run restic through rclone</span></h4>
<p>Initialize the backup repository on the remote ssh server:
</p>
<pre>restic -o rclone.program='ssh myuser@backup.tld' -r rclone: init
</pre>
<p>Execute restic backup with rclone as transport:
</p>
<pre>restic -o rclone.program='ssh myuser@backup.tld' -r rclone: backup /home/myuser/importantData
</pre>
<h4><span class="mw-headline" id="Append-only_script">Append-only script</span></h4>
<p>Note that it is no longer possible to use the prune option in order to delete old backups since no data on the remote repository can be modified now. The user can only write-append new files and read existing backup data to restore.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/usr/local/bin/restic-backup</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">#!/bin/bash

if [[ -n $(pgrep 'restic' | grep 'restic backup') ]]; then
  echo 'restic is already running...' 1&gt;&amp;2
  exit 0
fi

set -e
set -v

export RESTIC_REPOSITORY="rclone:"
export RESTIC_PASSWORD_COMMAND='/usr/local/bin/get-restic-password'
export RESTIC_COMPRESSION='off'
export RESTIC_CACHE_DIR=~/.cache/restic

RCLONE_EXEC="rclone.program=ssh myuser@backup.tld forced-command"
DATA_PATH="/home/myuser/importantData"

mkdir -p "${RESTIC_CACHE_DIR}"

restic -o "${RCLONE_EXEC}" unlock
restic -o "${RCLONE_EXEC}" backup ${DATA_PATH} --exclude-file="$HOME/.local/scripts/excludes" --tag scheduled
restic -o "${RCLONE_EXEC}" check --with-cache --read-data-subset=5G
</pre>
<h4><span class="mw-headline" id="Restoring_Backup_Data">Restoring Backup Data</span></h4>
<pre>restic -o rclone.program='ssh myuser@backup.tld forced-command' -r rclone: restore latest --target /tmp/restoredData
</pre>
</div>
</div>
					<div id="catlinks" class="catlinks" data-mw="interface">
<div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../Special:Categories.html" title="Special:Categories">Category</a>: <ul><li><a href="../en/Category:Backup.html" title="Category:Backup">Backup</a></li></ul>
</div>
<div id="mw-hidden-catlinks" class="mw-hidden-catlinks mw-hidden-cats-hidden">Hidden category: <ul><li><a href="../en/Category:Pages_or_sections_flagged_with_Template:Expansion.html" title="Category:Pages or sections flagged with Template:Expansion">Pages or sections flagged with Template:Expansion</a></li></ul>
</div>
</div>
				</div>
			</main>
			
		</div>
		<div class="mw-footer-container">
			
<footer id="footer" class="mw-footer" role="contentinfo" style="margin: 0">
	<ul id="footer-info">
	<li data-nosnippet="">Retrieved from "<a dir="ltr" href="https://wiki.archlinux.org/index.php?title=Restic&amp;oldid=819682">https://wiki.archlinux.org/index.php?title=Restic&amp;oldid=819682</a>"</li>
<li id="footer-info-lastmod"> This page was last edited on 27 October 2024, at 07:15.</li>
	<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="https://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.3 or later</a> unless otherwise noted.</li>
<br>
</ul>

	<ul id="footer-places">
	<li id="footer-places-privacy"><a href="https://terms.archlinux.org/docs/privacy-policy/">Privacy policy</a></li>
	<li id="footer-places-about"><a href="../en/ArchWiki:About.html">About ArchWiki</a></li>
	<li id="footer-places-disclaimers"><a href="../en/ArchWiki:General_disclaimer.html">Disclaimers</a></li>
	<li id="footer-places-archwiki-code-of-conduct"><a href="https://terms.archlinux.org/docs/code-of-conduct/" class="extiw" title="archlinux-service-agreements:code-of-conduct">Code of conduct</a></li>
	<li id="footer-places-archwiki-terms-of-service"><a href="https://terms.archlinux.org/docs/terms-of-service/" class="extiw" title="archlinux-service-agreements:terms-of-service">Terms of service</a></li>
</ul>

	<ul id="footer-icons" class="noprint">
	<li id="footer-copyrightico"><a href="https://www.gnu.org/copyleft/fdl.html"><img src="/resources/assets/licenses/gnu-fdl.png" alt="GNU Free Documentation License 1.3 or later" width="88" height="31" loading="lazy"></a></li>
	<li id="footer-poweredbyico"><img src="/resources/assets/poweredby_mediawiki_88x31.png" srcset="/resources/assets/poweredby_mediawiki_132x47.png 1.5x, /resources/assets/poweredby_mediawiki_176x62.png 2x" width="88" height="31" loading="lazy"></li>
</ul>

</footer>

		</div>
	</div> 
</div> 
<div class="vector-settings" id="p-dock-bottom">
	<ul>
		<li>
		<button class="cdx-button cdx-button--icon-only vector-limited-width-toggle" id=""><span class="vector-icon mw-ui-icon-fullScreen mw-ui-icon-wikimedia-fullScreen"></span>

<span>Toggle limited content width</span>
</button>
</li>
	</ul>
</div>
</body>
</html>
