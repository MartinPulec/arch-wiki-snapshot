<!DOCTYPE html>
<html class="client-nojs vector-feature-language-in-header-enabled vector-feature-language-in-main-page-header-disabled vector-feature-sticky-header-disabled vector-feature-page-tools-pinned-disabled vector-feature-toc-pinned-clientpref-1 vector-feature-main-menu-pinned-disabled vector-feature-limited-width-clientpref-1 vector-feature-limited-width-content-enabled vector-feature-custom-font-size-clientpref-0 vector-feature-appearance-pinned-clientpref-1 vector-feature-night-mode-enabled skin-theme-clientpref-day vector-toc-available" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>QEMU/Advanced networking - ArchWiki</title>
<link rel="stylesheet" href="../../ArchWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<meta name="generator" content="MediaWiki 1.43.1">
<meta name="referrer" content="no-referrer-when-downgrade">
<meta name="robots" content="max-image-preview:standard">
<meta name="format-detection" content="telephone=no">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=0.25, maximum-scale=5.0">
<link rel="search" type="application/opensearchdescription+xml" href="/rest.php/v1/search" title="ArchWiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.archlinux.org/api.php?action=rsd">
<link rel="license" href="https://www.gnu.org/copyleft/fdl.html">
<link rel="alternate" type="application/atom+xml" title="ArchWiki Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="skin--responsive skin-vector skin-vector-search-vue mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-QEMU_Advanced_networking rootpage-QEMU skin-vector-2022 action-view">
<a class="mw-jump-link" href="#bodyContent">Jump to content</a>
<div class="vector-header-container">
	</div>
<div class="mw-page-container">
	<div class="mw-page-container-inner">
		<div class="vector-column-start">
			<div class="vector-main-menu-container">
		</div>
	<div class="vector-sticky-pinned-container">
				<nav id="mw-panel-toc" aria-label="Contents" data-event-name="ui.sidebar-toc" class="mw-table-of-contents-container vector-toc-landmark">
					<div id="vector-toc-pinned-container" class="vector-pinned-container">
					<div id="vector-toc" class="vector-toc vector-pinnable-element">
	<div class="vector-pinnable-header vector-toc-pinnable-header vector-pinnable-header-pinned" data-feature-name="toc-pinned" data-pinnable-element-id="vector-toc">
	<h2 class="vector-pinnable-header-label">Contents</h2>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-pin-button" data-event-name="pinnable-header.vector-toc.pin">move to sidebar</button>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-unpin-button" data-event-name="pinnable-header.vector-toc.unpin">hide</button>
</div>


	<ul class="vector-toc-contents" id="mw-panel-toc-list">
		<li id="toc-mw-content-text" class="vector-toc-list-item vector-toc-level-1">
			<a href="#" class="vector-toc-link">
				<div class="vector-toc-text">Beginning</div>
			</a>
		</li>
		<li id="toc-Advanced_bridge_network_configuration" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#Advanced_bridge_network_configuration">
			<div class="vector-toc-text">
				<span class="vector-toc-numb">1</span>
				<span>Advanced bridge network configuration</span>
			</div>
		</a>
		
			<button aria-controls="toc-Advanced_bridge_network_configuration-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Advanced bridge network configuration subsection</span>
			</button>
		
		<ul id="toc-Advanced_bridge_network_configuration-sublist" class="vector-toc-list">
			<li id="toc-Creating_bridge_manually" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Creating_bridge_manually">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">1.1</span>
					<span>Creating bridge manually</span>
				</div>
			</a>
			
			<ul id="toc-Creating_bridge_manually-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Network_sharing_between_physical_device_and_a_Tap_device_through_iptables" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Network_sharing_between_physical_device_and_a_Tap_device_through_iptables">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">1.2</span>
					<span>Network sharing between physical device and a Tap device through iptables</span>
				</div>
			</a>
			
			<ul id="toc-Network_sharing_between_physical_device_and_a_Tap_device_through_iptables-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Networking_with_VDE2" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#Networking_with_VDE2">
			<div class="vector-toc-text">
				<span class="vector-toc-numb">2</span>
				<span>Networking with VDE2</span>
			</div>
		</a>
		
			<button aria-controls="toc-Networking_with_VDE2-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Networking with VDE2 subsection</span>
			</button>
		
		<ul id="toc-Networking_with_VDE2-sublist" class="vector-toc-list">
			<li id="toc-What_is_VDE?" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#What_is_VDE?">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">2.1</span>
					<span>What is VDE?</span>
				</div>
			</a>
			
			<ul id="toc-What_is_VDE?-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Basics" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Basics">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">2.2</span>
					<span>Basics</span>
				</div>
			</a>
			
			<ul id="toc-Basics-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Startup_scripts" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Startup_scripts">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">2.3</span>
					<span>Startup scripts</span>
				</div>
			</a>
			
			<ul id="toc-Startup_scripts-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Alternative_method" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Alternative_method">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">2.4</span>
					<span>Alternative method</span>
				</div>
			</a>
			
			<ul id="toc-Alternative_method-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-VDE2_Bridge" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#VDE2_Bridge">
			<div class="vector-toc-text">
				<span class="vector-toc-numb">3</span>
				<span>VDE2 Bridge</span>
			</div>
		</a>
		
			<button aria-controls="toc-VDE2_Bridge-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle VDE2 Bridge subsection</span>
			</button>
		
		<ul id="toc-VDE2_Bridge-sublist" class="vector-toc-list">
			<li id="toc-Basics_2" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Basics_2">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">3.1</span>
					<span>Basics</span>
				</div>
			</a>
			
			<ul id="toc-Basics_2-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Startup_scripts_2" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Startup_scripts_2">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">3.2</span>
					<span>Startup scripts</span>
				</div>
			</a>
			
			<ul id="toc-Startup_scripts_2-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
</ul>
</div>

					</div>
		</nav>
			</div>
		</div>
		<div class="mw-content-container">
			<main id="content" class="mw-body" style="margin: 0">
				<header class="mw-body-header vector-page-titlebar">
					<nav aria-label="Contents" class="vector-toc-landmark">
						
<div id="vector-page-titlebar-toc" class="vector-dropdown vector-page-titlebar-toc vector-button-flush-left">
	<input type="checkbox" id="vector-page-titlebar-toc-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-vector-page-titlebar-toc" class="vector-dropdown-checkbox " aria-label="Toggle the table of contents">
	<label id="vector-page-titlebar-toc-label" for="vector-page-titlebar-toc-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--icon-only " aria-hidden="true"><span class="vector-icon mw-ui-icon-listBullet mw-ui-icon-wikimedia-listBullet"></span>

<span class="vector-dropdown-label-text">Toggle the table of contents</span>
	</label>
	<div class="vector-dropdown-content">


							<div id="vector-page-titlebar-toc-unpinned-container" class="vector-unpinned-container">
			</div>
		
	</div>
</div>

					</nav>
					<h1 id="firstHeading" class="firstHeading mw-first-heading"><span class="mw-page-title-main">QEMU/Advanced networking</span></h1>
				</header>
				<div class="vector-column-end">
					<div class="vector-sticky-pinned-container">
						<nav class="vector-page-tools-landmark" aria-label="Page tools">
							<div id="vector-page-tools-pinned-container" class="vector-pinned-container">
				
							</div>
		</nav>
						<nav class="vector-appearance-landmark" aria-label="Appearance">
							<div id="vector-appearance-pinned-container" class="vector-pinned-container">
				<div id="vector-appearance" class="vector-appearance vector-pinnable-element">
	<div class="vector-pinnable-header vector-appearance-pinnable-header vector-pinnable-header-pinned" data-feature-name="appearance-pinned" data-pinnable-element-id="vector-appearance" data-pinned-container-id="vector-appearance-pinned-container" data-unpinned-container-id="vector-appearance-unpinned-container">
	<div class="vector-pinnable-header-label">Appearance</div>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-pin-button" data-event-name="pinnable-header.vector-appearance.pin">move to sidebar</button>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-unpin-button" data-event-name="pinnable-header.vector-appearance.unpin">hide</button>
</div>


</div>

							</div>
		</nav>
					</div>
				</div>
				<div id="bodyContent" class="vector-body" aria-labelledby="firstHeading" data-mw-ve-target-container>
					<div class="vector-body-before-content">
							<div class="mw-indicators">
		</div>

						<div id="siteSub" class="noprint">From ArchWiki</div>
					</div>
					<div id="contentSub"><div id="mw-content-subtitle"><div class="subpages">&lt; <bdi dir="ltr"><a href="../../en/QEMU.html" title="QEMU">QEMU</a></bdi>
</div></div></div>
					
					
					<div id="mw-content-text" class="mw-body-content">
<div class="mw-content-ltr mw-parser-output" lang="en" dir="ltr">
<p><br>
</p>
<meta property="mw:PageProp/toc">
<h2><span class="mw-headline" id="Advanced_bridge_network_configuration">Advanced bridge network configuration</span></h2>
<h3><span class="mw-headline" id="Creating_bridge_manually">Creating bridge manually</span></h3>
<div class="noprint archwiki-template-message">
<p><span class="mw-default-size" typeof="mw:File"><span><img src="../../File:Tango-edit-clear.svg" decoding="async" width="48" height="48" class="mw-file-element"></span></span><b>This article or section needs language, wiki syntax or style improvements. See <a href="../../en/Help:Style.html" title="Help:Style">Help:Style</a> for reference.</b></p>
<div>
<b>Reason:</b> This section needs serious cleanup and may contain out-of-date information. (Discuss in <a rel="nofollow" class="external text" href="../../en/Talk:QEMU/Advanced_networking.html">Talk:QEMU/Advanced networking</a>)</div>
</div>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> Since QEMU 1.1, the <a rel="nofollow" class="external text" href="https://wiki.qemu.org/Features/HelperNetworking">network bridge helper</a> can set tun/tap up for you without the need for additional scripting. See <a href="../../en/QEMU.html#Bridged_networking_using_qemu-bridge-helper" title="QEMU">QEMU#Bridged networking using qemu-bridge-helper</a>.</div>
<p>The following describes how to bridge a virtual machine to a host interface such as <code>eth0</code>, which is probably the most common configuration. This configuration makes it appear that the virtual machine is located directly on the external network, on the same Ethernet segment as the physical host machine.
</p>
<p>We will replace the normal Ethernet adapter with a bridge adapter and bind the normal Ethernet adapter to it.
</p>
<ul><li>Install <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=bridge-utils">bridge-utils</a></span>, which provides <code>brctl</code> to manipulate bridges.</li></ul>
<ul><li>Enable IPv4 forwarding:</li></ul>
<pre># sysctl -w net.ipv4.ip_forward=1
</pre>
<p>To make the change permanent, change <code>net.ipv4.ip_forward = 0</code> to <code>net.ipv4.ip_forward = 1</code> in <code>/etc/sysctl.d/99-sysctl.conf</code>.
</p>
<ul><li>Load the <code>tun</code> module and configure it to be loaded on boot. See <a href="../../en/Kernel_module.html" class="mw-redirect" title="Kernel modules">Kernel modules</a> for details.</li></ul>
<ul><li>Optionally create the bridge. See <a href="../../en/Bridge_with_netctl.html" title="Bridge with netctl">Bridge with netctl</a> for details. Remember to name your bridge as <code>br0</code>, or change the scripts below to your bridge's name. In the <code>run-qemu</code> script below, <code>br0</code> is set up if not listed, as it is assumed that by default the host is not accessing network via the bridge.</li></ul>
<ul><li>Create the script that QEMU uses to bring up the tap adapter with <code>root:kvm</code> 750 permissions:</li></ul>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/qemu-ifup</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">#!/bin/sh

echo "Executing /etc/qemu-ifup"
echo "Bringing up $1 for bridged mode..."
sudo /usr/bin/ip link set $1 up promisc on
echo "Adding $1 to br0..."
sudo /usr/bin/brctl addif br0 $1
sleep 2
</pre>
<ul><li>Create the script that QEMU uses to bring down the tap adapter in <code>/etc/qemu-ifdown</code> with <code>root:kvm</code> 750 permissions:</li></ul>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/qemu-ifdown</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">#!/bin/sh

echo "Executing /etc/qemu-ifdown"
sudo /usr/bin/ip link set $1 down
sudo /usr/bin/brctl delif br0 $1
sudo /usr/bin/ip link delete dev $1
</pre>
<ul><li>Use <code>visudo</code> to add the following to your <code>sudoers</code> file:</li></ul>
<pre>Cmnd_Alias      QEMU=/usr/bin/ip,/usr/bin/modprobe,/usr/bin/brctl
%kvm     ALL=NOPASSWD: QEMU
</pre>
<ul><li>You launch QEMU using the following <code>run-qemu</code> script:</li></ul>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">run-qemu</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">#!/bin/bash
: '
e.g. with img created via:
qemu-img create -f qcow2 example.img 90G
run-qemu -cdrom archlinux-x86_64.iso -boot order=d -drive file=example.img,format=qcow2 -m 4G -enable-kvm -cpu host -smp 4
run-qemu -drive file=example.img,format=qcow2 -m 4G -enable-kvm -cpu host -smp 4
'

nicbr0() {
    sudo ip link set dev $1 promisc on up &amp;&gt; /dev/null
    sudo ip addr flush dev $1 scope host &amp;&gt;/dev/null
    sudo ip addr flush dev $1 scope site &amp;&gt;/dev/null
    sudo ip addr flush dev $1 scope global &amp;&gt;/dev/null
    sudo ip link set dev $1 master br0 &amp;&gt; /dev/null
}
_nicbr0() {
    sudo ip link set $1 promisc off down &amp;&gt; /dev/null
    sudo ip link set dev $1 nomaster &amp;&gt; /dev/null
}

HASBR0="$( ip link show | grep br0 )"
if [ -z $HASBR0 ] ; then
    ROUTER="192.168.1.1"
    SUBNET="192.168.1."
    NIC=$(ip link show | grep en | grep 'state UP' | head -n 1 | cut -d":" -f 2 | xargs)
    IPADDR=$(ip addr show | grep -o "inet $SUBNET\([0-9]*\)" | cut -d ' ' -f2)
    sudo ip link add name br0 type bridge &amp;&gt; /dev/null
    sudo ip link set dev br0 up
    sudo ip addr add $IPADDR/24 brd + dev br0
    sudo ip route del default &amp;&gt; /dev/null
    sudo ip route add default via $ROUTER dev br0 onlink
    nicbr0 $NIC
    sudo iptables -I FORWARD -m physdev --physdev-is-bridged -j ACCEPT
fi

USERID=$(whoami)
precreationg=$(ip tuntap list | cut -d: -f1 | sort)
sudo ip tuntap add user $USERID mode tap
postcreation=$(ip tuntap list | cut -d: -f1 | sort)
TAP=$(comm -13 &lt;(echo "$precreationg") &lt;(echo "$postcreation"))
nicbr0 $TAP

printf -v MACADDR "52:54:%02x:%02x:%02x:%02x" $(( $RANDOM &amp; 0xff)) $(( $RANDOM &amp; 0xff )) $(( $RANDOM &amp; 0xff)) $(( $RANDOM &amp; 0xff ))
qemu-system-x86_64 -net nic,macaddr=$MACADDR,model=virtio \
    -net tap,ifname=$TAP,script=no,downscript=no,vhost=on \
    $@

_nicbr0 $TAP
sudo ip link set dev $TAP down &amp;&gt; /dev/null
sudo ip tuntap del $TAP mode tap

if [ -z $HASBR0 ] ; then
    _nicbr0 $NIC
    sudo ip addr del dev br0 $IPADDR/24 &amp;&gt; /dev/null
    sudo ip link set dev br0 down
    sudo ip link delete br0 type bridge &amp;&gt; /dev/null
    sudo ip route del default &amp;&gt; /dev/null
    sudo ip link set dev $NIC up
    sudo ip route add default via $ROUTER dev $NIC onlink &amp;&gt; /dev/null
fi
</pre>
<p>Then to launch a virtual machine, do something like this
</p>
<pre>$ run-qemu -hda <i>myvm.img</i> -m 512
</pre>
<ul><li>It is recommended for performance and security reasons to disable the <a rel="nofollow" class="external text" href="https://ebtables.netfilter.org/documentation/bridge-nf.html">firewall on the bridge</a>:</li></ul>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/sysctl.d/10-disable-firewall-on-bridge.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">net.bridge.bridge-nf-call-ip6tables = 0
net.bridge.bridge-nf-call-iptables = 0
net.bridge.bridge-nf-call-arptables = 0
</pre>
<p>In order to apply the parameters described above on boot, you will also need to load the br-netfilter module on boot. Otherwise, the parameters will not exist when sysctl will try to modify them.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/modules-load.d/br_netfilter.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">br_netfilter
</pre>
<p>Run <code>sysctl -p /etc/sysctl.d/10-disable-firewall-on-bridge.conf</code> to apply the changes immediately.
</p>
<p>See the <a rel="nofollow" class="external text" href="https://wiki.libvirt.org/page/Networking#Creating_network_initscripts">libvirt wiki</a> and <a rel="nofollow" class="external text" href="https://bugzilla.redhat.com/show_bug.cgi?id=512206">Fedora bug 512206</a>. If you get errors by sysctl during boot about non-existing files, make the <code>bridge</code> module load at boot. See <a href="../../en/Kernel_module.html#systemd" title="Kernel module">Kernel module#systemd</a>.
</p>
<p>Alternatively, you can configure <a href="../../en/Iptables.html" title="Iptables">iptables</a> to allow all traffic to be forwarded across the bridge by adding a rule like this:
</p>
<pre>-I FORWARD -m physdev --physdev-is-bridged -j ACCEPT
</pre>
<h3><span class="mw-headline" id="Network_sharing_between_physical_device_and_a_Tap_device_through_iptables">Network sharing between physical device and a Tap device through iptables</span></h3>
<div class="noprint archwiki-template-message">
<p><span class="mw-default-size" typeof="mw:File"><span><img src="../../File:Merge-arrows-2.svg" decoding="async" width="36" height="40" class="mw-file-element"></span></span><b>This article or section is a candidate for merging with <a href="../../en/Internet_sharing.html" title="Internet sharing">Internet_sharing</a>.</b></p>
<div>
<b>Notes:</b> Duplication, not specific to QEMU. (Discuss in <a rel="nofollow" class="external text" href="../../en/Talk:QEMU/Advanced_networking.html">Talk:QEMU/Advanced networking</a>)</div>
</div>
<p>Bridged networking works fine between a wired interface (Eg. eth0), and it is easy to setup. However if the host gets connected to the network through a wireless device, then bridging is not possible.
</p>
<p>See <a href="../../en/Network_bridge.html#Wireless_interface_on_a_bridge" title="Network bridge">Network bridge#Wireless interface on a bridge</a> as a reference.
</p>
<p>One way to overcome that is to setup a tap device with a static IP, making linux automatically handle the routing for it, and then forward traffic between the tap interface and the device connected to the network through iptables rules.
</p>
<p>See <a href="../../en/Internet_sharing.html" title="Internet sharing">Internet sharing</a> as a reference.
</p>
<p>There you can find what is needed to share the network between devices, included tap and tun ones. The following just hints further on some of the host configurations required. As indicated in the reference above, the client needs to be configured for a static IP, using the IP assigned to the tap interface as the gateway. The caveat is that the DNS servers on the client might need to be manually edited if they change when changing from one host device connected to the network to another.
</p>
<p>To allow IP forwarding on every boot, one need to add the following lines to sysctl configuration file inside <code>/etc/sysctl.d</code>:
</p>
<pre>net.ipv4.ip_forward = 1
net.ipv6.conf.default.forwarding = 1
net.ipv6.conf.all.forwarding = 1
</pre>
<p>The iptables rules can look like:
</p>
<pre># Forwarding from/to outside
iptables -A FORWARD -i ${INT} -o ${EXT_0} -j ACCEPT
iptables -A FORWARD -i ${INT} -o ${EXT_1} -j ACCEPT
iptables -A FORWARD -i ${INT} -o ${EXT_2} -j ACCEPT
iptables -A FORWARD -i ${EXT_0} -o ${INT} -j ACCEPT
iptables -A FORWARD -i ${EXT_1} -o ${INT} -j ACCEPT
iptables -A FORWARD -i ${EXT_2} -o ${INT} -j ACCEPT
# NAT/Masquerade (network address translation)
iptables -t nat -A POSTROUTING -o ${EXT_0} -j MASQUERADE
iptables -t nat -A POSTROUTING -o ${EXT_1} -j MASQUERADE
iptables -t nat -A POSTROUTING -o ${EXT_2} -j MASQUERADE
</pre>
<p>The prior supposes there are 3 devices connected to the network sharing traffic with one internal device, where for example:
</p>
<pre>INT=tap0
EXT_0=eth0
EXT_1=wlan0
EXT_2=tun0
</pre>
<p>The prior shows a forwarding that would allow sharing wired and wireless connections with the tap device.
</p>
<p>The forwarding rules shown are stateless, and for pure forwarding. One could think of restricting specific traffic, putting a firewall in place to protect the guest and others. However those would decrease the networking performance, while a simple bridge does not include any of that.
</p>
<p>Bonus:  Whether the connection is wired or wireless, if one gets connected through VPN to a remote site with a tun device, supposing the tun device opened for that connection is tun0, and the prior iptables rules are applied, then the remote connection gets also shared with the guest. This avoids the need for the guest to also open a VPN connection. Again, as the guest networking needs to be static, then if connecting the host remotely this way, one most probably will need to edit the DNS servers on the guest.
</p>
<h2><span class="mw-headline" id="Networking_with_VDE2">Networking with VDE2</span></h2>
<div class="noprint archwiki-template-message">
<p><span class="mw-default-size" typeof="mw:File"><span><img src="../../File:Tango-edit-clear.svg" decoding="async" width="48" height="48" class="mw-file-element"></span></span><b>This article or section needs language, wiki syntax or style improvements. See <a href="../../en/Help:Style.html" title="Help:Style">Help:Style</a> for reference.</b></p>
<div>
<b>Reason:</b> This section needs serious cleanup and may contain out-of-date information. (Discuss in <a rel="nofollow" class="external text" href="../../en/Talk:QEMU/Advanced_networking.html">Talk:QEMU/Advanced networking</a>)</div>
</div>
<h3>
<span id="What_is_VDE.3F"></span><span class="mw-headline" id="What_is_VDE?">What is VDE?</span>
</h3>
<p>VDE stands for Virtual Distributed Ethernet. It started as an enhancement of <a href="../../en/User-mode_Linux.html" title="User-mode Linux">uml</a>_switch. It is a toolbox to manage virtual networks.
</p>
<p>The idea is to create virtual switches, which are basically sockets, and to "plug" both physical and virtual machines in them. The configuration we show here is quite simple; However, VDE is much more powerful than this, it can plug virtual switches together, run them on different hosts and monitor the traffic in the switches. You are invited to read <a rel="nofollow" class="external text" href="https://wiki.virtualsquare.org/">the documentation of the project</a>.
</p>
<p>The advantage of this method is you do not have to add sudo privileges to your users. Regular users should not be allowed to run modprobe.
</p>
<h3><span class="mw-headline" id="Basics">Basics</span></h3>
<p>VDE support can be <a href="../../en/Help:Reading.html#Installation_of_packages" class="mw-redirect" title="Install">installed</a> via the <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=vde2">vde2</a></span> package.
</p>
<p>In our config, we use tun/tap to create a virtual interface on my host. Load the <code>tun</code> module (see <a href="../../en/Kernel_module.html" class="mw-redirect" title="Kernel modules">Kernel modules</a> for details):
</p>
<pre># modprobe tun
</pre>
<p>Now create the virtual switch:
</p>
<pre># vde_switch -tap tap0 -daemon -mod 660 -group users
</pre>
<p>This line creates the switch, creates <code>tap0</code>, "plugs" it, and allows the users of the group <code>users</code> to use it.
</p>
<p>The interface is plugged in but not configured yet. To configure it, run this command:
</p>
<pre># ip addr add 192.168.100.254/24 dev tap0
</pre>
<p>Now, you just have to run KVM with these <code>-net</code> options as a normal user:
</p>
<pre>$ qemu-system-x86_64 -net nic -net vde -hda <i>[...]</i>
</pre>
<p>Configure networking for your guest as you would do in a physical network.
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> You might want to set up NAT on tap device to access the internet from the virtual machine. See <a href="../../en/Internet_sharing.html#Enable_NAT" title="Internet sharing">Internet sharing#Enable NAT</a> for more information.</div>
<h3><span class="mw-headline" id="Startup_scripts">Startup scripts</span></h3>
<p>Example of main script starting VDE:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/scripts/qemu-network-env</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">#!/bin/sh
# QEMU/VDE network environment preparation script

# The IP configuration for the tap device that will be used for
# the virtual machine network:

TAP_DEV=tap0
TAP_IP=192.168.100.254
TAP_MASK=24
TAP_NETWORK=192.168.100.0

# Host interface
NIC=eth0

case "$1" in
  start)
        echo -n "Starting VDE network for QEMU: "

        # If you want tun kernel module to be loaded by script uncomment here
	#modprobe tun 2&gt;/dev/null
	## Wait for the module to be loaded
 	#while ! lsmod | grep -q "^tun"; do echo "Waiting for tun device"; sleep 1; done

        # Start tap switch
        vde_switch -tap "$TAP_DEV" -daemon -mod 660 -group users

        # Bring tap interface up
        ip address add "$TAP_IP"/"$TAP_MASK" dev "$TAP_DEV"
        ip link set "$TAP_DEV" up

        # Start IP Forwarding
        echo "1" &gt; /proc/sys/net/ipv4/ip_forward
        iptables -t nat -A POSTROUTING -s "$TAP_NETWORK"/"$TAP_MASK" -o "$NIC" -j MASQUERADE
        ;;
  stop)
        echo -n "Stopping VDE network for QEMU: "
        # Delete the NAT rules
        iptables -t nat -D POSTROUTING -s "$TAP_NETWORK"/"$TAP_MASK" -o "$NIC" -j MASQUERADE

        # Bring tap interface down
        ip link set "$TAP_DEV" down

        # Kill VDE switch
        pgrep vde_switch | xargs kill -TERM
        ;;
  restart|reload)
        $0 stop
        sleep 1
        $0 start
        ;;
  *)
        echo "Usage: $0 {start|stop|restart|reload}"
        exit 1
esac
exit 0
</pre>
<p>Example of systemd service using the above script:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/qemu-network-env.service</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Unit]
Description=Manage VDE Switch

[Service]
Type=oneshot
ExecStart=/etc/systemd/scripts/qemu-network-env start
ExecStop=/etc/systemd/scripts/qemu-network-env stop
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
</pre>
<p>Change permissions for <code>qemu-network-env</code> to be <a href="../../en/Help:Reading.html#Make_executable" class="mw-redirect" title="Executable">executable</a>. 
</p>
<p>You can <a href="../../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Start">start</a> <code>qemu-network-env.service</code> as usual.
</p>
<h3><span class="mw-headline" id="Alternative_method">Alternative method</span></h3>
<p>If the above method does not work or you do not want to mess with kernel configs, TUN, dnsmasq, and iptables you can do the following for the same result.
</p>
<pre># vde_switch -daemon -mod 660 -group users
# slirpvde --dhcp --daemon
</pre>
<p>Then, to start the virtual machine with a connection to the network of the host:
</p>
<pre>$ qemu-system-x86_64 -net nic,macaddr=52:54:00:00:EE:03 -net vde <i>disk_image</i>
</pre>
<h2><span class="mw-headline" id="VDE2_Bridge">VDE2 Bridge</span></h2>
<p>Based on <a rel="nofollow" class="external text" href="https://selamatpagicikgu.wordpress.com/2011/06/08/quickhowto-qemu-networking-using-vde-tuntap-and-bridge/">quickhowto: qemu networking using vde, tun/tap, and bridge</a> graphic. Any virtual machine connected to vde is externally exposed. For example, each virtual machine can receive DHCP configuration directly from your ADSL router.
</p>
<h3><span class="mw-headline" id="Basics_2">Basics</span></h3>
<p>Remember that you need <code>tun</code> module and <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=bridge-utils">bridge-utils</a></span> package.
</p>
<p>Create the vde2/tap device:
</p>
<pre># vde_switch -tap tap0 -daemon -mod 660 -group users
# ip link set tap0 up
</pre>
<p>Create bridge:
</p>
<pre># brctl addbr br0
</pre>
<p>Add devices:
</p>
<pre># brctl addif br0 eth0
# brctl addif br0 tap0
</pre>
<p>And configure bridge interface:
</p>
<pre># dhcpcd br0
</pre>
<h3><span class="mw-headline" id="Startup_scripts_2">Startup scripts</span></h3>
<p>All devices must be set up. And only the bridge needs an IP address. For physical devices on the bridge (e.g. <code>eth0</code>), this can be done with <a href="../../en/Netctl.html" title="Netctl">netctl</a> using a custom Ethernet profile with:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/netctl/ethernet-noip</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">Description='A more versatile static Ethernet connection'
Interface=eth0
Connection=ethernet
IP=no</pre>
<p>The following custom systemd service can be used to create and activate a VDE2 tap interface for users in the <code>users</code> user group.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/vde2@.service</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Unit]
Description=Network Connectivity for %i
Wants=network.target
Before=network.target

[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/usr/bin/vde_switch -tap %i -daemon -mod 660 -group users
ExecStart=/usr/bin/ip link set dev %i up
ExecStop=/usr/bin/ip addr flush dev %i
ExecStop=/usr/bin/ip link set dev %i down

[Install]
WantedBy=multi-user.target</pre>
<p>And finally, you can create the <a href="../../en/Bridge_with_netctl.html" title="Bridge with netctl">bridge interface with netctl</a>.
</p>
</div>
</div>
					<div id="catlinks" class="catlinks" data-mw="interface">
<div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../../Special:Categories.html" title="Special:Categories">Categories</a>: <ul>
<li><a href="../../en/Category:Emulation.html" title="Category:Emulation">Emulation</a></li>
<li><a href="../../en/Category:Hypervisors.html" title="Category:Hypervisors">Hypervisors</a></li>
</ul>
</div>
<div id="mw-hidden-catlinks" class="mw-hidden-catlinks mw-hidden-cats-hidden">Hidden categories: <ul>
<li><a href="../../en/Category:Pages_or_sections_flagged_with_Template:Style.html" title="Category:Pages or sections flagged with Template:Style">Pages or sections flagged with Template:Style</a></li>
<li><a href="../../en/Category:Pages_or_sections_flagged_with_Template:Merge.html" title="Category:Pages or sections flagged with Template:Merge">Pages or sections flagged with Template:Merge</a></li>
</ul>
</div>
</div>
				</div>
			</main>
			
		</div>
		<div class="mw-footer-container">
			
<footer id="footer" class="mw-footer" style="margin: 0">
	<ul id="footer-info">
	<li data-nosnippet="">Retrieved from "<a dir="ltr" href="https://wiki.archlinux.org/index.php?title=QEMU/Advanced_networking&amp;oldid=828614">https://wiki.archlinux.org/index.php?title=QEMU/Advanced_networking&amp;oldid=828614</a>"</li>
<li id="footer-info-lastmod"> This page was last edited on 10 March 2025, at 19:50.</li>
	<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="https://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.3 or later</a> unless otherwise noted.</li>
<br>
</ul>

	<ul id="footer-places">
	<li id="footer-places-privacy"><a href="https://terms.archlinux.org/docs/privacy-policy/">Privacy policy</a></li>
	<li id="footer-places-about"><a href="../../en/ArchWiki:About.html">About ArchWiki</a></li>
	<li id="footer-places-disclaimers"><a href="../../en/ArchWiki:General_disclaimer.html">Disclaimers</a></li>
	<li id="footer-places-archwiki-code-of-conduct"><a href="https://terms.archlinux.org/docs/code-of-conduct/" class="extiw" title="archlinux-service-agreements:code-of-conduct">Code of conduct</a></li>
	<li id="footer-places-archwiki-terms-of-service"><a href="https://terms.archlinux.org/docs/terms-of-service/" class="extiw" title="archlinux-service-agreements:terms-of-service">Terms of service</a></li>
</ul>

	<ul id="footer-icons" class="noprint">
	<li id="footer-copyrightico"><a href="https://www.gnu.org/copyleft/fdl.html" class="cdx-button cdx-button--fake-button cdx-button--size-large cdx-button--fake-button--enabled"><img src="/resources/assets/licenses/gnu-fdl.png" alt="GNU Free Documentation License 1.3 or later" width="88" height="31" loading="lazy"></a></li>
	<li id="footer-poweredbyico"><img src="/resources/assets/poweredby_mediawiki.svg" width="88" height="31" loading="lazy"></li>
</ul>

</footer>

		</div>
	</div> 
</div> 
<div class="vector-settings" id="p-dock-bottom">
	<ul></ul>
</div>
</body>
</html>
