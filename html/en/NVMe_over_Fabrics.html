<!DOCTYPE html>
<html class="client-nojs vector-feature-language-in-header-enabled vector-feature-language-in-main-page-header-disabled vector-feature-sticky-header-disabled vector-feature-page-tools-pinned-disabled vector-feature-toc-pinned-clientpref-1 vector-feature-main-menu-pinned-disabled vector-feature-limited-width-clientpref-1 vector-feature-limited-width-content-enabled vector-feature-custom-font-size-clientpref-0 vector-feature-client-preferences-disabled vector-feature-client-prefs-pinned-disabled vector-feature-night-mode-disabled skin-theme-clientpref-day vector-toc-available" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>NVMe over Fabrics - ArchWiki</title>
<link rel="stylesheet" href="../ArchWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<meta name="generator" content="MediaWiki 1.42.3">
<meta name="referrer" content="no-referrer-when-downgrade">
<meta name="robots" content="max-image-preview:standard">
<meta name="format-detection" content="telephone=no">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=0.25, maximum-scale=5.0">
<link rel="icon" href="/favicon.ico">
<link rel="search" type="application/opensearchdescription+xml" href="/opensearch_desc.php" title="ArchWiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.archlinux.org/api.php?action=rsd">
<link rel="license" href="https://www.gnu.org/copyleft/fdl.html">
<link rel="alternate" type="application/atom+xml" title="ArchWiki Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="skin-vector skin-vector-search-vue mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-NVMe_over_Fabrics rootpage-NVMe_over_Fabrics skin-vector-2022 action-view skin--responsive">
<a class="mw-jump-link" href="#bodyContent">Jump to content</a>
<div class="vector-header-container">
	</div>
<div class="mw-page-container">
	<div class="mw-page-container-inner">
		<div class="vector-column-start">
			<div class="vector-main-menu-container">
		</div>
	<div class="vector-sticky-pinned-container">
				<nav id="mw-panel-toc" role="navigation" aria-label="Contents" data-event-name="ui.sidebar-toc" class="mw-table-of-contents-container vector-toc-landmark">
					<div id="vector-toc-pinned-container" class="vector-pinned-container">
					<div id="vector-toc" class="vector-toc vector-pinnable-element">
	<div class="vector-pinnable-header vector-toc-pinnable-header vector-pinnable-header-pinned" data-feature-name="toc-pinned" data-pinnable-element-id="vector-toc">
	<h2 class="vector-pinnable-header-label">Contents</h2>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-pin-button" data-event-name="pinnable-header.vector-toc.pin">move to sidebar</button>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-unpin-button" data-event-name="pinnable-header.vector-toc.unpin">hide</button>
</div>


	<ul class="vector-toc-contents" id="mw-panel-toc-list">
		<li id="toc-mw-content-text" class="vector-toc-list-item vector-toc-level-1">
			<a href="#" class="vector-toc-link">
				<div class="vector-toc-text">Beginning</div>
			</a>
		</li>
		<li id="toc-Host_configuration" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#Host_configuration">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">1</span>Host configuration</div>
		</a>
		
		<ul id="toc-Host_configuration-sublist" class="vector-toc-list">
		</ul>
	</li>
	<li id="toc-Controller_configuration" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#Controller_configuration">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">2</span>Controller configuration</div>
		</a>
		
			<button aria-controls="toc-Controller_configuration-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Controller configuration subsection</span>
			</button>
		
		<ul id="toc-Controller_configuration-sublist" class="vector-toc-list">
			<li id="toc-Adding_a_device" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Adding_a_device">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.1</span>Adding a device</div>
			</a>
			
			<ul id="toc-Adding_a_device-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Configuring_the_port" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Configuring_the_port">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.2</span>Configuring the port</div>
			</a>
			
			<ul id="toc-Configuring_the_port-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Authentication_using_DHCHAP" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#Authentication_using_DHCHAP">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">3</span>Authentication using DHCHAP</div>
		</a>
		
		<ul id="toc-Authentication_using_DHCHAP-sublist" class="vector-toc-list">
		</ul>
	</li>
	<li id="toc-Booting_from_NVMe-oF" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#Booting_from_NVMe-oF">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">4</span>Booting from NVMe-oF</div>
		</a>
		
		<ul id="toc-Booting_from_NVMe-oF-sublist" class="vector-toc-list">
		</ul>
	</li>
</ul>
</div>

					</div>
		</nav>
			</div>
		</div>
		<div class="mw-content-container">
			<main id="content" class="mw-body" role="main" style="margin: 0">
				<header class="mw-body-header vector-page-titlebar">
					<nav role="navigation" aria-label="Contents" class="vector-toc-landmark">
						
<div id="vector-page-titlebar-toc" class="vector-dropdown vector-page-titlebar-toc vector-button-flush-left">
	<input type="checkbox" id="vector-page-titlebar-toc-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-vector-page-titlebar-toc" class="vector-dropdown-checkbox " aria-label="Toggle the table of contents">
	<label id="vector-page-titlebar-toc-label" for="vector-page-titlebar-toc-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--icon-only " aria-hidden="true"><span class="vector-icon mw-ui-icon-listBullet mw-ui-icon-wikimedia-listBullet"></span>

<span class="vector-dropdown-label-text">Toggle the table of contents</span>
	</label>
	<div class="vector-dropdown-content">


							<div id="vector-page-titlebar-toc-unpinned-container" class="vector-unpinned-container">
			</div>
		
	</div>
</div>

					</nav>
					<h1 id="firstHeading" class="firstHeading mw-first-heading"><span class="mw-page-title-main">NVMe over Fabrics</span></h1>
				</header>
				<div class="vector-column-end">
					<div class="vector-sticky-pinned-container">
						<nav class="vector-page-tools-landmark" aria-label="Page tools">
							<div id="vector-page-tools-pinned-container" class="vector-pinned-container">
				
							</div>
		</nav>
						<nav class="vector-client-prefs-landmark" aria-label="Appearance">
						</nav>
					</div>
				</div>
				<div id="bodyContent" class="vector-body" aria-labelledby="firstHeading" data-mw-ve-target-container>
					<div class="vector-body-before-content">
							<div class="mw-indicators">
		</div>

						<div id="siteSub" class="noprint">From ArchWiki</div>
					</div>
					<div id="contentSub"><div id="mw-content-subtitle"></div></div>
					
					
					<div id="mw-content-text" class="mw-body-content">
<div class="mw-content-ltr mw-parser-output" lang="en" dir="ltr">
<p><a href="https://en.wikipedia.org/wiki/NVMe_over_Fabrics" class="extiw" title="wikipedia:NVMe over Fabrics">NVMe over Fabrics</a> (NVMe-oF) allows sending NVMe commands over <a href="https://en.wikipedia.org/wiki/Ethernet" class="extiw" title="wikipedia:Ethernet">Ethernet</a> or <a href="https://en.wikipedia.org/wiki/Fibre_Channel" class="extiw" title="wikipedia:Fibre Channel">Fibre Channel</a>. This can be used for remote access to block devices similar to <a href="../en/ISCSI.html" title="ISCSI">iSCSI</a>. An NVMe-oF <b>host</b> can access devices exposed by an NVMe-oF <b>controller</b>. This is not limited to NVMe devices, you can also expose <a href="../en/Device_file.html#Block_devices" class="mw-redirect" title="Block device">block devices</a> such as <a href="../en/ZFS.html" title="ZFS">ZFS</a> zvols.
</p>
<meta property="mw:PageProp/toc">
<h2><span class="mw-headline" id="Host_configuration">Host configuration</span></h2>
<p>To access a block device exposed by a remote NVMe-oF controller, <a href="../en/Help:Reading.html#Installation_of_packages" class="mw-redirect" title="Install">install</a> the <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=nvme-cli">nvme-cli</a></span> package.
</p>
<p>First, make sure the necessary kernel module is loaded:
</p>
<pre># modprobe nvme-fabrics
</pre>
<p>Now you can use the CLI to connect to the device:
</p>
<pre># nvme connect --transport=tcp --traddr=192.168.0.5 --trsvcid=4420 --nqn=nqn.2024-08.com.example:my-disk
</pre>
<dl>
<dt>--transport=tcp</dt>
<dd>Specifies the transport protocol. TCP is the most simple to set up.</dd>
<dt>--traddr=192.168.0.5</dt>
<dd>The address of the NVMe-oF target, i.e. the server that exposes the block device.</dd>
<dt>--trsvcid=4420</dt>
<dd>The port the target is listening on. 4420 is the recommended port (IANA assignment).</dd>
<dt>--nqn=nqn.2024-08.com.examplemy-disk</dt>
<dd>The NVMe Qualified Name (NQN) of the <i>device</i> to connect to. The device must be configured on the controller.</dd>
</dl>
<p>After running this command, the device will be available as a normal <a href="../en/Device_file.html#NVMe" title="Device file">NVMe block device</a>, e.g. under <code>/dev/nvme0n1</code> with partitions under <code>/dev/nvme0n1p1</code>. It is recommended to refer to these devices by UUID, however.
</p>
<h2><span class="mw-headline" id="Controller_configuration">Controller configuration</span></h2>
<p><a href="../en/Help:Reading.html#Installation_of_packages" class="mw-redirect" title="Install">Install</a> the <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=nvmetcli">nvmetcli</a></span> package.
</p>
<p>First, make sure the necessary kernel module is loaded:
</p>
<pre># modprobe nvmet
</pre>
<p>Controller configuration happens through a file system located at <code>/sys/kernel/config/nvmet</code>. <i>nvmetcli</i> provides a convenient interface to modify that file system. It also provides a way to load and save the settings. <code>nvmetcli save</code> will save the current state to <code>/etc/nvmet/config.json</code>, and <code>nvmetcli restore</code> will load from that location. You can <a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Enable">enable</a> the <code>nvmet.service</code> unit to load the configuration from that file automatically.
</p>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> <i>nvmetcli</i> will only save, load and edit settings that it recognizes. If you configure unsupported settings (such as DHCHAP) they will be silently dropped. You will have to write them manually to the above filesystem.</div>
<p>Inside <code>nvmetcli</code>, you can navigate using <code>cd</code> and show the config tree using <code>ls</code>. There are three top-level directories.
</p>
<dl>
<dt><code>hosts</code></dt>
<dd>contains the NQNs of hosts that are referenced in other parts of the tree, e.g. for access control. You can add an NQN here and then make the client use that NQN using the <code>nvme connect --hostnqn=...</code> parameter.</dd>
<dt><code>ports</code></dt>
<dd>configures the protocols used to access the devices, e.g. a TCP port.</dd>
<dt><code>subsystems</code></dt>
<dd>configures the individual accessible devices.</dd>
</dl>
<h3><span class="mw-headline" id="Adding_a_device">Adding a device</span></h3>
<p>First you'll want to create a device to expose:
</p>
<pre>/&gt; cd subsystems
/subsystems&gt; create nqn.2024-08.com.example:my-device
/subsystems&gt; cd nqn.2024-08.com.example:my-device
/subsystems/n...ple:my-device&gt;
</pre>
<p>Configure access for the device:
</p>
<pre>/subsystems/n...ple:my-device&gt; set attr allow_any_host=1
</pre>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> This will allow any host with network access to this controller to access the block device. There is no further access control by default.</div>
<p>Configure a namespace for the device and set the backing block device:
</p>
<pre>/subsystems/n...ple:my-device&gt; cd namespaces
/subsystems/n...ce/namespaces&gt; create 1
/subsystems/n...ce/namespaces&gt; cd 1
/subsystems/n.../namespaces/1&gt; set device path=/dev/path/to/block/device
/subsystems/n.../namespaces/1&gt; enable
</pre>
<h3><span class="mw-headline" id="Configuring_the_port">Configuring the port</span></h3>
<p>Next, create a port. Navigate back to the top using <code>cd /</code>.
</p>
<pre>/&gt; cd ports
/ports&gt; create 1
/ports&gt; cd 1
/ports/1&gt; set addr trtype=tcp traddr=192.168.0.5 trsvcid=4420
</pre>
<dl>
<dt>trtype</dt>
<dd>The transport protocol</dd>
<dt>traddr</dt>
<dd>The listener address</dd>
<dt>trsvcid</dt>
<dd>The listener TCP port ("service ID")</dd>
</dl>
<p>Add the device you created above to the network port:
</p>
<pre>/ports/1&gt; cd subsystems
/ports/1/subsystems&gt; create nqn.2024-08.com.example:my-device
</pre>
<p>That's it! Now the device is accessible to the host using the above instructions.
</p>
<h2><span class="mw-headline" id="Authentication_using_DHCHAP">Authentication using DHCHAP</span></h2>
<p>It is prudent to not allow just any device access to the exposed block device. To authenticate the host, NVMe-oF offers a DHCHAP handshake using a secret shared between host and controller. Unfortunately, as of writing, <i>nvmetcli</i> does not support this out of the box, so you have to modify the config FS manually. The host <code>nvme</code> command does support DHCHAP.
</p>
<p>First, use <code>nvmetcli</code> to limit access to the device to only a single host, identified by NQN.
</p>
<pre>/&gt; cd hosts
/hosts&gt; create nqn.2024-08.com.example.host
/hosts&gt; cd /subsystems/nqn.2024-08.com.example:my-device
/subsystems/n...ple:my-device&gt; set attr allow_any_host=0
/subsystems/n...ple:my-device&gt; cd allowed_hosts
/subsystems/n...allowed_hosts&gt; create nqn.2024-08.com.example.host
</pre>
<p>The NVMe controller now knows that only the host with the NQN <code>nqn.2024-08.com.example.host</code> may access the device. You can test this (without DHCHAP, for now) using <code>nvme connect --hostnqn=nqn.2024-08.com.example.host</code>. With the wrong NQN, the connection should fail, with the right NQN, it should succeed.
</p>
<p>The next step is to configure DHCHAP. First you need to generate a secret like so:
</p>
<pre>$ nvme gen-dhchap-key --nqn=nqn.2024-08.com.example.host
DHHC-1:00:znDcb37R200FNlZkIOkv37idpu/notvalid!!si1VQ09KhKv2g:
</pre>
<p>Because <i>nvmetcli</i> does not support DHCHAP, you must configure it manually:
</p>
<pre># echo 'DHHC-1:00:znDcb37R200FNlZkIOkv37idpu/notvalid!!si1VQ09KhKv2g:' &gt; /sys/kernel/config/nvmet/hosts/nqn.2024-08.com.example.host/dhchap_key
</pre>
<p>Now, you can connect using the DHCHAP secret:
</p>
<pre># nvme connect --transport=tcp --traddr=192.168.0.5 --trsvcid=4420 --nqn=nqn.2024-08.com.example:my-disk --hostnqn=nqn.2024-08.com.example.host --dhchap-secret="DHHC-1:00:znDcb37R200FNlZkIOkv37idpu/notvalid!!si1VQ09KhKv2g:"
</pre>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> DHCHAP will authenticate the host but not encrypt the block device data on the network.</div>
<h2><span class="mw-headline" id="Booting_from_NVMe-oF">Booting from NVMe-oF</span></h2>
<p>It is possible to connect to an NVMe-oF device during the boot process inside <a href="../en/Arch_boot_process.html#initramfs" class="mw-redirect" title="Initramfs">initramfs</a> and use the device for the root file system. The procedure is very similar to that for <a href="../en/ISCSI/Boot.html" title="ISCSI/Boot">iSCSI</a>. Only the NVMe-specific parts are listed here for now.
</p>
<p>The <code>initcpio</code> hook is different for NVMe-oF. The install script adds different modules, and adds the <code>nvme</code> binary instead of <code>iscsistart</code>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/initcpio/install/nvme-of</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">build () {
	map add_module nvme-fabrics nvme-tcp nvme-keyring
	add_checked_modules "/drivers/net"
	add_binary nvme
	add_runscript
}
help () {
	cat &lt;&lt;HELPEOF
	This hook allows you to boot from an NVMe-oF target.
HELPEOF
}</pre>
<p>The actual hook uses the CLI to connect to the device:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/initcpio/hooks/nvme-of</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">run_hook () {
	msg "Mounting NVMe-oF target"
	nvme connect --transport=tcp --nqn=nqn.2024-08.com.example:my-device --traddr=192.168.0.5 --trsvcid=4420
}</pre>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> If you configured DHCHAP, make sure to add the required arguments here.</div>
<p>Modify the <code>mkinitcpio</code> configuration:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/mkinitcpio.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">MODULES=(... nvme-fabrics)
HOOKS=(... net nvme-of block ...)</pre>
</div>
</div>
					<div id="catlinks" class="catlinks" data-mw="interface"><div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../Special:Categories.html" title="Special:Categories">Categories</a>: <ul>
<li><a href="../en/Category:Storage.html" title="Category:Storage">Storage</a></li>
<li><a href="../en/Category:Networking.html" title="Category:Networking">Networking</a></li>
</ul>
</div></div>
				</div>
			</main>
			
		</div>
		<div class="mw-footer-container">
			
<footer id="footer" class="mw-footer" role="contentinfo" style="margin: 0">
	<ul id="footer-info">
	<li data-nosnippet="">Retrieved from "<a dir="ltr" href="https://wiki.archlinux.org/index.php?title=NVMe_over_Fabrics&amp;oldid=814892">https://wiki.archlinux.org/index.php?title=NVMe_over_Fabrics&amp;oldid=814892</a>"</li>
<li id="footer-info-lastmod"> This page was last edited on 21 August 2024, at 06:01.</li>
	<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="https://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.3 or later</a> unless otherwise noted.</li>
<br>
</ul>

	<ul id="footer-places">
	<li id="footer-places-privacy"><a href="https://terms.archlinux.org/docs/privacy-policy/">Privacy policy</a></li>
	<li id="footer-places-about"><a href="../en/ArchWiki:About.html">About ArchWiki</a></li>
	<li id="footer-places-disclaimers"><a href="../en/ArchWiki:General_disclaimer.html">Disclaimers</a></li>
	<li id="footer-places-archwiki-code-of-conduct"><a href="https://terms.archlinux.org/docs/code-of-conduct/" class="extiw" title="archlinux-service-agreements:code-of-conduct">Code of conduct</a></li>
	<li id="footer-places-archwiki-terms-of-service"><a href="https://terms.archlinux.org/docs/terms-of-service/" class="extiw" title="archlinux-service-agreements:terms-of-service">Terms of service</a></li>
</ul>

	<ul id="footer-icons" class="noprint">
	<li id="footer-copyrightico"><a href="https://www.gnu.org/copyleft/fdl.html"><img src="/resources/assets/licenses/gnu-fdl.png" alt="GNU Free Documentation License 1.3 or later" width="88" height="31" loading="lazy"></a></li>
	<li id="footer-poweredbyico"><img src="/resources/assets/poweredby_mediawiki_88x31.png" srcset="/resources/assets/poweredby_mediawiki_132x47.png 1.5x, /resources/assets/poweredby_mediawiki_176x62.png 2x" width="88" height="31" loading="lazy"></li>
</ul>

</footer>

		</div>
	</div> 
</div> 
<div class="vector-settings" id="p-dock-bottom">
	<ul>
		<li>
		<button class="cdx-button cdx-button--icon-only vector-limited-width-toggle" id=""><span class="vector-icon mw-ui-icon-fullScreen mw-ui-icon-wikimedia-fullScreen"></span>

<span>Toggle limited content width</span>
</button>
</li>
	</ul>
</div>
</body>
</html>
