<!DOCTYPE html>
<html class="client-nojs vector-feature-language-in-header-enabled vector-feature-language-in-main-page-header-disabled vector-feature-sticky-header-disabled vector-feature-page-tools-pinned-disabled vector-feature-toc-pinned-clientpref-1 vector-feature-main-menu-pinned-disabled vector-feature-limited-width-clientpref-1 vector-feature-limited-width-content-enabled vector-feature-custom-font-size-clientpref-0 vector-feature-client-preferences-disabled vector-feature-client-prefs-pinned-disabled vector-feature-night-mode-disabled skin-theme-clientpref-day vector-toc-available" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>Btrfs - ArchWiki</title>
<link rel="stylesheet" href="../ArchWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<meta name="generator" content="MediaWiki 1.42.1">
<meta name="referrer" content="no-referrer-when-downgrade">
<meta name="robots" content="max-image-preview:standard">
<meta name="format-detection" content="telephone=no">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=0.25, maximum-scale=5.0">
<link rel="icon" href="/favicon.ico">
<link rel="search" type="application/opensearchdescription+xml" href="/opensearch_desc.php" title="ArchWiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.archlinux.org/api.php?action=rsd">
<link rel="license" href="https://www.gnu.org/copyleft/fdl.html">
<link rel="alternate" type="application/atom+xml" title="ArchWiki Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="skin-vector skin-vector-search-vue mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-Btrfs rootpage-Btrfs skin-vector-2022 action-view skin--responsive">
<a class="mw-jump-link" href="#bodyContent">Jump to content</a>
<div class="vector-header-container">
	</div>
<div class="mw-page-container">
	<div class="mw-page-container-inner">
		<div class="vector-column-start">
			<div class="vector-main-menu-container">
		</div>
	<div class="vector-sticky-pinned-container">
				<nav id="mw-panel-toc" role="navigation" aria-label="Contents" data-event-name="ui.sidebar-toc" class="mw-table-of-contents-container vector-toc-landmark">
					<div id="vector-toc-pinned-container" class="vector-pinned-container">
					<div id="vector-toc" class="vector-toc vector-pinnable-element">
	<div class="vector-pinnable-header vector-toc-pinnable-header vector-pinnable-header-pinned" data-feature-name="toc-pinned" data-pinnable-element-id="vector-toc">
	<h2 class="vector-pinnable-header-label">Contents</h2>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-pin-button" data-event-name="pinnable-header.vector-toc.pin">move to sidebar</button>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-unpin-button" data-event-name="pinnable-header.vector-toc.unpin">hide</button>
</div>


	<ul class="vector-toc-contents" id="mw-panel-toc-list">
		<li id="toc-mw-content-text" class="vector-toc-list-item vector-toc-level-1">
			<a href="#" class="vector-toc-link">
				<div class="vector-toc-text">Beginning</div>
			</a>
		</li>
		<li id="toc-Preparation" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#Preparation">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">1</span>Preparation</div>
		</a>
		
		<ul id="toc-Preparation-sublist" class="vector-toc-list">
		</ul>
	</li>
	<li id="toc-File_system_creation" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#File_system_creation">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">2</span>File system creation</div>
		</a>
		
			<button aria-controls="toc-File_system_creation-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle File system creation subsection</span>
			</button>
		
		<ul id="toc-File_system_creation-sublist" class="vector-toc-list">
			<li id="toc-File_system_on_a_single_device" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#File_system_on_a_single_device">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.1</span>File system on a single device</div>
			</a>
			
			<ul id="toc-File_system_on_a_single_device-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Multi-device_file_system" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Multi-device_file_system">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.2</span>Multi-device file system</div>
			</a>
			
			<ul id="toc-Multi-device_file_system-sublist" class="vector-toc-list">
				<li id="toc-Profiles" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Profiles">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.2.1</span>Profiles</div>
			</a>
			
			<ul id="toc-Profiles-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Configuring_the_file_system" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#Configuring_the_file_system">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">3</span>Configuring the file system</div>
		</a>
		
			<button aria-controls="toc-Configuring_the_file_system-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Configuring the file system subsection</span>
			</button>
		
		<ul id="toc-Configuring_the_file_system-sublist" class="vector-toc-list">
			<li id="toc-Copy-on-Write_(CoW)" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Copy-on-Write_(CoW)">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.1</span>Copy-on-Write (CoW)</div>
			</a>
			
			<ul id="toc-Copy-on-Write_(CoW)-sublist" class="vector-toc-list">
				<li id="toc-Disabling_CoW" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Disabling_CoW">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.1.1</span>Disabling CoW</div>
			</a>
			
			<ul id="toc-Disabling_CoW-sublist" class="vector-toc-list">
				<li id="toc-Effect_on_snapshots" class="vector-toc-list-item vector-toc-level-4">
			<a class="vector-toc-link" href="#Effect_on_snapshots">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.1.1.1</span>Effect on snapshots</div>
			</a>
			
			<ul id="toc-Effect_on_snapshots-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Compression" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Compression">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.2</span>Compression</div>
			</a>
			
			<ul id="toc-Compression-sublist" class="vector-toc-list">
				<li id="toc-View_compression_types_and_ratios" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#View_compression_types_and_ratios">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.2.1</span>View compression types and ratios</div>
			</a>
			
			<ul id="toc-View_compression_types_and_ratios-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Subvolumes" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Subvolumes">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.3</span>Subvolumes</div>
			</a>
			
			<ul id="toc-Subvolumes-sublist" class="vector-toc-list">
				<li id="toc-Creating_a_subvolume" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Creating_a_subvolume">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.3.1</span>Creating a subvolume</div>
			</a>
			
			<ul id="toc-Creating_a_subvolume-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Listing_subvolumes" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Listing_subvolumes">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.3.2</span>Listing subvolumes</div>
			</a>
			
			<ul id="toc-Listing_subvolumes-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Deleting_a_subvolume" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Deleting_a_subvolume">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.3.3</span>Deleting a subvolume</div>
			</a>
			
			<ul id="toc-Deleting_a_subvolume-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Mounting_subvolumes" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Mounting_subvolumes">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.3.4</span>Mounting subvolumes</div>
			</a>
			
			<ul id="toc-Mounting_subvolumes-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Mounting_subvolume_as_root" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Mounting_subvolume_as_root">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.3.5</span>Mounting subvolume as root</div>
			</a>
			
			<ul id="toc-Mounting_subvolume_as_root-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Changing_the_default_sub-volume" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Changing_the_default_sub-volume">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.3.6</span>Changing the default sub-volume</div>
			</a>
			
			<ul id="toc-Changing_the_default_sub-volume-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Quota" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Quota">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.4</span>Quota</div>
			</a>
			
			<ul id="toc-Quota-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Commit_interval" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Commit_interval">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.5</span>Commit interval</div>
			</a>
			
			<ul id="toc-Commit_interval-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-SSD_TRIM" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#SSD_TRIM">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.6</span>SSD TRIM</div>
			</a>
			
			<ul id="toc-SSD_TRIM-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Usage" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#Usage">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">4</span>Usage</div>
		</a>
		
			<button aria-controls="toc-Usage-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Usage subsection</span>
			</button>
		
		<ul id="toc-Usage-sublist" class="vector-toc-list">
			<li id="toc-Swap_file" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Swap_file">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">4.1</span>Swap file</div>
			</a>
			
			<ul id="toc-Swap_file-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Displaying_used/free_space" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Displaying_used/free_space">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">4.2</span>Displaying used/free space</div>
			</a>
			
			<ul id="toc-Displaying_used/free_space-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Defragmentation" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Defragmentation">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">4.3</span>Defragmentation</div>
			</a>
			
			<ul id="toc-Defragmentation-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-RAID" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#RAID">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">4.4</span>RAID</div>
			</a>
			
			<ul id="toc-RAID-sublist" class="vector-toc-list">
				<li id="toc-Scrub" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Scrub">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">4.4.1</span>Scrub</div>
			</a>
			
			<ul id="toc-Scrub-sublist" class="vector-toc-list">
				<li id="toc-Start_manually" class="vector-toc-list-item vector-toc-level-4">
			<a class="vector-toc-link" href="#Start_manually">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">4.4.1.1</span>Start manually</div>
			</a>
			
			<ul id="toc-Start_manually-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Start_with_a_service_or_timer" class="vector-toc-list-item vector-toc-level-4">
			<a class="vector-toc-link" href="#Start_with_a_service_or_timer">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">4.4.1.2</span>Start with a service or timer</div>
			</a>
			
			<ul id="toc-Start_with_a_service_or_timer-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Balance" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Balance">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">4.4.2</span>Balance</div>
			</a>
			
			<ul id="toc-Balance-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Snapshots" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Snapshots">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">4.5</span>Snapshots</div>
			</a>
			
			<ul id="toc-Snapshots-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Send/receive" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Send/receive">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">4.6</span>Send/receive</div>
			</a>
			
			<ul id="toc-Send/receive-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Deduplication" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Deduplication">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">4.7</span>Deduplication</div>
			</a>
			
			<ul id="toc-Deduplication-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Resizing" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Resizing">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">4.8</span>Resizing</div>
			</a>
			
			<ul id="toc-Resizing-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Known_issues" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#Known_issues">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">5</span>Known issues</div>
		</a>
		
			<button aria-controls="toc-Known_issues-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Known issues subsection</span>
			</button>
		
		<ul id="toc-Known_issues-sublist" class="vector-toc-list">
			<li id="toc-Encryption" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Encryption">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">5.1</span>Encryption</div>
			</a>
			
			<ul id="toc-Encryption-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-btrfs_check_issues" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#btrfs_check_issues">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">5.2</span>btrfs check issues</div>
			</a>
			
			<ul id="toc-btrfs_check_issues-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Tips_and_tricks" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#Tips_and_tricks">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">6</span>Tips and tricks</div>
		</a>
		
			<button aria-controls="toc-Tips_and_tricks-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Tips and tricks subsection</span>
			</button>
		
		<ul id="toc-Tips_and_tricks-sublist" class="vector-toc-list">
			<li id="toc-Partitionless_Btrfs_disk" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Partitionless_Btrfs_disk">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">6.1</span>Partitionless Btrfs disk</div>
			</a>
			
			<ul id="toc-Partitionless_Btrfs_disk-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Ext3/4_to_Btrfs_conversion" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Ext3/4_to_Btrfs_conversion">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">6.2</span>Ext3/4 to Btrfs conversion</div>
			</a>
			
			<ul id="toc-Ext3/4_to_Btrfs_conversion-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Corruption_recovery" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Corruption_recovery">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">6.3</span>Corruption recovery</div>
			</a>
			
			<ul id="toc-Corruption_recovery-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Booting_into_snapshots" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Booting_into_snapshots">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">6.4</span>Booting into snapshots</div>
			</a>
			
			<ul id="toc-Booting_into_snapshots-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Use_Btrfs_subvolumes_with_systemd-nspawn" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Use_Btrfs_subvolumes_with_systemd-nspawn">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">6.5</span>Use Btrfs subvolumes with systemd-nspawn</div>
			</a>
			
			<ul id="toc-Use_Btrfs_subvolumes_with_systemd-nspawn-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Reducing_access_time_metadata_updates" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Reducing_access_time_metadata_updates">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">6.6</span>Reducing access time metadata updates</div>
			</a>
			
			<ul id="toc-Reducing_access_time_metadata_updates-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Incremental_backup_to_external_drive" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Incremental_backup_to_external_drive">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">6.7</span>Incremental backup to external drive</div>
			</a>
			
			<ul id="toc-Incremental_backup_to_external_drive-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Automatic_snapshots" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Automatic_snapshots">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">6.8</span>Automatic snapshots</div>
			</a>
			
			<ul id="toc-Automatic_snapshots-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Troubleshooting" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#Troubleshooting">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">7</span>Troubleshooting</div>
		</a>
		
			<button aria-controls="toc-Troubleshooting-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Troubleshooting subsection</span>
			</button>
		
		<ul id="toc-Troubleshooting-sublist" class="vector-toc-list">
			<li id="toc-GRUB" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#GRUB">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">7.1</span>GRUB</div>
			</a>
			
			<ul id="toc-GRUB-sublist" class="vector-toc-list">
				<li id="toc-Partition_offset" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Partition_offset">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">7.1.1</span>Partition offset</div>
			</a>
			
			<ul id="toc-Partition_offset-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Missing_root" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Missing_root">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">7.1.2</span>Missing root</div>
			</a>
			
			<ul id="toc-Missing_root-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Mounting_timed_out" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Mounting_timed_out">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">7.2</span>Mounting timed out</div>
			</a>
			
			<ul id="toc-Mounting_timed_out-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-BTRFS:_open_ctree_failed" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#BTRFS:_open_ctree_failed">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">7.3</span>BTRFS: open_ctree failed</div>
			</a>
			
			<ul id="toc-BTRFS:_open_ctree_failed-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-btrfs_check" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#btrfs_check">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">7.4</span>btrfs check</div>
			</a>
			
			<ul id="toc-btrfs_check-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Constant_drive_activity" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Constant_drive_activity">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">7.5</span>Constant drive activity</div>
			</a>
			
			<ul id="toc-Constant_drive_activity-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-See_also" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#See_also">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">8</span>See also</div>
		</a>
		
		<ul id="toc-See_also-sublist" class="vector-toc-list">
		</ul>
	</li>
</ul>
</div>

					</div>
		</nav>
			</div>
		</div>
		<div class="mw-content-container">
			<main id="content" class="mw-body" role="main" style="margin: 0">
				<header class="mw-body-header vector-page-titlebar">
					<nav role="navigation" aria-label="Contents" class="vector-toc-landmark">
						
<div id="vector-page-titlebar-toc" class="vector-dropdown vector-page-titlebar-toc vector-button-flush-left">
	<input type="checkbox" id="vector-page-titlebar-toc-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-vector-page-titlebar-toc" class="vector-dropdown-checkbox " aria-label="Toggle the table of contents">
	<label id="vector-page-titlebar-toc-label" for="vector-page-titlebar-toc-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--icon-only " aria-hidden="true"><span class="vector-icon mw-ui-icon-listBullet mw-ui-icon-wikimedia-listBullet"></span>

<span class="vector-dropdown-label-text">Toggle the table of contents</span>
	</label>
	<div class="vector-dropdown-content">


							<div id="vector-page-titlebar-toc-unpinned-container" class="vector-unpinned-container">
			</div>
		
	</div>
</div>

					</nav>
					<h1 id="firstHeading" class="firstHeading mw-first-heading"><span class="mw-page-title-main">Btrfs</span></h1>
							
<div id="p-lang-btn" class="vector-dropdown mw-portlet mw-portlet-lang">
	<input type="checkbox" id="p-lang-btn-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-p-lang-btn" class="vector-dropdown-checkbox mw-interlanguage-selector" aria-label="Go to an article in another language. Available in 7 languages">
	<label id="p-lang-btn-label" for="p-lang-btn-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--action-progressive mw-portlet-lang-heading-7" aria-hidden="true"><span class="vector-icon mw-ui-icon-language-progressive mw-ui-icon-wikimedia-language-progressive"></span>

<span class="vector-dropdown-label-text">7 languages</span>
	</label>
	<div class="vector-dropdown-content">

		<div class="vector-menu-content">
			
			<ul class="vector-menu-content-list">
				
				<li class="interlanguage-link interwiki-de mw-list-item"><a href="https://wiki.archlinux.de/title/Arch_auf_BtrFS" title="Arch auf BtrFS – Deutsch" lang="de" hreflang="de" class="interlanguage-link-target"><span>Deutsch</span></a></li>
<li class="interlanguage-link interwiki-es mw-list-item"><a href="../es/Btrfs.html" title="Btrfs – español" lang="es" hreflang="es" class="interlanguage-link-target"><span>Español</span></a></li>
<li class="interlanguage-link interwiki-it mw-list-item"><a href="../it/Btrfs.html" title="Btrfs – italiano" lang="it" hreflang="it" class="interlanguage-link-target"><span>Italiano</span></a></li>
<li class="interlanguage-link interwiki-ja mw-list-item"><a href="https://wiki.archlinux.jp/index.php/Btrfs" title="Btrfs – 日本語" lang="ja" hreflang="ja" class="interlanguage-link-target"><span>日本語</span></a></li>
<li class="interlanguage-link interwiki-pt mw-list-item"><a href="../pt/Btrfs.html" title="Btrfs – português" lang="pt" hreflang="pt" class="interlanguage-link-target"><span>Português</span></a></li>
<li class="interlanguage-link interwiki-ru mw-list-item"><a href="../ru/Btrfs.html" title="Btrfs – русский" lang="ru" hreflang="ru" class="interlanguage-link-target"><span>Русский</span></a></li>
<li class="interlanguage-link interwiki-zh-hans mw-list-item"><a href="https://wiki.archlinuxcn.org/wiki/Btrfs" title="Btrfs – 中文（简体）" lang="zh-Hans" hreflang="zh-Hans" class="interlanguage-link-target"><span>中文（简体）</span></a></li>
			</ul>
			
		</div>

	</div>
</div>
</header>
				<div class="vector-column-end">
					<div class="vector-sticky-pinned-container">
						<nav class="vector-page-tools-landmark" aria-label="Page tools">
							<div id="vector-page-tools-pinned-container" class="vector-pinned-container">
				
							</div>
		</nav>
						<nav class="vector-client-prefs-landmark" aria-label="Appearance">
						</nav>
					</div>
				</div>
				<div id="bodyContent" class="vector-body" aria-labelledby="firstHeading" data-mw-ve-target-container>
					<div class="vector-body-before-content">
							<div class="mw-indicators">
		</div>

						<div id="siteSub" class="noprint">From ArchWiki</div>
					</div>
					<div id="contentSub"><div id="mw-content-subtitle"></div></div>
					
					
					<div id="mw-content-text" class="mw-body-content">
<div class="mw-content-ltr mw-parser-output" lang="en" dir="ltr">
<div class="archwiki-template-meta-related-articles">
<p>Related articles</p>
<ul>
<li><a href="../en/File_systems.html" title="File systems">File systems</a></li>
<li><a href="../en/Snapper.html" title="Snapper">Snapper</a></li>
<li><a href="../en/Timeshift.html" title="Timeshift">Timeshift</a></li>
<li><a href="../en/Yabsnap.html" title="Yabsnap">Yabsnap</a></li>
</ul>
</div>
<p>From the <a rel="nofollow" class="external text" href="https://btrfs.readthedocs.io/en/latest/Introduction.html">Btrfs Documentation</a>:
</p>
<dl><dd>Btrfs is a modern copy on write (COW) file system for Linux aimed at implementing advanced features while also focusing on fault tolerance, repair and easy administration.</dd></dl>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> Like some other file systems, Btrfs is under continuous development. This means that specific features may not be ready for everyday use yet. To see if your use case might be affected, check the Btrfs Documentation’s <a rel="nofollow" class="external text" href="https://btrfs.readthedocs.io/en/latest/Status.html">Status</a> and the <a href="#Known_issues">#Known issues</a> section of this article.</div>
<meta property="mw:PageProp/toc">
<h2><span class="mw-headline" id="Preparation">Preparation</span></h2>
<p>For user space utilities, <a href="../en/Help:Reading.html#Installation_of_packages" class="mw-redirect" title="Install">install</a> the <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=btrfs-progs">btrfs-progs</a></span> package that is required for basic operations.
</p>
<p>If you need to boot from a Btrfs file system (i.e., your kernel and initramfs reside on a Btrfs partition), check if your <a href="../en/Arch_boot_process.html#Boot_loader" class="mw-redirect" title="Boot loader">boot loader</a> supports Btrfs.
</p>
<h2><span class="mw-headline" id="File_system_creation">File system creation</span></h2>
<p>The following shows how to create a new Btrfs <a href="../en/File_systems.html" class="mw-redirect" title="File system">file system</a>. To convert an Ext3/4 partition to Btrfs, see <a href="#Ext3/4_to_Btrfs_conversion">#Ext3/4 to Btrfs conversion</a>. To use a partitionless setup, see <a href="#Partitionless_Btrfs_disk">#Partitionless Btrfs disk</a>.
</p>
<p>See <span class="plainlinks archwiki-template-man" title="$ man 8 mkfs.btrfs"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/mkfs.btrfs.8">mkfs.btrfs(8)</a></span> for more information.
</p>
<h3><span class="mw-headline" id="File_system_on_a_single_device">File system on a single device</span></h3>
<p>To create a Btrfs file system on partition <code>/dev/<i>partition</i></code>:
</p>
<pre># mkfs.btrfs -L <i>mylabel</i> /dev/<i>partition</i>
</pre>
<p>The Btrfs default nodesize for metadata is 16 KiB, while the default sectorsize for data is equal to page size and autodetected. To use a larger nodesize for metadata (must be a multiple of sectorsize, up to 64 KiB is allowed), specify a value for the <code>nodesize</code> via the <code>-n</code> switch as shown in this example using 32 KiB blocks:
</p>
<pre># mkfs.btrfs -L <i>mylabel</i> -n 32k /dev/<i>partition</i>
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> According to <span class="plainlinks archwiki-template-man" title="$ man 8 mkfs.btrfs"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/mkfs.btrfs.8#OPTIONS">mkfs.btrfs(8) § OPTIONS</a></span>, "[a] smaller node size increases fragmentation but leads to taller b-trees which in turn leads to lower locking contention. Higher node sizes give better packing and less fragmentation at the cost of more expensive memory operations while updating the metadata blocks".</div>
<h3><span class="mw-headline" id="Multi-device_file_system">Multi-device file system</span></h3>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> 
<ul>
<li>The RAID 5 and RAID 6 modes of Btrfs are fatally flawed, and should not be used for "anything but testing with throw-away data." <a rel="nofollow" class="external text" href="https://lore.kernel.org/linux-btrfs/20200627032414.GX10769@hungrycats.org/">List of known problems and partial workarounds</a>. See <span class="plainlinks archwiki-template-man" title="$ man 5 btrfs"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/btrfs.5#RAID56_STATUS_AND_RECOMMENDED_PRACTICES">btrfs(5) § RAID56 STATUS AND RECOMMENDED PRACTICES</a></span> for status updates.</li>
<li>By default, <a href="../en/Systemd.html" title="Systemd">systemd</a> disables <a href="#Copy-on-Write_(CoW)">CoW</a> for <code>/var/log/journal</code>, which can cause data corruption on RAID 1 (see <a href="#Disabling_CoW">#Disabling CoW</a>). To prevent this, create an empty file <code>/etc/tmpfiles.d/journal-nocow.conf</code> to override <code>/usr/lib/tmpfiles.d/journal-nocow.conf</code> (see <span class="plainlinks archwiki-template-man" title="$ man 5 tmpfiles.d"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/tmpfiles.d.5#CONFIGURATION_DIRECTORIES_AND_PRECEDENCE">tmpfiles.d(5) § CONFIGURATION DIRECTORIES AND PRECEDENCE</a></span>).</li>
</ul>
</div>
<p>Multiple devices can be used to create a RAID. Supported RAID levels include RAID 0, RAID 1, RAID 10, RAID 5 and RAID 6. Starting from kernel 5.5 RAID1c3 and RAID1c4 for 3- and 4- copies of RAID 1 level. The RAID levels can be configured separately for data and metadata using the <code>-d</code> and <code>-m</code> options respectively. By default, the data has one copy (<code>single</code>) and the metadata is mirrored (<code>raid1</code>). This is similar to 
creating a <a href="https://en.wikipedia.org/wiki/JBOD" class="extiw" title="w:JBOD">JBOD configuration</a>, where disks are seen as one file system, but files are not duplicated. See <a rel="nofollow" class="external text" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/Using_Btrfs_with_Multiple_Devices.html">Using Btrfs with Multiple Devices</a> for more information about how to create a Btrfs RAID volume.
</p>
<pre># mkfs.btrfs -d single -m raid1 /dev/<i>part1</i> /dev/<i>part2</i> ...
</pre>
<p>You must include either the <code>udev</code> hook, <code>systemd</code> hook or the <code>btrfs</code> hook in <code>/etc/mkinitcpio.conf</code> in order to use multiple Btrfs devices in a pool. See the <a href="../en/Mkinitcpio.html#Common_hooks" title="Mkinitcpio">Mkinitcpio#Common hooks</a> article for more information.
</p>
<p>Once the file system is created, it is advised to run the following command to scan for multi-device Btrfs file systems and register them, allowing to mount the multi-device file system by specifying only one member:
</p>
<pre># btrfs device scan
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> 
<ul>
<li>It is possible to add devices to a multiple-device file system later on. See the <a rel="nofollow" class="external text" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/Using_Btrfs_with_Multiple_Devices.html">Btrfs wiki article</a> for more information.</li>
<li>Devices can be of different sizes. However, if one drive in a RAID configuration is bigger than the others, this extra space will not be used.</li>
<li>Some <a href="../en/Arch_boot_process.html#Boot_loader" class="mw-redirect" title="Boot loader">boot loaders</a> such as <a href="../en/Syslinux.html" title="Syslinux">Syslinux</a> do not support multi-device file systems.</li>
<li>Btrfs does not automatically read from the fastest device, so mixing different kinds of disks results in inconsistent performance. See <a rel="nofollow" class="external autonumber" href="https://stackoverflow.com/a/55408367">[1]</a> for details.</li>
</ul>
</div>
<p>See <a href="#RAID">#RAID</a> for advice on maintenance specific to multi-device Btrfs file systems.
</p>
<h4><span class="mw-headline" id="Profiles">Profiles</span></h4>
<p>Btrfs uses the concept of <a rel="nofollow" class="external text" href="https://btrfs.readthedocs.io/en/latest/mkfs.btrfs.html#profiles">profiles</a> to configure mirroring, parity, and striping. In standard <a href="https://en.wikipedia.org/wiki/RAID" class="extiw" title="wikipedia:RAID">RAID</a> terminology, this is called <i>RAID level</i>. Profiles for metadata (the <code>-m</code> option of <span class="plainlinks archwiki-template-man" title="$ man 8 mkfs.btrfs"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/mkfs.btrfs.8">mkfs.btrfs(8)</a></span>) and data (the <code>-d</code> option of <span class="plainlinks archwiki-template-man" title="$ man 8 mkfs.btrfs"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/mkfs.btrfs.8">mkfs.btrfs(8)</a></span>) may be different for the same Btrfs file system.
</p>
<p>Some notable profiles:
</p>
<dl>
<dt>single</dt>
<dd>No mirroring, no striping, no parity, enables mapping several devices to a single file system, called <code>LINEAR</code> in <a href="../en/RAID.html" class="mw-redirect" title="Mdadm">mdadm</a> terminology.</dd>
<dt>raid0</dt>
<dd>No mirroring, striping, no parity, enables parallel access between devices, but not limited to same-size devices like traditional <a href="../en/RAID.html" class="mw-redirect" title="Mdadm">mdadm</a> RAID.</dd>
<dt>raid1</dt>
<dd>Mirroring, no striping, no parity, enables recovering from one drive failure.</dd>
</dl>
<h2><span class="mw-headline" id="Configuring_the_file_system">Configuring the file system</span></h2>
<h3>
<span id="Copy-on-Write_.28CoW.29"></span><span class="mw-headline" id="Copy-on-Write_(CoW)">Copy-on-Write (CoW)</span>
</h3>
<p>By default, Btrfs uses <a href="https://en.wikipedia.org/wiki/copy-on-write" class="extiw" title="wikipedia:copy-on-write">copy-on-write</a> for all files all the time. Writes do not overwrite data in place; instead, a modified copy of the block is written to a new location, and metadata is updated to point at the new location. See the <a rel="nofollow" class="external text" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/SysadminGuide.html#Copy_on_Write_.28CoW.29">Btrfs Sysadmin Guide section</a> for implementation details, as well as advantages and disadvantages.
</p>
<h4><span class="mw-headline" id="Disabling_CoW">Disabling CoW</span></h4>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> Disabling CoW in Btrfs also disables checksums. Btrfs will not be able to detect corrupted <code>nodatacow</code> files. When combined with RAID 1, power outages or other sources of corruption can cause the data to become out of sync.</div>
<p>To disable copy-on-write for newly created files in a mounted subvolume, use the <code>nodatacow</code> mount option. This will only affect newly created files. Copy-on-write will still happen for existing files. The <code>nodatacow</code> option also disables compression. See <span class="plainlinks archwiki-template-man" title="$ man 5 btrfs"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/btrfs.5">btrfs(5)</a></span> for details.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> From <span class="plainlinks archwiki-template-man" title="$ man 5 btrfs"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/btrfs.5#MOUNT_OPTIONS">btrfs(5) § MOUNT OPTIONS</a></span>: "within a single file system, it is not possible to mount some subvolumes with <code>nodatacow</code> and others with <code>datacow</code>. The mount option of the first mounted subvolume applies to any other subvolumes."</div>
<p>To disable copy-on-write for single files/directories, do:
</p>
<pre>$ chattr +C <i>/dir/file</i>
</pre>
<p>This will disable copy-on-write for those operation in which there is only one reference to the file. If there is more than one reference, e.g. due to file clones or lightweight clones or file system snapshots, copy-on-write still occurs. Note that as of <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=coreutils">coreutils</a></span> 9.0, <code>cp</code> attempts to perform lightweight copies by default — see <span class="plainlinks archwiki-template-man" title="$ man 1 cp"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/cp.1">cp(1)</a></span> for more details.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> From <span class="plainlinks archwiki-template-man" title="$ man 1 chattr"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/chattr.1">chattr(1)</a></span>: "For Btrfs, the '<code>C</code>' flag should be set on new or empty files. If it is set on a file which already has data blocks, it is undefined when the blocks assigned to the file will be fully stable. If the '<code>C</code>' flag is set on a directory, it will have no effect on the directory, but new files created in that directory will have the <code>No_COW</code> attribute."</div>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> In accordance with the note above, you can use the following trick to disable copy-on-write on existing files in a directory:
<pre>$ mv <i>/path/to/dir</i> <i>/path/to/dir</i>_old
$ mkdir <i>/path/to/dir</i>
$ chattr +C <i>/path/to/dir</i>
$ cp -a --reflink=never <i>/path/to/dir</i>_old/. <i>/path/to/dir</i>
$ rm -rf <i>/path/to/dir</i>_old
</pre>
Make sure that the data are not used during this process. Also note that <code>mv</code> or <code>cp</code> without <code>--reflink=never</code> as described below will not work.</div>
<h5><span class="mw-headline" id="Effect_on_snapshots">Effect on snapshots</span></h5>
<p>If a file has copy-on-write disabled (NOCOW) and a <a href="#Snapshots">snapshot</a> is taken, the first write to a file block after the snapshot <a rel="nofollow" class="external text" href="https://www.spinics.net/lists/linux-btrfs/msg33090.html">will be a COW operation</a> because the snapshot locks the old file blocks in place. However, the file will retain the NOCOW attribute and any subsequent writes to the same file block will be in-place until the next snapshot.
</p>
<p>Frequent snapshots can reduce the effectiveness of NOCOW, as COW is still required on the first write. To avoid copy-on-write for such files altogether, put them in a separate subvolume and do not take snapshots of that subvolume.
</p>
<h3><span class="mw-headline" id="Compression">Compression</span></h3>
<p>Btrfs supports <a rel="nofollow" class="external text" href="https://btrfs.readthedocs.io/en/latest/Compression.html">transparent and automatic compression</a>. This reduces the size of files as well as significantly increases the lifespan of flash-based media by reducing write amplification. See <a href="https://fedoraproject.org/wiki/Changes/BtrfsByDefault#Compression" class="extiw" title="fedora:Changes/BtrfsByDefault">Fedora:Changes/BtrfsByDefault#Compression</a>, <a rel="nofollow" class="external autonumber" href="https://lists.fedoraproject.org/archives/list/devel@lists.fedoraproject.org/message/NTV77NFF6NDZM3QTPUM2TQZ5PCM6GOO2/">[2]</a>, and <a rel="nofollow" class="external autonumber" href="https://pagure.io/fedora-btrfs/project/issue/36#comment-701551">[3]</a>. It can also <a rel="nofollow" class="external text" href="https://www.phoronix.com/scan.php?page=article&amp;item=btrfs_compress_2635&amp;num=1">improve performance</a>, in some cases (e.g. single thread with heavy file I/O), while obviously harming performance in other cases (e.g. multi-threaded and/or CPU intensive tasks with large file I/O). Better performance is generally achieved with the fastest compress algorithms, <i>zstd</i> and <i>lzo</i>, and some <a rel="nofollow" class="external text" href="https://www.phoronix.com/scan.php?page=article&amp;item=btrfs-zstd-compress">benchmarks</a> provide detailed comparisons.
</p>
<p>LZO has a fixed compression level, whereas zlib and zstd have a range of levels from 1 (low compression) to 9 (zlib) or 15 (zstd); see <span class="plainlinks archwiki-template-man" title="$ man 5 btrfs"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/btrfs.5#COMPRESSION">btrfs(5) § COMPRESSION</a></span>. Changing the levels will affect CPU and I/O throughput differently, so they should be checked / benchmarked before and after changing.
</p>
<p>The <code>compress=<i>alg[:level]</i></code> mount option enables automatically considering every file for compression, where <code><i>alg</i></code> is either <code>zlib</code>, <code>lzo</code>, <code>zstd</code>, or <code>no</code> (for no compression). Using this option, Btrfs will check if compressing the first portion of the data shrinks it.  If it does, the entire write to that file will be compressed.  If it does not, none of it is compressed.  With this option, if the first portion of the write does not shrink, no compression will be applied to the write even if the rest of the data would shrink tremendously. <a rel="nofollow" class="external autonumber" href="https://btrfs.readthedocs.io/en/latest/Compression.html#incompressible-data">[4]</a>  This is done to prevent making the disk wait to start writing until all of the data to be written is fully given to Btrfs and compressed.
</p>
<div class="noprint archwiki-template-message">
<p><span class="mw-default-size" typeof="mw:File"><span><img src="../File:Tango-view-fullscreen.svg" decoding="async" width="48" height="48" class="mw-file-element"></span></span><b>This article or section needs expansion.</b></p>
<div>
<b>Reason:</b> Missing reference for the "empirical testing" mentioned in the following paragraph. (Discuss in <a rel="nofollow" class="external text" href="../en/Talk:Btrfs.html">Talk:Btrfs</a>)</div>
</div>
<p>The <code>compress-force=<i>alg[:level]</i></code> mount option can be used instead, which makes Btrfs skip checking if compression shrinks the first portion, and enables automatic compression try for every file.  In a worst-case scenario, this can cause (slightly) more CPU usage for no purpose. However, empirical testing on multiple mixed-use systems showed a significant improvement of about 10% disk compression from using <code>compress-force=<i>zstd</i></code> over just <code>compress=<i>zstd</i></code>, which also had 10% disk compression. However, keep in mind that forcing compression is against <a rel="nofollow" class="external text" href="https://btrfs.readthedocs.io/en/latest/Compression.html#incompressible-data">official Btrfs guidelines</a>.
</p>
<p>Only files created or modified after the mount option is added will be compressed.
</p>
<p>To apply compression to existing files, use the <code>btrfs filesystem defragment -c<i>alg</i></code> command, where <code><i>alg</i></code> is either <code>zlib</code>, <code>lzo</code> or <code>zstd</code>. For example, in order to re-compress the whole file system with <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=zstd">zstd</a></span>, run the following command:
</p>
<pre># btrfs filesystem defragment -r -v -czstd /
</pre>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong>  Defragmenting a file which has a COW copy (either a snapshot copy or one made with <code>cp</code> or bcp) plus using the <code>-c</code> switch with a compression algorithm may result in two unrelated files effectively increasing the disk usage.</div>
<p>To enable compression when installing Arch to an empty Btrfs partition, use the <code>compress</code> option when <a href="../en/File_systems.html#Mount_a_file_system" class="mw-redirect" title="Mounting">mounting</a> the file system: <code>mount -o compress=zstd /dev/sd<i>xY</i> /mnt/</code>. During configuration, add <code>compress=zstd</code> to the mount options of the root file system in <a href="../en/Fstab.html" title="Fstab">fstab</a>.
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> Compression can also be enabled per-file without using the <code>compress</code> mount option; to do so, apply <code>chattr +c</code> <b>or</b> <code>btrfs property set <i>file</i> compression <i>alg</i></code> to the file. The first command is using legacy interface of file attributes inherited from ext2 filesystem and is not flexible, so by default the <code>zlib</code> compression is set. The other command sets a property on the file with the given algorithm. (Note: setting level that way is not yet implemented.) When applied to directories, it will cause new files to be automatically compressed as they come.</div>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> 
<ul>
<li>Systems using older kernels or <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=btrfs-progs">btrfs-progs</a></span> without <code>zstd</code> support may be unable to read or repair your file system if you use this option.</li>
<li>
<a href="../en/GRUB.html" title="GRUB">GRUB</a> introduced <i>zstd</i> support in 2.04.  Make sure you have actually upgraded the bootloader installed in your MBR/ESP since then, by running <code>grub-install</code> with the appropriate options for your BIOS/UEFI setup, since that is not done automatically. See <a rel="nofollow" class="external text" href="https://bugs.archlinux.org/task/63235">FS#63235</a>.</li>
</ul>
</div>
<h4><span class="mw-headline" id="View_compression_types_and_ratios">View compression types and ratios</span></h4>
<p><span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=compsize">compsize</a></span> takes a list of files (or an entire Btrfs file system) and measures compression types used and effective compression ratios.  Uncompressed size may not match the number given by other programs such as <span class="plainlinks archwiki-template-man" title="$ man 1 du"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/du.1">du(1)</a></span>, because every extent is counted once, even if it is reflinked several times, and even if a part of it is no longer used anywhere but has not been garbage collected.  The <code>-x</code> option keeps it on a single file system, which is useful in situations like <code>compsize -x /</code> to avoid it from attempting to look in non-Btrfs subdirectories and fail the entire run.
</p>
<h3><span class="mw-headline" id="Subvolumes">Subvolumes</span></h3>
<p>"A Btrfs subvolume is not a block device (and cannot be treated as one) instead, a Btrfs subvolume can be thought of as a POSIX file namespace. This namespace can be accessed via the top-level subvolume of the file system, or it can be mounted in its own right." <a rel="nofollow" class="external autonumber" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/SysadminGuide.html#Subvolumes">[5]</a>
</p>
<p>Each Btrfs file system has a top-level subvolume with ID 5. This subvolume cannot be removed or replaced by another subvolume. The top-level subvolume has path <code>/</code> on the file system and other subvolumes are <i>nested</i> below the top-level subvolume. However, subvolumes can be moved around in the file system and their path may change, whereas their ID cannot.
</p>
<p>By default, the top-level subvolume is mounted when mounting the file system. Options allow to <a href="#Mounting_subvolumes">mount a specific subvolume</a> instead.
</p>
<p>A major use case for subvolumes are <a href="#Snapshots">snapshots</a>.
</p>
<p>See the following links for more details:
</p>
<ul>
<li><a rel="nofollow" class="external text" href="https://btrfs.readthedocs.io/en/latest/Subvolumes.html">Btrfs Documentation</a></li>
<li><a rel="nofollow" class="external text" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/SysadminGuide.html#Subvolumes">Btrfs Wiki SysadminGuide#Subvolumes</a></li>
<li><a rel="nofollow" class="external text" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/Trees.html">Btrfs Wiki Trees</a></li>
</ul>
<h4><span class="mw-headline" id="Creating_a_subvolume">Creating a subvolume</span></h4>
<p>To create a subvolume, the Btrfs file system must be mounted. The subvolume's name is set using the last argument.
</p>
<pre># btrfs subvolume create <i>/path/to/subvolume</i>
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> You can use <code>--parents</code> to automatically create parent directories if they do not exist.</div>
<h4><span class="mw-headline" id="Listing_subvolumes">Listing subvolumes</span></h4>
<p>To see a list of current subvolumes and their ids under <code><i>path</i></code>:
</p>
<pre># btrfs subvolume list -p <i>path</i>
</pre>
<h4><span class="mw-headline" id="Deleting_a_subvolume">Deleting a subvolume</span></h4>
<p>To delete a subvolume:
</p>
<pre># btrfs subvolume delete <i>/path/to/subvolume</i>
</pre>
<p>Alternatively, a subvolume can be deleted like a regular directory (<code>rm -r</code>, <code>rmdir</code>).
</p>
<h4><span class="mw-headline" id="Mounting_subvolumes">Mounting subvolumes</span></h4>
<p>Subvolumes can be mounted like file system partitions using the <code>subvol=<i>/path/to/subvolume</i></code> or <code>subvolid=<i>objectid</i></code> mount flags. For example, you could have a subvolume named <code>subvol_root</code> and mount it as <code>/</code>.  One can mimic traditional file system partitions by creating various subvolumes under the top level of the file system and then mounting them at the appropriate mount points. It is preferable to mount using <code>subvol=<i>/path/to/subvolume</i></code>, rather than the subvolid, as the subvolid may change when restoring <a href="#Snapshots">#Snapshots</a>, requiring a change of mount configuration.
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> Changing subvolume layouts is made simpler by not using the top-level subvolume (ID=5) as <code>/</code> (which is done by default). Instead, consider creating a subvolume to house your actual data and mounting it as <code>/</code>.</div>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> From <span class="plainlinks archwiki-template-man" title="$ man 5 btrfs"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/btrfs.5#MOUNT_OPTIONS">btrfs(5) § MOUNT OPTIONS</a></span>: "Most mount options apply to the <b>whole file system</b>, and only the options for the first subvolume to be mounted will take effect. This is due to lack of implementation and may change in the future."
<p>See the <a rel="nofollow" class="external text" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/FAQ.html#Can_I_mount_subvolumes_with_different_mount_options.3F">Btrfs Wiki FAQ</a> for which mount options can be used per subvolume.
</p>
</div>
<p>See <a href="../en/Snapper.html#Suggested_filesystem_layout" title="Snapper">Snapper#Suggested filesystem layout</a>, <a rel="nofollow" class="external text" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/SysadminGuide.html#Managing_Snapshots">Btrfs SysadminGuide#Managing Snapshots</a>, and <a rel="nofollow" class="external text" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/SysadminGuide.html#Layout">SysadminGuide#Layout</a> for example file system layouts using subvolumes.
</p>
<p>See <span class="plainlinks archwiki-template-man" title="$ man 5 btrfs"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/btrfs.5">btrfs(5)</a></span> for a full list of Btrfs-specific mount options.
</p>
<h4><span class="mw-headline" id="Mounting_subvolume_as_root">Mounting subvolume as root</span></h4>
<p>To use a subvolume as the root mountpoint, either make it the <a href="#Changing_the_default_sub-volume">default subvolume</a>, or specify the subvolume via a <a href="../en/Kernel_parameters.html#Configuration" title="Kernel parameters">kernel parameter</a> using <code>rootflags=subvol=<i>/path/to/subvolume</i></code>. Edit the root mountpoint in <code>/etc/fstab</code> and specify the mount option <code>subvol=</code>. Alternatively, the subvolume can be specified with its id, <code>rootflags=subvolid=<i>objectid</i></code> as kernel parameter and <code>subvolid=<i>objectid</i></code> as mount option in <code>/etc/fstab</code>. It is preferable to mount using <code>subvol=<i>/path/to/subvolume</i></code>, rather than the subvolid, as the subvolid may change when restoring <a href="#Snapshots">#Snapshots</a>, requiring a change of mount configuration, or else the system will not boot.
</p>
<h4><span class="mw-headline" id="Changing_the_default_sub-volume">Changing the default sub-volume</span></h4>
<p>The default sub-volume is mounted if no <code>subvol=</code> mount option is provided. To change the default subvolume, do:
</p>
<pre># btrfs subvolume set-default <i>subvolume-id</i> /
</pre>
<p>where <i>subvolume-id</i> can be found by <a href="#Listing_subvolumes">listing</a>.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> After changing the default subvolume on a system with <a href="../en/GRUB.html" title="GRUB">GRUB</a>, you should run <code>grub-install</code> again to notify the bootloader of the changes. See <a rel="nofollow" class="external text" href="https://bbs.archlinux.org/viewtopic.php?pid=1615373">this forum thread</a>.</div>
<p>Changing the default subvolume with <code>btrfs subvolume set-default</code> will make the top level of the file system inaccessible, except by use of the <code>subvol=/</code> or <code>subvolid=5</code> mount options <a rel="nofollow" class="external autonumber" href="https://btrfs.readthedocs.io/en/latest/Administration.html">[6]</a>.
</p>
<h3><span class="mw-headline" id="Quota">Quota</span></h3>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> Qgroup is not stable yet and combining quota with (too many) snapshots of subvolumes can cause performance problems, for example when deleting snapshots. Plus there are several more <a rel="nofollow" class="external text" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/Quota_support.html#Known_issues">known issues</a>.</div>
<p>Quota support in Btrfs is implemented at a subvolume level by the use of quota groups or qgroup: Each subvolume is assigned a quota groups in the form of <i>0/subvolume_id</i> by default. However, it is possible to create a quota group using any number if desired.
</p>
<p>To use qgroups, you need to enable quota first using
</p>
<pre># btrfs quota enable <i>path</i>
</pre>
<p>From this point onwards, newly created subvolumes will be controlled by those groups.
In order to retrospectively enable them for already existing subvolumes, enable quota normally, then create a qgroup (quota group) for each of those subvolume using their <i>subvolume_id</i> and rescan them:
</p>
<pre># btrfs subvolume list <i>path</i> | cut -d' ' -f2 | xargs -I{} -n1 btrfs qgroup create 0/{} <i>path</i>
# btrfs quota rescan <i>path</i>
</pre>
<p>Quota groups in Btrfs form a tree hierarchy, whereby qgroups are attached to subvolumes. The size limits are set per qgroup and apply when any limit is reached in tree that contains a given subvolume.
</p>
<p>Limits on quota groups can be applied either to the total data usage, un-shared data usage, compressed data usage or both. File copy and file deletion may both affect limits since the unshared limit of another qgroup can change if the original volume's files are deleted and only one copy is remaining. For example, a fresh snapshot shares almost all the blocks with the original subvolume, new writes to either subvolume will raise towards the exclusive limit, deletions of common data in one volume raises towards the exclusive limit in the other one.
</p>
<p>To apply a limit to a qgroup, use the command <code>btrfs qgroup limit</code>. Depending on your usage, either use a total limit, unshared limit (<code>-e</code>) or compressed limit (<code>-c</code>).
To show usage and limits for a given path within a file system, use
</p>
<pre># btrfs qgroup show -reF <i>path</i>
</pre>
<h3><span class="mw-headline" id="Commit_interval">Commit interval</span></h3>
<p>The resolution at which data are written to the file system is dictated by Btrfs itself and by system-wide settings. Btrfs defaults to a 30 seconds checkpoint interval in which new data are committed to the file system. This can be changed by appending the <code>commit</code> mount option in <code>/etc/fstab</code> for the Btrfs partition.
</p>
<pre>LABEL=arch64 / btrfs defaults,compress=zstd,commit=120 0 0
</pre>
<p>System-wide settings also affect commit intervals. They include the files under <code>/proc/sys/vm/*</code> and are out-of-scope of this wiki article. The kernel documentation for them is available at <a rel="nofollow" class="external free" href="https://docs.kernel.org/admin-guide/sysctl/vm.html">https://docs.kernel.org/admin-guide/sysctl/vm.html</a>.
</p>
<h3><span class="mw-headline" id="SSD_TRIM">SSD TRIM</span></h3>
<p>A Btrfs file system is able to free unused blocks from an SSD drive supporting the TRIM command. Asynchronous discard support is available with mount option <code>discard=async</code>, and is enabled by default as of <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=linux">linux</a></span> 6.2. Freed extents are not discarded immediately, but grouped together and trimmed later by a separate worker thread, improving commit latency.
</p>
<p>Asynchronous discard can safely be used alongside periodic trim <a rel="nofollow" class="external autonumber" href="https://lists.fedoraproject.org/archives/list/devel@lists.fedoraproject.org/thread/MLZIPQUXMJFRVSFJS6B2ACDKTYNSX3AX/">[7]</a>.
</p>
<p>More information about enabling and using TRIM can be found in <a href="../en/Solid_state_drive.html#TRIM" class="mw-redirect" title="Solid State Drives">Solid State Drives#TRIM</a>.
</p>
<h2><span class="mw-headline" id="Usage">Usage</span></h2>
<h3><span class="mw-headline" id="Swap_file">Swap file</span></h3>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> Swap files on file systems spanning multiple devices are not supported. See <span class="plainlinks archwiki-template-man" title="$ man 5 btrfs"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/btrfs.5#SWAPFILE_SUPPORT">btrfs(5) § SWAPFILE SUPPORT</a></span> for all limitations.</div>
<p>To properly initialize a swap file, first create a <i>non-snapshotted</i> subvolume to host the file, e.g.
</p>
<pre># btrfs subvolume create /swap
</pre>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> Consider creating the subvolume directly below the top-level subvolume, e.g. <code>@swap</code>. Then, make sure the subvolume is <a href="#Mounting_subvolumes">mounted</a> to <code>/swap</code> (or any other accessible location).</div>
<p>Create the swap file:
</p>
<pre># btrfs filesystem mkswapfile --size 4g --uuid clear /swap/swapfile
</pre>
<p>If <code>--size</code> is omitted, the default of 2GiB is used.
</p>
<p>Activate the swap file:
</p>
<pre># swapon /swap/swapfile
</pre>
<p>Finally, edit the <a href="../en/Fstab.html" title="Fstab">fstab</a> configuration to add an entry for the swap file:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/fstab</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">/swap/swapfile none swap defaults 0 0
</pre>
<p>For additional information, see <a href="../en/Fstab.html#Usage" title="Fstab">fstab#Usage</a>.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> You can also create the swap file manually, by <a href="#Disabling_CoW">setting the</a> <code>No_COW</code> attribute on the whole subvolume with <code>chattr</code>, then following the steps in <a href="../en/Swap.html#Swap_file_creation" title="Swap">Swap#Swap file creation</a>. See <span class="plainlinks archwiki-template-man" title="$ man 5 btrfs"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/btrfs.5#SWAPFILE_SUPPORT">btrfs(5) § SWAPFILE SUPPORT</a></span> for an alternative method.</div>
<p>To use a swap file for hibernation, you might need to additionally follow the procedures described in <a href="../en/Power_management/Suspend_and_hibernate.html#Hibernation" class="mw-redirect" title="Hibernation">Hibernation</a>.
</p>
<h3>
<span id="Displaying_used.2Ffree_space"></span><span class="mw-headline" id="Displaying_used/free_space">Displaying used/free space</span>
</h3>
<p>General linux userspace tools such as <span class="plainlinks archwiki-template-man" title="$ man 1 df"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/df.1">df(1)</a></span> will inaccurately report free space on a Btrfs partition. It is recommended to use <code>btrfs filesystem usage</code> to query Btrfs partitions. For example, for a full breakdown of device allocation and usage stats:
</p>
<pre># btrfs filesystem usage /
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> The <code>btrfs filesystem usage</code> command does not currently work correctly with <code>RAID5/RAID6</code> RAID levels.</div>
<p>Alternatively, <code>btrfs filesystem df</code> allows a quick check on usage of allocated space without the requirement to run as root:
</p>
<pre>$ btrfs filesystem df /
</pre>
<p>See <a rel="nofollow" class="external autonumber" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/FAQ.html#How_much_free_space_do_I_have.3F">[8]</a> for more information.
</p>
<p>The same limitations apply to tools which analyze space usage for some subset of the file system, such as <span class="plainlinks archwiki-template-man" title="$ man 1 du"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/du.1">du(1)</a></span> or <span class="plainlinks archwiki-template-man" title="$ man 1 ncdu"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/ncdu.1">ncdu(1)</a></span>, as they do not take into account reflinks, snapshots and compression. Instead, see <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/btdu/">btdu</a></span><sup><small>AUR</small></sup> and <a href="#View_compression_types_and_ratios">compsize</a> for Btrfs-aware alternatives.
</p>
<h3><span class="mw-headline" id="Defragmentation">Defragmentation</span></h3>
<p>Btrfs supports online defragmentation through the mount option <code>autodefrag</code>; see <span class="plainlinks archwiki-template-man" title="$ man 5 btrfs"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/btrfs.5#MOUNT_OPTIONS">btrfs(5) § MOUNT OPTIONS</a></span>. To manually defragment your root, use:
</p>
<pre># btrfs filesystem defragment -r /
</pre>
<p>Using the above command without the <code>-r</code> switch will result in only the metadata held by the subvolume containing the directory being defragmented. This allows for single file defragmentation by simply specifying the path.
</p>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> Defragmenting a file which has a COW copy (either a snapshot copy or one made with <code>cp</code> or bcp) plus using the <code>-c</code> switch with a compression algorithm may result in two unrelated files effectively increasing the disk usage.</div>
<h3><span class="mw-headline" id="RAID">RAID</span></h3>
<p>Btrfs offers native "RAID" for <a href="#Multi-device_file_system">#Multi-device file systems</a>. Notable features which set Btrfs RAID apart from <a href="../en/RAID.html" class="mw-redirect" title="Mdadm">mdadm</a> are self-healing redundant arrays and online balancing. See <a rel="nofollow" class="external text" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/Using_Btrfs_with_Multiple_Devices.html">the Btrfs wiki page</a> for more information. The Btrfs sysadmin page also <a rel="nofollow" class="external text" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/SysadminGuide.html#RAID_and_data_replication">has a section</a> with some more technical background.
</p>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> Parity RAID (RAID 5/6) code has multiple serious data-loss bugs in it. See the Btrfs Wiki's <a rel="nofollow" class="external text" href="https://btrfs.readthedocs.io/en/latest/btrfs-man5.html#raid56-status-and-recommended-practices">RAID5/6 page</a> and a bug report on <a rel="nofollow" class="external text" href="https://lore.kernel.org/linux-btrfs/8695beeb-f991-28c4-cf6b-8c92339e468f@inwind.it/">linux-btrfs mailing list</a> for more detailed information. In June 2020, somebody posted a <a rel="nofollow" class="external text" href="https://lore.kernel.org/linux-btrfs/20200627030614.GW10769@hungrycats.org/">comprehensive list of current issues</a> and a <a rel="nofollow" class="external text" href="https://lore.kernel.org/linux-btrfs/20200627032414.GX10769@hungrycats.org/">helpful recovery guide</a>. </div>
<h4><span class="mw-headline" id="Scrub">Scrub</span></h4>
<div class="noprint archwiki-template-message">
<p><span class="mw-default-size" typeof="mw:File"><span><img src="../File:Tango-view-fullscreen.svg" decoding="async" width="48" height="48" class="mw-file-element"></span></span><b>This article or section needs expansion.</b></p>
<div>
<b>Reason:</b> <a rel="nofollow" class="external text" href="https://unix.stackexchange.com/questions/556816/does-btrfs-scrub-examine-subvolume-or-the-device-that-subvolume-resides-on">Does Btrfs scrub examine subvolume or the device that subvolume resides on?</a> (Discuss in <a rel="nofollow" class="external text" href="../en/Talk:Btrfs.html">Talk:Btrfs</a>)</div>
</div>
<p>The <a rel="nofollow" class="external text" href="https://btrfs.readthedocs.io/en/latest/Glossary.html">Btrfs Wiki Glossary</a> says that Btrfs scrub is "[a]n online file system checking tool. Reads all the data and metadata on the file system and uses checksums and the duplicate copies from RAID storage to identify and repair any corrupt data."
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> A running scrub process will prevent the system from suspending, see <a rel="nofollow" class="external text" href="https://lore.kernel.org/linux-btrfs/20140227190656.GA28338@merlins.org/">this thread</a> for details.</div>
<h5><span class="mw-headline" id="Start_manually">Start manually</span></h5>
<p>To start a (background) scrub on the file system which contains <code>/</code>:
</p>
<pre># btrfs scrub start /
</pre>
<p>To check the status of a running scrub:
</p>
<pre># btrfs scrub status /
</pre>
<h5><span class="mw-headline" id="Start_with_a_service_or_timer">Start with a service or timer</span></h5>
<p>The <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=btrfs-progs">btrfs-progs</a></span> package brings the <code>btrfs-scrub@.timer</code> unit for monthly scrubbing the specified mountpoint. <a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Enable">Enable</a> the timer with an escaped path, e.g. <code>btrfs-scrub@-.timer</code> for <code>/</code> and <code>btrfs-scrub@home.timer</code> for <code>/home</code>. You can use <code>systemd-escape -p <i>/path/to/mountpoint</i></code> to escape the path; see <span class="plainlinks archwiki-template-man" title="$ man 1 systemd-escape"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/systemd-escape.1">systemd-escape(1)</a></span> for details.
</p>
<p>You can also run the scrub by <a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Starting">starting</a> <code>btrfs-scrub@.service</code> (with the same encoded path). The advantage of this over <code>btrfs scrub</code> (as the root user) is that the results of the scrub will be logged in the <a href="../en/Systemd/Journal.html" class="mw-redirect" title="Systemd journal">systemd journal</a>.
</p>
<p>On large NVMe drives with insufficient cooling (e.g. in a laptop), scrubbing can read the drive fast enough and long enough to get it very hot. If you are running scrubs with systemd, you can easily limit the rate of scrubbing with the <code>IOReadBandwidthMax</code> option described in <span class="plainlinks archwiki-template-man" title="$ man 5 systemd.resource-control"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/systemd.resource-control.5">systemd.resource-control(5)</a></span> by using a <a href="../en/Systemd.html#Drop-in_files" class="mw-redirect" title="Drop-in file">drop-in file</a>.
</p>
<h4><span class="mw-headline" id="Balance">Balance</span></h4>
<p>"A balance passes all data in the file system through the allocator again. It is primarily intended to rebalance the data in the file system across the devices when a device is added or removed. A balance will regenerate missing copies for the redundant RAID levels, if a device has failed." <a rel="nofollow" class="external autonumber" href="https://btrfs.readthedocs.io/en/latest/Glossary.html">[9]</a> See <a rel="nofollow" class="external text" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/FAQ.html#What_does_.22balance.22_do.3F">Upstream FAQ page</a>.
</p>
<p>On a single-device filesystem, a balance may be also useful for (temporarily) reducing the amount of allocated but unused (meta)data chunks. Sometimes this is needed for fixing <a rel="nofollow" class="external text" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/FAQ.html#Help.21_Btrfs_claims_I.27m_out_of_space.2C_but_it_looks_like_I_should_have_lots_left.21">"file system full" issues</a>.
</p>
<pre># btrfs balance start --bg /
# btrfs balance status /
</pre>
<h3><span class="mw-headline" id="Snapshots">Snapshots</span></h3>
<p>"A snapshot is simply a subvolume that shares its data (and metadata) with some other subvolume, using Btrfs's COW capabilities." See <a rel="nofollow" class="external text" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/SysadminGuide.html#Snapshots">Btrfs Wiki SysadminGuide#Snapshots</a> for details.
</p>
<p>To create a snapshot:
</p>
<pre># btrfs subvolume snapshot <i>source</i> [<i>dest</i>/]<i>name</i>
</pre>
<p>To create a readonly snapshot, add the <code>-r</code> flag. To create a writable version of a readonly snapshot, simply create a snapshot of it.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> 
<ul>
<li>It is possible for a snapshot to be converted in-place from readonly to writeable with <code>btrfs property set -f -ts '/path/to/snapshot' ro false</code>. However, this is not recommended because it <a rel="nofollow" class="external text" href="https://lore.kernel.org/linux-btrfs/06e92a0b-e71b-eb21-edb5-9d2a5513b718@gmail.com/">causes issues</a> with any future incremental send/receive. Making a new writeable snapshot prevents such issues.</li>
<li>Snapshots are not recursive. Every nested subvolume will be an empty directory inside the snapshot.</li>
</ul>
</div>
<h3>
<span id="Send.2Freceive"></span><span class="mw-headline" id="Send/receive">Send/receive</span>
</h3>
<p>A subvolume can be sent to stdout or a file using the <code>send</code> command. This is usually most useful when piped to a Btrfs <code>receive</code> command. For example, to send a snapshot named <code>/root_backup</code> (perhaps of a snapshot you made of <code>/</code> earlier) to <code>/backup</code>, you would do the following:
</p>
<pre># btrfs send /root_backup | btrfs receive /backup
</pre>
<p>The snapshot that is sent <i>must</i> be readonly. The above command is useful for copying a subvolume to an external device (e.g. a USB disk mounted at <code>/backup</code> above).
</p>
<p>The subvolume will be created on the receiving end. It does not need to be created manually.
</p>
<p>Another example which creates: <code>/mnt/arch-v2/subvolumes/@var</code>:
</p>
<pre># btrfs send --proto 2 --compressed-data '/mnt/arch/snapshots/@var' | btrfs receive '/mnt/arch-v2/subvolumes/'
</pre>
<p>The parameters <code>--proto 2</code> and <code>--compressed-data</code> used in the example might be useful for more efficient sending (assumes compressed data).
</p>
<p>You can also send only the difference between two snapshots. For example, if you have already sent a copy of <code>root_backup</code> above and have made a new readonly snapshot on your system named <code>root_backup_new</code>, then to send only the incremental difference to <code>/backup</code>, do:
</p>
<pre># btrfs send -p /root_backup /root_backup_new | btrfs receive /backup
</pre>
<p>Now, a new subvolume named <code>root_backup_new</code> will be present in <code>/backup</code>.
</p>
<p>See <a rel="nofollow" class="external text" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/Incremental_Backup.html">Btrfs Wiki's Incremental Backup page</a> and <a href="#Incremental_backup_to_external_drive">#Incremental backup to external drive</a> on how to use this for incremental backups and for tools that automate the process.
</p>
<h3><span class="mw-headline" id="Deduplication">Deduplication</span></h3>
<p>Using copy-on-write, Btrfs is able to copy files or whole subvolumes without actually copying the data. However, whenever a file is altered, a new <i>proper</i> copy is created. Deduplication takes this a step further by actively identifying blocks of data which share common sequences and combining them into an extent with the same copy-on-write semantics.
</p>
<p>Tools dedicated to deduplicate a Btrfs formatted partition include <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=duperemove">duperemove</a></span> and <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=bees">bees</a></span>. One may also want to merely deduplicate data on a file based level instead using e.g. <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=rmlint">rmlint</a></span>, <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/jdupes/">jdupes</a></span><sup><small>AUR</small></sup> or <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/dduper-git/">dduper-git</a></span><sup><small>AUR</small></sup>. For an overview of available features of those programs and additional information, have a look at the <a rel="nofollow" class="external text" href="https://btrfs.readthedocs.io/en/latest/Deduplication.html">upstream Wiki entry</a>.
</p>
<h3><span class="mw-headline" id="Resizing">Resizing</span></h3>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> To avoid data loss, ensure that you back up your data before you begin any resizing task.</div>
<p>You can grow a file system to the maximum space available on the device, or specify an exact size. Ensure that you grow the size of the device or logical volume before you attempt to increase the size of the file system.
When specifying an exact size for the file system on a device, either increasing or decreasing, ensure that the new size satisfies the following conditions:
</p>
<ul>
<li>The new size must be greater than the size of the existing data; otherwise, data loss occurs.</li>
<li>The new size must be equal to or less than the current device size because the file system size cannot extend beyond the space available.</li>
</ul>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> If you plan to also decrease the size of the logical volume that holds the file system, ensure that you decrease the size of the file system before you attempt to decrease the size of the device or logical volume.</div>
<p>To extend the file system size to the maximum available size of the device:
</p>
<pre># btrfs filesystem resize max /
</pre>
<p>To extend the file system to a specific size:
</p>
<pre># btrfs filesystem resize <i>size</i> /
</pre>
<p>Replace <code><i>size</i></code> with the desired size in bytes. You can also specify units on the value, such as K (kibibytes), M (mebibytes), or G (gibibytes). Alternatively, you can specify an increase or decrease to the current size by prefixing the value with a plus (+) or a minus (-) sign, respectively:
</p>
<pre># btrfs filesystem resize +<i>size</i> /
# btrfs filesystem resize -<i>size</i> /
</pre>
<h2><span class="mw-headline" id="Known_issues">Known issues</span></h2>
<p>A few limitations should be known before trying.
</p>
<h3><span class="mw-headline" id="Encryption">Encryption</span></h3>
<p>Btrfs has no built-in encryption support, but this <a rel="nofollow" class="external text" href="https://lwn.net/Articles/700487/">may</a> come in the future. Users can encrypt the partition before running <code>mkfs.btrfs</code>, see <a href="../en/Dm-crypt/Encrypting_an_entire_system.html" title="Dm-crypt/Encrypting an entire system">dm-crypt/Encrypting an entire system</a>. Another approach is <a href="../en/Data-at-rest_encryption.html#Stacked_filesystem_encryption" title="Data-at-rest encryption">stacked filesystem encryption</a>.
</p>
<h3><span class="mw-headline" id="btrfs_check_issues">btrfs check issues</span></h3>
<p>The tool <code>btrfs check</code> has known issues and should not be run without further reading; see section <a href="#btrfs_check">#btrfs check</a>.
</p>
<h2><span class="mw-headline" id="Tips_and_tricks">Tips and tricks</span></h2>
<h3><span class="mw-headline" id="Partitionless_Btrfs_disk">Partitionless Btrfs disk</span></h3>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> This type of setup is not ideal for a boot device and it is recommended to instead set up a Btrfs partition along with a separate <a href="../en/EFI_system_partition.html" title="EFI system partition">EFI system partition</a>. Furthermore, GRUB strongly discourages installation to a partitionless disk.</div>
<p>Btrfs can occupy an entire data storage device, replacing the <a href="../en/Partitioning.html#Master_Boot_Record" class="mw-redirect" title="MBR">MBR</a> or <a href="../en/Partitioning.html#GUID_Partition_Table" class="mw-redirect" title="GPT">GPT</a> partitioning schemes, using <a href="#Subvolumes">subvolumes</a> to simulate partitions. However, using a partitionless setup is not required to simply <a href="#File_system_creation">create a Btrfs file system</a> on an existing <a href="../en/Partitioning.html" class="mw-redirect" title="Partition">partition</a> that was created using another method. There are some limitations to partitionless single disk setups:
</p>
<ul>
<li>Cannot place other <a href="../en/File_systems.html" title="File systems">file systems</a> on another partition on the same disk.</li>
<li>Due to the previous point, having an <a href="../en/EFI_system_partition.html" class="mw-redirect" title="ESP">ESP</a> on this disk is not possible. Another device is necessary for <a href="../en/Unified_Extensible_Firmware_Interface.html" class="mw-redirect" title="UEFI">UEFI</a> boot.</li>
</ul>
<p>To overwrite the existing partition table with Btrfs, run the following command:
</p>
<pre># mkfs.btrfs /dev/sd<i>X</i>
</pre>
<p>For example, use <code>/dev/sda</code> rather than <code>/dev/sda1</code>. The latter would format an existing partition instead of replacing the entire partitioning scheme. Because the root partition is Btrfs, make sure <code>btrfs</code> is compiled into the kernel, or put <code>btrfs</code> into <a href="../en/Mkinitcpio.html#MODULES" class="mw-redirect" title="Mkinitcpio.conf">mkinitcpio.conf#MODULES</a> and <a href="../en/Mkinitcpio.html#Image_creation_and_activation" class="mw-redirect" title="Regenerate the initramfs">regenerate the initramfs</a>.
</p>
<p>Install the <a href="../en/Arch_boot_process.html#Boot_loader" class="mw-redirect" title="Boot loader">boot loader</a> like you would for a data storage device with a <a href="../en/Partitioning.html#Master_Boot_Record" class="mw-redirect" title="Master Boot Record">Master Boot Record</a>. See <a href="../en/Syslinux.html#Manually" title="Syslinux">Syslinux#Manually</a> or <a href="../en/GRUB/Tips_and_tricks.html#Install_to_partition_or_partitionless_disk" title="GRUB/Tips and tricks">GRUB/Tips and tricks#Install to partition or partitionless disk</a>. If your kernel does not boot due to <code>Failed to mount /sysroot.</code>, please add <code>GRUB_PRELOAD_MODULES="btrfs"</code> in <code>/etc/default/grub</code> and <a href="../en/GRUB.html#Generate_the_main_configuration_file" title="GRUB">generate</a> the grub configuration.
</p>
<h3>
<span id="Ext3.2F4_to_Btrfs_conversion"></span><span class="mw-headline" id="Ext3/4_to_Btrfs_conversion">Ext3/4 to Btrfs conversion</span>
</h3>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> There are many reports on the btrfs mailing list about incomplete/corrupt/broken conversions. Make sure you have <i>working</i> backups of any data you cannot afford to lose. See the <a rel="nofollow" class="external text" href="https://btrfs.readthedocs.io/en/latest/Convert.html">Convert</a> page on the Btrfs wiki for more information.
</div>
<p>Boot from an install CD, then convert by doing:
</p>
<pre># btrfs-convert /dev/<i>partition</i>
</pre>
<p>Mount the partition and test the conversion by checking the files.  Be sure to change the <code>/etc/fstab</code> to reflect the change (<b>type</b> to <code>btrfs</code> and <b>fs_passno</b> [the last field] to <code>0</code> as Btrfs does not do a file system check on boot). Also note that the UUID of the partition will have changed, so update fstab accordingly when using UUIDs. <code>chroot</code> into the system and rebuild your boot loader's menu list (see <a href="../en/Install_Arch_Linux_from_existing_Linux.html" class="mw-redirect" title="Install from existing Linux">Install from existing Linux</a>). If converting a root file system, while still chrooted, run <code>mkinitcpio -p linux</code> to regenerate the initramfs or the system will not successfully boot.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> If there is anything wrong, either unable to mount or write files to the newly converted Btrfs; there is always the option to rollback as long as the backup subvolume <code>/ext2_saved</code> is still there. Use the <code>btrfs-convert -r /dev/<i>partition</i></code> command to rollback; this will discard any modifications to the newly converted Btrfs file system.</div>
<p>After confirming that there are no problems, complete the conversion by deleting the backup <code>ext2_saved</code> sub-volume. Note that you cannot revert back to ext3/4 without it.
</p>
<pre># btrfs subvolume delete /ext2_saved
</pre>
<p>Finally, <a href="#Balance">balance</a> the file system to reclaim the space.
</p>
<p>Remember that some applications which were installed prior have to be adapted to Btrfs.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> Ext3/4 to Btrfs conversion is a time consuming operation. For a 4 TiB file system and a regular HDD, it can take up to 10 hours.</div>
<h3><span class="mw-headline" id="Corruption_recovery">Corruption recovery</span></h3>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> The tool <code>btrfs check</code> has known issues, see section <a href="#btrfs_check">#btrfs check</a>
</div>
<p><i>btrfs-check</i> cannot be used on a mounted file system. To be able to use <i>btrfs-check</i> without booting from a live USB, add it to the initial ramdisk:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/mkinitcpio.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">BINARIES=(btrfs)</pre>
<p><a href="../en/Mkinitcpio.html#Image_creation_and_activation" class="mw-redirect" title="Regenerate the initramfs">Regenerate the initramfs</a>.
</p>
<p>Then if there is a problem booting, the utility is available for repair.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> If the fsck process has to invalidate the space cache (and/or other caches?), it is normal for a subsequent boot to hang up for a while (it may give console messages about btrfs-transaction being hung). The system should recover from this after a while.</div>
<p>See <span class="plainlinks archwiki-template-man" title="$ man 8 btrfs-check"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/btrfs-check.8">btrfs-check(8)</a></span> for more information.
</p>
<h3><span class="mw-headline" id="Booting_into_snapshots">Booting into snapshots</span></h3>
<p>In order to boot into a snapshot, the same procedure applies as for mounting a subvolume as your root partition, as given in section <a href="#Mounting_subvolume_as_root">mounting a subvolume as your root partition</a>, because snapshots can be mounted like subvolumes.
</p>
<ul>
<li>If using <a href="../en/GRUB.html" title="GRUB">GRUB</a>, you can automatically populate your boot menu with Btrfs snapshots when regenerating the configuration file with the help of <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=grub-btrfs">grub-btrfs</a></span> or <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/grub-btrfs-git/">grub-btrfs-git</a></span><sup><small>AUR</small></sup>.</li>
<li>If using <a href="../en/REFInd.html" title="REFInd">rEFInd</a>, you can automatically populate your boot menu with Btrfs snapshots with the help of <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/refind-btrfs/">refind-btrfs</a></span><sup><small>AUR</small></sup>, after <a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Enabling">enabling</a> <code>refind-btrfs.service</code>.</li>
</ul>
<h3><span class="mw-headline" id="Use_Btrfs_subvolumes_with_systemd-nspawn">Use Btrfs subvolumes with systemd-nspawn</span></h3>
<p>See the <a href="../en/Systemd-nspawn.html#Use_Btrfs_subvolume_as_container_root" title="Systemd-nspawn">Systemd-nspawn#Use Btrfs subvolume as container root</a> and <a href="../en/Systemd-nspawn.html#Use_temporary_Btrfs_snapshot_of_container" title="Systemd-nspawn">Systemd-nspawn#Use temporary Btrfs snapshot of container</a> articles.
</p>
<h3><span class="mw-headline" id="Reducing_access_time_metadata_updates">Reducing access time metadata updates</span></h3>
<p>Because of the copy-on-write nature of Btrfs, simply accessing files can trigger the metadata copy and writing. Reducing the frequency of access time updates may eliminate this unexpected disk usage and increase performance. See <a href="../en/Fstab.html#atime_options" title="Fstab">fstab#atime options</a> for the available options.
</p>
<h3><span class="mw-headline" id="Incremental_backup_to_external_drive">Incremental backup to external drive</span></h3>
<p>The following packages use <code>btrfs send</code> and <code>btrfs receive</code> to send backups incrementally to an external drive. Refer to their documentation to see differences in implementation, features, and requirements.
</p>
<ul><li>
<b>btrbk</b> — Tool for creating snapshots and remote backups of Btrfs subvolumes.</li></ul>
<dl><dd>
<a rel="nofollow" class="external free" href="https://github.com/digint/btrbk">https://github.com/digint/btrbk</a> || <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=btrbk">btrbk</a></span>
</dd></dl>
<ul><li>
<b>snap-sync</b> — Use <a href="../en/Snapper.html" title="Snapper">Snapper</a> snapshots to backup to external drive or remote machine.</li></ul>
<dl><dd>
<a rel="nofollow" class="external free" href="https://github.com/wesbarnett/snap-sync">https://github.com/wesbarnett/snap-sync</a> || <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=snap-sync">snap-sync</a></span>
</dd></dl>
<ul><li>
<b>snapsync</b> — A synchronization tool for <a href="../en/Snapper.html" title="Snapper">Snapper</a>.</li></ul>
<dl><dd>
<a rel="nofollow" class="external free" href="https://github.com/doudou/snapsync">https://github.com/doudou/snapsync</a> || <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/ruby-snapsync/">ruby-snapsync</a></span><sup><small>AUR</small></sup>
</dd></dl>
<p>The following package allows backing up snapper snapshots to non-Btrfs file systems.
</p>
<ul><li>
<b>snapborg</b> — borgmatic-like tool which integrates snapper snapshots with <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=borg">borg</a></span> backups.</li></ul>
<dl><dd>
<a rel="nofollow" class="external free" href="https://github.com/enzingerm/snapborg">https://github.com/enzingerm/snapborg</a> || <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/snapborg/">snapborg</a></span><sup><small>AUR</small></sup>
</dd></dl>
<h3><span class="mw-headline" id="Automatic_snapshots">Automatic snapshots</span></h3>
<p>For the managing and automatic creation of Btrfs snapshot, one may use a snapshot manager such as <a href="../en/Snapper.html" title="Snapper">Snapper</a>, <a href="../en/Timeshift.html" title="Timeshift">Timeshift</a> or <a href="../en/Yabsnap.html" title="Yabsnap">Yabsnap</a>.
</p>
<h2><span class="mw-headline" id="Troubleshooting">Troubleshooting</span></h2>
<p>See the <a rel="nofollow" class="external text" href="https://btrfs.readthedocs.io/en/latest/trouble-index.html">Btrfs Troubleshooting pages</a> and <a rel="nofollow" class="external text" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/Problem_FAQ.html">Btrfs Problem FAQ</a> for general troubleshooting.
</p>
<h3><span class="mw-headline" id="GRUB">GRUB</span></h3>
<h4><span class="mw-headline" id="Partition_offset">Partition offset</span></h4>
<p>The offset problem may happen when you try to embed <code>core.img</code> into a partitioned disk. It means that <a href="../Special:Diff/319474.html" title="Special:Diff/319474">it is OK</a> to embed GRUB's <code>core.img</code> into a Btrfs pool on a partitionless disk (e.g. <code>/dev/sd<i>X</i></code>) directly.
</p>
<p><a href="../en/GRUB.html" title="GRUB">GRUB</a> can boot Btrfs partitions, however the module may be larger than other <a href="../en/File_systems.html" title="File systems">file systems</a>. And the <code>core.img</code> file made by <code>grub-install</code> may not fit in the first 63 sectors (31.5KiB) of the drive between the MBR and the first partition. Up-to-date partitioning tools such as <code>fdisk</code> and <code>gdisk</code> avoid this issue by offsetting the first partition by roughly 1MiB or 2MiB.
</p>
<h4><span class="mw-headline" id="Missing_root">Missing root</span></h4>
<div class="noprint archwiki-template-message">
<p><span class="mw-default-size" typeof="mw:File"><span><img src="../File:Inaccurate.svg" decoding="async" width="48" height="48" class="mw-file-element"></span></span><b>The factual accuracy of this article or section is disputed.</b></p>
<div>
<b>Reason:</b> Suggests editing a non-configuration file manually. (Discuss in <a href="../en/Talk:Btrfs.html#Should_not_suggest_to_edit_files_in_/usr/share" title="Talk:Btrfs">Talk:Btrfs#Should not suggest to edit files in /usr/share</a>)</div>
</div>
<p>Users experiencing the following: <code>error no such device: root</code> when booting from a RAID style setup then edit /usr/share/grub/grub-mkconfig_lib and remove both quotes from the line <code>echo "  search --no-floppy --fs-uuid --set=root ${hints} ${fs_uuid}"</code>. Regenerate the config for grub and the system should boot without an error.
</p>
<h3><span class="mw-headline" id="Mounting_timed_out">Mounting timed out</span></h3>
<p>Sometimes, especially with large RAID1 arrays, mounting might time out during boot with a journal message such as:
</p>
<pre>Jan 25 18:05:12 host systemd[1]: storage.mount: Mounting timed out. Terminating.
Jan 25 18:05:46 host systemd[1]: storage.mount: Mount process exited, code=killed, status=15/TERM
Jan 25 18:05:46 host systemd[1]: storage.mount: Failed with result 'timeout'.
Jan 25 18:05:46 host systemd[1]: Failed to mount /storage.
Jan 25 18:05:46 host systemd[1]: Startup finished in 32.943s (firmware) + 3.097s (loader) + 7.247s (kernel)&gt;
Jan 25 18:05:46 host kernel: BTRFS error (device sda): open_ctree failed</pre>
<p>This can easily be worked around by providing a longer timeout via the systemd-specific mount option <code>x-systemd.mount-timeout</code> in <a href="../en/Fstab.html" title="Fstab">fstab</a>. For example:
</p>
<pre>/dev/sda                /storage    btrfs       rw,relatime,x-systemd.mount-timeout=5min  0 0
</pre>
<h3><span class="mw-headline" id="BTRFS:_open_ctree_failed">BTRFS: open_ctree failed</span></h3>
<div class="noprint archwiki-template-message">
<p><span class="mw-default-size" typeof="mw:File"><span><img src="../File:Inaccurate.svg" decoding="async" width="48" height="48" class="mw-file-element"></span></span><b>The factual accuracy of this article or section is disputed.</b></p>
<div>
<b>Reason:</b> The status is old. Replacing udev hook with systemd makes no sense since they both use systemd-udevd. (Discuss in <a rel="nofollow" class="external text" href="../en/Talk:Btrfs.html">Talk:Btrfs</a>)</div>
</div>
<p>As of November 2014, there seems to be a bug in <a href="../en/Systemd.html" title="Systemd">systemd</a> or <a href="../en/Mkinitcpio.html" title="Mkinitcpio">mkinitcpio</a> causing the following error on systems with multi-device Btrfs file system using the <code>btrfs</code> hook in <code>mkinitcpio.conf</code>:
</p>
<pre>BTRFS: open_ctree failed
mount: wrong fs type, bad option, bad superblock on /dev/sdb2, missing codepage or helper program, or other error

In some cases, useful info is found in syslog - try dmesg|tail or so.

You are now being dropped into an emergency shell.
</pre>
<p>A workaround is to remove <code>btrfs</code> from the <code>HOOKS</code> array in <code>/etc/mkinitcpio.conf</code> and instead add <code>btrfs</code> to the <code>MODULES</code> array. Then <a href="../en/Mkinitcpio.html#Image_creation_and_activation" class="mw-redirect" title="Regenerate the initramfs">regenerate the initramfs</a> and reboot.
</p>
<p>You will get the same error if you try to mount a raid array without one of the devices. In that case, you must add the <code>degraded</code> mount option to <code>/etc/fstab</code>. If your root resides on the array, you must also add <code>rootflags=degraded</code> to your <a href="../en/Kernel_parameters.html" title="Kernel parameters">kernel parameters</a>.
</p>
<p>As of August 2016, a potential workaround for this bug is to mount the array by a single drive only in <code>/etc/fstab</code>, and allow Btrfs to discover and append the other drives automatically. Group-based identifiers such as UUID and LABEL appear to contribute to the failure. For example, a two-device RAID1 array consisting of 'disk1' and disk2' will have a UUID allocated to it, but instead of using the UUID, use only <code>/dev/mapper/disk1</code> in <code>/etc/fstab</code>. For a more detailed explanation, see the following <a rel="nofollow" class="external text" href="https://web.archive.org/web/20161108175034/http://blog.samcater.com/fix-for-btrfs-open_ctree-failed-when-running-root-fs-on-raid-1-or-raid10-arch-linux/">blog post</a>.
</p>
<p>Another possible workaround is to remove the <code>udev</code> hook in <a href="../en/Mkinitcpio.html#Configuration" class="mw-redirect" title="Mkinitcpio.conf">mkinitcpio.conf</a> and replace it with the <code>systemd</code> hook. In this case, <code>btrfs</code> should <i>not</i> be in the <code>HOOKS</code> or <code>MODULES</code> arrays.
</p>
<p>See the <a rel="nofollow" class="external text" href="https://bbs.archlinux.org/viewtopic.php?id=189845">original forums thread</a> and <a rel="nofollow" class="external text" href="https://bugs.archlinux.org/task/42884">FS#42884</a> for further information and discussion.
</p>
<h3><span class="mw-headline" id="btrfs_check">btrfs check</span></h3>
<div class="noprint archwiki-template-message">
<p><span class="mw-default-size" typeof="mw:File"><span><img src="../File:View-refresh-red.svg" decoding="async" width="48" height="48" class="mw-file-element"></span></span><b>This article or section is out of date.</b></p>
<div>
<b>Reason:</b> The "heavy development" status is old. (Discuss in <a rel="nofollow" class="external text" href="../en/Talk:Btrfs.html">Talk:Btrfs</a>)</div>
</div>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> Since Btrfs is under heavy development, especially the <code>btrfs check</code> command, it is highly recommended to create a <a href="../en/System_maintenance.html#Backup" class="mw-redirect" title="Backup">backup</a> and consult <span class="plainlinks archwiki-template-man" title="$ man 8 btrfs-check"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/btrfs-check.8">btrfs-check(8)</a></span> before executing <code>btrfs check</code> with the <code>--repair</code> switch.</div>
<p>The <span class="plainlinks archwiki-template-man" title="$ man 8 btrfs-check"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/btrfs-check.8">btrfs-check(8)</a></span> command can be used to check or repair an unmounted Btrfs file system. However, this repair tool is still immature and not able to repair certain file system errors even those that do not render the file system unmountable.
</p>
<h3><span class="mw-headline" id="Constant_drive_activity">Constant drive activity</span></h3>
<p>Since the <a href="../en/Kernel.html" title="Kernel">kernel</a> version 6.2, <code>discard=async</code> <span class="plainlinks archwiki-template-man" title="$ man 8 mount"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/mount.8">mount(8)</a></span> option is set by default. This <a rel="nofollow" class="external text" href="https://lore.kernel.org/linux-btrfs/Y%2F%2Bn1wS%2F4XAH7X1p@nz/#r">has been reported</a> to cause constant drive activity on some drives even while idle, as the discard queue is filled faster than it is processed. This can cause increased power usage, especially on NVMe-based drives.
</p>
<p>As of kernel version 6.3, the default discard <code>iops_limit</code> has been changed from 100 to 1000 to address this issue. You can manually set it to a desired value on an old kernel version, e.g.
</p>
<pre># echo 1000 &gt; /sys/fs/btrfs/<i>uuid</i>/discard/iops_limit
</pre>
<p>Where <code><i>uuid</i></code> is the UUID of the Btrfs file system. The limit of <code>1000</code> will need to be tuned experimentally.
</p>
<p>To set the parameter on boot, <a href="../en/Systemd.html#systemd-tmpfiles_-_temporary_files" class="mw-redirect" title="Systemd-tmpfiles">systemd-tmpfiles</a> may be used, e.g. by creating the following file:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/tmpfiles.d/btrfs-discard.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">w /sys/fs/btrfs/<i>uuid</i>/discard/iops_limit - - - - 1000
</pre>
<p>Alternatively, one can disable asynchronous discard altogether by mounting using the <code>nodiscard</code> mount option in <a href="../en/Fstab.html" title="Fstab">fstab</a>, and instead use <a href="../en/Solid_state_drive.html#Periodic_TRIM" title="Solid state drive">Periodic TRIM</a>.
</p>
<h2><span class="mw-headline" id="See_also">See also</span></h2>
<ul>
<li>
<b>Official site</b>
<ul>
<li><a rel="nofollow" class="external text" href="https://btrfs.readthedocs.io">Btrfs Documentation</a></li>
<li><a rel="nofollow" class="external text" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/">Archived Btrfs Wiki</a></li>
</ul>
</li>
<li>
<b>Performance related</b>
<ul>
<li><a rel="nofollow" class="external text" href="https://superuser.com/questions/432188/should-i-put-my-multi-device-btrfs-filesystem-on-disk-partitions-or-raw-devices">Btrfs on raw disks?</a></li>
<li><a rel="nofollow" class="external text" href="https://lore.kernel.org/linux-btrfs/CAKcLGm_MKEdTiHFBd-b-v2sN5gJmgFRqsykzWRXTVqUw4O6Acw@mail.gmail.com/">Varying leafsize and nodesize in Btrfs</a></li>
<li><a rel="nofollow" class="external text" href="https://lore.kernel.org/linux-btrfs/jgui4j$th5$1@dough.gmane.org/">Btrfs support for efficient SSD operation (data blocks alignment)</a></li>
<li><a rel="nofollow" class="external text" href="https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/FAQ.html#Is_Btrfs_optimized_for_SSD.3F">Is Btrfs optimized for SSDs?</a></li>
<li><a rel="nofollow" class="external text" href="https://blog.erdemagaoglu.com/post/4605524309/lzo-vs-snappy-vs-lzf-vs-zlib-a-comparison-of">Lzo vs. zLib</a></li>
</ul>
</li>
<li>
<b>Miscellaneous</b>
<ul>
<li><a href="https://www.funtoo.org/BTRFS_Fun" class="extiw" title="funtoo:BTRFS Fun">Funtoo:BTRFS Fun</a></li>
<li>
<a rel="nofollow" class="external text" href="https://www.phoronix.com/scan.php?page=news_item&amp;px=MTA0ODU">Avi Miller presenting Btrfs</a> at SCALE 10x, January 2012.</li>
<li>
<a rel="nofollow" class="external text" href="https://www.phoronix.com/scan.php?page=news_item&amp;px=MTA4Mzc">Summary of Chris Mason's talk</a> from LFCS 2012</li>
<li>
<a rel="nofollow" class="external text" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=35054394c4b3cecd52577c2662c84da1f3e73525">Btrfs: stop providing a bmap operation to avoid swapfile corruptions</a> 2009-01-21</li>
<li><a rel="nofollow" class="external text" href="https://marc.merlins.org/perso/btrfs/post_2014-03-22_Btrfs-Tips_-Doing-Fast-Incremental-Backups-With-Btrfs-Send-and-Receive.html">Doing Fast Incremental Backups With Btrfs Send and Receive</a></li>
</ul>
</li>
</ul>
</div>
</div>
					<div id="catlinks" class="catlinks" data-mw="interface">
<div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../Special:Categories.html" title="Special:Categories">Category</a>: <ul><li><a href="../en/Category:File_systems.html" title="Category:File systems">File systems</a></li></ul>
</div>
<div id="mw-hidden-catlinks" class="mw-hidden-catlinks mw-hidden-cats-hidden">Hidden categories: <ul>
<li><a href="../en/Category:Pages_or_sections_flagged_with_Template:Expansion.html" title="Category:Pages or sections flagged with Template:Expansion">Pages or sections flagged with Template:Expansion</a></li>
<li><a href="../en/Category:Pages_or_sections_flagged_with_Template:Accuracy.html" title="Category:Pages or sections flagged with Template:Accuracy">Pages or sections flagged with Template:Accuracy</a></li>
<li><a href="../en/Category:Pages_or_sections_flagged_with_Template:Out_of_date.html" title="Category:Pages or sections flagged with Template:Out of date">Pages or sections flagged with Template:Out of date</a></li>
</ul>
</div>
</div>
				</div>
			</main>
			
		</div>
		<div class="mw-footer-container">
			
<footer id="footer" class="mw-footer" role="contentinfo" style="margin: 0">
	<ul id="footer-info">
	<li data-nosnippet="">Retrieved from "<a dir="ltr" href="https://wiki.archlinux.org/index.php?title=Btrfs&amp;oldid=811537">https://wiki.archlinux.org/index.php?title=Btrfs&amp;oldid=811537</a>"</li>
<li id="footer-info-lastmod"> This page was last edited on 29 June 2024, at 08:50.</li>
	<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="https://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.3 or later</a> unless otherwise noted.</li>
<br>
</ul>

	<ul id="footer-places">
	<li id="footer-places-privacy"><a href="https://terms.archlinux.org/docs/privacy-policy/">Privacy policy</a></li>
	<li id="footer-places-about"><a href="../en/ArchWiki:About.html">About ArchWiki</a></li>
	<li id="footer-places-disclaimers"><a href="../en/ArchWiki:General_disclaimer.html">Disclaimers</a></li>
	<li id="footer-places-archwiki-code-of-conduct"><a href="https://terms.archlinux.org/docs/code-of-conduct/" class="extiw" title="archlinux-service-agreements:code-of-conduct">Code of conduct</a></li>
	<li id="footer-places-archwiki-terms-of-service"><a href="https://terms.archlinux.org/docs/terms-of-service/" class="extiw" title="archlinux-service-agreements:terms-of-service">Terms of service</a></li>
</ul>

	<ul id="footer-icons" class="noprint">
	<li id="footer-copyrightico"><a href="https://www.gnu.org/copyleft/fdl.html"><img src="/resources/assets/licenses/gnu-fdl.png" alt="GNU Free Documentation License 1.3 or later" width="88" height="31" loading="lazy"></a></li>
	<li id="footer-poweredbyico"><img src="/resources/assets/poweredby_mediawiki_88x31.png" srcset="/resources/assets/poweredby_mediawiki_132x47.png 1.5x, /resources/assets/poweredby_mediawiki_176x62.png 2x" width="88" height="31" loading="lazy"></li>
</ul>

</footer>

		</div>
	</div> 
</div> 
<div class="vector-settings" id="p-dock-bottom">
	<ul>
		<li>
		<button class="cdx-button cdx-button--icon-only vector-limited-width-toggle" id=""><span class="vector-icon mw-ui-icon-fullScreen mw-ui-icon-wikimedia-fullScreen"></span>

<span>Toggle limited content width</span>
</button>
</li>
	</ul>
</div>
</body>
</html>
