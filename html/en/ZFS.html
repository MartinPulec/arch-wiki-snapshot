<!DOCTYPE html>
<html class="client-nojs vector-feature-language-in-header-enabled vector-feature-language-in-main-page-header-disabled vector-feature-sticky-header-disabled vector-feature-page-tools-pinned-disabled vector-feature-toc-pinned-clientpref-1 vector-feature-main-menu-pinned-disabled vector-feature-limited-width-clientpref-1 vector-feature-limited-width-content-enabled vector-feature-custom-font-size-clientpref-0 vector-feature-client-preferences-disabled vector-feature-client-prefs-pinned-disabled vector-feature-night-mode-disabled skin-theme-clientpref-day vector-toc-available" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>ZFS - ArchWiki</title>
<link rel="stylesheet" href="../ArchWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<meta name="generator" content="MediaWiki 1.42.1">
<meta name="referrer" content="no-referrer-when-downgrade">
<meta name="robots" content="max-image-preview:standard">
<meta name="format-detection" content="telephone=no">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=0.25, maximum-scale=5.0">
<link rel="icon" href="/favicon.ico">
<link rel="search" type="application/opensearchdescription+xml" href="/opensearch_desc.php" title="ArchWiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.archlinux.org/api.php?action=rsd">
<link rel="license" href="https://www.gnu.org/copyleft/fdl.html">
<link rel="alternate" type="application/atom+xml" title="ArchWiki Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="skin-vector skin-vector-search-vue mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-ZFS rootpage-ZFS skin-vector-2022 action-view skin--responsive">
<a class="mw-jump-link" href="#bodyContent">Jump to content</a>
<div class="vector-header-container">
	</div>
<div class="mw-page-container">
	<div class="mw-page-container-inner">
		<div class="vector-column-start">
			<div class="vector-main-menu-container">
		</div>
	<div class="vector-sticky-pinned-container">
				<nav id="mw-panel-toc" role="navigation" aria-label="Contents" data-event-name="ui.sidebar-toc" class="mw-table-of-contents-container vector-toc-landmark">
					<div id="vector-toc-pinned-container" class="vector-pinned-container">
					<div id="vector-toc" class="vector-toc vector-pinnable-element">
	<div class="vector-pinnable-header vector-toc-pinnable-header vector-pinnable-header-pinned" data-feature-name="toc-pinned" data-pinnable-element-id="vector-toc">
	<h2 class="vector-pinnable-header-label">Contents</h2>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-pin-button" data-event-name="pinnable-header.vector-toc.pin">move to sidebar</button>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-unpin-button" data-event-name="pinnable-header.vector-toc.unpin">hide</button>
</div>


	<ul class="vector-toc-contents" id="mw-panel-toc-list">
		<li id="toc-mw-content-text" class="vector-toc-list-item vector-toc-level-1">
			<a href="#" class="vector-toc-link">
				<div class="vector-toc-text">Beginning</div>
			</a>
		</li>
		<li id="toc-Installation" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#Installation">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">1</span>Installation</div>
		</a>
		
			<button aria-controls="toc-Installation-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Installation subsection</span>
			</button>
		
		<ul id="toc-Installation-sublist" class="vector-toc-list">
			<li id="toc-Kernel-specific_packages" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Kernel-specific_packages">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">1.1</span>Kernel-specific packages</div>
			</a>
			
			<ul id="toc-Kernel-specific_packages-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-DKMS" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#DKMS">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">1.2</span>DKMS</div>
			</a>
			
			<ul id="toc-DKMS-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Root_on_ZFS" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Root_on_ZFS">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">1.3</span>Root on ZFS</div>
			</a>
			
			<ul id="toc-Root_on_ZFS-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Experimenting_with_ZFS" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#Experimenting_with_ZFS">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">2</span>Experimenting with ZFS</div>
		</a>
		
		<ul id="toc-Experimenting_with_ZFS-sublist" class="vector-toc-list">
		</ul>
	</li>
	<li id="toc-Configuration" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#Configuration">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">3</span>Configuration</div>
		</a>
		
			<button aria-controls="toc-Configuration-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Configuration subsection</span>
			</button>
		
		<ul id="toc-Configuration-sublist" class="vector-toc-list">
			<li id="toc-Automatic_Start" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Automatic_Start">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.1</span>Automatic Start</div>
			</a>
			
			<ul id="toc-Automatic_Start-sublist" class="vector-toc-list">
				<li id="toc-Using_zfs-mount.service" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Using_zfs-mount.service">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.1.1</span>Using zfs-mount.service</div>
			</a>
			
			<ul id="toc-Using_zfs-mount.service-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Using_zfs-mount-generator" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Using_zfs-mount-generator">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.1.2</span>Using zfs-mount-generator</div>
			</a>
			
			<ul id="toc-Using_zfs-mount-generator-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Storage_pools" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#Storage_pools">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">4</span>Storage pools</div>
		</a>
		
			<button aria-controls="toc-Storage_pools-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Storage pools subsection</span>
			</button>
		
		<ul id="toc-Storage_pools-sublist" class="vector-toc-list">
			<li id="toc-Identify_disks" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Identify_disks">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">4.1</span>Identify disks</div>
			</a>
			
			<ul id="toc-Identify_disks-sublist" class="vector-toc-list">
				<li id="toc-Using_GPT_labels" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Using_GPT_labels">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">4.1.1</span>Using GPT labels</div>
			</a>
			
			<ul id="toc-Using_GPT_labels-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Creating_ZFS_pools" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Creating_ZFS_pools">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">4.2</span>Creating ZFS pools</div>
			</a>
			
			<ul id="toc-Creating_ZFS_pools-sublist" class="vector-toc-list">
				<li id="toc-Advanced_Format_disks" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Advanced_Format_disks">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">4.2.1</span>Advanced Format disks</div>
			</a>
			
			<ul id="toc-Advanced_Format_disks-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-GRUB-compatible_pool_creation" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#GRUB-compatible_pool_creation">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">4.2.2</span>GRUB-compatible pool creation</div>
			</a>
			
			<ul id="toc-GRUB-compatible_pool_creation-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Verifying_pool_status" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Verifying_pool_status">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">4.3</span>Verifying pool status</div>
			</a>
			
			<ul id="toc-Verifying_pool_status-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Importing_a_pool_created_by_id" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Importing_a_pool_created_by_id">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">4.4</span>Importing a pool created by id</div>
			</a>
			
			<ul id="toc-Importing_a_pool_created_by_id-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Destroy_a_storage_pool" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Destroy_a_storage_pool">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">4.5</span>Destroy a storage pool</div>
			</a>
			
			<ul id="toc-Destroy_a_storage_pool-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Exporting_a_storage_pool" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Exporting_a_storage_pool">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">4.6</span>Exporting a storage pool</div>
			</a>
			
			<ul id="toc-Exporting_a_storage_pool-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Extending_an_existing_zpool" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Extending_an_existing_zpool">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">4.7</span>Extending an existing zpool</div>
			</a>
			
			<ul id="toc-Extending_an_existing_zpool-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Attaching_a_device_to_(create)_a_mirror" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Attaching_a_device_to_(create)_a_mirror">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">4.8</span>Attaching a device to (create) a mirror</div>
			</a>
			
			<ul id="toc-Attaching_a_device_to_(create)_a_mirror-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Renaming_a_zpool" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Renaming_a_zpool">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">4.9</span>Renaming a zpool</div>
			</a>
			
			<ul id="toc-Renaming_a_zpool-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Setting_a_different_mount_point" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Setting_a_different_mount_point">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">4.10</span>Setting a different mount point</div>
			</a>
			
			<ul id="toc-Setting_a_different_mount_point-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Upgrade_zpools" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Upgrade_zpools">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">4.11</span>Upgrade zpools</div>
			</a>
			
			<ul id="toc-Upgrade_zpools-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Creating_datasets" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#Creating_datasets">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">5</span>Creating datasets</div>
		</a>
		
			<button aria-controls="toc-Creating_datasets-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Creating datasets subsection</span>
			</button>
		
		<ul id="toc-Creating_datasets-sublist" class="vector-toc-list">
			<li id="toc-Native_encryption" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Native_encryption">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">5.1</span>Native encryption</div>
			</a>
			
			<ul id="toc-Native_encryption-sublist" class="vector-toc-list">
				<li id="toc-Unlock/Mount_at_boot_time:_systemd" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Unlock/Mount_at_boot_time:_systemd">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">5.1.1</span>Unlock/Mount at boot time: systemd</div>
			</a>
			
			<ul id="toc-Unlock/Mount_at_boot_time:_systemd-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Unlock_at_login_time:_PAM" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Unlock_at_login_time:_PAM">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">5.1.2</span>Unlock at login time: PAM</div>
			</a>
			
			<ul id="toc-Unlock_at_login_time:_PAM-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Swap_volume" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Swap_volume">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">5.2</span>Swap volume</div>
			</a>
			
			<ul id="toc-Swap_volume-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Access_Control_Lists" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Access_Control_Lists">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">5.3</span>Access Control Lists</div>
			</a>
			
			<ul id="toc-Access_Control_Lists-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Databases" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Databases">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">5.4</span>Databases</div>
			</a>
			
			<ul id="toc-Databases-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-/tmp" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#/tmp">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">5.5</span>/tmp</div>
			</a>
			
			<ul id="toc-/tmp-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Transmitting_snapshots_with_ZFS_Send_and_ZFS_Recv" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Transmitting_snapshots_with_ZFS_Send_and_ZFS_Recv">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">5.6</span>Transmitting snapshots with ZFS Send and ZFS Recv</div>
			</a>
			
			<ul id="toc-Transmitting_snapshots_with_ZFS_Send_and_ZFS_Recv-sublist" class="vector-toc-list">
				<li id="toc-Basic_ZFS_Send" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Basic_ZFS_Send">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">5.6.1</span>Basic ZFS Send</div>
			</a>
			
			<ul id="toc-Basic_ZFS_Send-sublist" class="vector-toc-list">
				<li id="toc-To_and_from_files" class="vector-toc-list-item vector-toc-level-4">
			<a class="vector-toc-link" href="#To_and_from_files">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">5.6.1.1</span>To and from files</div>
			</a>
			
			<ul id="toc-To_and_from_files-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Send_over_ssh" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Send_over_ssh">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">5.6.2</span>Send over ssh</div>
			</a>
			
			<ul id="toc-Send_over_ssh-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Incremental_Backups" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Incremental_Backups">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">5.6.3</span>Incremental Backups</div>
			</a>
			
			<ul id="toc-Incremental_Backups-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Tuning" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#Tuning">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">6</span>Tuning</div>
		</a>
		
			<button aria-controls="toc-Tuning-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Tuning subsection</span>
			</button>
		
		<ul id="toc-Tuning-sublist" class="vector-toc-list">
			<li id="toc-General" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#General">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">6.1</span>General</div>
			</a>
			
			<ul id="toc-General-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Scrubbing" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Scrubbing">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">6.2</span>Scrubbing</div>
			</a>
			
			<ul id="toc-Scrubbing-sublist" class="vector-toc-list">
				<li id="toc-How_often_should_I_do_this?" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#How_often_should_I_do_this?">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">6.2.1</span>How often should I do this?</div>
			</a>
			
			<ul id="toc-How_often_should_I_do_this?-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Start_with_a_service_or_timer" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Start_with_a_service_or_timer">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">6.2.2</span>Start with a service or timer</div>
			</a>
			
			<ul id="toc-Start_with_a_service_or_timer-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Enabling_TRIM" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Enabling_TRIM">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">6.3</span>Enabling TRIM</div>
			</a>
			
			<ul id="toc-Enabling_TRIM-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-SSD_Caching" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#SSD_Caching">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">6.4</span>SSD Caching</div>
			</a>
			
			<ul id="toc-SSD_Caching-sublist" class="vector-toc-list">
				<li id="toc-ZIL" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#ZIL">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">6.4.1</span>ZIL</div>
			</a>
			
			<ul id="toc-ZIL-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-L2ARC" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#L2ARC">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">6.4.2</span>L2ARC</div>
			</a>
			
			<ul id="toc-L2ARC-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-ZVOLs" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#ZVOLs">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">6.5</span>ZVOLs</div>
			</a>
			
			<ul id="toc-ZVOLs-sublist" class="vector-toc-list">
				<li id="toc-RAIDZ_and_Advanced_Format_physical_disks" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#RAIDZ_and_Advanced_Format_physical_disks">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">6.5.1</span>RAIDZ and Advanced Format physical disks</div>
			</a>
			
			<ul id="toc-RAIDZ_and_Advanced_Format_physical_disks-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-I/O_Scheduler" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#I/O_Scheduler">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">6.6</span>I/O Scheduler</div>
			</a>
			
			<ul id="toc-I/O_Scheduler-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Troubleshooting" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#Troubleshooting">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">7</span>Troubleshooting</div>
		</a>
		
			<button aria-controls="toc-Troubleshooting-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Troubleshooting subsection</span>
			</button>
		
		<ul id="toc-Troubleshooting-sublist" class="vector-toc-list">
			<li id="toc-Creating_a_zpool_fails" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Creating_a_zpool_fails">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">7.1</span>Creating a zpool fails</div>
			</a>
			
			<ul id="toc-Creating_a_zpool_fails-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-ZFS_is_using_too_much_RAM" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#ZFS_is_using_too_much_RAM">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">7.2</span>ZFS is using too much RAM</div>
			</a>
			
			<ul id="toc-ZFS_is_using_too_much_RAM-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Does_not_contain_an_EFI_label" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Does_not_contain_an_EFI_label">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">7.3</span>Does not contain an EFI label</div>
			</a>
			
			<ul id="toc-Does_not_contain_an_EFI_label-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-No_hostid_found" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#No_hostid_found">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">7.4</span>No hostid found</div>
			</a>
			
			<ul id="toc-No_hostid_found-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Pool_cannot_be_found_while_booting_from_SAS/SCSI_devices" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Pool_cannot_be_found_while_booting_from_SAS/SCSI_devices">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">7.5</span>Pool cannot be found while booting from SAS/SCSI devices</div>
			</a>
			
			<ul id="toc-Pool_cannot_be_found_while_booting_from_SAS/SCSI_devices-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id='toc-On_boot_the_zfs_pool_does_not_mount_stating:_"pool_may_be_in_use_from_other_system"' class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href='#On_boot_the_zfs_pool_does_not_mount_stating:_"pool_may_be_in_use_from_other_system"'>
				<div class="vector-toc-text">
				<span class="vector-toc-numb">7.6</span>On boot the zfs pool does not mount stating: "pool may be in use from other system"</div>
			</a>
			
			<ul id='toc-On_boot_the_zfs_pool_does_not_mount_stating:_"pool_may_be_in_use_from_other_system"-sublist' class="vector-toc-list">
				<li id="toc-Unexported_pool" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Unexported_pool">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">7.6.1</span>Unexported pool</div>
			</a>
			
			<ul id="toc-Unexported_pool-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Incorrect_hostid" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Incorrect_hostid">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">7.6.2</span>Incorrect hostid</div>
			</a>
			
			<ul id="toc-Incorrect_hostid-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Devices_have_different_sector_alignment" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Devices_have_different_sector_alignment">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">7.7</span>Devices have different sector alignment</div>
			</a>
			
			<ul id="toc-Devices_have_different_sector_alignment-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Pool_resilvering_stuck/restarting/slow?" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Pool_resilvering_stuck/restarting/slow?">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">7.8</span>Pool resilvering stuck/restarting/slow?</div>
			</a>
			
			<ul id="toc-Pool_resilvering_stuck/restarting/slow?-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Fix_slow_boot_caused_by_failed_import_of_unavailable_pools_in_the_initramfs_zpool.cache" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Fix_slow_boot_caused_by_failed_import_of_unavailable_pools_in_the_initramfs_zpool.cache">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">7.9</span>Fix slow boot caused by failed import of unavailable pools in the initramfs zpool.cache</div>
			</a>
			
			<ul id="toc-Fix_slow_boot_caused_by_failed_import_of_unavailable_pools_in_the_initramfs_zpool.cache-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-ZFS_Command_History" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#ZFS_Command_History">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">7.10</span>ZFS Command History</div>
			</a>
			
			<ul id="toc-ZFS_Command_History-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Tips_and_tricks" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#Tips_and_tricks">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">8</span>Tips and tricks</div>
		</a>
		
			<button aria-controls="toc-Tips_and_tricks-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Tips and tricks subsection</span>
			</button>
		
		<ul id="toc-Tips_and_tricks-sublist" class="vector-toc-list">
			<li id="toc-Create_an_Archiso_image_with_ZFS_support" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Create_an_Archiso_image_with_ZFS_support">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.1</span>Create an Archiso image with ZFS support</div>
			</a>
			
			<ul id="toc-Create_an_Archiso_image_with_ZFS_support-sublist" class="vector-toc-list">
				<li id="toc-Using_self-built_ZFS_packages_from_the_AUR" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Using_self-built_ZFS_packages_from_the_AUR">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.1.1</span>Using self-built ZFS packages from the AUR</div>
			</a>
			
			<ul id="toc-Using_self-built_ZFS_packages_from_the_AUR-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Using_the_archzfs_unofficial_user_repository" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Using_the_archzfs_unofficial_user_repository">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.1.2</span>Using the archzfs unofficial user repository</div>
			</a>
			
			<ul id="toc-Using_the_archzfs_unofficial_user_repository-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Finishing_up" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Finishing_up">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.1.3</span>Finishing up</div>
			</a>
			
			<ul id="toc-Finishing_up-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Automatic_snapshots" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Automatic_snapshots">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.2</span>Automatic snapshots</div>
			</a>
			
			<ul id="toc-Automatic_snapshots-sublist" class="vector-toc-list">
				<li id="toc-zrepl" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#zrepl">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.2.1</span>zrepl</div>
			</a>
			
			<ul id="toc-zrepl-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-sanoid" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#sanoid">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.2.2</span>sanoid</div>
			</a>
			
			<ul id="toc-sanoid-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-ZFS_Automatic_Snapshot_Service_for_Linux" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#ZFS_Automatic_Snapshot_Service_for_Linux">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.2.3</span>ZFS Automatic Snapshot Service for Linux</div>
			</a>
			
			<ul id="toc-ZFS_Automatic_Snapshot_Service_for_Linux-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Creating_a_share" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Creating_a_share">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.3</span>Creating a share</div>
			</a>
			
			<ul id="toc-Creating_a_share-sublist" class="vector-toc-list">
				<li id="toc-NFS" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#NFS">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.3.1</span>NFS</div>
			</a>
			
			<ul id="toc-NFS-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-SMB" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#SMB">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.3.2</span>SMB</div>
			</a>
			
			<ul id="toc-SMB-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Encryption_in_ZFS_using_dm-crypt" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Encryption_in_ZFS_using_dm-crypt">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.4</span>Encryption in ZFS using dm-crypt</div>
			</a>
			
			<ul id="toc-Encryption_in_ZFS_using_dm-crypt-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Emergency_chroot_repair_with_archzfs" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Emergency_chroot_repair_with_archzfs">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.5</span>Emergency chroot repair with archzfs</div>
			</a>
			
			<ul id="toc-Emergency_chroot_repair_with_archzfs-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Bind_mount" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Bind_mount">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.6</span>Bind mount</div>
			</a>
			
			<ul id="toc-Bind_mount-sublist" class="vector-toc-list">
				<li id="toc-fstab" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#fstab">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.6.1</span>fstab</div>
			</a>
			
			<ul id="toc-fstab-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Monitoring_/_Mailing_on_Events" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Monitoring_/_Mailing_on_Events">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.7</span>Monitoring / Mailing on Events</div>
			</a>
			
			<ul id="toc-Monitoring_/_Mailing_on_Events-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Wrap_shell_commands_in_pre_&amp;_post_snapshots" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Wrap_shell_commands_in_pre_&amp;_post_snapshots">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.8</span>Wrap shell commands in pre &amp; post snapshots</div>
			</a>
			
			<ul id="toc-Wrap_shell_commands_in_pre_&amp;_post_snapshots-sublist" class="vector-toc-list">
				<li id="toc-znp" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#znp">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.8.1</span>znp</div>
			</a>
			
			<ul id="toc-znp-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Remote_unlocking_of_ZFS_encrypted_root" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Remote_unlocking_of_ZFS_encrypted_root">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.9</span>Remote unlocking of ZFS encrypted root</div>
			</a>
			
			<ul id="toc-Remote_unlocking_of_ZFS_encrypted_root-sublist" class="vector-toc-list">
				<li id="toc-Changing_the_SSH_server_port" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Changing_the_SSH_server_port">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.9.1</span>Changing the SSH server port</div>
			</a>
			
			<ul id="toc-Changing_the_SSH_server_port-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Unlocking_from_a_Windows_machine_using_PuTTY/Plink" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Unlocking_from_a_Windows_machine_using_PuTTY/Plink">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.9.2</span>Unlocking from a Windows machine using PuTTY/Plink</div>
			</a>
			
			<ul id="toc-Unlocking_from_a_Windows_machine_using_PuTTY/Plink-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Enabling_bclone_support_(cp_--reflink)" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Enabling_bclone_support_(cp_--reflink)">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.10</span>Enabling bclone support (<i>cp --reflink</i>)</div>
			</a>
			
			<ul id="toc-Enabling_bclone_support_(cp_--reflink)-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-See_also" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#See_also">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">9</span>See also</div>
		</a>
		
		<ul id="toc-See_also-sublist" class="vector-toc-list">
		</ul>
	</li>
</ul>
</div>

					</div>
		</nav>
			</div>
		</div>
		<div class="mw-content-container">
			<main id="content" class="mw-body" role="main" style="margin: 0">
				<header class="mw-body-header vector-page-titlebar">
					<nav role="navigation" aria-label="Contents" class="vector-toc-landmark">
						
<div id="vector-page-titlebar-toc" class="vector-dropdown vector-page-titlebar-toc vector-button-flush-left">
	<input type="checkbox" id="vector-page-titlebar-toc-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-vector-page-titlebar-toc" class="vector-dropdown-checkbox " aria-label="Toggle the table of contents">
	<label id="vector-page-titlebar-toc-label" for="vector-page-titlebar-toc-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--icon-only " aria-hidden="true"><span class="vector-icon mw-ui-icon-listBullet mw-ui-icon-wikimedia-listBullet"></span>

<span class="vector-dropdown-label-text">Toggle the table of contents</span>
	</label>
	<div class="vector-dropdown-content">


							<div id="vector-page-titlebar-toc-unpinned-container" class="vector-unpinned-container">
			</div>
		
	</div>
</div>

					</nav>
					<h1 id="firstHeading" class="firstHeading mw-first-heading"><span class="mw-page-title-main">ZFS</span></h1>
							
<div id="p-lang-btn" class="vector-dropdown mw-portlet mw-portlet-lang">
	<input type="checkbox" id="p-lang-btn-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-p-lang-btn" class="vector-dropdown-checkbox mw-interlanguage-selector" aria-label="Go to an article in another language. Available in 3 languages">
	<label id="p-lang-btn-label" for="p-lang-btn-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--action-progressive mw-portlet-lang-heading-3" aria-hidden="true"><span class="vector-icon mw-ui-icon-language-progressive mw-ui-icon-wikimedia-language-progressive"></span>

<span class="vector-dropdown-label-text">3 languages</span>
	</label>
	<div class="vector-dropdown-content">

		<div class="vector-menu-content">
			
			<ul class="vector-menu-content-list">
				
				<li class="interlanguage-link interwiki-ja mw-list-item"><a href="https://wiki.archlinux.jp/index.php/ZFS" title="ZFS – 日本語" lang="ja" hreflang="ja" class="interlanguage-link-target"><span>日本語</span></a></li>
<li class="interlanguage-link interwiki-pt mw-list-item"><a href="../pt/ZFS.html" title="ZFS – português" lang="pt" hreflang="pt" class="interlanguage-link-target"><span>Português</span></a></li>
<li class="interlanguage-link interwiki-zh-hans mw-list-item"><a href="https://wiki.archlinuxcn.org/wiki/ZFS" title="ZFS – 中文（简体）" lang="zh-Hans" hreflang="zh-Hans" class="interlanguage-link-target"><span>中文（简体）</span></a></li>
			</ul>
			
		</div>

	</div>
</div>
</header>
				<div class="vector-column-end">
					<div class="vector-sticky-pinned-container">
						<nav class="vector-page-tools-landmark" aria-label="Page tools">
							<div id="vector-page-tools-pinned-container" class="vector-pinned-container">
				
							</div>
		</nav>
						<nav class="vector-client-prefs-landmark" aria-label="Appearance">
						</nav>
					</div>
				</div>
				<div id="bodyContent" class="vector-body" aria-labelledby="firstHeading" data-mw-ve-target-container>
					<div class="vector-body-before-content">
							<div class="mw-indicators">
		</div>

						<div id="siteSub" class="noprint">From ArchWiki</div>
					</div>
					<div id="contentSub"><div id="mw-content-subtitle"></div></div>
					
					
					<div id="mw-content-text" class="mw-body-content">
<div class="mw-content-ltr mw-parser-output" lang="en" dir="ltr">
<div class="archwiki-template-meta-related-articles">
<p>Related articles</p>
<ul>
<li><a href="../en/File_systems.html" title="File systems">File systems</a></li>
<li><a href="../en/ZFS/Virtual_disks.html" title="ZFS/Virtual disks">ZFS/Virtual disks</a></li>
<li><a href="../en/Install_Arch_Linux_on_ZFS.html" title="Install Arch Linux on ZFS">Install Arch Linux on ZFS</a></li>
</ul>
</div>
<p><a href="https://en.wikipedia.org/wiki/ZFS" class="extiw" title="wikipedia:ZFS">ZFS</a> is an advanced filesystem, originally developed and released by <a href="https://en.wikipedia.org/wiki/Sun_Microsystems" class="extiw" title="wikipedia:Sun Microsystems">Sun Microsystems</a> in 2005.
</p>
<p>Described as <a rel="nofollow" class="external text" href="https://web.archive.org/web/20060428092023/http://www.sun.com/2004-0914/feature/">"The last word in filesystems"</a>, ZFS is stable, fast, secure, and future-proof.
Features of ZFS include: pooled storage (integrated volume management – zpool), <a href="https://en.wikipedia.org/wiki/Copy-on-write" class="extiw" title="wikipedia:Copy-on-write">Copy-on-write</a>, <a href="https://en.wikipedia.org/wiki/Snapshot_(computer_storage)" class="extiw" title="wikipedia:Snapshot (computer storage)">snapshots</a>, data integrity verification and automatic repair (scrubbing), <a href="https://en.wikipedia.org/wiki/RAID-Z" class="extiw" title="wikipedia:RAID-Z">RAID-Z</a>, a maximum <a href="https://en.wikipedia.org/wiki/Exabyte" class="extiw" title="wikipedia:Exabyte">16 exabyte</a> file size, and a maximum 256 quadrillion <a href="https://en.wikipedia.org/wiki/Zettabyte" class="extiw" title="wikipedia:Zettabyte">zettabyte</a> storage with no limit on number of filesystems (datasets) or files<a rel="nofollow" class="external autonumber" href="https://docs.oracle.com/cd/E19253-01/819-5461/zfsover-2/index.html">[1]</a>.
</p>
<p>ZFS is licensed under the <a href="https://en.wikipedia.org/wiki/CDDL" class="extiw" title="wikipedia:CDDL">Common Development and Distribution License</a> (CDDL). Because the CDDL is incompatible with the GPL, <a rel="nofollow" class="external text" href="https://sfconservancy.org/blog/2016/feb/25/zfs-and-linux/">it is not possible</a> for ZFS to be included in the Linux Kernel. This requirement, however, does not prevent a native Linux kernel module from being developed and distributed by a third party, as is the case with <a rel="nofollow" class="external text" href="https://openzfs.org">OpenZFS</a> (previously named ZFS on Linux).
</p>
<p>As a result of ZFS not being included in the Linux kernel:
</p>
<ul>
<li>OpenZFS project must keep up with Linux kernel versions. After making stable OpenZFS release - Arch ZFS maintainers release them.</li>
<li>This situation sometimes locks down the normal rolling update process by unsatisfied dependencies because the new kernel version, proposed by update, is unsupported by OpenZFS.</li>
</ul>
<meta property="mw:PageProp/toc">
<h2><span class="mw-headline" id="Installation">Installation</span></h2>
<p>The kernel modules for ZFS can be installed in two ways—either installing a package that provides the modules for a specific kernel version or using a <a href="../en/Dynamic_Kernel_Module_Support.html" class="mw-redirect" title="DKMS">DKMS</a> package that builds the modules for installed kernels. See the following sections.
</p>
<p>ZFS userspace utilities are provided by the <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/zfs-utils/">zfs-utils</a></span><sup><small>AUR</small></sup> package which is a dependency of all zfs kernel module packages.
</p>
<h3><span class="mw-headline" id="Kernel-specific_packages">Kernel-specific packages</span></h3>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> Unless you use the <a href="../en/Dynamic_Kernel_Module_Support.html" class="mw-redirect" title="Dkms">dkms</a> versions of these packages, the ZFS and SPL kernel modules are tied to a specific kernel version. It will not be possible to apply any kernel updates until updated packages are uploaded to AUR or the <a href="../en/Unofficial_user_repositories.html#archzfs" title="Unofficial user repositories">archzfs</a> repository.</div>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> You can <a href="../en/Downgrading_packages.html" class="mw-redirect" title="Downgrade">downgrade</a> your linux version to the one from <a href="../en/Unofficial_user_repositories.html#archzfs" title="Unofficial user repositories">archzfs</a> repository if your current kernel is newer or switch to the LTS kernel which may provide better compatibility with out-of-tree kernel modules.</div>
<p>Install from the <a href="../en/Unofficial_user_repositories.html#archzfs" title="Unofficial user repositories">archzfs</a> repository or alternatively the <a href="../en/Arch_User_Repository.html" title="Arch User Repository">Arch User Repository</a>:
</p>
<ul>
<li>
<span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/zfs-linux/">zfs-linux</a></span><sup><small>AUR</small></sup>—<a rel="nofollow" class="external text" href="https://zfsonlinux.org/">stable releases</a> for <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=linux">linux</a></span>.</li>
<li>
<span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/zfs-linux-git/">zfs-linux-git</a></span><sup><small>AUR</small></sup>—<a rel="nofollow" class="external text" href="https://github.com/openzfs/zfs">development</a> releases (with support of newer kernel versions) for <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=linux">linux</a></span>.</li>
<li>
<span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/zfs-linux-lts/">zfs-linux-lts</a></span><sup><small>AUR</small></sup>—stable releases for <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=linux-lts">linux-lts</a></span>.</li>
<li>
<span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/zfs-linux-hardened/">zfs-linux-hardened</a></span><sup><small>AUR</small></sup>—stable releases for <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=linux-hardened">linux-hardened</a></span>.</li>
<li>
<span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/zfs-linux-zen/">zfs-linux-zen</a></span><sup><small>AUR</small></sup>—stable releases for <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=linux-zen">linux-zen</a></span>.</li>
</ul>
<p>Test the installation by issuing <code>zpool status</code> on the command line. If an "insmod" error is produced, try <code>depmod -a</code>.
</p>
<h3><span class="mw-headline" id="DKMS">DKMS</span></h3>
<p>Users can make use of <a href="../en/Dynamic_Kernel_Module_Support.html" title="Dynamic Kernel Module Support">Dynamic Kernel Module Support</a> (DKMS) to rebuild the ZFS modules automatically.
</p>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> Occasionally, the dkms package might not compile against the newest kernel packages in Arch. Using the <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=linux-lts">linux-lts</a></span> <a href="../en/Kernel.html" title="Kernel">kernel</a> may provide better compatibility with out-of-tree kernel modules.</div>
<p>Install from the <a href="../en/Unofficial_user_repositories.html#archzfs" title="Unofficial user repositories">archzfs</a> repository or alternatively the <a href="../en/Arch_User_Repository.html" title="Arch User Repository">Arch User Repository</a>:
</p>
<ul>
<li>
<span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/zfs-dkms/">zfs-dkms</a></span><sup><small>AUR</small></sup> for versions with dynamic kernel module support.</li>
<li>
<span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/zfs-dkms-git/">zfs-dkms-git</a></span><sup><small>AUR</small></sup> for development releases for versions with dynamic kernel module support.</li>
</ul>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> Add an <code>IgnorePkg</code> entry to <a href="../en/Pacman.html#Configuration" class="mw-redirect" title="Pacman.conf">pacman.conf</a> to prevent these packages from upgrading when doing a regular update.</div>
<p>To compile the ZFS modules provided by the aforementioned dkms packages, it is also necessary to install the appropriate headers package(s) for your installed kernel(s) (e.g. <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=linux-headers">linux-headers</a></span> for <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=linux">linux</a></span>, <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=linux-lts-headers">linux-lts-headers</a></span> for <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=linux-lts">linux-lts</a></span>, etc.). When either the dkms packages or the kernel is updated, the kernel modules will be automatically recompiled thanks to the <a href="../en/Dynamic_Kernel_Module_Support.html" class="mw-redirect" title="DKMS">DKMS</a> <a href="../en/Pacman.html#Hooks" class="mw-redirect" title="Pacman hook">pacman hook</a>.
</p>
<h3><span class="mw-headline" id="Root_on_ZFS">Root on ZFS</span></h3>
<p>See <a href="../en/Install_Arch_Linux_on_ZFS.html#Installation" title="Install Arch Linux on ZFS">Install Arch Linux on ZFS#Installation</a>.
</p>
<h2><span class="mw-headline" id="Experimenting_with_ZFS">Experimenting with ZFS</span></h2>
<p>Users wishing to experiment with ZFS on <i>virtual block devices</i> (known in ZFS terms as VDEVs) which can be simple files like <code>~/zfs0.img</code> <code>~/zfs1.img</code> <code>~/zfs2.img</code> etc. with no possibility of real data loss are encouraged to see the <a href="../en/ZFS/Virtual_disks.html" class="mw-redirect" title="Experimenting with ZFS">Experimenting with ZFS</a> article. Common tasks like building a RAIDZ array, purposefully corrupting data and recovering it, snapshotting datasets, etc. are covered.
</p>
<h2><span class="mw-headline" id="Configuration">Configuration</span></h2>
<p>ZFS is considered a "zero administration" filesystem by its creators; therefore, configuring ZFS is very straight forward. Configuration is done primarily with two commands: <code>zfs</code> and <code>zpool</code>.
</p>
<h3><span class="mw-headline" id="Automatic_Start">Automatic Start</span></h3>
<p>For ZFS to live by its "zero administration" namesake, <code>zfs-import-cache.service</code> must be enabled to import the pools and <code>zfs-mount.service</code> must be enabled to mount the filesystems available in the pools. A benefit to this is that it is not necessary to mount ZFS filesystems in <code>/etc/fstab</code>. <code>zfs-import-cache.service</code> imports the zfs pools reading the file <code>/etc/zfs/zpool.cache</code>.
</p>
<p>For each <a href="#Importing_a_pool_created_by_id">imported pool</a> you want automatically imported by <code>zfs-import-cache.service</code> execute:
</p>
<pre># zpool set cachefile=/etc/zfs/zpool.cache &lt;pool&gt;
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> Beginning with <a rel="nofollow" class="external text" href="https://github.com/openzfs/zfs/releases/tag/zfs-0.6.5.8">OpenZFS version 0.6.5.8</a> the ZFS service unit files have been changed so that you need to explicitly enable any ZFS services you want to run. See <a rel="nofollow" class="external text" href="https://github.com/archzfs/archzfs/issues/72">ArchZFS issue 72</a> for more information.</div>
<p><a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Enable">Enable</a> the relevant service (<code>zfs-import-cache.service</code>) and targets (<code>zfs.target</code> and <code>zfs-import.target</code>) so the pools are automatically imported at boot time:
</p>
<p>To mount the ZFS filesystems, you have 2 choices:
</p>
<ul>
<li>Enable the <a href="#Using_zfs-mount.service">zfs-mount.service</a>
</li>
<li>Using <a href="#Using_zfs-mount-generator">zfs-mount-generator</a>
</li>
</ul>
<h4><span class="mw-headline" id="Using_zfs-mount.service">Using zfs-mount.service</span></h4>
<p>In order to mount ZFS filesystems automatically on boot you need to <a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Enable">enable</a> <code>zfs-mount.service</code> and <code>zfs.target</code>.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> 
<ul>
<li>This does not work with separated <code>/var</code> dataset because it does not get mounted early enough. Instead you should use <a href="#Using_zfs-mount-generator">zfs-mount-generator</a> option. See <a rel="nofollow" class="external text" href="https://github.com/openzfs/zfs/issues/3768">OpenZFS issue #3768</a> for more information.</li>
<li>It appears that the ZFS module is loaded too late for using this method, see <a rel="nofollow" class="external text" href="https://bbs.archlinux.org/viewtopic.php?id=274044">BBS#274044</a> and <a href="../en/Talk:ZFS.html#zfs_hook_in_mkinitcpio.conf" title="Talk:ZFS">Talk:ZFS#zfs hook in mkinitcpio.conf</a>. The workaround is to use the <code>ZFS</code> <a href="../en/Mkinitcpio.html" title="Mkinitcpio">mkinitcpio</a> hook.</li>
</ul>
</div>
<h4><span class="mw-headline" id="Using_zfs-mount-generator">Using zfs-mount-generator</span></h4>
<p>You can also use the zfs-mount-generator to create systemd mount units for your ZFS filesystems at boot. systemd will automatically mount the filesystems based on the mount units without having to use the <code>zfs-mount.service</code>. To do that, you need to:
</p>
<ol>
<li>Create the <code>/etc/zfs/zfs-list.cache</code> directory.</li>
<li>Enable the ZFS Event Daemon(ZED) script (called a ZEDLET) required to create a list of mountable ZFS filesystems. (This link is created automatically if you are using OpenZFS &gt;= 2.0.0.) <pre># ln -s /usr/lib/zfs/zed.d/history_event-zfs-list-cacher.sh /etc/zfs/zed.d</pre>
</li>
<li>
<a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Enable">Enable</a> <code>zfs.target</code> and <a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Enable/start">enable/start</a> the ZFS Event Daemon (<code>zfs-zed.service</code>). This service is responsible for running the script in the previous step.</li>
<li>You need to create an empty file named after your pool in <code>/etc/zfs/zfs-list.cache</code>. The ZEDLET will only update the list of filesystems if the file for the pool already exists. <pre># touch /etc/zfs/zfs-list.cache/&lt;pool-name&gt;</pre>
</li>
<li>Check the contents of <code>/etc/zfs/zfs-list.cache/&lt;pool-name&gt;</code>. If it is empty, make sure that the <code>zfs-zed.service</code> is running and just change the canmount property of any of your ZFS filesystem by running: <pre>zfs set canmount=off zroot/fs1</pre> This change causes ZFS to raise an event which is captured by ZED, which in turn runs the ZEDLET to update the file in <code>/etc/zfs/zfs-list.cache</code>. If the file in <code>/etc/zfs/zfs-list.cache</code> is updated, you can set the <code>canmount</code> property of the filesystem back by running: <pre>zfs set canmount=on zroot/fs1</pre>
</li>
</ol>
<p>You need to add a file in <code>/etc/zfs/zfs-list.cache</code> for each ZFS pool in your system. Make sure the pools are imported by enabling <code>zfs-import-cache.service</code> and <code>zfs-import.target</code> as <a href="#Automatic_Start">explained above</a>.
</p>
<h2><span class="mw-headline" id="Storage_pools">Storage pools</span></h2>
<p>It is not necessary to partition the drives before creating the ZFS filesystem. It is recommended to point ZFS at an entire disk (ie. <code>/dev/sdx</code> rather than <code>/dev/sdx1</code>), which will <a rel="nofollow" class="external text" href="https://www.reddit.com/r/zfs/comments/667na0/zfs_on_raw_or_gpt/dgh0l9t/">automatically create a GPT (GUID Partition Table)</a> and add an 8 MB reserved partition at the end of the disk for legacy bootloaders. However, you can specify a partition or a file within an existing filesystem, if you wish to create multiple volumes with different redundancy properties.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> If some or all device have been used in a software RAID set it is paramount to <a href="../en/RAID.html#Prepare_the_devices" class="mw-redirect" title="Mdadm">erase any old RAID configuration information</a>.</div>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> For <a href="../en/Advanced_Format.html" title="Advanced Format">Advanced Format</a> Disks with 4KB sector size, an ashift of 12 is recommended for best performance. Advanced Format disks emulate a sector size of 512 bytes for compatibility with legacy systems, this causes ZFS to sometimes use an ashift option number that is not ideal. Once the pool has been created, the only way to change the ashift option is to recreate the pool. Using an ashift of 12 would also decrease available capacity. See the OpenZFS FAQ: <a rel="nofollow" class="external text" href="https://openzfs.github.io/openzfs-docs/Project%20and%20Community/FAQ.html#performance-considerations">Performance Considerations</a>, <a rel="nofollow" class="external text" href="https://openzfs.github.io/openzfs-docs/Project%20and%20Community/FAQ.html#advanced-format-disks">Advanced Format Disks</a>, and <a rel="nofollow" class="external text" href="https://web.archive.org/web/20170913063528/https://wiki.illumos.org/display/illumos/ZFS+and+Advanced+Format+disks">ZFS and Advanced Format disks</a>.</div>
<h3><span class="mw-headline" id="Identify_disks">Identify disks</span></h3>
<p>OpenZFS recommends using device IDs when creating ZFS storage pools of less than 10 devices<a rel="nofollow" class="external autonumber" href="https://openzfs.github.io/openzfs-docs/Project%20and%20Community/FAQ.html#selecting-dev-names-when-creating-a-pool-linux">[2]</a>. Use <a href="../en/Persistent_block_device_naming.html#by-id_and_by-path" title="Persistent block device naming">Persistent block device naming#by-id and by-path</a> to identify the list of drives to be used for ZFS pool. 
</p>
<p>The disk IDs should look similar to the following:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">$ ls -lh /dev/disk/by-id/</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">lrwxrwxrwx 1 root root  9 Aug 12 16:26 ata-ST3000DM001-9YN166_S1F0JKRR -&gt; ../../sdc
lrwxrwxrwx 1 root root  9 Aug 12 16:26 ata-ST3000DM001-9YN166_S1F0JTM1 -&gt; ../../sde
lrwxrwxrwx 1 root root  9 Aug 12 16:26 ata-ST3000DM001-9YN166_S1F0KBP8 -&gt; ../../sdd
lrwxrwxrwx 1 root root  9 Aug 12 16:26 ata-ST3000DM001-9YN166_S1F0KDGY -&gt; ../../sdb</pre>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> If you create zpools using device names (e.g. <code>/dev/sda</code>,<code>/dev/sdb</code>,...) ZFS might not be able to detect zpools intermittently on boot.</div>
<h4><span class="mw-headline" id="Using_GPT_labels">Using GPT labels</span></h4>
<div class="noprint archwiki-template-message">
<p><span class="mw-default-size" typeof="mw:File"><span><img src="../File:Tango-edit-clear.svg" decoding="async" width="48" height="48" class="mw-file-element"></span></span><b>This article or section needs language, wiki syntax or style improvements. See <a href="../en/Help:Style.html" title="Help:Style">Help:Style</a> for reference.</b></p>
<div>
<b>Reason:</b> Missing references to <a href="../en/Persistent_block_device_naming.html" title="Persistent block device naming">Persistent block device naming</a>, it is useless to explain the differences (or even what they are) here. (Discuss in <a rel="nofollow" class="external text" href="../en/Talk:ZFS.html">Talk:ZFS</a>)</div>
</div>
<p>Disk labels and UUID can also be used for ZFS mounts by using <a href="../en/Partitioning.html#GUID_Partition_Table" class="mw-redirect" title="GUID Partition Table">GPT</a> partitions. ZFS drives have labels but Linux is unable to read them at boot. Unlike <a href="../en/Partitioning.html#Master_Boot_Record" class="mw-redirect" title="Master Boot Record">MBR</a> partitions, GPT partitions directly support both UUID and labels independent of the format inside the partition. Partitioning rather than using the whole disk for ZFS offers two additional advantages. The OS does not generate bogus partition numbers from whatever unpredictable data ZFS has written to the partition sector, and if desired, you can easily over provision SSD drives, and slightly over provision spindle drives to ensure that different models with slightly different sector counts can zpool replace into your mirrors. This is a lot of organization and control over ZFS using readily available tools and techniques at almost zero cost.
</p>
<p>Use <a href="../en/Partitioning.html#GUID_Partition_Table" class="mw-redirect" title="GUID Partition Table">gdisk</a> to partition the all or part of the drive as a single partition. gdisk does not automatically name partitions so if partition labels are desired use gdisk command "c" to label the partitions. Some reasons you might prefer labels over UUID are: labels are easy to control, labels can be titled to make the purpose of each disk in your arrangement readily apparent, and labels are shorter and easier to type. These are all advantages when the server is down and the heat is on. GPT partition labels have plenty of space and can store most international characters <a href="https://en.wikipedia.org/wiki/GUID_Partition_Table#Partition_entries" class="extiw" title="wikipedia:GUID Partition Table">wikipedia:GUID_Partition_Table#Partition_entries</a> allowing large data pools to be labeled in an organized fashion.
</p>
<p>Drives partitioned with GPT have labels and UUID that look like this. 
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">$ ls -l /dev/disk/by-partlabel</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">lrwxrwxrwx 1 root root 10 Apr 30 01:44 zfsdata1 -&gt; ../../sdd1
lrwxrwxrwx 1 root root 10 Apr 30 01:44 zfsdata2 -&gt; ../../sdc1
lrwxrwxrwx 1 root root 10 Apr 30 01:59 zfsl2arc -&gt; ../../sda1</pre>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">$ ls -l /dev/disk/by-partuuid</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">lrwxrwxrwx 1 root root 10 Apr 30 01:44 148c462c-7819-431a-9aba-5bf42bb5a34e -&gt; ../../sdd1
lrwxrwxrwx 1 root root 10 Apr 30 01:59 4f95da30-b2fb-412b-9090-fc349993df56 -&gt; ../../sda1
lrwxrwxrwx 1 root root 10 Apr 30 01:44 e5ccef58-5adf-4094-81a7-3bac846a885f -&gt; ../../sdc1
</pre>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> To minimize typing and copy/paste errors, set a local variable with the target PARTUUID: <code>$ UUID=$(lsblk --noheadings --output PARTUUID /dev/sd<i>XY</i>)</code> </div>
<h3><span class="mw-headline" id="Creating_ZFS_pools">Creating ZFS pools</span></h3>
<p>To create a ZFS pool:
</p>
<pre># zpool create -f -m &lt;mount&gt; &lt;pool&gt; [raidz(2|3)|mirror] &lt;ids&gt;
</pre>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> One may want to read <a href="#Advanced_Format_disks">#Advanced Format disks</a> first as it may be recommend to set <code>ashift</code> on pool creation.</div>
<ul><li>
<b>create</b>: subcommand to create the pool.</li></ul>
<ul>
<li>
<b>-f</b>: Force creating the pool. This is to overcome the "EFI label error". See <a href="#Does_not_contain_an_EFI_label">#Does not contain an EFI label</a>.</li>
<li>
<b>-m</b>: The mount point of the pool. If this is not specified, then the pool will be mounted to <code>/&lt;pool&gt;</code>.</li>
<li>
<b>pool</b>: This is the name of the pool.</li>
<li>
<b>raidz(2|3)|mirror</b>: This is the type of virtual device that will be created from the list of devices. Raidz is a single disk of parity (similar to raid5), raidz2 for 2 disks of parity (similar to raid6) and raidz3 for 3 disks of parity. Also available is <b>mirror</b>, which is similar to raid1 or raid10, but is not constrained to just 2 device. If not specified, each device will be added as a vdev which is similar to raid0. After creation, a device can be added to each single drive vdev to turn it into a mirror, which can be useful for migrating data.</li>
<li>
<b>ids</b>: The <a href="../en/Persistent_block_device_naming.html#by-id_and_by-path" title="Persistent block device naming">ID's</a> of the drives or partitions that to include into the pool.</li>
</ul>
<p>Create pool with single raidz vdev:
</p>
<pre># zpool create -f -m /mnt/data bigdata \
               raidz \
                  ata-ST3000DM001-9YN166_S1F0KDGY \
                  ata-ST3000DM001-9YN166_S1F0JKRR \
                  ata-ST3000DM001-9YN166_S1F0KBP8 \
                  ata-ST3000DM001-9YN166_S1F0JTM1
</pre>
<p>Create pool with two mirror vdevs:
</p>
<pre># zpool create -f -m /mnt/data bigdata \
               mirror \
                  ata-ST3000DM001-9YN166_S1F0KDGY \
                  ata-ST3000DM001-9YN166_S1F0JKRR \
               mirror \
                  ata-ST3000DM001-9YN166_S1F0KBP8 \
                  ata-ST3000DM001-9YN166_S1F0JTM1
</pre>
<h4><span class="mw-headline" id="Advanced_Format_disks">Advanced Format disks</span></h4>
<p>At pool creation, <b>ashift=12</b> should always be used, except with SSDs that have 8k sectors where <b>ashift=13</b> is correct. A vdev of 512 byte disks using 4k sectors will not experience performance issues, but a 4k disk using 512 byte sectors will. Since <b>ashift</b> cannot be changed after pool creation, even a pool with only 512 byte disks should use 4k because those disks may need to be replaced with 4k disks or the pool may be expanded by adding a vdev composed of 4k disks. Because correct detection of 4k disks is not reliable, <code>-o ashift=12</code> should always be specified during pool creation. See the <a rel="nofollow" class="external text" href="https://openzfs.github.io/openzfs-docs/Project%20and%20Community/FAQ.html#advanced-format-disks">OpenZFS FAQ</a> for more details.
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> Use <span class="plainlinks archwiki-template-man" title="$ man 8 blockdev"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/blockdev.8">blockdev(8)</a></span> (part of <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=util-linux">util-linux</a></span>) to print the sector size reported by the device's ioctls: <code>blockdev --getpbsz /dev/sd<i>XY</i></code> as the root user.</div>
<p>Create pool with ashift=12 and single raidz vdev:
</p>
<pre># zpool create -f -o ashift=12 -m /mnt/data bigdata \
               raidz \
                  ata-ST3000DM001-9YN166_S1F0KDGY \
                  ata-ST3000DM001-9YN166_S1F0JKRR \
                  ata-ST3000DM001-9YN166_S1F0KBP8 \
                  ata-ST3000DM001-9YN166_S1F0JTM1
</pre>
<h4><span class="mw-headline" id="GRUB-compatible_pool_creation">GRUB-compatible pool creation</span></h4>
<p>By default, <i>zpool create</i> enables all features on a pool. If <code>/boot</code> resides on ZFS when using <a href="../en/GRUB.html" title="GRUB">GRUB</a> you must only enable features supported by GRUB otherwise GRUB will not be able to read the pool. ZFS includes compatibility files (see <code>/usr/share/zfs/compatibility.d</code>) to assist in creating pools at specific feature sets, of which grub2 is an option.
</p>
<p>You can create a pool with only the compatible features enabled:
</p>
<pre># zpool create -o compatibility=grub2 $POOL_NAME $VDEVS
</pre>
<h3><span class="mw-headline" id="Verifying_pool_status">Verifying pool status</span></h3>
<p>If the command is successful, there will be no output. Using the <a href="../en/File_systems.html#Mount_a_file_system" class="mw-redirect" title="Mount">mount</a> command will show that the pool is mounted. Using <code>zpool status</code> will show that the pool has been created:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># zpool status -v</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">  pool: bigdata
 state: ONLINE
 scan: none requested
config:

        NAME                                       STATE     READ WRITE CKSUM
        bigdata                                    ONLINE       0     0     0
          -0                                       ONLINE       0     0     0
            ata-ST3000DM001-9YN166_S1F0KDGY-part1  ONLINE       0     0     0
            ata-ST3000DM001-9YN166_S1F0JKRR-part1  ONLINE       0     0     0
            ata-ST3000DM001-9YN166_S1F0KBP8-part1  ONLINE       0     0     0
            ata-ST3000DM001-9YN166_S1F0JTM1-part1  ONLINE       0     0     0

errors: No known data errors
</pre>
<p>At this point it would be good to reboot the machine to ensure that the ZFS pool is mounted at boot. It is best to deal with all errors before transferring data.
</p>
<h3><span class="mw-headline" id="Importing_a_pool_created_by_id">Importing a pool created by id</span></h3>
<p>Eventually a pool may fail to auto mount and you need to import to bring your pool back. Take care to avoid the most obvious solution.
</p>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> Do not run <code>zpool import <i>pool</i></code>! This will import your pools using <code>/dev/sd?</code> which will lead to problems the next time you rearrange your drives. This may be as simple as rebooting with a USB drive left in the machine.</div>
<p>Adapt one of the following commands to import your pool so that pool imports retain the persistence they were created with:
</p>
<pre># zpool import -d /dev/disk/by-id bigdata
# zpool import -d /dev/disk/by-partlabel bigdata
# zpool import -d /dev/disk/by-partuuid bigdata
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> Use the <code>-l</code> flag when importing a pool that contains <a href="#Native_encryption">encrypted datasets keys</a>, e.g.:
<pre># zpool import -l -d /dev/disk/by-id bigdata
</pre>
</div>
<p>Finally check the state of the pool:
</p>
<pre># zpool status -v bigdata
</pre>
<h3><span class="mw-headline" id="Destroy_a_storage_pool">Destroy a storage pool</span></h3>
<p>ZFS makes it easy to destroy a mounted storage pool, removing all metadata about the ZFS device.
</p>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> This command destroys <b>any data</b> containing in the pool and/or dataset.</div>
<p>To destroy the pool:
</p>
<pre># zpool destroy &lt;pool&gt;
</pre>
<p>To destroy a dataset:
</p>
<pre># zfs destroy &lt;pool&gt;/&lt;dataset&gt;
</pre>
<p>And now when checking the status:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># zpool status</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">no pools available
</pre>
<h3><span class="mw-headline" id="Exporting_a_storage_pool">Exporting a storage pool</span></h3>
<p>If a storage pool is to be used on another system, it will first need to be exported. It is also necessary to export a pool if it has been imported from the archiso as the hostid is different in the archiso as it is in the booted system. The zpool command will refuse to import any storage pools that have not been exported. It is possible to force the import with the <code>-f</code> argument, but this is considered bad form.
</p>
<p>Any attempts made to import an un-exported storage pool will result in an error stating the storage pool is in use by another system. This error can be produced at boot time abruptly abandoning the system in the busybox console and requiring an archiso to do an emergency repair by either exporting the pool, or adding the <code>zfs_force=1</code> to the kernel boot parameters (which is not ideal). See <a href='#On_boot_the_zfs_pool_does_not_mount_stating:_"pool_may_be_in_use_from_other_system"'>#On boot the zfs pool does not mount stating: "pool may be in use from other system"</a>.
</p>
<p>To export a pool:
</p>
<pre># zpool export &lt;pool&gt;
</pre>
<h3><span class="mw-headline" id="Extending_an_existing_zpool">Extending an existing zpool</span></h3>
<p>A device (a partition or a disk) can be added to an existing zpool:
</p>
<pre># zpool add &lt;pool&gt; &lt;device-id&gt;
</pre>
<p>To import a pool which consists of multiple devices:
</p>
<pre># zpool import -d &lt;device-id-1&gt; -d &lt;device-id-2&gt; &lt;pool&gt;
</pre>
<p>or simply:
</p>
<pre># zpool import -d /dev/disk-by-id/ &lt;pool&gt;
</pre>
<h3>
<span id="Attaching_a_device_to_.28create.29_a_mirror"></span><span class="mw-headline" id="Attaching_a_device_to_(create)_a_mirror">Attaching a device to (create) a mirror</span>
</h3>
<p>A device (a partition or a disk) can be attached aside an existing device to be its mirror (similar to RAID 1):
</p>
<pre># zpool attach &lt;pool&gt; &lt;device-id|mirror&gt; &lt;new-device-id&gt;
</pre>
<p>You can attach the new device to an already existing mirror vdev (e.g. to upgrade from a 2-device to a 3-device mirror) or <a rel="nofollow" class="external text" href="https://askubuntu.com/a/1303462">attach it to single device to create a new mirror vdev</a>.
</p>
<h3><span class="mw-headline" id="Renaming_a_zpool">Renaming a zpool</span></h3>
<p>Renaming a zpool that is already created is accomplished in 2 steps:
</p>
<pre># zpool export oldname
# zpool import oldname newname
</pre>
<h3><span class="mw-headline" id="Setting_a_different_mount_point">Setting a different mount point</span></h3>
<p>The mount point for a given zpool can be moved at will with one command:
</p>
<pre># zfs set mountpoint=/foo/bar poolname
</pre>
<h3><span class="mw-headline" id="Upgrade_zpools">Upgrade zpools</span></h3>
<p>When using a newer <code>zfs</code> module, zpools may display an upgrade indication:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">$ zpool status -v</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">pool: bigdata
state: ONLINE
status: Some supported features are not enabled on the pool. The pool can still be used, but some features are unavailable.
action: Enable all features using 'zpool upgrade'. Once this is done, the pool may no longer be accessible by software that does not support the features. See zpool-features(5) for details.</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> 
<ul>
<li>Lower version <code>zfs</code> modules will not be able to import a zpool of a higher version.</li>
<li>When dealing with important data, one may want to create a <a href="../en/System_maintenance.html#Backup" class="mw-redirect" title="Backup">backup</a> prior running a <code>zpool upgrade</code>.</li>
</ul>
</div>
<p>To upgrade the version of zpool <i>bigdata</i>:
</p>
<pre># zpool upgrade bigdata
</pre>
<p>To upgrade the version of all zpools:
</p>
<pre># zpool upgrade -a
</pre>
<h2><span class="mw-headline" id="Creating_datasets">Creating datasets</span></h2>
<p>Users can optionally create a dataset under the zpool as opposed to manually creating directories under the zpool. Datasets allow for an increased level of control (quotas for example) in addition to snapshots. To be able to create and mount a dataset, a directory of the same name must not pre-exist in the zpool. To create a dataset, use:
</p>
<pre># zfs create &lt;nameofzpool&gt;/&lt;nameofdataset&gt;
</pre>
<p>It is then possible to apply ZFS specific attributes to the dataset. For example, one could assign a quota limit to a specific directory within a dataset:
</p>
<pre># zfs set quota=20G &lt;nameofzpool&gt;/&lt;nameofdataset&gt;/&lt;directory&gt;
</pre>
<p>To see all the commands available in ZFS, see <span class="plainlinks archwiki-template-man" title="$ man 8 zfs">zfs(8)</span> or <span class="plainlinks archwiki-template-man" title="$ man 8 zpool">zpool(8)</span>.
</p>
<h3><span class="mw-headline" id="Native_encryption">Native encryption</span></h3>
<p>ZFS offers the following supported encryption options: <code>aes-128-ccm</code>, <code>aes-192-ccm</code>, <code>aes-256-ccm</code>, <code>aes-128-gcm</code>, <code>aes-192-gcm</code> and <code>aes-256-gcm</code>. When encryption is set to <code>on</code>, <code>aes-256-gcm</code> will be used. See <a rel="nofollow" class="external text" href="https://openzfs.github.io/openzfs-docs/man/8/zfs-change-key.8.html#Encryption">zfs-change-key(8)</a> for a description of the native encryption, including limitations.
</p>
<p>The following keyformats are supported: <code>passphrase</code>, <code>raw</code>, <code>hex</code>.
</p>
<p>One can also specify/increase the default iterations of PBKDF2 when using <code>passphrase</code> with <code>-o pbkdf2iters &lt;n&gt;</code>, although it may increase the decryption time.
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> 
<ul>
<li>To import a pool with keys, one needs to specify the <code>-l</code> flag, without this flag encrypted datasets will be left unavailable until the keys are loaded. See <a href="#Importing_a_pool_created_by_id">#Importing a pool created by id</a>.</li>
<li>Native ZFS encryption has been made available in the stable 0.8.0 release or newer. Previously it was only available in development versions provided by packages like <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/zfs-linux-git/">zfs-linux-git</a></span><sup><small>AUR</small></sup>, <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/zfs-dkms-git/">zfs-dkms-git</a></span><sup><small>AUR</small></sup> or other development builds. Users who were only using the development versions for the native encryption, may now switch to the stable releases if they wish.</li>
<li>The default encryption suite was changed from <code>aes-256-ccm</code> to <code>aes-256-gcm</code> in the 0.8.4 release.</li>
</ul>
</div>
<p>To create a dataset including native encryption with a passphrase, use:
</p>
<pre># zfs create -o encryption=on -o keyformat=passphrase &lt;nameofzpool&gt;/&lt;nameofdataset&gt;
</pre>
<p>To use a key instead of using a passphrase:
</p>
<pre># dd if=/dev/random of=/path/to/key bs=1 count=32
# zfs create -o encryption=on -o keyformat=raw -o keylocation=file:///path/to/key &lt;nameofzpool&gt;/&lt;nameofdataset&gt;
</pre>
<p>The easy way to make a key in human-readable form (<code>keyformat=hex</code>):
</p>
<pre># od -Anone -x -N 32 -w64 /dev/random | tr -d [:blank:] &gt; /path/to/hex.key
</pre>
<p>To verify the key location:
</p>
<pre># zfs get keylocation &lt;nameofzpool&gt;/&lt;nameofdataset&gt;
</pre>
<p>To change the key location:
</p>
<pre># zfs set keylocation=file:///path/to/key &lt;nameofzpool&gt;/&lt;nameofdataset&gt;
</pre>
<p>You can also manually load the keys by using one of the following commands:
</p>
<pre># zfs load-key &lt;nameofzpool&gt;/&lt;nameofdataset&gt; # load key for a specific dataset
# zfs load-key -a # load all keys
# zfs load-key -r zpool/dataset # load all keys in a dataset
</pre>
<p>To mount the created encrypted dataset:
</p>
<pre># zfs mount &lt;nameofzpool&gt;/&lt;nameofdataset&gt;
</pre>
<h4>
<span id="Unlock.2FMount_at_boot_time:_systemd"></span><span class="mw-headline" id="Unlock/Mount_at_boot_time:_systemd">Unlock/Mount at boot time: systemd</span>
</h4>
<p>It is possible to automatically unlock a pool dataset on boot time by using a <a href="../en/Systemd.html" title="Systemd">systemd</a> unit. For example create the following service to unlock any specific dataset: 
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/zfs-load-key@.service</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Unit]
Description=Load %I encryption keys
Before=systemd-user-sessions.service zfs-mount.service
After=zfs-import.target
Requires=zfs-import.target
DefaultDependencies=no

[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/usr/bin/bash -c 'until (systemd-ask-password "Encrypted ZFS password for %I" --no-tty | zfs load-key %I); do echo "Try again!"; done'

[Install]
WantedBy=zfs-mount.service
</pre>
<p><a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Enable/start">Enable/start</a> the service for each encrypted dataset, (e.g. <code>zfs-load-key@pool0-dataset0.service</code>). Note the use of <code>-</code>, which is an escaped <code>/</code> in systemd unit definitions. See <code>systemd-escape(1)</code> for more info.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> The <code>Before=systemd-user-sessions.service</code> ensures that systemd-ask-password is invoked before the local IO devices are handed over to the <a href="../en/Desktop_environment.html" title="Desktop environment">desktop environment</a>.</div>
<p>An alternative is to load all possible keys:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/zfs-load-key.service</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Unit]
Description=Load encryption keys
DefaultDependencies=no
After=zfs-import.target
Before=zfs-mount.service

[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/usr/bin/zfs load-key -a
StandardInput=tty-force

[Install]
WantedBy=zfs-mount.service</pre>
<p><a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Enable/start">Enable/start</a> <code>zfs-load-key.service</code>.
</p>
<h4><span class="mw-headline" id="Unlock_at_login_time:_PAM">Unlock at login time: PAM</span></h4>
<p>If you are not encrypting the root volume, but only the home volume or a user-specific volume, another idea is to <a rel="nofollow" class="external text" href="https://blog.trifork.com/2020/05/22/linux-homedir-encryption/">wait until login to decrypt it</a>.  The advantages of this method are that the system boots uninterrupted, and that when the user logs in, the same password can be used both to authenticate and to decrypt the home volume, so that the password is only entered once.
</p>
<p>First set the mountpoint to legacy to avoid having it mounted by <code>zfs mount -a</code>:
</p>
<pre>zfs set mountpoint=legacy zroot/data/home</pre>
<p>Ensure that it is in /etc/fstab so that <code>mount /home</code> will work:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/fstab</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">zroot/data/home         /home           zfs             rw,xattr,posixacl,noauto        0 0</pre>
<p>On a single-user system, with only one <code>/home</code> volume having the same encryption password as the user's password, it can be decrypted at login as follows: first create <code>/usr/local/bin/mount-zfs-homedir</code>
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/usr/local/bin/mount-zfs-homedir</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">#!/bin/bash

# simplified from <a rel="nofollow" class="external free" href="https://talldanestale.dk/2020/04/06/zfs-and-homedir-encryption/">https://talldanestale.dk/2020/04/06/zfs-and-homedir-encryption/</a>

set -eu

# Password is given to us via stdin, save it in a variable for later
PASS=$(cat -)

VOLNAME="zroot/data/home"

# Unlock and mount the volume
zfs load-key "$VOLNAME" &lt;&lt;&lt; "$PASS" || continue
zfs mount "$VOLNAME" || true # ignore errors</pre>
<p>do not forget <code>chmod a+x /usr/local/bin/mount-zfs-homedir</code>; then get PAM to run it by adding the following line to /etc/pam.d/system-auth:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/pam.d/system-auth</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">auth       optional                    pam_exec.so          expose_authtok /usr/local/bin/mount-zfs-homedir
</pre>
<p>Now it will transparently decrypt and mount the /home volume when you log in anywhere: on the console, via ssh, etc.  A caveat is that since your <code>~/.ssh</code> directory is not mounted, if you log in via ssh, you must use the default password authentication the first time rather than relying on <code>~/.ssh/authorized_keys</code>.
</p>
<p>If you want to have separate volumes for each user, each encrypted with the user's password, try the <a rel="nofollow" class="external text" href="https://blog.trifork.com/2020/05/22/linux-homedir-encryption/">linked method</a>.
</p>
<h3><span class="mw-headline" id="Swap_volume">Swap volume</span></h3>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> 
<ul>
<li>On systems with extremely high memory pressure, using a zvol for swap can result in lockup, regardless of how much swap is still available. This issue is currently being investigated in <a rel="nofollow" class="external text" href="https://github.com/openzfs/zfs/issues/7734">OpenZFS issue #7734</a>
</li>
<li>Swap on zvol does not support resume from hibernation, attempt to resume will result in pool corruption. Possible workaround: <a rel="nofollow" class="external free" href="https://github.com/openzfs/zfs/issues/260#issuecomment-758782144">https://github.com/openzfs/zfs/issues/260#issuecomment-758782144</a>
</li>
</ul>
</div>
<p>ZFS does not allow to use swapfiles, but users can use a ZFS volume (ZVOL) as swap. It is important to set the ZVOL block size to match the system page size, which can be obtained by the <code>getconf PAGESIZE</code> command (default on x86_64 is 4KiB). Another option useful for keeping the system running well in low-memory situations is not caching the ZVOL data.
</p>
<p>Create a 8 GiB zfs volume:
</p>
<pre># zfs create -V 8G -b $(getconf PAGESIZE) -o compression=zle \
              -o logbias=throughput -o sync=always\
              -o primarycache=metadata -o secondarycache=none \
              -o com.sun:auto-snapshot=false &lt;pool&gt;/swap
</pre>
<p>Prepare it as swap partition:
</p>
<pre># mkswap -f /dev/zvol/&lt;pool&gt;/swap
# swapon /dev/zvol/&lt;pool&gt;/swap
</pre>
<p>To make it permanent, edit <code>/etc/fstab</code>. ZVOLs support discard, which can potentially help ZFS's block allocator and reduce fragmentation for all other datasets when/if swap is not full.
</p>
<p>Add a line to <code>/etc/fstab</code>:
</p>
<pre>/dev/zvol/&lt;pool&gt;/swap none swap discard 0 0
</pre>
<h3><span class="mw-headline" id="Access_Control_Lists">Access Control Lists</span></h3>
<p>To use <a href="../en/Access_Control_Lists.html" class="mw-redirect" title="ACL">ACL</a> on a dataset:
</p>
<pre># zfs set acltype=posixacl &lt;nameofzpool&gt;/&lt;nameofdataset&gt;
# zfs set xattr=sa &lt;nameofzpool&gt;/&lt;nameofdataset&gt;
</pre>
<p>Setting <code>xattr</code> is recommended for performance reasons <a rel="nofollow" class="external autonumber" href="https://github.com/openzfs/zfs/issues/170#issuecomment-27348094">[3]</a>.
</p>
<p>It may be preferable to enable ACL on the zpool as datasets will inherit the ACL parameters. Setting <code>aclinherit=passthrough</code> may be wanted as the default mode is <code>restricted</code> <a rel="nofollow" class="external autonumber" href="https://docs.oracle.com/cd/E19120-01/open.solaris/817-2271/gbaaz/index.html">[4]</a>; however, it is worth noting that <code>aclinherit</code> does not affect POSIX ACLs <a rel="nofollow" class="external autonumber" href="https://askubuntu.com/questions/342553/activate-acl-for-zfs-pool-ubuntu-13-04#comment1220577_392008">[5]</a>:
</p>
<pre># zfs set aclinherit=passthrough &lt;nameofzpool&gt;
# zfs set acltype=posixacl &lt;nameofzpool&gt;
# zfs set xattr=sa &lt;nameofzpool&gt;
</pre>
<h3><span class="mw-headline" id="Databases">Databases</span></h3>
<p>ZFS, unlike most other file systems, has a variable record size, or what is commonly referred to as a block size. By default, the recordsize on ZFS is 128KiB, which means it will dynamically allocate blocks of any size from 512B to 128KiB depending on the size of file being written. This can often help fragmentation and file access, at the cost that ZFS would have to allocate new 128KiB blocks each time only a few bytes are written to.
</p>
<div class="noprint archwiki-template-message">
<p><span class="mw-default-size" typeof="mw:File"><span><img src="../File:Inaccurate.svg" decoding="async" width="48" height="48" class="mw-file-element"></span></span><b>The factual accuracy of this article or section is disputed.</b></p>
<div>
<b>Reason:</b> At least MariaDB uses a default of 16Kib pages! Check your specific DBMS before setting this value. (Discuss in <a rel="nofollow" class="external text" href="../en/Talk:ZFS.html">Talk:ZFS</a>)</div>
</div>
<p>Most RDBMSes work in 8KiB-sized blocks by default. Although the block size is tunable for <a href="../en/MySQL.html" title="MySQL">MySQL/MariaDB</a>, <a href="../en/PostgreSQL.html" title="PostgreSQL">PostgreSQL</a>, and Oracle database, all three of them use an 8KiB block size <i>by default</i>. For both performance concerns and keeping snapshot differences to a minimum (for backup purposes, this is helpful), it is usually desirable to tune ZFS instead to accommodate the databases, using a command such as:
</p>
<pre># zfs set recordsize=8K &lt;pool&gt;/postgres
</pre>
<p>These RDBMSes also tend to implement their own caching algorithm, often similar to ZFS's own ARC. In the interest of saving memory, it is best to simply disable ZFS's caching of the database's file data and let the database do its own job:
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> <a href="#L2ARC">L2ARC</a> requires <code>primarycache</code> to function, because it is fed with data evicted from <code>primarycache</code>. If you intend to use the L2ARC, do not set the option below, otherwise no actual data will be cached on L2ARC.</div>
<pre># zfs set primarycache=metadata &lt;pool&gt;/postgres
</pre>
<p>ZFS uses the <a href="#ZIL">ZIL</a> for crash recovery, but databases are often syncing their data files to the file system on their own transaction commits anyway. The end result of this is that ZFS will be committing data <b>twice</b> to the data disks, and it can severely impact performance. You can tell ZFS to prefer to not use the ZIL, and in which case, data is only committed to the file system once. However, doing so on non-solid state storage (e.g. HDDs) can result in decreased read performance due to fragmentation (<a rel="nofollow" class="external text" href="https://openzfs.org/wiki/ZFS_on_high_latency_devices">OpenZFS Wiki</a>) -- with mechanical hard drives, please consider using a dedicated SSD as <a href="#ZIL">ZIL</a> rather than setting the option below. In addition, setting this for non-database file systems, or for pools with configured log devices, can also <i>negatively</i> impact the performance, so beware:
</p>
<pre># zfs set logbias=throughput &lt;pool&gt;/postgres
</pre>
<p>These can also be done at file system creation time, for example:
</p>
<pre># zfs create -o recordsize=8K \
             -o primarycache=metadata \
             -o mountpoint=/var/lib/postgres \
             -o logbias=throughput \
              &lt;pool&gt;/postgres
</pre>
<p>Please note: these kinds of tuning parameters are ideal for specialized applications like RDBMSes. You can easily <i>hurt</i> ZFS's performance by setting these on a general-purpose file system such as your /home directory.
</p>
<h3>
<span id=".2Ftmp"></span><span class="mw-headline" id="/tmp">/tmp</span>
</h3>
<p>If you would like to use ZFS to store your /tmp directory, which may be useful for storing arbitrarily-large sets of files or simply keeping your RAM free of idle data, you can generally improve performance of certain applications writing to /tmp by disabling file system sync. This causes ZFS to ignore an application's sync requests (eg, with <code>fsync</code> or <code>O_SYNC</code>) and return immediately. While this has severe application-side data consistency consequences (never disable sync for a database!), files in /tmp are less likely to be important and affected. Please note this does <i>not</i> affect the integrity of ZFS itself, only the possibility that data an application expects on-disk may not have actually been written out following a crash.
</p>
<pre># zfs set sync=disabled &lt;pool&gt;/tmp
</pre>
<p>Additionally, for security purposes, you may want to disable <b>setuid</b> and <b>devices</b> on the /tmp file system, which prevents some kinds of privilege-escalation attacks or the use of device nodes:
</p>
<pre># zfs set setuid=off &lt;pool&gt;/tmp
# zfs set devices=off &lt;pool&gt;/tmp
</pre>
<p>Combining all of these for a create command would be as follows:
</p>
<pre># zfs create -o setuid=off -o devices=off -o sync=disabled -o mountpoint=/tmp &lt;pool&gt;/tmp
</pre>
<p>Please note, also, that if you want /tmp on ZFS, you will need to <a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Mask">mask</a> (disable) <a href="../en/Systemd.html" title="Systemd">systemd</a>'s automatic tmpfs-backed /tmp (<code>tmp.mount</code>, else ZFS will be unable to mount your dataset at boot-time or import-time.
</p>
<h3><span class="mw-headline" id="Transmitting_snapshots_with_ZFS_Send_and_ZFS_Recv">Transmitting snapshots with ZFS Send and ZFS Recv</span></h3>
<p>It is possible to pipe ZFS snapshots to an arbitrary target by pairing <code>zfs send</code> and <code>zfs recv</code>. This is done through standard output, which allows the data to be sent to any file, device, across the network, or manipulated mid-stream by incorporating additional programs in the pipe. 
</p>
<p>Below are examples of common scenarios:
</p>
<h4><span class="mw-headline" id="Basic_ZFS_Send">Basic ZFS Send</span></h4>
<p>First, let's create a snapshot of some ZFS filesystem:
</p>
<pre># zfs snapshot zpool0/archive/books@snap
</pre>
<p>Now let's send the snapshot to a new location on a different zpool 
</p>
<pre># zfs send -v zpool0/archive/books@snap | zfs recv zpool4/library
</pre>
<p>The contents of <code>zpool0/archive/books@snap</code> are now live at <code>zpool4/library</code>
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong>  See <a rel="nofollow" class="external text" href="https://openzfs.github.io/openzfs-docs/man/8/zfs-send.8.html">man zfs-send</a> and <a rel="nofollow" class="external text" href="https://openzfs.github.io/openzfs-docs/man/8/zfs-recv.8.html">man zfs-recv</a> for details on flags.</div>
<h5><span class="mw-headline" id="To_and_from_files">To and from files</span></h5>
<p>First, let's create a snapshot of some ZFS filesystem:
</p>
<pre># zfs snapshot zpool0/archive/books@snap
</pre>
<p>Write the snapshot to a gzip file:
</p>
<pre># zfs send zpool0/archive/books@snap &gt; /tmp/mybooks.gz
</pre>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong>  Make sure to run <code>zfs send</code> with <code>-w</code> flag if you wish to preserve encryption during the send.</div>
<p>Now restore the snapshot from the file:
</p>
<pre># gzcat /tmp/mybooks.gz | zfs recv -F zpool0/archive/books
</pre>
<h4><span class="mw-headline" id="Send_over_ssh">Send over ssh</span></h4>
<p>First, let's create a snapshot of some ZFS filesystem:
</p>
<pre># zfs snapshot zpool1/filestore@snap
</pre>
<p>Next we pipe our "send" traffic over an ssh session running "recv":
</p>
<pre># zfs send -v zpool1/filestore@snap | ssh $HOST zfs recv coldstore/backups
</pre>
<p>The <code>-v</code> flag prints information about the datastream being generated. If you are using a passphrase or passkey, you will be prompted to enter it.
</p>
<h4><span class="mw-headline" id="Incremental_Backups">Incremental Backups</span></h4>
<p>You may wish update a previously sent ZFS filesystem without retransmitting all of the data over again. 
Alternatively, it may be necessary to keep a filesystem online during a lengthy transfer and it is now time to send writes that were made since the initial snapshot.
</p>
<p>First, let's create a snapshot of some ZFS filesystem:
</p>
<pre># zfs snapshot zpool1/filestore@initial
</pre>
<p>Next we pipe our "send" traffic over an ssh session running "recv":
</p>
<pre># zfs send -v -R zpool1/filestore@initial | ssh $HOST zfs recv coldstore/backups
</pre>
<p>Once changes are written, make another snapshot:
</p>
<pre># zfs snapshot zpool1/filestore@snap2
</pre>
<p>The following will send the differences that exist locally between zpool1/filestore@initial and zpool1/filestore@snap2 and create an additional snapshot for the remote filesystem coldstore/backups:
</p>
<pre># zfs send -v -i -R zpool1/filestore@initial | ssh $HOST zfs recv coldstore/backups
</pre>
<p>Now both zpool1/filestore and coldstore/backups have the @initial and @snap2 snapshots.
</p>
<p>On the remote host, you may now promote the latest snapshot to become the active filesystem:
</p>
<pre># rollback coldstore/backups@snap2
</pre>
<h2><span class="mw-headline" id="Tuning">Tuning</span></h2>
<h3><span class="mw-headline" id="General">General</span></h3>
<p>ZFS pools and datasets can be further adjusted using parameters.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> All settable properties, with the exception of quotas and reservations, inherit their value from the parent dataset.</div>
<p>To retrieve the current pool parameter status:
</p>
<pre># zfs get all &lt;pool&gt;
</pre>
<p>To retrieve the current dataset parameter status:
</p>
<pre># zfs get all &lt;pool&gt;/&lt;dataset&gt;
</pre>
<p>To disable access time (atime), which is enabled by default:
</p>
<pre># zfs set atime=off &lt;pool&gt;
</pre>
<p>To disable access time (atime) on a particular dataset:
</p>
<pre># zfs set atime=off &lt;pool&gt;/&lt;dataset&gt;
</pre>
<p>An alternative to turning off atime completely, <code>relatime</code> is available. This brings the default ext4/XFS atime semantics to ZFS, where access time is only updated if the modified time or changed time changes, or if the existing access time has not been updated within the past 24 hours. It is a compromise between <code>atime=off</code> and <code>atime=on</code>. This property <i>only</i> takes effect if <code>atime</code> is <code>on</code>:
</p>
<pre># zfs set atime=on &lt;pool&gt;
# zfs set relatime=on &lt;pool&gt;
</pre>
<p>Compression is just that, transparent compression of data. ZFS supports a few different algorithms, presently lz4 is the default, <i>gzip</i> is also available for seldom-written yet highly-compressible data; consult the <a rel="nofollow" class="external text" href="https://openzfs.github.io/openzfs-docs/Performance%20and%20Tuning/Workload%20Tuning.html">OpenZFS Wiki</a> for more details.
</p>
<p>To enable compression:
</p>
<pre># zfs set compression=on &lt;pool&gt;
</pre>
<p>To reset a property of a pool and/or dataset to its default state, use <code>zfs inherit</code>:
</p>
<pre># zfs inherit -rS atime &lt;pool&gt;
# zfs inherit -rS atime &lt;pool&gt;/&lt;dataset&gt;
</pre>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> Using the <code>-r</code> flag will recursively reset all datasets of the zpool.</div>
<h3><span class="mw-headline" id="Scrubbing">Scrubbing</span></h3>
<p>Whenever data is read and ZFS encounters an error, it is silently repaired when possible, rewritten back to disk and logged so you can obtain an overview of errors on your pools. There is no fsck or equivalent tool for ZFS. Instead, ZFS supports a feature known as scrubbing. This traverses through all the data in a pool and verifies that all blocks can be read.
</p>
<p>To scrub a pool:
</p>
<pre># zpool scrub &lt;pool&gt;
</pre>
<p>To cancel a running scrub:
</p>
<pre># zpool scrub -s &lt;pool&gt;
</pre>
<h4>
<span id="How_often_should_I_do_this.3F"></span><span class="mw-headline" id="How_often_should_I_do_this?">How often should I do this?</span>
</h4>
<p>From the Oracle blog post <a rel="nofollow" class="external text" href="https://blogs.oracle.com/wonders-of-zfs-storage/disk-scrub-why-and-when-v2">Disk Scrub - Why and When?</a>:
</p>
<dl><dd>This question is challenging for Support to answer, because as always the true answer is "It Depends". So before I offer a general guideline, here are a few tips to help you create an answer more tailored to your use pattern.</dd></dl>
<dl><dd><ul>
<li>What is the expiration of your oldest backup? You should probably scrub your data at least as often as your oldest tapes expire so that you have a known-good restore point.</li>
<li>How often are you experiencing disk failures? While the recruitment of a hot-spare disk invokes a "resilver" -- a targeted scrub of just the VDEV which lost a disk -- you should probably scrub at least as often as you experience disk failures on average in your specific environment.</li>
<li>How often is the oldest piece of data on your disk read? You should scrub occasionally to prevent very old, very stale data from experiencing bit-rot and dying without you knowing it.</li>
</ul></dd></dl>
<dl><dd>If any of your answers to the above are "I do not know", the general guideline is: you should probably be scrubbing your zpool at least once per month. It is a schedule that works well for most use cases, provides enough time for scrubs to complete before starting up again on all but the busiest &amp; most heavily-loaded systems, and even on very large zpools (192+ disks) should complete fairly often between disk failures.</dd></dl>
<p>In the <a rel="nofollow" class="external text" href="https://pthree.org/2012/12/11/zfs-administration-part-vi-scrub-and-resilver/">ZFS Administration Guide</a> by Aaron Toponce, he advises to scrub consumer disks once a week.
</p>
<h4><span class="mw-headline" id="Start_with_a_service_or_timer">Start with a service or timer</span></h4>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> Starting with OpenZFS 2.1.3 weekly and monthly <a href="../en/Systemd.html" title="Systemd">systemd</a> timers/services are included. To use these <a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Enable">enable</a>/<a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Start">start</a> <code>zfs-scrub-weekly@<i>pool-to-scrub</i>.timer</code> or <code>zfs-scrub-monthly@<i>pool-to-scrub</i>.timer</code> for the desired pool.</div>
<p>Using a <a href="../en/Systemd.html" title="Systemd">systemd</a> timer/service it is possible to automatically scrub pools.
</p>
<p>To perform scrubbing monthly on a particular pool:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/zfs-scrub@.timer</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Unit]
Description=Monthly zpool scrub on %i

[Timer]
OnCalendar=monthly
AccuracySec=1h
Persistent=true

[Install]
WantedBy=multi-user.target</pre>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/zfs-scrub@.service</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Unit]
Description=zpool scrub on %i

[Service]
Nice=19
IOSchedulingClass=idle
KillSignal=SIGINT
ExecStart=/usr/bin/zpool scrub %i

[Install]
WantedBy=multi-user.target</pre>
<p><a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Enable">Enable</a>/<a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Start">start</a> <code>zfs-scrub@<i>pool-to-scrub</i>.timer</code> unit for monthly scrubbing the specified zpool.
</p>
<h3><span class="mw-headline" id="Enabling_TRIM">Enabling TRIM</span></h3>
<p>To quickly query your vdevs <a href="../en/Solid_state_drive.html#TRIM" class="mw-redirect" title="TRIM">TRIM</a> support, you can include trimming information in <code>zpool status</code> with <code>-t</code>. 
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">$ zpool status -t tank</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">pool: tank
 state: ONLINE
  scan: none requested
 config:

	NAME                                     STATE     READ WRITE CKSUM
	tank                                     ONLINE       0     0     0
	  ata-ST31000524AS_5RP4SSNR-part1        ONLINE       0     0     0  (trim unsupported)
	  ata-CT480BX500SSD1_2134A59B933D-part1  ONLINE       0     0     0  (untrimmed)

errors: No known data errors</pre>
<p>ZFS is capable of trimming supported vdevs either on-demand or periodically via the <code>autotrim</code> property.
</p>
<p>Manually performing a TRIM operation on a zpool:
</p>
<pre> # zpool trim &lt;zpool&gt;
</pre>
<p>Enabling periodic trimming on all supported vdevs in a pool:
</p>
<pre> # zpool set autotrim=on &lt;zpool&gt;
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> Because of how the automatic TRIM and a full <code>zpool trim</code> differ in their operation, <a rel="nofollow" class="external text" href="https://github.com/openzfs/zfs/commit/1b939560be5c51deecf875af9dada9d094633bf7">it can make sense to run a manual trim occasionally.</a> </div>
<p>To perform a full <code>zpool trim</code> monthly on a particular pool using a <a href="../en/Systemd.html" title="Systemd">systemd</a> timer/service:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/zfs-trim@.timer</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Unit]
Description=Monthly zpool trim on %i

[Timer]
OnCalendar=monthly
AccuracySec=1h
Persistent=true

[Install]
WantedBy=multi-user.target</pre>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/zfs-trim@.service</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Unit]
Description=zpool trim on %i
Documentation=man:zpool-trim(8)
Requires=zfs.target
After=zfs.target
ConditionACPower=true
ConditionPathIsDirectory=/sys/module/zfs

[Service]
Nice=19
IOSchedulingClass=idle
KillSignal=SIGINT
ExecStart=/bin/sh -c '\
if /usr/bin/zpool status %i | grep "trimming"; then\
exec /usr/bin/zpool wait -t trim %i;\
else exec /usr/bin/zpool trim -w %i; fi'
ExecStop=-/bin/sh -c '/usr/bin/zpool trim -s %i 2&gt;/dev/null || true'

[Install]
WantedBy=multi-user.target</pre>
<p><a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Enable">Enable</a>/<a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Start">start</a> <code>zfs-trim@<i>pool-to-trim</i>.timer</code> unit for monthly trimming of the specified zpool.
</p>
<h3><span class="mw-headline" id="SSD_Caching">SSD Caching</span></h3>
<p>If your pool has no configured log devices, ZFS reserves space on the pool's data disks for its intent log (the ZIL, also called SLOG). If your data disks are slow (e.g. HDD) it is highly recommended to configure the ZIL on solid state drives for better write performance and also to consider a layer 2 adaptive replacement cache (L2ARC). The process to add them is very similar to adding a new VDEV.
</p>
<p>All of the below references to device-id are the IDs from <code>/dev/disk/by-id/*</code>.
</p>
<h4><span class="mw-headline" id="ZIL">ZIL</span></h4>
<p>To add a mirrored ZIL:
</p>
<pre> # zpool add &lt;pool&gt; log mirror &lt;device-id-1&gt; &lt;device-id-2&gt;
</pre>
<p>Or to add a single device ZIL (unsafe):
</p>
<pre> # zpool add &lt;pool&gt; log &lt;device-id&gt;
</pre>
<p>Because the ZIL device stores data that has not been written to the pool, it is important to use devices that can finish writes when power is lost. It is also important to use redundancy, since a device failure can cause data loss. In addition, the ZIL is only used for sync writes, so may not provide any performance improvement when your data drives are as fast as your ZIL drive(s).
</p>
<h4><span class="mw-headline" id="L2ARC">L2ARC</span></h4>
<p>To add L2ARC:
</p>
<pre># zpool add &lt;pool&gt; cache &lt;device-id&gt;
</pre>
<p>L2ARC is only a read cache, so redundancy is unnecessary. Since <a rel="nofollow" class="external text" href="https://github.com/openzfs/zfs/releases/tag/zfs-2.0.0">ZFS version 2.0.0</a>, L2ARC is persisted across reboots.<a rel="nofollow" class="external autonumber" href="https://github.com/openzfs/zfs/pull/9582">[6]</a>
</p>
<p>L2ARC is generally only useful in workloads where the amount of hot data is <b>bigger</b> than system memory, but small enough to fit into L2ARC. The L2ARC is indexed by the ARC in system memory, consuming 70 bytes per record (default 128KiB). Thus, the equation for RAM usage is:
</p>
<pre>(L2ARC size) / (recordsize) * 70 bytes
</pre>
<p>Because of this, L2ARC can, in certain workloads, harm performance as it takes memory away from ARC.
</p>
<h3><span class="mw-headline" id="ZVOLs">ZVOLs</span></h3>
<p>ZFS volumes (ZVOLs) can suffer from the same block size-related issues as RDBMSes, but it is worth noting that the default recordsize for ZVOLs is 8 KiB already. If possible, it is best to align any partitions contained in a ZVOL to your recordsize (current versions of fdisk and gdisk by default automatically align at 1MiB segments, which works), and file system block sizes to the same size. Other than this, you might tweak the <b>recordsize</b> to accommodate the data inside the ZVOL as necessary (though 8 KiB tends to be a good value for most file systems, even when using 4 KiB blocks on that level).
</p>
<h4><span class="mw-headline" id="RAIDZ_and_Advanced_Format_physical_disks">RAIDZ and Advanced Format physical disks</span></h4>
<p>Each block of a ZVOL gets its own parity disks, and if you have physical media with logical block sizes of 4096B, 8192B, or so on, the parity needs to be stored in whole physical blocks, and this can drastically increase the space requirements of a ZVOL, requiring 2× or more physical storage capacity than the ZVOL's logical capacity. Setting the <b>recordsize</b> to 16k or 32k can help reduce this footprint drastically.
</p>
<p>See <a rel="nofollow" class="external text" href="https://github.com/openzfs/zfs/issues/1807">OpenZFS issue #1807</a> for details.
</p>
<h3>
<span id="I.2FO_Scheduler"></span><span class="mw-headline" id="I/O_Scheduler">I/O Scheduler</span>
</h3>
<p>While ZFS is expected to work well with modern schedulers including, <code>mq-deadline</code>, and <code>none</code>, experimenting with <a href="../en/Improving_performance.html#Changing_I/O_scheduler" title="Improving performance">manually setting</a> the I/O scheduler on ZFS disks may yield performance gains. The ZFS recomendation is "[...] users leave the default scheduler <a rel="nofollow" class="external text" href="https://github.com/openzfs/zfs/issues/9778#issuecomment-569347505">“unless you’re encountering a specific problem, or have clearly measured a performance improvement for your workload”</a>"<a rel="nofollow" class="external autonumber" href="https://openzfs.github.io/openzfs-docs/Performance%20and%20Tuning/Module%20Parameters.html#zfs-vdev-scheduler">[7]</a>
</p>
<h2><span class="mw-headline" id="Troubleshooting">Troubleshooting</span></h2>
<h3><span class="mw-headline" id="Creating_a_zpool_fails">Creating a zpool fails</span></h3>
<p>If the following error occurs then it can be fixed.
</p>
<pre># the kernel failed to rescan the partition table: 16
# cannot label 'sdc': try using parted(8) and then provide a specific slice: -1
</pre>
<p>One reason this can occur is because ZFS expects pool creation to take less than 1 second<a rel="nofollow" class="external autonumber" href="https://github.com/openzfs/zfs/issues/2582">[8]</a><a rel="nofollow" class="external autonumber" href="https://github.com/openzfs/zfs/issues/1646">[9]</a>. This is a reasonable assumption under ordinary conditions, but in many situations it may take longer. Each drive will need to be cleared again before another attempt can be made.
</p>
<pre># parted /dev/sda rm 1
# parted /dev/sda rm 1
# dd if=/dev/zero of=/dev/sdb bs=512 count=1
# zpool labelclear /dev/sda
</pre>
<p>A brute force creation can be attempted over and over again, and with some luck the ZPool creation will take less than 1 second.
One cause for creation slowdown can be slow burst read writes on a drive. By reading from the disk in parallell to ZPool creation, it may be possible to increase burst speeds.
</p>
<pre># dd if=/dev/sda of=/dev/null
</pre>
<p>This can be done with multiple drives by saving the above command for each drive to a file on separate lines and running 
</p>
<pre># cat $FILE | parallel
</pre>
<p>Then run ZPool creation at the same time.
</p>
<h3><span class="mw-headline" id="ZFS_is_using_too_much_RAM">ZFS is using too much RAM</span></h3>
<p>By default, ZFS caches file operations (<a href="https://en.wikipedia.org/wiki/Adaptive_replacement_cache" class="extiw" title="wikipedia:Adaptive replacement cache">ARC</a>) using up to half of available system memory on the host. To adjust the ARC size, add the following to the <a href="../en/Kernel_parameters.html" title="Kernel parameters">Kernel parameters</a> list:
</p>
<pre>zfs.zfs_arc_max=536870912 # (for 512MiB)
</pre>
<p>In case that the default value of <code>zfs_arc_min</code> (1/32 of system memory) is higher than the specified <code>zfs_arc_max</code> it is needed to add also the following to the <a href="../en/Kernel_parameters.html" title="Kernel parameters">Kernel parameters</a> list:
</p>
<pre>zfs.zfs_arc_min=268435456 # (for 256MiB, needs to be lower than zfs.zfs_arc_max)
</pre>
<p>You may also want to increase <code>zfs_arc_sys_free</code> instead (in this example to 8GiB):
</p>
<pre># echo $((8*1024**3)) &gt; /sys/module/zfs/parameters/zfs_arc_sys_free
</pre>
<p>For a more detailed description, as well as other configuration options, see <a href="https://wiki.gentoo.org/wiki/ZFS#ARC" class="extiw" title="gentoo:ZFS">Gentoo:ZFS#ARC</a>.
</p>
<p>ZFS should release ARC as applications reserve more RAM, but some applications still <a rel="nofollow" class="external text" href="https://github.com/openzfs/zfs/issues/10255">get confused</a>, and reported <a rel="nofollow" class="external text" href="https://github.com/openzfs/zfs/issues/10251">free RAM is always wrong</a>. But in case all your applications work as intended and you have no problems, there is no need to change ARC settings.
</p>
<h3><span class="mw-headline" id="Does_not_contain_an_EFI_label">Does not contain an EFI label</span></h3>
<p>The following error will occur when attempting to create a zfs filesystem,
</p>
<pre>/dev/disk/by-id/&lt;id&gt; does not contain an EFI label but it may contain partition
</pre>
<p>The way to overcome this is to use <code>-f</code> with the zfs create command.
</p>
<h3><span class="mw-headline" id="No_hostid_found">No hostid found</span></h3>
<p>An error that occurs at boot with the following lines appearing before initscript output:
</p>
<pre>ZFS: No hostid found on kernel command line or /etc/hostid.
</pre>
<p>This warning occurs because the ZFS module does not have access to the spl hosted. There are two solutions, for this. Either place the spl hostid in the <a href="../en/Kernel_parameters.html" title="Kernel parameters">kernel parameters</a> in the boot loader. For example, adding <code>spl.spl_hostid=0x00bab10c</code>.
</p>
<p>The other solution is to make sure that there is a hostid in <code>/etc/hostid</code>, and then <a href="../en/Mkinitcpio.html#Image_creation_and_activation" class="mw-redirect" title="Regenerate the initramfs">regenerate the initramfs</a> image. Which will copy the hostid into the initramfs image.
</p>
<h3>
<span id="Pool_cannot_be_found_while_booting_from_SAS.2FSCSI_devices"></span><span class="mw-headline" id="Pool_cannot_be_found_while_booting_from_SAS/SCSI_devices">Pool cannot be found while booting from SAS/SCSI devices</span>
</h3>
<p>In case you are booting a SAS/SCSI based, you might occassionally get boot problems where the pool you are trying to boot from cannot be found. A likely reason for this is that your devices are initialized too late into the process. That means that zfs cannot find any devices at the time when it tries to assemble your pool.
</p>
<p>In this case you should force the scsi driver to wait for devices to come online before continuing. You can do this by putting this into <code>/etc/modprobe.d/zfs.conf</code>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/modprobe.d/zfs.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">options scsi_mod scan=sync</pre>
<p>Afterwards, <a href="../en/Mkinitcpio.html#Image_creation_and_activation" class="mw-redirect" title="Regenerate the initramfs">regenerate the initramfs</a>.
</p>
<p>This works because the zfs hook will copy the file at <code>/etc/modprobe.d/zfs.conf</code> into the initcpio which will then be used at build time.
</p>
<h3>
<span id="On_boot_the_zfs_pool_does_not_mount_stating:_.22pool_may_be_in_use_from_other_system.22"></span><span class="mw-headline" id='On_boot_the_zfs_pool_does_not_mount_stating:_"pool_may_be_in_use_from_other_system"'>On boot the zfs pool does not mount stating: "pool may be in use from other system"</span>
</h3>
<h4><span class="mw-headline" id="Unexported_pool">Unexported pool</span></h4>
<p>If the new installation does not boot because the zpool cannot be imported, chroot into the installation and properly export the zpool. See <a href="#Emergency_chroot_repair_with_archzfs">#Emergency chroot repair with archzfs</a>.
</p>
<p>Once inside the chroot environment, load the ZFS module and force import the zpool,
</p>
<pre># zpool import -a -f
</pre>
<p>now export the pool:
</p>
<pre># zpool export &lt;pool&gt;
</pre>
<p>To see the available pools, use,
</p>
<pre># zpool status
</pre>
<p>It is necessary to export a pool because of the way ZFS uses the hostid to track the system the zpool was created on. The hostid is generated partly based on the network setup. During the installation in the archiso the network configuration could be different generating a different hostid than the one contained in the new installation. Once the zfs filesystem is exported and then re-imported in the new installation, the hostid is reset. See <a rel="nofollow" class="external text" href="https://web.archive.org/web/20151101094022/http://osdir.com/ml/zfs-discuss/2011-06/msg00227.html">Re: Howto zpool import/export automatically? - msg#00227</a>.
</p>
<p>If ZFS complains about "pool may be in use" after every reboot, properly export pool as described above, and then <a href="../en/Mkinitcpio.html#Image_creation_and_activation" class="mw-redirect" title="Regenerate the initramfs">regenerate the initramfs</a> in normally booted system.
</p>
<h4><span class="mw-headline" id="Incorrect_hostid">Incorrect hostid</span></h4>
<p>Double check that the pool is properly exported. Exporting the zpool clears the hostid marking the ownership. So during the first boot the zpool should mount correctly. If it does not there is some other problem.
</p>
<p>Reboot again, if the zfs pool refuses to mount it means the hostid is not yet correctly set in the early boot phase and it confuses zfs. Manually tell zfs the correct number, once the hostid is coherent across the reboots the zpool will mount correctly.
</p>
<p>Boot using zfs_force and write down the hostid. This one is just an example.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">$ hostid</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">0a0af0f8
</pre>
<p>This number have to be added to the <a href="../en/Kernel_parameters.html" title="Kernel parameters">kernel parameters</a> as <code>spl.spl_hostid=0x0a0af0f8</code>. Another solution is writing the hostid inside the initram image, see the <a href="../en/Install_Arch_Linux_on_ZFS.html#Configure_systemd_ZFS_mounts" title="Install Arch Linux on ZFS">installation guide</a> explanation about this.
</p>
<p>Users can always ignore the check adding <code>zfs_force=1</code> in the <a href="../en/Kernel_parameters.html" title="Kernel parameters">kernel parameters</a>, but it is not advisable as a permanent solution.
</p>
<h3><span class="mw-headline" id="Devices_have_different_sector_alignment">Devices have different sector alignment</span></h3>
<p>Once a drive has become faulted it should be replaced A.S.A.P. with an identical drive.
</p>
<pre># zpool replace bigdata ata-ST3000DM001-9YN166_S1F0KDGY ata-ST3000DM001-1CH166_W1F478BD -f
</pre>
<p>but in this instance, the following error is produced:
</p>
<pre>cannot replace ata-ST3000DM001-9YN166_S1F0KDGY with ata-ST3000DM001-1CH166_W1F478BD: devices have different sector alignment
</pre>
<p>ZFS uses the ashift option to adjust for physical block size. When replacing the faulted disk, ZFS is attempting to use <code>ashift=12</code>, but the faulted disk is using a different ashift (probably <code>ashift=9</code>) and this causes the resulting error. 
</p>
<p>For Advanced Format Disks with 4KB blocksize, an ashift of 12 is recommended for best performance. See <a rel="nofollow" class="external text" href="https://openzfs.github.io/openzfs-docs/Project%20and%20Community/FAQ.html#performance-considerations">OpenZFS FAQ: Performance Considerations</a> and <a rel="nofollow" class="external text" href="https://web.archive.org/web/20170913063528/https://wiki.illumos.org/display/illumos/ZFS+and+Advanced+Format+disks">ZFS and Advanced Format disks</a>.
</p>
<p>Use zdb to find the ashift of the zpool: <code>zdb </code>, then use the <code>-o</code> argument to set the ashift of the replacement drive:
</p>
<pre># zpool replace bigdata ata-ST3000DM001-9YN166_S1F0KDGY ata-ST3000DM001-1CH166_W1F478BD -o ashift=9 -f
</pre>
<p>Check the zpool status for confirmation:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># zpool status -v</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">pool: bigdata
state: DEGRADED
status: One or more devices is currently being resilvered.  The pool will
        continue to function, possibly in a degraded state.
action: Wait for the resilver to complete.
scan: resilver in progress since Mon Jun 16 11:16:28 2014
    10.3G scanned out of 5.90T at 81.7M/s, 20h59m to go
    2.57G resilvered, 0.17% done
config:

        NAME                                   STATE     READ WRITE CKSUM
        bigdata                                DEGRADED     0     0     0
        raidz1-0                               DEGRADED     0     0     0
            replacing-0                        OFFLINE      0     0     0
            ata-ST3000DM001-9YN166_S1F0KDGY    OFFLINE      0     0     0
            ata-ST3000DM001-1CH166_W1F478BD    ONLINE       0     0     0  (resilvering)
            ata-ST3000DM001-9YN166_S1F0JKRR    ONLINE       0     0     0
            ata-ST3000DM001-9YN166_S1F0KBP8    ONLINE       0     0     0
            ata-ST3000DM001-9YN166_S1F0JTM1    ONLINE       0     0     0

errors: No known data errors
</pre>
<h3>
<span id="Pool_resilvering_stuck.2Frestarting.2Fslow.3F"></span><span class="mw-headline" id="Pool_resilvering_stuck/restarting/slow?">Pool resilvering stuck/restarting/slow?</span>
</h3>
<p>According to <a rel="nofollow" class="external text" href="https://github.com/openzfs/zfs/issues/840">ZFS issue #840</a>, this is a known issue since 2012 with ZFS-ZED which causes the resilvering process to constantly restart, sometimes get stuck and be generally slow for some hardware. The simplest mitigation is to stop zfs-zed.service until the resilver completes.
</p>
<h3><span class="mw-headline" id="Fix_slow_boot_caused_by_failed_import_of_unavailable_pools_in_the_initramfs_zpool.cache">Fix slow boot caused by failed import of unavailable pools in the initramfs zpool.cache</span></h3>
<p>Your boot time can be significantly impacted if you update your intitramfs (eg when doing a kernel update) when you have additional but non-permanently attached pools imported because these pools will get added to your initramfs zpool.cache and ZFS will attempt to import these extra pools on every boot, regardless of whether you have exported it and removed it from your regular zpool.cache.
</p>
<p>If you notice ZFS trying to import unavailable pools at boot, first run:
</p>
<pre>$ zdb -C
</pre>
<p>To check your zpool.cache for pools you do not want imported at boot. If this command is showing (a) additional, currently unavailable pool(s), run:
</p>
<pre># zpool set cachefile=/etc/zfs/zpool.cache zroot
</pre>
<p>To clear the zpool.cache of any pools other than the pool named zroot. Sometimes there is no need to refresh your zpool.cache, but instead all you need to do is <a href="../en/Mkinitcpio.html#Image_creation_and_activation" class="mw-redirect" title="Regenerate the initramfs">regenerate the initramfs</a>.
</p>
<h3><span class="mw-headline" id="ZFS_Command_History">ZFS Command History</span></h3>
<p>ZFS logs changes to a pool's structure natively as a log of executed commands in a ring buffer (which cannot be turned off).
The log may be helpful when restoring a degraded or failed pool.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># zpool history zpool</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">History for 'zpool':
2023-02-19.16:28:44 zpool create zpool raidz1 /scratch/disk_1.img /scratch/disk_2.img /scratch/disk_3.img
2023-02-19.16:31:29 zfs set compression=lz4 zpool
2023-02-19.16:41:45 zpool scrub zpool
2023-02-19.17:00:57 zpool replace zpool /scratch/disk_1.img /scratch/bigger_disk_1.img
2023-02-19.17:01:34 zpool scrub zpool
2023-02-19.17:01:42 zpool replace zpool /scratch/disk_2.img /scratch/bigger_disk_2.img
2023-02-19.17:01:46 zpool replace zpool /scratch/disk_3.img /scratch/bigger_disk_3.img
</pre>
<h2><span class="mw-headline" id="Tips_and_tricks">Tips and tricks</span></h2>
<h3><span class="mw-headline" id="Create_an_Archiso_image_with_ZFS_support">Create an Archiso image with ZFS support</span></h3>
<p>Follow the <a href="../en/Archiso.html" title="Archiso">Archiso</a> steps for creating a fully functional Arch Linux live CD/DVD/USB image. To include ZFS support in the image, you can either build your choice of PKGBUILDs from the AUR or include prebuilt packages from one of the <a href="../en/Unofficial_user_repositories.html" title="Unofficial user repositories">unofficial user repositories</a>.
</p>
<h4><span class="mw-headline" id="Using_self-built_ZFS_packages_from_the_AUR">Using self-built ZFS packages from the AUR</span></h4>
<p>Build the ZFS packages you want by following the <a href="../en/Arch_User_Repository.html#Build_the_package" title="Arch User Repository">normal procedures</a>. If you are unsure, <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/zfs-dkms/">zfs-dkms</a></span><sup><small>AUR</small></sup> and <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/zfs-utils/">zfs-utils</a></span><sup><small>AUR</small></sup> are likely to be compatible with the widest range of other modifications to the Archiso image you may wish to perform. Proceed to set up <a href="../en/Pacman/Tips_and_tricks.html#Custom_local_repository" title="Pacman/Tips and tricks">a custom local repository</a>. <a href="../en/Archiso.html#Custom_local_repository" title="Archiso">Include the resulting repository</a> in the Pacman configuration of your new profile.
</p>
<p>Include the built packages in the list of packages to be installed. The example below presumes you want to include only the <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/zfs-dkms/">zfs-dkms</a></span><sup><small>AUR</small></sup> and <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/zfs-utils/">zfs-utils</a></span><sup><small>AUR</small></sup> packages.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">packages.x86_64</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">...
zfs-dkms
zfs-utils
</pre>
<p>If you include any <a href="../en/Dynamic_Kernel_Module_Support.html" class="mw-redirect" title="DKMS">DKMS</a> packages, make sure you also include headers for any kernels you are including in the ISO (<span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=linux-headers">linux-headers</a></span> for the default kernel).
</p>
<h4><span class="mw-headline" id="Using_the_archzfs_unofficial_user_repository">Using the archzfs unofficial user repository</span></h4>
<p>Add the <a href="../en/Unofficial_user_repositories.html#archzfs" title="Unofficial user repositories">archzfs</a> unofficial user repository to <code>pacman.conf</code> in your new Archiso profile.
</p>
<p>Add the <code>archzfs-linux</code> group to the list of packages to be installed (the <code>archzfs</code> repository provides packages for the x86_64 architecture only).
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">packages.x86_64</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">...
archzfs-linux
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> If you later have problems running modprobe zfs, you should include the linux-headers in the packages.x86_64. </div>
<h4><span class="mw-headline" id="Finishing_up">Finishing up</span></h4>
<p>Regardless of where you source your ZFS packages from, you should finish by <a href="../en/Archiso.html#Build_the_ISO" title="Archiso">building the ISO</a>.
</p>
<h3><span class="mw-headline" id="Automatic_snapshots">Automatic snapshots</span></h3>
<h4><span class="mw-headline" id="zrepl">zrepl</span></h4>
<p>The <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/zrepl/">zrepl</a></span><sup><small>AUR</small></sup> package provides a ZFS automatic replication service, which could also be used as a snapshotting service much like <a href="../en/Snapper.html" title="Snapper">snapper</a>.
</p>
<p>For details on how to configure the zrepl daemon, see the zrepl <a rel="nofollow" class="external text" href="https://zrepl.github.io/">documentation</a>. The configuration file should be located at <code>/etc/zrepl/zrepl.yml</code>. Then, run <code>zrepl configcheck</code> to make sure that the syntax of the config file is correct. Finally, enable <code>zrepl.service</code>.
</p>
<h4><span class="mw-headline" id="sanoid">sanoid</span></h4>
<p><span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/sanoid/">sanoid</a></span><sup><small>AUR</small></sup> is a policy-driven tool for taking snapshots. Sanoid also includes <code>syncoid</code>, which is for replicating snapshots. It comes with systemd services and a timer.
</p>
<p>Sanoid only prunes snapshots on the local system. To prune snapshots on the remote system, run sanoid there as well with prune options. Either use the <code>--prune-snapshots</code> command line option or use the <code>--cron</code> command line option together with the <code>autoprune = yes</code> and <code>autosnap = no</code> configuration options.
</p>
<h4><span class="mw-headline" id="ZFS_Automatic_Snapshot_Service_for_Linux">ZFS Automatic Snapshot Service for Linux</span></h4>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong>  <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/zfs-auto-snapshot-git/">zfs-auto-snapshot-git</a></span><sup><small>AUR</small></sup> has not seen any updates since 2019, and the functionality is extremely limited. You are advised to switch to a newer tool like <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/zrepl/">zrepl</a></span><sup><small>AUR</small></sup>. </div>
<p>The <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/zfs-auto-snapshot-git/">zfs-auto-snapshot-git</a></span><sup><small>AUR</small></sup> package provides a shell script to automate the management of snapshots, with each named by date and label (hourly, daily, etc), giving quick and convenient snapshotting of all ZFS datasets. The package also installs cron tasks for quarter-hourly, hourly, daily, weekly, and monthly snapshots. Optionally adjust the <code>--keep parameter</code> from the defaults depending on how far back the snapshots are to go (the monthly script by default keeps data for up to a year).
</p>
<p>To prevent a dataset from being snapshotted at all, set <code>com.sun:auto-snapshot=false</code> on it. Likewise, set more fine-grained control as well by label, if, for example, no monthlies are to be kept on a snapshot, for example, set <code>com.sun:auto-snapshot:monthly=false</code>.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> zfs-auto-snapshot-git will not create snapshots during <a href="#Scrubbing">scrubbing</a>. It is possible to override this by <a href="../en/Systemd.html#Editing_provided_units" title="Systemd">editing provided systemd unit</a> and removing <code>--skip-scrub</code> from <code>ExecStart</code> line. Consequences not known, someone please edit.</div>
<p>Once the package has been installed, <a href="../en/Systemd/Timers.html" title="Systemd/Timers">enable and start the selected timers</a> (<code>zfs-auto-snapshot-{frequent,daily,weekly,monthly}.timer</code>).
</p>
<h3><span class="mw-headline" id="Creating_a_share">Creating a share</span></h3>
<p>ZFS has support for creating shares by <a href="../en/NFS.html" title="NFS">NFS</a> or <a href="../en/Samba.html" class="mw-redirect" title="SMB">SMB</a>.
</p>
<h4><span class="mw-headline" id="NFS">NFS</span></h4>
<p>Make sure <a href="../en/NFS.html" title="NFS">NFS</a> has been installed/configured, note there is no need to edit the <code>/etc/exports</code> file. For sharing over NFS the services <code>nfs-server.service</code> and <code>zfs-share.service</code> should be <a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Start">started</a>.
</p>
<p>To make a pool available on the network:
</p>
<pre># zfs set sharenfs=on <i>nameofzpool</i>
</pre>
<p>To make a dataset available on the network:
</p>
<pre># zfs set sharenfs=on <i>nameofzpool</i>/<i>nameofdataset</i>
</pre>
<p>To enable read/write access for a specific ip-range(s):
</p>
<pre># zfs set sharenfs="rw=@192.168.1.100/24,rw=@10.0.0.0/24" <i>nameofzpool</i>/<i>nameofdataset</i>
</pre>
<p>To check if the dataset is exported successfully:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># showmount -e `hostname`</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">Export list for hostname:
/path/of/dataset 192.168.1.100/24
</pre>
<p>To view the current loaded exports state in more detail, use:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># exportfs -v</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;"><i>/path/of/dataset</i>
    192.168.1.100/24(sync,wdelay,hide,no_subtree_check,mountpoint,sec=sys,rw,secure,no_root_squash,no_all_squash)</pre>
<p>To view the current NFS share list by ZFS:
</p>
<pre># zfs get sharenfs
</pre>
<h4><span class="mw-headline" id="SMB">SMB</span></h4>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong>  SMB functionality is very limited. The usershare path must be <code>/var/lib/samba/usershares</code> and the only supported sharesmb options are <code>on</code> and <code>off</code>. Enabling guest access via <code>sharesmb=guest_ok=y</code> is not supported. </div>
<p>When sharing through SMB, using <code>usershares</code> in <code>/etc/samba/smb.conf</code> will allow ZFS to setup and create the shares. See <a href="../en/Samba.html#Enable_Usershares" title="Samba">Samba#Enable Usershares</a> for details.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/samba/smb.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[global]
    usershare path = /var/lib/samba/usershares
    usershare max shares = 100
    usershare allow guests = yes
    usershare owner only = no</pre>
<p>Create and set permissions on the user directory as root
</p>
<pre># mkdir /var/lib/samba/usershares
# chmod +t /var/lib/samba/usershares
</pre>
<p>To make a pool available on the network:
</p>
<pre># zfs set sharesmb=on <i>nameofzpool</i>
</pre>
<p>To make a dataset available on the network:
</p>
<pre># zfs set sharesmb=on <i>nameofzpool</i>/<i>nameofdataset</i>
</pre>
<p>To check if the dataset is exported successfully:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># smbclient -L localhost -U%</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">        Sharename       Type      Comment
        ---------       ----      -------
        IPC$            IPC       IPC Service (SMB Server Name)
        <i>nameofzpool</i>_<i>nameofdataset</i>        Disk      Comment: path/of/dataset
SMB1 disabled -- no workgroup available
</pre>
<p>To view the current SMB share list by ZFS:
</p>
<pre># zfs get sharesmb
</pre>
<h3><span class="mw-headline" id="Encryption_in_ZFS_using_dm-crypt">Encryption in ZFS using dm-crypt</span></h3>
<p>Before <a rel="nofollow" class="external text" href="https://github.com/openzfs/zfs/releases/tag/zfs-0.8.0">OpenZFS version 0.8.0</a>, ZFS did not support encryption directly (See <a href="#Native_encryption">#Native encryption</a>). Instead, zpools can be created on <a href="../en/Dm-crypt.html" title="Dm-crypt">dm-crypt</a> block devices. Since the zpool is created on the plain-text abstraction, it is possible to have the data encrypted while having all the advantages of ZFS like deduplication, compression, and data robustness. Furthermore, utilizing dm-crypt will encrypt the zpools metadata, which the native encryption can inherently not provide.<a rel="nofollow" class="external autonumber" href="https://openzfs.github.io/openzfs-docs/man/8/zfs-change-key.8.html#Encryption">[10]</a>
</p>
<p>dm-crypt, possibly via LUKS, creates devices in <code>/dev/mapper</code> and their name is fixed. So you just need to change <code>zpool create</code> commands to point to that names. The idea is configuring the system to create the <code>/dev/mapper</code> block devices and import the zpools from there. Since zpools can be created in multiple devices (raid, mirroring, striping, ...), it is important all the devices are encrypted otherwise the protection might be partially lost.
</p>
<p>For example, an encrypted zpool can be created using plain dm-crypt (without LUKS) with:
</p>
<pre># cryptsetup open --type=plain --hash=sha256 --cipher=aes-xts-plain64 --offset=0 \
             --key-file=/dev/sdZ --key-size=512 /dev/sdX enc
# zpool create zroot /dev/mapper/enc
</pre>
<p>In the case of a root filesystem pool, the <code>mkinitcpio.conf</code> HOOKS line will enable the keyboard for the password, create the devices, and load the pools. It will contain something like:
</p>
<pre>HOOKS=(... keyboard encrypt zfs ...)
</pre>
<p>Since the <code>/dev/mapper/enc</code> name is fixed no import errors will occur.
</p>
<p>Creating encrypted zpools works fine. But if you need encrypted directories, for example to protect your users' homes, ZFS loses some functionality.
</p>
<p>ZFS will see the encrypted data, not the plain-text abstraction, so compression and deduplication will not work. The reason is that encrypted data has always high entropy making compression ineffective and even from the same input you get different output (thanks to salting) making deduplication impossible. To reduce the unnecessary overhead it is possible to create a sub-filesystem for each encrypted directory and use <a href="../en/ECryptfs.html" title="ECryptfs">eCryptfs</a> on it.
</p>
<p>For example to have an encrypted home: (the two passwords, encryption and login, must be the same)
</p>
<pre># zfs create -o compression=off -o dedup=off -o mountpoint=/home/&lt;username&gt; &lt;zpool&gt;/&lt;username&gt;
# useradd -m &lt;username&gt;
# passwd &lt;username&gt;
# ecryptfs-migrate-home -u &lt;username&gt;
&lt;log in user and complete the procedure with ecryptfs-unwrap-passphrase&gt;
</pre>
<h3><span class="mw-headline" id="Emergency_chroot_repair_with_archzfs">Emergency chroot repair with archzfs</span></h3>
<p>To get into the ZFS filesystem from live system for maintenance, there are two options:
</p>
<ol>
<li>Build custom archiso with ZFS as described in <a href="#Create_an_Archiso_image_with_ZFS_support">#Create an Archiso image with ZFS support</a>.</li>
<li>Boot the latest official archiso and bring up the network. Then enable <a href="../en/Unofficial_user_repositories.html#archzfs" title="Unofficial user repositories">archzfs</a> repository inside the live system as usual, sync the pacman package database and install the <i>archzfs-archiso-linux</i> package.</li>
</ol>
<p>To start the recovery, load the ZFS kernel modules:
</p>
<pre># modprobe zfs
</pre>
<p>Import the pool:
</p>
<pre># zpool import -a -R /mnt
</pre>
<p>Mount the boot partition and EFI system partition (if any):
</p>
<pre># mount /dev/sda2 /mnt/boot
# mount /dev/sda1 /mnt/efi
</pre>
<p>Chroot into the ZFS filesystem:
</p>
<pre># arch-chroot /mnt /bin/bash
</pre>
<p>Check the kernel version:
</p>
<pre># pacman -Qi linux
# uname -r
</pre>
<p>uname will show the kernel version of the archiso. If they are different, run depmod (in the chroot) with the correct kernel version of the chroot installation:
</p>
<pre># depmod -a 3.6.9-1-ARCH (version gathered from pacman -Qi linux but using the matching kernel modules directory name under the chroot's /lib/modules)
</pre>
<p>This will load the correct kernel modules for the kernel version installed in the chroot installation.
</p>
<p><a href="../en/Mkinitcpio.html#Image_creation_and_activation" class="mw-redirect" title="Regenerate the initramfs">Regenerate the initramfs</a>. There should be no errors.
</p>
<h3><span class="mw-headline" id="Bind_mount">Bind mount</span></h3>
<p>Here a bind mount from /mnt/zfspool to /srv/nfs4/music is created. The configuration ensures that the zfs pool is ready before the bind mount is created.
</p>
<h4><span class="mw-headline" id="fstab">fstab</span></h4>
<p>See <span class="plainlinks archwiki-template-man" title="$ man 5 systemd.mount"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/systemd.mount.5">systemd.mount(5)</a></span> for more information on how systemd converts fstab into mount unit files with <span class="plainlinks archwiki-template-man" title="$ man 8 systemd-fstab-generator"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/systemd-fstab-generator.8">systemd-fstab-generator(8)</a></span>.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/fstab</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">/mnt/zfspool		/srv/nfs4/music		none	bind,defaults,nofail,x-systemd.requires=zfs-mount.service	0 0
</pre>
<h3>
<span id="Monitoring_.2F_Mailing_on_Events"></span><span class="mw-headline" id="Monitoring_/_Mailing_on_Events">Monitoring / Mailing on Events</span>
</h3>
<p>See <a rel="nofollow" class="external text" href="https://ramsdenj.com/2016/08/29/arch-linux-on-zfs-part-3-followup.html">ZED: The ZFS Event Daemon</a> for more information.
</p>
<p>An email forwarder, such as <a href="../en/S-nail.html" title="S-nail">S-nail</a>, is required to accomplish this. Test it to be sure it is working correctly.
</p>
<p>Uncomment the following in the configuration file:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/zfs/zed.d/zed.rc</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;"> ZED_EMAIL_ADDR="root"
 ZED_EMAIL_PROG="mailx"
 ZED_NOTIFY_VERBOSE=0
 ZED_EMAIL_OPTS="-s '@SUBJECT@' @ADDRESS@"
</pre>
<p>Update 'root' in <code>ZED_EMAIL_ADDR="root"</code> to the email address you want to receive notifications at.
</p>
<p>If you are keeping your mailrc in your home directory, you can tell mail to get it from there by setting <code>MAILRC</code>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/zfs/zed.d/zed.rc</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">export MAILRC=/home/&lt;user&gt;/.mailrc</pre>
<p>This works because ZED sources this file, so <code>mailx</code> sees this environment variable.
</p>
<p>If you want to receive an email no matter the state of your pool, you will want to set <code>ZED_NOTIFY_VERBOSE=1</code>. You will need to do this temporary to test.
</p>
<p><a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Start">Start</a> and <a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Enable">enable</a> <code>zfs-zed.service</code>.
</p>
<p>With <code>ZED_NOTIFY_VERBOSE=1</code>, you can test by running a scrub as root: <code>zpool scrub &lt;pool-name&gt;</code>.
</p>
<h3>
<span id="Wrap_shell_commands_in_pre_.26_post_snapshots"></span><span class="mw-headline" id="Wrap_shell_commands_in_pre_&amp;_post_snapshots">Wrap shell commands in pre &amp; post snapshots</span>
</h3>
<p>Since it is so cheap to make a snapshot, we can use this as a measure of security for sensitive commands such as system and package upgrades. If we make a snapshot before, and one after, we can later diff these snapshots to find out what changed on the filesystem after the command executed. Furthermore we can also rollback in case the outcome was not desired.
</p>
<h4><span class="mw-headline" id="znp">znp</span></h4>
<p>E.g.:
</p>
<pre># zfs snapshot -r zroot@pre
# pacman -Syu
# zfs snapshot -r zroot@post
# zfs diff zroot@pre zroot@post 
# zfs rollback zroot@pre
</pre>
<p>A utility that automates the creation of pre and post snapshots around a shell command is <a rel="nofollow" class="external text" href="https://gist.github.com/erikw/eeec35be33e847c211acd886ffb145d5">znp</a>.
</p>
<p>E.g.:
</p>
<pre># znp pacman -Syu
# znp find / -name "something*" -delete
</pre>
<p>and you would get snapshots created before and after the supplied command, and also output of the commands logged to file for future reference so we know what command created the diff seen in a pair of pre/post snapshots.
</p>
<h3><span class="mw-headline" id="Remote_unlocking_of_ZFS_encrypted_root">Remote unlocking of ZFS encrypted root</span></h3>
<p>As of <a rel="nofollow" class="external text" href="https://github.com/archzfs/archzfs/pull/261">PR #261</a>, <code>archzfs</code> supports SSH unlocking of natively-encrypted ZFS datasets. This section describes how to use this feature, and is largely based on <a href="../en/Dm-crypt/Specialties.html#Busybox_based_initramfs_(built_with_mkinitcpio)" title="Dm-crypt/Specialties">dm-crypt/Specialties#Busybox based initramfs (built with mkinitcpio)</a>.
</p>
<ol>
<li>Install <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=mkinitcpio-netconf">mkinitcpio-netconf</a></span> to provide hooks for setting up early user space networking.</li>
<li>Choose an SSH server to use in early user space. The options are <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=mkinitcpio-tinyssh">mkinitcpio-tinyssh</a></span> or <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=mkinitcpio-dropbear">mkinitcpio-dropbear</a></span>, and are mutually exclusive.
<ol><li>If using <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=mkinitcpio-tinyssh">mkinitcpio-tinyssh</a></span>, it is also recommended to install <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=tinyssh">tinyssh</a></span> or <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/tinyssh-convert-git/">tinyssh-convert-git</a></span><sup><small>AUR</small></sup>. This tool converts an existing OpenSSH hostkey to the TinySSH key format, preserving the key fingerprint and avoiding connection warnings. The TinySSH and Dropbear mkinitcpio install scripts will automatically convert existing hostkeys when generating a new initcpio image.</li></ol>
</li>
<li>Decide whether to use an existing OpenSSH key or generate a new one (recommended) for the host that will be connecting to and unlocking the encrypted ZFS machine. Copy the public key into <code>/etc/tinyssh/root_key</code> or <code>/etc/dropbear/root_key</code>. When generating the initcpio image, this file will be added to <code>authorized_keys</code> for the root user and is only valid in the initrd environment.</li>
<li>Add the <code>ip=</code> <a href="../en/Kernel_parameters.html" class="mw-redirect" title="Kernel parameter">kernel parameter</a> to your boot loader configuration. The <code>ip</code> string is <a rel="nofollow" class="external text" href="https://docs.kernel.org/admin-guide/nfs/nfsroot.html">highly configurable</a>. A simple DHCP example is shown below.<pre>ip=:::::eth0:dhcp</pre>
</li>
<li>Edit <code>/etc/mkinitcpio.conf</code> to include the <code>netconf</code>, <code>dropbear</code> or <code>tinyssh</code>, and <code>zfsencryptssh</code> hooks before the <code>zfs</code> hook:<pre>HOOKS=(... netconf &lt;tinyssh&gt;|&lt;dropbear&gt; zfsencryptssh zfs ...)</pre>
</li>
<li>
<a href="../en/Mkinitcpio.html#Image_creation_and_activation" class="mw-redirect" title="Regenerate the initramfs">Regenerate the initramfs</a>.</li>
<li>Reboot and try it out!</li>
</ol>
<h4><span class="mw-headline" id="Changing_the_SSH_server_port">Changing the SSH server port</span></h4>
<p>By default, <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=mkinitcpio-tinyssh">mkinitcpio-tinyssh</a></span> and <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=mkinitcpio-dropbear">mkinitcpio-dropbear</a></span> listen on port <code>22</code>. You may wish to change this.
</p>
<p>For <b>TinySSH</b>, copy <code>/usr/lib/initcpio/hooks/tinyssh</code> to <code>/etc/initcpio/hooks/tinyssh</code>, and find/modify the following line in the <code>run_hook()</code> function:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/initcpio/hooks/tinyssh</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">/usr/bin/tcpserver -HRDl0 0.0.0.0 &lt;new_port&gt; /usr/sbin/tinysshd -v /etc/tinyssh/sshkeydir &amp;
</pre>
<p>For <b>Dropbear</b>, copy <code>/usr/lib/initcpio/hooks/dropbear</code> to <code>/etc/initcpio/hooks/dropbear</code>, and find/modify the following line in the <code>run_hook()</code> function:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/initcpio/hooks/tinyssh</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;"> /usr/sbin/dropbear -E -s -j -k -p &lt;new_port&gt;
</pre>
<p><a href="../en/Mkinitcpio.html#Image_creation_and_activation" class="mw-redirect" title="Regenerate the initramfs">Regenerate the initramfs</a>.
</p>
<h4>
<span id="Unlocking_from_a_Windows_machine_using_PuTTY.2FPlink"></span><span class="mw-headline" id="Unlocking_from_a_Windows_machine_using_PuTTY/Plink">Unlocking from a Windows machine using PuTTY/Plink</span>
</h4>
<p>First, we need to use <code>puttygen.exe</code> to import and convert the OpenSSH key generated earlier into PuTTY's <i>.ppk</i> private key format. Let us call it <code>zfs_unlock.ppk</code> for this example.
</p>
<p>The mkinitcpio-netconf process above does not setup a shell (nor do we need need one). However, because there is no shell, PuTTY will immediately close after a successful connection. This can be disabled in the PuTTY SSH configuration (<i>Connection &gt; SSH &gt; [X] Do not start a shell or command at all</i>), but it still does not allow us to see stdout or enter the encryption passphrase. Instead, we use <code>plink.exe</code> with the following parameters:
</p>
<pre>plink.exe -ssh -l root -i c:\path\to\zfs_unlock.ppk &lt;hostname&gt;
</pre>
<p>The plink command can be put into a batch script for ease of use.
</p>
<h3>
<span id="Enabling_bclone_support_.28cp_--reflink.29"></span><span class="mw-headline" id="Enabling_bclone_support_(cp_--reflink)">Enabling bclone support (<i>cp --reflink</i>)</span>
</h3>
<p>First it is necessary to upgrade the <i>feature flags</i> if coming from a version prior to 2.2.2 to enable bclone, this will allow the pool to have support for this feature. This is done with <code>zpool upgrade</code>, if the status of the pool show this is possible.
</p>
<p>It is also required to enable a module parameter, otherwise userspace apps will not be able to use this feature. You can do this by putting this into <code>/etc/modprobe.d/zfs.conf</code>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/modprobe.d/zfs.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">options zfs zfs_bclone_enabled=1</pre>
<p>Check that is working, and how much space is being saved with the command: <code>zpool get all POOLNAME | grep clon</code>
</p>
<h2><span class="mw-headline" id="See_also">See also</span></h2>
<ul>
<li><a rel="nofollow" class="external text" href="https://pthree.org/2012/12/04/zfs-administration-part-i-vdevs/">Aaron Toponce's 17-part blog on ZFS</a></li>
<li><a rel="nofollow" class="external text" href="https://zfsonlinux.org/">OpenZFS releases</a></li>
<li><a rel="nofollow" class="external text" href="https://openzfs.github.io/openzfs-docs/Project%20and%20Community/FAQ.html">OpenZFS FAQ</a></li>
<li><a rel="nofollow" class="external text" href="https://www.freebsd.org/doc/en_US.ISO8859-1/books/handbook/zfs.html">FreeBSD Handbook - The Z File System</a></li>
<li><a rel="nofollow" class="external text" href="https://docs.oracle.com/cd/E19253-01/819-5461/index.html">Oracle Solaris ZFS Administration Guide</a></li>
<li><a rel="nofollow" class="external text" href="https://web.archive.org/web/20161028084224/http://www.solarisinternals.com/wiki/index.php/ZFS_Best_Practices_Guide">ZFS Best Practices Guide</a></li>
<li><a rel="nofollow" class="external text" href="https://docs.oracle.com/cd/E23823_01/html/819-5461/gavwg.html">ZFS Troubleshooting Guide</a></li>
<li><a rel="nofollow" class="external text" href="https://web.archive.org/web/20171213164254/http://royal.pingdom.com/2013/06/04/zfs-backup/">How Pingdom uses ZFS to back up 5TB of MySQL data every day</a></li>
<li><a rel="nofollow" class="external text" href="https://www.linuxquestions.org/questions/linux-from-scratch-13/%5Bhow-to%5D-add-zfs-to-the-linux-kernel-4175514510/">Tutorial on adding the modules to a custom kernel</a></li>
<li><a rel="nofollow" class="external text" href="https://github.com/danboid/creating-ZFS-disks-under-Linux">How to create cross platform ZFS disks under Linux</a></li>
<li><a rel="nofollow" class="external text" href="https://blog.heckel.xyz/2017/01/08/zfs-encryption-openzfs-zfs-on-linux/">How-To: Using ZFS Encryption at Rest in OpenZFS (ZFS on Linux, ZFS on FreeBSD, …)</a></li>
<li><a rel="nofollow" class="external text" href="https://archzfs.leibelt.de/">Archzfs iso download page: Frequently updated and downloadable archzfs linux iso with full OpenZFS support since 2016</a></li>
</ul>
</div>
</div>
					<div id="catlinks" class="catlinks" data-mw="interface">
<div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../Special:Categories.html" title="Special:Categories">Categories</a>: <ul>
<li><a href="../en/Category:File_systems.html" title="Category:File systems">File systems</a></li>
<li><a href="../en/Category:Oracle.html" title="Category:Oracle">Oracle</a></li>
</ul>
</div>
<div id="mw-hidden-catlinks" class="mw-hidden-catlinks mw-hidden-cats-hidden">Hidden categories: <ul>
<li><a href="../en/Category:Pages_or_sections_flagged_with_Template:Style.html" title="Category:Pages or sections flagged with Template:Style">Pages or sections flagged with Template:Style</a></li>
<li><a href="../en/Category:Pages_or_sections_flagged_with_Template:Accuracy.html" title="Category:Pages or sections flagged with Template:Accuracy">Pages or sections flagged with Template:Accuracy</a></li>
</ul>
</div>
</div>
				</div>
			</main>
			
		</div>
		<div class="mw-footer-container">
			
<footer id="footer" class="mw-footer" role="contentinfo" style="margin: 0">
	<ul id="footer-info">
	<li data-nosnippet="">Retrieved from "<a dir="ltr" href="https://wiki.archlinux.org/index.php?title=ZFS&amp;oldid=813223">https://wiki.archlinux.org/index.php?title=ZFS&amp;oldid=813223</a>"</li>
<li id="footer-info-lastmod"> This page was last edited on 29 July 2024, at 20:57.</li>
	<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="https://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.3 or later</a> unless otherwise noted.</li>
<br>
</ul>

	<ul id="footer-places">
	<li id="footer-places-privacy"><a href="https://terms.archlinux.org/docs/privacy-policy/">Privacy policy</a></li>
	<li id="footer-places-about"><a href="../en/ArchWiki:About.html">About ArchWiki</a></li>
	<li id="footer-places-disclaimers"><a href="../en/ArchWiki:General_disclaimer.html">Disclaimers</a></li>
	<li id="footer-places-archwiki-code-of-conduct"><a href="https://terms.archlinux.org/docs/code-of-conduct/" class="extiw" title="archlinux-service-agreements:code-of-conduct">Code of conduct</a></li>
	<li id="footer-places-archwiki-terms-of-service"><a href="https://terms.archlinux.org/docs/terms-of-service/" class="extiw" title="archlinux-service-agreements:terms-of-service">Terms of service</a></li>
</ul>

	<ul id="footer-icons" class="noprint">
	<li id="footer-copyrightico"><a href="https://www.gnu.org/copyleft/fdl.html"><img src="/resources/assets/licenses/gnu-fdl.png" alt="GNU Free Documentation License 1.3 or later" width="88" height="31" loading="lazy"></a></li>
	<li id="footer-poweredbyico"><img src="/resources/assets/poweredby_mediawiki_88x31.png" srcset="/resources/assets/poweredby_mediawiki_132x47.png 1.5x, /resources/assets/poweredby_mediawiki_176x62.png 2x" width="88" height="31" loading="lazy"></li>
</ul>

</footer>

		</div>
	</div> 
</div> 
<div class="vector-settings" id="p-dock-bottom">
	<ul>
		<li>
		<button class="cdx-button cdx-button--icon-only vector-limited-width-toggle" id=""><span class="vector-icon mw-ui-icon-fullScreen mw-ui-icon-wikimedia-fullScreen"></span>

<span>Toggle limited content width</span>
</button>
</li>
	</ul>
</div>
</body>
</html>
