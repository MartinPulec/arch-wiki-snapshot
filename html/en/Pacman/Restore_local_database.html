<!DOCTYPE html>
<html class="client-nojs vector-feature-language-in-header-enabled vector-feature-language-in-main-page-header-disabled vector-feature-sticky-header-disabled vector-feature-page-tools-pinned-disabled vector-feature-toc-pinned-clientpref-1 vector-feature-main-menu-pinned-disabled vector-feature-limited-width-clientpref-1 vector-feature-limited-width-content-enabled vector-feature-custom-font-size-clientpref-0 vector-feature-client-preferences-disabled vector-feature-client-prefs-pinned-disabled vector-feature-night-mode-disabled skin-theme-clientpref-day vector-toc-available" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>pacman/Restore local database - ArchWiki</title>
<link rel="stylesheet" href="../../ArchWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<meta name="generator" content="MediaWiki 1.42.1">
<meta name="referrer" content="no-referrer-when-downgrade">
<meta name="robots" content="max-image-preview:standard">
<meta name="format-detection" content="telephone=no">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=0.25, maximum-scale=5.0">
<link rel="icon" href="/favicon.ico">
<link rel="search" type="application/opensearchdescription+xml" href="/opensearch_desc.php" title="ArchWiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.archlinux.org/api.php?action=rsd">
<link rel="license" href="https://www.gnu.org/copyleft/fdl.html">
<link rel="alternate" type="application/atom+xml" title="ArchWiki Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="skin-vector skin-vector-search-vue mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-Pacman_Restore_local_database rootpage-Pacman skin-vector-2022 action-view skin--responsive">
<a class="mw-jump-link" href="#bodyContent">Jump to content</a>
<div class="vector-header-container">
	</div>
<div class="mw-page-container">
	<div class="mw-page-container-inner">
		<div class="vector-column-start">
			<div class="vector-main-menu-container">
		</div>
	<div class="vector-sticky-pinned-container">
				<nav id="mw-panel-toc" role="navigation" aria-label="Contents" data-event-name="ui.sidebar-toc" class="mw-table-of-contents-container vector-toc-landmark">
					<div id="vector-toc-pinned-container" class="vector-pinned-container">
					<div id="vector-toc" class="vector-toc vector-pinnable-element">
	<div class="vector-pinnable-header vector-toc-pinnable-header vector-pinnable-header-pinned" data-feature-name="toc-pinned" data-pinnable-element-id="vector-toc">
	<h2 class="vector-pinnable-header-label">Contents</h2>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-pin-button" data-event-name="pinnable-header.vector-toc.pin">move to sidebar</button>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-unpin-button" data-event-name="pinnable-header.vector-toc.unpin">hide</button>
</div>


	<ul class="vector-toc-contents" id="mw-panel-toc-list">
		<li id="toc-mw-content-text" class="vector-toc-list-item vector-toc-level-1">
			<a href="#" class="vector-toc-link">
				<div class="vector-toc-text">Beginning</div>
			</a>
		</li>
		<li id="toc-Generating_the_package_recovery_list" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#Generating_the_package_recovery_list">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">1</span>Generating the package recovery list</div>
		</a>
		
		<ul id="toc-Generating_the_package_recovery_list-sublist" class="vector-toc-list">
		</ul>
	</li>
	<li id="toc-Performing_the_recovery" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#Performing_the_recovery">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">2</span>Performing the recovery</div>
		</a>
		
		<ul id="toc-Performing_the_recovery-sublist" class="vector-toc-list">
		</ul>
	</li>
</ul>
</div>

					</div>
		</nav>
			</div>
		</div>
		<div class="mw-content-container">
			<main id="content" class="mw-body" role="main" style="margin: 0">
				<header class="mw-body-header vector-page-titlebar">
					<nav role="navigation" aria-label="Contents" class="vector-toc-landmark">
						
<div id="vector-page-titlebar-toc" class="vector-dropdown vector-page-titlebar-toc vector-button-flush-left">
	<input type="checkbox" id="vector-page-titlebar-toc-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-vector-page-titlebar-toc" class="vector-dropdown-checkbox " aria-label="Toggle the table of contents">
	<label id="vector-page-titlebar-toc-label" for="vector-page-titlebar-toc-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--icon-only " aria-hidden="true"><span class="vector-icon mw-ui-icon-listBullet mw-ui-icon-wikimedia-listBullet"></span>

<span class="vector-dropdown-label-text">Toggle the table of contents</span>
	</label>
	<div class="vector-dropdown-content">


							<div id="vector-page-titlebar-toc-unpinned-container" class="vector-unpinned-container">
			</div>
		
	</div>
</div>

					</nav>
					<h1 id="firstHeading" class="firstHeading mw-first-heading">pacman/Restore local database</h1>
							
<div id="p-lang-btn" class="vector-dropdown mw-portlet mw-portlet-lang">
	<input type="checkbox" id="p-lang-btn-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-p-lang-btn" class="vector-dropdown-checkbox mw-interlanguage-selector" aria-label="Go to an article in another language. Available in 6 languages">
	<label id="p-lang-btn-label" for="p-lang-btn-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--action-progressive mw-portlet-lang-heading-6" aria-hidden="true"><span class="vector-icon mw-ui-icon-language-progressive mw-ui-icon-wikimedia-language-progressive"></span>

<span class="vector-dropdown-label-text">6 languages</span>
	</label>
	<div class="vector-dropdown-content">

		<div class="vector-menu-content">
			
			<ul class="vector-menu-content-list">
				
				<li class="interlanguage-link interwiki-es mw-list-item"><a href="../../es/Pacman/Restore_local_database.html" title="Pacman (Español)/Restore local database – español" lang="es" hreflang="es" class="interlanguage-link-target"><span>Español</span></a></li>
<li class="interlanguage-link interwiki-fr mw-list-item"><a href="../../fr/Pacman/Restore_local_database.html" title="Pacman (Français)/Restore local database – français" lang="fr" hreflang="fr" class="interlanguage-link-target"><span>Français</span></a></li>
<li class="interlanguage-link interwiki-ja mw-list-item"><a href="https://wiki.archlinux.jp/index.php/Pacman/%E3%83%AD%E3%83%BC%E3%82%AB%E3%83%AB%E3%83%87%E3%83%BC%E3%82%BF%E3%83%99%E3%83%BC%E3%82%B9%E3%81%AE%E5%BE%A9%E5%85%83" title="Pacman/ローカルデータベースの復元 – 日本語" lang="ja" hreflang="ja" class="interlanguage-link-target"><span>日本語</span></a></li>
<li class="interlanguage-link interwiki-pt mw-list-item"><a href="../../pt/Pacman/Restore_local_database.html" title="Pacman (Português)/Restore local database – português" lang="pt" hreflang="pt" class="interlanguage-link-target"><span>Português</span></a></li>
<li class="interlanguage-link interwiki-ru mw-list-item"><a href="../../ru/Pacman/Restore_local_database.html" title="Pacman (Русский)/Restore local database – русский" lang="ru" hreflang="ru" class="interlanguage-link-target"><span>Русский</span></a></li>
<li class="interlanguage-link interwiki-zh-hans mw-list-item"><a href="https://wiki.archlinuxcn.org/wiki/Pacman/Restore_local_database" title="Pacman/Restore local database – 中文（简体）" lang="zh-Hans" hreflang="zh-Hans" class="interlanguage-link-target"><span>中文（简体）</span></a></li>
			</ul>
			
		</div>

	</div>
</div>
</header>
				<div class="vector-column-end">
					<div class="vector-sticky-pinned-container">
						<nav class="vector-page-tools-landmark" aria-label="Page tools">
							<div id="vector-page-tools-pinned-container" class="vector-pinned-container">
				
							</div>
		</nav>
						<nav class="vector-client-prefs-landmark" aria-label="Appearance">
						</nav>
					</div>
				</div>
				<div id="bodyContent" class="vector-body" aria-labelledby="firstHeading" data-mw-ve-target-container>
					<div class="vector-body-before-content">
							<div class="mw-indicators">
		</div>

						<div id="siteSub" class="noprint">From ArchWiki</div>
					</div>
					<div id="contentSub"><div id="mw-content-subtitle"><div class="subpages">&lt; <a href="../../en/Pacman.html" title="Pacman">Pacman</a>
</div></div></div>
					
					
					<div id="mw-content-text" class="mw-body-content">
<div class="mw-content-ltr mw-parser-output" lang="en" dir="ltr">
<p><span>
</span>
Signs that pacman needs a local database restoration:
</p>
<ul>
<li>
<code>pacman -Q</code> gives absolutely no output, and <code>pacman -Syu</code> erroneously reports that the system is up to date.</li>
<li>When trying to install a package using <code>pacman -S package</code>, and it outputs a list of already satisfied dependencies.</li>
</ul>
<p>Most likely, pacman's database of installed software, <code>/var/lib/pacman/local</code>, has been corrupted or deleted. While this is a serious problem, it can be restored by following the instructions below.
</p>
<p>Firstly, make sure pacman's log file is present:
</p>
<pre>$ ls /var/log/pacman.log
</pre>
<p>If it does not exist, it is <i>not</i> possible to continue with this method. You may be able to use <a rel="nofollow" class="external text" href="https://bbs.archlinux.org/viewtopic.php?pid=670876">Xyne's package detection script</a> to recreate the database. If not, then the likely solution is to re-install the entire system.
</p>
<h2><span class="mw-headline" id="Generating_the_package_recovery_list">Generating the package recovery list</span></h2>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> If for some reason your <a href="../../en/Pacman.html" title="Pacman">pacman</a> cache or <a href="../../en/Makepkg.html" title="Makepkg">makepkg</a> package destination contain packages for other architectures, remove them before continuation.</div>
<p><a href="../../en/Help:Reading.html#Installation_of_packages" class="mw-redirect" title="Install">Install</a> the <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=pacman-contrib">pacman-contrib</a></span> package to get <i>paclog-pkglist</i>.
</p>
<p>Create the log filter script and make it <a href="../../en/Help:Reading.html#Make_executable" class="mw-redirect" title="Executable">executable</a>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">pacrecover</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">#!/bin/bash -e

# load configuration settings from the makepkg configuration file
. /etc/makepkg.conf

# determine the cache directory from pacman configuration, defaulting to /var/cache/pacman/pkg, remove prefix with sed
PKGCACHE=$( (grep -m 1 '^CacheDir' /etc/pacman.conf || echo 'CacheDir = /var/cache/pacman/pkg') | sed 's/CacheDir = //')

# define directories to search for package files
pkgdirs=("$@" "$PKGDEST" "$PKGCACHE")

# read package name and version from input and construct a search pattern for package files
while read -r -a parampart; do

        # loop through each directory to search for matching package files
        for pkgdir in "${pkgdirs[@]}"; do

                # check each file matching the pattern in the current directory
                for i in "$pkgdir"/"${parampart[0]}"-"${parampart[1]}"-*.pkg.tar.{xz,zst} ; do

                        # if a file exists, print its path and stop checking further
                        [ -f "${i}" ] &amp;&amp; { echo "${i}" ; break; };
                done

                # If no file is found, output the package name to stderr
        done || echo "${parampart[0]}" 1&gt;&amp;2 
done
</pre>
<p>Run the script (optionally passing additional directories with packages as parameters):
</p>
<pre>$ paclog-pkglist /var/log/pacman.log | ./pacrecover &gt;files.list 2&gt;pkglist.orig
</pre>
<p>This way two files will be created: <code>files.list</code> with package files, still present on machine and <code>pkglist.orig</code>, packages from which should be downloaded. Later operation may result in mismatch between files of older versions of package, still present on machine, and files, found in new version. Such mismatches will have to be fixed manually.
</p>
<p>Here is a way to automatically restrict second list to packages available in a repository:
</p>
<pre>$ { cat pkglist.orig; pacman -Slq; } | sort | uniq -d &gt; pkglist
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> If this fails with <code>failed to initialise alpm library</code>, then check if <code>/var/lib/pacman/local/ALPM_DB_VERSION</code> exists - if not, then run <code>pacman-db-upgrade</code> as root followed by <code>pacman -Sy</code> and then <b>retry the previous command</b>.</div>
<p>Check if some important <i>base</i> packages are missing, and add them to the list:
</p>
<pre>$ comm -23 &lt;({ echo base ; expac -l '\n' '%E' base; } | sort) pkglist.orig &gt;&gt; pkglist
</pre>
<p>Proceed once the contents of both lists are satisfactory, since they will be used to restore pacman's installed package database; <code>/var/lib/pacman/local/</code>.
</p>
<h2><span class="mw-headline" id="Performing_the_recovery">Performing the recovery</span></h2>
<p>Define a <a href="../../en/Bash/Functions.html" title="Bash/Functions">bash function</a> for recovery purposes:
</p>
<pre> recovery-pacman() {
    pacman "$@"  \
    --log /dev/null   \
    --noscriptlet     \
    --dbonly          \
    --overwrite "*"   \
    --nodeps          \
    --needed
}
</pre>
<p><code>--log /dev/null</code> allows to avoid needless pollution of pacman log, <code>--needed</code> will save some time by skipping packages, already present in database, <code>--nodeps</code> will allow installation of cached packages, even if packages being installed depend on newer versions. Rest of options will allow <b>pacman</b> to operate without reading/writing filesystem.
</p>
<p>Populate the sync database:
</p>
<pre># pacman -Sy
</pre>
<p>Start database generation by installing locally available package files from <code>files.list</code>:
</p>
<pre># recovery-pacman -U $(&lt; files.list)
</pre>
<p>Install the rest from <code>pkglist</code>:
</p>
<pre># recovery-pacman -S $(&lt; pkglist)
</pre>
<p>Update the local database so that packages that are not required by any other package are marked as explicitly installed and the other as dependences. You will need to be extra careful in the future when removing packages, but with the original database lost, it is the best we can do.
</p>
<pre># pacman -D --asdeps $(pacman -Qq)
# pacman -D --asexplicit $(pacman -Qtq)
</pre>
<p>Optionally check all installed packages for corruption:
</p>
<pre># pacman -Qk
</pre>
<p>Optionally <a href="../../en/Pacman/Tips_and_tricks.html#Identify_files_not_owned_by_any_package" title="Pacman/Tips and tricks">Pacman/Tips and tricks#Identify files not owned by any package</a>.
</p>
<p>Update all packages:
</p>
<pre># pacman -Su
</pre>
</div>
</div>
					<div id="catlinks" class="catlinks" data-mw="interface"><div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../../Special:Categories.html" title="Special:Categories">Category</a>: <ul><li><a href="../../en/Category:Package_manager.html" title="Category:Package manager">Package manager</a></li></ul>
</div></div>
				</div>
			</main>
			
		</div>
		<div class="mw-footer-container">
			
<footer id="footer" class="mw-footer" role="contentinfo" style="margin: 0">
	<ul id="footer-info">
	<li data-nosnippet="">Retrieved from "<a dir="ltr" href="https://wiki.archlinux.org/index.php?title=Pacman/Restore_local_database&amp;oldid=806981">https://wiki.archlinux.org/index.php?title=Pacman/Restore_local_database&amp;oldid=806981</a>"</li>
<li id="footer-info-lastmod"> This page was last edited on 28 April 2024, at 09:23.</li>
	<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="https://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.3 or later</a> unless otherwise noted.</li>
<br>
</ul>

	<ul id="footer-places">
	<li id="footer-places-privacy"><a href="https://terms.archlinux.org/docs/privacy-policy/">Privacy policy</a></li>
	<li id="footer-places-about"><a href="../../en/ArchWiki:About.html">About ArchWiki</a></li>
	<li id="footer-places-disclaimers"><a href="../../en/ArchWiki:General_disclaimer.html">Disclaimers</a></li>
	<li id="footer-places-archwiki-code-of-conduct"><a href="https://terms.archlinux.org/docs/code-of-conduct/" class="extiw" title="archlinux-service-agreements:code-of-conduct">Code of conduct</a></li>
	<li id="footer-places-archwiki-terms-of-service"><a href="https://terms.archlinux.org/docs/terms-of-service/" class="extiw" title="archlinux-service-agreements:terms-of-service">Terms of service</a></li>
</ul>

	<ul id="footer-icons" class="noprint">
	<li id="footer-copyrightico"><a href="https://www.gnu.org/copyleft/fdl.html"><img src="/resources/assets/licenses/gnu-fdl.png" alt="GNU Free Documentation License 1.3 or later" width="88" height="31" loading="lazy"></a></li>
	<li id="footer-poweredbyico"><img src="/resources/assets/poweredby_mediawiki_88x31.png" srcset="/resources/assets/poweredby_mediawiki_132x47.png 1.5x, /resources/assets/poweredby_mediawiki_176x62.png 2x" width="88" height="31" loading="lazy"></li>
</ul>

</footer>

		</div>
	</div> 
</div> 
<div class="vector-settings" id="p-dock-bottom">
	<ul>
		<li>
		<button class="cdx-button cdx-button--icon-only vector-limited-width-toggle" id=""><span class="vector-icon mw-ui-icon-fullScreen mw-ui-icon-wikimedia-fullScreen"></span>

<span>Toggle limited content width</span>
</button>
</li>
	</ul>
</div>
</body>
</html>
