<!DOCTYPE html>
<html class="client-nojs vector-feature-language-in-header-enabled vector-feature-language-in-main-page-header-disabled vector-feature-sticky-header-disabled vector-feature-page-tools-pinned-disabled vector-feature-toc-pinned-clientpref-1 vector-feature-main-menu-pinned-disabled vector-feature-limited-width-clientpref-1 vector-feature-limited-width-content-enabled vector-feature-custom-font-size-clientpref-0 vector-feature-client-preferences-disabled vector-feature-client-prefs-pinned-disabled vector-feature-night-mode-disabled skin-theme-clientpref-day vector-toc-available" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>nginx - ArchWiki</title>
<link rel="stylesheet" href="../ArchWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<meta name="generator" content="MediaWiki 1.42.1">
<meta name="referrer" content="no-referrer-when-downgrade">
<meta name="robots" content="max-image-preview:standard">
<meta name="format-detection" content="telephone=no">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=0.25, maximum-scale=5.0">
<link rel="icon" href="/favicon.ico">
<link rel="search" type="application/opensearchdescription+xml" href="/opensearch_desc.php" title="ArchWiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.archlinux.org/api.php?action=rsd">
<link rel="license" href="https://www.gnu.org/copyleft/fdl.html">
<link rel="alternate" type="application/atom+xml" title="ArchWiki Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="skin-vector skin-vector-search-vue mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-Nginx rootpage-Nginx skin-vector-2022 action-view skin--responsive">
<a class="mw-jump-link" href="#bodyContent">Jump to content</a>
<div class="vector-header-container">
	</div>
<div class="mw-page-container">
	<div class="mw-page-container-inner">
		<div class="vector-column-start">
			<div class="vector-main-menu-container">
		</div>
	<div class="vector-sticky-pinned-container">
				<nav id="mw-panel-toc" role="navigation" aria-label="Contents" data-event-name="ui.sidebar-toc" class="mw-table-of-contents-container vector-toc-landmark">
					<div id="vector-toc-pinned-container" class="vector-pinned-container">
					<div id="vector-toc" class="vector-toc vector-pinnable-element">
	<div class="vector-pinnable-header vector-toc-pinnable-header vector-pinnable-header-pinned" data-feature-name="toc-pinned" data-pinnable-element-id="vector-toc">
	<h2 class="vector-pinnable-header-label">Contents</h2>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-pin-button" data-event-name="pinnable-header.vector-toc.pin">move to sidebar</button>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-unpin-button" data-event-name="pinnable-header.vector-toc.unpin">hide</button>
</div>


	<ul class="vector-toc-contents" id="mw-panel-toc-list">
		<li id="toc-mw-content-text" class="vector-toc-list-item vector-toc-level-1">
			<a href="#" class="vector-toc-link">
				<div class="vector-toc-text">Beginning</div>
			</a>
		</li>
		<li id="toc-Installation" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#Installation">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">1</span>Installation</div>
		</a>
		
		<ul id="toc-Installation-sublist" class="vector-toc-list">
		</ul>
	</li>
	<li id="toc-Running" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#Running">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">2</span>Running</div>
		</a>
		
		<ul id="toc-Running-sublist" class="vector-toc-list">
		</ul>
	</li>
	<li id="toc-Configuration" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#Configuration">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">3</span>Configuration</div>
		</a>
		
			<button aria-controls="toc-Configuration-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Configuration subsection</span>
			</button>
		
		<ul id="toc-Configuration-sublist" class="vector-toc-list">
			<li id="toc-Configuration_example" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Configuration_example">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.1</span>Configuration example</div>
			</a>
			
			<ul id="toc-Configuration_example-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-General_configuration" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#General_configuration">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.2</span>General configuration</div>
			</a>
			
			<ul id="toc-General_configuration-sublist" class="vector-toc-list">
				<li id="toc-Processes_and_connections" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Processes_and_connections">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.2.1</span>Processes and connections</div>
			</a>
			
			<ul id="toc-Processes_and_connections-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Running_under_different_user" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Running_under_different_user">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.2.2</span>Running under different user</div>
			</a>
			
			<ul id="toc-Running_under_different_user-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Server_blocks" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Server_blocks">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.2.3</span>Server blocks</div>
			</a>
			
			<ul id="toc-Server_blocks-sublist" class="vector-toc-list">
				<li id="toc-Managing_server_entries" class="vector-toc-list-item vector-toc-level-4">
			<a class="vector-toc-link" href="#Managing_server_entries">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.2.3.1</span>Managing server entries</div>
			</a>
			
			<ul id="toc-Managing_server_entries-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-TLS" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#TLS">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.2.4</span>TLS</div>
			</a>
			
			<ul id="toc-TLS-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Per-user_directories" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Per-user_directories">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.2.5</span>Per-user directories</div>
			</a>
			
			<ul id="toc-Per-user_directories-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-FastCGI" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#FastCGI">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.3</span>FastCGI</div>
			</a>
			
			<ul id="toc-FastCGI-sublist" class="vector-toc-list">
				<li id="toc-PHP_implementation" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#PHP_implementation">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.3.1</span>PHP implementation</div>
			</a>
			
			<ul id="toc-PHP_implementation-sublist" class="vector-toc-list">
				<li id="toc-nginx_configuration" class="vector-toc-list-item vector-toc-level-4">
			<a class="vector-toc-link" href="#nginx_configuration">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.3.1.1</span>nginx configuration</div>
			</a>
			
			<ul id="toc-nginx_configuration-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Test_configuration" class="vector-toc-list-item vector-toc-level-4">
			<a class="vector-toc-link" href="#Test_configuration">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.3.1.2</span>Test configuration</div>
			</a>
			
			<ul id="toc-Test_configuration-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-CGI_implementation" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#CGI_implementation">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.3.2</span>CGI implementation</div>
			</a>
			
			<ul id="toc-CGI_implementation-sublist" class="vector-toc-list">
				<li id="toc-fcgiwrap" class="vector-toc-list-item vector-toc-level-4">
			<a class="vector-toc-link" href="#fcgiwrap">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.3.2.1</span>fcgiwrap</div>
			</a>
			
			<ul id="toc-fcgiwrap-sublist" class="vector-toc-list">
				<li id="toc-Multiple_worker_threads" class="vector-toc-list-item vector-toc-level-5">
			<a class="vector-toc-link" href="#Multiple_worker_threads">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.3.2.1.1</span>Multiple worker threads</div>
			</a>
			
			<ul id="toc-Multiple_worker_threads-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-nginx_configuration_2" class="vector-toc-list-item vector-toc-level-4">
			<a class="vector-toc-link" href="#nginx_configuration_2">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.3.2.2</span>nginx configuration</div>
			</a>
			
			<ul id="toc-nginx_configuration_2-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
	</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Installation_in_a_chroot" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#Installation_in_a_chroot">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">4</span>Installation in a chroot</div>
		</a>
		
			<button aria-controls="toc-Installation_in_a_chroot-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Installation in a chroot subsection</span>
			</button>
		
		<ul id="toc-Installation_in_a_chroot-sublist" class="vector-toc-list">
			<li id="toc-Create_necessary_devices" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Create_necessary_devices">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">4.1</span>Create necessary devices</div>
			</a>
			
			<ul id="toc-Create_necessary_devices-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Create_necessary_directories" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Create_necessary_directories">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">4.2</span>Create necessary directories</div>
			</a>
			
			<ul id="toc-Create_necessary_directories-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Populate_the_chroot" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Populate_the_chroot">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">4.3</span>Populate the chroot</div>
			</a>
			
			<ul id="toc-Populate_the_chroot-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Modify_nginx.service_to_start_chroot" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Modify_nginx.service_to_start_chroot">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">4.4</span>Modify nginx.service to start chroot</div>
			</a>
			
			<ul id="toc-Modify_nginx.service_to_start_chroot-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Tips_and_tricks" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#Tips_and_tricks">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">5</span>Tips and tricks</div>
		</a>
		
			<button aria-controls="toc-Tips_and_tricks-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Tips and tricks subsection</span>
			</button>
		
		<ul id="toc-Tips_and_tricks-sublist" class="vector-toc-list">
			<li id="toc-Running_unprivileged_using_systemd" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Running_unprivileged_using_systemd">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">5.1</span>Running unprivileged using systemd</div>
			</a>
			
			<ul id="toc-Running_unprivileged_using_systemd-sublist" class="vector-toc-list">
				<li id="toc-Port" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Port">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">5.1.1</span>Port</div>
			</a>
			
			<ul id="toc-Port-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-PID_file" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#PID_file">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">5.1.2</span>PID file</div>
			</a>
			
			<ul id="toc-PID_file-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-/var/lib/nginx" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#/var/lib/nginx">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">5.1.3</span>/var/lib/nginx</div>
			</a>
			
			<ul id="toc-/var/lib/nginx-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-/var/log/nginx" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#/var/log/nginx">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">5.1.4</span>/var/log/nginx</div>
			</a>
			
			<ul id="toc-/var/log/nginx-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Running_user_service_using_systemd" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Running_user_service_using_systemd">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">5.2</span>Running user service using systemd</div>
			</a>
			
			<ul id="toc-Running_user_service_using_systemd-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Alternative_script_for_systemd" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Alternative_script_for_systemd">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">5.3</span>Alternative script for systemd</div>
			</a>
			
			<ul id="toc-Alternative_script_for_systemd-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Nginx_beautifier" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Nginx_beautifier">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">5.4</span>Nginx beautifier</div>
			</a>
			
			<ul id="toc-Nginx_beautifier-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Better_headers_management" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Better_headers_management">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">5.5</span>Better headers management</div>
			</a>
			
			<ul id="toc-Better_headers_management-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Basic_Authentication" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Basic_Authentication">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">5.6</span>Basic Authentication</div>
			</a>
			
			<ul id="toc-Basic_Authentication-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Using_php-legacy" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Using_php-legacy">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">5.7</span>Using php-legacy</div>
			</a>
			
			<ul id="toc-Using_php-legacy-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Troubleshooting" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#Troubleshooting">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">6</span>Troubleshooting</div>
		</a>
		
			<button aria-controls="toc-Troubleshooting-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Troubleshooting subsection</span>
			</button>
		
		<ul id="toc-Troubleshooting-sublist" class="vector-toc-list">
			<li id="toc-Configuration_validation" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Configuration_validation">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">6.1</span>Configuration validation</div>
			</a>
			
			<ul id="toc-Configuration_validation-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Error:_The_page_you_are_looking_for_is_temporarily_unavailable._Please_try_again_later._(502_Bad_Gateway)" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Error:_The_page_you_are_looking_for_is_temporarily_unavailable._Please_try_again_later._(502_Bad_Gateway)">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">6.2</span>Error: The page you are looking for is temporarily unavailable. Please try again later. (502 Bad Gateway)</div>
			</a>
			
			<ul id="toc-Error:_The_page_you_are_looking_for_is_temporarily_unavailable._Please_try_again_later._(502_Bad_Gateway)-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Error:_No_input_file_specified" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Error:_No_input_file_specified">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">6.3</span>Error: No input file specified</div>
			</a>
			
			<ul id="toc-Error:_No_input_file_specified-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Warning:_Could_not_build_optimal_types_hash" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Warning:_Could_not_build_optimal_types_hash">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">6.4</span>Warning: Could not build optimal types_hash</div>
			</a>
			
			<ul id="toc-Warning:_Could_not_build_optimal_types_hash-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Cannot_assign_requested_address" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Cannot_assign_requested_address">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">6.5</span>Cannot assign requested address</div>
			</a>
			
			<ul id="toc-Cannot_assign_requested_address-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-See_also" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#See_also">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">7</span>See also</div>
		</a>
		
		<ul id="toc-See_also-sublist" class="vector-toc-list">
		</ul>
	</li>
</ul>
</div>

					</div>
		</nav>
			</div>
		</div>
		<div class="mw-content-container">
			<main id="content" class="mw-body" role="main" style="margin: 0">
				<header class="mw-body-header vector-page-titlebar">
					<nav role="navigation" aria-label="Contents" class="vector-toc-landmark">
						
<div id="vector-page-titlebar-toc" class="vector-dropdown vector-page-titlebar-toc vector-button-flush-left">
	<input type="checkbox" id="vector-page-titlebar-toc-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-vector-page-titlebar-toc" class="vector-dropdown-checkbox " aria-label="Toggle the table of contents">
	<label id="vector-page-titlebar-toc-label" for="vector-page-titlebar-toc-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--icon-only " aria-hidden="true"><span class="vector-icon mw-ui-icon-listBullet mw-ui-icon-wikimedia-listBullet"></span>

<span class="vector-dropdown-label-text">Toggle the table of contents</span>
	</label>
	<div class="vector-dropdown-content">


							<div id="vector-page-titlebar-toc-unpinned-container" class="vector-unpinned-container">
			</div>
		
	</div>
</div>

					</nav>
					<h1 id="firstHeading" class="firstHeading mw-first-heading">nginx</h1>
							
<div id="p-lang-btn" class="vector-dropdown mw-portlet mw-portlet-lang">
	<input type="checkbox" id="p-lang-btn-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-p-lang-btn" class="vector-dropdown-checkbox mw-interlanguage-selector" aria-label="Go to an article in another language. Available in 4 languages">
	<label id="p-lang-btn-label" for="p-lang-btn-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--action-progressive mw-portlet-lang-heading-4" aria-hidden="true"><span class="vector-icon mw-ui-icon-language-progressive mw-ui-icon-wikimedia-language-progressive"></span>

<span class="vector-dropdown-label-text">4 languages</span>
	</label>
	<div class="vector-dropdown-content">

		<div class="vector-menu-content">
			
			<ul class="vector-menu-content-list">
				
				<li class="interlanguage-link interwiki-de mw-list-item"><a href="https://wiki.archlinux.de/title/Nginx" title="Nginx – Deutsch" lang="de" hreflang="de" class="interlanguage-link-target"><span>Deutsch</span></a></li>
<li class="interlanguage-link interwiki-ja mw-list-item"><a href="https://wiki.archlinux.jp/index.php/Nginx" title="Nginx – 日本語" lang="ja" hreflang="ja" class="interlanguage-link-target"><span>日本語</span></a></li>
<li class="interlanguage-link interwiki-ru mw-list-item"><a href="../ru/Nginx.html" title="Nginx – русский" lang="ru" hreflang="ru" class="interlanguage-link-target"><span>Русский</span></a></li>
<li class="interlanguage-link interwiki-zh-hans mw-list-item"><a href="https://wiki.archlinuxcn.org/wiki/Nginx" title="Nginx – 中文（简体）" lang="zh-Hans" hreflang="zh-Hans" class="interlanguage-link-target"><span>中文（简体）</span></a></li>
			</ul>
			
		</div>

	</div>
</div>
</header>
				<div class="vector-column-end">
					<div class="vector-sticky-pinned-container">
						<nav class="vector-page-tools-landmark" aria-label="Page tools">
							<div id="vector-page-tools-pinned-container" class="vector-pinned-container">
				
							</div>
		</nav>
						<nav class="vector-client-prefs-landmark" aria-label="Appearance">
						</nav>
					</div>
				</div>
				<div id="bodyContent" class="vector-body" aria-labelledby="firstHeading" data-mw-ve-target-container>
					<div class="vector-body-before-content">
							<div class="mw-indicators">
		</div>

						<div id="siteSub" class="noprint">From ArchWiki</div>
					</div>
					<div id="contentSub"><div id="mw-content-subtitle"></div></div>
					
					
					<div id="mw-content-text" class="mw-body-content">
<div class="mw-content-ltr mw-parser-output" lang="en" dir="ltr">
<p><span>
</span>
<a href="https://en.wikipedia.org/wiki/nginx" class="extiw" title="wikipedia:nginx">nginx</a> (pronounced "engine X"), is a free, open-source, high-performance HTTP <a href="../en/List_of_applications/Internet.html#Web_servers" class="mw-redirect" title="Web server">web server</a> and reverse proxy, as well as an IMAP/POP3 proxy server, written by Igor Sysoev in 2005. nginx is well known for its stability, rich feature set, simple configuration, and low resource consumption.
</p>
<p>This article describes how to set up nginx and how to optionally integrate it with <a href="../en/PHP.html" title="PHP">PHP</a> via <a href="#FastCGI">#FastCGI</a>.
</p>
<meta property="mw:PageProp/toc">
<h2><span class="mw-headline" id="Installation">Installation</span></h2>
<p><a href="../en/Help:Reading.html#Installation_of_packages" class="mw-redirect" title="Install">Install</a> one of the following packages:
</p>
<ul>
<li>
<span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=nginx-mainline">nginx-mainline</a></span> - mainline branch: new features, updates, bugfixes.</li>
<li>
<span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=nginx">nginx</a></span> - stable branch: major bugfixes only.</li>
<li>
<span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/angie/">angie</a></span><sup><small>AUR</small></sup> - fork and drop-in replacement for nginx with more features.</li>
<li>
<span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/freenginx-mainline/">freenginx-mainline</a></span><sup><small>AUR</small></sup> - drop-in replacement that preserves the free and open development of nginx (mainline branch).</li>
<li>
<span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/freenginx-libressl/">freenginx-libressl</a></span><sup><small>AUR</small></sup> - drop-in replacement that preserves the free and open development of nginx (mainline branch with <a href="../en/Transport_Layer_Security.html#Implementations" class="mw-redirect" title="LibreSSL">LibreSSL</a> support).</li>
<li>
<span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/freenginx/">freenginx</a></span><sup><small>AUR</small></sup> - drop-in replacement that preserves the free and open development of nginx (stable branch).</li>
</ul>
<p>Using the mainline branch is recommended. The main reason to use the stable branch is that you are concerned about possible impacts of new features, such as incompatibility with third-party modules or the inadvertent introduction of bugs in <a rel="nofollow" class="external text" href="https://nginx.org/en/download.html">new features</a>.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> All nginx modules available in the <a href="../en/Official_repositories.html" title="Official repositories">official repositories</a> require the <i>nginx</i> package (as opposed to <i>nginx-mainline</i>) as a dependency. It may be wise to review the list of modules for any you might need/want before making the <i>nginx</i> vs <i>nginx-mainline</i> decision. Modules for <i>nginx-mainline</i> can be found in the <a href="../en/Arch_User_Repository.html" title="Arch User Repository">Arch User Repository</a>.</div>
<p>For a chroot-based installation for additional security, see <a href="#Installation_in_a_chroot">#Installation in a chroot</a>.
</p>
<h2><span class="mw-headline" id="Running">Running</span></h2>
<p><a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Start/enable">Start/enable</a> <code>nginx.service</code> or <code>angie.service</code> if you use Angie.
</p>
<p>The default page served at <a rel="nofollow" class="external free" href="http://127.0.0.1">http://127.0.0.1</a> is <code>/usr/share/nginx/html/index.html</code>.
</p>
<h2><span class="mw-headline" id="Configuration">Configuration</span></h2>
<p>First steps with nginx are described in the <a rel="nofollow" class="external text" href="https://nginx.org/en/docs/beginners_guide.html">Beginner’s Guide</a>. You can modify the configuration by editing the files in <code>/etc/nginx/</code> The main configuration file is located at <code>/etc/nginx/nginx.conf</code>.
</p>
<p>More details and examples can be found in <a rel="nofollow" class="external free" href="https://wiki.nginx.org/Configuration">https://wiki.nginx.org/Configuration</a><sup title="Last check status: domain name not resolved">[<a href="https://en.wikipedia.org/wiki/Wikipedia:Link_rot" class="extiw" title="wikipedia:Wikipedia:Link rot">dead link</a> 2024-07-30 ⓘ]</sup> and the <a rel="nofollow" class="external text" href="https://nginx.org/en/docs/">official documentation</a>.
</p>
<p>The examples below cover the most common use cases. It is assumed that you use the default location for documents (<code>/usr/share/nginx/html</code>). If that is not the case, substitute your path instead.
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> A <a rel="nofollow" class="external text" href="https://www.digitalocean.com/community/tools/nginx/">Nginx configuration tool</a> has been provided by DigitalOcean.</div>
<h3><span class="mw-headline" id="Configuration_example">Configuration example</span></h3>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/nginx/nginx.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">user http;
worker_processes auto;
worker_cpu_affinity auto;

events {
    multi_accept on;
    worker_connections 1024;
}

http {
    charset utf-8;
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    server_tokens off;
    log_not_found off;
    types_hash_max_size 4096;
    client_max_body_size 16M;

    # MIME
    include mime.types;
    default_type application/octet-stream;

    # logging
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log warn;

    # load configs
    include /etc/nginx/conf.d/*.conf;
    include /etc/nginx/sites-enabled/*;
}
</pre>
<h3><span class="mw-headline" id="General_configuration">General configuration</span></h3>
<h4><span class="mw-headline" id="Processes_and_connections">Processes and connections</span></h4>
<p>You should choose a fitting value for <code>worker_processes</code>. This setting ultimately defines how many connections nginx will accept and how many processors it will be able to make use of. Generally, making it the number of hardware threads in your system is a good start. Alternatively, <code>worker_processes</code> accepts the <code>auto</code> value since versions 1.3.8 and 1.2.5, which will try to autodetect the optimal value (<a rel="nofollow" class="external text" href="https://nginx.org/en/docs/ngx_core_module.html#worker_processes">source</a>).
</p>
<p>The maximum connections nginx will accept is given by <code>max_clients = worker_processes * worker_connections</code>.
</p>
<h4><span class="mw-headline" id="Running_under_different_user">Running under different user</span></h4>
<p>By default, <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=nginx">nginx</a></span> runs the master process as <code>root</code> and worker processes as user <code>http</code>. To run worker processes as another user, change the <code>user</code> directive in <code>nginx.conf</code>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/nginx/nginx.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">user <i>user</i> [<i>group</i>];
</pre>
<p>If the group is omitted, a group whose name equals that of <i>user</i> is used.
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> It is also possible to run nginx without anything running as <code>root</code> using <a href="../en/Systemd.html" title="Systemd">systemd</a>. See <a href="#Running_unprivileged_using_systemd">#Running unprivileged using systemd</a> and <a href="#Running_user_service_using_systemd">#Running user service using systemd</a>.</div>
<h4><span class="mw-headline" id="Server_blocks">Server blocks</span></h4>
<p>It is possible to serve multiple domains using <code>server</code> blocks. These are comparable to "VirtualHosts" in <a href="../en/Apache_HTTP_Server.html" title="Apache HTTP Server">Apache HTTP Server</a>. Also see the <a rel="nofollow" class="external text" href="https://www.nginx.com/resources/wiki/start/topics/examples/server_blocks/">upstream examples</a>.
</p>
<p>In the example below the server listens for incoming connections on IPv4 and IPv6 ports 80 for two domains, <code>domainname1.tld</code> and <code>domainname2.tld</code>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/nginx/nginx.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">...
server {
    listen 80;
    listen [::]:80;
    server_name domainname1.tld;
    root /usr/share/nginx/domainname1.tld/html;
    location / {
        index index.php index.html index.htm;
    }
}

server {
    listen 80;
    listen [::]:80;
    server_name domainname2.tld;
    root /usr/share/nginx/domainname2.tld/html;
    ...
}
</pre>
<p><a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Restart">Restart</a> <code>nginx.service</code> to apply any changes.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> Make sure the hostnames are resolvable by setting up a DNS-server like <a href="../en/BIND.html" title="BIND">BIND</a> or <a href="../en/Dnsmasq.html" title="Dnsmasq">dnsmasq</a>, or have a look at <a href="../en/Network_configuration.html#Local_network_hostname_resolution" title="Network configuration">Network configuration#Local network hostname resolution</a>.</div>
<h5><span class="mw-headline" id="Managing_server_entries">Managing server entries</span></h5>
<p>It is possible to put different <code>server</code> blocks in different files. This allows you to easily enable or disable certain sites.
</p>
<div class="noprint archwiki-template-message">
<p><span class="mw-default-size" typeof="mw:File"><span><img src="../File:Inaccurate.svg" decoding="async" width="48" height="48" class="mw-file-element"></span></span><b>The factual accuracy of this article or section is disputed.</b></p>
<div>
<b>Reason:</b> It is contested if the below approach using <code>sites-enabled</code> and <code>sites-available</code> is still useful and doesn't create more problems, see <a rel="nofollow" class="external text" href="https://serverfault.com/questions/527630/difference-in-sites-available-vs-sites-enabled-vs-conf-d-directories-nginx">comparing the two approaches</a> and <a rel="nofollow" class="external text" href="https://stackoverflow.com/questions/45660042/nginx-proxy-pass-leads-to-404-not-found-page/45789055">example of problems arising through sites-enabled and sites-available approach</a>.
<p>Instead, one can just create files inside <code>etc/nginx/conf.d/</code> which adheres to the standard of drop in configuration files. Then, include <code>include /etc/nginx/conf.d/*.conf</code> in the main config file, similar to including other file patterns in other directories as shown below. This way, sites can be disabled just be renaming them to e.g. <code>original_name.conf.disabled</code>, since only files ending in <i>.conf</i> are included.
</p>
 (Discuss in <a rel="nofollow" class="external text" href="../en/Talk:Nginx.html">Talk:Nginx</a>)</div>
</div>
<p>For using the <code>sites-enabled</code> and <code>sites-available</code> approach, create the following directories:
</p>
<pre># mkdir /etc/nginx/sites-available
# mkdir /etc/nginx/sites-enabled
</pre>
<p>Create a file inside the <code>sites-available</code> directory that contains one or more server blocks:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/nginx/sites-available/example.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">server {
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;

    ...
}
</pre>
<p>Append <code>include sites-enabled/*;</code> to the end of the <code>http</code> block:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/nginx/nginx.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">http {
    ...
    include sites-enabled/*;
}
</pre>
<p>To enable a site, simply create a symlink:
</p>
<pre># ln -s /etc/nginx/sites-available/example.conf /etc/nginx/sites-enabled/example.conf
</pre>
<p>To disable a site, unlink the active symlink:
</p>
<pre># unlink /etc/nginx/sites-enabled/example.conf
</pre>
<p><a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Reload">Reload</a>/<a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Restart">restart</a> <code>nginx.service</code> to enable changes to the site's configuration.
</p>
<h4><span class="mw-headline" id="TLS">TLS</span></h4>
<div class="noprint archwiki-template-message">
<p><span class="mw-default-size" typeof="mw:File"><span><img src="../File:Tango-edit-clear.svg" decoding="async" width="48" height="48" class="mw-file-element"></span></span><b>This article or section needs language, wiki syntax or style improvements. See <a href="../en/Help:Style.html" title="Help:Style">Help:Style</a> for reference.</b></p>
<div>
<b>Reason:</b> Do not duplicate <a href="../en/OpenSSL.html#Usage" title="OpenSSL">OpenSSL#Usage</a>. (Discuss in <a rel="nofollow" class="external text" href="../en/Talk:Nginx.html">Talk:Nginx</a>)</div>
</div>
<p><a href="../en/OpenSSL.html" title="OpenSSL">OpenSSL</a> provides TLS support and is installed by default on Arch installations.
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> 
<ul>
<li>You may want to read the <a rel="nofollow" class="external text" href="https://nginx.org/en/docs/http/ngx_http_ssl_module.html">ngx_http_ssl_module</a> documentation first before configuring SSL.</li>
<li>
<a href="../en/Certbot.html" class="mw-redirect" title="Let’s Encrypt">Let’s Encrypt</a> is a free, automated, and open certificate authority. A plugin is available to request valid SSL certificates straight from the command line and automatic configuration.</li>
<li>Mozilla has a useful <a href="https://wiki.mozilla.org/Security/Server_Side_TLS" class="extiw" title="mozillawiki:Security/Server Side TLS">TLS article</a> as well as an <a rel="nofollow" class="external text" href="https://mozilla.github.io/server-side-tls/ssl-config-generator/">automated tool</a> to help create a more secure configuration.</li>
</ul>
</div>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> If you plan on implementing TLS, know that some variations and implementations are <a href="https://en.wikipedia.org/wiki/Transport_Layer_Security#Attacks_against_TLS.2FSSL" class="extiw" title="wikipedia:Transport Layer Security">still vulnerable to attack</a><a rel="nofollow" class="external autonumber" href="https://weakdh.org/#affected">[1]</a>. For details on these current vulnerabilities within TLS and how to apply appropriate changes to nginx, visit <a rel="nofollow" class="external free" href="https://weakdh.org/sysadmin.html">https://weakdh.org/sysadmin.html</a>
</div>
<p>Create a private key and self-signed certificate. This is adequate for most installations that do not require a <a href="../en/OpenSSL.html#Generate_a_certificate_signing_request" title="OpenSSL">CSR</a>:
</p>
<pre># mkdir /etc/nginx/ssl
# cd /etc/nginx/ssl
# openssl req -new -x509 -nodes -newkey rsa:4096 -keyout server.key -out server.crt -days 1095
# chmod 400 server.key
# chmod 444 server.crt
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> The <code>-days</code> switch is optional and RSA keysize can be as low as 2048 (default).</div>
<p>If you need to create a CSR, follow these instructions instead of the above:
</p>
<pre># mkdir /etc/nginx/ssl
# cd /etc/nginx/ssl
# openssl genpkey -algorithm RSA -pkeyopt rsa_keygen_bits:4096 -out server.key
# chmod 400 server.key
# openssl req -new -sha256 -key server.key -out server.csr
# openssl x509 -req -days 1095 -in server.csr -signkey server.key -out server.crt
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> For more <i>openssl</i> options, read its man page <span class="plainlinks archwiki-template-man" title="$ man 1ssl openssl"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/openssl.1ssl">openssl(1ssl)</a></span> or peruse its <a rel="nofollow" class="external text" href="https://www.openssl.org/docs/">extensive documentation</a>.</div>
<p>A starting point for a <code>/etc/nginx/nginx.conf</code> with TLS is <a rel="nofollow" class="external text" href="https://ssl-config.mozilla.org/#server=nginx">Mozilla's SSL Configuration Generator</a>.
</p>
<p><a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Restart">Restart</a> <code>nginx.service</code> to apply any changes.
</p>
<h4><span class="mw-headline" id="Per-user_directories">Per-user directories</span></h4>
<p>To replicate Apache-style <code>~user</code> URLs to users' <code>~/public_html</code> directories, try the following. (Note: if both rules are used, below, the more-specific PHP rule must come first.)
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/nginx/nginx.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">...
server {
    ...
    # PHP in user directories, e.g. http://example.com/~user/test.php
    location ~ ^/~(.+?)(/.+\.php)$ {
        alias          /home/$1/public_html$2;
        fastcgi_pass   unix:/run/php-fpm/php-fpm.sock;
        fastcgi_index  index.php;
        include        fastcgi.conf;
    }

    # User directories, e.g. http://example.com/~user/
    location ~ ^/~(.+?)(/.*)?$ {
        alias     /home/$1/public_html$2;
        index     index.html index.htm;
        autoindex on;
    }
    ...
}
...
</pre>
<p>See <a href="#PHP_implementation">#PHP implementation</a> for more information on PHP configuration with <code>nginx</code>.
</p>
<p><a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Restart">Restart</a> <code>nginx.service</code> to enable the new configuration.
</p>
<h3><span class="mw-headline" id="FastCGI">FastCGI</span></h3>
<p><a href="https://en.wikipedia.org/wiki/FastCGI" class="extiw" title="wikipedia:FastCGI">FastCGI</a>, also FCGI, is a protocol for interfacing interactive programs with a web server. FastCGI is a variation on the earlier <a href="https://en.wikipedia.org/wiki/Common_Gateway_Interface" class="extiw" title="wikipedia:Common Gateway Interface">Common Gateway Interface</a> (CGI); FastCGI's main aim is to reduce the overhead associated with interfacing the web server and CGI programs, allowing servers to handle more web page requests at once.
</p>
<p>FastCGI technology is introduced into nginx to work with many external tools, e.g. <a href="../en/Perl.html" title="Perl">Perl</a>, <a href="../en/PHP.html" title="PHP">PHP</a> and <a href="../en/Python.html" title="Python">Python</a>.
</p>
<h4><span class="mw-headline" id="PHP_implementation">PHP implementation</span></h4>
<p><a rel="nofollow" class="external text" href="https://php-fpm.org/">PHP-FPM</a> is the recommended solution to run as FastCGI server for <a href="../en/PHP.html" title="PHP">PHP</a>.
</p>
<p><a href="../en/Help:Reading.html#Installation_of_packages" class="mw-redirect" title="Install">Install</a> <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=php-fpm">php-fpm</a></span> and make sure <a href="../en/PHP.html" title="PHP">PHP</a> has been installed and configured correctly. The main configuration file of PHP-FPM is <code>/etc/php/php-fpm.conf</code>. For basic usage the default configuration should be sufficient.
</p>
<p>Finally, <a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Start/enable">start/enable</a> <code>php-fpm.service</code>.
</p>
<p>You can also use <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=php-legacy-fpm">php-legacy-fpm</a></span> instead, see <a href="#Using_php-legacy">#Using php-legacy</a>.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> 
<ul>
<li>If you <a href="#Running_under_different_user">run nginx under a different user</a>, make sure that the PHP-FPM socket file is accessible by this user, or use a TCP socket.</li>
<li>If you run nginx in chrooted environment (chroot is <code>/srv/nginx-jail</code>, web pages are served at <code>/srv/nginx-jail/www</code>), you must modify the file <code>/etc/php/php-fpm.conf</code> to include the <code>chroot = /srv/nginx-jail</code> and <code>listen = /srv/nginx-jail/run/php-fpm/php-fpm.sock</code> directives within the pool section (a default one is <code>[www]</code>). Create the directory for the socket file, if missing. Moreover, for modules that are dynamically linked to dependencies, you will need to copy those dependencies to the chroot (e.g. for php-imagick, you will need to copy the ImageMagick libraries to the chroot, but not imagick.so itself).</li>
</ul>
</div>
<h5><span class="mw-headline" id="nginx_configuration">nginx configuration</span></h5>
<p>When serving a PHP web-application, a <code>location</code> for PHP-FPM should to be included in each <a href="#Server_blocks">server block</a> <a rel="nofollow" class="external autonumber" href="https://www.nginx.com/resources/wiki/start/topics/examples/phpfcgi/">[2]</a>, e.g.:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/nginx/sites-available/example.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">server {
    root /usr/share/nginx/html;

    location / {
        index index.html index.htm index.php;
    }

    location ~ \.php$ {
        # 404
        try_files $fastcgi_script_name =404;

        # default fastcgi_params
        include fastcgi_params;

        # fastcgi settings
        fastcgi_pass			unix:/run/php-fpm/php-fpm.sock;
        fastcgi_index			index.php;
        fastcgi_buffers			8 16k;
        fastcgi_buffer_size		32k;

        # fastcgi params
        fastcgi_param DOCUMENT_ROOT	$realpath_root;
        fastcgi_param SCRIPT_FILENAME	$realpath_root$fastcgi_script_name;
        #fastcgi_param PHP_ADMIN_VALUE	"open_basedir=$base/:/usr/lib/php/:/tmp/";
    }
}</pre>
<p>If it is needed to process other extensions with PHP (e.g. <i>.html</i> and <i>.htm</i>):
</p>
<pre>location ~ [^/]\.(php|html|htm)(/|$) {
    ...
}
</pre>
<p>Non <i>.php</i> extension processing in PHP-FPM should also be explicitly added in <code>/etc/php/php-fpm.d/www.conf</code>:
</p>
<pre>security.limit_extensions = .php .html .htm
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> Pay attention to the <code>fastcgi_pass</code> argument, as it must be the TCP or Unix socket defined by the chosen FastCGI server in its configuration file. The <b>default</b> (Unix) socket for <code>php-fpm</code> is:
<pre>fastcgi_pass unix:/run/php-fpm/php-fpm.sock;
</pre>
<p>You might use the common TCP socket, <b>not default</b>,
</p>
<pre>fastcgi_pass 127.0.0.1:9000;
</pre>
Unix domain sockets should however be faster.</div>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> To allow multiple <code>server</code> blocks using the same PHP-FPM configuration, a <code>php_fastcgi.conf</code> configuration file may be used to ease management:
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/nginx/php_fastcgi.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">location ~ \.php$ {
    # 404
    try_files $fastcgi_script_name =404;

    # default fastcgi_params
    include fastcgi_params;

    # fastcgi settings
    ...
}</pre>
<p>To enable PHP support for a particular server, simply include the <code>php_fastcgi.conf</code> configuration file:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/nginx/sites-available/example.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">server {
    server_name example.com;
    ...

    include /etc/nginx/php_fastcgi.conf;
}
</pre>
</div>
<h5><span class="mw-headline" id="Test_configuration">Test configuration</span></h5>
<p>You need to <a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Restart">restart</a> the <code>php-fpm.service</code> and <code>nginx.service</code> units if the configuration has been changed in order to apply changes.
</p>
<p>To test the FastCGI implementation, create a new PHP file inside the <code>root</code> folder containing:
</p>
<pre>&lt;?php phpinfo(); ?&gt;
</pre>
<p>Navigate this file inside a browser and you should see the informational page with the current PHP configuration.
</p>
<h4><span class="mw-headline" id="CGI_implementation">CGI implementation</span></h4>
<p>This implementation is needed for CGI applications.
</p>
<h5><span class="mw-headline" id="fcgiwrap">fcgiwrap</span></h5>
<p><a href="../en/Help:Reading.html#Installation_of_packages" class="mw-redirect" title="Install">Install</a> <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=fcgiwrap">fcgiwrap</a></span>. The configuration is done by <a href="../en/Systemd.html#Editing_provided_units" class="mw-redirect" title="Edit">editing</a> <code>fcgiwrap.socket</code>. <a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Enable">Enable</a> and <a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Start">start</a> <code>fcgiwrap.socket</code>.
</p>
<h6><span class="mw-headline" id="Multiple_worker_threads">Multiple worker threads</span></h6>
<p>If you want to spawn multiple worker threads, it is recommended that you use <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/multiwatch/">multiwatch</a></span><sup><small>AUR</small></sup>, which will take care of restarting crashed children. You will need to use <code>spawn-fcgi</code> to create the Unix socket, as multiwatch seems unable to handle the systemd-created socket, even though fcgiwrap itself does not have any trouble if invoked directly in the unit file.
</p>
<p><a href="../en/Systemd.html#Replacement_unit_files" class="mw-redirect" title="Override the unit">Override the unit</a> <code>fcgiwrap.service</code> (and the <code>fcgiwrap.socket</code> unit, if present), and modify the <code>ExecStart</code> line to suit your needs. Here is a unit file that uses <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/multiwatch/">multiwatch</a></span><sup><small>AUR</small></sup>. Make sure <code>fcgiwrap.socket</code> is not started or enabled, because it will conflict with this unit:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/fcgiwrap.service</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Unit]
Description=Simple CGI Server
After=nss-user-lookup.target

[Service]
ExecStartPre=/bin/rm -f /run/fcgiwrap.socket
ExecStart=/usr/bin/spawn-fcgi -u http -g http -s /run/fcgiwrap.sock -n -- /usr/bin/multiwatch -f 10 -- /usr/sbin/fcgiwrap
ExecStartPost=/usr/bin/chmod 660 /run/fcgiwrap.sock
PrivateTmp=true
Restart=on-failure

[Install]
WantedBy=multi-user.target</pre>
<p>Tweak <code>-f 10</code> to change the number of children that are spawned.
</p>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> The <code>ExecStartPost</code> line is required because of strange behaviour I'm seeing when I use the <code>-M 660</code> option for <code>spawn-fcgi</code>. The wrong mode is set. This may be a bug?</div>
<h5><span class="mw-headline" id="nginx_configuration_2">nginx configuration</span></h5>
<p>In <code>/etc/nginx</code>, copy the file <code>fastcgi_params</code> to <code>fcgiwrap_params</code>. In <code>fcgiwrap_params</code>, comment or delete the lines which set <code>SCRIPT_NAME</code> and <code>DOCUMENT_ROOT</code>.
</p>
<p>Inside each <code>server</code> block serving a CGI web application should appear a <code>location</code> block similar to:
</p>
<pre>location ~ \.cgi$ {
     include       fcgiwrap_params;
     fastcgi_param DOCUMENT_ROOT /srv/www/cgi-bin/;
     fastcgi_param SCRIPT_NAME   myscript.cgi;
     fastcgi_pass  unix:/run/fcgiwrap.sock;
}
</pre>
<p>The default socket file for <code>fcgiwrap</code> is <code>/run/fcgiwrap.sock</code>.
</p>
<p>Using <code>fastcgi_param SCRIPT_FILENAME /srv/www/cgi-bin/myscript.cgi</code> is a shortcut alternative to setting <code>DOCUMENT_ROOT</code> and <code>SCRIPT_NAME</code>. If you use <code>SCRIPT_FILENAME</code>, you also will not need to copy <code>fastcgi_params</code> to <code>fcgiwrap_params</code> and comment out the <code>DOCUMENT_ROOT</code> and <code>SCRIPT_NAME</code> lines.
</p>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> If SCRIPT_NAME and DOCUMENT_ROOT are used, fcgiwrap will <i>discard</i> any other fastcgi_params set in nginx. You must use SCRIPT_FILENAME in order for other params (like PATH_INFO) to be settable through the Nginx configuration. See <a rel="nofollow" class="external text" href="https://github.com/gnosek/fcgiwrap/issues/3">this</a> GitHub issue.</div>
<p>If you keep getting a <code>502 - bad Gateway</code> error, you should check if your CGI-application first announces the mime-type of the following content. For HTML this needs to be <code>Content-type: text/html</code>.
</p>
<p>If you get 403 errors, make sure that the CGI executable is readable and executable by the <code>http</code> user and that every parent folder is readable by the <code>http</code> user.
</p>
<h2><span class="mw-headline" id="Installation_in_a_chroot">Installation in a chroot</span></h2>
<div class="noprint archwiki-template-message">
<p><span class="mw-default-size" typeof="mw:File"><span><img src="../File:Inaccurate.svg" decoding="async" width="48" height="48" class="mw-file-element"></span></span><b>The factual accuracy of this article or section is disputed.</b></p>
<div>
<b>Reason:</b> This section is from 2013. systemd has since been introduced and can be used instead, at much greater efficiency and without much hassle. (Discuss in <a rel="nofollow" class="external text" href="../en/Talk:Nginx.html">Talk:Nginx</a>)</div>
</div>
<p>Installing nginx in a <a href="../en/Chroot.html" title="Chroot">chroot</a> adds an additional layer of security. For maximum security the chroot should include only the files needed to run the nginx server and all files should have the most restrictive permissions possible, e.g., as much as possible should be owned by root, directories such as <code>/usr/bin</code> should be unreadable and unwritable, etc.
</p>
<p>Arch comes with an <code>http</code> user and group by default which will run the server. The chroot will be in <code>/srv/http</code>.
</p>
<p>A PERL script to create this jail is available at <a rel="nofollow" class="external text" href="https://gist.github.com/4365696">jail.pl gist</a>. You can either use that or follow the instructions in this article. It expects to be run as root. You will need to uncomment a line before it makes any changes.
</p>
<h3><span class="mw-headline" id="Create_necessary_devices">Create necessary devices</span></h3>
<p>nginx needs <code>/dev/null</code>, <code>/dev/random</code>, and <code>/dev/urandom</code>. To install these in the chroot create the <code>/dev/</code> directory and add the devices with <i>mknod</i>. Avoid mounting all of <code>/dev/</code> to ensure that, even if the chroot is compromised, an attacker must break out of the chroot to access important devices like <code>/dev/sda1</code>.
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> 
<ul>
<li>Be sure that <code>/srv/http</code> is mounted without the nodev option</li>
<li>See <span class="plainlinks archwiki-template-man" title="$ man 1 mknod"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/mknod.1">mknod(1)</a></span> and <code>ls -l /dev/{null,random,urandom}</code> to better understand the <i>mknod</i> options.</li>
</ul>
</div>
<pre># export JAIL=/srv/http
# mkdir $JAIL/dev
# mknod -m 0666 $JAIL/dev/null c 1 3
# mknod -m 0666 $JAIL/dev/random c 1 8
# mknod -m 0444 $JAIL/dev/urandom c 1 9
</pre>
<h3><span class="mw-headline" id="Create_necessary_directories">Create necessary directories</span></h3>
<p>nginx requires a bunch of files to run properly. Before copying them over, create the folders to store them. This assumes your nginx document root will be <code>/srv/http/www</code>.
</p>
<pre># mkdir -p $JAIL/etc/nginx/logs
# mkdir -p $JAIL/usr/{lib,bin}
# mkdir -p $JAIL/usr/share/nginx
# mkdir -p $JAIL/var/{log,lib}/nginx
# mkdir -p $JAIL/www/cgi-bin
# mkdir -p $JAIL/{run,tmp}
# cd $JAIL; ln -s usr/lib lib
# cd $JAIL; ln -s usr/lib lib64
# cd $JAIL/usr; ln -s lib lib64
</pre>
<p>Then mount <code>$JAIL/tmp</code> and <code>$JAIL/run</code> as tmpfs's. The size should be limited to ensure an attacker cannot eat all the RAM.
</p>
<pre># mount -t tmpfs none $JAIL/run -o 'noexec,size=1M'
# mount -t tmpfs none $JAIL/tmp -o 'noexec,size=100M'
</pre>
<p>In order to preserve the mounts across reboots, the following entries should be added to <code>/etc/fstab</code>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/fstab</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">tmpfs   /srv/http/run   tmpfs   rw,noexec,relatime,size=1024k   0       0
tmpfs   /srv/http/tmp   tmpfs   rw,noexec,relatime,size=102400k 0       0</pre>
<h3><span class="mw-headline" id="Populate_the_chroot">Populate the chroot</span></h3>
<p>First copy over the easy files.
</p>
<pre># cp -r /usr/share/nginx/* $JAIL/usr/share/nginx
# cp -r /usr/share/nginx/html/* $JAIL/www
# cp /usr/bin/nginx $JAIL/usr/bin/
# cp -r /var/lib/nginx $JAIL/var/lib/nginx
</pre>
<p>Now copy over required libraries. Use <i>ldd</i> to list them and then copy them all to the correct location. Copying is preferred over hardlinks to ensure that even if an attacker gains write access to the files they cannot destroy or alter the true system files.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">$ ldd /usr/bin/nginx</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">linux-vdso.so.1 (0x00007fffc41fe000)
libpthread.so.0 =&gt; /usr/lib/libpthread.so.0 (0x00007f57ec3e8000)
libcrypt.so.1 =&gt; /usr/lib/libcrypt.so.1 (0x00007f57ec1b1000)
libstdc++.so.6 =&gt; /usr/lib/libstdc++.so.6 (0x00007f57ebead000)
libm.so.6 =&gt; /usr/lib/libm.so.6 (0x00007f57ebbaf000)
libpcre.so.1 =&gt; /usr/lib/libpcre.so.1 (0x00007f57eb94c000)
libssl.so.1.0.0 =&gt; /usr/lib/libssl.so.1.0.0 (0x00007f57eb6e0000)
libcrypto.so.1.0.0 =&gt; /usr/lib/libcrypto.so.1.0.0 (0x00007f57eb2d6000)
libdl.so.2 =&gt; /usr/lib/libdl.so.2 (0x00007f57eb0d2000)
libz.so.1 =&gt; /usr/lib/libz.so.1 (0x00007f57eaebc000)
libGeoIP.so.1 =&gt; /usr/lib/libGeoIP.so.1 (0x00007f57eac8d000)
libgcc_s.so.1 =&gt; /usr/lib/libgcc_s.so.1 (0x00007f57eaa77000)
libc.so.6 =&gt; /usr/lib/libc.so.6 (0x00007f57ea6ca000)
/lib64/ld-linux-x86-64.so.2 (0x00007f57ec604000)</pre>
<p>For files residing in <code>/usr/lib</code> you may try the following one-liner:
</p>
<pre># cp $(ldd /usr/bin/nginx | grep /usr/lib/ | sed -sre 's/(.+)(\/usr\/lib\/\S+).+/\2/g') $JAIL/usr/lib
</pre>
<p>And the following for <code>ld-linux-x86-64.so</code>:
</p>
<pre># cp /lib64/ld-linux-x86-64.so.2 $JAIL/lib
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> Do not try to copy <code>linux-vdso.so</code>: it is not a real library and does not exist in <code>/usr/lib</code>.</div>
<p>Copy over some miscellaneous but necessary libraries and system files.
</p>
<pre># cp /usr/lib/libnss_* $JAIL/usr/lib
# cp -rfvL /etc/{services,localtime,nsswitch.conf,nscd.conf,protocols,hosts,ld.so.cache,ld.so.conf,resolv.conf,host.conf,nginx} $JAIL/etc
</pre>
<p>Create restricted user/group files for the chroot. This way only the users needed for the chroot to function exist as far as the chroot knows, and none of the system users/groups are leaked to attackers should they gain access to the chroot.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">$JAIL/etc/group</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">http:x:33:
nobody:x:99:
</pre>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">$JAIL/etc/passwd</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">http:x:33:33:http:/:/bin/false
nobody:x:99:99:nobody:/:/bin/false
</pre>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">$JAIL/etc/shadow</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">http:x:14871::::::
nobody:x:14871::::::
</pre>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">$JAIL/etc/gshadow</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">http:::
nobody:::
</pre>
<pre># touch $JAIL/etc/shells
# touch $JAIL/run/nginx.pid
</pre>
<p>Finally, make set very restrictive permissions. As much as possible should be owned by root and set unwritable.
</p>
<pre># chown -R root:root $JAIL/

# chown -R http:http $JAIL/www
# chown -R http:http $JAIL/etc/nginx
# chown -R http:http $JAIL/var/{log,lib}/nginx
# chown http:http $JAIL/run/nginx.pid

# find $JAIL/ -gid 0 -uid 0 -type d -print | xargs chmod -rw
# find $JAIL/ -gid 0 -uid 0 -type d -print | xargs chmod +x
# find $JAIL/etc -gid 0 -uid 0 -type f -print | xargs chmod -x
# find $JAIL/usr/bin -type f -print | xargs chmod ug+rx
# find $JAIL/ -group http -user http -print | xargs chmod o-rwx
# chmod +rw $JAIL/tmp
# chmod +rw $JAIL/run
</pre>
<p>If your server will bind port 80 (or any other port in range [1-1023]), give the chrooted executable permission to bind these ports without root.
</p>
<pre># setcap 'cap_net_bind_service=+ep' $JAIL/usr/bin/nginx
</pre>
<h3><span class="mw-headline" id="Modify_nginx.service_to_start_chroot">Modify nginx.service to start chroot</span></h3>
<p><a href="../en/Systemd.html#Replacement_unit_files" class="mw-redirect" title="Override the unit">Override the unit</a> <code>nginx.service</code>. Upgrading nginx will not modify your custom <i>.service</i> file.
</p>
<p>The systemd unit must be changed to start up nginx in the chroot, as the http user, and store the PID file in the chroot.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> I'm not sure if the pid file needs to be stored in the chroot jail.</div>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/nginx.service</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Unit]
Description=A high performance web server and a reverse proxy server
After=network.target

[Service]
Type=forking
PIDFile=/srv/http/run/nginx.pid
ExecStartPre=/usr/bin/chroot --userspec=http:http /srv/http /usr/bin/nginx -t -q -g 'pid /run/nginx.pid; daemon on; master_process on;'
ExecStart=/usr/bin/chroot --userspec=http:http /srv/http /usr/bin/nginx -g 'pid /run/nginx.pid; daemon on; master_process on;'
ExecReload=/usr/bin/chroot --userspec=http:http /srv/http /usr/bin/nginx -g 'pid /run/nginx.pid; daemon on; master_process on;' -s reload
ExecStop=/usr/bin/chroot --userspec=http:http /srv/http /usr/bin/nginx -g 'pid /run/nginx.pid;' -s quit

[Install]
WantedBy=multi-user.target</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> Upgrading nginx with pacman will not upgrade the chrooted nginx installation. You have to take care of the updates manually by repeating some of the steps above. Do not forget to also update the libraries it links against.</div>
<p>You can now safely get rid of the non-chrooted nginx installation.
</p>
<pre># pacman -Rsc nginx
</pre>
<p>If you do not remove the non-chrooted nginx installation, you may want to make sure that the running nginx process is in fact the chrooted one. You can do so by checking where <code>/proc/<i>PID</i>/root</code> symlinks to. It should link to <code>/srv/http</code> instead of <code>/</code>.
</p>
<pre># ps -C nginx | awk '{print $1}' | sed 1d | while read -r PID; do ls -l /proc/$PID/root; done
</pre>
<h2><span class="mw-headline" id="Tips_and_tricks">Tips and tricks</span></h2>
<h3><span class="mw-headline" id="Running_unprivileged_using_systemd">Running unprivileged using systemd</span></h3>
<p>Use a <a href="../en/Systemd.html#Drop-in_files" class="mw-redirect" title="Drop-in unit file">drop-in unit file</a> for <code>nginx.service</code> and set the <code>User</code> and optionally <code>Group</code> options under <code>[Service]</code>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/nginx.service.d/user.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Service]
User=<i>user</i>
Group=<i>group</i></pre>
<p>We can harden the service against ever elevating privileges:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/nginx.service.d/user.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Service]
...
NoNewPrivileges=yes</pre>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> See <span class="plainlinks archwiki-template-man" title="$ man 5 systemd.exec"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/systemd.exec.5">systemd.exec(5)</a></span> for more options of confinement.</div>
<p>Then we need to ensure that <code><i>user</i></code> has access to everything it needs. Follow the subsections below and then <a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Start">start</a> nginx.
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> The same setup may be desirable for your <a href="#FastCGI">FastCGI server</a> as well.</div>
<h4><span class="mw-headline" id="Port">Port</span></h4>
<p>Linux does not permit non-<code>root</code> processes to bind to ports below 1024 by default. A port above 1024 can be used:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/nginx/nginx.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">server {
        listen 8080;
}
</pre>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> If you want nginx accessible on port 80 or 443, configure your <a href="../en/Category:Firewalls.html" class="mw-redirect" title="Firewall">firewall</a> to redirect requests from 80 or 443 to the ports nginx listens to.</div>
<p>Or you may grant the nginx process the CAP_NET_BIND_SERVICE capability which allows it to bind to ports below 1024:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/nginx.service.d/user.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Service]
...
CapabilityBoundingSet=
CapabilityBoundingSet=CAP_NET_BIND_SERVICE
AmbientCapabilities=
AmbientCapabilities=CAP_NET_BIND_SERVICE</pre>
<p>Alternatively, you can use systemd socket activation. In this case, systemd will listen on the ports and, when a connection is made, spawn nginx passing the socket as a file descriptor. This means nginx requires no special capabilities as the socket already exists when it is started. This relies on an internal environment variable that nginx uses for passing sockets <a rel="nofollow" class="external autonumber" href="https://trac.nginx.org/nginx/ticket/237">[3]</a> and is therefore not officially supported. Instead of setting <code>CapabilityBoundingSet</code> and <code>AmbientCapabilities</code>, edit the service override to set the <code>NGINX</code> environment variable to tell nginx which file descriptors the sockets will be passed as:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/nginx.service.d/user.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Service]
...
Environment=NGINX=3:4;</pre>
<p>There will be one socket per listening port starting at file descriptor 3, so in this example we are telling nginx to expect two sockets. Now create a <code>nginx.socket</code> unit specifying what ports to listen on:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/nginx.socket</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Socket]
ListenStream=0.0.0.0:80
ListenStream=0.0.0.0:443
After=network.target
Requires=network.target

[Install]
WantedBy=sockets.target</pre>
<p>The sockets will be passed in the order defined in this unit, so port 80 will be file descriptor 3 and port 443 will be file descriptor 4. If you previously enabled or started the service, you should now <a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Stop">stop</a> it, and <a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Enable">enable</a> <code>nginx.socket</code> instead. When your system starts, nginx will not be running, but will be started when you access the website in a browser. With this you can harden the service further; for example, in many cases you can now set <code>PrivateNetwork=True</code> in the service file, blocking nginx from the external network, since the socket created by systemd is sufficient to serve the website over. Note that this will print a warning in the logs of the nginx service: <code>2020/08/29 19:33:20 [notice] 254#254: using inherited sockets from "3:4;"</code>
</p>
<h4><span class="mw-headline" id="PID_file">PID file</span></h4>
<p><span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=nginx">nginx</a></span> is compiled to use <code>/run/nginx.pid</code> by default, which <i>user</i> cannot write to. We can create a directory that <i>user</i> can write to and place the PID file there. This can for example be done with <code>RuntimeDirectory</code> (<span class="plainlinks archwiki-template-man" title="$ man 5 systemd.exec"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/systemd.exec.5">systemd.exec(5)</a></span>).
</p>
<p><a href="../en/Systemd.html#Editing_provided_units" class="mw-redirect" title="Edit">Edit</a> <code>nginx.service</code> to configure the PID file:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/nginx.service.d/user.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Service]
...
RuntimeDirectory=nginx
PIDFile=/run/nginx/nginx.pid
ExecStart=
ExecStart=/usr/bin/nginx -g 'pid /run/nginx/nginx.pid; error_log stderr;' 
ExecReload=
ExecReload=/usr/bin/nginx -s reload -g 'pid /run/nginx/nginx.pid; error_log stderr;'</pre>
<h4>
<span id=".2Fvar.2Flib.2Fnginx"></span><span class="mw-headline" id="/var/lib/nginx">/var/lib/nginx</span>
</h4>
<p><span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=nginx">nginx</a></span> is compiled to store temp files in <code>/var/lib/nginx</code> by default.
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> See all compiled-in options by running <code>$ nginx -V</code>
</div>
<p>You can give <i>user</i> write access to this directory by for example using <code>StateDirectory</code> (<span class="plainlinks archwiki-template-man" title="$ man 5 systemd.exec"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/systemd.exec.5">systemd.exec(5)</a></span>):
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/nginx.service.d/user.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Service]
...
StateDirectory=nginx</pre>
<h4>
<span id=".2Fvar.2Flog.2Fnginx"></span><span class="mw-headline" id="/var/log/nginx">/var/log/nginx</span>
</h4>
<p><span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=nginx">nginx</a></span> is compiled to store access logs in <code>/var/log/nginx</code> by default.
</p>
<p>You can give <i>user</i> write access to this directory by for example using <code>LogsDirectory</code> (<span class="plainlinks archwiki-template-man" title="$ man 5 systemd.exec"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/systemd.exec.5">systemd.exec(5)</a></span>):
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/nginx.service.d/user.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Service]
...
LogsDirectory=nginx</pre>
<h3><span class="mw-headline" id="Running_user_service_using_systemd">Running user service using systemd</span></h3>
<p>If you want to run a server instance fully controlled and configurable by unprivileged user, consider using <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/nginx-user-service/">nginx-user-service</a></span><sup><small>AUR</small></sup>.
</p>
<h3><span class="mw-headline" id="Alternative_script_for_systemd">Alternative script for systemd</span></h3>
<p>On pure systemd you can get advantages of chroot + systemd. <a rel="nofollow" class="external autonumber" href="http://0pointer.de/blog/projects/changing-roots.html">[4]</a> Based on set <a rel="nofollow" class="external text" href="https://wiki.nginx.org/CoreModule#user">user group</a><sup title="Last check status: domain name not resolved">[<a href="https://en.wikipedia.org/wiki/Wikipedia:Link_rot" class="extiw" title="wikipedia:Wikipedia:Link rot">dead link</a> 2024-07-30 ⓘ]</sup> and pid with:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/nginx/nginx.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">user http;
pid /run/nginx.pid;</pre>
<p>the absolute path of the file is <code>/srv/http/etc/nginx/nginx.conf</code>.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/nginx.service</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Unit]
Description=nginx (Chroot)
After=network.target

[Service]
Type=forking
PIDFile=/srv/http/run/nginx.pid
RootDirectory=/srv/http
ExecStartPre=/usr/bin/nginx -t -c /etc/nginx/nginx.conf
ExecStart=/usr/bin/nginx -c /etc/nginx/nginx.conf
ExecReload=/usr/bin/nginx -c /etc/nginx/nginx.conf -s reload
ExecStop=/usr/bin/nginx -c /etc/nginx/nginx.conf -s stop

[Install]
WantedBy=multi-user.target</pre>
<p>It is not necessary to set the default location, nginx loads at default <code> -c /etc/nginx/nginx.conf</code>, but it is a good idea.
</p>
<p>Alternatively you can run <b>only</b> <code>ExecStart</code> as chroot with parameter <code>RootDirectoryStartOnly</code> set as <code>yes</code> (see <span class="plainlinks archwiki-template-man" title="$ man 5 systemd.service"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/systemd.service.5">systemd.service(5)</a></span>) or start it before mount point as effective or a systemd path (see <span class="plainlinks archwiki-template-man" title="$ man 5 systemd.path"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/systemd.path.5">systemd.path(5)</a></span>) is available.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/nginx.path</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Unit]
Description=nginx (Chroot) path
[Path]
PathExists=/srv/http/site/Public_html
[Install]
WantedBy=default.target</pre>
<p><a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Enable">Enable</a> the created <code>nginx.path</code> and change the <code>WantedBy=default.target</code> to <code>WantedBy=nginx.path</code> in <code>/etc/systemd/system/nginx.service</code>.
</p>
<p>The <code>PIDFile</code> in unit file allows systemd to monitor process (absolute path required). If it is undesired, you can change to default one-shot type, and delete the reference from the unit file.
</p>
<h3><span class="mw-headline" id="Nginx_beautifier">Nginx beautifier</span></h3>
<p><span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/nginxbeautifier/">nginxbeautifier</a></span><sup><small>AUR</small></sup> is a commandline tool used to beautify and format nginx configuration files.
</p>
<h3><span class="mw-headline" id="Better_headers_management">Better headers management</span></h3>
<p>Nginx has a rather unintuitive header management system where headers can only be defined in one context, any other headers are ignored. To remedy this we can install the <a rel="nofollow" class="external text" href="https://github.com/openresty/headers-more-nginx-module#more_set_headers">headers-more-nginx</a> module.
</p>
<p><a href="../en/Help:Reading.html#Installation_of_packages" class="mw-redirect" title="Install">Install</a> the package <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=nginx-mod-headers-more">nginx-mod-headers-more</a></span> package. This will install the module to <code>/usr/lib/nginx/modules</code> directory.
</p>
<p>To load the module add the following to the top of your main nginx configuration file.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/nginx/nginx.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">load_module "/usr/lib/nginx/modules/ngx_http_headers_more_filter_module.so";
...</pre>
<h3><span class="mw-headline" id="Basic_Authentication">Basic Authentication</span></h3>
<p>Basic authentication requires creation of a password file. The password file can be managed using <code>htpasswd</code> program provided by the <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=apache">apache</a></span> package or using <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/nginx_passwd/">nginx_passwd</a></span><sup><small>AUR</small></sup> which provides <code>nginx-passwd</code> - details available on <a rel="nofollow" class="external text" href="https://github.com/gene-git/nginx_passwd">GitHub source</a>
</p>
<h3><span class="mw-headline" id="Using_php-legacy">Using php-legacy</span></h3>
<p><a href="../en/Help:Reading.html#Installation_of_packages" class="mw-redirect" title="Install">Install</a> <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=php-legacy-fpm">php-legacy-fpm</a></span> instead of <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=php-fpm">php-fpm</a></span> and make sure <a href="../en/PHP.html" title="PHP">PHP</a> has been installed and configured correctly. 
</p>
<p>The main configuration file of PHP-LEGACY-FPM is <code>/etc/php-legacy/php-fpm.conf</code>. For basic usage the default configuration should be sufficient.
</p>
<p>The Unix socket for the <code>fastcgi_pass</code> argument also needs to be adjusted, usually it is:
</p>
<pre>fastcgi_pass unix:/run/php-fpm-legacy/php-fpm.sock;
</pre>
<p>Then <a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Start/enable">start/enable</a> <code>php-legacy-fpm.service</code>.
</p>
<h2><span class="mw-headline" id="Troubleshooting">Troubleshooting</span></h2>
<h3><span class="mw-headline" id="Configuration_validation">Configuration validation</span></h3>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># nginx -t</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: configuration file /etc/nginx/nginx.conf test is successful
</pre>
<h3>
<span id="Error:_The_page_you_are_looking_for_is_temporarily_unavailable._Please_try_again_later._.28502_Bad_Gateway.29"></span><span class="mw-headline" id="Error:_The_page_you_are_looking_for_is_temporarily_unavailable._Please_try_again_later._(502_Bad_Gateway)">Error: The page you are looking for is temporarily unavailable. Please try again later. (502 Bad Gateway)</span>
</h3>
<p>This is because the FastCGI server has not been started, or the socket used has wrong permissions.
</p>
<p>Try <a rel="nofollow" class="external text" href="https://stackoverflow.com/questions/4252368/nginx-502-bad-gateway/16497957#16497957">out this answer</a> to fix the 502 error.
</p>
<p>In Arch Linux, the configuration file mentioned in above link is <code>/etc/php/php-fpm.conf</code>.
</p>
<h3><span class="mw-headline" id="Error:_No_input_file_specified">Error: No input file specified</span></h3>
<p>1. Verify that variable <code>open_basedir</code> in <code>/etc/php/php.ini</code> contains the correct path specified as <code>root</code> argument in <code>nginx.conf</code> (usually <code>/usr/share/nginx/</code>). When using <a rel="nofollow" class="external text" href="https://php-fpm.org/">PHP-FPM</a> as FastCGI server for PHP, you may add <code>fastcgi_param PHP_ADMIN_VALUE "open_basedir=$document_root/:/tmp/:/proc/";</code> in the <code>location</code> block which aims for processing PHP file in <code>nginx.conf</code>.
</p>
<p>2. Another occasion is that, wrong <code>root</code> argument in the <code>location ~ \.php$</code> section in <code>nginx.conf</code>. Make sure the <code>root</code> points to the same directory as it in <code>location /</code> in the same server. Or you may just set root as global, do not define it in any location section.
</p>
<p>3. Check permissions: e.g. <code>http</code> for user/group, <code>755</code> for directories and <code>644</code> for files. Remember the entire path to the <code>html</code> directory should have the correct permissions. See <a href="../en/File_permissions_and_attributes.html#Bulk_chmod" title="File permissions and attributes">File permissions and attributes#Bulk chmod</a> to bulk modify a directory tree. 
</p>
<p>4. You do not have the <code>SCRIPT_FILENAME</code> containing the full path to your scripts. If the configuration of nginx (<code>fastcgi_param SCRIPT_FILENAME</code>) is correct, this kind of error means PHP failed to load the requested script. Usually it is simply a permissions issue, you can just run php-cgi as root:
</p>
<pre># spawn-fcgi -a 127.0.0.1 -p 9000 -f /usr/bin/php-cgi
</pre>
<p>or you should create a group and user to start the php-cgi:
</p>
<pre># groupadd www
# useradd -g www www
# chmod +w /srv/www/nginx/html
# chown -R www:www /srv/www/nginx/html
# spawn-fcgi -a 127.0.0.1 -p 9000 -u www -g www -f /usr/bin/php-cgi
</pre>
<p>5. If you are running php-fpm with chrooted nginx ensure <code>chroot</code> is set correctly within <code>/etc/php-fpm/php-fpm.d/www.conf</code> (or <code>/etc/php-fpm/php-fpm.conf</code> if working on older version)
</p>
<h3><span class="mw-headline" id="Warning:_Could_not_build_optimal_types_hash">Warning: Could not build optimal types_hash</span></h3>
<p>When starting the <code>nginx.service</code>, the process might log the message:
</p>
<pre>[warn] 18872#18872: could not build optimal types_hash, you should increase either types_hash_max_size: 1024 or types_hash_bucket_size: 64; ignoring types_hash_bucket_size
</pre>
<p>To fix this warning, increase the values for these keys inside the <code>http</code> block <a rel="nofollow" class="external autonumber" href="https://nginx.org/en/docs/http/ngx_http_core_module.html#types_hash_max_size">[5]</a> <a rel="nofollow" class="external autonumber" href="https://nginx.org/en/docs/http/server_names.html">[6]</a>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/nginx/nginx.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">http {
    types_hash_max_size 4096;
    server_names_hash_bucket_size 128;
    ...
}
</pre>
<h3><span class="mw-headline" id="Cannot_assign_requested_address">Cannot assign requested address</span></h3>
<p>The full error from <code>nginx.service</code> <a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Unit status">unit status</a> is
</p>
<pre>[emerg] 460#460: bind() to A.B.C.D:443 failed (99: Cannot assign requested address)
</pre>
<p>Even if your nginx unit-file is configured to run after <code>network.target</code> with systemd, nginx may attempt to listen at an address that is configured but not added to any interface yet. Verify that this the case by manually running <a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Start">start</a> for nginx (thereby showing the IP address is configured properly). Configuring nginx to listen to any address will resolve this issue. Now if your use case requires listening to a specific address, one possible solution is to reconfigure systemd.
</p>
<p>To start nginx after all configured network devices are up and assigned an IP address, append <code>network-online.target</code> to <code>After=</code> within <code>nginx.service</code> and <a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Start/enable">start/enable</a> <code>systemd-networkd-wait-online.service</code>.
</p>
<h2><span class="mw-headline" id="See_also">See also</span></h2>
<ul>
<li><a href="../en/WebDAV.html#nginx" title="WebDAV">WebDAV with nginx</a></li>
<li><a rel="nofollow" class="external text" href="https://www.nginx.com/resources/wiki/start/topics/tutorials/config_pitfalls/">nginx configuration pitfalls</a></li>
<li><a rel="nofollow" class="external text" href="https://calomel.org/nginx.html">Very good in-depth 2014 look at nginx security and Reverse Proxying</a></li>
<li><a rel="nofollow" class="external text" href="https://www.tecmint.com/install-nginx-php-mysql-with-mariadb-engine-and-phpmyadmin-in-arch-linux/">Installing LEMP (nginx, PHP, MySQL with MariaDB engine and PhpMyAdmin) in Arch Linux</a></li>
<li><a href="../en/Certbot.html" class="mw-redirect" title="Let’s Encrypt">Using SSL certificates generated with Let's Encrypt</a></li>
</ul>
</div>
</div>
					<div id="catlinks" class="catlinks" data-mw="interface">
<div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../Special:Categories.html" title="Special:Categories">Category</a>: <ul><li><a href="../en/Category:Web_server.html" title="Category:Web server">Web server</a></li></ul>
</div>
<div id="mw-hidden-catlinks" class="mw-hidden-catlinks mw-hidden-cats-hidden">Hidden categories: <ul>
<li><a href="../en/Category:Pages_with_dead_links.html" title="Category:Pages with dead links">Pages with dead links</a></li>
<li><a href="../en/Category:Pages_or_sections_flagged_with_Template:Accuracy.html" title="Category:Pages or sections flagged with Template:Accuracy">Pages or sections flagged with Template:Accuracy</a></li>
<li><a href="../en/Category:Pages_or_sections_flagged_with_Template:Style.html" title="Category:Pages or sections flagged with Template:Style">Pages or sections flagged with Template:Style</a></li>
</ul>
</div>
</div>
				</div>
			</main>
			
		</div>
		<div class="mw-footer-container">
			
<footer id="footer" class="mw-footer" role="contentinfo" style="margin: 0">
	<ul id="footer-info">
	<li data-nosnippet="">Retrieved from "<a dir="ltr" href="https://wiki.archlinux.org/index.php?title=Nginx&amp;oldid=813422">https://wiki.archlinux.org/index.php?title=Nginx&amp;oldid=813422</a>"</li>
<li id="footer-info-lastmod"> This page was last edited on 30 July 2024, at 15:03.</li>
	<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="https://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.3 or later</a> unless otherwise noted.</li>
<br>
</ul>

	<ul id="footer-places">
	<li id="footer-places-privacy"><a href="https://terms.archlinux.org/docs/privacy-policy/">Privacy policy</a></li>
	<li id="footer-places-about"><a href="../en/ArchWiki:About.html">About ArchWiki</a></li>
	<li id="footer-places-disclaimers"><a href="../en/ArchWiki:General_disclaimer.html">Disclaimers</a></li>
	<li id="footer-places-archwiki-code-of-conduct"><a href="https://terms.archlinux.org/docs/code-of-conduct/" class="extiw" title="archlinux-service-agreements:code-of-conduct">Code of conduct</a></li>
	<li id="footer-places-archwiki-terms-of-service"><a href="https://terms.archlinux.org/docs/terms-of-service/" class="extiw" title="archlinux-service-agreements:terms-of-service">Terms of service</a></li>
</ul>

	<ul id="footer-icons" class="noprint">
	<li id="footer-copyrightico"><a href="https://www.gnu.org/copyleft/fdl.html"><img src="/resources/assets/licenses/gnu-fdl.png" alt="GNU Free Documentation License 1.3 or later" width="88" height="31" loading="lazy"></a></li>
	<li id="footer-poweredbyico"><img src="/resources/assets/poweredby_mediawiki_88x31.png" srcset="/resources/assets/poweredby_mediawiki_132x47.png 1.5x, /resources/assets/poweredby_mediawiki_176x62.png 2x" width="88" height="31" loading="lazy"></li>
</ul>

</footer>

		</div>
	</div> 
</div> 
<div class="vector-settings" id="p-dock-bottom">
	<ul>
		<li>
		<button class="cdx-button cdx-button--icon-only vector-limited-width-toggle" id=""><span class="vector-icon mw-ui-icon-fullScreen mw-ui-icon-wikimedia-fullScreen"></span>

<span>Toggle limited content width</span>
</button>
</li>
	</ul>
</div>
</body>
</html>
