<!DOCTYPE html>
<html class="client-nojs vector-feature-language-in-header-enabled vector-feature-language-in-main-page-header-disabled vector-feature-sticky-header-disabled vector-feature-page-tools-pinned-disabled vector-feature-toc-pinned-clientpref-1 vector-feature-main-menu-pinned-disabled vector-feature-limited-width-clientpref-1 vector-feature-limited-width-content-enabled vector-feature-custom-font-size-clientpref-0 vector-feature-appearance-pinned-clientpref-1 vector-feature-night-mode-enabled skin-theme-clientpref-day vector-toc-available" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>KVM - ArchWiki</title>
<link rel="stylesheet" href="../ArchWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<meta name="generator" content="MediaWiki 1.43.1">
<meta name="referrer" content="no-referrer-when-downgrade">
<meta name="robots" content="max-image-preview:standard">
<meta name="format-detection" content="telephone=no">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=0.25, maximum-scale=5.0">
<link rel="search" type="application/opensearchdescription+xml" href="/rest.php/v1/search" title="ArchWiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.archlinux.org/api.php?action=rsd">
<link rel="license" href="https://www.gnu.org/copyleft/fdl.html">
<link rel="alternate" type="application/atom+xml" title="ArchWiki Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="skin--responsive skin-vector skin-vector-search-vue mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-KVM rootpage-KVM skin-vector-2022 action-view">
<a class="mw-jump-link" href="#bodyContent">Jump to content</a>
<div class="vector-header-container">
	</div>
<div class="mw-page-container">
	<div class="mw-page-container-inner">
		<div class="vector-column-start">
			<div class="vector-main-menu-container">
		</div>
	<div class="vector-sticky-pinned-container">
				<nav id="mw-panel-toc" aria-label="Contents" data-event-name="ui.sidebar-toc" class="mw-table-of-contents-container vector-toc-landmark">
					<div id="vector-toc-pinned-container" class="vector-pinned-container">
					<div id="vector-toc" class="vector-toc vector-pinnable-element">
	<div class="vector-pinnable-header vector-toc-pinnable-header vector-pinnable-header-pinned" data-feature-name="toc-pinned" data-pinnable-element-id="vector-toc">
	<h2 class="vector-pinnable-header-label">Contents</h2>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-pin-button" data-event-name="pinnable-header.vector-toc.pin">move to sidebar</button>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-unpin-button" data-event-name="pinnable-header.vector-toc.unpin">hide</button>
</div>


	<ul class="vector-toc-contents" id="mw-panel-toc-list">
		<li id="toc-mw-content-text" class="vector-toc-list-item vector-toc-level-1">
			<a href="#" class="vector-toc-link">
				<div class="vector-toc-text">Beginning</div>
			</a>
		</li>
		<li id="toc-Checking_support_for_KVM" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#Checking_support_for_KVM">
			<div class="vector-toc-text">
				<span class="vector-toc-numb">1</span>
				<span>Checking support for KVM</span>
			</div>
		</a>
		
			<button aria-controls="toc-Checking_support_for_KVM-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Checking support for KVM subsection</span>
			</button>
		
		<ul id="toc-Checking_support_for_KVM-sublist" class="vector-toc-list">
			<li id="toc-Hardware_support" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Hardware_support">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">1.1</span>
					<span>Hardware support</span>
				</div>
			</a>
			
			<ul id="toc-Hardware_support-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Kernel_support" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Kernel_support">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">1.2</span>
					<span>Kernel support</span>
				</div>
			</a>
			
			<ul id="toc-Kernel_support-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Para-virtualization_with_Virtio" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#Para-virtualization_with_Virtio">
			<div class="vector-toc-text">
				<span class="vector-toc-numb">2</span>
				<span>Para-virtualization with Virtio</span>
			</div>
		</a>
		
			<button aria-controls="toc-Para-virtualization_with_Virtio-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Para-virtualization with Virtio subsection</span>
			</button>
		
		<ul id="toc-Para-virtualization_with_Virtio-sublist" class="vector-toc-list">
			<li id="toc-Kernel_support_2" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Kernel_support_2">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">2.1</span>
					<span>Kernel support</span>
				</div>
			</a>
			
			<ul id="toc-Kernel_support_2-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-List_of_para-virtualized_devices" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#List_of_para-virtualized_devices">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">2.2</span>
					<span>List of para-virtualized devices</span>
				</div>
			</a>
			
			<ul id="toc-List_of_para-virtualized_devices-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-How_to_use_KVM" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#How_to_use_KVM">
			<div class="vector-toc-text">
				<span class="vector-toc-numb">3</span>
				<span>How to use KVM</span>
			</div>
		</a>
		
		<ul id="toc-How_to_use_KVM-sublist" class="vector-toc-list">
		</ul>
	</li>
	<li id="toc-Tips_and_tricks" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#Tips_and_tricks">
			<div class="vector-toc-text">
				<span class="vector-toc-numb">4</span>
				<span>Tips and tricks</span>
			</div>
		</a>
		
			<button aria-controls="toc-Tips_and_tricks-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Tips and tricks subsection</span>
			</button>
		
		<ul id="toc-Tips_and_tricks-sublist" class="vector-toc-list">
			<li id="toc-Nested_virtualization" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Nested_virtualization">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">4.1</span>
					<span>Nested virtualization</span>
				</div>
			</a>
			
			<ul id="toc-Nested_virtualization-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Enabling_huge_pages" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Enabling_huge_pages">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">4.2</span>
					<span>Enabling huge pages</span>
				</div>
			</a>
			
			<ul id="toc-Enabling_huge_pages-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Secure_Boot" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Secure_Boot">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">4.3</span>
					<span>Secure Boot</span>
				</div>
			</a>
			
			<ul id="toc-Secure_Boot-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-See_also" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#See_also">
			<div class="vector-toc-text">
				<span class="vector-toc-numb">5</span>
				<span>See also</span>
			</div>
		</a>
		
		<ul id="toc-See_also-sublist" class="vector-toc-list">
		</ul>
	</li>
</ul>
</div>

					</div>
		</nav>
			</div>
		</div>
		<div class="mw-content-container">
			<main id="content" class="mw-body" style="margin: 0">
				<header class="mw-body-header vector-page-titlebar">
					<nav aria-label="Contents" class="vector-toc-landmark">
						
<div id="vector-page-titlebar-toc" class="vector-dropdown vector-page-titlebar-toc vector-button-flush-left">
	<input type="checkbox" id="vector-page-titlebar-toc-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-vector-page-titlebar-toc" class="vector-dropdown-checkbox " aria-label="Toggle the table of contents">
	<label id="vector-page-titlebar-toc-label" for="vector-page-titlebar-toc-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--icon-only " aria-hidden="true"><span class="vector-icon mw-ui-icon-listBullet mw-ui-icon-wikimedia-listBullet"></span>

<span class="vector-dropdown-label-text">Toggle the table of contents</span>
	</label>
	<div class="vector-dropdown-content">


							<div id="vector-page-titlebar-toc-unpinned-container" class="vector-unpinned-container">
			</div>
		
	</div>
</div>

					</nav>
					<h1 id="firstHeading" class="firstHeading mw-first-heading"><span class="mw-page-title-main">KVM</span></h1>
							
<div id="p-lang-btn" class="vector-dropdown mw-portlet mw-portlet-lang">
	<input type="checkbox" id="p-lang-btn-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-p-lang-btn" class="vector-dropdown-checkbox mw-interlanguage-selector" aria-label="Go to an article in another language. Available in 4 languages">
	<label id="p-lang-btn-label" for="p-lang-btn-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--action-progressive mw-portlet-lang-heading-4" aria-hidden="true"><span class="vector-icon mw-ui-icon-language-progressive mw-ui-icon-wikimedia-language-progressive"></span>

<span class="vector-dropdown-label-text">4 languages</span>
	</label>
	<div class="vector-dropdown-content">

		<div class="vector-menu-content">
			
			<ul class="vector-menu-content-list">
				
				<li class="interlanguage-link interwiki-es mw-list-item"><a href="../es/KVM.html" title="KVM – español" lang="es" hreflang="es" data-title="KVM" data-language-autonym="Español" data-language-local-name="español" class="interlanguage-link-target"><span>Español</span></a></li>
<li class="interlanguage-link interwiki-ja mw-list-item"><a href="https://wiki.archlinux.jp/index.php/KVM" title="KVM – 日本語" lang="ja" hreflang="ja" data-title="KVM" data-language-autonym="日本語" data-language-local-name="日本語" class="interlanguage-link-target"><span>日本語</span></a></li>
<li class="interlanguage-link interwiki-ru mw-list-item"><a href="../ru/KVM.html" title="KVM – русский" lang="ru" hreflang="ru" data-title="KVM" data-language-autonym="Русский" data-language-local-name="русский" class="interlanguage-link-target"><span>Русский</span></a></li>
<li class="interlanguage-link interwiki-zh-hans mw-list-item"><a href="https://wiki.archlinuxcn.org/wiki/KVM" title="KVM – 中文（简体）" lang="zh-Hans" hreflang="zh-Hans" data-title="KVM" data-language-autonym="中文（简体）" data-language-local-name="中文（简体）" class="interlanguage-link-target"><span>中文（简体）</span></a></li>
			</ul>
			
		</div>

	</div>
</div>
</header>
				<div class="vector-column-end">
					<div class="vector-sticky-pinned-container">
						<nav class="vector-page-tools-landmark" aria-label="Page tools">
							<div id="vector-page-tools-pinned-container" class="vector-pinned-container">
				
							</div>
		</nav>
						<nav class="vector-appearance-landmark" aria-label="Appearance">
							<div id="vector-appearance-pinned-container" class="vector-pinned-container">
				<div id="vector-appearance" class="vector-appearance vector-pinnable-element">
	<div class="vector-pinnable-header vector-appearance-pinnable-header vector-pinnable-header-pinned" data-feature-name="appearance-pinned" data-pinnable-element-id="vector-appearance" data-pinned-container-id="vector-appearance-pinned-container" data-unpinned-container-id="vector-appearance-unpinned-container">
	<div class="vector-pinnable-header-label">Appearance</div>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-pin-button" data-event-name="pinnable-header.vector-appearance.pin">move to sidebar</button>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-unpin-button" data-event-name="pinnable-header.vector-appearance.unpin">hide</button>
</div>


</div>

							</div>
		</nav>
					</div>
				</div>
				<div id="bodyContent" class="vector-body" aria-labelledby="firstHeading" data-mw-ve-target-container>
					<div class="vector-body-before-content">
							<div class="mw-indicators">
		</div>

						<div id="siteSub" class="noprint">From ArchWiki</div>
					</div>
					<div id="contentSub"><div id="mw-content-subtitle"></div></div>
					
					
					<div id="mw-content-text" class="mw-body-content">
<div class="mw-content-ltr mw-parser-output" lang="en" dir="ltr">
<div class="archwiki-template-meta-related-articles">
<p>Related articles</p>
<ul>
<li><a href="../en/Category:Hypervisors.html" title="Category:Hypervisors">Category:Hypervisors</a></li>
<li><a href="../en/Libvirt.html" title="Libvirt">Libvirt</a></li>
</ul>
</div>
<p><b>KVM</b>, <a href="https://en.wikipedia.org/wiki/Kernel-based_Virtual_Machine" class="extiw" title="wikipedia:Kernel-based Virtual Machine">Kernel-based Virtual Machine</a>, is a <a href="https://en.wikipedia.org/wiki/hypervisor" class="extiw" title="wikipedia:hypervisor">hypervisor</a> built into the Linux kernel. It is similar to <a href="../en/Xen.html" title="Xen">Xen</a> in purpose but much simpler to get running. Unlike native <a href="../en/QEMU.html" title="QEMU">QEMU</a>, which uses emulation, KVM is a special operating mode of QEMU that uses CPU extensions (<a href="https://en.wikipedia.org/wiki/Hardware-assisted_virtualization" class="extiw" title="wikipedia:Hardware-assisted virtualization">HVM</a>) for virtualization via a kernel module.
</p>
<p>Using KVM, one can run multiple virtual machines running unmodified GNU/Linux, Windows, or any other operating system. (See <a rel="nofollow" class="external text" href="https://www.linux-kvm.org/page/Guest_Support_Status">Guest Support Status</a> for more information.) Each virtual machine has private virtualized hardware: a network card, disk, graphics card, etc.
</p>
<p>Differences between KVM and <a href="../en/Xen.html" title="Xen">Xen</a>, <a href="../en/VMware.html" title="VMware">VMware</a>, or QEMU can be found at the <a rel="nofollow" class="external text" href="https://www.linux-kvm.org/page/FAQ#General_KVM_information">KVM FAQ</a>.
</p>
<p>This article does not cover features common to multiple emulators using KVM as a backend. You should see related articles for such information.
</p>
<meta property="mw:PageProp/toc">
<h2><span class="mw-headline" id="Checking_support_for_KVM">Checking support for KVM</span></h2>
<h3><span class="mw-headline" id="Hardware_support">Hardware support</span></h3>
<p>KVM requires that the virtual machine host's processor has virtualization support (named VT-x for Intel processors and AMD-V for AMD processors). You can check whether your processor supports hardware virtualization with the following command:
</p>
<pre>$ LC_ALL=C.UTF-8 lscpu | grep Virtualization
</pre>
<p>Alternatively:
</p>
<pre>$ grep -E --color=auto 'vmx|svm|0xc0f' /proc/cpuinfo
</pre>
<p>If nothing is displayed after running either command, then your processor does <b>not</b> support hardware virtualization, and you will <b>not</b> be able to use KVM.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> You may need to enable virtualization support in your BIOS.  All x86_64 processors manufactured by AMD and Intel in the last 10 years support virtualization.  If it looks like your processor does not support virtualization, it is almost certainly turned off in the BIOS.</div>
<h3><span class="mw-headline" id="Kernel_support">Kernel support</span></h3>
<p>Arch Linux kernels provide the required <a href="../en/Kernel_module.html" class="mw-redirect" title="Kernel modules">kernel modules</a> to support KVM.
</p>
<ul><li>One can check if the necessary modules, <code>kvm</code> and either <code>kvm_amd</code> or <code>kvm_intel</code>, are available in the kernel with the following command:</li></ul>
<pre>$ zgrep CONFIG_KVM= /proc/config.gz
</pre>
<p>The module is available only if it is set to either <code>y</code> or <code>m</code>.
</p>
<ul><li>Then, ensure that the kernel modules are automatically loaded, with the command:</li></ul>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">$ lsmod | grep kvm</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">kvm_intel             245760  0
kvmgt                  28672  0
mdev                   20480  2 kvmgt,vfio_mdev
vfio                   32768  3 kvmgt,vfio_mdev,vfio_iommu_type1
kvm                   737280  2 kvmgt,kvm_intel
irqbypass              16384  1 kvm
</pre>
<p>If the command returns nothing, the module needs to be loaded manually; see <a href="../en/Kernel_module.html#Manual_module_handling" class="mw-redirect" title="Kernel modules">Kernel modules#Manual module handling</a>.
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> If modprobing <code>kvm_intel</code> or <code>kvm_amd</code> fails but modprobing <code>kvm</code> succeeds, and <code>lscpu</code> claims that hardware acceleration is supported, check the BIOS settings. Some vendors, especially laptop vendors, disable these processor extensions by default. To determine whether there is no hardware support or whether the extensions are disabled in BIOS, the output from <a href="../en/Core_utilities.html#Essentials" class="mw-redirect" title="Dmesg">dmesg</a> after having failed to modprobe will tell.</div>
<h2><span class="mw-headline" id="Para-virtualization_with_Virtio">Para-virtualization with Virtio</span></h2>
<p>Para-virtualization provides a fast and efficient means of communication for guests to use devices on the host machine. KVM provides para-virtualized devices to virtual machines using the <b>Virtio</b> API as a layer between the hypervisor and guest.
</p>
<p>All Virtio devices have two parts: the host device and the guest driver.
</p>
<h3><span class="mw-headline" id="Kernel_support_2">Kernel support</span></h3>
<p>Use the following command <b>inside the virtual machine</b> to check if the VIRTIO modules are available in the kernel:
</p>
<pre>$ zgrep VIRTIO /proc/config.gz
</pre>
<p>Then, check if the kernel modules are automatically loaded with the command:
</p>
<pre>$ lsmod | grep virtio
</pre>
<p>In case the above commands return nothing, you need to <a href="../en/Kernel_module.html#Manual_module_handling" class="mw-redirect" title="Kernel modules">load the kernel modules</a> manually.
</p>
<h3><span class="mw-headline" id="List_of_para-virtualized_devices">List of para-virtualized devices</span></h3>
<ul>
<li>network device (virtio-net)</li>
<li>block device (virtio-blk)</li>
<li>controller device (virtio-scsi)</li>
<li>serial device (virtio-serial)</li>
<li>balloon device (virtio-balloon)</li>
</ul>
<h2><span class="mw-headline" id="How_to_use_KVM">How to use KVM</span></h2>
<p>See the main article: <a href="../en/QEMU.html" title="QEMU">QEMU</a>.
</p>
<h2><span class="mw-headline" id="Tips_and_tricks">Tips and tricks</span></h2>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> See <a href="../en/QEMU.html#Tips_and_tricks" title="QEMU">QEMU#Tips and tricks</a> and <a href="../en/QEMU/Troubleshooting.html" title="QEMU/Troubleshooting">QEMU/Troubleshooting</a> for general tips and tricks.</div>
<h3><span class="mw-headline" id="Nested_virtualization">Nested virtualization</span></h3>
<p>Nested virtualization enables existing virtual machines to be run on third-party hypervisors and on other clouds without any modifications to the original virtual machines or their networking.
</p>
<p>On host, enable nested feature for <code>kvm_intel</code>:
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> the same can be done for AMD, just replace <code>intel</code> with <code>amd</code> where necessary</div>
<pre># modprobe -r kvm_intel
# modprobe kvm_intel nested=1
</pre>
<p>To make it permanent (see <a href="../en/Kernel_module.html#Setting_module_options" class="mw-redirect" title="Kernel modules">Kernel modules#Setting module options</a>):
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/modprobe.d/kvm_intel.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">options kvm_intel nested=1</pre>
<p>Verify that feature is activated:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">$ cat /sys/module/kvm_intel/parameters/nested</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">Y</pre>
<p>Enable the "host passthrough" mode to forward all CPU features to the guest system:
</p>
<ol>
<li>If using <a href="../en/QEMU.html" title="QEMU">QEMU</a>, run the guest virtual machine with the following command: <code>qemu-system-x86_64 -enable-kvm -cpu host</code>.</li>
<li>If using <i>virt-manager</i>, change the CPU model to <code>host-passthrough</code>.</li>
<li>If using <i>virsh</i>, use <code>virsh edit <i>vm-name</i></code> and change the CPU line to <code>&lt;cpu mode='host-passthrough' check='partial'/&gt;</code>
</li>
</ol>
<p>Boot the virtual machine and check if the <code>vmx</code> flag is present:
</p>
<pre>$ grep -E --color=auto 'vmx|svm' /proc/cpuinfo
</pre>
<h3><span class="mw-headline" id="Enabling_huge_pages">Enabling huge pages</span></h3>
<div class="noprint archwiki-template-message">
<p><span class="mw-default-size" typeof="mw:File"><span><img src="../File:Merge-arrows-2.svg" decoding="async" width="36" height="40" class="mw-file-element"></span></span><b>This article or section is a candidate for merging with <a href="../en/QEMU.html" title="QEMU">QEMU</a>.</b></p>
<div>
<b>Notes:</b> qemu-kvm no longer exists. After the above issue is cleared, I suggest merging this section into <a href="../en/QEMU.html" title="QEMU">QEMU</a>. (Discuss in <a rel="nofollow" class="external text" href="../en/Talk:KVM.html">Talk:KVM</a>)</div>
</div>
<p>You may also want to enable hugepages to improve the performance of your virtual machine.
With an up to date Arch Linux and a running KVM, you probably already have everything you need. Check if you have the directory <code>/dev/hugepages</code>. If not, create it.
Now we need the right permissions to use this directory. The default permission is root's uid and gid with 0755, but we want anyone in the kvm group to have access to hugepages.
</p>
<p>Add to your <code>/etc/fstab</code>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/fstab</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">hugetlbfs       /dev/hugepages  hugetlbfs       mode=01770,gid=kvm        0 0</pre>
<p>Instead of specifying the group name directly, with <code>gid=kvm</code>, you can of course specify the gid as a number, but it must match the <code>kvm</code> group. The mode of <code>1770</code> allows anyone in the group to create files but not unlink or rename each other's files. Make sure <code>/dev/hugepages</code> is mounted properly:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># umount /dev/hugepages
# mount /dev/hugepages
$ mount | grep huge</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">hugetlbfs on /dev/hugepages type hugetlbfs (rw,relatime,mode=1770,gid=78)</pre>
<p>Now you can calculate how many hugepages you need. Check how large your hugepages are:
</p>
<pre>$ grep Hugepagesize /proc/meminfo
</pre>
<p>Normally that should be 2048 kB ≙ 2 MB. Let us say you want to run your virtual machine with 1024 MB. 1024 / 2 = 512. Add a few extra so we can round this up to 550. Now tell your machine how many hugepages you want:
</p>
<pre># sysctl -w vm.nr_hugepages=550
</pre>
<p>If you had enough free memory, you should see:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">$ grep HugePages_Total /proc/meminfo</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">HugesPages_Total:  550
</pre>
<p>If the number is smaller, close some applications or start your virtual machine with less memory (number_of_pages x 2):
</p>
<pre>$ qemu-system-x86_64 -enable-kvm -m 1024 -mem-path /dev/hugepages -hda &lt;disk_image&gt; [...]
</pre>
<p>Note the <code>-mem-path</code> parameter. This will make use of the hugepages.
</p>
<p>Now you can check, while your virtual machine is running, how many pages are used:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">$ grep HugePages /proc/meminfo</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">HugePages_Total:     550
HugePages_Free:       48
HugePages_Rsvd:        6
HugePages_Surp:        0
</pre>
<p>Now that everything seems to work, you can enable hugepages by default if you like. Add to your <code>/etc/sysctl.d/40-hugepage.conf</code>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/sysctl.d/40-hugepage.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">vm.nr_hugepages = 550</pre>
<p>See also:
</p>
<ul>
<li><a rel="nofollow" class="external text" href="https://docs.kernel.org/admin-guide/mm/hugetlbpage.html">Summary of hugetlbpage support in the Linux kernel</a></li>
<li><a href="https://wiki.debian.org/Hugepages" class="extiw" title="debian:Hugepages">Debian Wiki - Hugepages</a></li>
</ul>
<h3><span class="mw-headline" id="Secure_Boot">Secure Boot</span></h3>
<div class="noprint archwiki-template-message">
<p><span class="mw-default-size" typeof="mw:File"><span><img src="../File:Merge-arrows-2.svg" decoding="async" width="36" height="40" class="mw-file-element"></span></span><b>This article or section is a candidate for merging with <a href="../en/QEMU.html#Enabling_Secure_Boot" title="QEMU">QEMU#Enabling Secure Boot</a>.</b></p>
<div>
<b>Notes:</b> This is not KVM-specific and would be a great addition to what is already described there. (Discuss in <a rel="nofollow" class="external text" href="../en/Talk:KVM.html">Talk:KVM</a>)</div>
</div>
<p>KVM Secure boot has a few requirements before it can be enabled:
</p>
<ol>
<li>You must use a UEFI with secure boot support compiled in.</li>
<li>The UEFI must have keys enrolled.</li>
</ol>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> Arch Linux does not currently have a secure boot key unlike distributions like Fedora. If you intend to secure boot Arch Linux you must create your own signing key and sign your kernel after following the steps below. See <a href="../en/Unified_Extensible_Firmware_Interface/Secure_Boot.html" title="Unified Extensible Firmware Interface/Secure Boot">Unified Extensible Firmware Interface/Secure Boot</a> for more information.</div>
<p>To enable UEFI with secure boot support, install <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=edk2-ovmf">edk2-ovmf</a></span> and set your virtual machine to use the secure boot enabled UEFI. If you are using <a href="../en/Libvirt.html" title="Libvirt">libvirt</a>, you can do this by adding the following to the XML configuration of your virtual machine.
</p>
<pre>&lt;os firmware="efi"&gt;
  &lt;loader readonly="yes" secure="yes" type="pflash"&gt;/usr/share/edk2/x64/OVMF_CODE.secboot.4m.fd&lt;/loader&gt;
&lt;/os&gt;</pre>
<p>Next you need to enroll some keys. In this example we will enroll Microsoft and Redhat's secure boot keys. Install <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=virt-firmware">virt-firmware</a></span> and run the following. Replace <code><i>vm_name</i></code> with the name of your virtual machine.
</p>
<pre>$ virt-fw-vars --input /usr/share/edk2/x64/OVMF_VARS.4m.fd --output /var/lib/libvirt/qemu/nvram/<i>vm_name</i>_SECURE_VARS.fd --secure-boot --enroll-redhat
</pre>
<p>Then edit the libvirt XML configuration of your virtual machine to point to the new VARS file.
</p>
<pre>&lt;os firmware="efi"&gt;
  &lt;loader readonly="yes" secure="yes" type="pflash"&gt;/usr/share/edk2/x64/OVMF_CODE.secboot.4m.fd&lt;/loader&gt;
  &lt;nvram template="/usr/share/edk2/x64/OVMF_VARS.4m.fd"&gt;/var/lib/libvirt/qemu/nvram/<b>{vm-name}</b>_SECURE_VARS.fd&lt;/nvram&gt;
&lt;/os&gt;</pre>
<p>After this secure boot should automatically be enabled. You can double check by entering the virtual machine's BIOS by pressing <code>F2</code> when you see the UEFI boot logo.
</p>
<h2><span class="mw-headline" id="See_also">See also</span></h2>
<ul>
<li><a rel="nofollow" class="external text" href="https://www.linux-kvm.org/page/HOWTO">KVM Howto</a></li>
<li><a rel="nofollow" class="external text" href="https://www.linux-kvm.org/page/FAQ#General_KVM_information">KVM FAQ</a></li>
</ul>
</div>
</div>
					<div id="catlinks" class="catlinks" data-mw="interface">
<div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../Special:Categories.html" title="Special:Categories">Categories</a>: <ul>
<li><a href="../en/Category:Hypervisors.html" title="Category:Hypervisors">Hypervisors</a></li>
<li><a href="../en/Category:Kernel.html" title="Category:Kernel">Kernel</a></li>
</ul>
</div>
<div id="mw-hidden-catlinks" class="mw-hidden-catlinks mw-hidden-cats-hidden">Hidden category: <ul><li><a href="../en/Category:Pages_or_sections_flagged_with_Template:Merge.html" title="Category:Pages or sections flagged with Template:Merge">Pages or sections flagged with Template:Merge</a></li></ul>
</div>
</div>
				</div>
			</main>
			
		</div>
		<div class="mw-footer-container">
			
<footer id="footer" class="mw-footer" style="margin: 0">
	<ul id="footer-info">
	<li data-nosnippet="">Retrieved from "<a dir="ltr" href="https://wiki.archlinux.org/index.php?title=KVM&amp;oldid=832342">https://wiki.archlinux.org/index.php?title=KVM&amp;oldid=832342</a>"</li>
<li id="footer-info-lastmod"> This page was last edited on 19 April 2025, at 22:50.</li>
	<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="https://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.3 or later</a> unless otherwise noted.</li>
<br>
</ul>

	<ul id="footer-places">
	<li id="footer-places-privacy"><a href="https://terms.archlinux.org/docs/privacy-policy/">Privacy policy</a></li>
	<li id="footer-places-about"><a href="../en/ArchWiki:About.html">About ArchWiki</a></li>
	<li id="footer-places-disclaimers"><a href="../en/ArchWiki:General_disclaimer.html">Disclaimers</a></li>
	<li id="footer-places-archwiki-code-of-conduct"><a href="https://terms.archlinux.org/docs/code-of-conduct/" class="extiw" title="archlinux-service-agreements:code-of-conduct">Code of conduct</a></li>
	<li id="footer-places-archwiki-terms-of-service"><a href="https://terms.archlinux.org/docs/terms-of-service/" class="extiw" title="archlinux-service-agreements:terms-of-service">Terms of service</a></li>
</ul>

	<ul id="footer-icons" class="noprint">
	<li id="footer-copyrightico"><a href="https://www.gnu.org/copyleft/fdl.html" class="cdx-button cdx-button--fake-button cdx-button--size-large cdx-button--fake-button--enabled"><img src="/resources/assets/licenses/gnu-fdl.png" alt="GNU Free Documentation License 1.3 or later" width="88" height="31" loading="lazy"></a></li>
	<li id="footer-poweredbyico"><img src="/resources/assets/poweredby_mediawiki.svg" width="88" height="31" loading="lazy"></li>
</ul>

</footer>

		</div>
	</div> 
</div> 
<div class="vector-settings" id="p-dock-bottom">
	<ul></ul>
</div>
</body>
</html>
