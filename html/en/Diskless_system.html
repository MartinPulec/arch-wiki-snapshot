<!DOCTYPE html>
<html class="client-nojs vector-feature-language-in-header-enabled vector-feature-language-in-main-page-header-disabled vector-feature-sticky-header-disabled vector-feature-page-tools-pinned-disabled vector-feature-toc-pinned-clientpref-1 vector-feature-main-menu-pinned-disabled vector-feature-limited-width-clientpref-1 vector-feature-limited-width-content-enabled vector-feature-custom-font-size-clientpref-0 vector-feature-client-preferences-disabled vector-feature-client-prefs-pinned-disabled vector-feature-night-mode-disabled skin-theme-clientpref-day vector-toc-available" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>Diskless system - ArchWiki</title>
<link rel="stylesheet" href="../ArchWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<meta name="generator" content="MediaWiki 1.42.1">
<meta name="referrer" content="no-referrer-when-downgrade">
<meta name="robots" content="max-image-preview:standard">
<meta name="format-detection" content="telephone=no">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=0.25, maximum-scale=5.0">
<link rel="icon" href="/favicon.ico">
<link rel="search" type="application/opensearchdescription+xml" href="/opensearch_desc.php" title="ArchWiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.archlinux.org/api.php?action=rsd">
<link rel="license" href="https://www.gnu.org/copyleft/fdl.html">
<link rel="alternate" type="application/atom+xml" title="ArchWiki Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="skin-vector skin-vector-search-vue mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-Diskless_system rootpage-Diskless_system skin-vector-2022 action-view skin--responsive">
<a class="mw-jump-link" href="#bodyContent">Jump to content</a>
<div class="vector-header-container">
	</div>
<div class="mw-page-container">
	<div class="mw-page-container-inner">
		<div class="vector-column-start">
			<div class="vector-main-menu-container">
		</div>
	<div class="vector-sticky-pinned-container">
				<nav id="mw-panel-toc" role="navigation" aria-label="Contents" data-event-name="ui.sidebar-toc" class="mw-table-of-contents-container vector-toc-landmark">
					<div id="vector-toc-pinned-container" class="vector-pinned-container">
					<div id="vector-toc" class="vector-toc vector-pinnable-element">
	<div class="vector-pinnable-header vector-toc-pinnable-header vector-pinnable-header-pinned" data-feature-name="toc-pinned" data-pinnable-element-id="vector-toc">
	<h2 class="vector-pinnable-header-label">Contents</h2>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-pin-button" data-event-name="pinnable-header.vector-toc.pin">move to sidebar</button>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-unpin-button" data-event-name="pinnable-header.vector-toc.unpin">hide</button>
</div>


	<ul class="vector-toc-contents" id="mw-panel-toc-list">
		<li id="toc-mw-content-text" class="vector-toc-list-item vector-toc-level-1">
			<a href="#" class="vector-toc-link">
				<div class="vector-toc-text">Beginning</div>
			</a>
		</li>
		<li id="toc-Server_configuration" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#Server_configuration">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">1</span>Server configuration</div>
		</a>
		
			<button aria-controls="toc-Server_configuration-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Server configuration subsection</span>
			</button>
		
		<ul id="toc-Server_configuration-sublist" class="vector-toc-list">
			<li id="toc-DHCP" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#DHCP">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">1.1</span>DHCP</div>
			</a>
			
			<ul id="toc-DHCP-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-TFTP" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#TFTP">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">1.2</span>TFTP</div>
			</a>
			
			<ul id="toc-TFTP-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Network_storage" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Network_storage">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">1.3</span>Network storage</div>
			</a>
			
			<ul id="toc-Network_storage-sublist" class="vector-toc-list">
				<li id="toc-NFS" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#NFS">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">1.3.1</span>NFS</div>
			</a>
			
			<ul id="toc-NFS-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-NBD" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#NBD">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">1.3.2</span>NBD</div>
			</a>
			
			<ul id="toc-NBD-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-SKUF" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#SKUF">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">1.3.3</span>SKUF</div>
			</a>
			
			<ul id="toc-SKUF-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Client_installation" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#Client_installation">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">2</span>Client installation</div>
		</a>
		
			<button aria-controls="toc-Client_installation-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Client installation subsection</span>
			</button>
		
		<ul id="toc-Client_installation-sublist" class="vector-toc-list">
			<li id="toc-Directory_setup" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Directory_setup">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.1</span>Directory setup</div>
			</a>
			
			<ul id="toc-Directory_setup-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Bootstrapping_installation" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Bootstrapping_installation">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.2</span>Bootstrapping installation</div>
			</a>
			
			<ul id="toc-Bootstrapping_installation-sublist" class="vector-toc-list">
				<li id="toc-NFS_2" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#NFS_2">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.2.1</span>NFS</div>
			</a>
			
			<ul id="toc-NFS_2-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-NBD_2" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#NBD_2">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.2.2</span>NBD</div>
			</a>
			
			<ul id="toc-NBD_2-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-SKUF_2" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#SKUF_2">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.2.3</span>SKUF</div>
			</a>
			
			<ul id="toc-SKUF_2-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Client_configuration" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#Client_configuration">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">3</span>Client configuration</div>
		</a>
		
			<button aria-controls="toc-Client_configuration-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Client configuration subsection</span>
			</button>
		
		<ul id="toc-Client_configuration-sublist" class="vector-toc-list">
			<li id="toc-Bootloader" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Bootloader">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.1</span>Bootloader</div>
			</a>
			
			<ul id="toc-Bootloader-sublist" class="vector-toc-list">
				<li id="toc-GRUB" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#GRUB">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.1.1</span>GRUB</div>
			</a>
			
			<ul id="toc-GRUB-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-PXELINUX" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#PXELINUX">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.1.2</span>PXELINUX</div>
			</a>
			
			<ul id="toc-PXELINUX-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Additional_mountpoints" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Additional_mountpoints">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.2</span>Additional mountpoints</div>
			</a>
			
			<ul id="toc-Additional_mountpoints-sublist" class="vector-toc-list">
				<li id="toc-NBD_root" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#NBD_root">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.2.1</span>NBD root</div>
			</a>
			
			<ul id="toc-NBD_root-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Program_state_directories" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Program_state_directories">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.2.2</span>Program state directories</div>
			</a>
			
			<ul id="toc-Program_state_directories-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Client_boot" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#Client_boot">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">4</span>Client boot</div>
		</a>
		
			<button aria-controls="toc-Client_boot-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Client boot subsection</span>
			</button>
		
		<ul id="toc-Client_boot-sublist" class="vector-toc-list">
			<li id="toc-NBD_3" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#NBD_3">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">4.1</span>NBD</div>
			</a>
			
			<ul id="toc-NBD_3-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-SKUF_3" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#SKUF_3">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">4.2</span>SKUF</div>
			</a>
			
			<ul id="toc-SKUF_3-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-See_also" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#See_also">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">5</span>See also</div>
		</a>
		
		<ul id="toc-See_also-sublist" class="vector-toc-list">
		</ul>
	</li>
</ul>
</div>

					</div>
		</nav>
			</div>
		</div>
		<div class="mw-content-container">
			<main id="content" class="mw-body" role="main" style="margin: 0">
				<header class="mw-body-header vector-page-titlebar">
					<nav role="navigation" aria-label="Contents" class="vector-toc-landmark">
						
<div id="vector-page-titlebar-toc" class="vector-dropdown vector-page-titlebar-toc vector-button-flush-left">
	<input type="checkbox" id="vector-page-titlebar-toc-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-vector-page-titlebar-toc" class="vector-dropdown-checkbox " aria-label="Toggle the table of contents">
	<label id="vector-page-titlebar-toc-label" for="vector-page-titlebar-toc-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--icon-only " aria-hidden="true"><span class="vector-icon mw-ui-icon-listBullet mw-ui-icon-wikimedia-listBullet"></span>

<span class="vector-dropdown-label-text">Toggle the table of contents</span>
	</label>
	<div class="vector-dropdown-content">


							<div id="vector-page-titlebar-toc-unpinned-container" class="vector-unpinned-container">
			</div>
		
	</div>
</div>

					</nav>
					<h1 id="firstHeading" class="firstHeading mw-first-heading"><span class="mw-page-title-main">Diskless system</span></h1>
							
<div id="p-lang-btn" class="vector-dropdown mw-portlet mw-portlet-lang">
	<input type="checkbox" id="p-lang-btn-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-p-lang-btn" class="vector-dropdown-checkbox mw-interlanguage-selector" aria-label="Go to an article in another language. Available in 4 languages">
	<label id="p-lang-btn-label" for="p-lang-btn-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--action-progressive mw-portlet-lang-heading-4" aria-hidden="true"><span class="vector-icon mw-ui-icon-language-progressive mw-ui-icon-wikimedia-language-progressive"></span>

<span class="vector-dropdown-label-text">4 languages</span>
	</label>
	<div class="vector-dropdown-content">

		<div class="vector-menu-content">
			
			<ul class="vector-menu-content-list">
				
				<li class="interlanguage-link interwiki-de mw-list-item"><a href="https://wiki.archlinux.de/title/Diskless_Workstation" title="Diskless Workstation – Deutsch" lang="de" hreflang="de" class="interlanguage-link-target"><span>Deutsch</span></a></li>
<li class="interlanguage-link interwiki-ja mw-list-item"><a href="https://wiki.archlinux.jp/index.php/%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AF%E3%83%AC%E3%82%B9%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0" title="ディスクレスシステム – 日本語" lang="ja" hreflang="ja" class="interlanguage-link-target"><span>日本語</span></a></li>
<li class="interlanguage-link interwiki-ru mw-list-item"><a href="../ru/Diskless_system.html" title="Diskless system – русский" lang="ru" hreflang="ru" class="interlanguage-link-target"><span>Русский</span></a></li>
<li class="interlanguage-link interwiki-zh-hans mw-list-item"><a href="https://wiki.archlinuxcn.org/wiki/Diskless_system" title="Diskless system – 中文（简体）" lang="zh-Hans" hreflang="zh-Hans" class="interlanguage-link-target"><span>中文（简体）</span></a></li>
			</ul>
			
		</div>

	</div>
</div>
</header>
				<div class="vector-column-end">
					<div class="vector-sticky-pinned-container">
						<nav class="vector-page-tools-landmark" aria-label="Page tools">
							<div id="vector-page-tools-pinned-container" class="vector-pinned-container">
				
							</div>
		</nav>
						<nav class="vector-client-prefs-landmark" aria-label="Appearance">
						</nav>
					</div>
				</div>
				<div id="bodyContent" class="vector-body" aria-labelledby="firstHeading" data-mw-ve-target-container>
					<div class="vector-body-before-content">
							<div class="mw-indicators">
		</div>

						<div id="siteSub" class="noprint">From ArchWiki</div>
					</div>
					<div id="contentSub"><div id="mw-content-subtitle"></div></div>
					
					
					<div id="mw-content-text" class="mw-body-content">
<div class="mw-content-ltr mw-parser-output" lang="en" dir="ltr">
<div class="archwiki-template-meta-related-articles">
<p>Related articles</p>
<ul>
<li><a href="../en/NFS.html" title="NFS">NFS</a></li>
<li><a href="../en/NFS/Troubleshooting.html" class="mw-redirect" title="NFS Troubleshooting">NFS Troubleshooting</a></li>
<li><a href="../en/Preboot_Execution_Environment.html" class="mw-redirect" title="PXE">PXE</a></li>
<li><a href="../en/Mkinitcpio.html#Using_net" title="Mkinitcpio">Mkinitcpio#Using net</a></li>
<li><a href="../en/ISCSI/Boot.html" class="mw-redirect" title="ISCSI Boot">iSCSI Boot</a></li>
</ul>
</div>
<p>From <a href="https://en.wikipedia.org/wiki/Diskless_node" class="extiw" title="wikipedia:Diskless node">Wikipedia:Diskless node</a>: 
</p>
<dl><dd>A diskless node (or diskless workstation) is a workstation or personal computer without disk drives, which employs network booting to load its operating system from a server.</dd></dl>
<meta property="mw:PageProp/toc">
<h2><span class="mw-headline" id="Server_configuration">Server configuration</span></h2>
<p>First of all, we must install the following components:
</p>
<ul>
<li>A <a href="../en/Dhcpd.html" title="Dhcpd">DHCP</a> server to assign IP addresses to our diskless nodes.</li>
<li>A <a href="../en/TFTP.html" title="TFTP">TFTP</a> server to transfer the boot image (a requirement of all PXE option roms).</li>
<li>A form of network storage (<a href="../en/NFS.html" title="NFS">NFS</a>, <a href="../en/Samba.html" title="Samba">Samba</a> or NBD) to export the Arch installation to the diskless node.</li>
</ul>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> 
<ul>
<li>
<span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=dnsmasq">dnsmasq</a></span> is capable of simultaneously acting as both DHCP and TFTP server. For more information, see the <a href="../en/Dnsmasq.html" title="Dnsmasq">dnsmasq</a> article.</li>
<li>You can also boot Arch Linux without using PXE at all. See the SKUF item below.</li>
</ul>
</div>
<h3><span class="mw-headline" id="DHCP">DHCP</span></h3>
<p>Install ISC <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=dhcp">dhcp</a></span> and configure it:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/dhcpd.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">allow booting;
allow bootp;

authoritative;

option domain-name-servers 10.0.0.1;

option architecture code 93 = unsigned integer 16;

group {
    next-server 10.0.0.1;

    if option architecture = 00:07 {
        filename "/grub/x86_64-efi/core.efi";
    } else {
        filename "/grub/i386-pc/core.0";
    }

    subnet 10.0.0.0 netmask 255.255.255.0 {
        option routers 10.0.0.1;
        range 10.0.0.128 10.0.0.254;
    }
}</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> <code>next-server</code> should be the address of the TFTP server; everything else should be changed to match your network</div>
<p><a href="https://tools.ietf.org/html/rfc4578" class="extiw" title="rfc:4578">RFC:4578</a> defines the "Client System Architecture Type" dhcp option. In the above configuration, if the PXE client requests an x86_64-efi binary (type 0x7), we appropriately give them one, otherwise falling back to the legacy binary. This allows both UEFI and legacy BIOS clients to boot simultaneously on the same network segment.
</p>
<p>Start ISC DHCP <a href="../en/Systemd.html" title="Systemd">systemd</a> service.
</p>
<h3><span class="mw-headline" id="TFTP">TFTP</span></h3>
<p>The TFTP server will be used to transfer the bootloader, kernel, and initramfs to the client.
</p>
<p>Set the TFTP root to <code>/srv/arch/boot</code>. See <a href="../en/TFTP.html" title="TFTP">TFTP</a> for installation and configuration.
</p>
<h3><span class="mw-headline" id="Network_storage">Network storage</span></h3>
<p>The primary difference between using NFS and NBD is while with both you can in fact have multiple clients using the same installation, with NBD (by the nature of manipulating a filesystem directly) you will need to use the <code>copyonwrite</code> mode to do so, which ends up discarding all writes on client disconnect. In some situations however, this might be highly desirable.
</p>
<h4><span class="mw-headline" id="NFS">NFS</span></h4>
<p>Install <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=nfs-utils">nfs-utils</a></span> on the server.
</p>
<p>You will need to add the root of your Arch installation to your <a href="../en/NFS.html" title="NFS">NFS</a> exports:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/exports</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">/srv       *(rw,fsid=0,no_root_squash,no_subtree_check)
/srv/arch  *(rw,no_root_squash,no_subtree_check)</pre>
<p>Next, start NFS services: <code>nfs-idmapd</code> <code>nfs-mountd</code>.
</p>
<h4><span class="mw-headline" id="NBD">NBD</span></h4>
<p>Install <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=nbd">nbd</a></span> and configure it.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/nbd-server/config</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[generic]
    user = nbd
    group = nbd
[arch]
    exportname = /srv/arch.img
    copyonwrite = false</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> Set <code>copyonwrite</code> to true if you want to have multiple clients using the same NBD share simultaneously; refer to <span class="plainlinks archwiki-template-man" title="$ man 5 nbd-server"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/nbd-server.5">nbd-server(5)</a></span> for more details. Also use <a href="../en/File_permissions_and_attributes.html#Changing_ownership" class="mw-redirect" title="Chown">chown</a> to change the ownership of the exportname directory to the user <code>nbd</code>.</div>
<p>Start <code>nbd</code> systemd service.
</p>
<h4><span class="mw-headline" id="SKUF">SKUF</span></h4>
<p>You can boot Arch Linux using the <a rel="nofollow" class="external text" href="https://github.com/BiteDasher/skuf">SKUF Network Boot System</a> project, where the root of the file system will be a <a href="https://en.wikipedia.org/wiki/Sparse_file" class="extiw" title="wikipedia:Sparse file">sparse file</a> located on <a href="../en/Samba.html" title="Samba">Samba</a> server.
</p>
<p>To get started, install <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=samba">samba</a></span> and create a configuration file:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/samba/smb.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[global]
	workgroup = WORKGROUP
	security = user

[arch]
	path = /srv/samba
	valid users = @skuf
	write list = @skuf
	guest ok = no
	read only = no
	writeable = yes
	browseable = yes</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> All your sparse images will lie in the specified directory (in this example <code>/srv/samba</code>).</div>
<p>Start <code>smb</code> systemd service
</p>
<p>Then, create a <code>skuf</code> group and users who will be members of it and through whom <code>SAMBA</code> mounting on the client machine will happen.
</p>
<pre># groupadd skuf
# useradd test -g skuf
# smbpasswd -a test
</pre>
<h2><span class="mw-headline" id="Client_installation">Client installation</span></h2>
<p>Next we will create a full Arch Linux installation in a subdirectory on the server. During boot, the diskless client will get an IP address from the DHCP server, then boot from the host using PXE and mount this installation as its root.
</p>
<h3><span class="mw-headline" id="Directory_setup">Directory setup</span></h3>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> Creating a separate filesystem is required for NBD but optional for NFS and can be skipped/ignored.</div>
<p>Create a <a href="https://en.wikipedia.org/wiki/Sparse_file" class="extiw" title="wikipedia:Sparse file">sparse file</a> of at least 2 gibibytes, and create a btrfs filesystem on it (you can of course also use a real block device or <a href="../en/LVM.html" title="LVM">LVM</a> if you want).
</p>
<pre># truncate -s 2G /srv/arch.img
# mkfs.btrfs /srv/arch.img
# export root=/srv/arch
# mount --mkdir -o loop,compress=lzo /srv/arch.img "$root"
</pre>
<h3><span class="mw-headline" id="Bootstrapping_installation">Bootstrapping installation</span></h3>
<p>Install <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=devtools">devtools</a></span> and <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=arch-install-scripts">arch-install-scripts</a></span>, and run <i>pacstrap</i> to install the <a href="../en/Installation_guide.html#Install_essential_packages" title="Installation guide">essential packages</a> for the client:
</p>
<pre># pacstrap -K "$root" base linux linux-firmware mkinitcpio-nfs-utils nfs-utils
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> In all cases <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=mkinitcpio-nfs-utils">mkinitcpio-nfs-utils</a></span> is still required. <code>ipconfig</code> used in early-boot is provided only by the latter.</div>
<p>Now the initramfs needs to be constructed.
</p>
<h4><span class="mw-headline" id="NFS_2">NFS</span></h4>
<p>Trivial modifications to the <code>net</code> hook are required in order for NFSv4 mounting to work (not supported by <code>nfsmount</code> – the default for the <code>net</code> hook).
</p>
<pre># sed s/nfsmount/mount.nfs4/ "$root/usr/lib/initcpio/hooks/net" &gt; "$root/usr/lib/initcpio/hooks/netnfs4"
# cp $root/usr/lib/initcpio/install/net{,nfs4}
</pre>
<p>The copy of <code>net</code> is unfortunately needed so it does not get overwritten when <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=mkinitcpio-nfs-utils">mkinitcpio-nfs-utils</a></span> is updated on the client installation.
</p>
<p>Edit <code>$root/etc/mkinitcpio.conf</code> and add <code>nfsv4</code> to <code>MODULES</code>, <code>netnfs4</code> to <code>HOOKS</code>, and <code>/usr/bin/mount.nfs4</code> to <code>BINARIES</code>.
</p>
<p>Next, we <a href="../en/Chroot.html" title="Chroot">chroot</a> our installation and run <i>mkinitcpio</i>:
</p>
<pre># arch-chroot "$root" mkinitcpio -p linux
</pre>
<h4><span class="mw-headline" id="NBD_2">NBD</span></h4>
<p>The <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/mkinitcpio-nbd/">mkinitcpio-nbd</a></span><sup><small>AUR</small></sup> package needs to be installed on the client. Build it with <a href="../en/Makepkg.html" title="Makepkg">makepkg</a> and install it:
</p>
<pre># pacman --root "$root" --dbpath "$root/var/lib/pacman" -U mkinitcpio-nbd-0.4-1-any.pkg.tar.xz
</pre>
<p>You will then need to append <code>nbd</code> to your <code>HOOKS</code> array after <code>net</code>; <code>net</code> will configure your networking for you, but not attempt a NFS mount if <code>nfsroot</code> is not specified in the kernel line.
</p>
<h4><span class="mw-headline" id="SKUF_2">SKUF</span></h4>
<p>To install Arch Linux on <a href="https://en.wikipedia.org/wiki/Sparse_file" class="extiw" title="wikipedia:Sparse file">sparse file</a> using <a rel="nofollow" class="external text" href="https://github.com/BiteDasher/skuf">SKUF Network Boot System</a>, clone the <a href="../en/Git.html" title="Git">git</a> repository:
</p>
<pre>$ git clone <a rel="nofollow" class="external free" href="https://github.com/BiteDasher/skuf.git">https://github.com/BiteDasher/skuf.git</a>
$ cd skuf
$ ./switch-tag latest
</pre>
<p>Then, build the <code>skuf</code> package and <a href="https://en.wikipedia.org/wiki/ISO_Image" class="extiw" title="wikipedia:ISO Image">ISO image</a> which will later be used as a "kickstart" to start the main system using <a href="../en/Kexec.html" title="Kexec">kexec</a>
</p>
<p>First of all, you need to tune the method of encrypting your passwords for SAMBA (see <a rel="nofollow" class="external autonumber" href="https://github.com/BiteDasher/skuf#customisation-instructions">[1]</a> for more details):
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">tune.crypt</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">A B
X Y
I O</pre>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">tune.password</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">1234 Test password!</pre>
<p>Set up <a rel="nofollow" class="external text" href="https://github.com/BiteDasher/skuf#defaults-setup">defaults</a>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">defaults</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">SAMBA_USERNAME="testuser"
SAMBA_PASSWORD="pa33w0rd"
SAMBA_ADDRESS="192.168.0.5"
SAMBA_PORT="445"
SAMBA_VERSION="3.0"
...</pre>
<p>And finally, build <code>skuf</code> package:
</p>
<pre>$ ./tune_crypt.sh
$ ./tune_password.sh
$ ./setup_defaults.sh
$ ./build_rootfs_tar.sh
$ ./build_package.sh
</pre>
<p>ISO image:
</p>
<pre># ./setup_repo.sh
# ./build_iso.sh
</pre>
<p>And <a href="https://en.wikipedia.org/wiki/Sparse_file" class="extiw" title="wikipedia:Sparse file">sparse file</a> with Arch Linux:
</p>
<pre># ./create_image.sh -s <i>SIZE_IN_GIGABYTES</i> <i>additional_packages</i>
</pre>
<p>Then, move <code>arch.ext4</code> in <code>/srv/samba</code>.
</p>
<h2><span class="mw-headline" id="Client_configuration">Client configuration</span></h2>
<p>In addition to the setup mentioned here, you should also set up your <a href="../en/Network_configuration.html#Set_the_hostname" class="mw-redirect" title="Hostname">hostname</a>, <a href="../en/System_time.html#Time_zone" class="mw-redirect" title="Timezone">timezone</a>, <a href="../en/Locale.html#Setting_the_system_locale" title="Locale">locale</a>, and <a href="../en/Linux_console/Keyboard_configuration.html" class="mw-redirect" title="Keymap">keymap</a>, and follow any other relevant parts of the <a href="../en/Installation_guide.html" title="Installation guide">Installation guide</a>.
</p>
<h3><span class="mw-headline" id="Bootloader">Bootloader</span></h3>
<h4><span class="mw-headline" id="GRUB">GRUB</span></h4>
<div class="noprint archwiki-template-message">
<p><span class="mw-default-size" typeof="mw:File"><span><img src="../File:Merge-arrows-2.svg" decoding="async" width="36" height="40" class="mw-file-element"></span></span><b>This article or section is a candidate for merging with <a href="../en/GRUB.html" title="GRUB">GRUB</a>.</b></p>
<div>
<b>Notes:</b>  (Discuss in <a rel="nofollow" class="external text" href="../en/Talk:Diskless_system.html">Talk:Diskless system</a>)</div>
</div>
<p>Though poorly documented, GRUB supports being loaded via PXE.
</p>
<pre># pacman --root "$root" --dbpath "$root/var/lib/pacman" -S grub
</pre>
<p>Create a grub prefix on the target installation for both architectures using <code>grub-mknetdir</code>.
</p>
<pre># arch-chroot "$root" grub-mknetdir --net-directory=/boot --subdir=grub
</pre>
<p>Luckily for us, grub-mknetdir creates prefixes for all currently compiled/installed targets, and the <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=grub">grub</a></span> maintainers were nice enough to give us both in the same package, thus grub-mknetdir only needs to be run once.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> This example config assumes the NFS/NBD server's IP being <code>10.0.0.1</code> </div>
<p>Now we create a trivial GRUB configuration:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># vim "$root/boot/grub/grub.cfg"</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">menuentry "Arch Linux" {
    linux /vmlinuz-linux quiet add_efi_memmap ip=:::::eth0:dhcp nfsroot=10.0.0.1:/arch
    initrd /initramfs-linux.img
}

menuentry "Arch Linux (NBD)" {
    linux /vmlinuz-linux quiet add_efi_memmap ip=:::::eth0:dhcp nbd_host=10.0.0.1 nbd_name=arch root=/dev/nbd0
    initrd /initramfs-linux.img
}</pre>
<p><a href="../en/GRUB.html" title="GRUB">GRUB</a> will <code>set root=(tftp,10.0.0.1)</code> automatically, so that the kernel and initramfs are transferred via TFTP without any additional configuration, though you might want to set it explicitly if you have any other non-tftp menuentries.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> 
<ul>
<li>All GRUB files and initcpio files must be available through TFTP. For example, for a NBD install with TFTP root set to <code>/srv/tftp</code>, <code>/srv/tftp/grub/x86_64-efi/core.efi</code>, <code>/srv/tftp/vmlinuz-linux</code> must be present to boot successfully. You may copy all the <code>/boot</code> files inside the image to TFTP server's root.</li>
<li>You may generate grub config by <code>grub-mkconfig</code> to ensure video settings are set correctly. However, it is needed to edit <code>boot.cfg</code> afterwards, to remove <code>search --no-floppy ...</code> and ensure <code>linux</code> <code>initrd</code> options (paths, NBD settings, NFS settings) are set correctly.</li>
<li>Modify your kernel line as-necessary, refer to <a href="../en/Syslinux.html#PXELINUX" class="mw-redirect" title="PXELINUX">PXELINUX</a> for NBD-related options.</li>
</ul>
</div>
<h4><span class="mw-headline" id="PXELINUX">PXELINUX</span></h4>
<p>PXELINUX is provided by <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=syslinux">syslinux</a></span>, see <a href="../en/Syslinux.html#PXELINUX" class="mw-redirect" title="PXELINUX">PXELINUX</a> for details.
</p>
<h3><span class="mw-headline" id="Additional_mountpoints">Additional mountpoints</span></h3>
<h4><span class="mw-headline" id="NBD_root">NBD root</span></h4>
<p>In late boot, you will want to switch your root filesystem mount to both <code>rw</code>, and enable <code>compress=lzo</code>, for much improved disk performance in comparison to <a href="../en/NFS.html" title="NFS">NFS</a>.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># vim "$root/etc/fstab"</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">/dev/nbd0  /  btrfs  rw,noatime,compress=lzo  0 0</pre>
<h4><span class="mw-headline" id="Program_state_directories">Program state directories</span></h4>
<div class="noprint archwiki-template-message">
<p><span class="mw-default-size" typeof="mw:File"><span><img src="../File:Inaccurate.svg" decoding="async" width="48" height="48" class="mw-file-element"></span></span><b>The factual accuracy of this article or section is disputed.</b></p>
<div>
<b>Reason:</b> systemd does not use persistent logging by default when /var/log/journal is in tmpfs and/or does not exist (Discuss in <a rel="nofollow" class="external text" href="../en/Talk:Diskless_system.html">Talk:Diskless system</a>)</div>
</div>
<p>You could mount <code>/var/log</code>, for example, as tmpfs so that logs from multiple hosts do not mix unpredictably, and do the same with <code>/var/spool/cups</code>, so the 20 instances of cups using the same spool do not fight with each other and make 1,498 print jobs and eat an entire ream of paper (or worse: toner cartridge) overnight.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># vim "$root/etc/fstab"</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">tmpfs   /var/log        tmpfs     nodev,nosuid    0 0
tmpfs   /var/spool/cups tmpfs     nodev,nosuid    0 0</pre>
<p>It would be best to configure software that has some sort of state/database to use unique state/database storage directories for each host. If you wanted to run <a rel="nofollow" class="external text" href="http://puppetlabs.com/">puppet</a>, for example, you could simply use the <code>%H</code> specifier in the puppet unit file:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># vim "$root/etc/systemd/system/puppetagent.service"</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Unit]
Description=Puppet agent
Wants=basic.target
After=basic.target network.target

[Service]
Type=forking
PIDFile=/run/puppet/agent.pid
ExecStartPre=/usr/bin/install -d -o puppet -m 755 /run/puppet
ExecStart=/usr/bin/puppet agent --vardir=/var/lib/puppet-%H --ssldir=/etc/puppet/ssl-%H

[Install]
WantedBy=multi-user.target</pre>
<p>Puppet-agent creates <code>vardir</code> and <code>ssldir</code> if they do not exist.
</p>
<p>If neither of these approaches are appropriate, the last sane option would be to create a <span class="plainlinks archwiki-template-man" title="$ man 7 systemd.generator"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/systemd.generator.7">systemd.generator(7)</a></span> that creates a mount unit specific to the current host (specifiers are not allowed in mount units, unfortunately).
</p>
<h2><span class="mw-headline" id="Client_boot">Client boot</span></h2>
<h3><span class="mw-headline" id="NBD_3">NBD</span></h3>
<div class="noprint archwiki-template-message">
<p><span class="mw-default-size" typeof="mw:File"><span><img src="../File:Inaccurate.svg" decoding="async" width="48" height="48" class="mw-file-element"></span></span><b>The factual accuracy of this article or section is disputed.</b></p>
<div>
<b>Reason:</b> When using COW on the server, the clients all effectively have read-only mounts of the original filesystem; it should theoretically be safe to do a read-write mount on the NBD server (Discuss in <a rel="nofollow" class="external text" href="../en/Talk:Diskless_system.html">Talk:Diskless system</a>)</div>
</div>
<p>If you are using NBD, you will need to umount the <code>arch.img</code> before/while you boot your client.
</p>
<p>This makes things particularly interesting when it comes to kernel updates. You cannot have your client filesystem mounted while you are booting a client, but that also means you need to use a kernel separate from your client filesystem in order to build it.
</p>
<p>You will need to first copy <code>$root/boot</code> from the client installation to your tftp root (i.e. <code>/srv/boot</code>).
</p>
<pre># cp -r "$root/boot" /srv/boot
</pre>
<p>You will then need to umount <code>$root</code> before you start the client.
</p>
<pre># umount "$root"
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> To update the kernel in this setup, you either need to mount <code>/srv/boot</code> using <a href="../en/NFS.html" title="NFS">NFS</a> in <a href="../en/Fstab.html" title="Fstab">fstab</a> on the client (prior to doing the kernel update) or mount your client filesystem after the client has disconnected from NBD</div>
<h3><span class="mw-headline" id="SKUF_3">SKUF</span></h3>
<p>Write <code>skuflinux-smth.iso</code> to your USB drive, plug it in client computer and select in <a href="../en/Unified_Extensible_Firmware_Interface.html" class="mw-redirect" title="UEFI">UEFI</a>/BIOS settings as a boot device.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> If the client computer has <a href="../en/Unified_Extensible_Firmware_Interface.html" class="mw-redirect" title="UEFI">UEFI</a>, you can install <code>SKUF</code> on a <a href="../en/EFI_system_partition.html" class="mw-redirect" title="ESP">ESP</a> partition so you don't have to use a USB flash drive/CD/DVD. To do this, mount <code>skuflinux-smth.iso</code> somewhere (like /mnt), then copy <code>/mnt/skuf/boot/x86_64/{vmlinuz-linux,initramfs-linux.img} </code> to <a href="../en/EFI_system_partition.html" class="mw-redirect" title="ESP">ESP</a> partition and execute <code>efibootmgr -c -d /dev/sdX -p Y -u 'initrd=\initramfs-linux.img' -l '\vmlinuz-linux' -L 'SKUF'</code> where <i>/dev/sdX</i> is the target disk and <i>Y</i> is the target <a href="../en/EFI_system_partition.html" class="mw-redirect" title="ESP">ESP</a> partition number.</div>
<h2><span class="mw-headline" id="See_also">See also</span></h2>
<ul>
<li><a rel="nofollow" class="external text" href="https://docs.kernel.org/admin-guide/nfs/nfsroot.html">kernel.org: Mounting the root filesystem via NFS (nfsroot)</a></li>
<li><a rel="nofollow" class="external text" href="https://wiki.syslinux.org/wiki/index.php/PXELINUX">syslinux.org: pxelinux FAQ</a></li>
</ul>
</div>
</div>
					<div id="catlinks" class="catlinks" data-mw="interface">
<div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../Special:Categories.html" title="Special:Categories">Category</a>: <ul><li><a href="../en/Category:Installation_process.html" title="Category:Installation process">Installation process</a></li></ul>
</div>
<div id="mw-hidden-catlinks" class="mw-hidden-catlinks mw-hidden-cats-hidden">Hidden categories: <ul>
<li><a href="../en/Category:Pages_or_sections_flagged_with_Template:Merge.html" title="Category:Pages or sections flagged with Template:Merge">Pages or sections flagged with Template:Merge</a></li>
<li><a href="../en/Category:Pages_or_sections_flagged_with_Template:Accuracy.html" title="Category:Pages or sections flagged with Template:Accuracy">Pages or sections flagged with Template:Accuracy</a></li>
</ul>
</div>
</div>
				</div>
			</main>
			
		</div>
		<div class="mw-footer-container">
			
<footer id="footer" class="mw-footer" role="contentinfo" style="margin: 0">
	<ul id="footer-info">
	<li data-nosnippet="">Retrieved from "<a dir="ltr" href="https://wiki.archlinux.org/index.php?title=Diskless_system&amp;oldid=808275">https://wiki.archlinux.org/index.php?title=Diskless_system&amp;oldid=808275</a>"</li>
<li id="footer-info-lastmod"> This page was last edited on 14 May 2024, at 10:55.</li>
	<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="https://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.3 or later</a> unless otherwise noted.</li>
<br>
</ul>

	<ul id="footer-places">
	<li id="footer-places-privacy"><a href="https://terms.archlinux.org/docs/privacy-policy/">Privacy policy</a></li>
	<li id="footer-places-about"><a href="../en/ArchWiki:About.html">About ArchWiki</a></li>
	<li id="footer-places-disclaimers"><a href="../en/ArchWiki:General_disclaimer.html">Disclaimers</a></li>
	<li id="footer-places-archwiki-code-of-conduct"><a href="https://terms.archlinux.org/docs/code-of-conduct/" class="extiw" title="archlinux-service-agreements:code-of-conduct">Code of conduct</a></li>
	<li id="footer-places-archwiki-terms-of-service"><a href="https://terms.archlinux.org/docs/terms-of-service/" class="extiw" title="archlinux-service-agreements:terms-of-service">Terms of service</a></li>
</ul>

	<ul id="footer-icons" class="noprint">
	<li id="footer-copyrightico"><a href="https://www.gnu.org/copyleft/fdl.html"><img src="/resources/assets/licenses/gnu-fdl.png" alt="GNU Free Documentation License 1.3 or later" width="88" height="31" loading="lazy"></a></li>
	<li id="footer-poweredbyico"><img src="/resources/assets/poweredby_mediawiki_88x31.png" srcset="/resources/assets/poweredby_mediawiki_132x47.png 1.5x, /resources/assets/poweredby_mediawiki_176x62.png 2x" width="88" height="31" loading="lazy"></li>
</ul>

</footer>

		</div>
	</div> 
</div> 
<div class="vector-settings" id="p-dock-bottom">
	<ul>
		<li>
		<button class="cdx-button cdx-button--icon-only vector-limited-width-toggle" id=""><span class="vector-icon mw-ui-icon-fullScreen mw-ui-icon-wikimedia-fullScreen"></span>

<span>Toggle limited content width</span>
</button>
</li>
	</ul>
</div>
</body>
</html>
