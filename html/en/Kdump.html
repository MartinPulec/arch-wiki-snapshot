<!DOCTYPE html>
<html class="client-nojs vector-feature-language-in-header-enabled vector-feature-language-in-main-page-header-disabled vector-feature-sticky-header-disabled vector-feature-page-tools-pinned-disabled vector-feature-toc-pinned-clientpref-1 vector-feature-main-menu-pinned-disabled vector-feature-limited-width-clientpref-1 vector-feature-limited-width-content-enabled vector-feature-custom-font-size-clientpref-0 vector-feature-appearance-pinned-clientpref-1 vector-feature-night-mode-disabled skin-theme-clientpref-day vector-toc-available" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>Kdump - ArchWiki</title>
<link rel="stylesheet" href="../ArchWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<meta name="generator" content="MediaWiki 1.43.0">
<meta name="referrer" content="no-referrer-when-downgrade">
<meta name="robots" content="max-image-preview:standard">
<meta name="format-detection" content="telephone=no">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=0.25, maximum-scale=5.0">
<link rel="search" type="application/opensearchdescription+xml" href="/rest.php/v1/search" title="ArchWiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.archlinux.org/api.php?action=rsd">
<link rel="license" href="https://www.gnu.org/copyleft/fdl.html">
<link rel="alternate" type="application/atom+xml" title="ArchWiki Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="skin--responsive skin-vector skin-vector-search-vue mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-Kdump rootpage-Kdump skin-vector-2022 action-view">
<a class="mw-jump-link" href="#bodyContent">Jump to content</a>
<div class="vector-header-container">
	</div>
<div class="mw-page-container">
	<div class="mw-page-container-inner">
		<div class="vector-column-start">
			<div class="vector-main-menu-container">
		</div>
	<div class="vector-sticky-pinned-container">
				<nav id="mw-panel-toc" aria-label="Contents" data-event-name="ui.sidebar-toc" class="mw-table-of-contents-container vector-toc-landmark">
					<div id="vector-toc-pinned-container" class="vector-pinned-container">
					<div id="vector-toc" class="vector-toc vector-pinnable-element">
	<div class="vector-pinnable-header vector-toc-pinnable-header vector-pinnable-header-pinned" data-feature-name="toc-pinned" data-pinnable-element-id="vector-toc">
	<h2 class="vector-pinnable-header-label">Contents</h2>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-pin-button" data-event-name="pinnable-header.vector-toc.pin">move to sidebar</button>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-unpin-button" data-event-name="pinnable-header.vector-toc.unpin">hide</button>
</div>


	<ul class="vector-toc-contents" id="mw-panel-toc-list">
		<li id="toc-mw-content-text" class="vector-toc-list-item vector-toc-level-1">
			<a href="#" class="vector-toc-link">
				<div class="vector-toc-text">Beginning</div>
			</a>
		</li>
		<li id="toc-Alternatives_to_setup_kdump" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#Alternatives_to_setup_kdump">
			<div class="vector-toc-text">
				<span class="vector-toc-numb">1</span>
				<span>Alternatives to setup kdump</span>
			</div>
		</a>
		
			<button aria-controls="toc-Alternatives_to_setup_kdump-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Alternatives to setup kdump subsection</span>
			</button>
		
		<ul id="toc-Alternatives_to_setup_kdump-sublist" class="vector-toc-list">
			<li id="toc-The_automatic_way:_kdumpst" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#The_automatic_way:_kdumpst">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">1.1</span>
					<span>The automatic way: kdumpst</span>
				</div>
			</a>
			
			<ul id="toc-The_automatic_way:_kdumpst-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-The_automatic_way:_simple-kdump" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#The_automatic_way:_simple-kdump">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">1.2</span>
					<span>The automatic way: simple-kdump</span>
				</div>
			</a>
			
			<ul id="toc-The_automatic_way:_simple-kdump-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Manual_steps" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Manual_steps">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">1.3</span>
					<span>Manual steps</span>
				</div>
			</a>
			
			<ul id="toc-Manual_steps-sublist" class="vector-toc-list">
				<li id="toc-Compiling_kernel" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Compiling_kernel">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">1.3.1</span>
					<span>Compiling kernel</span>
				</div>
			</a>
			
			<ul id="toc-Compiling_kernel-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Reuse_existing_kernel_and_initramfs" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Reuse_existing_kernel_and_initramfs">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">1.3.2</span>
					<span>Reuse existing kernel and initramfs</span>
				</div>
			</a>
			
			<ul id="toc-Reuse_existing_kernel_and_initramfs-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Setup_the_kdump_kernel" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Setup_the_kdump_kernel">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">1.3.3</span>
					<span>Setup the kdump kernel</span>
				</div>
			</a>
			
			<ul id="toc-Setup_the_kdump_kernel-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Testing_kdump_by_crashing_the_kernel" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Testing_kdump_by_crashing_the_kernel">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">1.3.4</span>
					<span>Testing kdump by crashing the kernel</span>
				</div>
			</a>
			
			<ul id="toc-Testing_kdump_by_crashing_the_kernel-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Saving_the_crashed_kernel_memory" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Saving_the_crashed_kernel_memory">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">1.3.5</span>
					<span>Saving the crashed kernel memory</span>
				</div>
			</a>
			
			<ul id="toc-Saving_the_crashed_kernel_memory-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Early_kdump_using_mkinitcpio" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Early_kdump_using_mkinitcpio">
				<div class="vector-toc-text">
					<span class="vector-toc-numb">1.3.6</span>
					<span>Early kdump using mkinitcpio</span>
				</div>
			</a>
			
			<ul id="toc-Early_kdump_using_mkinitcpio-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Analyzing_the_kernel_core_dump" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#Analyzing_the_kernel_core_dump">
			<div class="vector-toc-text">
				<span class="vector-toc-numb">2</span>
				<span>Analyzing the kernel core dump</span>
			</div>
		</a>
		
		<ul id="toc-Analyzing_the_kernel_core_dump-sublist" class="vector-toc-list">
		</ul>
	</li>
	<li id="toc-See_also" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#See_also">
			<div class="vector-toc-text">
				<span class="vector-toc-numb">3</span>
				<span>See also</span>
			</div>
		</a>
		
		<ul id="toc-See_also-sublist" class="vector-toc-list">
		</ul>
	</li>
</ul>
</div>

					</div>
		</nav>
			</div>
		</div>
		<div class="mw-content-container">
			<main id="content" class="mw-body" style="margin: 0">
				<header class="mw-body-header vector-page-titlebar">
					<nav aria-label="Contents" class="vector-toc-landmark">
						
<div id="vector-page-titlebar-toc" class="vector-dropdown vector-page-titlebar-toc vector-button-flush-left">
	<input type="checkbox" id="vector-page-titlebar-toc-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-vector-page-titlebar-toc" class="vector-dropdown-checkbox " aria-label="Toggle the table of contents">
	<label id="vector-page-titlebar-toc-label" for="vector-page-titlebar-toc-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--icon-only " aria-hidden="true"><span class="vector-icon mw-ui-icon-listBullet mw-ui-icon-wikimedia-listBullet"></span>

<span class="vector-dropdown-label-text">Toggle the table of contents</span>
	</label>
	<div class="vector-dropdown-content">


							<div id="vector-page-titlebar-toc-unpinned-container" class="vector-unpinned-container">
			</div>
		
	</div>
</div>

					</nav>
					<h1 id="firstHeading" class="firstHeading mw-first-heading"><span class="mw-page-title-main">Kdump</span></h1>
							
<div id="p-lang-btn" class="vector-dropdown mw-portlet mw-portlet-lang">
	<input type="checkbox" id="p-lang-btn-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-p-lang-btn" class="vector-dropdown-checkbox mw-interlanguage-selector" aria-label="Go to an article in another language. Available in 1 language">
	<label id="p-lang-btn-label" for="p-lang-btn-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--action-progressive mw-portlet-lang-heading-1" aria-hidden="true"><span class="vector-icon mw-ui-icon-language-progressive mw-ui-icon-wikimedia-language-progressive"></span>

<span class="vector-dropdown-label-text">1 language</span>
	</label>
	<div class="vector-dropdown-content">

		<div class="vector-menu-content">
			
			<ul class="vector-menu-content-list">
				
				<li class="interlanguage-link interwiki-ja mw-list-item"><a href="https://wiki.archlinux.jp/index.php/Kdump" title="Kdump – 日本語" lang="ja" hreflang="ja" data-title="Kdump" data-language-autonym="日本語" data-language-local-name="日本語" class="interlanguage-link-target"><span>日本語</span></a></li>
			</ul>
			
		</div>

	</div>
</div>
</header>
				<div class="vector-column-end">
					<div class="vector-sticky-pinned-container">
						<nav class="vector-page-tools-landmark" aria-label="Page tools">
							<div id="vector-page-tools-pinned-container" class="vector-pinned-container">
				
							</div>
		</nav>
						<nav class="vector-appearance-landmark" aria-label="Appearance">
							<div id="vector-appearance-pinned-container" class="vector-pinned-container">
				<div id="vector-appearance" class="vector-appearance vector-pinnable-element">
	<div class="vector-pinnable-header vector-appearance-pinnable-header vector-pinnable-header-pinned" data-feature-name="appearance-pinned" data-pinnable-element-id="vector-appearance" data-pinned-container-id="vector-appearance-pinned-container" data-unpinned-container-id="vector-appearance-unpinned-container">
	<div class="vector-pinnable-header-label">Appearance</div>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-pin-button" data-event-name="pinnable-header.vector-appearance.pin">move to sidebar</button>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-unpin-button" data-event-name="pinnable-header.vector-appearance.unpin">hide</button>
</div>


</div>

							</div>
		</nav>
					</div>
				</div>
				<div id="bodyContent" class="vector-body" aria-labelledby="firstHeading" data-mw-ve-target-container>
					<div class="vector-body-before-content">
							<div class="mw-indicators">
		</div>

						<div id="siteSub" class="noprint">From ArchWiki</div>
					</div>
					<div id="contentSub"><div id="mw-content-subtitle"></div></div>
					
					
					<div id="mw-content-text" class="mw-body-content">
<div class="mw-content-ltr mw-parser-output" lang="en" dir="ltr">
<div class="archwiki-template-meta-related-articles">
<p>Related articles</p>
<ul>
<li><a href="../en/Kexec.html" title="Kexec">Kexec</a></li>
</ul>
</div>
<p><a rel="nofollow" class="external text" href="https://docs.kernel.org/admin-guide/kdump/kdump.html">Kdump</a> is a standard Linux mechanism to dump machine memory content on kernel crash. Kdump is based on <a href="../en/Kexec.html" title="Kexec">Kexec</a>. Kdump utilizes two kernels: the regular system kernel and kdump capture kernel (called from now on, the kdump kernel). System kernel is the normal kernel, booted with the <code>crashkernel</code> parameter - we need to tell the system kernel to reserve some amount of physical memory where the kdump kernel will be loaded/executed. Then it's necessary to load the kdump kernel in advance, because when the system kernel crashes, there is no reliable way to read data from disk, for example, given that such kernel is broken.
</p>
<p>Once a kernel crash happens, the system kernel crash handler uses the <a href="../en/Kexec.html" title="Kexec">Kexec</a> mechanism to boot the kdump kernel in its pre-reserved memory. The memory from system kernel is preserved in such kexec boot, and it's accessible from the kdump kernel at the moment of crash. Once the kdump kernel is booted, the user can collect the file <code>/proc/vmcore</code> to get access to memory of the crashed system kernel. Such crash dump can be saved to disk or copied over network to some other machine for further post-mortem investigation.
</p>
<p>In server production environments, the system and kdump kernels could be different - system kernel needs a lot of features and is compiled with a many kernel flags/drivers, while the kdump kernel goal is to be minimalistic and take as small amount of memory as possible, e.g. it could be compiled without network support if we store the crash dump to disk only. But for desktops and in general, for non-specific setups, the same kernel is used both as system and kdump kernels. It means we will load the same kernel code twice - one time as normal system kernel, another one to the reserved memory area, but with different kernel parameters.
</p>
<meta property="mw:PageProp/toc">
<h2><span class="mw-headline" id="Alternatives_to_setup_kdump">Alternatives to setup kdump</span></h2>
<h3><span class="mw-headline" id="The_automatic_way:_kdumpst">The automatic way: kdumpst</span></h3>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> kdumpst implicitly depends on GRUB and does not work with other boot loaders, see <a rel="nofollow" class="external free" href="https://gitlab.freedesktop.org/gpiccoli/kdumpst/-/issues/21">https://gitlab.freedesktop.org/gpiccoli/kdumpst/-/issues/21</a>
</div>
<p>The <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/kdumpst/">kdumpst</a></span><sup><small>AUR</small></sup> tool is an automatic way for loading kdump. It's highly customizable - it defaults to another method of log collecting (called pstore), but can be easily set to use kdump (a matter of setting <code>USE_PSTORE_RAM=0</code> on <code>/usr/share/kdumpst.d/00-default</code>. The tool also fallbacks to kdump in case pstore RAM region isn't available.
</p>
<p>After installing kdumpst, one can check the journal and the following message means kdump is loaded: <code>kdumpst: panic kexec loaded successfully</code>. If a kernel crash happens, the kdump will be collected and in the subsequent boot, a message indicates the success of the operation: <code>kdumpst: logs saved in "/var/crash/kdumpst/logs"</code>. In that folder, the user will find a lightweight zip blob, that included a dmesg plus some extra data. The vmcore itself is saved on <code>/var/crash/kdumpst/crash</code>. For questions/issues, the #kdump IRC channel at OFTC could be used, or open issues in the kdumpst repository.
</p>
<h3><span class="mw-headline" id="The_automatic_way:_simple-kdump">The automatic way: simple-kdump</span></h3>
<p>The <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/simple-kdump/">simple-kdump</a></span><sup><small>AUR</small></sup> tool provides a simple and easy-to-config way to setup and collect kdump.
Unlike <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/kdumpst/">kdumpst</a></span><sup><small>AUR</small></sup>, it is bootloader independent, has one and only one objective, save the vmcore file
to <code>/var/crash/</code>.
</p>
<p>It's mostly all the manual setups mentioned in later sections with slightly better organization using systemd, but re-use the Archlinux kernels (or whatever kernel the end user choose), so it's super flex and simple.
</p>
<p>After installing <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/simple-kdump/">simple-kdump</a></span><sup><small>AUR</small></sup>, fill <code>/etc/conf.d/simple-kdump.conf</code> using any booting kernel/initramfs combination, which has the <code>CONFIG_PROC_VMCORE=y</code> enabled.
It's recommended to use the Archlinux linux or linux-lts kernel, which already have all the needed features enabled.
</p>
<p>Then add <code>crashkernel=[size]</code> <a href="../en/Kernel_parameters.html" class="mw-redirect" title="Kernel parameter">kernel parameter</a> and reboot. Recommended to use value no smaller than 512M
</p>
<p>Finally enable and start <code>simple-kdump-setup.service</code>, then refer to <a href="#Testing_kdump_by_crashing_the_kernel">#Testing kdump by crashing the kernel</a> to verify the kdump behavior.
</p>
<p>The kexec kernel should reach target <code>Emergency Mode to collect vmcore</code>, with a prompt asking login for the emergency shell. You can ignore that login as the vmcore collection will happen at the background and reboot automatically.
</p>
<p>After the reboot, there should be a new crash dump at <code>/var/crash/crashdump-*</code>.
</p>
<h3><span class="mw-headline" id="Manual_steps">Manual steps</span></h3>
<p>In case the preference is for doing that manually, the below guide will help with that.
</p>
<h4><span class="mw-headline" id="Compiling_kernel">Compiling kernel</span></h4>
<p>Both System/kdump kernels requires some configuration flags that may not be set by default. Please consult <a href="../en/Kernel.html#Compilation" class="mw-redirect" title="Kernel Compilation">Kernel Compilation</a> article for more information about compiling a custom kernel in Arch. Here we will emphasize on Kdump specific configurations. Current default Arch kernel builds have these flags already set.  You can verify if your running kernel has these set by looking in <code>/proc/config.gz</code>.
</p>
<p>Please note that, the default <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=linux">linux</a></span> and <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=linux-lts">linux-lts</a></span> kernels all have the needed options enabled.
But unfortunately the default kernels have debug info striped, thus one still needs to recompile the kernel to have all the debug info so that the vmcore can be properly analyzed.
</p>
<p>To create a kernel you need to edit the kernel <code>.config</code> file and enable following configuration options:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">.config</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">CONFIG_DEBUG_INFO=y
CONFIG_CRASH_DUMP=y
CONFIG_PROC_VMCORE=y
CONFIG_DEBUG_INFO=y
COFNIG_DEBUG_INFO_BTF=y</pre>
<p>The last two are for the extra debuginfo so that tools like <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=crash">crash</a></span> or <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=drgn">drgn</a></span> can analyze the vmcore.
(Or is there a way to use debuginfod to download the kernel debuginfo?)
</p>
<p>Also change package base name to something like <b>linux-kdump</b> to distinguish the kernel from the default Arch one. Compile kernel package and install it. Save <i>./src/linux-X.Y/vmlinux</i> uncompressed system kernel binary - it contains debug symbols and you will need them later when analyzing the crash.
</p>
<p>For reference, some details about building a kdump kernel or configuring the kernel parameters for kdump could be found in the kernel <a rel="nofollow" class="external text" href="https://docs.kernel.org/admin-guide/kdump/kdump.html">Kdump</a> documentation.
</p>
<h4><span class="mw-headline" id="Reuse_existing_kernel_and_initramfs">Reuse existing kernel and initramfs</span></h4>
<p>The simplest way to setup kdump is to use the existing kernel and initramfs.
The example here will use <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=linux">linux</a></span> kernel as an example,
which generates its initramfs at <code>/boot/initramfs-linux.img</code>.
</p>
<p>The core idea is to boot the kexec environment just as a regular Archlinux boot sequence.
But with extra systemd options to slightly change the boot sequence (to skip re-setup kexec environment, collect vmcore, and reboot).
</p>
<p>Thus we do not need to generate a special initramfs, unlike other distros (and our default initramfs generated by <a href="../en/Mkinitcpio.html" title="Mkinitcpio">mkinitcpio</a> is already way smaller than our competitors).
</p>
<h4><span class="mw-headline" id="Setup_the_kdump_kernel">Setup the kdump kernel</span></h4>
<p>First, you need to reserve memory in the system kernel, for the kdump kernel loading. Edit your bootloader configuration and add <code>crashkernel=[size]</code> <a href="../en/Kernel_parameters.html" class="mw-redirect" title="Kernel parameter">kernel parameter</a>.
</p>
<p>Depending on the machine and how the kdump kernel was built, something from <i>256M</i> to <i>512M</i> is usually enough - it worth trying after setting everything to check if it succeeds. Note that the reserved memory is unavailable to the system kernel.
</p>
<p>Reboot into your system kernel.  To make sure that the kernel is booted with correct options please check the files <code>/proc/cmdline</code> and <code>/sys/kernel/kexec_crash_size</code> to see if the memory was indeed pre-reserved (sometimes it's possible , though rare, that such memory reservation fails - if it happens, check the <code>dmesg</code> to get more information).
</p>
<p>Next you need to tell <a href="../en/Kexec.html" title="Kexec">Kexec</a> that you want to use your kdump kernel. Specify your kernel, initramfs file, root device and other parameters if needed: (here we use default <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=linux">linux</a></span> kernel)
</p>
<pre># kexec -p /boot/vmlinuz-linux --initrd=/boot/initramfs-linux.img] --append="root=[root-device] irqpoll nr_cpus=1 reset_devices"
</pre>
<p>It loads the kdump kernel into the reserved area. Without the <code>-p</code> flag <i>kexec</i> would boot the kernel right away, but in presence of such flag, the kdump kernel will be loaded into the reserved memory but its boot is postponed until a crash happens.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> The parameter <code>nr_cpus=1</code> restricts the CPUs to 1 in the kdump environment, which is both memory saving (CPUs structures consume memory!) and also safer, as it restricts the surface for potential concurrency issues. If that option for some reason fails, there is another one to be used, instead: <code>maxcpus=1</code>. The second one consumes a bit more memory, since it initializes other CPUS structures but disables such CPUS except CPU0, whereas the <code>nr_cpus</code> one effectively drops the other CPUs structures. More information in the kernel <a rel="nofollow" class="external text" href="https://docs.kernel.org/core-api/cpu_hotplug.html">CPU hotplug</a> docs.</div>
<p>Instead of running <i>kexec</i> manually you might want to setup <a href="../en/Systemd.html" title="Systemd">Systemd</a> service that will run kexec on boot:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/kdump.service</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Unit]
Description=Load the kdump kernel
After=local-fs.target

[Service]
Type=oneshot
RemainAfterExit=true
ExecStart=/usr/bin/kexec -p /boot/vmlinuz-linux --initrd=/boot/initramfs-linux.img --append="root=[root-device] irqpoll nr_cpus=1 reset_devices systemd.mask=kdump.service"
ExecStop=/usr/bin/kexec -p -u

[Install]
WantedBy=multi-user.target
</pre>
<p>Then <a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Enable">enable</a> <code>kdump.service</code>.
</p>
<p>Note, since the service is enabled, and our kexec environment boots exactly like a regular boot,
it will try to start <code>kdump.service</code> but fail since there is not enough memory.
Thus in the <code>--append=</code> option, <code>systemd.mask=kdump.service</code> is specified to avoid the kdump service itself.
</p>
<p>To check whether the crash kernel is already loaded please run following command:
</p>
<pre>$ cat /sys/kernel/kexec_crash_loaded
</pre>
<h4><span class="mw-headline" id="Testing_kdump_by_crashing_the_kernel">Testing kdump by crashing the kernel</span></h4>
<p>
If you want to test crash then you can use <i>sysrq</i> for this. </p>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> a kernel crash may corrupt data on your disks, run it at your own risk!</div>
<pre># sync; echo 1 &gt; /proc/sys/kernel/sysrq; echo c &gt; /proc/sysrq-trigger
</pre>
<p>Once crash happens kexec will load your kdump kernel, which should look exactly like a regular boot, but with much smaller memory (the reserved size) and only one CPU core.
</p>
<h4><span class="mw-headline" id="Saving_the_crashed_kernel_memory">Saving the crashed kernel memory</span></h4>
<p>Once booted into the kdump kernel, the idea is to save the relevant contents from <code>/proc/vmcore</code> to analyze it later. Though this is exposed as a file (hence it's possible to copy it, like in <code>cp /proc/vmcore /root/vmcore.crashdump</code>, this is not the recommended way. The vmcore is a full copy of system memory, so this file will have 64G if your machine has 64G, for example. It includes all data from all the userpace loaded, as well as free memory. So, the best way for saving it is use the <code>makedumpfile</code> utility. Such application is able to remove free memory and userspace irrelevant data, as well as compress the vmcore! Example of the usage:
</p>
<pre># makedumpfile -z -d 31 /proc/vmcore /root/vmcore.crashdump_compressed
</pre>
<p>You can also save out the dmesg log from the crashed kernel using this command:
</p>
<pre># makedumpfile --dump-dmesg /proc/vmcore /root/vmcore.dmesg
</pre>
<p>The following systemd service can be used to automatically save the crash dumps and reboot into the system kernel again:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/kdump-save.service</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Unit]
Description=Save the kernel crash dump after a crash
After=multi-user.target

[Service]
Type=idle
ExecStart=/bin/sh -c 'mkdir -p /var/crash/ &amp;&amp; /usr/bin/makedumpfile -z -d 31 /proc/vmcore "/var/crash/crashdump-$$(date +%%F-%%T)"'
ExecStopPost=/usr/bin/systemctl reboot
UMask=0077
</pre>
<p>This can be invoked from the kdump kernel command line - for that, we should edit the kdump load service as below:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/kdump.service</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Unit]
Description=Load the kdump kernel
After=local-fs.target

[Service]
Type=oneshot
RemainAfterExit=true
ExecStart=/usr/bin/kexec -p /boot/vmlinuz-linux --initrd=/boot/initramfs-linux.img --append="root=[root-device] irqpoll nr_cpus=1 reset_devices systemd.mask=kdump.service systemd.unit=kdump-save.service"
ExecStop=/usr/bin/kexec -p -u

[Install]
WantedBy=multi-user.target
</pre>
<h4><span class="mw-headline" id="Early_kdump_using_mkinitcpio">Early kdump using mkinitcpio</span></h4>
<p>You might encounter a situation where the kernel crashes before the systemd service can be started.  In this case, it might be helpful to run kexec as a mkinitcpio hook rather than a service.
</p>
<p>First make a copy of your initramfs.  This will be used to run the crash kernel. 
</p>
<pre># cp /boot/initramfs-linux.img /boot/initramfs-linux-crash.img
</pre>
<p>Next, create the mkinitcpio install file.  This builds allows us to build the main initramfs with a copy of the crash initramfs for the crash kernel and the 
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/initcpio/install/kdump</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">build() {
        add_binary kexec
        add_file /boot/initramfs-linux-crash.img /crash/initramfs.img
        add_file /boot/vmlinuz-linux /crash/vmlinuz
        add_runscript
}

help() {
        cat &lt;&lt;HELPEOF
Installs the crash kernel on boot
HELPEOF
}
</pre>
<p>Next, make the mkinitcpio hook file.  This runs kexec as an earlyhook, hopefully before anything in the kernel can crash.  An important note here is that we run the kernel in emergency mode, because running the kernel in rescue or normal might might just lead to another the same crash happening in the crash kernel.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/initcpio/hook/kdump</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">run_earlyhook() {
	msg 'Loading crash kernel..'
	if [ -e /crash/vmlinuz ]; then
		if [ -e /crash/initramfs.img ]; then
			kexec -p /crash/vmlinuz --initrd=/crash/initramfs.img --append="root=[root-device] irqpoll nr_cpus=1 reset_devices emergency"
		else
			msg 'No initramfs found'
		fi
	else
		msg 'No vmlinuz found'
	fi
}
</pre>
<p>Now run mkinitcpio with the new hook
</p>
<pre># mkinitcpio -A kdump
</pre>
<p>When the crash happens, you will be loaded into emergency kernel mode.  After entering your password, you will be at a terminal.  The first thing you will need to do is make your root filesystem writable.
</p>
<pre>$ mount -o remount, rw /
</pre>
<p>Now you can save the dump using makedumpfile (see <a href="#Saving_the_crashed_kernel_memory">#Saving the crashed kernel memory</a>)
</p>
<h2><span class="mw-headline" id="Analyzing_the_kernel_core_dump">Analyzing the kernel core dump</span></h2>
<p>The best way for studying the saved kernel core dump involves tools aimed specifically at that. The most common alternative is the gdb-based <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=crash">crash</a></span>. Run <i>crash</i> as in
</p>
<pre>$ crash <i>vmlinux</i> <i>path</i>/crash.dump
</pre>
<p>Where the <i>vmlinux</i> should contain debug symbols included in order to extract more information from the saved crash dump.
</p>
<p>Follow <i>man crash</i> or <a rel="nofollow" class="external autonumber" href="https://crash-utility.github.io/crash_whitepaper.html">[1]</a> for more information about debugging practices.
</p>
<p>Another recent alternative is <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=drgn">drgn</a></span>, a python-based and fully scriptable tool to extract information from the vmcore.
</p>
<h2><span class="mw-headline" id="See_also">See also</span></h2>
<ul>
<li>
<a rel="nofollow" class="external free" href="https://docs.kernel.org/admin-guide/kdump/kdump.html">https://docs.kernel.org/admin-guide/kdump/kdump.html</a> - Official kdump documentation</li>
<li>
<a rel="nofollow" class="external free" href="https://www.dedoimedo.com/computers/www.dedoimedo.com-crash-book.pdf">https://www.dedoimedo.com/computers/www.dedoimedo.com-crash-book.pdf</a> - The crash book</li>
<li>
<a rel="nofollow" class="external free" href="https://gitlab.freedesktop.org/gpiccoli/kdumpst/">https://gitlab.freedesktop.org/gpiccoli/kdumpst/</a> - kdumpst repository</li>
<li>
<a rel="nofollow" class="external free" href="https://crash-utility.github.io">https://crash-utility.github.io</a> - The crash website</li>
<li>
<a rel="nofollow" class="external free" href="https://drgn.readthedocs.io/">https://drgn.readthedocs.io/</a> - The drgn documentation website</li>
</ul>
</div>
</div>
					<div id="catlinks" class="catlinks" data-mw="interface"><div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../Special:Categories.html" title="Special:Categories">Categories</a>: <ul>
<li><a href="../en/Category:Boot_process.html" title="Category:Boot process">Boot process</a></li>
<li><a href="../en/Category:Kernel.html" title="Category:Kernel">Kernel</a></li>
</ul>
</div></div>
				</div>
			</main>
			
		</div>
		<div class="mw-footer-container">
			
<footer id="footer" class="mw-footer" style="margin: 0">
	<ul id="footer-info">
	<li data-nosnippet="">Retrieved from "<a dir="ltr" href="https://wiki.archlinux.org/index.php?title=Kdump&amp;oldid=827886">https://wiki.archlinux.org/index.php?title=Kdump&amp;oldid=827886</a>"</li>
<li id="footer-info-lastmod"> This page was last edited on 27 February 2025, at 06:53.</li>
	<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="https://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.3 or later</a> unless otherwise noted.</li>
<br>
</ul>

	<ul id="footer-places">
	<li id="footer-places-privacy"><a href="https://terms.archlinux.org/docs/privacy-policy/">Privacy policy</a></li>
	<li id="footer-places-about"><a href="../en/ArchWiki:About.html">About ArchWiki</a></li>
	<li id="footer-places-disclaimers"><a href="../en/ArchWiki:General_disclaimer.html">Disclaimers</a></li>
	<li id="footer-places-archwiki-code-of-conduct"><a href="https://terms.archlinux.org/docs/code-of-conduct/" class="extiw" title="archlinux-service-agreements:code-of-conduct">Code of conduct</a></li>
	<li id="footer-places-archwiki-terms-of-service"><a href="https://terms.archlinux.org/docs/terms-of-service/" class="extiw" title="archlinux-service-agreements:terms-of-service">Terms of service</a></li>
</ul>

	<ul id="footer-icons" class="noprint">
	<li id="footer-copyrightico"><a href="https://www.gnu.org/copyleft/fdl.html" class="cdx-button cdx-button--fake-button cdx-button--size-large cdx-button--fake-button--enabled"><img src="/resources/assets/licenses/gnu-fdl.png" alt="GNU Free Documentation License 1.3 or later" width="88" height="31" loading="lazy"></a></li>
	<li id="footer-poweredbyico"><img src="/resources/assets/poweredby_mediawiki.svg" width="88" height="31" loading="lazy"></li>
</ul>

</footer>

		</div>
	</div> 
</div> 
<div class="vector-settings" id="p-dock-bottom">
	<ul></ul>
</div>
</body>
</html>
