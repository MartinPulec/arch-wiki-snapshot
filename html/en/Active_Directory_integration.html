<!DOCTYPE html>
<html class="client-nojs vector-feature-language-in-header-enabled vector-feature-language-in-main-page-header-disabled vector-feature-sticky-header-disabled vector-feature-page-tools-pinned-disabled vector-feature-toc-pinned-clientpref-1 vector-feature-main-menu-pinned-disabled vector-feature-limited-width-clientpref-1 vector-feature-limited-width-content-enabled vector-feature-custom-font-size-clientpref-0 vector-feature-client-preferences-disabled vector-feature-client-prefs-pinned-disabled vector-feature-night-mode-disabled skin-theme-clientpref-day vector-toc-available" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>Active Directory integration - ArchWiki</title>
<link rel="stylesheet" href="../ArchWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<meta name="generator" content="MediaWiki 1.42.1">
<meta name="referrer" content="no-referrer-when-downgrade">
<meta name="robots" content="max-image-preview:standard">
<meta name="format-detection" content="telephone=no">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=0.25, maximum-scale=5.0">
<link rel="icon" href="/favicon.ico">
<link rel="search" type="application/opensearchdescription+xml" href="/opensearch_desc.php" title="ArchWiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.archlinux.org/api.php?action=rsd">
<link rel="license" href="https://www.gnu.org/copyleft/fdl.html">
<link rel="alternate" type="application/atom+xml" title="ArchWiki Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="skin-vector skin-vector-search-vue mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-Active_Directory_integration rootpage-Active_Directory_integration skin-vector-2022 action-view skin--responsive">
<a class="mw-jump-link" href="#bodyContent">Jump to content</a>
<div class="vector-header-container">
	</div>
<div class="mw-page-container">
	<div class="mw-page-container-inner">
		<div class="vector-column-start">
			<div class="vector-main-menu-container">
		</div>
	<div class="vector-sticky-pinned-container">
				<nav id="mw-panel-toc" role="navigation" aria-label="Contents" data-event-name="ui.sidebar-toc" class="mw-table-of-contents-container vector-toc-landmark">
					<div id="vector-toc-pinned-container" class="vector-pinned-container">
					<div id="vector-toc" class="vector-toc vector-pinnable-element">
	<div class="vector-pinnable-header vector-toc-pinnable-header vector-pinnable-header-pinned" data-feature-name="toc-pinned" data-pinnable-element-id="vector-toc">
	<h2 class="vector-pinnable-header-label">Contents</h2>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-pin-button" data-event-name="pinnable-header.vector-toc.pin">move to sidebar</button>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-unpin-button" data-event-name="pinnable-header.vector-toc.unpin">hide</button>
</div>


	<ul class="vector-toc-contents" id="mw-panel-toc-list">
		<li id="toc-mw-content-text" class="vector-toc-list-item vector-toc-level-1">
			<a href="#" class="vector-toc-link">
				<div class="vector-toc-text">Beginning</div>
			</a>
		</li>
		<li id="toc-Introduction" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#Introduction">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">1</span>Introduction</div>
		</a>
		
		<ul id="toc-Introduction-sublist" class="vector-toc-list">
		</ul>
	</li>
	<li id="toc-Needed_software" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#Needed_software">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">2</span>Needed software</div>
		</a>
		
		<ul id="toc-Needed_software-sublist" class="vector-toc-list">
		</ul>
	</li>
	<li id="toc-Initial_configuration_of_services" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#Initial_configuration_of_services">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">3</span>Initial configuration of services</div>
		</a>
		
			<button aria-controls="toc-Initial_configuration_of_services-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Initial configuration of services subsection</span>
			</button>
		
		<ul id="toc-Initial_configuration_of_services-sublist" class="vector-toc-list">
			<li id="toc-DNS_configuration" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#DNS_configuration">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.1</span>DNS configuration</div>
			</a>
			
			<ul id="toc-DNS_configuration-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-NTP_configuration" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#NTP_configuration">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.2</span>NTP configuration</div>
			</a>
			
			<ul id="toc-NTP_configuration-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Kerberos_configuration" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Kerberos_configuration">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.3</span>Kerberos configuration</div>
			</a>
			
			<ul id="toc-Kerberos_configuration-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Samba_configuration" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Samba_configuration">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.4</span>Samba configuration</div>
			</a>
			
			<ul id="toc-Samba_configuration-sublist" class="vector-toc-list">
				<li id="toc-Base_Samba_configuration_file" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Base_Samba_configuration_file">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.4.1</span>Base Samba configuration file</div>
			</a>
			
			<ul id="toc-Base_Samba_configuration_file-sublist" class="vector-toc-list">
				<li id="toc-Adding_the_idmap_configuration_for_domains_with_RFC2307_extensions" class="vector-toc-list-item vector-toc-level-4">
			<a class="vector-toc-link" href="#Adding_the_idmap_configuration_for_domains_with_RFC2307_extensions">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.4.1.1</span>Adding the idmap configuration for domains with RFC2307 extensions</div>
			</a>
			
			<ul id="toc-Adding_the_idmap_configuration_for_domains_with_RFC2307_extensions-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Adding_the_idmap_configuration_for_domains_without_RFC2307_extensions" class="vector-toc-list-item vector-toc-level-4">
			<a class="vector-toc-link" href="#Adding_the_idmap_configuration_for_domains_without_RFC2307_extensions">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.4.1.2</span>Adding the idmap configuration for domains without RFC2307 extensions</div>
			</a>
			
			<ul id="toc-Adding_the_idmap_configuration_for_domains_without_RFC2307_extensions-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
	</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Joining_the_domain" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#Joining_the_domain">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">4</span>Joining the domain</div>
		</a>
		
		<ul id="toc-Joining_the_domain-sublist" class="vector-toc-list">
		</ul>
	</li>
	<li id="toc-Start_the_individual_Samba_services" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#Start_the_individual_Samba_services">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">5</span>Start the individual Samba services</div>
		</a>
		
		<ul id="toc-Start_the_individual_Samba_services-sublist" class="vector-toc-list">
		</ul>
	</li>
	<li id="toc-Configure_NSS" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#Configure_NSS">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">6</span>Configure NSS</div>
		</a>
		
			<button aria-controls="toc-Configure_NSS-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Configure NSS subsection</span>
			</button>
		
		<ul id="toc-Configure_NSS-sublist" class="vector-toc-list">
			<li id="toc-Testing_NSS" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Testing_NSS">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">6.1</span>Testing NSS</div>
			</a>
			
			<ul id="toc-Testing_NSS-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Configuring_PAM_authentication" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#Configuring_PAM_authentication">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">7</span>Configuring PAM authentication</div>
		</a>
		
		<ul id="toc-Configuring_PAM_authentication-sublist" class="vector-toc-list">
		</ul>
	</li>
	<li id="toc-Old_Wiki_Article" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#Old_Wiki_Article">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">8</span>Old Wiki Article</div>
		</a>
		
			<button aria-controls="toc-Old_Wiki_Article-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Old Wiki Article subsection</span>
			</button>
		
		<ul id="toc-Old_Wiki_Article-sublist" class="vector-toc-list">
			<li id="toc-Terminology" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Terminology">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.1</span>Terminology</div>
			</a>
			
			<ul id="toc-Terminology-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Active_Directory_configuration" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Active_Directory_configuration">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.2</span>Active Directory configuration</div>
			</a>
			
			<ul id="toc-Active_Directory_configuration-sublist" class="vector-toc-list">
				<li id="toc-GPO_considerations" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#GPO_considerations">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.2.1</span><s>GPO considerations</s>
</div>
			</a>
			
			<ul id="toc-GPO_considerations-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Linux_host_configuration" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Linux_host_configuration">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.3</span><s>Linux host configuration</s>
</div>
			</a>
			
			<ul id="toc-Linux_host_configuration-sublist" class="vector-toc-list">
				<li id="toc-Installation" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Installation">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.3.1</span><s>Installation</s>
</div>
			</a>
			
			<ul id="toc-Installation-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Updating_DNS" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Updating_DNS">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.3.2</span><s>Updating DNS</s>
</div>
			</a>
			
			<ul id="toc-Updating_DNS-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Configuring_NTP" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Configuring_NTP">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.3.3</span><s>Configuring NTP</s>
</div>
			</a>
			
			<ul id="toc-Configuring_NTP-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Kerberos" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Kerberos">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.3.4</span><s>Kerberos</s>
</div>
			</a>
			
			<ul id="toc-Kerberos-sublist" class="vector-toc-list">
				<li id="toc-Creating_a_Kerberos_ticket" class="vector-toc-list-item vector-toc-level-4">
			<a class="vector-toc-link" href="#Creating_a_Kerberos_ticket">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.3.4.1</span><s>Creating a Kerberos ticket</s>
</div>
			</a>
			
			<ul id="toc-Creating_a_Kerberos_ticket-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Validating_the_Ticket" class="vector-toc-list-item vector-toc-level-4">
			<a class="vector-toc-link" href="#Validating_the_Ticket">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.3.4.2</span><s>Validating the Ticket</s>
</div>
			</a>
			
			<ul id="toc-Validating_the_Ticket-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-pam_winbind.conf" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#pam_winbind.conf">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.3.5</span><s>pam_winbind.conf</s>
</div>
			</a>
			
			<ul id="toc-pam_winbind.conf-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Samba" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Samba">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.3.6</span><s>Samba</s>
</div>
			</a>
			
			<ul id="toc-Samba-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Join_the_domain" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Join_the_domain">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.3.7</span><s>Join the domain</s>
</div>
			</a>
			
			<ul id="toc-Join_the_domain-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Starting_and_testing_services" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Starting_and_testing_services">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.4</span><s>Starting and testing services</s>
</div>
			</a>
			
			<ul id="toc-Starting_and_testing_services-sublist" class="vector-toc-list">
				<li id="toc-Starting_Samba" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Starting_Samba">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.4.1</span><s>Starting Samba</s>
</div>
			</a>
			
			<ul id="toc-Starting_Samba-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Testing_Winbind" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Testing_Winbind">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.4.2</span><s>Testing Winbind</s>
</div>
			</a>
			
			<ul id="toc-Testing_Winbind-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Testing_nsswitch" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Testing_nsswitch">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.4.3</span><s>Testing nsswitch</s>
</div>
			</a>
			
			<ul id="toc-Testing_nsswitch-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Testing_Samba_commands" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Testing_Samba_commands">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.4.4</span>Testing Samba commands</div>
			</a>
			
			<ul id="toc-Testing_Samba_commands-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Configuring_PAM" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Configuring_PAM">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.5</span><s>Configuring PAM</s>
</div>
			</a>
			
			<ul id="toc-Configuring_PAM-sublist" class="vector-toc-list">
				<li id="toc-system-auth" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#system-auth">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.5.1</span><s>system-auth</s>
</div>
			</a>
			
			<ul id="toc-system-auth-sublist" class="vector-toc-list">
				<li id='toc-"auth"_section' class="vector-toc-list-item vector-toc-level-4">
			<a class="vector-toc-link" href='#"auth"_section'>
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.5.1.1</span><s>"auth" section</s>
</div>
			</a>
			
			<ul id='toc-"auth"_section-sublist' class="vector-toc-list">
			</ul>
		</li>
		<li id='toc-"account"_section' class="vector-toc-list-item vector-toc-level-4">
			<a class="vector-toc-link" href='#"account"_section'>
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.5.1.2</span><s>"account" section</s>
</div>
			</a>
			
			<ul id='toc-"account"_section-sublist' class="vector-toc-list">
			</ul>
		</li>
		<li id='toc-"password"_section' class="vector-toc-list-item vector-toc-level-4">
			<a class="vector-toc-link" href='#"password"_section'>
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.5.1.3</span><s>"password" section</s>
</div>
			</a>
			
			<ul id='toc-"password"_section-sublist' class="vector-toc-list">
			</ul>
		</li>
		<li id='toc-"session"_section' class="vector-toc-list-item vector-toc-level-4">
			<a class="vector-toc-link" href='#"session"_section'>
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.5.1.4</span><s>"session" section</s>
</div>
			</a>
			
			<ul id='toc-"session"_section-sublist' class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-passwd" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#passwd">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.5.2</span><s>passwd</s>
</div>
			</a>
			
			<ul id="toc-passwd-sublist" class="vector-toc-list">
				<li id='toc-"password"_section_2' class="vector-toc-list-item vector-toc-level-4">
			<a class="vector-toc-link" href='#"password"_section_2'>
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.5.2.1</span><s>"password" section</s>
</div>
			</a>
			
			<ul id='toc-"password"_section_2-sublist' class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Testing_login" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Testing_login">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.5.3</span><s>Testing login</s>
</div>
			</a>
			
			<ul id="toc-Testing_login-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Configuring_Shares" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Configuring_Shares">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.6</span>Configuring Shares</div>
			</a>
			
			<ul id="toc-Configuring_Shares-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Adding_a_machine_keytab_file_and_activating_password-free_kerberized_ssh_to_the_machine" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Adding_a_machine_keytab_file_and_activating_password-free_kerberized_ssh_to_the_machine">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.7</span>Adding a machine keytab file and activating password-free kerberized ssh to the machine</div>
			</a>
			
			<ul id="toc-Adding_a_machine_keytab_file_and_activating_password-free_kerberized_ssh_to_the_machine-sublist" class="vector-toc-list">
				<li id="toc-Creating_a_machine_key_tab_file" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Creating_a_machine_key_tab_file">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.7.1</span><s>Creating a machine key tab file</s>
</div>
			</a>
			
			<ul id="toc-Creating_a_machine_key_tab_file-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Enabling_keytab_authentication" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Enabling_keytab_authentication">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.7.2</span><s>Enabling keytab authentication</s>
</div>
			</a>
			
			<ul id="toc-Enabling_keytab_authentication-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Preparing_sshd_on_server" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Preparing_sshd_on_server">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.7.3</span>Preparing sshd on server</div>
			</a>
			
			<ul id="toc-Preparing_sshd_on_server-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Adding_necessary_options_on_client" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Adding_necessary_options_on_client">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.7.4</span>Adding necessary options on client</div>
			</a>
			
			<ul id="toc-Adding_necessary_options_on_client-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Testing_the_setup" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Testing_the_setup">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.7.5</span>Testing the setup</div>
			</a>
			
			<ul id="toc-Testing_the_setup-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Nifty_fine-tuning_for_complete_password-free_kerberos_handling." class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Nifty_fine-tuning_for_complete_password-free_kerberos_handling.">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.7.6</span>Nifty fine-tuning for complete password-free kerberos handling.</div>
			</a>
			
			<ul id="toc-Nifty_fine-tuning_for_complete_password-free_kerberos_handling.-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Generating_user_Keytabs_which_are_accepted_by_AD" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Generating_user_Keytabs_which_are_accepted_by_AD">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.8</span>Generating user Keytabs which are accepted by AD</div>
			</a>
			
			<ul id="toc-Generating_user_Keytabs_which_are_accepted_by_AD-sublist" class="vector-toc-list">
				<li id="toc-Nice_to_know" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Nice_to_know">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.8.1</span>Nice to know</div>
			</a>
			
			<ul id="toc-Nice_to_know-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-See_also" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#See_also">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.9</span>See also</div>
			</a>
			
			<ul id="toc-See_also-sublist" class="vector-toc-list">
				<li id="toc-Using_SSSD" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Using_SSSD">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.9.1</span>Using SSSD</div>
			</a>
			
			<ul id="toc-Using_SSSD-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Commercial_solutions" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Commercial_solutions">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.9.2</span>Commercial solutions</div>
			</a>
			
			<ul id="toc-Commercial_solutions-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-OpenSource_version" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#OpenSource_version">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">8.9.3</span>OpenSource version</div>
			</a>
			
			<ul id="toc-OpenSource_version-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
	</ul>
	</li>
</ul>
</div>

					</div>
		</nav>
			</div>
		</div>
		<div class="mw-content-container">
			<main id="content" class="mw-body" role="main" style="margin: 0">
				<header class="mw-body-header vector-page-titlebar">
					<nav role="navigation" aria-label="Contents" class="vector-toc-landmark">
						
<div id="vector-page-titlebar-toc" class="vector-dropdown vector-page-titlebar-toc vector-button-flush-left">
	<input type="checkbox" id="vector-page-titlebar-toc-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-vector-page-titlebar-toc" class="vector-dropdown-checkbox " aria-label="Toggle the table of contents">
	<label id="vector-page-titlebar-toc-label" for="vector-page-titlebar-toc-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--icon-only " aria-hidden="true"><span class="vector-icon mw-ui-icon-listBullet mw-ui-icon-wikimedia-listBullet"></span>

<span class="vector-dropdown-label-text">Toggle the table of contents</span>
	</label>
	<div class="vector-dropdown-content">


							<div id="vector-page-titlebar-toc-unpinned-container" class="vector-unpinned-container">
			</div>
		
	</div>
</div>

					</nav>
					<h1 id="firstHeading" class="firstHeading mw-first-heading"><span class="mw-page-title-main">Active Directory integration</span></h1>
							
<div id="p-lang-btn" class="vector-dropdown mw-portlet mw-portlet-lang">
	<input type="checkbox" id="p-lang-btn-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-p-lang-btn" class="vector-dropdown-checkbox mw-interlanguage-selector" aria-label="Go to an article in another language. Available in 3 languages">
	<label id="p-lang-btn-label" for="p-lang-btn-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--action-progressive mw-portlet-lang-heading-3" aria-hidden="true"><span class="vector-icon mw-ui-icon-language-progressive mw-ui-icon-wikimedia-language-progressive"></span>

<span class="vector-dropdown-label-text">3 languages</span>
	</label>
	<div class="vector-dropdown-content">

		<div class="vector-menu-content">
			
			<ul class="vector-menu-content-list">
				
				<li class="interlanguage-link interwiki-es mw-list-item"><a href="../es/Active_Directory_integration.html" title="Active Directory integration – español" lang="es" hreflang="es" class="interlanguage-link-target"><span>Español</span></a></li>
<li class="interlanguage-link interwiki-ja mw-list-item"><a href="https://wiki.archlinux.jp/index.php/Active_Directory_Integration" title="Active Directory Integration – 日本語" lang="ja" hreflang="ja" class="interlanguage-link-target"><span>日本語</span></a></li>
<li class="interlanguage-link interwiki-ru mw-list-item"><a href="../ru/Active_Directory_integration.html" title="Active Directory integration – русский" lang="ru" hreflang="ru" class="interlanguage-link-target"><span>Русский</span></a></li>
			</ul>
			
		</div>

	</div>
</div>
</header>
				<div class="vector-column-end">
					<div class="vector-sticky-pinned-container">
						<nav class="vector-page-tools-landmark" aria-label="Page tools">
							<div id="vector-page-tools-pinned-container" class="vector-pinned-container">
				
							</div>
		</nav>
						<nav class="vector-client-prefs-landmark" aria-label="Appearance">
						</nav>
					</div>
				</div>
				<div id="bodyContent" class="vector-body" aria-labelledby="firstHeading" data-mw-ve-target-container>
					<div class="vector-body-before-content">
							<div class="mw-indicators">
		</div>

						<div id="siteSub" class="noprint">From ArchWiki</div>
					</div>
					<div id="contentSub"><div id="mw-content-subtitle"></div></div>
					
					
					<div id="mw-content-text" class="mw-body-content">
<div class="mw-content-ltr mw-parser-output" lang="en" dir="ltr">
<div class="archwiki-template-meta-related-articles">
<p>Related articles</p>
<ul>
<li><a href="../en/Samba.html" title="Samba">Samba</a></li>
<li><a href="../en/Samba/Active_Directory_domain_controller.html" title="Samba/Active Directory domain controller">Samba/Active Directory domain controller</a></li>
<li><a href="../en/SOGo.html" title="SOGo">SOGo</a></li>
</ul>
</div>
<div class="noprint archwiki-template-message">
<p><span class="mw-default-size" typeof="mw:File"><span><img src="../File:Tango-view-fullscreen.svg" decoding="async" width="48" height="48" class="mw-file-element"></span></span><b>This article or section needs expansion.</b></p>
<div>
<b>Reason:</b> This page is currently being updated. The original page has been left intact until the rewrite is complete, see the section labeled <b>Old Wiki Article</b> for the original contents. Sections using the <s>strikethrough</s> in the title, have already been covered in the new sections. (Discuss in <a rel="nofollow" class="external text" href="../en/Talk:Active_Directory_integration.html">Talk:Active Directory integration</a>)</div>
</div>
<p>From <a href="https://en.wikipedia.org/wiki/Active_Directory" class="extiw" title="w:Active Directory">Wikipedia</a>:
</p>
<dl><dd>Active Directory (AD) is a <a href="https://en.wikipedia.org/wiki/directory_service" class="extiw" title="wikipedia:directory service">directory service</a> that Microsoft developed for <a href="https://en.wikipedia.org/wiki/Windows_domain" class="extiw" title="wikipedia:Windows domain">Windows domain</a> networks.</dd></dl>
<p>This article describes how to integrate an Arch Linux system with an existing Windows domain network using <a href="../en/Samba.html" title="Samba">Samba</a>.
</p>
<p>Before continuing, you must have an existing Active Directory domain, and have a user with the appropriate rights within the domain to: query users and add computer accounts (Domain Join). 
</p>
<p>This document is not an intended as a complete guide to Active Directory nor Samba. Refer to the resources section for additional information.
</p>
<meta property="mw:PageProp/toc">
<h2><span class="mw-headline" id="Introduction">Introduction</span></h2>
<p>This article explains how to configure an Arch Linux system to participate in an Active Directory domain. This article was written and tested on a fresh installation, and it is assumed that all configuration files are in their unmodified, post-installation state. For the duration of the article, the example Active Directory domain will use the following configuration:
</p>
<ul>
<li>NetBIOS domain name: <b>INTERNAL</b>
</li>
<li>DNS domain name: <b>internal.domain.tld</b>
</li>
<li>Kerberos realm: <b>INTERNAL.DOMAIN.TLD</b>
</li>
<li>First DC: <b>server1.internal.domain.tld</b> with IP address <b>192.168.1.1</b>
</li>
<li>Second DC: <b>server2.internal.domain.tld</b> with IP address <b>192.168.1.2</b>
</li>
</ul>
<p>In most small networks, the DCs (domain controllers) also hold the DNS server role. This may not be true in larger networks. Generally, DCs also hold the NTP role, but not always. Consult your network administrator to verify correct values for DNS and NTP servers.
</p>
<h2><span class="mw-headline" id="Needed_software">Needed software</span></h2>
<p>In order to use samba effectively, you will need to install the following packages: <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=samba">samba</a></span>, <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=smbclient">smbclient</a></span>, and <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=ntp">ntp</a></span>. (<a href="../en/System_time.html" class="mw-redirect" title="Timedatectl">timedatectl</a> can be used as an alternative to <i>ntp</i>.)
</p>
<p>Additionally, while not required, the following packages will be useful for testing and troubleshooting: <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=bind">bind</a></span>, <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=krb5">krb5</a></span>, and if a printing is desired (whether you want to share printers, or use printers on another Samba/Windows host), <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=cups">cups</a></span>.
</p>
<h2><span class="mw-headline" id="Initial_configuration_of_services">Initial configuration of services</span></h2>
<h3><span class="mw-headline" id="DNS_configuration">DNS configuration</span></h3>
<p>Active Directory depends entirely on DNS for name resolution. It is imperative that the <code>/etc/resolv.conf</code> file is configured with both the correct DNS servers and a domain search suffix. Whether configured via DHCP or static configuration, ensure that these values are correct for your domain. For the example domain configuration, the following contents are appropriate (be sure to replace <b>192.168.1.1</b>, <b>192.168.1.2</b>, and <b>internal.domain.tld</b> with appropriate values for your network):
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/resolv.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">nameserver <b>192.168.1.1</b>
nameserver <b>192.168.1.2</b>
search <b>internal.domain.tld</b></pre>
<p>If you elected to install the <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=bind">bind</a></span> package, you can test DNS configuration with the following commands (be sure to replace <b>server1</b> and <b>internal.domain.tld</b> with appropriate values for your network):
</p>
<pre>$ nslookup -type=SRV _kerberos._tcp.<b>internal.domain.tld</b>.
$ nslookup -type=SRV _ldap._tcp.<b>internal.domain.tld</b>.
$ nslookup <b>server1</b>.<b>internal.domain.tld</b>.
</pre>
<p>You should get output similar to the following (adjust appropriately for only one DC, or more than two):
</p>
<pre>Server:        192.168.1.1
Address:       192.168.1.1#53

_kerberos._tcp.internal.domain.tld service = 0 100 88 server1.internal.domain.tld.
_kerberos._tcp.internal.domain.tld service = 0 100 88 server2.internal.domain.tld.
...
_ldap._tcp.internal.domain.tld     service = 0 100 389 server1.internal.domain.tld.
_ldap._tcp.internal.domain.tld     service = 0 100 389 server2.internal.domain.tld.
...
Name:   server1.internal.domain.tld
Address: 192.168.1.1
</pre>
<h3><span class="mw-headline" id="NTP_configuration">NTP configuration</span></h3>
<p>In an Active Directory domain, more specifically for Kerberos ticketing, it is imperative that time is synchronized with all other hosts on the network. A margin of error no more than five minutes is required. For the example domain configuration, an appropriate <code>/etc/ntp.conf</code> file should have the following contents (be sure to replace <b>server1</b>, <b>server2</b>, and <b>internal.domain.tld</b> with appropriate values for your network):
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/ntp.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;"># Use your domain's NTP servers 
server <b>server1</b>.<b>internal.domain.tld</b>
server <b>server2</b>.<b>internal.domain.tld</b>

# Restrictions
restrict default kod limited nomodify nopeer noquery notrap
restrict 127.0.0.1
restrict ::1

# Location of drift file
driftfile /var/lib/ntp/ntpd.drift</pre>
<p>Enable and start the <code>ntpd.service</code> unit.
</p>
<h3><span class="mw-headline" id="Kerberos_configuration">Kerberos configuration</span></h3>
<p>The Samba documentation recommends a minimal Kerberos configuration, with just enough information in the <b>[libdefaults]</b> section to hand off the work of discovering domain details to DNS. Unfortunately, this does not work well in practice. Continuing with the example domain configuration, modify the <code>/etc/krb5.conf</code> file with the following contents (be sure to replace instances of <b>INTERNAL</b>, <b>internal.domain.tld</b>, <b>SERVER1</b>, and <b>INTERNAL.DOMAIN.TLD</b> with appropriate values for your network):
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/krb5.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[libdefaults]
   default_realm = <b>INTERNAL.DOMAIN.TLD</b>
   dns_lookup_realm = false
   dns_lookup_kdc = true

[realms]
   <b>INTERNAL.DOMAIN.TLD</b> = {
      kdc = <b>SERVER1</b>.<b>INTERNAL.DOMAIN.TLD</b>
      default_domain = <b>INTERNAL.DOMAIN.TLD</b>
      admin_server = <b>SERVER1</b>.<b>INTERNAL.DOMAIN.TLD</b>
   }
   <b>INTERNAL</b> = {
      kdc = <b>SERVER1</b>.<b>INTERNAL.DOMAIN.TLD</b>
      default_domain = <b>INTERNAL.DOMAIN.TLD</b>
      admin_server = <b>SERVER1</b>.<b>INTERNAL.DOMAIN.TLD</b>
   }

[domain_realm]
    .<b>internal.domain.tld</b> = <b>INTERNAL.DOMAIN.TLD</b>

[appdefaults]
    pam = {
        ticket_lifetime = 1d
        renew_lifetime = 1d
        forwardable = true
        proxiable = false
        minimum_uid = 1
    }

</pre>
<h3><span class="mw-headline" id="Samba_configuration">Samba configuration</span></h3>
<h4><span class="mw-headline" id="Base_Samba_configuration_file">Base Samba configuration file</span></h4>
<p>A default installation of <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=samba">samba</a></span> does not ship with an example <code>/etc/samba/smb.conf</code> file. For our example domain configuration, use the following base settings (replace instances of <b>INTERNAL</b> and <b>INTERNAL.DOMAIN.TLD</b> with appropriate values for your network):
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/samba/smb.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[global]
   workgroup = <b>INTERNAL</b>
   security = ADS
   realm = <b>INTERNAL.DOMAIN.TLD</b>

   winbind refresh tickets = Yes
   vfs objects = acl_xattr
   map acl inherit = Yes
   store dos attributes = Yes

   # Allow a single, unified keytab to store obtained Kerberos tickets
   dedicated keytab file = /etc/krb5.keytab
   kerberos method = secrets and keytab

   # Do not require that login usernames include the default domain
   winbind use default domain = yes</pre>
<p>If you do not wish to share local printers configured in <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=cups">cups</a></span>, then add the following to the [Global] section of the <code>/etc/samba/smb.conf</code> file:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/samba/smb.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Global]
...
   load printers = no
   printing = bsd
   printcap name = /dev/null
   disable spoolss = yes
...</pre>
<p>The remainder of the configuration depends on whether your domain supports RFC2307 Unix/NFS Attributes. Consult with your domain administrator if unsure.
</p>
<h5><span class="mw-headline" id="Adding_the_idmap_configuration_for_domains_with_RFC2307_extensions">Adding the idmap configuration for domains with RFC2307 extensions</span></h5>
<p>Be certain that the values below do not overlap with system values, and that all users have at least the <i>uidNubmer</i> attribute, and that those users' <i>PrimaryGroup</i> has a <i>gid</i> attribute. Append to the following to the [Global] section of the <code>/etc/samba/smb.conf</code> file (replace <b>INTERNAL</b> with the NetBIOS domain name):
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/samba/smb.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Global]
...

   # UID/GID mapping for local users
   idmap config * : backend = tdb
   idmap config * : range = 3000-7999

   # UID/GID mapping for domain users
   idmap config <b>INTERNAL</b> : backend = ad
   idmap config <b>INTERNAL</b> : schema_mode = rfc2307
   idmap config <b>INTERNAL</b> : range = 10000-999999
   idmap config <b>INTERNAL</b> : unix_nss_info = yes

   # Template settings for users without ''unixHomeDir'' and ''loginShell'' attributes 
   template shell = /bin/bash
   template homedir = /home/%U

   # Allow offline/cached credentials and ticket refresh
   winbind offline logon = yes
   winbind refresh tickets = yes
...</pre>
<p>Additionally, if user accounts in AD have a <i>gidNumber</i> attribute, you can use it instead of the RID for the user's <i>Primary Group</i> by appending the following setting (again in the [Global] section):
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/samba/smb.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Global]
...
   idmap config <b>INTERNAL</b>:unix_primary_group = yes
...</pre>
<h5><span class="mw-headline" id="Adding_the_idmap_configuration_for_domains_without_RFC2307_extensions">Adding the idmap configuration for domains without RFC2307 extensions</span></h5>
<p>If your administrator has not extended the AD schema to include the RFC2307 attributes, use the following idmap configuration in the [Global] section of the <code>/etc/samba/smb.conf</code> file (replace <b>INTERNAL</b> with the NetBIOS domain name):
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/samba/smb.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Global]
...
   # UID/GID mapping for local users
   idmap config * : backend = tdb
   idmap config * : range = 3000-7999

   # UID/GID mapping for domain users
   idmap config <b>INTERNAL</b> : backend = rid
   idmap config <b>INTERNAL</b> : range = 10000-999999

   # Template settings for users
   template shell = /bin/bash
   template homedir = /home/%U

   # Allow offline/cached credentials and ticket refresh
   winbind offline logon = yes
   winbind refresh tickets = yes
...</pre>
<h2><span class="mw-headline" id="Joining_the_domain">Joining the domain</span></h2>
<p>To join the AD domain, simply issue the following command (be sure to replace <b>Administrator</b> with a user that has privileges to join the AD domain).
</p>
<pre># net ads join -U Administrator
</pre>
<h2><span class="mw-headline" id="Start_the_individual_Samba_services">Start the individual Samba services</span></h2>
<p>Enable and start the <code>smb.service</code>, <code>nmb.service</code>, and <code>winbind.service</code> services.
</p>
<h2><span class="mw-headline" id="Configure_NSS">Configure NSS</span></h2>
<p>Modify the <code>/etc/nsswitch.conf</code> file to allow Samba to map names to uid and gid:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/nsswitch.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">...
passwd: files winbind mymachines systemd
group: files winbind mymachines systemd
...</pre>
<h3><span class="mw-headline" id="Testing_NSS">Testing NSS</span></h3>
<p>Verify connectivity by listing the AD domain users and groups that system is aware of:
</p>
<pre># wbinfo -u
# wbinfo -g
</pre>
<p>You should get a list of AD users followed by AD groups.
</p>
<h2><span class="mw-headline" id="Configuring_PAM_authentication">Configuring PAM authentication</span></h2>
<p>Rather than configuring options directly in the <i>Linux-PAM</i> configuration files, set defaults for the <i>pam_winbind</i> module in <code>/etc/security/pam_winbind.conf</code>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/security/pam_winbind.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Global]
   debug = no
   debug_state = no
   try_first_pass = yes
   krb5_auth = yes
   krb5_ccache_type = FILE:/run/user/%u/krb5cc
   cached_login = yes
   silent = no
   mkhomedir = yes</pre>
<p>For most services, it will be sufficient to modify only the <code>/etc/pam.d/system-auth</code> file. Any configuration for programs that do not include this file will also need to be modified directly. Create a backup of the <code>/etc/pam.d/system-auth</code> file and use the following configuration:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/pam.d/system-auth</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">#%PAM-1.0

auth       required                    pam_faillock.so      preauth
# Optionally use requisite above if you do not want to prompt for the password
# on locked accounts.
-auth      [success=3 default=ignore]  pam_systemd_home.so
auth       [success=2 default=ignore]  pam_winbind.so
auth       [success=1 default=bad]     pam_unix.so          try_first_pass nullok
auth       [default=die]               pam_faillock.so      authfail
auth       optional                    pam_permit.so
auth       required                    pam_env.so
auth       required                    pam_faillock.so      authsucc
# If you drop the above call to pam_faillock.so the lock will be done also
# on non-consecutive authentication failures.

-account   [success=2 default=ignore]  pam_systemd_home.so
account    [success=1 default=ignore]  pam_winbind.so
account    required                    pam_unix.so
account    optional                    pam_permit.so
account    required                    pam_time.so

-password  [success=2 default=ignore]  pam_systemd_home.so
password   [success=1 default=ignore]  pam_winbind.so
password   required                    pam_unix.so          try_first_pass nullok shadow sha512
password   optional                    pam_permit.so

-session   optional                    pam_systemd_home.so
session    required                    pam_mkhomedir.so skel=/etc/skel/ umask=0022
session    required                    pam_limits.so
session    required                    pam_winbind.so
session    required                    pam_unix.so
session    optional                    pam_permit.so</pre>
<p>If you have other services that do not include the <code>/etc/pam.d/system-auth</code> file, modify the configuration to mirror all <i>pam_unix.so</i> entries for <i>pam_winbind.so</i> and  change all <i>required</i> to <i>sufficient</i>. A good example is the su configuration. Create a backup of the <code>/etc/pam.d/su</code> file and use the following in its place:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/pam.d/su</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">#%PAM-1.0

auth      sufficient  pam_rootok.so
# Uncomment the following line to implicitly trust users in the "wheel" group.
#auth     required    pam_wheeel.so   trust use_uid
# Uncomment the following line to require a user to be in the "wheel" group.
#auth     required    pam_wheel.so    use_uid
auth      sufficient  pam_winbind.so
auth      required    pam_unix.so
account   sufficient  pam_winbind.so
account   required    pam_unix.so
session   sufficient  pam_winbind.so
session   required    pam_unix.so</pre>
<p>The above pam_winbind configuration will not use the default location of the Kerberos ticket (<code>KRB5CCNAME</code>), which is at <code>/tmp/krb5cc_<i>UID</i></code>. Instead, it stores the automatically refreshed Kerberos ticket to <code>/run/user/<i>UID</i>/krb5cc</code>. Append the following to your krb5.conf to let Kerberos know your new location:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/krb5.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[libdefaults]
   ...
   default_ccache_name = /run/user/%{uid}/krb5cc
   ...</pre>
<p>To test your changes, start a <b>new</b> console or ssh session (do not exit your existing session until you have tested thoroughly) and try to login using the AD credentials. The domain name is optional, as this was set in the Winbind configuration as 'default realm'.  Please note that in the case of ssh, you will need to modify the <code>/etc/ssh/sshd_config</code> file to allow kerberos authentication (see below). 
</p>
<p>Run <b>klist</b> to verify that you have received a kerberos ticket. You should see something similar to:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">$ klist</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">Ticket cache: FILE:/run/user/20000/krb5cc
Default principal: administrator@INTERNAL.DOMAIN.TLD

Valid starting       Expires              Service principal
12/25/2020 03:35:21  12/25/2020 13:35:21  krbtgt/INTERNAL.DOMAIN.TLD@INTERNAL.DOMAIN.TLD
        renew until 12/26/2020 03:35:15
</pre>
<p>Finally, you should test login as both the root user and a local unprivileged user before logging out of your existing (working) session.
</p>
<h2><span class="mw-headline" id="Old_Wiki_Article">Old Wiki Article</span></h2>
<p>Active Directory serves as a central location for network administration and security. It is responsible for authenticating and authorizing all users and computers within a Windows domain network, assigning and enforcing security policies for all computers in a network and installing or updating software on network computers. For example, when a user logs into a computer that is part of a Windows domain, it is Active Directory that verifies their password and specifies whether they are a system administrator or normal user. Server computers on which Active Directory is running are called domain controllers.
</p>
<p>Active Directory uses <a href="https://en.wikipedia.org/wiki/Ldap" class="extiw" title="wikipedia:Ldap">Lightweight Directory Access Protocol (LDAP)</a> versions 2 and 3, Microsoft's version of <a href="../en/Kerberos.html" title="Kerberos">Kerberos</a> and DNS.
</p>
<h3><span class="mw-headline" id="Terminology">Terminology</span></h3>
<p>If you are not familiar with Active Directory, there are a few keywords that are helpful to know.
</p>
<ul>
<li>
<b>Domain</b> : The name used to group computers and accounts.</li>
<li>
<b>SID</b> : Each computer that joins the domain as a member must have a unique SID or System Identifier.</li>
<li>
<b>SMB</b> : Server Message Block.</li>
<li>
<b>NETBIOS</b>: Network naming protocol used as an alternative to DNS. Mostly legacy, but still used in Windows Networking.</li>
<li>
<b>WINS</b>: Windows Information Naming Service. Used for resolving Netbios names to windows hosts.</li>
<li>
<b>Winbind</b>: Protocol for windows authentication.</li>
</ul>
<h3><span class="mw-headline" id="Active_Directory_configuration">Active Directory configuration</span></h3>
<p>This section works with the default configuration of Windows Server 2012 R2.
</p>
<h4><span class="mw-headline" id="GPO_considerations"><s>GPO considerations</s></span></h4>
<p>Digital signing is enabled by default in Windows Server, and must be enabled at both the client and server level. For certain versions of Samba, Linux clients may experience issues connecting to the domain and/or shares. It is recommended you add the following parameters to your <code>smb.conf</code> file: 
</p>
<pre>client signing = auto 
server signing = auto
</pre>
<p>If that is not successful, you can disable <i>Digital Sign Communication (Always)</i> in the AD group policies. In your AD Group Policy editor, locate:
</p>
<p>Under <i>Local policies &gt; Security policies &gt; Microsoft Network Server &gt; Digital sign communication (Always)</i> activate <i>define this policy</i> and use the <i>disable</i> radio button.
</p>
<p>If you use Windows Server 2008 R2, you need to modify that in <i>GPO for Default Domain Controller Policy &gt; Computer Setting &gt; Policies &gt; Windows Setting &gt; Security Setting &gt; Local Policies &gt; Security Option &gt; Microsoft network client: Digitally sign communications (always)</i>.
</p>
<p>Please note that disabling this GPO affects the security of all members of the domain.
</p>
<h3><span class="mw-headline" id="Linux_host_configuration"><s>Linux host configuration</s></span></h3>
<p>The next few steps will begin the process of configuring the Host. You will need root or sudo access to complete these steps.
</p>
<h4><span class="mw-headline" id="Installation"><s>Installation</s></span></h4>
<p><a href="../en/Help:Reading.html#Installation_of_packages" class="mw-redirect" title="Install">Install</a> the following packages:
</p>
<ul>
<li>
<span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=samba">samba</a></span>, see also <a href="../en/Samba.html" title="Samba">Samba</a>
</li>
<li><span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=pam-krb5">pam-krb5</a></span></li>
<li>
<span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=ntp">ntp</a></span> or <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=openntpd">openntpd</a></span>, see also <a href="../en/Network_Time_Protocol_daemon.html" class="mw-redirect" title="NTPd">NTPd</a> or <a href="../en/OpenNTPD.html" title="OpenNTPD">OpenNTPD</a>
</li>
</ul>
<h4><span class="mw-headline" id="Updating_DNS"><s>Updating DNS</s></span></h4>
<p>Active Directory is heavily dependent upon DNS. You will need to update <code>/etc/resolv.conf</code> to use one or more of the Active Directory domain controllers:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/resolv.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">nameserver &lt;IP1&gt;
nameserver &lt;IP2&gt;
</pre>
<p>Replacing &lt;IP1&gt; and &lt;IP2&gt; with valid IP addresses for the AD servers. If your AD domains do not permit DNS forwarding or recursion, you may need to add additional resolvers. 
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> If your machine dual boots Windows and Linux, you should use a different DNS hostname and netbios name for the linux configuration if both operating systems will be members of the same domain.</div>
<h4><span class="mw-headline" id="Configuring_NTP"><s>Configuring NTP</s></span></h4>
<p>Read <a href="../en/System_time.html#Time_synchronization" title="System time">System time#Time synchronization</a> to configure an NTP service.
</p>
<p>On the NTP servers configuration, use the IP addresses for the AD servers, as they typically run NTP as a service. Alternatively, you can use other known NTP servers provided the Active directory servers sync to the same stratum.
</p>
<p>Ensure that the service is configured to sync the time automatically very early on startup.
</p>
<h4><span class="mw-headline" id="Kerberos"><s>Kerberos</s></span></h4>
<p>Let us assume that your AD is named example.com. Let us further assume your AD is ruled by two domain controllers, the primary and secondary one, which are named PDC and BDC, pdc.example.com and bdc.example.com respectively. Their IP adresses will be 192.168.1.2 and 192.168.1.3 in this example.  Take care to watch your syntax; upper-case is very important here.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/krb5.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[libdefaults]
        default_realm 	= 	EXAMPLE.COM
	clockskew 	= 	300
	ticket_lifetime	=	1d
        forwardable     =       true
        proxiable       =       true
        dns_lookup_realm =      true
        dns_lookup_kdc  =       true
	
[realms]
	EXAMPLE.COM = {
		kdc 	= 	PDC.EXAMPLE.COM
                admin_server = PDC.EXAMPLE.COM
		default_domain = EXAMPLE.COM
	}
	
[domain_realm]
        .kerberos.server = EXAMPLE.COM
	.example.com = EXAMPLE.COM
	example.com = EXAMPLE.COM
	example	= EXAMPLE.COM

[appdefaults]
	pam = {
	ticket_lifetime 	= 1d
	renew_lifetime 		= 1d
	forwardable 		= true
	proxiable 		= false
	retain_after_close 	= false
	minimum_uid 		= 0
	debug 			= false
	}

[logging]
	default 		= FILE:/var/log/krb5libs.log
	kdc 			= FILE:/var/log/kdc.log
        admin_server            = FILE:/var/log/kadmind.log
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> Heimdal 1.3.1 deprecated DES encryption which is required for AD authentication before Windows Server 2008. You will probably have to add <pre>allow_weak_crypto = true</pre> to the <code>[libdefaults]</code> section.</div>
<h5><span class="mw-headline" id="Creating_a_Kerberos_ticket"><s>Creating a Kerberos ticket</s></span></h5>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> The keys and commands are user specific: sudo will be root, so your non-elevated account can connect to a different AD user with a separate key.  If you only have one domain, it is not necessary to type @EXAMPLE.COM</div>
<p>Now you can query the AD domain controllers and request a kerberos ticket (<b>uppercase is necessary</b>):
</p>
<pre>kinit administrator@EXAMPLE.COM</pre>
<p>You can use any username that has rights as a Domain Administrator.
</p>
<h5><span class="mw-headline" id="Validating_the_Ticket"><s>Validating the Ticket</s></span></h5>
<p>Run <b>klist</b> to verify you did receive the token. You should see something similar to:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># klist</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;"> Ticket cache: FILE:/tmp/krb5cc_0
 Default principal: administrator@EXAMPLE.COM
 
 Valid starting    Expires           Service principal 
 02/04/12 21:27:47 02/05/12 07:27:42 krbtgt/EXAMPLE.COM@EXAMPLE.COM
         renew until 02/05/12 21:27:47
</pre>
<h4><span class="mw-headline" id="pam_winbind.conf"><s>pam_winbind.conf</s></span></h4>
<p>If you get errors stating that /etc/security/pam_winbind.conf was not found, create the file and add the following:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/security/pam_winbind.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[global]
  debug = no
  debug_state = no
  try_first_pass = yes
  krb5_auth = yes
  krb5_ccache_type = FILE
  cached_login = yes
  silent = no
  mkhomedir = yes
</pre>
<p>With this setup, winbind will create user keytabs on the fly (krb5_ccache_type = FILE) at login and maintain them.  You can verify this by simply running klist in a shell after logging in as an AD user but without needing to run kinit.  You may need to set additional permissions on /etc/krb5.keytab eg 640 instead of 600 to get this to work (see <a rel="nofollow" class="external text" href="https://bugs.archlinux.org/task/52621">FS#52621</a> for example)
</p>
<h4><span class="mw-headline" id="Samba"><s>Samba</s></span></h4>
<p>Samba is a free software re-implementation of the SMB/CIFS networking protocol. It also includes tools for Linux machines to act as Windows networking servers and clients.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> The configuration can vary greatly depending on how the Windows environment is deployed. Be prepared to troubleshoot and research</div>
<p>In this section, we will focus on getting Authentication to work first by editing the 'Global' section first. Later, we will go back and add shares.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/samba/smb.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Global]
  netbios name = MYARCHLINUX
  workgroup = EXAMPLE
  realm = EXAMPLE.COM
  server string = %h Arch Linux Host
  security = ads
  encrypt passwords = yes
  password server = pdc.example.com
  client signing = auto
  server signing = auto

  idmap config * : backend = tdb
  idmap config * : range = 10000-20000

  winbind use default domain = Yes
  winbind enum users = Yes
  winbind enum groups = Yes
  winbind nested groups = Yes
  winbind separator = +
  winbind refresh tickets = yes
  winbind offline logon = yes
  winbind cache time = 300

  template shell = /bin/bash
  template homedir = /home/%D/%U
   
  preferred master = no
  dns proxy = no
  wins server = pdc.example.com
  wins proxy = no

  inherit acls = Yes
  map acl inherit = Yes
  acl group control = yes

  load printers = no
  debug level = 3
  use sendfile = no
</pre>
<h4><span class="mw-headline" id="Join_the_domain"><s>Join the domain</s></span></h4>
<p>You need an AD Administrator account to do this. Let us assume this is named Administrator. The command is 'net ads join'
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># net ads join -U Administrator</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">Administrator's password: xxx
Using short domain name -- EXAMPLE
Joined 'MYARCHLINUX' to realm 'EXAMPLE.COM'
</pre>
<h3><span class="mw-headline" id="Starting_and_testing_services"><s>Starting and testing services</s></span></h3>
<h4><span class="mw-headline" id="Starting_Samba"><s>Starting Samba</s></span></h4>
<p>Hopefully, you have not rebooted yet! Fine. If you are in an X-session, quit it, so you can test login into another console, while you are still logged in.
</p>
<p>Enable and start the individual Samba daemons <code>smbd.service</code>, <code>nmbd.service</code>, and <code>winbindd.service</code>.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> In <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=samba">samba</a></span> 4.8.0-1, the Samba daemon units have been renamed from <code>smbd.service</code>, <code>nmbd.service</code>, and <code>winbindd.service</code> to <code>smb.service</code>, <code>nmb.service</code>, and <code>winbind.service</code>.</div>
<p>Next we will need to modify the NSSwitch configuration, which tells the Linux host how to retrieve information from various sources and in which order to do so. In this case, we are appending Active Directory as additional sources for Users, Groups, and Hosts.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/nsswitch.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;"> passwd:            files winbind
 shadow:            files winbind
 group:             files winbind 
 
 hosts:             files dns wins
</pre>
<h4><span class="mw-headline" id="Testing_Winbind"><s>Testing Winbind</s></span></h4>
<p>Let us check if winbind is able to query the AD. The following command should return a list of AD users:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># wbinfo -u</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">administrator
guest
krbtgt
test.user
</pre>
<ul><li>Note we created an Active Directory user called 'test.user' on the domain controller</li></ul>
<p>We can do the same for AD groups:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># wbinfo -g</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">domain computers
domain controllers
schema admins
enterprise admins
cert publishers
domain admins
domain users
domain guests
group policy creator owners
ras and ias servers
allowed rodc password replication group
denied rodc password replication group
read-only domain controllers
enterprise read-only domain controllers
dnsadmins
dnsupdateproxy
</pre>
<h4><span class="mw-headline" id="Testing_nsswitch"><s>Testing nsswitch</s></span></h4>
<p>To ensure that our host is able to query the domain for users and groups, we test nsswitch settings by issuing the 'getent' command.
</p>
<p>The following output shows what a stock Arch Linux install looks like:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># getent passwd</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">root:x:0:0:root:/root:/bin/bash
bin:x:1:1:bin:/bin:/bin/false
daemon:x:2:2:daemon:/sbin:/bin/false
mail:x:8:12:mail:/var/spool/mail:/bin/false
ftp:x:14:11:ftp:/srv/ftp:/bin/false
http:x:33:33:http:/srv/http:/bin/false
nobody:x:99:99:nobody:/:/bin/false
dbus:x:81:81:System message bus:/:/bin/false
ntp:x:87:87:Network Time Protocol:/var/empty:/bin/false
avahi:x:84:84:avahi:/:/bin/false
administrator:*:10001:10006:Administrator:/home/EXAMPLE/administrator:/bin/bash
guest:*:10002:10007:Guest:/home/EXAMPLE/guest:/bin/bash
krbtgt:*:10003:10006:krbtgt:/home/EXAMPLE/krbtgt:/bin/bash
test.user:*:10000:10006:Test User:/home/EXAMPLE/test.user:/bin/bash
</pre>
<p>And for groups:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># getent group</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">root:x:0:root
bin:x:1:root,bin,daemon
daemon:x:2:root,bin,daemon
sys:x:3:root,bin
adm:x:4:root,daemon
tty:x:5:
disk:x:6:root
lp:x:7:daemon
mem:x:8:
kmem:x:9:
wheel:x:10:root
ftp:x:11:
mail:x:12:
uucp:x:14:
log:x:19:root
utmp:x:20:
locate:x:21:
rfkill:x:24:
smmsp:x:25:
http:x:33:
games:x:50:
network:x:90:
video:x:91:
audio:x:92:
optical:x:93:
floppy:x:94:
storage:x:95:
scanner:x:96:
power:x:98:
nobody:x:99:
users:x:100:
dbus:x:81:
ntp:x:87:
avahi:x:84:
domain computers:x:10008:
domain controllers:x:10009:
schema admins:x:10010:administrator
enterprise admins:x:10011:administrator
cert publishers:x:10012:
domain admins:x:10013:test.user,administrator
domain users:x:10006:
domain guests:x:10007:
group policy creator owners:x:10014:administrator
ras and ias servers:x:10015:
allowed rodc password replication group:x:10016:
denied rodc password replication group:x:10017:krbtgt
read-only domain controllers:x:10018:
enterprise read-only domain controllers:x:10019:
dnsadmins:x:10020:
dnsupdateproxy:x:10021:
</pre>
<h4><span class="mw-headline" id="Testing_Samba_commands">Testing Samba commands</span></h4>
<p>Try out some net commands to see if Samba can communicate with  AD:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># net ads info</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[2012/02/05 20:21:36.473559,  0] param/loadparm.c:7599(lp_do_parameter)
  Ignoring unknown parameter "idmapd backend"
LDAP server: 192.168.1.2
LDAP server name: PDC.example.com
Realm: EXAMPLE.COM
Bind Path: dc=EXAMPLE,dc=COM
LDAP port: 389
Server time: Sun, 05 Feb 2012 20:21:33 CST
KDC server: 192.168.1.2
Server time offset: -3
</pre>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># net ads lookup</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[2012/02/05 20:22:39.298823,  0] param/loadparm.c:7599(lp_do_parameter)
  Ignoring unknown parameter "idmapd backend"
Information for Domain Controller: 192.168.1.2

Response Type: LOGON_SAM_LOGON_RESPONSE_EX
GUID: 2a098512-4c9f-4fe4-ac22-8f9231fabbad
Flags:
        Is a PDC:                                   yes
        Is a GC of the forest:                      yes
        Is an LDAP server:                          yes
        Supports DS:                                yes
        Is running a KDC:                           yes
        Is running time services:                   yes
        Is the closest DC:                          yes
        Is writable:                                yes
        Has a hardware clock:                       yes
        Is a non-domain NC serviced by LDAP server: no
        Is NT6 DC that has some secrets:            no
        Is NT6 DC that has all secrets:             yes
Forest:                 example.com
Domain:                 example.com
Domain Controller:      PDC.example.com
Pre-Win2k Domain:       EXAMPLE
Pre-Win2k Hostname:     PDC
Server Site Name :              Office
Client Site Name :              Office
NT Version: 5
LMNT Token: ffff
LM20 Token: ffff
</pre>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># net ads status -U administrator%password | less</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">objectClass: top
objectClass: person
objectClass: organizationalPerson
objectClass: user
objectClass: computer
cn: myarchlinux
distinguishedName: CN=myarchlinux,CN=Computers,DC=leafscale,DC=inc
instanceType: 4
whenCreated: 20120206043413.0Z
whenChanged: 20120206043414.0Z
uSNCreated: 16556
uSNChanged: 16563
name: myarchlinux
objectGUID: 2c24029c-8422-42b2-83b3-a255b9cb41b3
userAccountControl: 69632
badPwdCount: 0
codePage: 0
countryCode: 0
badPasswordTime: 0
lastLogoff: 0
lastLogon: 129729780312632000
localPolicyFlags: 0
pwdLastSet: 129729764538848000
primaryGroupID: 515
objectSid: S-1-5-21-719106045-3766251393-3909931865-1105
...&lt;snip&gt;...
</pre>
<h3><span class="mw-headline" id="Configuring_PAM"><s>Configuring PAM</s></span></h3>
<p>Now we will change various rules in PAM to allow Active Directory users to use the system for things like login and sudo access.  When changing the rules, note the order of these items and whether they are marked as <b>required</b> or <b>sufficient</b> is critical to things working as expected. You should not deviate from these rules unless you know how to write PAM rules.
</p>
<p>In case of logins, PAM should first ask for AD accounts, and for local accounts if no matching AD account was found. Therefore, we add entries to include <code>pam_winbind.so</code> into the authentication process.
</p>
<p>The Arch Linux PAM configuration keeps the central auth process in <code>/etc/pam.d/system-auth</code>. Starting with the stock configuration from <code>pambase</code>, change it like this:
</p>
<h4><span class="mw-headline" id="system-auth"><s>system-auth</s></span></h4>
<h5>
<span id=".22auth.22_section"></span><span class="mw-headline" id='"auth"_section'><s>"auth" section</s></span>
</h5>
<p>Find the line:
</p>
<pre>auth required pam_unix.so ...
</pre>
<p>Delete it, and replace with:
</p>
<pre>auth [success=1 default=ignore] pam_localuser.so
auth [success=2 default=die] pam_winbind.so
auth [success=1 default=die] pam_unix.so nullok
auth requisite pam_deny.so
</pre>
<h5>
<span id=".22account.22_section"></span><span class="mw-headline" id='"account"_section'><s>"account" section</s></span>
</h5>
<p>Find the line:
</p>
<pre>account required pam_unix.so
</pre>
<p>Keep it, and add this below:
</p>
<pre>account [success=1 default=ignore] pam_localuser.so
account required pam_winbind.so
</pre>
<h5>
<span id=".22password.22_section"></span><span class="mw-headline" id='"password"_section'><s>"password" section</s></span>
</h5>
<p>Find the line:
</p>
<pre>password required pam_unix.so ...
</pre>
<p>Delete it, and replace with:
</p>
<pre>password [success=1 default=ignore] pam_localuser.so
password [success=2 default=die] pam_winbind.so
password [success=1 default=die] pam_unix.so sha512 shadow
password requisite pam_deny.so
</pre>
<h5>
<span id=".22session.22_section"></span><span class="mw-headline" id='"session"_section'><s>"session" section</s></span>
</h5>
<p>Find the line:
</p>
<pre>session required pam_unix.so
</pre>
<p>Keep it, and add this line immediately above it:
</p>
<pre>session required pam_mkhomedir.so skel=/etc/skel/ umask=0022
</pre>
<p>Below the pam_unix line, add these:
</p>
<pre>session [success=1 default=ignore] pam_localuser.so
session required pam_winbind.so
</pre>
<h4><span class="mw-headline" id="passwd"><s>passwd</s></span></h4>
<h5>
<span id=".22password.22_section_2"></span><span class="mw-headline" id='"password"_section_2'><s>"password" section</s></span>
</h5>
<p>In order for logged-in Active Directory users to be able to change their passwords with the  'passwd' command, the file <code>/etc/pam.d/passwd</code> must include the information from system-auth.
</p>
<p>Find the line:
</p>
<pre>password required pam_unix.so sha512 shadow nullok
</pre>
<p>Delete it, and replace with:
</p>
<pre>password include system-auth
</pre>
<h4><span class="mw-headline" id="Testing_login"><s>Testing login</s></span></h4>
<p>Now, start a new console session (or ssh) and try to login using the AD credentials. The domain name is optional, as this was set in the Winbind configuration as 'default realm'.  Please note that in the case of ssh, you will need to modify the <code>/etc/ssh/sshd_config</code> file to allow kerberos authentication <code>(KerberosAuthentication yes)</code>.
</p>
<pre>test.user
EXAMPLE+test.user
</pre>
<p>Both should work. You should notice that <code>/home/example/test.user</code> will be automatically created.
<b>Log into another session using an linux account. Check that you still be able to log in as root - but keep in mind to be logged in as root in at least one session!</b>
</p>
<h3><span class="mw-headline" id="Configuring_Shares">Configuring Shares</span></h3>
<p>Earlier we skipped configuration of the shares. Now that things are working, go back to <code>/etc/samba/smb.conf</code>, and add the exports for the host that you want available on the windows network. 
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/samba/smb.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[MyShare]
  comment = Example Share
  path = /srv/exports/myshare
  read only = no
  browseable = yes
  valid users = @NETWORK+"Domain Admins" NETWORK+test.user
</pre>
<p>In the above example, the keyword <b>NETWORK</b> is to be used. Do not mistakenly substitute this with your domain name. For adding groups, prepend the '@' symbol to the group. Note that <code>Domain Admins</code> is encapsulated in quotes so Samba correctly parses it when reading the configuration file.
</p>
<h3><span class="mw-headline" id="Adding_a_machine_keytab_file_and_activating_password-free_kerberized_ssh_to_the_machine">Adding a machine keytab file and activating password-free kerberized ssh to the machine</span></h3>
<p>This explains how to generate a machine keytab file which you will need e.g. to enable password-free kerberized ssh to your machine from other machines in the domain. The scenario in mind is that you have a bunch of systems in your domain and you just added a server/workstation using the above description to your domain onto which a lot of users need to ssh in order to work - e.g. GPU workstation or an OpenMP compute node, etc. In this case you might not want to type your password every time you log in. On the other hand the key authentication used by many users in this case can not give you the necessary credentials to e.g. mount kerberized NFSv4 shares. So this will help you to enable password-free logins from your clients to the machine in question using kerberos ticket forwarding.
</p>
<h4><span class="mw-headline" id="Creating_a_machine_key_tab_file"><s>Creating a machine key tab file</s></span></h4>
<p>run 'net ads keytab create -U administrator' as root to create a machine keytab file in /etc/krb5.keytab. It will prompt you with a warning that we need to enable keytab authentication in our configuration file, so we will do that in the next step. In my case it had problems when a key tab file is already in place - the command just did not come back it hang ... In that case you should rename the existing /etc/krb5.keytab and run the command again - it should work now.
</p>
<pre># net ads keytab create -U administrator</pre>
<p>verify the content of your keytab by running:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># klist -k /etc/krb5.keytab</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">Keytab name: FILE:/etc/krb5.keytab
KVNO Principal
---- --------------------------------------------------------------------------
   4 host/myarchlinux.example.com@EXAMPLE.COM
   4 host/myarchlinux.example.com@EXAMPLE.COM
   4 host/myarchlinux.example.com@EXAMPLE.COM
   4 host/myarchlinux.example.com@EXAMPLE.COM
   4 host/myarchlinux.example.com@EXAMPLE.COM
   4 host/MYARCHLINUX@EXAMPLE.COM
   4 host/MYARCHLINUX@EXAMPLE.COM
   4 host/MYARCHLINUX@EXAMPLE.COM
   4 host/MYARCHLINUX@EXAMPLE.COM
   4 host/MYARCHLINUX@EXAMPLE.COM
   4 MYARCHLINUX$@EXAMPLE.COM
   4 MYARCHLINUX$@EXAMPLE.COM
   4 MYARCHLINUX$@EXAMPLE.COM
   4 MYARCHLINUX$@EXAMPLE.COM
   4 MYARCHLINUX$@EXAMPLE.COM
</pre>
<h4><span class="mw-headline" id="Enabling_keytab_authentication"><s>Enabling keytab authentication</s></span></h4>
<p>Now you need to tell winbind to use the file by adding these lines to the /etc/samba/smb.conf:
</p>
<pre> kerberos method = secrets and keytab
 dedicated keytab file = /etc/krb5.keytab
</pre>
<p>It should look something like this:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/samba/smb.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Global]
  netbios name = MYARCHLINUX
  workgroup = EXAMPLE
  realm = EXAMPLE.COM
  server string = %h Arch Linux Host
  security = ads
  encrypt passwords = yes
  password server = pdc.example.com
  kerberos method = secrets and keytab
  dedicated keytab file = /etc/krb5.keytab

  idmap config * : backend = tdb
  idmap config * : range = 10000-20000

  winbind use default domain = Yes
  winbind enum users = Yes
  winbind enum groups = Yes
  winbind nested groups = Yes
  winbind separator = +
  winbind refresh tickets = yes

  template shell = /bin/bash
  template homedir = /home/%D/%U
   
  preferred master = no
  dns proxy = no
  wins server = pdc.example.com
  wins proxy = no

  inherit acls = Yes
  map acl inherit = Yes
  acl group control = yes

  load printers = no
  debug level = 3
  use sendfile = no
</pre>
<p><a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Restart">Restart</a> the <code>winbindd.service</code>
</p>
<p>Check if everything works by getting a machine ticket for your system by running 
</p>
<pre># kinit MYARCHLINUX$ -kt /etc/krb5.keytab</pre>
<p>This should not give you any feedback but running 'klist' should show you sth like:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># klist</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;"> Ticket cache: FILE:/tmp/krb5cc_0
 Default principal: MYARCHLINUX$@EXAMPLE.COM
 
 Valid starting    Expires           Service principal 
 02/04/12 21:27:47 02/05/12 07:27:42 krbtgt/EXAMPLE.COM@EXAMPLE.COM
         renew until 02/05/12 21:27:47
</pre>
<p>Some common mistakes here are a) forgetting the trailing $ or b) ignoring case sensitivity - it needs to look exactly like the entry in the keytab (usually you cannot to much wrong with all capital)
</p>
<h4><span class="mw-headline" id="Preparing_sshd_on_server">Preparing sshd on server</span></h4>
<p>All we need to do is add some options to our <code>sshd_config</code> and <a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Restart">restart</a> the <code>sshd.service</code>.
</p>
<p>Edit <code>/etc/ssh/sshd_config</code> to look like this in the appropriate places:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># /etc/ssh/sshd_config</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">

...

# Change to no to disable s/key passwords
ChallengeResponseAuthentication no

# Kerberos options
KerberosAuthentication yes
#KerberosOrLocalPasswd yes
KerberosTicketCleanup yes
KerberosGetAFSToken yes

# GSSAPI options
GSSAPIAuthentication yes
GSSAPICleanupCredentials yes

...

</pre>
<p><a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Restart">Restart</a> the <code>sshd.service</code>.
</p>
<h4><span class="mw-headline" id="Adding_necessary_options_on_client">Adding necessary options on client</span></h4>
<p>First we need to make sure that the tickets on our client are forwardable. This is usually standard but we better check anyways. You have to look for the  forwardable option and set it to 'true' in the Kerberos configuration file <code>/etc/krb5.conf</code>
</p>
<pre>forwardable     =       true
</pre>
<p>Secondly we need to add the options 
</p>
<pre> GSSAPIAuthentication yes
 GSSAPIDelegateCredentials yes
</pre>
<p>to our <code>.ssh/config</code> file to tell ssh to use this options - alternatively they can be invoked using the <code>-o</code> options directly in the ssh command (see <span class="plainlinks archwiki-template-man" title="$ man 1 ssh"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/ssh.1">ssh(1)</a></span> for help).
</p>
<h4><span class="mw-headline" id="Testing_the_setup">Testing the setup</span></h4>
<p>On Client:
</p>
<p>make sure you have a valid ticket - if in doubt run 'kinit'
</p>
<p>then use ssh to connect to you machine
</p>
<pre>ssh myarchlinux.example.com </pre>
<p>you should get connected without needing to enter your password.
</p>
<p>if you have key authentication additionally activated then you should perform
</p>
<pre>ssh -v myarchlinux.example.com </pre>
<p>to see which authentication method it actually uses.
</p>
<p>For debugging you can enable DEBUG3 on the server and look into the journal using <a href="../en/Systemd/Journal.html" class="mw-redirect" title="Journalctl">journalctl</a>.
</p>
<h4><span class="mw-headline" id="Nifty_fine-tuning_for_complete_password-free_kerberos_handling.">Nifty fine-tuning for complete password-free kerberos handling.</span></h4>
<p>In case your clients are not using domain accounts on their local machines (for whatever reason) it can be hard to actually teach them to kinit before ssh to the workstation. Therefore I came up with a nice workaround:
</p>
<h3><span class="mw-headline" id="Generating_user_Keytabs_which_are_accepted_by_AD">Generating user Keytabs which are accepted by AD</span></h3>
<p>On a system let the user run:
</p>
<pre>ktutil
addent -password -p username@EXAMPLE.COM -k 1 -e RC4-HMAC
- enter password for username -
wkt username.keytab
q
</pre>
<p>Now test the file by invoking:
</p>
<pre>kinit username@EXAMPLE.COM -kt username.keytab</pre>
<p>It should not promt you to give your password nor should it give any other feedback. If it worked you are basically done - just put the line above into your ~./bashrc - you can now get kerberos tickets without typing a password and with that you can connect to your workstation without typing a password while being completely kerberized and able to authenticate against NFSv4 and CIFS via tickets - pretty neat.
</p>
<h4><span class="mw-headline" id="Nice_to_know">Nice to know</span></h4>
<p>The file 'username.keytab' is not machinespecific and can therefore be copied around. E.g. we created the files on a linux machine and copied them to our Mac clients as the commands on Macs are different ...
</p>
<h3><span class="mw-headline" id="See_also">See also</span></h3>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Active_Directory" class="extiw" title="wikipedia:Active Directory">Wikipedia - Active Directory</a></li>
<li><a href="https://en.wikipedia.org/wiki/Samba_(software)" class="extiw" title="wikipedia:Samba (software)">Wikipedia - Samba</a></li>
<li><a href="https://en.wikipedia.org/wiki/Kerberos_(protocol)" class="extiw" title="wikipedia:Kerberos (protocol)">Wikipedia - Kerberos</a></li>
<li><a rel="nofollow" class="external text" href="https://www.samba.org/samba/docs">Samba - Documentation</a></li>
<li><a rel="nofollow" class="external text" href="https://wiki.samba.org/index.php?search=active+directory%7CActive">Directory on Samba Wiki</a></li>
<li><a rel="nofollow" class="external text" href="https://wiki.samba.org/index.php?title=Samba,_Active_Directory_%26_LDAP&amp;direction=next&amp;oldid=4082">Samba Wiki - Samba, Active Directory &amp; LDAP</a></li>
<li><span class="plainlinks archwiki-template-man" title="$ man 5 smb.conf"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/smb.conf.5">smb.conf(5)</a></span></li>
</ul>
<h4><span class="mw-headline" id="Using_SSSD">Using SSSD</span></h4>
<p><span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=sssd">sssd</a></span> can be used instead of Samba to integrate with AD. See <a rel="nofollow" class="external text" href="https://sssd.io/docs/ad/ad-introduction.html">SSSD documentation</a>.
</p>
<h4><span class="mw-headline" id="Commercial_solutions">Commercial solutions</span></h4>
<ul>
<li>Centrify</li>
<li>Likewise</li>
</ul>
<h4><span class="mw-headline" id="OpenSource_version">OpenSource version</span></h4>
<ul>
<li>
<a rel="nofollow" class="external text" href="https://github.com/BeyondTrust/pbis-open/">PowerBroker Identity Services Open</a>: formerly Likewise acquired by BeyondTrust</li>
<li><a rel="nofollow" class="external text" href="https://www.centrify.com/express/linux/">Centrify Express for Linux</a></li>
</ul>
</div>
</div>
					<div id="catlinks" class="catlinks" data-mw="interface">
<div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../Special:Categories.html" title="Special:Categories">Category</a>: <ul><li><a href="../en/Category:Directory_services.html" title="Category:Directory services">Directory services</a></li></ul>
</div>
<div id="mw-hidden-catlinks" class="mw-hidden-catlinks mw-hidden-cats-hidden">Hidden category: <ul><li><a href="../en/Category:Pages_or_sections_flagged_with_Template:Expansion.html" title="Category:Pages or sections flagged with Template:Expansion">Pages or sections flagged with Template:Expansion</a></li></ul>
</div>
</div>
				</div>
			</main>
			
		</div>
		<div class="mw-footer-container">
			
<footer id="footer" class="mw-footer" role="contentinfo" style="margin: 0">
	<ul id="footer-info">
	<li data-nosnippet="">Retrieved from "<a dir="ltr" href="https://wiki.archlinux.org/index.php?title=Active_Directory_integration&amp;oldid=798021">https://wiki.archlinux.org/index.php?title=Active_Directory_integration&amp;oldid=798021</a>"</li>
<li id="footer-info-lastmod"> This page was last edited on 24 January 2024, at 03:11.</li>
	<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="https://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.3 or later</a> unless otherwise noted.</li>
<br>
</ul>

	<ul id="footer-places">
	<li id="footer-places-privacy"><a href="https://terms.archlinux.org/docs/privacy-policy/">Privacy policy</a></li>
	<li id="footer-places-about"><a href="../en/ArchWiki:About.html">About ArchWiki</a></li>
	<li id="footer-places-disclaimers"><a href="../en/ArchWiki:General_disclaimer.html">Disclaimers</a></li>
	<li id="footer-places-archwiki-code-of-conduct"><a href="https://terms.archlinux.org/docs/code-of-conduct/" class="extiw" title="archlinux-service-agreements:code-of-conduct">Code of conduct</a></li>
	<li id="footer-places-archwiki-terms-of-service"><a href="https://terms.archlinux.org/docs/terms-of-service/" class="extiw" title="archlinux-service-agreements:terms-of-service">Terms of service</a></li>
</ul>

	<ul id="footer-icons" class="noprint">
	<li id="footer-copyrightico"><a href="https://www.gnu.org/copyleft/fdl.html"><img src="/resources/assets/licenses/gnu-fdl.png" alt="GNU Free Documentation License 1.3 or later" width="88" height="31" loading="lazy"></a></li>
	<li id="footer-poweredbyico"><img src="/resources/assets/poweredby_mediawiki_88x31.png" srcset="/resources/assets/poweredby_mediawiki_132x47.png 1.5x, /resources/assets/poweredby_mediawiki_176x62.png 2x" width="88" height="31" loading="lazy"></li>
</ul>

</footer>

		</div>
	</div> 
</div> 
<div class="vector-settings" id="p-dock-bottom">
	<ul>
		<li>
		<button class="cdx-button cdx-button--icon-only vector-limited-width-toggle" id=""><span class="vector-icon mw-ui-icon-fullScreen mw-ui-icon-wikimedia-fullScreen"></span>

<span>Toggle limited content width</span>
</button>
</li>
	</ul>
</div>
</body>
</html>
