<!DOCTYPE html>
<html class="client-nojs vector-feature-language-in-header-enabled vector-feature-language-in-main-page-header-disabled vector-feature-sticky-header-disabled vector-feature-page-tools-pinned-disabled vector-feature-toc-pinned-clientpref-1 vector-feature-main-menu-pinned-disabled vector-feature-limited-width-clientpref-1 vector-feature-limited-width-content-enabled vector-feature-custom-font-size-clientpref-0 vector-feature-client-preferences-disabled vector-feature-client-prefs-pinned-disabled vector-feature-night-mode-disabled skin-theme-clientpref-day vector-toc-available" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>Simple stateful firewall - ArchWiki</title>
<link rel="stylesheet" href="../ArchWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<meta name="generator" content="MediaWiki 1.42.1">
<meta name="referrer" content="no-referrer-when-downgrade">
<meta name="robots" content="max-image-preview:standard">
<meta name="format-detection" content="telephone=no">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=0.25, maximum-scale=5.0">
<link rel="icon" href="/favicon.ico">
<link rel="search" type="application/opensearchdescription+xml" href="/opensearch_desc.php" title="ArchWiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.archlinux.org/api.php?action=rsd">
<link rel="license" href="https://www.gnu.org/copyleft/fdl.html">
<link rel="alternate" type="application/atom+xml" title="ArchWiki Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="skin-vector skin-vector-search-vue mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-Simple_stateful_firewall rootpage-Simple_stateful_firewall skin-vector-2022 action-view skin--responsive">
<a class="mw-jump-link" href="#bodyContent">Jump to content</a>
<div class="vector-header-container">
	</div>
<div class="mw-page-container">
	<div class="mw-page-container-inner">
		<div class="vector-column-start">
			<div class="vector-main-menu-container">
		</div>
	<div class="vector-sticky-pinned-container">
				<nav id="mw-panel-toc" role="navigation" aria-label="Contents" data-event-name="ui.sidebar-toc" class="mw-table-of-contents-container vector-toc-landmark">
					<div id="vector-toc-pinned-container" class="vector-pinned-container">
					<div id="vector-toc" class="vector-toc vector-pinnable-element">
	<div class="vector-pinnable-header vector-toc-pinnable-header vector-pinnable-header-pinned" data-feature-name="toc-pinned" data-pinnable-element-id="vector-toc">
	<h2 class="vector-pinnable-header-label">Contents</h2>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-pin-button" data-event-name="pinnable-header.vector-toc.pin">move to sidebar</button>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-unpin-button" data-event-name="pinnable-header.vector-toc.unpin">hide</button>
</div>


	<ul class="vector-toc-contents" id="mw-panel-toc-list">
		<li id="toc-mw-content-text" class="vector-toc-list-item vector-toc-level-1">
			<a href="#" class="vector-toc-link">
				<div class="vector-toc-text">Beginning</div>
			</a>
		</li>
		<li id="toc-Prerequisites" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#Prerequisites">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">1</span>Prerequisites</div>
		</a>
		
		<ul id="toc-Prerequisites-sublist" class="vector-toc-list">
		</ul>
	</li>
	<li id="toc-Firewall_for_a_single_machine" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#Firewall_for_a_single_machine">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">2</span>Firewall for a single machine</div>
		</a>
		
			<button aria-controls="toc-Firewall_for_a_single_machine-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Firewall for a single machine subsection</span>
			</button>
		
		<ul id="toc-Firewall_for_a_single_machine-sublist" class="vector-toc-list">
			<li id="toc-Creating_necessary_chains" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Creating_necessary_chains">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.1</span>Creating necessary chains</div>
			</a>
			
			<ul id="toc-Creating_necessary_chains-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-The_FORWARD_chain" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#The_FORWARD_chain">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.2</span>The FORWARD chain</div>
			</a>
			
			<ul id="toc-The_FORWARD_chain-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-The_OUTPUT_chain" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#The_OUTPUT_chain">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.3</span>The OUTPUT chain</div>
			</a>
			
			<ul id="toc-The_OUTPUT_chain-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-The_INPUT_chain" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#The_INPUT_chain">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.4</span>The INPUT chain</div>
			</a>
			
			<ul id="toc-The_INPUT_chain-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Resulting_iptables.rules_file" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Resulting_iptables.rules_file">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.5</span>Resulting iptables.rules file</div>
			</a>
			
			<ul id="toc-Resulting_iptables.rules_file-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-The_TCP_and_UDP_chains" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#The_TCP_and_UDP_chains">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.6</span>The TCP and UDP chains</div>
			</a>
			
			<ul id="toc-The_TCP_and_UDP_chains-sublist" class="vector-toc-list">
				<li id="toc-Opening_ports_to_incoming_connections" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Opening_ports_to_incoming_connections">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.6.1</span>Opening ports to incoming connections</div>
			</a>
			
			<ul id="toc-Opening_ports_to_incoming_connections-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Port_knocking" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Port_knocking">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.6.2</span>Port knocking</div>
			</a>
			
			<ul id="toc-Port_knocking-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Protection_against_spoofing_attacks" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Protection_against_spoofing_attacks">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.7</span>Protection against spoofing attacks</div>
			</a>
			
			<ul id="toc-Protection_against_spoofing_attacks-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id='toc-"Hide"_your_computer' class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href='#"Hide"_your_computer'>
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.8</span>"Hide" your computer</div>
			</a>
			
			<ul id='toc-"Hide"_your_computer-sublist' class="vector-toc-list">
				<li id="toc-Block_ping_request" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Block_ping_request">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.8.1</span>Block ping request</div>
			</a>
			
			<ul id="toc-Block_ping_request-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Tricking_port_scanners" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Tricking_port_scanners">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.8.2</span>Tricking port scanners</div>
			</a>
			
			<ul id="toc-Tricking_port_scanners-sublist" class="vector-toc-list">
				<li id="toc-SYN_scans" class="vector-toc-list-item vector-toc-level-4">
			<a class="vector-toc-link" href="#SYN_scans">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.8.2.1</span>SYN scans</div>
			</a>
			
			<ul id="toc-SYN_scans-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-UDP_scans" class="vector-toc-list-item vector-toc-level-4">
			<a class="vector-toc-link" href="#UDP_scans">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.8.2.2</span>UDP scans</div>
			</a>
			
			<ul id="toc-UDP_scans-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Restore_the_Final_Rule" class="vector-toc-list-item vector-toc-level-4">
			<a class="vector-toc-link" href="#Restore_the_Final_Rule">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.8.2.3</span>Restore the Final Rule</div>
			</a>
			
			<ul id="toc-Restore_the_Final_Rule-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Protection_against_other_attacks" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Protection_against_other_attacks">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.9</span>Protection against other attacks</div>
			</a>
			
			<ul id="toc-Protection_against_other_attacks-sublist" class="vector-toc-list">
				<li id="toc-Bruteforce_attacks" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Bruteforce_attacks">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.9.1</span>Bruteforce attacks</div>
			</a>
			
			<ul id="toc-Bruteforce_attacks-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-IPv6" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#IPv6">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.10</span>IPv6</div>
			</a>
			
			<ul id="toc-IPv6-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Saving_the_rules" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Saving_the_rules">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.11</span>Saving the rules</div>
			</a>
			
			<ul id="toc-Saving_the_rules-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Resulting_ip6tables.rules_file" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Resulting_ip6tables.rules_file">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.12</span>Resulting ip6tables.rules file</div>
			</a>
			
			<ul id="toc-Resulting_ip6tables.rules_file-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Setting_up_a_NAT_gateway" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#Setting_up_a_NAT_gateway">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">3</span>Setting up a NAT gateway</div>
		</a>
		
			<button aria-controls="toc-Setting_up_a_NAT_gateway-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Setting up a NAT gateway subsection</span>
			</button>
		
		<ul id="toc-Setting_up_a_NAT_gateway-sublist" class="vector-toc-list">
			<li id="toc-Setting_up_the_filter_table" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Setting_up_the_filter_table">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.1</span>Setting up the filter table</div>
			</a>
			
			<ul id="toc-Setting_up_the_filter_table-sublist" class="vector-toc-list">
				<li id="toc-Creating_necessary_chains_2" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Creating_necessary_chains_2">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.1.1</span>Creating necessary chains</div>
			</a>
			
			<ul id="toc-Creating_necessary_chains_2-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Setting_up_the_FORWARD_chain" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Setting_up_the_FORWARD_chain">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.1.2</span>Setting up the FORWARD chain</div>
			</a>
			
			<ul id="toc-Setting_up_the_FORWARD_chain-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Setting_up_the_fw-interfaces_and_fw-open_chains" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Setting_up_the_fw-interfaces_and_fw-open_chains">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.1.3</span>Setting up the fw-interfaces and fw-open chains</div>
			</a>
			
			<ul id="toc-Setting_up_the_fw-interfaces_and_fw-open_chains-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Setting_up_the_nat_table" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Setting_up_the_nat_table">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.2</span>Setting up the nat table</div>
			</a>
			
			<ul id="toc-Setting_up_the_nat_table-sublist" class="vector-toc-list">
				<li id="toc-Setting_up_the_POSTROUTING_chain" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Setting_up_the_POSTROUTING_chain">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.2.1</span>Setting up the POSTROUTING chain</div>
			</a>
			
			<ul id="toc-Setting_up_the_POSTROUTING_chain-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Setting_up_the_PREROUTING_chain" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Setting_up_the_PREROUTING_chain">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.2.2</span>Setting up the PREROUTING chain</div>
			</a>
			
			<ul id="toc-Setting_up_the_PREROUTING_chain-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Saving_the_rules_2" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Saving_the_rules_2">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.3</span>Saving the rules</div>
			</a>
			
			<ul id="toc-Saving_the_rules_2-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-See_Also" class="vector-toc-list-item vector-toc-level-1">
		<a class="vector-toc-link" href="#See_Also">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">4</span>See Also</div>
		</a>
		
		<ul id="toc-See_Also-sublist" class="vector-toc-list">
		</ul>
	</li>
</ul>
</div>

					</div>
		</nav>
			</div>
		</div>
		<div class="mw-content-container">
			<main id="content" class="mw-body" role="main" style="margin: 0">
				<header class="mw-body-header vector-page-titlebar">
					<nav role="navigation" aria-label="Contents" class="vector-toc-landmark">
						
<div id="vector-page-titlebar-toc" class="vector-dropdown vector-page-titlebar-toc vector-button-flush-left">
	<input type="checkbox" id="vector-page-titlebar-toc-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-vector-page-titlebar-toc" class="vector-dropdown-checkbox " aria-label="Toggle the table of contents">
	<label id="vector-page-titlebar-toc-label" for="vector-page-titlebar-toc-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--icon-only " aria-hidden="true"><span class="vector-icon mw-ui-icon-listBullet mw-ui-icon-wikimedia-listBullet"></span>

<span class="vector-dropdown-label-text">Toggle the table of contents</span>
	</label>
	<div class="vector-dropdown-content">


							<div id="vector-page-titlebar-toc-unpinned-container" class="vector-unpinned-container">
			</div>
		
	</div>
</div>

					</nav>
					<h1 id="firstHeading" class="firstHeading mw-first-heading"><span class="mw-page-title-main">Simple stateful firewall</span></h1>
							
<div id="p-lang-btn" class="vector-dropdown mw-portlet mw-portlet-lang">
	<input type="checkbox" id="p-lang-btn-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-p-lang-btn" class="vector-dropdown-checkbox mw-interlanguage-selector" aria-label="Go to an article in another language. Available in 4 languages">
	<label id="p-lang-btn-label" for="p-lang-btn-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--action-progressive mw-portlet-lang-heading-4" aria-hidden="true"><span class="vector-icon mw-ui-icon-language-progressive mw-ui-icon-wikimedia-language-progressive"></span>

<span class="vector-dropdown-label-text">4 languages</span>
	</label>
	<div class="vector-dropdown-content">

		<div class="vector-menu-content">
			
			<ul class="vector-menu-content-list">
				
				<li class="interlanguage-link interwiki-es mw-list-item"><a href="../es/Simple_stateful_firewall.html" title="Simple stateful firewall – español" lang="es" hreflang="es" class="interlanguage-link-target"><span>Español</span></a></li>
<li class="interlanguage-link interwiki-ja mw-list-item"><a href="https://wiki.archlinux.jp/index.php/%E3%82%B7%E3%83%B3%E3%83%97%E3%83%AB%E3%81%AA%E3%82%B9%E3%83%86%E3%83%BC%E3%83%88%E3%83%95%E3%83%AB%E3%83%95%E3%82%A1%E3%82%A4%E3%82%A2%E3%82%A6%E3%82%A9%E3%83%BC%E3%83%AB" title="シンプルなステートフルファイアウォール – 日本語" lang="ja" hreflang="ja" class="interlanguage-link-target"><span>日本語</span></a></li>
<li class="interlanguage-link interwiki-ru mw-list-item"><a href="../ru/Simple_stateful_firewall.html" title="Simple stateful firewall – русский" lang="ru" hreflang="ru" class="interlanguage-link-target"><span>Русский</span></a></li>
<li class="interlanguage-link interwiki-zh-hans mw-list-item"><a href="https://wiki.archlinuxcn.org/wiki/Simple_stateful_firewall" title="Simple stateful firewall – 中文（简体）" lang="zh-Hans" hreflang="zh-Hans" class="interlanguage-link-target"><span>中文（简体）</span></a></li>
			</ul>
			
		</div>

	</div>
</div>
</header>
				<div class="vector-column-end">
					<div class="vector-sticky-pinned-container">
						<nav class="vector-page-tools-landmark" aria-label="Page tools">
							<div id="vector-page-tools-pinned-container" class="vector-pinned-container">
				
							</div>
		</nav>
						<nav class="vector-client-prefs-landmark" aria-label="Appearance">
						</nav>
					</div>
				</div>
				<div id="bodyContent" class="vector-body" aria-labelledby="firstHeading" data-mw-ve-target-container>
					<div class="vector-body-before-content">
							<div class="mw-indicators">
		</div>

						<div id="siteSub" class="noprint">From ArchWiki</div>
					</div>
					<div id="contentSub"><div id="mw-content-subtitle"></div></div>
					
					
					<div id="mw-content-text" class="mw-body-content">
<div class="mw-content-ltr mw-parser-output" lang="en" dir="ltr">
<div class="archwiki-template-meta-related-articles">
<p>Related articles</p>
<ul>
<li><a href="../en/Category:Firewalls.html" class="mw-redirect" title="Firewalls">Firewalls</a></li>
<li><a href="../en/Internet_sharing.html" title="Internet sharing">Internet sharing</a></li>
<li><a href="../en/Nftables.html#Simple_stateful_firewall" title="Nftables">Nftables#Simple stateful firewall</a></li>
<li><a href="../en/Router.html" title="Router">Router</a></li>
<li><a href="../en/Uncomplicated_Firewall.html" title="Uncomplicated Firewall">Uncomplicated Firewall</a></li>
</ul>
</div>
<p>This page explains how to set up a <a href="https://en.wikipedia.org/wiki/Stateful_firewall" class="extiw" title="wikipedia:Stateful firewall">stateful firewall</a> using <a href="../en/Iptables.html" title="Iptables">iptables</a>. It also explains what the rules mean and why they are needed. For simplicity, it is split into two major sections. The first section deals with a firewall for a single machine, the second sets up a NAT gateway in addition to the firewall from the first section.
</p>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong>  The rules below are given in the order they are executed and should only be followed while logged in locally. If you are logged into a remote machine, you may be locked out of the machine while setting up the rules. To get around this problem in a remote setup, the <a href="#Resulting_iptables.rules_file">example configuration file</a> can be used.</div>
<meta property="mw:PageProp/toc">
<h2><span class="mw-headline" id="Prerequisites">Prerequisites</span></h2>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> Your kernel needs to be compiled with iptables support. All stock Arch Linux kernels have iptables support.</div>
<p>First, install the userland utilities <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=iptables">iptables</a></span> or verify that they are already installed.
</p>
<p>This article assumes that there are currently no iptables rules set. To check the current ruleset and verify that there are currently no rules run the following:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># iptables-save</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;"># Generated by iptables-save v1.4.19.1 on Thu Aug  1 19:28:53 2013
*filter
:INPUT ACCEPT [50:3763]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [30:3472]
COMMIT
# Completed on Thu Aug  1 19:28:53 2013
</pre>
<p>or
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># iptables -nvL --line-numbers</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">Chain INPUT (policy ACCEPT 156 packets, 12541 bytes)
num   pkts bytes target     prot opt in     out     source               destination

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
num   pkts bytes target     prot opt in     out     source               destination

Chain OUTPUT (policy ACCEPT 82 packets, 8672 bytes)
num   pkts bytes target     prot opt in     out     source               destination
</pre>
<p>If there are rules, you may be able to reset the rules by loading a default rule set:
</p>
<pre># iptables-restore &lt; /etc/iptables/empty.rules
</pre>
<p>Otherwise, see <a href="../en/Iptables.html#Resetting_rules" title="Iptables">Iptables#Resetting rules</a>.
</p>
<h2><span class="mw-headline" id="Firewall_for_a_single_machine">Firewall for a single machine</span></h2>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> Because iptables processes rules in linear order, from top to bottom within a chain, it is advised to put frequently-hit rules near the start of the chain. Of course there is a limit, depending on the logic that is being implemented. Also, rules have an associated runtime cost, so rules should not be reordered solely based upon empirical observations of the byte/packet counters.</div>
<h3><span class="mw-headline" id="Creating_necessary_chains">Creating necessary chains</span></h3>
<p>For this basic setup, we will create two user-defined chains that we will use to open up ports in the firewall.
</p>
<pre># iptables -N TCP
# iptables -N UDP
</pre>
<p>The chains can of course have arbitrary names. We pick these just to match the protocols we want handle with them in the later rules, which are specified with the protocol options, e.g. <code>-p tcp</code>, always.
</p>
<h3><span class="mw-headline" id="The_FORWARD_chain">The FORWARD chain</span></h3>
<p>If you want to set up your machine as a NAT gateway, please look at <a href="#Setting_up_a_NAT_gateway">#Setting up a NAT gateway</a>. For a single machine, however, we simply set the policy of the <b>FORWARD</b> chain to <b>DROP</b> and move on:
</p>
<pre># iptables -P FORWARD DROP
</pre>
<h3><span class="mw-headline" id="The_OUTPUT_chain">The OUTPUT chain</span></h3>
<p>The OUTPUT chain can be a powerful tool for filtering outbound traffic, especially for servers and other devices which do not run web browsers or peer-to-peer tools that need to connect to arbitrary destinations on the internet. However, properly setting up an OUTPUT chain requires information about the intended use of the system. A secure set of rules for a desktop system, laptop system, cloud server and home/on-prem server would all be very different.
</p>
<p>In this simple example, we will allow all outbound traffic by setting the default policy for the <b>OUTPUT</b> chain to <b>ACCEPT</b>. This is less secure, but is highly compatible with many systems.
</p>
<pre># iptables -P OUTPUT ACCEPT
</pre>
<h3><span class="mw-headline" id="The_INPUT_chain">The INPUT chain</span></h3>
<p>Similar to the previous chains, we set the default policy for the <b>INPUT</b> chain to <b>DROP</b> in case something somehow slips by our rules. Dropping all traffic and specifying what is allowed is the best way to make a secure firewall.
</p>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> If you are logged in via SSH, the following will immediately disconnect the SSH session. To avoid it: 
<ol>
<li>add the first INPUT chain rule below (it will keep the session open),</li>
<li>add a regular rule to allow inbound SSH (to be able to reconnect in case of a connection drop) and</li>
<li>set the policy.</li>
</ol>
</div>
<pre># iptables -P INPUT DROP
</pre>
<p>Every packet that is received by any network interface will pass the <b>INPUT</b> chain first, if it is destined for this machine. In this chain, we make sure that only the packets that we want are accepted. For a simplified ASCII art showing how packets traverse those builtin chains, see <a rel="nofollow" class="external text" href="https://www.netfilter.org/documentation/HOWTO/packet-filtering-HOWTO-6.html">How Packets Traverse The Filters</a>.
</p>
<p>The first rule added to the INPUT chain will allow traffic that belongs to established connections, or new valid traffic that is related to these connections such as ICMP errors, or echo replies (the packets a host returns when pinged). ICMP stands for Internet Control Message Protocol. Some ICMP messages are very important and help to manage congestion and MTU, and are accepted by this rule:
</p>
<pre># iptables -A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
</pre>
<p>The connection state <code>ESTABLISHED</code> implies that either another rule previously allowed the initial (<code>--ctstate NEW</code>) connection attempt or the connection was already active (for example an active remote SSH connection).
</p>
<p>The second rule will accept all traffic from the "loopback" (lo) interface, which is necessary for many applications and services.
</p>
<pre># iptables -A INPUT -i lo -j ACCEPT
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> You can add more trusted interfaces here such as "eth1" if you do not want/need the traffic filtered by the firewall, but be warned that if you have a NAT setup that redirects any kind of traffic to this interface from anywhere else in the network (let us say a router), it will get through, regardless of any other settings you may have.</div>
<p>The third rule will drop all traffic with an "INVALID" state match. Traffic can fall into four "state" categories: NEW, ESTABLISHED, RELATED or INVALID and this is what makes this a "stateful" firewall rather than a less secure "stateless" one. States are tracked using the "nf_conntrack_*" kernel modules which are loaded automatically by the kernel as you add rules.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> 
<ul>
<li>This rule will drop all packets with invalid headers or checksums, invalid TCP flags, invalid ICMP messages (such as a port unreachable when we did not send anything to the host), and out of sequence packets which can be caused by sequence prediction or other similar attacks. The "DROP" target will drop a packet without any response, contrary to REJECT which politely refuses the packet. We use DROP because there is no proper "REJECT" response to packets that are INVALID, and we do not want to acknowledge that we received these packets.</li>
<li>ICMPv6 Neighbor Discovery packets remain untracked, and will always be classified "INVALID" though they are not corrupted or the like. Keep this in mind, and accept them before this rule! Run <code>iptables -A INPUT -p 41 -j ACCEPT</code> as root.</li>
</ul>
</div>
<pre># iptables -A INPUT -m conntrack --ctstate INVALID -j DROP
</pre>
<p>The next rule will accept all new incoming ICMP echo requests, also known as pings. Only the first packet will count as NEW, the others will be handled by the RELATED, ESTABLISHED rule. Since the computer is not a router, no other ICMP traffic with state NEW needs to be allowed.
</p>
<pre># iptables -A INPUT -p icmp --icmp-type 8 -m conntrack --ctstate NEW -j ACCEPT
</pre>
<p>Now we attach the TCP and UDP chains to the INPUT chain to handle all new incoming connections. Once a connection is accepted by either TCP or UDP chain, it is handled by the RELATED/ESTABLISHED traffic rule. The TCP and UDP chains will either accept new incoming connections, or politely reject them. New TCP connections must be started with SYN packets.
</p>
<pre># iptables -A INPUT -p udp -m conntrack --ctstate NEW -j UDP
# iptables -A INPUT -p tcp --syn -m conntrack --ctstate NEW -j TCP
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> <code>NEW</code> does not necessarily imply <code>--syn</code>. However, packets that match "<code>NEW</code> but not <code>--syn</code>" are rarely malicious and should not just be dropped. Instead, they are simply rejected with a TCP RESET by the next rule. Also, <code>--syn</code> is not equivalent to <code>--tcp-flags SYN SYN</code>. See <span class="plainlinks archwiki-template-man" title="$ man 8 iptables-extensions"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/iptables-extensions.8">iptables-extensions(8)</a></span> for details.</div>
<p>We reject TCP connections with TCP RESET packets and UDP streams with ICMP port unreachable messages if the ports are not opened. This imitates default Linux behavior (RFC compliant), and it allows the sender to quickly close the connection and clean up.
</p>
<pre># iptables -A INPUT -p udp -j REJECT --reject-with icmp-port-unreachable
# iptables -A INPUT -p tcp -j REJECT --reject-with tcp-reset
</pre>
<p>For other protocols, we add a final rule to the INPUT chain to reject all remaining incoming traffic with icmp protocol unreachable messages. This imitates Linux's default behavior.
</p>
<pre># iptables -A INPUT -j REJECT --reject-with icmp-proto-unreachable
</pre>
<h3><span class="mw-headline" id="Resulting_iptables.rules_file">Resulting iptables.rules file</span></h3>
<p>Example of <code>iptables.rules</code> file after running all the commands from above:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/iptables/iptables.rules</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;"># Generated by iptables-save v1.4.18 on Sun Mar 17 14:21:12 2013
*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [0:0]
:TCP - [0:0]
:UDP - [0:0]
-A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -m conntrack --ctstate INVALID -j DROP
-A INPUT -p icmp -m icmp --icmp-type 8 -m conntrack --ctstate NEW -j ACCEPT
-A INPUT -p udp -m conntrack --ctstate NEW -j UDP
-A INPUT -p tcp --tcp-flags FIN,SYN,RST,ACK SYN -m conntrack --ctstate NEW -j TCP
-A INPUT -p udp -j REJECT --reject-with icmp-port-unreachable
-A INPUT -p tcp -j REJECT --reject-with tcp-reset
-A INPUT -j REJECT --reject-with icmp-proto-unreachable
COMMIT
# Completed on Sun Mar 17 14:21:12 2013
</pre>
<p>This file can be generated and saved with:
</p>
<pre># iptables-save -f /etc/iptables/iptables.rules
</pre>
<p>and can be used to continue with the following sections. If you are setting up the firewall remotely via SSH, append the following rule to allow new SSH connections before continuing (adjust port as required):
</p>
<pre># iptables -A TCP -p tcp --dport 22 -j ACCEPT
</pre>
<h3><span class="mw-headline" id="The_TCP_and_UDP_chains">The TCP and UDP chains</span></h3>
<p>The TCP and UDP chains contain rules for accepting new incoming TCP connections and UDP streams to specific ports.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> This is where you need to add rules to accept incoming connections, such as SSH, HTTP or other services that you want to access remotely.</div>
<h4><span class="mw-headline" id="Opening_ports_to_incoming_connections">Opening ports to incoming connections</span></h4>
<p>To accept incoming TCP connections on port 80 for a web server:
</p>
<pre># iptables -A TCP -p tcp --dport 80 -j ACCEPT
</pre>
<p>To accept incoming TCP connections on port 443 for a web server (HTTPS):
</p>
<pre># iptables -A TCP -p tcp --dport 443 -j ACCEPT
</pre>
<p>To allow remote SSH connections (on port 22):
</p>
<pre># iptables -A TCP -p tcp --dport 22 -j ACCEPT
</pre>
<p>To accept incoming TCP/UDP requests for a <a href="../en/Category:Domain_Name_System.html" class="mw-redirect" title="DNS server">DNS server</a> (port 53):
</p>
<pre># iptables -A TCP -p tcp --dport 53 -j ACCEPT
# iptables -A UDP -p udp --dport 53 -j ACCEPT
</pre>
<p>See <span class="plainlinks archwiki-template-man" title="$ man 8 iptables"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/iptables.8">iptables(8)</a></span> for more advanced rules, like matching multiple ports.
</p>
<h4><span class="mw-headline" id="Port_knocking">Port knocking</span></h4>
<p>Port knocking is a method to externally open ports that, by default, the firewall keeps closed. It works by requiring connection attempts to a series of predefined closed ports. When the correct sequence of port "knocks" (connection attempts) is received, the firewall opens certain port(s) to allow a connection. See <a href="../en/Port_knocking.html" title="Port knocking">Port knocking</a> for more information.
</p>
<h3><span class="mw-headline" id="Protection_against_spoofing_attacks">Protection against spoofing attacks</span></h3>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> <code>rp_filter</code> is currently set to <code>2</code> by default in <code>/usr/lib/sysctl.d/50-default.conf</code>, so the following step is not necessary.</div>
<p>Blocking reserved local addresses incoming from the internet or local network is normally done through setting <code>rp_filter</code> (Reverse Path Filter) in sysctl to 1. To do so, add the following line to your <code>/etc/sysctl.d/90-firewall.conf</code> file (see <a href="../en/Sysctl.html" title="Sysctl">sysctl</a> for details) to enable source address verification which is built into Linux kernel itself. The verification by the kernel will handle spoofing better than individual iptables rules for each case.
</p>
<pre>net.ipv4.conf.all.rp_filter=1
</pre>
<p>This can be done with netfilter instead if statistics (and better logging) are desired:
</p>
<pre># iptables -t mangle -I PREROUTING -m rpfilter --invert -j DROP
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> There is no reason to enable this in both places. The netfilter method is the modern choice and works with IPv6 too.</div>
<p>For niche setups where asymmetric routing is used, the <code>rp_filter=2</code> sysctl option needs to be used instead. Passing the <code>--loose</code> switch to the <code>rpfilter</code> module will accomplish the same thing with netfilter.
</p>
<h3>
<span id=".22Hide.22_your_computer"></span><span class="mw-headline" id='"Hide"_your_computer'>"Hide" your computer</span>
</h3>
<p>If you are running a desktop machine, it might be a good idea to block some incoming requests.
</p>
<h4><span class="mw-headline" id="Block_ping_request">Block ping request</span></h4>
<p>A 'Ping' request is an ICMP packet sent to the destination address to ensure connectivity between the devices. If your network works well, you can safely block all ping requests. It is important to note that this <i>does not</i> actually hide your computer — any packet sent to you is rejected, so you will still show up in a simple nmap "ping scan" of an IP range.
</p>
<p>This is rudimentary "protection" and makes life difficult when debugging issues in the future. This should only be done for educational purposes.
</p>
<p>To block echo requests, add the following line to your <code>/etc/sysctl.d/90-firewall.conf</code> file (see <a href="../en/Sysctl.html" title="Sysctl">sysctl</a> for details):
</p>
<pre>net.ipv4.icmp_echo_ignore_all = 1
</pre>
<p>More information in <span class="plainlinks archwiki-template-man" title="$ man 8 iptables"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/iptables.8">iptables(8)</a></span>, or reading the docs and examples on the webpage <a rel="nofollow" class="external free" href="http://www.snowman.net/projects/ipt_recent/">http://www.snowman.net/projects/ipt_recent/</a>
</p>
<h4><span class="mw-headline" id="Tricking_port_scanners">Tricking port scanners</span></h4>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> 
<ul>
<li>This opens you up to a form of <a href="https://en.wikipedia.org/wiki/Denial-of-service_attack" class="extiw" title="wikipedia:Denial-of-service attack">DoS</a>. An attack can send packets with spoofed IPs and get them blocked from connecting to your services.</li>
<li>This trick may block a legitimate IP address if some packets from this address to the destination port are regarded as INVALID by module conntrack. To avoid blacklisting, a workaround is to allow all packets directed to that particular destination port.</li>
</ul>
</div>
<p>Port scans are used by attackers to identify open ports on your computer. This allows them to identify and fingerprint your running services and possibly launch exploits against them.
</p>
<p>The INVALID state rule will take care of every type of port scan except UDP, ACK and SYN scans (<code>-sU</code>, <code>-sA</code> and <code>-sS</code> in <i>nmap</i> respectively). 
</p>
<p><i>ACK scans</i> are not used to identify open ports, but to identify ports filtered by a firewall. Due to the SYN check for all TCP connections with the state NEW, every single packet sent by an ACK scan will be correctly rejected by a TCP RESET packet. Some firewalls drop these packets instead, and this allows an attacker to map out the firewall rules.
</p>
<p>The recent module can be used to trick the remaining two types of port scans. The recent module is used to add hosts to a "recent" list which can be used to fingerprint and stop certain types of attacks. Current recent lists can be viewed in <code>/proc/net/xt_recent/</code>.
</p>
<h5><span class="mw-headline" id="SYN_scans">SYN scans</span></h5>
<p>In a SYN scan, the port scanner sends a SYN (synchronization) packet to every port to initiate a TCP connection. Closed ports return a TCP RESET packet, or get dropped by a strict firewall, while open ports return a SYN ACK packet.
</p>
<p>The <code>recent</code> module can be used to keep track of hosts with rejected connection attempts and return a TCP RESET for any SYN packet they send to open ports as if the port was closed. If an open port is the first to be scanned, a SYN ACK will still be returned, so running applications such as ssh on non-standard ports is required for this to work consistently.
</p>
<p>First, insert a rule at the top of the TCP chain. This rule responds with a TCP RESET to any host that got onto the <code>TCP-PORTSCAN</code> list in the past sixty seconds. The <code>--update</code> switch causes the recent list to be updated, meaning the 60 second counter is reset.
</p>
<pre># iptables -I TCP -p tcp -m recent --update --rsource --seconds 60 --name TCP-PORTSCAN -j REJECT --reject-with tcp-reset
</pre>
<p>Next, the rule for rejecting TCP packets need to be modified to add hosts with rejected packets to the <code>TCP-PORTSCAN</code> list.
</p>
<pre># iptables -D INPUT -p tcp -j REJECT --reject-with tcp-reset
# iptables -A INPUT -p tcp -m recent --set --rsource --name TCP-PORTSCAN -j REJECT --reject-with tcp-reset
</pre>
<h5><span class="mw-headline" id="UDP_scans">UDP scans</span></h5>
<p>UDP port scans are similar to TCP SYN scans except that UDP is a "connectionless" protocol. There are no handshakes or acknowledgements. Instead, the scanner sends UDP packets to each UDP port. Closed ports should return ICMP port unreachable messages, and open ports do not return a response. Since UDP is not a "reliable" protocol, the scanner has no way of knowing if packets were lost, and has to do multiple checks for each port that does not return a response.
</p>
<p>The Linux kernel sends out ICMP port unreachable messages very slowly, so a full UDP scan against a Linux machine would take over 10 hours. However, common ports could still be identified, so applying the same countermeasures against UDP scans as SYN scans is a good idea.
</p>
<p>First, add a rule to reject packets from hosts on the <code>UDP-PORTSCAN</code> list to the top of the UDP chain.
</p>
<pre># iptables -I UDP -p udp -m recent --update --rsource --seconds 60 --name UDP-PORTSCAN -j REJECT --reject-with icmp-port-unreachable
</pre>
<p>Next, modify the reject packets rule for UDP:
</p>
<pre># iptables -D INPUT -p udp -j REJECT --reject-with icmp-port-unreachable
# iptables -A INPUT -p udp -m recent --set --rsource --name UDP-PORTSCAN -j REJECT --reject-with icmp-port-unreachable
</pre>
<h5><span class="mw-headline" id="Restore_the_Final_Rule">Restore the Final Rule</span></h5>
<p>If either or both of the portscanning tricks above were used, the final default rule is no longer the last rule in the INPUT chain. It needs to be the last rule, or it would intercept the <i>trick port scanner</i> rules you just added, rendering them useless. Simply delete (<code>-D</code>) the rule, then add it again using append (<code>-A</code>), which will place it at the end of the chain.
</p>
<pre># iptables -D INPUT -j REJECT --reject-with icmp-proto-unreachable
# iptables -A INPUT -j REJECT --reject-with icmp-proto-unreachable
</pre>
<h3><span class="mw-headline" id="Protection_against_other_attacks">Protection against other attacks</span></h3>
<p>See the <a href="../en/Sysctl.html#TCP/IP_stack_hardening" title="Sysctl">sysctl#TCP/IP stack hardening</a> for relevant kernel parameters.
</p>
<h4><span class="mw-headline" id="Bruteforce_attacks">Bruteforce attacks</span></h4>
<p>Unfortunately, bruteforce attacks on services accessible via an external IP address are common. One reason for this is that the attacks are easy to perform with the many tools available. Fortunately, there are a number of ways to protect the services against them. One is the use of appropriate <code>iptables</code> rules which activate and blacklist an IP after a set number of packets attempt to initiate a connection. Another is the use of specialised daemons that monitor the logfiles for failed attempts and blacklist accordingly.
</p>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> Using an IP blacklist will stop trivial attacks but it relies on an additional daemon and successful logging (the partition containing <code>/var</code> can become full, especially if an attacker is pounding on the server). Additionally, with the knowledge of your IP address, the attacker can send packets with a spoofed source header and get you locked out of the server. <a href="../en/SSH_keys.html" title="SSH keys">SSH keys</a> provide an elegant solution to the problem of brute forcing without these problems.</div>
<p>Two packages that ban IPs after too many password failures are <a href="../en/Fail2ban.html" title="Fail2ban">Fail2ban</a> or, for <code>sshd</code> in particular, <a href="../en/Sshguard.html" title="Sshguard">Sshguard</a>. These two applications update iptables rules to reject temporarily or permanently future connections from attackers.
</p>
<p>The following rules give an example configuration to mitigate SSH bruteforce attacks using <code>iptables</code>.
</p>
<pre># iptables -N IN_SSH
# iptables -N LOG_AND_DROP
# iptables -A INPUT -p tcp --dport ssh -m conntrack --ctstate NEW -j IN_SSH
# iptables -A IN_SSH -m recent --name sshbf --rttl --rcheck --hitcount 3 --seconds 10 -j LOG_AND_DROP
# iptables -A IN_SSH -m recent --name sshbf --rttl --rcheck --hitcount 4 --seconds 1800 -j LOG_AND_DROP 
# iptables -A IN_SSH -m recent --name sshbf --set -j ACCEPT
# iptables -A LOG_AND_DROP -j LOG --log-prefix "iptables deny: " --log-level 7
# iptables -A LOG_AND_DROP -j DROP
</pre>
<p>Most of the rules should be self-explanatory: the first one allows for a maximum of three connection packets in ten seconds and drops further attempts from this IP. The next rule adds a quirk by allowing a maximum of four hits in 30 minutes. This is done because some bruteforce attacks are actually performed slow and not in a burst of attempts. The rules employ a number of additional options. To read more about them, check the original reference for this example in <a rel="nofollow" class="external text" href="https://compilefailure.blogspot.com/2011/04/better-ssh-brute-force-prevention-with.html">compilefailure.blogspot.com</a>. The LOG_AND_DROP chain is used for logging dropped connections.
</p>
<p>The above rules can be used to protect any service, though the SSH daemon is probably the most often required one.
</p>
<p>In terms of order, one must ensure that <code>-A INPUT -p tcp --dport ssh -m conntrack --ctstate NEW -j IN_SSH</code> is at the right position in the iptables sequence: it should come before the TCP chain is attached to INPUT in order to catch new SSH connections first. If all the previous steps of this wiki have been completed, the following positioning works:
</p>
<pre>...
-A INPUT -m conntrack --ctstate INVALID -j DROP
-A INPUT -p icmp -m icmp --icmp-type 8 -m conntrack --ctstate NEW -j ACCEPT
<b>-A INPUT -p tcp --dport 22 -m conntrack --ctstate NEW -j IN_SSH</b>
-A INPUT -p udp -m conntrack --ctstate NEW -j UDP
-A INPUT -p tcp --tcp-flags FIN,SYN,RST,ACK SYN -m conntrack --ctstate NEW -j TCP
...
</pre>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> For self-testing the rules after setup, the actual blacklisting can slow the test, making it difficult to fine-tune parameters. One can watch the incoming attempts via <code>cat /proc/net/xt_recent/sshbf</code>. To unblock the own IP during testing, root is needed <code>echo / &gt; /proc/net/xt_recent/sshbf</code>
</div>
<h3><span class="mw-headline" id="IPv6">IPv6</span></h3>
<p>If you do not use IPv6, you can consider <a href="../en/IPv6.html#Disable_IPv6" class="mw-redirect" title="Disabling IPv6">disabling it</a>, otherwise follow these steps to enable the IPv6 firewall rules.
</p>
<p>Copy the IPv4 rules used in this example as a base, and change any IPs from IPv4 format to IPv6 format:
</p>
<pre># cp /etc/iptables/iptables.rules /etc/iptables/ip6tables.rules
</pre>
<p>A few of the rules in this example have to be adapted for use with IPv6. The ICMP protocol has been updated in IPv6, replacing the ICMP protocol for use with IPv4. Hence, the reject error return codes <code>--reject-with icmp-port-unreachable</code> and <code>--reject-with icmp-proto-unreachable</code> have to be converted to ICMPv6 codes. 
</p>
<p>The available ICMPv6 error codes are listed in <a href="https://tools.ietf.org/html/rfc4443#section-3.1" class="extiw" title="rfc:4443">RFC 4443</a>, which specifies that connection attempts blocked by a firewall rule should use <code>--reject-with icmp6-adm-prohibited</code>. Doing so will basically inform the remote system that the connection was rejected by a firewall, rather than a listening service. 
</p>
<p>If it is preferred not to explicitly inform about the existence of a firewall filter, the packet may also be rejected without the message: 
</p>
<pre> -A INPUT -j REJECT
</pre>
<p>The above will reject with the default return error of <code>--reject-with icmp6-port-unreachable</code>. You should note though, that identifying a firewall is a basic feature of port scanning applications and most will identify it regardless. 
</p>
<div class="noprint archwiki-template-message">
<p><span class="mw-default-size" typeof="mw:File"><span><img src="../File:Tango-view-fullscreen.svg" decoding="async" width="48" height="48" class="mw-file-element"></span></span><b>This article or section needs expansion.</b></p>
<div>
<b>Reason:</b> Which ICMPv6 peculiarities should be added to bring the rules at par with the IPv4 rules this article uses? (Discuss in <a href="../en/Talk:Simple_stateful_firewall.html#ICMP_blocking" title="Talk:Simple stateful firewall">Talk:Simple_stateful_firewall#ICMP blocking</a>)</div>
</div>
<p>In the next step make sure the protocol and extension are changed to be IPv6 appropriate for the rule regarding all new incoming ICMP echo requests (pings):
</p>
<pre># ip6tables -A INPUT -p ipv6-icmp --icmpv6-type 128 -m conntrack --ctstate NEW -j ACCEPT
</pre>
<p>Netfilter conntrack does not appear to track ICMPv6 Neighbor Discovery Protocol (the IPv6 equivalent of ARP), so we need to allow ICMPv6 traffic regardless of state for all directly attached subnets. The following should be inserted after dropping <code>--ctstate INVALID</code>, but before any other DROP or REJECT targets, along with a corresponding line for each directly attached subnet:
</p>
<pre># ip6tables -A INPUT -s fe80::/10 -p ipv6-icmp -j ACCEPT
</pre>
<p>If you want to enable <a href="https://en.wikipedia.org/wiki/DHCPv6" class="extiw" title="wikipedia:DHCPv6">DHCPv6</a>, you need to accept incoming connections on <a rel="nofollow" class="external text" href="https://unix.stackexchange.com/a/452905">UDP port 546</a>:
</p>
<pre># ip6tables -A INPUT -p udp --sport 547 --dport 546 -j ACCEPT
</pre>
<p>Since there is no kernel reverse path filter for IPv6, you may want to enable one in <i>ip6tables</i> with the following:
</p>
<pre># ip6tables -t mangle -A PREROUTING -m rpfilter -j ACCEPT
# ip6tables -t mangle -A PREROUTING -j DROP
</pre>
<h3><span class="mw-headline" id="Saving_the_rules">Saving the rules</span></h3>
<p>The rule sets are now finished and should be saved to a file so that they can be loaded on every boot.
</p>
<p>Save the IPv4 and IPv6 rules with these commands:
</p>
<pre># iptables-save -f /etc/iptables/iptables.rules
# ip6tables-save -f /etc/iptables/ip6tables.rules
</pre>
<h3><span class="mw-headline" id="Resulting_ip6tables.rules_file">Resulting ip6tables.rules file</span></h3>
<p>Example of <code>ip6tables.rules</code> file after running all the commands from above:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/iptables/ip6tables.rules</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;"># Generated by ip6tables-save v1.8.2 on Sat Apr 20 10:53:41 2019
*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [0:0]
:TCP - [0:0]
:UDP - [0:0]
-A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -m conntrack --ctstate INVALID -j DROP
-A INPUT -s fe80::/10 -p ipv6-icmp -j ACCEPT
-A INPUT -p udp --sport 547 --dport 546 -j ACCEPT
-A INPUT -p udp -m conntrack --ctstate NEW -j UDP
-A INPUT -p tcp -m tcp --tcp-flags FIN,SYN,RST,ACK SYN -m conntrack --ctstate NEW -j TCP
-A INPUT -p udp -j REJECT --reject-with icmp6-adm-prohibited
-A INPUT -p tcp -j REJECT --reject-with tcp-reset
-A INPUT -j REJECT --reject-with icmp6-adm-prohibited
-A INPUT -p ipv6-icmp -m icmp6 --icmpv6-type 128 -m conntrack --ctstate NEW -j ACCEPT
COMMIT
# Completed on Sat Apr 20 10:53:41 2019
</pre>
<p>Then <a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Enable">enable</a> and <a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Start">start</a> <code>iptables.service</code> and the <code>ip6tables.service</code>. Check the status of the services to make sure the rules are loaded correctly.
</p>
<h2><span class="mw-headline" id="Setting_up_a_NAT_gateway">Setting up a NAT gateway</span></h2>
<p>This section of the guide deals with NAT gateways. It is assumed that you already read the <a href="#Firewall_for_a_single_machine">first part of the guide</a> and set up the <b>INPUT</b>, <b>OUTPUT</b>, <b>TCP</b> and <b>UDP</b> chains like described above. All rules so far have been created in the <b>filter</b> table. In this section, we will also have to use the <b>nat</b> table. There is an ASCII art of the situation at <a rel="nofollow" class="external text" href="https://www.netfilter.org/documentation/HOWTO/NAT-HOWTO-5.html">Controlling What To NAT</a>.
</p>
<h3><span class="mw-headline" id="Setting_up_the_filter_table">Setting up the filter table</span></h3>
<h4><span class="mw-headline" id="Creating_necessary_chains_2">Creating necessary chains</span></h4>
<p>In our setup, we will create two new chains in the filter table, <b>fw-interfaces</b> and <b>fw-open</b>, using the following commands:
</p>
<pre># iptables -N fw-interfaces
# iptables -N fw-open
</pre>
<h4><span class="mw-headline" id="Setting_up_the_FORWARD_chain">Setting up the FORWARD chain</span></h4>
<p>Setting up the <b>FORWARD</b> chain is similar to the <b>INPUT</b> chain in the first section.
</p>
<p>Now we set up a rule with the <b>conntrack</b> match, identical to the one in the <b>INPUT</b> chain:
</p>
<pre># iptables -A FORWARD -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
</pre>
<p>The next step is to enable forwarding for trusted interfaces and to make all packets pass the <b>fw-open</b> chain.
</p>
<pre># iptables -A FORWARD -j fw-interfaces 
# iptables -A FORWARD -j fw-open 
</pre>
<p>The remaining packets are denied with an <b>ICMP</b> message:
</p>
<pre># iptables -A FORWARD -j REJECT --reject-with icmp-host-unreachable
# iptables -P FORWARD DROP
</pre>
<h4><span class="mw-headline" id="Setting_up_the_fw-interfaces_and_fw-open_chains">Setting up the fw-interfaces and fw-open chains</span></h4>
<p>The meaning of the <b>fw-interfaces</b> and <b>fw-open</b> chains is explained later, when we deal with the <b>POSTROUTING</b> and <b>PREROUTING</b> chains in the <b>nat</b> table, respectively.
</p>
<h3><span class="mw-headline" id="Setting_up_the_nat_table">Setting up the nat table</span></h3>
<p>All over this section, we assume that the outgoing interface (the one with the public internet IP) is <b>ppp0</b>. Keep in mind that you have to change the name in all following rules if your outgoing interface has another name.
</p>
<h4><span class="mw-headline" id="Setting_up_the_POSTROUTING_chain">Setting up the POSTROUTING chain</span></h4>
<p>Now, we have to define who is allowed to connect to the internet. Let us assume we have the subnet <b>192.168.0.0/24</b> (which means all addresses that are of the form 192.168.0.*) on <b>eth0</b>. We first need to accept the machines on this interface in the FORWARD table, that is why we created the <b>fw-interfaces</b> chain above:
</p>
<pre># iptables -A fw-interfaces -i eth0 -j ACCEPT
</pre>
<p>Now, we have to alter all outgoing packets so that they have our public IP address as the source address, instead of the local LAN address. To do this, we use the <b>MASQUERADE</b> target:
</p>
<pre># iptables -t nat -A POSTROUTING -s 192.168.0.0/24 -o ppp0 -j MASQUERADE
</pre>
<p>Do not forget the <b>-o ppp0</b> parameter above. If you omit it, your network will be screwed up.
</p>
<p>Let us assume we have another subnet, <b>10.3.0.0/16</b> (which means all addresses 10.3.*.*), on the interface <b>eth1</b>. We add the same rules as above again:
</p>
<pre># iptables -A fw-interfaces -i eth1 -j ACCEPT
# iptables -t nat -A POSTROUTING -s 10.3.0.0/16 -o ppp0 -j MASQUERADE
</pre>
<p>The last step is to <a href="../en/Internet_sharing.html#Enable_packet_forwarding" title="Internet sharing">enable packet forwarding</a> (if it is not already enabled).
</p>
<p>Machines from these subnets can now use your new NAT machine as their gateway. Note that you may want to set up a DNS and <a href="../en/Network_configuration.html#Network_managers" class="mw-redirect" title="DHCP">DHCP</a> server like <a href="../en/Dnsmasq.html" title="Dnsmasq">dnsmasq</a> or a combination of <a href="../en/BIND.html" title="BIND">BIND</a> and <a href="../en/Dhcpd.html" title="Dhcpd">dhcpd</a> to simplify network settings DNS resolution on the client machines. This is not the topic of this guide.
</p>
<h4><span class="mw-headline" id="Setting_up_the_PREROUTING_chain">Setting up the PREROUTING chain</span></h4>
<p>Sometimes, we want to change the address of an incoming packet from the gateway to a LAN machine. To do this, we use the <b>fw-open</b> chain defined above, as well as the <b>PREROUTING</b> chain in the <b>nat</b> table in the following two simple examples. 
</p>
<p>First, we want to change all incoming SSH packets (port 22) to the ssh server of the machine <b>192.168.0.5</b>:
</p>
<pre># iptables -t nat -A PREROUTING -i ppp0 -p tcp --dport 22 -j DNAT --to 192.168.0.5
# iptables -A fw-open -d 192.168.0.5 -p tcp --dport 22 -j ACCEPT
</pre>
<p>The second example will show you how to change packets to a different port than the incoming port. We want to change any incoming connection on port <b>8000</b> to our web server on <b>192.168.0.6</b>, port <b>80</b>:
</p>
<pre># iptables -t nat -A PREROUTING -i ppp0 -p tcp --dport 8000 -j DNAT --to 192.168.0.6:80
# iptables -A fw-open -d 192.168.0.6 -p tcp --dport 80 -j ACCEPT
</pre>
<p>The same setup also works with udp packets.
</p>
<h3><span class="mw-headline" id="Saving_the_rules_2">Saving the rules</span></h3>
<p>Save the rules:
</p>
<pre># iptables-save -f /etc/iptables/iptables.rules
</pre>
<p>This assumes that you have followed the steps <a href="#Saving_the_rules">above</a> to enable the <b>iptables</b> systemd service.
</p>
<h2><span class="mw-headline" id="See_Also">See Also</span></h2>
<ul>
<li><a rel="nofollow" class="external text" href="https://www.webhostingtalk.com/showthread.php?t=456571">Methods to block SSH attacks</a></li>
<li><a rel="nofollow" class="external text" href="https://www.ducea.com/2006/06/28/using-iptables-to-block-brute-force-attacks/">Using iptables to block brute force attacks</a></li>
<li><a rel="nofollow" class="external text" href="https://linuxconfig.org/collection-of-basic-linux-firewall-iptables-rules">18 examples of basic iptables rules</a></li>
<li><a rel="nofollow" class="external text" href="https://www.thegeekstuff.com/2011/06/iptables-rules-examples/">25 Most Frequently Used Linux IPTables Rules Examples</a></li>
</ul>
</div>
</div>
					<div id="catlinks" class="catlinks" data-mw="interface">
<div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../Special:Categories.html" title="Special:Categories">Category</a>: <ul><li><a href="../en/Category:Firewalls.html" title="Category:Firewalls">Firewalls</a></li></ul>
</div>
<div id="mw-hidden-catlinks" class="mw-hidden-catlinks mw-hidden-cats-hidden">Hidden category: <ul><li><a href="../en/Category:Pages_or_sections_flagged_with_Template:Expansion.html" title="Category:Pages or sections flagged with Template:Expansion">Pages or sections flagged with Template:Expansion</a></li></ul>
</div>
</div>
				</div>
			</main>
			
		</div>
		<div class="mw-footer-container">
			
<footer id="footer" class="mw-footer" role="contentinfo" style="margin: 0">
	<ul id="footer-info">
	<li data-nosnippet="">Retrieved from "<a dir="ltr" href="https://wiki.archlinux.org/index.php?title=Simple_stateful_firewall&amp;oldid=775199">https://wiki.archlinux.org/index.php?title=Simple_stateful_firewall&amp;oldid=775199</a>"</li>
<li id="footer-info-lastmod"> This page was last edited on 9 April 2023, at 18:20.</li>
	<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="https://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.3 or later</a> unless otherwise noted.</li>
<br>
</ul>

	<ul id="footer-places">
	<li id="footer-places-privacy"><a href="https://terms.archlinux.org/docs/privacy-policy/">Privacy policy</a></li>
	<li id="footer-places-about"><a href="../en/ArchWiki:About.html">About ArchWiki</a></li>
	<li id="footer-places-disclaimers"><a href="../en/ArchWiki:General_disclaimer.html">Disclaimers</a></li>
	<li id="footer-places-archwiki-code-of-conduct"><a href="https://terms.archlinux.org/docs/code-of-conduct/" class="extiw" title="archlinux-service-agreements:code-of-conduct">Code of conduct</a></li>
	<li id="footer-places-archwiki-terms-of-service"><a href="https://terms.archlinux.org/docs/terms-of-service/" class="extiw" title="archlinux-service-agreements:terms-of-service">Terms of service</a></li>
</ul>

	<ul id="footer-icons" class="noprint">
	<li id="footer-copyrightico"><a href="https://www.gnu.org/copyleft/fdl.html"><img src="/resources/assets/licenses/gnu-fdl.png" alt="GNU Free Documentation License 1.3 or later" width="88" height="31" loading="lazy"></a></li>
	<li id="footer-poweredbyico"><img src="/resources/assets/poweredby_mediawiki_88x31.png" srcset="/resources/assets/poweredby_mediawiki_132x47.png 1.5x, /resources/assets/poweredby_mediawiki_176x62.png 2x" width="88" height="31" loading="lazy"></li>
</ul>

</footer>

		</div>
	</div> 
</div> 
<div class="vector-settings" id="p-dock-bottom">
	<ul>
		<li>
		<button class="cdx-button cdx-button--icon-only vector-limited-width-toggle" id=""><span class="vector-icon mw-ui-icon-fullScreen mw-ui-icon-wikimedia-fullScreen"></span>

<span>Toggle limited content width</span>
</button>
</li>
	</ul>
</div>
</body>
</html>
