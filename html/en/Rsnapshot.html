<!DOCTYPE html>
<html class="client-nojs vector-feature-language-in-header-enabled vector-feature-language-in-main-page-header-disabled vector-feature-sticky-header-disabled vector-feature-page-tools-pinned-disabled vector-feature-toc-pinned-clientpref-1 vector-feature-main-menu-pinned-disabled vector-feature-limited-width-clientpref-1 vector-feature-limited-width-content-enabled vector-feature-custom-font-size-clientpref-0 vector-feature-client-preferences-disabled vector-feature-client-prefs-pinned-disabled vector-feature-night-mode-disabled skin-theme-clientpref-day vector-toc-available" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>rsnapshot - ArchWiki</title>
<link rel="stylesheet" href="../ArchWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<meta name="generator" content="MediaWiki 1.42.1">
<meta name="referrer" content="no-referrer-when-downgrade">
<meta name="robots" content="max-image-preview:standard">
<meta name="format-detection" content="telephone=no">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=0.25, maximum-scale=5.0">
<link rel="icon" href="/favicon.ico">
<link rel="search" type="application/opensearchdescription+xml" href="/opensearch_desc.php" title="ArchWiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.archlinux.org/api.php?action=rsd">
<link rel="license" href="https://www.gnu.org/copyleft/fdl.html">
<link rel="alternate" type="application/atom+xml" title="ArchWiki Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="skin-vector skin-vector-search-vue mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-Rsnapshot rootpage-Rsnapshot skin-vector-2022 action-view skin--responsive">
<a class="mw-jump-link" href="#bodyContent">Jump to content</a>
<div class="vector-header-container">
	</div>
<div class="mw-page-container">
	<div class="mw-page-container-inner">
		<div class="vector-column-start">
			<div class="vector-main-menu-container">
		</div>
	<div class="vector-sticky-pinned-container">
				<nav id="mw-panel-toc" role="navigation" aria-label="Contents" data-event-name="ui.sidebar-toc" class="mw-table-of-contents-container vector-toc-landmark">
					<div id="vector-toc-pinned-container" class="vector-pinned-container">
					<div id="vector-toc" class="vector-toc vector-pinnable-element">
	<div class="vector-pinnable-header vector-toc-pinnable-header vector-pinnable-header-pinned" data-feature-name="toc-pinned" data-pinnable-element-id="vector-toc">
	<h2 class="vector-pinnable-header-label">Contents</h2>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-pin-button" data-event-name="pinnable-header.vector-toc.pin">move to sidebar</button>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-unpin-button" data-event-name="pinnable-header.vector-toc.unpin">hide</button>
</div>


	<ul class="vector-toc-contents" id="mw-panel-toc-list">
		<li id="toc-mw-content-text" class="vector-toc-list-item vector-toc-level-1">
			<a href="#" class="vector-toc-link">
				<div class="vector-toc-text">Beginning</div>
			</a>
		</li>
		<li id="toc-Installation" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#Installation">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">1</span>Installation</div>
		</a>
		
		<ul id="toc-Installation-sublist" class="vector-toc-list">
		</ul>
	</li>
	<li id="toc-Configuration" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#Configuration">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">2</span>Configuration</div>
		</a>
		
			<button aria-controls="toc-Configuration-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Configuration subsection</span>
			</button>
		
		<ul id="toc-Configuration-sublist" class="vector-toc-list">
			<li id="toc-Root_Directory" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Root_Directory">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.1</span>Root Directory</div>
			</a>
			
			<ul id="toc-Root_Directory-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-External_program_dependencies" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#External_program_dependencies">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.2</span>External program dependencies</div>
			</a>
			
			<ul id="toc-External_program_dependencies-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Retain_Previous_Backups" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Retain_Previous_Backups">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.3</span>Retain Previous Backups</div>
			</a>
			
			<ul id="toc-Retain_Previous_Backups-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Back_up" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Back_up">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.4</span>Back up</div>
			</a>
			
			<ul id="toc-Back_up-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Remote_Systems" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Remote_Systems">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.5</span>Remote Systems</div>
			</a>
			
			<ul id="toc-Remote_Systems-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Extra_Scripts" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Extra_Scripts">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.6</span>Extra Scripts</div>
			</a>
			
			<ul id="toc-Extra_Scripts-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Testing_the_configuration" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Testing_the_configuration">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">2.7</span>Testing the configuration</div>
			</a>
			
			<ul id="toc-Testing_the_configuration-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Automation" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#Automation">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">3</span>Automation</div>
		</a>
		
			<button aria-controls="toc-Automation-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Automation subsection</span>
			</button>
		
		<ul id="toc-Automation-sublist" class="vector-toc-list">
			<li id="toc-External_Drives" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#External_Drives">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">3.1</span>External Drives</div>
			</a>
			
			<ul id="toc-External_Drives-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-How_it_works" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#How_it_works">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">4</span>How it works</div>
		</a>
		
		<ul id="toc-How_it_works-sublist" class="vector-toc-list">
		</ul>
	</li>
</ul>
</div>

					</div>
		</nav>
			</div>
		</div>
		<div class="mw-content-container">
			<main id="content" class="mw-body" role="main" style="margin: 0">
				<header class="mw-body-header vector-page-titlebar">
					<nav role="navigation" aria-label="Contents" class="vector-toc-landmark">
						
<div id="vector-page-titlebar-toc" class="vector-dropdown vector-page-titlebar-toc vector-button-flush-left">
	<input type="checkbox" id="vector-page-titlebar-toc-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-vector-page-titlebar-toc" class="vector-dropdown-checkbox " aria-label="Toggle the table of contents">
	<label id="vector-page-titlebar-toc-label" for="vector-page-titlebar-toc-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--icon-only " aria-hidden="true"><span class="vector-icon mw-ui-icon-listBullet mw-ui-icon-wikimedia-listBullet"></span>

<span class="vector-dropdown-label-text">Toggle the table of contents</span>
	</label>
	<div class="vector-dropdown-content">


							<div id="vector-page-titlebar-toc-unpinned-container" class="vector-unpinned-container">
			</div>
		
	</div>
</div>

					</nav>
					<h1 id="firstHeading" class="firstHeading mw-first-heading">rsnapshot</h1>
							
<div id="p-lang-btn" class="vector-dropdown mw-portlet mw-portlet-lang">
	<input type="checkbox" id="p-lang-btn-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-p-lang-btn" class="vector-dropdown-checkbox mw-interlanguage-selector" aria-label="Go to an article in another language. Available in 2 languages">
	<label id="p-lang-btn-label" for="p-lang-btn-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--action-progressive mw-portlet-lang-heading-2" aria-hidden="true"><span class="vector-icon mw-ui-icon-language-progressive mw-ui-icon-wikimedia-language-progressive"></span>

<span class="vector-dropdown-label-text">2 languages</span>
	</label>
	<div class="vector-dropdown-content">

		<div class="vector-menu-content">
			
			<ul class="vector-menu-content-list">
				
				<li class="interlanguage-link interwiki-de mw-list-item"><a href="https://wiki.archlinux.de/title/Rsnapshot" title="Rsnapshot – Deutsch" lang="de" hreflang="de" class="interlanguage-link-target"><span>Deutsch</span></a></li>
<li class="interlanguage-link interwiki-ja mw-list-item"><a href="https://wiki.archlinux.jp/index.php/Rsnapshot" title="Rsnapshot – 日本語" lang="ja" hreflang="ja" class="interlanguage-link-target"><span>日本語</span></a></li>
			</ul>
			
		</div>

	</div>
</div>
</header>
				<div class="vector-column-end">
					<div class="vector-sticky-pinned-container">
						<nav class="vector-page-tools-landmark" aria-label="Page tools">
							<div id="vector-page-tools-pinned-container" class="vector-pinned-container">
				
							</div>
		</nav>
						<nav class="vector-client-prefs-landmark" aria-label="Appearance">
						</nav>
					</div>
				</div>
				<div id="bodyContent" class="vector-body" aria-labelledby="firstHeading" data-mw-ve-target-container>
					<div class="vector-body-before-content">
							<div class="mw-indicators">
		</div>

						<div id="siteSub" class="noprint">From ArchWiki</div>
					</div>
					<div id="contentSub"><div id="mw-content-subtitle"></div></div>
					
					
					<div id="mw-content-text" class="mw-body-content">
<div class="mw-content-ltr mw-parser-output" lang="en" dir="ltr">
<p><span>
</span>
<a rel="nofollow" class="external text" href="https://www.rsnapshot.org/">Rsnapshot</a> is an open source utility that provides incremental back ups.
</p>
<meta property="mw:PageProp/toc">
<h2><span class="mw-headline" id="Installation">Installation</span></h2>
<p><a href="../en/Help:Reading.html#Installation_of_packages" class="mw-redirect" title="Install">Install</a> the <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=rsnapshot">rsnapshot</a></span> package.
</p>
<h2><span class="mw-headline" id="Configuration">Configuration</span></h2>
<p>In the install process, the configuration file is created. It is recommended you make a back up of this file in case you need to reconfigure the file again.
</p>
<pre># cp /etc/rsnapshot.conf /etc/rsnapshot.conf.default
</pre>
<p>The <code>/etc/rsnapshot.conf</code> file is well commented and much of it should be fairly self-explanatory. For a full reference of all the various options, please consult <span class="plainlinks archwiki-template-man" title="$ man 1 rsnapshot"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/rsnapshot.1">rsnapshot(1)</a></span>.
</p>
<h3><span class="mw-headline" id="Root_Directory">Root Directory</span></h3>
<p>Choose the directory where you want to store the file system back ups, in this case I will store the back ups in <code>/mnt/backups/</code>
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/rsnapshot.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;"># All snapshots will be stored under this root directory.
#
snapshot_root   /mnt/backups/
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> Fields are separated by tabs, not spaces. The reason for this is so it is easier to specify file paths with spaces in them.</div>
<h3><span class="mw-headline" id="External_program_dependencies">External program dependencies</span></h3>
<p>Uncomment the lines referring to the UNIX commands <code>cp</code>, <code>du</code>, <code>ssh</code> (if you want to do remote back ups) and <code>rsnapshot-diff</code>, etc. This section of the file should look like this:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/rsnapshot.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;"># LINUX USERS:   Be sure to uncomment "cmd_cp". This gives you extra features.
# EVERYONE ELSE: Leave "cmd_cp" commented out for compatibility.
#
# See the README file or the man page for more details.
#
cmd_cp          /usr/bin/cp

# uncomment this to use the rm program instead of the built-in perl routine.
#
cmd_rm          /usr/bin/rm

# rsync must be enabled for anything to work. This is the only command that
# must be enabled.
#
cmd_rsync       /usr/bin/rsync

# Uncomment this to enable remote ssh backups over rsync.
#
cmd_ssh /usr/bin/ssh

# Comment this out to disable syslog support.
#
cmd_logger      /usr/bin/logger

# Uncomment this to specify the path to "du" for disk usage checks.
# If you have an older version of "du", you may also want to check the
# "du_args" parameter below.
#
cmd_du          /usr/bin/du

# Uncomment this to specify the path to rsnapshot-diff.
#
cmd_rsnapshot_diff      /usr/bin/rsnapshot-diff

# Specify the path to a script (and any optional arguments) to run right
# before rsnapshot syncs files
#
#cmd_preexec    /path/to/preexec/script

# Specify the path to a script (and any optional arguments) to run right
# after rsnapshot syncs files
#
#cmd_postexec   /path/to/postexec/script
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> cmd_preexec and cmd_postexec are custom scripts to be run before and after each run of rsnapshot</div>
<h3><span class="mw-headline" id="Retain_Previous_Backups">Retain Previous Backups</span></h3>
<p>Rsnapshot allows named backup levels that retain a given number of previous backups.
</p>
<p>When configuring these, note that the first in the list will be the only one that actually backs up files from the file system AND rotates its own previous backups. The rest will ONLY rotate previous backups, creating its newest backup from the oldest backup created by the previous item on the list. So, the order these are listed in the configuration file are very important.
</p>
<p>Replace the default "BACKUP LEVELS / INTERVALS" section in the rsnapshot configuration file:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/rsnapshot.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">retain  hourly  24
retain  daily   7
retain  weekly  4
retain  monthly 12
</pre>
<ul><li>When <code>rsnapshot hourly</code> is called, a new backup will be created from the file system, and saved in <b>&lt;snapshot_root&gt;/hourly.0/</b>. The rest of the retained backups will continue to get incremented each time the command is run. So eventually, what was <b>&lt;snapshot_root&gt;/hourly.0</b>, will become <b>&lt;snapshot_root&gt;/hourly.23/</b>. Then the next time the command is run, this will be deleted.</li></ul>
<ul><li>When <code>rsnapshot daily</code> is called, it will create <b>&lt;snapshot_root&gt;/daily.0/</b> from the <b>&lt;snapshot_root&gt;/hourly.23/</b> backup if it exists. Otherwise, rotation works the same way.</li></ul>
<ul><li>Likewise, when <code>rsnapshot weekly</code> is called, it will create <b>&lt;snapshot_root&gt;/weekly.0/</b> from the <b>&lt;snapshot_root&gt;/daily.6/</b> backup if it exists. The pattern follows the same for each additional retain level that is configured.</li></ul>
<p>Using the above config, you could call:
</p>
<p><code>rsnapshot hourly</code> every hour  
</p>
<p><code>rsnapshot daily</code> every day  
</p>
<p><code>rsnapshot weekly</code> every week  
</p>
<p><code>rsnapshot monthly</code> every month  
</p>
<p>This would give you a robust 12 months of backups while minimizing the space taken up by older snapshots.
</p>
<p>If you just wanted to run this same config, but only backup daily, you would need to comment out the hourly backup level. Otherwise calling <code>rsnapshot daily</code> would never actually backup any files since it is not the first on the list.
</p>
<h3><span class="mw-headline" id="Back_up">Back up</span></h3>
<p>This is the section where you tell <i>rsnapshot</i> which files you actually want to back up. You put a <code>backup</code> parameter first, followed by the full path to the directory or network path you are backing up. The third column is the relative path you want to back up to inside the snapshot root.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/rsnapshot.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">###############################
### BACKUP POINTS / SCRIPTS ###
###############################

# LOCALHOST
backup  /home/          localhost/
</pre>
<p>In this example, backup tells us it is a backup point. <code>/home/</code> is the full path to the directory we want to take snapshots of, and <code>localhost/</code> is a directory <b>inside</b> the <code>snapshot_root</code> we are going to put them in. Using the word localhost as the destination directory is just a convention. You might also choose to use the server's fully qualified domain name instead of localhost. If you are taking snapshots of several machines on one dedicated backup server, it is a good idea to use their various hostnames as directories to keep track of which files came from which server.
</p>
<h3><span class="mw-headline" id="Remote_Systems">Remote Systems</span></h3>
<p>In addition to full paths on the local filesystem, you can also backup remote systems using <a href="../en/Rsync.html" title="Rsync">rsync</a> over <a href="../en/Secure_Shell.html" class="mw-redirect" title="Ssh">ssh</a>. If you have <i>ssh</i> installed and enabled - via the <code>cmd_ssh</code> parameter - you can specify a path like:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/rsnapshot.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">###############################
### BACKUP POINTS / SCRIPTS ###
###############################

# example.com
backup      root@example.com:/etc/     example.com/
</pre>
<p>This behaves fundamentally the same way, but you must take a few extra things into account:
</p>
<ul><li>The ssh daemon must be running on example.com</li></ul>
<ul><li>You must have access to the account you specify the remote machine, in this case the root user on example.com.</li></ul>
<ul><li>You must have key-based logins enabled for the root user at example.com, without passphrases. If you wanted to perform backups as another user, you could specify the other user instead of root for the source (i.e. user@domain.com). Please note that allowing remote logins with no passphrase is a security risk that may or may not be acceptable in your situation. Make sure you guard access to the backup server very carefully! For more information on how to set this up, please consult the ssh man page, or a tutorial on using ssh public and private keys. You will find that the key based logins are better in many ways, not just for rsnapshot but for convenience and security in general. One thing you can do to mitigate the potential damage from a backup server breach is to create alternate users on the client machines with uid and gid set to 0, but with a more restrictive shell such as scponly.</li></ul>
<ul><li>This backup occurs over the network, so it may be slower. Since this uses <i>rsync</i>, this is most noticeable during the first backup. Depending on how much your data changes, subsequent backups should go much, much faster since <i>rsync</i> only sends the differences between files.</li></ul>
<h3><span class="mw-headline" id="Extra_Scripts">Extra Scripts</span></h3>
<p>There is an extra <code>backup_script</code> line. With this parameter, the second column is the full path to an executable backup script, and the third column is the local path you want to store it in (just like with the <code>backup</code> parameter). For example:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/rsnapshot.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">backup_script      /usr/local/bin/backup_mysql.sh       localhost/mysql/
</pre>
<p>In this example, <i>rsnapshot</i> will run the script <code>/usr/local/bin/backup_mysql.sh</code> in a temp directory, then sync the results into the <code>localhost/mysql/</code> directory under the snapshot root.
</p>
<p>Your backup script simply needs to dump out the contents of whatever it does into its current working directory. It can create as many files and/or directories as necessary, but it should not put its files in any pre-determined path. The reason for this is that <i>rsnapshot</i> creates a temp directory, changes to that directory, runs the backup script, and then syncs the contents of the temp directory to the local path you specified in the third column. A typical backup script would be one that archives the contents of a database. It might look like this:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">backup_mysql.sh</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">#!/bin/sh

/usr/bin/mysqldump -uroot mydatabase &gt; mydatabase.sql
/bin/chmod 644 mydatabase.sql
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> 
<ul>
<li>Make sure the destination path you specify is unique. The backup script will completely overwrite anything in the destination path, so if you tried to specify the same destination twice, you would be left with only the files from the last script. Fortunately, rsnapshot will try to prevent you from doing this when it reads the configuration file.</li>
<li>Please remember that these backup scripts will be invoked as the user running rsnapshot. In our example, this is root. Make sure your backup scripts are owned by root, and not writable by anyone else. If you fail to do this, anyone with write access to these backup scripts will be able to put commands in them that will be run as the root user. If they are malicious, they could take over your server.</li>
</ul>
</div>
<h3><span class="mw-headline" id="Testing_the_configuration">Testing the configuration</span></h3>
<p>When you have made all your changes, you should verify that the configuration file is syntactically valid, and that all the supporting programs are where you think they are. To do this, run <i>rsnapshot</i> with the <b>configtest</b> argument:
</p>
<pre># rsnapshot configtest
</pre>
<p>If all is well, it should say Syntax OK. If there is a problem, it should tell you exactly what it is. Make sure your configuration file is using tabs and not spaces, etc.
</p>
<p>The final step to test your configuration is to run <i>rsnapshot</i> in test mode. This will print out a verbose list of the things it will do, without actually doing them. To do a test run, run this command:
</p>
<pre># rsnapshot -t hourly
</pre>
<p>This tells <i>rsnapshot</i> to simulate an "hourly" backup. It should print out the commands it will perform when it runs for real.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> Please note that the test output might be slightly different than the real execution, but only because the test does not actually do things that may be checked for later in the program. For example, if the program will create a directory and then later test to see if that directory exists, the test run might claim that it would create the directory twice, since it did not actually get created during the test. This should be the only type of difference you will see while running a test.</div>
<h2><span class="mw-headline" id="Automation">Automation</span></h2>
<p>Now that you have your configuration file set up, it is time to set up <i>rsnapshot</i> to be run automatically.
</p>
<p>First create a service file:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/rsnapshot@.service</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Unit]
Description=rsnapshot (%I) backup

[Service]
Type=oneshot
Nice=19
IOSchedulingClass=idle
ExecStart=/usr/bin/rsnapshot %I</pre>
<p>Then create a timer unit for each interval you want the service to run (i.e. hourly, daily, weekly, montly):
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/rsnapshot-<i>interval</i>.timer</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Unit]
Description=rsnapshot hourly backup

[Timer]
<b>OnCalendar=</b>
Persistent=true
Unit=rsnapshot@<i>interval</i>.service

[Install]
WantedBy=timers.target</pre>
<p>You can verify your <code>OnCalendar</code> entries are valid and do what you expect (especially if you want to change the above) with: 
</p>
<pre># systemd-analyze calendar "Mon *-*-* 04:30:00"
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> It is usually a good idea to schedule the larger intervals to run a bit before the lower ones. This helps prevent race conditions where the daily would try to run before the hourly job had finished. This same strategy should be extended so that a weekly entry would run before the daily and so on. </div>
<p>Then finally, <a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Enable/start">enable/start</a> them and verify that the resulting <a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Unit status">unit status</a> looks good, and that the timers are scheduled as expected:
</p>
<pre># systemctl list-timers rsnapshot*
</pre>
<p>Now you can wait for the first timer to trigger, or if you want to start one immediately you can do it <a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Start">manually</a>.
</p>
<h3><span class="mw-headline" id="External_Drives">External Drives</span></h3>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> This section assumes that you have already completed the configuration described in the <a href="#Automation">#Automation</a> section above.</div>
<p>If the destination drive is in an external enclosure connected via USB or <a href="https://en.wikipedia.org/wiki/ESATAp" class="extiw" title="wikipedia:ESATAp">eSATA</a>, it may not have mounted during boot or may otherwise be unmounted at the time <i>rsnapshot</i> is scheduled to begin. If <i>rsnapshot</i> is configured to write to a path that always exists, e.g. <code>/.snapshots</code>, the data will be backed up on whichever hard drive is mounted as the root directory rather than the desired external drive.
</p>
<p>To remedy this situation one must configure <i>rsnapshot</i> to depend upon the disk being mounted to the expected mount point. There are two actions required: alter <code>/etc/fstab</code> and <code>/etc/systemd/system/rsnapshot@.service</code>.
</p>
<p><i>Systemd</i> will read the <code>/etc/fstab</code> file and create unit files for all of the mount points therein. For this setup we need to add one, optionally two, configuration options to the mount point. At the end of the options column for the desired mount point add <code>x-systemd.automount</code> and, if you want the mount point to unmount after inactivity, <code>x-systemd.idle-timeout=10m</code>. The value <i>10m</i> can be changed to any value you wish. See <span class="plainlinks archwiki-template-man" title="$ man 5 systemd.automount"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/systemd.automount.5">systemd.automount(5)</a></span> and <span class="plainlinks archwiki-template-man" title="$ man 5 systemd.mount"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/systemd.mount.5">systemd.mount(5)</a></span> for additional details about the options available.
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> The UUID of a partition can be found by running <code>blkid</code> as root.</div>
<p>An example mount point:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/fstab</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;"># /dev/sdd1
UUID=2848e78d-b05a-4477-a5f0-38f35411c269 /mnt/backups ext4 noauto,nofail,noexec,nouser,nosuid,rw,async,x-systemd.device-timeout=200ms,x-systemd.automount,x-systemd.idle-timeout=10m 0 2</pre>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> See <span class="plainlinks archwiki-template-man" title="$ man 5 fstab"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/fstab.5">fstab(5)</a></span> and <span class="plainlinks archwiki-template-man" title="$ man 8 mount"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/mount.8#FILESYSTEM-INDEPENDENT_MOUNT_OPTIONS">mount(8) § FILESYSTEM-INDEPENDENT MOUNT OPTIONS</a></span> for details about the available options.</div>
<p>After changing <code>/etc/fstab</code>, run a <a href="../en/Help:Reading.html#Control_of_systemd_units" class="mw-redirect" title="Daemon-reload">daemon-reload</a> so <i>systemd</i> picks up the changes made. Check that the mount and automount units look correct:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># systemctl show mnt-backups.mount</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">Where=/.snapshots
What=/dev/sdd1
Options=rw,nosuid,noexec,relatime,x-systemd.automount
Type=ext4
TimeoutUSec=1h
...</pre>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># systemctl show mnt-backups.automount</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">Where=/mnt/backups
DirectoryMode=0755
...</pre>
<p>Finally, <a href="../en/Systemd.html#Editing_provided_units" class="mw-redirect" title="Edit">edit</a> <code>/etc/systemd/system/rsnapshot@.service</code> and add the following line in the "[Unit]" section:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/rsnapshot@.service</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Unit]
Requires=mnt-backups.mount
After=mnt-backups.mount</pre>
<p>To ensure everything is configured properly check that the rsnapshot service units now require the mount point:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># systemctl show rsnapshot@daily.service | grep 'Requires='</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">Requires=sysinit.target system-rsnapshot.slice mnt-backups.mount</pre>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> Run <code>journalctl -u mnt-backups.mount</code> as root to verify that the automatic mounting and unmounting is taking place as expected.</div>
<h2><span class="mw-headline" id="How_it_works">How it works</span></h2>
<p>We have a snapshot root under which all backups are stored. In this example, this is the directory <code>/mnt/backups/</code>. Within this directory, other directories are created for the various intervals that have been defined. In the beginning it will be empty, but once <i>rsnapshot</i> has been running for a week, it should look something like this:
</p>
<pre>[root@localhost]# ls -l /mnt/backups/
drwxr-xr-x    7 root     root         4096 Dec 28 00:00 daily.0
drwxr-xr-x    7 root     root         4096 Dec 27 00:00 daily.1
drwxr-xr-x    7 root     root         4096 Dec 26 00:00 daily.2
drwxr-xr-x    7 root     root         4096 Dec 25 00:00 daily.3
drwxr-xr-x    7 root     root         4096 Dec 24 00:00 daily.4
drwxr-xr-x    7 root     root         4096 Dec 23 00:00 daily.5
drwxr-xr-x    7 root     root         4096 Dec 22 00:00 daily.6
drwxr-xr-x    7 root     root         4096 Dec 29 00:00 hourly.0
drwxr-xr-x    7 root     root         4096 Dec 28 20:00 hourly.1
drwxr-xr-x    7 root     root         4096 Dec 28 16:00 hourly.2
drwxr-xr-x    7 root     root         4096 Dec 28 12:00 hourly.3
drwxr-xr-x    7 root     root         4096 Dec 28 08:00 hourly.4
drwxr-xr-x    7 root     root         4096 Dec 28 04:00 hourly.5
</pre>
<p>Inside each of these directories is a full backup of that point in time. The destination directory paths you specified under the <code>backup</code> and <code>backup_script</code> parameters get stuck directly under these directories. In the example:
</p>
<pre>backup          /etc/           localhost/
</pre>
<p>The <code>/etc/</code> directory will initially get backed up into <code>/mnt/backups/hourly.0/localhost/etc/</code>
</p>
<p>Each subsequent time <i>rsnapshot</i> is run with the <i>hourly</i> command, it will rotate the <b>hourly.X</b> directories, and then copy the contents of the <b>hourly.0</b> directory (using hard links) into <b>hourly.1</b>.
</p>
<p>When <i>rsnapshot daily</i> is run, it will rotate all the <b>daily.X</b> directories, then copy the contents of <b>hourly.5</b> into <b>daily.0</b>.
</p>
<p><b>hourly.0</b> will always contain the most recent snapshot, and <b>daily.6</b> will always contain a snapshot from a week ago. Unless the files change between snapshots, the <i>full</i> backups are really just multiple hard links to the same files. Thus, if your <code>/etc/passwd</code> file does not change in a week, <code>hourly.0/localhost/etc/passwd</code> and <code>daily.6/localhost/etc/passwd</code> will literally be the same exact file. This is how <i>rsnapshot</i> can be so efficient on space. If the file changes at any point, the next backup will unlink the hard link in <b>hourly.0</b>, and replace it with a brand new file. This will now take double the disk space it did before, but it is still considerably less than it would be to have full unique copies of this file 13 times over.
</p>
<p>Remember that if you are using different intervals than the ones in this example, the first interval listed is the one that gets updates directly from the main filesystem. All subsequently listed intervals pull from the previous intervals. For example, if you had weekly, monthly, and yearly intervals defined (in that order), the weekly ones would get updated directly from the filesystem, the monthly ones would get updated from weekly, and the yearly ones would get updated from monthly.
</p>
</div>
</div>
					<div id="catlinks" class="catlinks" data-mw="interface"><div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../Special:Categories.html" title="Special:Categories">Category</a>: <ul><li><a href="../en/Category:Backup.html" title="Category:Backup">Backup</a></li></ul>
</div></div>
				</div>
			</main>
			
		</div>
		<div class="mw-footer-container">
			
<footer id="footer" class="mw-footer" role="contentinfo" style="margin: 0">
	<ul id="footer-info">
	<li data-nosnippet="">Retrieved from "<a dir="ltr" href="https://wiki.archlinux.org/index.php?title=Rsnapshot&amp;oldid=775156">https://wiki.archlinux.org/index.php?title=Rsnapshot&amp;oldid=775156</a>"</li>
<li id="footer-info-lastmod"> This page was last edited on 9 April 2023, at 15:46.</li>
	<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="https://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.3 or later</a> unless otherwise noted.</li>
<br>
</ul>

	<ul id="footer-places">
	<li id="footer-places-privacy"><a href="https://terms.archlinux.org/docs/privacy-policy/">Privacy policy</a></li>
	<li id="footer-places-about"><a href="../en/ArchWiki:About.html">About ArchWiki</a></li>
	<li id="footer-places-disclaimers"><a href="../en/ArchWiki:General_disclaimer.html">Disclaimers</a></li>
	<li id="footer-places-archwiki-code-of-conduct"><a href="https://terms.archlinux.org/docs/code-of-conduct/" class="extiw" title="archlinux-service-agreements:code-of-conduct">Code of conduct</a></li>
	<li id="footer-places-archwiki-terms-of-service"><a href="https://terms.archlinux.org/docs/terms-of-service/" class="extiw" title="archlinux-service-agreements:terms-of-service">Terms of service</a></li>
</ul>

	<ul id="footer-icons" class="noprint">
	<li id="footer-copyrightico"><a href="https://www.gnu.org/copyleft/fdl.html"><img src="/resources/assets/licenses/gnu-fdl.png" alt="GNU Free Documentation License 1.3 or later" width="88" height="31" loading="lazy"></a></li>
	<li id="footer-poweredbyico"><img src="/resources/assets/poweredby_mediawiki_88x31.png" srcset="/resources/assets/poweredby_mediawiki_132x47.png 1.5x, /resources/assets/poweredby_mediawiki_176x62.png 2x" width="88" height="31" loading="lazy"></li>
</ul>

</footer>

		</div>
	</div> 
</div> 
<div class="vector-settings" id="p-dock-bottom">
	<ul>
		<li>
		<button class="cdx-button cdx-button--icon-only vector-limited-width-toggle" id=""><span class="vector-icon mw-ui-icon-fullScreen mw-ui-icon-wikimedia-fullScreen"></span>

<span>Toggle limited content width</span>
</button>
</li>
	</ul>
</div>
</body>
</html>
