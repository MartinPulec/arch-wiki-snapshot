<!DOCTYPE html>
<html class="client-nojs vector-feature-language-in-header-enabled vector-feature-language-in-main-page-header-disabled vector-feature-sticky-header-disabled vector-feature-page-tools-pinned-disabled vector-feature-toc-pinned-clientpref-1 vector-feature-main-menu-pinned-disabled vector-feature-limited-width-clientpref-1 vector-feature-limited-width-content-enabled vector-feature-custom-font-size-clientpref-0 vector-feature-client-preferences-disabled vector-feature-client-prefs-pinned-disabled vector-feature-night-mode-disabled skin-theme-clientpref-day vector-toc-available" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>Bcache - ArchWiki</title>
<link rel="stylesheet" href="../ArchWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<meta name="generator" content="MediaWiki 1.42.1">
<meta name="referrer" content="no-referrer-when-downgrade">
<meta name="robots" content="max-image-preview:standard">
<meta name="format-detection" content="telephone=no">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=0.25, maximum-scale=5.0">
<link rel="icon" href="/favicon.ico">
<link rel="search" type="application/opensearchdescription+xml" href="/opensearch_desc.php" title="ArchWiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.archlinux.org/api.php?action=rsd">
<link rel="license" href="https://www.gnu.org/copyleft/fdl.html">
<link rel="alternate" type="application/atom+xml" title="ArchWiki Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="skin-vector skin-vector-search-vue mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-Bcache rootpage-Bcache skin-vector-2022 action-view skin--responsive">
<a class="mw-jump-link" href="#bodyContent">Jump to content</a>
<div class="vector-header-container">
	</div>
<div class="mw-page-container">
	<div class="mw-page-container-inner">
		<div class="vector-column-start">
			<div class="vector-main-menu-container">
		</div>
	<div class="vector-sticky-pinned-container">
				<nav id="mw-panel-toc" role="navigation" aria-label="Contents" data-event-name="ui.sidebar-toc" class="mw-table-of-contents-container vector-toc-landmark">
					<div id="vector-toc-pinned-container" class="vector-pinned-container">
					<div id="vector-toc" class="vector-toc vector-pinnable-element">
	<div class="vector-pinnable-header vector-toc-pinnable-header vector-pinnable-header-pinned" data-feature-name="toc-pinned" data-pinnable-element-id="vector-toc">
	<h2 class="vector-pinnable-header-label">Contents</h2>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-pin-button" data-event-name="pinnable-header.vector-toc.pin">move to sidebar</button>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-unpin-button" data-event-name="pinnable-header.vector-toc.unpin">hide</button>
</div>


	<ul class="vector-toc-contents" id="mw-panel-toc-list">
		<li id="toc-mw-content-text" class="vector-toc-list-item vector-toc-level-1">
			<a href="#" class="vector-toc-link">
				<div class="vector-toc-text">Beginning</div>
			</a>
		</li>
		<li id="toc-Setting_up_bcached_btrfs_file_systems_on_an_existing_system" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#Setting_up_bcached_btrfs_file_systems_on_an_existing_system">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">1</span>Setting up bcached btrfs file systems on an existing system</div>
		</a>
		
			<button aria-controls="toc-Setting_up_bcached_btrfs_file_systems_on_an_existing_system-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Setting up bcached btrfs file systems on an existing system subsection</span>
			</button>
		
		<ul id="toc-Setting_up_bcached_btrfs_file_systems_on_an_existing_system-sublist" class="vector-toc-list">
			<li id="toc-Preparation" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Preparation">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">1.1</span>Preparation</div>
			</a>
			
			<ul id="toc-Preparation-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Situation:_1_hard_drive_and_1_read_cache_SSD" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Situation:_1_hard_drive_and_1_read_cache_SSD">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">1.2</span>Situation: 1 hard drive and 1 read cache SSD</div>
			</a>
			
			<ul id="toc-Situation:_1_hard_drive_and_1_read_cache_SSD-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Situation:_4_hard_drives_and_1_read_cache_SSD" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Situation:_4_hard_drives_and_1_read_cache_SSD">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">1.3</span>Situation: 4 hard drives and 1 read cache SSD</div>
			</a>
			
			<ul id="toc-Situation:_4_hard_drives_and_1_read_cache_SSD-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Situation:_3_hard_drives_and_3_read/write_cache_SSD's" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Situation:_3_hard_drives_and_3_read/write_cache_SSD's">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">1.4</span>Situation: 3 hard drives and 3 read/write cache SSD's</div>
			</a>
			
			<ul id="toc-Situation:_3_hard_drives_and_3_read/write_cache_SSD's-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Situation:_5_hard_drives_and_3_cache_SSD's" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Situation:_5_hard_drives_and_3_cache_SSD's">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">1.5</span>Situation: 5 hard drives and 3 cache SSD's</div>
			</a>
			
			<ul id="toc-Situation:_5_hard_drives_and_3_cache_SSD's-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Bcache_management" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Bcache_management">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">1.6</span>Bcache management</div>
			</a>
			
			<ul id="toc-Bcache_management-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Installation_to_a_bcache_device" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#Installation_to_a_bcache_device">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">2</span>Installation to a bcache device</div>
		</a>
		
		<ul id="toc-Installation_to_a_bcache_device-sublist" class="vector-toc-list">
		</ul>
	</li>
	<li id="toc-Accessing_from_the_install_disk" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#Accessing_from_the_install_disk">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">3</span>Accessing from the install disk</div>
		</a>
		
		<ul id="toc-Accessing_from_the_install_disk-sublist" class="vector-toc-list">
		</ul>
	</li>
	<li id="toc-Configuring" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#Configuring">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">4</span>Configuring</div>
		</a>
		
			<button aria-controls="toc-Configuring-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Configuring subsection</span>
			</button>
		
		<ul id="toc-Configuring-sublist" class="vector-toc-list">
			<li id="toc-Situation:_Prevent_all_write_access_to_a_HDD" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Situation:_Prevent_all_write_access_to_a_HDD">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">4.1</span>Situation: Prevent all write access to a HDD</div>
			</a>
			
			<ul id="toc-Situation:_Prevent_all_write_access_to_a_HDD-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Advanced_operations" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#Advanced_operations">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">5</span>Advanced operations</div>
		</a>
		
			<button aria-controls="toc-Advanced_operations-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Advanced operations subsection</span>
			</button>
		
		<ul id="toc-Advanced_operations-sublist" class="vector-toc-list">
			<li id="toc-Resize_backing_device" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Resize_backing_device">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">5.1</span>Resize backing device</div>
			</a>
			
			<ul id="toc-Resize_backing_device-sublist" class="vector-toc-list">
				<li id="toc-Example_of_growing" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Example_of_growing">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">5.1.1</span>Example of growing</div>
			</a>
			
			<ul id="toc-Example_of_growing-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Example_of_shrinking" class="vector-toc-list-item vector-toc-level-3">
			<a class="vector-toc-link" href="#Example_of_shrinking">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">5.1.2</span>Example of shrinking</div>
			</a>
			
			<ul id="toc-Example_of_shrinking-sublist" class="vector-toc-list">
				<li id="toc-Force_flush_of_cache_to_backing_device" class="vector-toc-list-item vector-toc-level-4">
			<a class="vector-toc-link" href="#Force_flush_of_cache_to_backing_device">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">5.1.2.1</span>Force flush of cache to backing device</div>
			</a>
			
			<ul id="toc-Force_flush_of_cache_to_backing_device-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
		</li>
	</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Troubleshooting" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#Troubleshooting">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">6</span>Troubleshooting</div>
		</a>
		
			<button aria-controls="toc-Troubleshooting-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Troubleshooting subsection</span>
			</button>
		
		<ul id="toc-Troubleshooting-sublist" class="vector-toc-list">
			<li id="toc-/dev/bcache_device_does_not_exist_on_bootup" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#/dev/bcache_device_does_not_exist_on_bootup">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">6.1</span>/dev/bcache device does not exist on bootup</div>
			</a>
			
			<ul id="toc-/dev/bcache_device_does_not_exist_on_bootup-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-/sys/fs/bcache/_does_not_exist" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#/sys/fs/bcache/_does_not_exist">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">6.2</span>/sys/fs/bcache/ does not exist</div>
			</a>
			
			<ul id="toc-/sys/fs/bcache/_does_not_exist-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-write_error:_Invalid_argument_when_trying_to_attach_a_device_due_to_mismatched_block_parameter" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#write_error:_Invalid_argument_when_trying_to_attach_a_device_due_to_mismatched_block_parameter">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">6.3</span>write error: Invalid argument when trying to attach a device due to mismatched block parameter</div>
			</a>
			
			<ul id="toc-write_error:_Invalid_argument_when_trying_to_attach_a_device_due_to_mismatched_block_parameter-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Device_or_resource_busy" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Device_or_resource_busy">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">6.4</span>Device or resource busy</div>
			</a>
			
			<ul id="toc-Device_or_resource_busy-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-See_also" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#See_also">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">7</span>See also</div>
		</a>
		
		<ul id="toc-See_also-sublist" class="vector-toc-list">
		</ul>
	</li>
</ul>
</div>

					</div>
		</nav>
			</div>
		</div>
		<div class="mw-content-container">
			<main id="content" class="mw-body" role="main" style="margin: 0">
				<header class="mw-body-header vector-page-titlebar">
					<nav role="navigation" aria-label="Contents" class="vector-toc-landmark">
						
<div id="vector-page-titlebar-toc" class="vector-dropdown vector-page-titlebar-toc vector-button-flush-left">
	<input type="checkbox" id="vector-page-titlebar-toc-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-vector-page-titlebar-toc" class="vector-dropdown-checkbox " aria-label="Toggle the table of contents">
	<label id="vector-page-titlebar-toc-label" for="vector-page-titlebar-toc-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--icon-only " aria-hidden="true"><span class="vector-icon mw-ui-icon-listBullet mw-ui-icon-wikimedia-listBullet"></span>

<span class="vector-dropdown-label-text">Toggle the table of contents</span>
	</label>
	<div class="vector-dropdown-content">


							<div id="vector-page-titlebar-toc-unpinned-container" class="vector-unpinned-container">
			</div>
		
	</div>
</div>

					</nav>
					<h1 id="firstHeading" class="firstHeading mw-first-heading"><span class="mw-page-title-main">Bcache</span></h1>
							
<div id="p-lang-btn" class="vector-dropdown mw-portlet mw-portlet-lang">
	<input type="checkbox" id="p-lang-btn-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-p-lang-btn" class="vector-dropdown-checkbox mw-interlanguage-selector" aria-label="Go to an article in another language. Available in 2 languages">
	<label id="p-lang-btn-label" for="p-lang-btn-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--action-progressive mw-portlet-lang-heading-2" aria-hidden="true"><span class="vector-icon mw-ui-icon-language-progressive mw-ui-icon-wikimedia-language-progressive"></span>

<span class="vector-dropdown-label-text">2 languages</span>
	</label>
	<div class="vector-dropdown-content">

		<div class="vector-menu-content">
			
			<ul class="vector-menu-content-list">
				
				<li class="interlanguage-link interwiki-ja mw-list-item"><a href="https://wiki.archlinux.jp/index.php/Bcache" title="Bcache – 日本語" lang="ja" hreflang="ja" class="interlanguage-link-target"><span>日本語</span></a></li>
<li class="interlanguage-link interwiki-zh-hans mw-list-item"><a href="https://wiki.archlinuxcn.org/wiki/Bcache" title="Bcache – 中文（简体）" lang="zh-Hans" hreflang="zh-Hans" class="interlanguage-link-target"><span>中文（简体）</span></a></li>
			</ul>
			
		</div>

	</div>
</div>
</header>
				<div class="vector-column-end">
					<div class="vector-sticky-pinned-container">
						<nav class="vector-page-tools-landmark" aria-label="Page tools">
							<div id="vector-page-tools-pinned-container" class="vector-pinned-container">
				
							</div>
		</nav>
						<nav class="vector-client-prefs-landmark" aria-label="Appearance">
						</nav>
					</div>
				</div>
				<div id="bodyContent" class="vector-body" aria-labelledby="firstHeading" data-mw-ve-target-container>
					<div class="vector-body-before-content">
							<div class="mw-indicators">
		</div>

						<div id="siteSub" class="noprint">From ArchWiki</div>
					</div>
					<div id="contentSub"><div id="mw-content-subtitle"></div></div>
					
					
					<div id="mw-content-text" class="mw-body-content">
<div class="mw-content-ltr mw-parser-output" lang="en" dir="ltr">
<div class="noprint archwiki-template-message">
<p><span class="mw-default-size" typeof="mw:File"><span><img src="../File:Tango-edit-clear.svg" decoding="async" width="48" height="48" class="mw-file-element"></span></span><b>This article or section needs language, wiki syntax or style improvements. See <a href="../en/Help:Style.html" title="Help:Style">Help:Style</a> for reference.</b></p>
<div>
<b>Reason:</b> Some first-person comments, see <a href="../en/Help:Style.html" title="Help:Style">Help:Style</a>. (Discuss in <a rel="nofollow" class="external text" href="../en/Talk:Bcache.html">Talk:Bcache</a>)</div>
</div>
<div class="archwiki-template-meta-related-articles">
<p>Related articles</p>
<ul>
<li><a href="../en/Bcachefs.html" title="Bcachefs">Bcachefs</a></li>
<li><a href="../en/LVM.html" class="mw-redirect" title="LVM2">LVM2</a></li>
</ul>
</div>
<p><a rel="nofollow" class="external text" href="https://bcache.evilpiepirate.org/">Bcache</a> (block cache) allows one to use an SSD as a read/write cache (in writeback mode) or read cache (writethrough or writearound) for another blockdevice (generally a rotating HDD or array). This article will show how to install Arch using Bcache as the root partition. For an intro to bcache itself, see <a rel="nofollow" class="external text" href="https://bcache.evilpiepirate.org/">the bcache homepage</a>. Be sure to read and reference <a rel="nofollow" class="external text" href="https://docs.kernel.org/admin-guide/bcache.html">the bcache manual</a>. 
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> An alternative to Bcache is the <a href="../en/LVM.html#Cache" title="LVM">LVM cache</a>.</div>
<p>Bcache needs the backing device to be formatted as a bcache block device.  In most cases, <a rel="nofollow" class="external text" href="https://github.com/g2p/blocks">blocks to-bcache</a> can do an in-place conversion.
</p>
<div class="noprint archwiki-template-message">
<p><span class="mw-default-size" typeof="mw:File"><span><img src="../File:View-refresh-red.svg" decoding="async" width="48" height="48" class="mw-file-element"></span></span><b>This article or section is out of date.</b></p>
<div>
<b>Reason:</b> Backwards incompatible changes to on-disk format for Linux 3.18 were reported to be false. bcache on-disk format changes had not landed upstream yet as of 3.19. Since then, Linux is at version 6.2, can the relevant sentence reflect when exactly the breaking changes took place ? Is the mention still needed ? (Discuss in <a rel="nofollow" class="external text" href="../en/Talk:Bcache.html">Talk:Bcache</a>)</div>
</div>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> 
<ul>
<li>Be sure you back up any important data first.</li>
<li>The bcache-dev branch is under heavy development. The on-disk format has undergone changes in 3.18 which are not backwards compatible with previous formats<a rel="nofollow" class="external autonumber" href="https://lore.kernel.org/linux-bcache/20150104004621.GA4460@kmo-pixel/">[1]</a>. Note: This only applies to users who compile-in bcache-dev. The version built-in to the upstream Linux kernel is unaffected<a rel="nofollow" class="external autonumber" href="https://lore.kernel.org/linux-bcache/CACHGV4KV-y3JD=i6jy_0jaapZYBKxOYr1+PL=0dsAe+M83Y_Ew@mail.gmail.com/">[2]</a>.</li>
<li>Bcache and <a href="../en/Btrfs.html" title="Btrfs">btrfs</a> could leave you with a corrupted filesystem. Please visit <a rel="nofollow" class="external text" href="https://www.hdevalence.ca/blog/2013-09-21-notes-on-my-archlinux-install">this post</a> for more information. Btrfs wiki reports that it was fixed in kernels 3.19+ <a rel="nofollow" class="external autonumber" href="https://btrfs.wiki.kernel.org/index.php/Gotchas#Historical_references">[3]</a>.</li>
</ul>
</div>
<meta property="mw:PageProp/toc">
<h2><span class="mw-headline" id="Setting_up_bcached_btrfs_file_systems_on_an_existing_system">Setting up bcached btrfs file systems on an existing system</span></h2>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> make-bcache <b>will not</b> import an existing drive or partition – it will reformat it.</div>
<h3><span class="mw-headline" id="Preparation">Preparation</span></h3>
<p><a href="../en/Help:Reading.html#Installation_of_packages" class="mw-redirect" title="Install">Install</a> <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/bcache-tools/">bcache-tools</a></span><sup><small>AUR</small></sup>.
</p>
<p>Use fdisk to create the appropriate partitions on the SSD's and hard drives to hold the cache and the backing data.
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong>  It is possible to create many partitions on a single drive. This allows for testing of elaborate setups before committing. Be aware all data will be lost when the drive fails. This will also kill performance of the drive, due to unfavorable access patterns.</div>
<h3><span class="mw-headline" id="Situation:_1_hard_drive_and_1_read_cache_SSD">Situation: 1 hard drive and 1 read cache SSD</span></h3>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong>  
<ul>
<li>When a single hard drive fails, all data is lost.</li>
<li>Do not enable write caching, as that can cause data loss when the SSD fails</li>
</ul>
</div>
<pre>+--------------+
| btrfs /mnt   |
+--------------+
| /dev/Bcache0 |
+--------------+
| Cache        |
| /dev/sdk1    |
+--------------+
| Data         |
| /dev/sdv1    |
+--------------+
</pre>
<p>1. Format the backing device (This will typically be your mechanical drive). The backing device can be a whole device, a partition or any other standard block device. This will create /dev/bcache0
</p>
<pre># make-bcache -B /dev/sdv1
</pre>
<p>2. Format the cache device (This will typically be your SSD). The cache device can be a whole device, a partition or any other standard block device
</p>
<pre># make-bcache -C /dev/sdk1
</pre>
<p>In this example the default block and bucket sizes of 512B and 128kB are used. The block size should match the backing devices sector size which will usually be either 512 or 4k. The bucket size should match the erase block size of the caching device with the intent of reducing write amplification. For example, using a HDD with 4k sectors and an SSD with an erase block size of 2MB this command would look like
</p>
<pre># make-bcache --block 4k --bucket 2M -C /dev/sdk1
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> You may need to omit the <code>--block 4k</code> option, see <a rel="nofollow" class="external text" href="https://unix.stackexchange.com/questions/359508/cannot-attach-cache-device-to-backing-device">Cannot attach cache device to backing device</a>.</div>
<p>3. Get the uuid of the cache device
</p>
<pre># bcache-super-show /dev/sdk1 | grep cset
cset.uuid		f0e01318-f4fd-4fab-abbb-d76d870503ec
</pre>
<p>4. Register the cache device against your backing device. Replace the example uuid with the uuid of your cache. Udev rules will take care of this on reboot and will only need to be done once.
</p>
<pre># echo f0e01318-f4fd-4fab-abbb-d76d870503ec &gt; /sys/block/bcache0/bcache/attach
</pre>
<p>5. Create the btrfs filesystem.
</p>
<pre># mkfs.btrfs /dev/bcache0
</pre>
<p>6. mount the filesystem
</p>
<pre># mount /dev/bcache0 /mnt
</pre>
<p>7. If you want to have this partition available during the initcpio (i.e. you require it at some point in the boot process) you need to add 'bcache' to your modules array in /etc/mkinitcpio.conf as well as adding the 'bcache' hook in your list between block and filesystems. You must then <a href="../en/Mkinitcpio.html#Image_creation_and_activation" class="mw-redirect" title="Regenerate the initramfs">regenerate the initramfs</a>.
</p>
<h3><span class="mw-headline" id="Situation:_4_hard_drives_and_1_read_cache_SSD">Situation: 4 hard drives and 1 read cache SSD</span></h3>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong>  
<ul><li>Do not enable write caching, as that can cause data loss when the SSD fails</li></ul>
</div>
<pre>+-----------------------------------------------------------+
|                         btrfs /mnt                        |
+--------------+--------------+--------------+--------------+
| /dev/Bcache0 | /dev/Bcache1 | /dev/Bcache2 | /dev/Bcache3 |
+--------------+--------------+--------------+--------------+
|                           Cache                           |  
|                         /dev/sdk1                         |
+--------------+--------------+--------------+--------------+
| Data         | Data         | Data         | Data         |
| /dev/sdv1    | /dev/sdw1    | /dev/sdx1    | /dev/sdy1    |
+--------------+--------------+--------------+--------------+
</pre>
<p>1. Format the backing devices (These will typically be your mechanical drives). The backing devices can be whole devices, partitions or any other standard block devices. This will create /dev/bcache0, /dev/bcache1, /dev/bcache2 and /dev/bcache3 
</p>
<pre># make-bcache -B /dev/sdv1
# make-bcache -B /dev/sdw1
# make-bcache -B /dev/sdx1
# make-bcache -B /dev/sdy1
</pre>
<p>2. Format the cache device (This will typically be your SSD). The cache device can be a whole device, a partition or any other standard block device. Only one cache device can be added to a group of backing devices.
</p>
<pre># make-bcache -C /dev/sdk1
</pre>
<p>3. Get the uuid of the cache device
</p>
<pre># bcache-super-show /dev/sdk1 | grep cset
cset.uuid		f0e01318-f4fd-4fab-abbb-d76d870503ec
</pre>
<p>4. Register the cache device against your backing devices. Replace the example uuid with the uuid of your cache.
</p>
<pre># echo f0e01318-f4fd-4fab-abbb-d76d870503ec &gt; /sys/block/bcache0/bcache/attach
# echo f0e01318-f4fd-4fab-abbb-d76d870503ec &gt; /sys/block/bcache1/bcache/attach
# echo f0e01318-f4fd-4fab-abbb-d76d870503ec &gt; /sys/block/bcache2/bcache/attach
# echo f0e01318-f4fd-4fab-abbb-d76d870503ec &gt; /sys/block/bcache3/bcache/attach
</pre>
<p>5. Create the btrfs filesystem. Both the data and the metadata is stored twice in the array, so there will be no data loss when a single hard drive fails. The -L argument defines the label of the filesystem.
</p>
<pre># mkfs.btrfs -L STORAGE -f -d raid1 -m raid1 /dev/bcache0 /dev/bcache1 /dev/bcache2 /dev/bcache3 
</pre>
<p>6. mount the filesystem
</p>
<pre># mount /dev/bcache0 /mnt
</pre>
<h3>
<span id="Situation:_3_hard_drives_and_3_read.2Fwrite_cache_SSD.27s"></span><span class="mw-headline" id="Situation:_3_hard_drives_and_3_read/write_cache_SSD's">Situation: 3 hard drives and 3 read/write cache SSD's</span>
</h3>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong>  
<ul><li>Each HDD needs its own SSD, to avoid data loss if a SSD in writeback mode fails.</li></ul>
</div>
<pre>+--------------------------------------------+
|                  btrfs /mnt                |
+--------------+--------------+--------------+
| /dev/Bcache0 | /dev/Bcache1 | /dev/Bcache2 |
+--------------+--------------+--------------+
| Cache        | Cache        | Cache        |  
| /dev/sdk1    | /dev/sdl1    | /dev/sdm1    |
+--------------+--------------+--------------+
| Data         | Data         | Data         |
| /dev/sdv1    | /dev/sdw1    | /dev/sdx1    |
+--------------+--------------+--------------+
</pre>
<p>1. Format the backing devices (These will typically be your mechanical drives). The backing devices can be whole devices, partitions or any other standard block devices. This will create /dev/bcache0, /dev/bcache1 and /dev/bcache2.
</p>
<pre># make-bcache -B /dev/sdv1
# make-bcache -B /dev/sdw1
# make-bcache -B /dev/sdx1
</pre>
<p>2. Format the cache devices (This will typically be your SSD's). The cache devices can be whole devices, partitions or any other standard block devices. To avoid data loss in case of a failing SSD, each backing device needs its own SSD if it is in writeback mode. Cache SSD's in writethrough and in writearound mode can be shared by multiple backing devices, as they do not cause data loss when they fail.
</p>
<pre># make-bcache -C /dev/sdk1
# make-bcache -C /dev/sdl1
# make-bcache -C /dev/sdm1
</pre>
<p>3. Get the uuid of the cache devices
</p>
<pre># bcache-super-show /dev/sdk1 | grep cset
cset.uuid		f0e01318-f4fd-4fab-abbb-d76d870503ec
# bcache-super-show /dev/sdl1 | grep cset
cset.uuid		4b05ce02-19f4-4cc6-8ca0-1f765671ceda
# bcache-super-show /dev/sdm1 | grep cset
cset.uuid		75ff0598-7624-46f6-bcac-c27a3cf1a09f
</pre>
<p>4. Register the cache devices against your backing devices. Replace the example uuid's with the uuid's of your caches.
</p>
<pre># echo f0e01318-f4fd-4fab-abbb-d76d870503ec &gt; /sys/block/bcache0/bcache/attach
# echo 4b05ce02-19f4-4cc6-8ca0-1f765671ceda &gt; /sys/block/bcache1/bcache/attach
# echo 75ff0598-7624-46f6-bcac-c27a3cf1a09f &gt; /sys/block/bcache2/bcache/attach
</pre>
<p>5. enable writeback mode
</p>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong>  
<ul>
<li>Bcache write caching can cause a catastrophic failure of a btrfs filesystem.</li>
<li>Btrfs assumes the underlying device executes writes in order, but bcache writeback may violate that assumption, causing the btrfs filesystem using it to collapse.</li>
<li>Every layer or write caching adds more risk of losing data in the event of a power loss.</li>
<li>Use bcache in writeback mode with btrfs at your own risk.</li>
</ul>
</div>
<pre># echo writeback &gt; /sys/block/bcache0/bcache/cache_mode
# echo writeback &gt; /sys/block/bcache1/bcache/cache_mode
# echo writeback &gt; /sys/block/bcache2/bcache/cache_mode
</pre>
<p>6. Create the btrfs filesystem. Both the data and the metadata is stored twice in the array, so there will be no data loss when a single hard drive fails. The -L argument defines the label of the filesystem.
</p>
<pre># mkfs.btrfs -L STORAGE -f -d raid1 -m raid1 /dev/bcache0 /dev/bcache1 /dev/bcache2
</pre>
<p>7. mount the filesystem
</p>
<pre># mount /dev/bcache0 /mnt
</pre>
<h3>
<span id="Situation:_5_hard_drives_and_3_cache_SSD.27s"></span><span class="mw-headline" id="Situation:_5_hard_drives_and_3_cache_SSD's">Situation: 5 hard drives and 3 cache SSD's</span>
</h3>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong>  
<ul><li>Each cache device in writeback mode must only be used to cache a single backing drive, to avoid data loss if that SSD fails. Writethrough and writearound SSD's can be shared.</li></ul>
</div>
<pre>+--------------------------------------------------------------------------+
|                                btrfs /mnt                                |
+--------------+--------------+--------------+--------------+--------------+
| /dev/Bcache0 | /dev/Bcache1 | /dev/Bcache2 | /dev/Bcache3 | /dev/Bcache4 |
+--------------+--------------+--------------+--------------+--------------+
| WriteB Cache |     Writethrough or writearound Cache      | WriteB Cache |  
| /dev/sdk1    |                 /dev/sdl1                  | /dev/sdm1    |
+--------------+--------------+--------------+--------------+--------------+
| Data         | Data         | Data         | Data         | Data         |
| /dev/sdv1    | /dev/sdw1    | /dev/sdx1    | /dev/sdy1    | /dev/sdz1    |
+--------------+--------------+--------------+--------------+--------------+
</pre>
<p>1. Format the backing devices (These will typically be your mechanical drives). The backing devices can be whole devices, partitions or any other standard block devices. This will create /dev/bcache0, /dev/bcache1, /dev/bcache2, /dev/bcache3 and /dev/bcache4.
</p>
<pre># make-bcache -B /dev/sdv1
# make-bcache -B /dev/sdw1
# make-bcache -B /dev/sdx1
# make-bcache -B /dev/sdy1
# make-bcache -B /dev/sdz1
</pre>
<p>2. Format the cache devices (This will typically be your SSD's). The cache devices can be whole devices, partitions or any other standard block devices. To avoid data loss in case of a failing SSD, each backing device needs its own SSD if it is in writeback mode. Cache SSD's in writethrough and in writearound mode can be shared by multiple backing devices, as they do not cause data loss when they fail.
</p>
<pre># make-bcache -C /dev/sdk1
# make-bcache -C /dev/sdl1
# make-bcache -C /dev/sdm1
</pre>
<p>3. Get the uuid of the cache devices
</p>
<pre># bcache-super-show /dev/sdk1 | grep cset
cset.uuid		f0e01318-f4fd-4fab-abbb-d76d870503ec
# bcache-super-show /dev/sdl1 | grep cset
cset.uuid		4b05ce02-19f4-4cc6-8ca0-1f765671ceda
# bcache-super-show /dev/sdm1 | grep cset
cset.uuid		75ff0598-7624-46f6-bcac-c27a3cf1a09f
</pre>
<p>4. Register the cache devices against your backing devices. Replace the example uuid's with the uuid's of your caches.
</p>
<pre># echo f0e01318-f4fd-4fab-abbb-d76d870503ec &gt; /sys/block/bcache0/bcache/attach
# echo 4b05ce02-19f4-4cc6-8ca0-1f765671ceda &gt; /sys/block/bcache1/bcache/attach
# echo 4b05ce02-19f4-4cc6-8ca0-1f765671ceda &gt; /sys/block/bcache2/bcache/attach
# echo 4b05ce02-19f4-4cc6-8ca0-1f765671ceda &gt; /sys/block/bcache3/bcache/attach
# echo 75ff0598-7624-46f6-bcac-c27a3cf1a09f &gt; /sys/block/bcache4/bcache/attach
</pre>
<p>5. enable writeback mode on non-shared caches
</p>
<pre># echo writeback &gt; /sys/block/bcache0/bcache/cache_mode
# echo writeback &gt; /sys/block/bcache4/bcache/cache_mode
</pre>
<p>6. Create the btrfs filesystem. Both the data and the metadata is stored twice in the array, so there will be no data loss when a single hard drive fails. The -L argument defines the label of the filesystem.
</p>
<pre># mkfs.btrfs -L STORAGE -f -d raid1 -m raid1 /dev/bcache0 /dev/bcache1 /dev/bcache2 /dev/bcache3 /dev/bcache4
</pre>
<p>7. mount the filesystem
</p>
<pre># mount /dev/bcache0 /mnt
</pre>
<h3><span class="mw-headline" id="Bcache_management">Bcache management</span></h3>
<p>1. Check that everything has been correctly setup 
</p>
<pre># cat /sys/block/bcache0/bcache/state
</pre>
<p>The output can be:
</p>
<ul>
<li>
<code>no cache</code>: this means you have not attached a caching device to your backing bcache device</li>
<li>
<b>clean</b>: this means everything is ok. The cache is clean.</li>
<li>
<b>dirty</b>: this means everything is setup fine and that you have enabled <i>writeback</i> and that the cache is dirty.</li>
<li>
<b>inconsistent</b>: you are in trouble because the backing device is not in sync with the caching device</li>
</ul>
<p>You can have a <code>/dev/bcache0</code> device associated with a backing device with no caching device attached. This means that all I/O (read/write) are passed directly to the backing device (pass-through mode)
</p>
<p>2. See what caching mode is in use
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># cat /sys/block/bcache0/bcache/cache_mode</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[writethrough] writeback writearound none
</pre>
<p>In the above example, the <i>writethrough</i> mode is enabled.
</p>
<p>3. Show info about a bcached device:
</p>
<pre># bcache-super-show /dev/sdXY
</pre>
<p>4. Stop the backing device:
</p>
<pre># echo 1 &gt; /sys/block/sdX/sdX[Y]/bcache/stop
</pre>
<p>5. Detach a caching device:
</p>
<pre># echo 1 &gt; /sys/block/sdX/sdX[Y]/bcache/detach
</pre>
<p>6. Safely remove the cache device
</p>
<pre># echo <i>cache-set-uuid</i> &gt; /sys/block/bcache0/bcache/detach
</pre>
<p>7. Release attached devices
</p>
<pre># echo 1 &gt; /sys/fs/bcache/<i>cache-set-uuid</i>/stop
</pre>
<h2><span class="mw-headline" id="Installation_to_a_bcache_device">Installation to a bcache device</span></h2>
<p>1. Boot on the install disk (2013.08.01 minimum).
</p>
<p>2. <a href="../en/Help:Reading.html#Installation_of_packages" class="mw-redirect" title="Install">Install</a> the <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/bcache-tools/">bcache-tools</a></span><sup><small>AUR</small></sup>.
</p>
<p>3. Partition your HDD
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> While it may be true that Grub2 does not offer support for bcache as noted below, it does, however, fully support UEFI. It follows then, that so long as the necessary modules for the linux kernel to properly handle your boot device are either compiled into the kernel or are included in an initramfs, and you can include these files on it, the separate boot partition described below may be omitted in favor of the FAT EFI system partition. See <a href="../en/GRUB.html" title="GRUB">GRUB</a> and/or <a href="../en/Unified_Extensible_Firmware_Interface.html" class="mw-redirect" title="UEFI">UEFI</a> for more.</div>
<p>grub cannot handle bcache, so you will need at least 2 partitions (boot and one for the bcache backing device). If you are doing UEFI, you will need an <a href="../en/EFI_system_partition.html" title="EFI system partition">EFI system partition</a> (ESP) as well. E.g.:
</p>
<pre>     1            2048           22527   10.0 MiB    EF00  EFI System
     2           22528          432127   200.0 MiB   8300  arch_boot
     3          432128       625142414   297.9 GiB   8300  bcache_backing
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> This example has no swapfile/partition. For a swap partition on the cache, use LVM in step 7. For a swap partition outside the cache, be sure to make a swap partition now.</div>
<p>4. Configure your HDD as a bcache backing device.
</p>
<pre># make-bcache -B /dev/sda3
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> 
<ul>
<li>When preparing any boot disk it is important to know the ramifications of any decision you may make. Please review and review again the documentation for your chosen boot-loader/-manager and consider seriously how it might relate to bcache.</li>
<li>If all associated disks are partitioned at once as below bcache will automatically attach "-B backing stores" to the "-C ssd cache" and step 5 is unnecessary.</li>
</ul>
</div>
<pre># make-bcache -B /dev/sd? /dev/sd? -C /dev/sd?
</pre>
<p>You now have a <code>/dev/bcache0</code> device.
</p>
<p>5. Configure your SSD
</p>
<p>Format the SSD as a caching device and link it to the backing device
</p>
<pre># make-bcache -C /dev/sdb
# echo /dev/sdb &gt; /sys/fs/bcache/register 
# echo <i>UUID__from_previous_command</i> &gt; /sys/block/bcache0/bcache/attach
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> If the UUID is forgotten, it can be found with <code>ls /sys/fs/bcache/</code> after the cache device has been registered.</div>
<p>6. Format the bcache device. Use LVM or btrfs subvolumes if you want to divide up the <code>/dev/bcache0</code> device how you like (ex for separate <code>/</code>, <code>/home</code>, <code>/var</code>, etc):
</p>
<pre># mkfs.btrfs /dev/bcache0
# mount /dev/bcache0 /mnt/
# btrfs subvolume create /mnt/root
# btrfs subvolume create /mnt/home
# umount /mnt
</pre>
<p>You can even setup LUKS on it if you want using e.g. cryptsetup. Referencing the bcache device in the 'cryptdevice' kernel option will work fine, for instance.
</p>
<p>7. Prepare the installation mount point:
</p>
<pre># mkfs.ext4 /dev/sda2
# mkfs.msdos /dev/sda1 (if your ESP is at least 500MB, use mkfs.vfat to make a FAT32 partition instead)
</pre>
<p>Now install <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=arch-install-scripts">arch-install-scripts</a></span> package. Then:
</p>
<pre># mount /dev/bcache0 -o subvol=root,compress=lzo /mnt/
# mount --mkdir /dev/bcache0 -o subvol=home,compress=lzo /mnt/home
# mount --mkdir /dev/sda2 /mnt/boot
# mount --mkdir /dev/sda1 /mnt/efi
</pre>
<p>8. Install the system as per the <a href="../en/Installation_guide.html" title="Installation guide">Installation guide</a> as normal except this:
</p>
<p>Before you edit <code>/etc/mkinitcpio.conf</code> and run <code>mkinitcpio -p linux</code>:
</p>
<ul>
<li>
<a href="../en/Help:Reading.html#Installation_of_packages" class="mw-redirect" title="Install">Install</a> <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/bcache-tools/">bcache-tools</a></span><sup><small>AUR</small></sup>.</li>
<li>Edit <code>/etc/mkinitcpio.conf</code>:
<ul>
<li>add the "bcache" module</li>
<li>add the "bcache" hook between block and filesystem hooks</li>
</ul>
</li>
</ul>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong>  Should you want to open the backing device from the installation media for any reason after a reboot you must register it manually. Make sure the bcache module is loaded and then echo the relevant devices to /sys/bcache/register. You should see whether this worked or not by using <a href="../en/Core_utilities.html#Essentials" class="mw-redirect" title="Dmesg">dmesg</a>.</div>
<h2><span class="mw-headline" id="Accessing_from_the_install_disk">Accessing from the install disk</span></h2>
<p>This is how to access a bcache partition from the install disk that was present before the install disk was booted. Boot the install disk and install <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/bcache-tools/">bcache-tools</a></span><sup><small>AUR</small></sup> from the AUR, just as in the previous section. Then, add the module to the kernel:
</p>
<pre># modprobe bcache
</pre>
<p>Your device will not appear immediately at <code>/dev/bcache*</code>. To force the kernel to find it, tell it to reread the partition table:
</p>
<pre># partprobe
</pre>
<p>Now, <code>/dev/bcache*</code> should be present, and you can carry on mounting, reformatting, etc. from here.
</p>
<p>To start the cache without having to configure the internet and install <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/bcache-tools/">bcache-tools</a></span><sup><small>AUR</small></sup>, load the kernel module just as before—it is included in the mainline kernel. Then start the cache by registering all of the slave devices:
</p>
<pre># echo /dev/sdX &gt; /sys/fs/bcache/register
# echo /dev/sdY &gt; /sys/fs/bcache/register
# ...
</pre>
<p>The bcache device will appear right after the last required slave device is registered.
</p>
<p>A <i>writethrough</i> backing device can be started without having to register any caches. This can be done if there are a lot of them and you are in a hurry, or if some of the caches are inaccessible for some reason. Register the device, as above, then start it:
</p>
<pre># echo 1 &gt; /sys/block/sdX/bcache/running
</pre>
<p>Bcache has not actually detached any caches, and will still add any cache devices if they are registered. This command will "work" on writeback backing devices, but there will be massive data corruption. Only do this if the missing cache is totally unrecoverable.
</p>
<h2><span class="mw-headline" id="Configuring">Configuring</span></h2>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> Do not enable the <code>discard</code> option! It can cause unrecoverable corruption. <a rel="nofollow" class="external autonumber" href="https://bugzilla.kernel.org/show_bug.cgi?id=197377">[4]</a><a rel="nofollow" class="external autonumber" href="https://lore.kernel.org/linux-bcache/CAJ+L6qeOVY_KofXsZKihHrbHaYzQTKYAh0Shm7Givj+f8=PiBg@mail.gmail.com/">[5]</a>
</div>
<p>There are many options that can be configured (such as cache mode, cache flush interval, sequential write heuristic, etc.) This is currently done by writing to files in <code>/sys</code>. See the <a rel="nofollow" class="external text" href="https://docs.kernel.org/admin-guide/bcache.html">bcache user documentation</a>.
</p>
<p>Changing the cache mode is done by echoing one of <code>writethrough</code>, <code>writeback</code>, <code>writearound</code> or <code>none</code> to <code>/sys/block/bcache[0-9]/bcache/cache_mode</code>.
</p>
<p>Note that some changes to <code>/sys</code> are temporary, and will revert back after a reboot (It seems that at least cache_mode does not need this workaround). To set custom configurations at boot create a .conf file in <code>/etc/tmpfiles.d</code>. To set, in a persistent fashion, the sequential cutoff for <code>bcache0</code> to 1 MB  and write back you could create a file <code>/etc/tmpfiles.d/my-bcache.conf</code> with the contents:
</p>
<pre>w /sys/block/bcache0/bcache/sequential_cutoff - - - - 1M
w /sys/block/bcache0/bcache/cache_mode        - - - - writeback
</pre>
<h3><span class="mw-headline" id="Situation:_Prevent_all_write_access_to_a_HDD">Situation: Prevent all write access to a HDD</span></h3>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong>  
<ul>
<li>When the hard drive or the SSD fails, all data is lost.</li>
<li>Consider using BTRFS RAID to prevent data loss when a SSD / HDD fails.</li>
</ul>
</div>
<p>In this situation the goal is to keep he HDD idle as long as possible. This is achieved by absorbing all writes with the SSD. The hard drive is only activated when the SSD is full, or when something is read that's not on the SSD.
</p>
<p>Enable the writeback cache mode:
</p>
<pre># echo writeback &gt; /sys/block/bcache0/bcache/cache_mode
</pre>
<p>Let bcache completely sync with the hard drive.
</p>
<pre># echo 0 &gt; /sys/block/bcache0/bcache/writeback_percent
</pre>
<p>Don't let sequential IO bypass the cache:
</p>
<pre># echo 0 &gt; /sys/block/bcache0/bcache/sequential_cutoff 
</pre>
<p>Let bcache wait a week after the previous sync is done: 
</p>
<pre># echo $((7*24*60*60)) &gt; /sys/block/bcache0/bcache/writeback_delay
</pre>
<p>Don't let bcache go around the cache when there's read / write congestion
</p>
<pre># echo 0 &gt; /sys/fs/bcache/&lt;cache set&gt;/congested_read_threshold_us
# echo 0 &gt; /sys/fs/bcache/&lt;cache set&gt;/congested_write_threshold_us

</pre>
<p>Put the HDD to sleep after 20 minutes:
</p>
<pre># hdparm -S 240  /dev/$(cat /sys/block/bcache0/bcache/backing_dev_name)
/dev/sdh1:
setting standby to 240 (20 minutes)
</pre>
<p><br>
</p>
<pre>First use lsblk to get the device names of the HDD and SSD. In this example /dev/sdh1 is the HDD, /dev/sdc1 is the SSD:
</pre>
<pre># lsblk -M -s
bcache0   254:0    0 931.5G  0 disk 
   ├─sdc1      8:33   0 111.8G  0 part 
   │ └─sdc     8:32   0 111.8G  0 disk 
   └─sdh1      8:113  0 931.5G  0 part 
     └─sdh     8:112  0 931.5G  0 disk
</pre>
<p>Now Dstat can be used to monitor disk access to the members of the bcache set.
</p>
<pre>$ dstat -D sdc1,sdh1
</pre>
<h2><span class="mw-headline" id="Advanced_operations">Advanced operations</span></h2>
<h3><span class="mw-headline" id="Resize_backing_device">Resize backing device</span></h3>
<p>It is possible to resize the backing device so long as you do not move the partition start. This process is described in <a rel="nofollow" class="external text" href="https://lore.kernel.org/linux-bcache/CAH+dOxJv-ajvLfbUSo8dqG0a8_grNBhfxJ1EbmSrYZz0YXJM2w@mail.gmail.com/T/">the mailing list</a>. Here is an example using btrfs volume directly on bcache0. For LVM containers or for other filesystems, procedure will differ.
</p>
<h4><span class="mw-headline" id="Example_of_growing">Example of growing</span></h4>
<p>In this example, I grow the filesystem by 4GB. 
</p>
<p>1. Reboot to a live CD/USB Drive (need not be bcache enabled) and use fdisk, gdisk, parted, or your other favorite tool to delete the backing partition and recreate it with the same start and a total size 4G larger. 
</p>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> Do not use a tool like GParted that might perform filesystem operations! It will not recognize the bcache partition and might overwrite part of it!!</div>
<p>2. Reboot to your normal install. Your filesystem will be currently mounted. That is fine. Issue the command to resize the partition to its maximum. For btrfs, that is
</p>
<pre># btrfs filesystem resize max /
</pre>
<p>For ext3/4, that is:
</p>
<pre># resize2fs /dev/bcache0
</pre>
<h4><span class="mw-headline" id="Example_of_shrinking">Example of shrinking</span></h4>
<p>In this example, I shrink the filesystem by 4GB.
</p>
<p>1. Disable writeback cache (switch to writethrough cache) and wait for the disk to flush.
</p>
<pre># echo writethrough &gt; /sys/block/bcache0/bcache/cache_mode
$ watch cat /sys/block/bcache0/bcache/state
</pre>
<p>wait until state reports "clean". This might take a while.
</p>
<h5><span class="mw-headline" id="Force_flush_of_cache_to_backing_device">Force flush of cache to backing device</span></h5>
<p>I suggest to use 
</p>
<pre> # echo 0 &gt; /sys/block/bcache0/bcache/writeback_percent
</pre>
<p>This will flush the dirty data of the cache to the backing device in less a minute.
</p>
<p>Revert back the value after with
</p>
<pre># echo 10 &gt; /sys/block/bcache0/bcache/writeback_percent
</pre>
<p>2. Shrink the mounted filesystem by something more than the desired amount, to ensure we do not accidentally clip it later. For btrfs, that is:
</p>
<pre># btrfs filesystem resize -5G /
</pre>
<p>For ext3/4 you can use <i>resize2fs</i>, but only if the partition is unmounted
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">$ df -h /home</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">/dev/bcache0    290G   20G   270G   1% /home
</pre>
<pre># umount /home
# resize2fs /dev/bcache0 283G
</pre>
<p>3. Reboot to a LiveCD/USB drive (does not need to support bcache) and use fdisk, gdisk, parted, or your other favorite tool to delete the backing partition and recreate it with the same start and a total size 4G smaller.
</p>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> Do not use a tool like GParted that might perform filesystem operations! It will not recognize the bcache partition and might overwrite part of it!!</div>
<p>4. Reboot to your normal install. Your filesystem will be currently mounted. That is fine. Issue the command to resize the partition to its maximum (that is, the size we shrunk the actual partition to in step 3). For btrfs, that is:
</p>
<pre># btrfs filesystem resize max /
</pre>
<p>For ext3/4, that is:
</p>
<pre># resize2fs /dev/bcache0
</pre>
<p>5. Re-enable writeback cache if you want that enabled:
</p>
<pre># echo writeback &gt; /sys/block/bcache0/bcache/cache_mode
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> If you are very careful you can shrink the filesystem to the exact size in step 2 and avoid step 4. Be careful, though, many partition tools do not do exactly what you want, but instead adjust the requested partition start/end points to end on sector boundaries. This may be difficult to calculate ahead of time</div>
<h2><span class="mw-headline" id="Troubleshooting">Troubleshooting</span></h2>
<h3>
<span id=".2Fdev.2Fbcache_device_does_not_exist_on_bootup"></span><span class="mw-headline" id="/dev/bcache_device_does_not_exist_on_bootup">/dev/bcache device does not exist on bootup</span>
</h3>
<p>If you are sent to a busy box shell with an error:
</p>
<pre>ERROR: Unable to find root device 'UUID=b6b2d82b-f87e-44d5-bbc5-c51dd7aace15'.
You are being dropped to a recovery shell
    Type 'exit' to try and continue booting</pre>
<p>This might happen if the backing device is configured for "writeback" mode (default is writearound). When in "writeback" mode, the /dev/bcache0 device is not started until the cache device is both registered and attached. Registering is something that needs to happen every bootup, but attaching should only have to be done once. 
</p>
<p>To continue booting, try one of the following:
</p>
<ul><li>Register both the backing device and the caching device</li></ul>
<pre># echo /dev/sda3 &gt; /sys/fs/bcache/register
# echo /dev/sdb &gt; /sys/fs/bcache/register
</pre>
<p>If the /dev/bcache0 device now exists, type exit and continue booting. You will need to fix your initcpio to ensure devices are registered before mounting the root device.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> 
<ul>
<li>An error of "sh: echo: write error: Invalid argument" means the device was already registered or is not recognized as either a bcache backing device or cache. If using the udev rule on boot it should only attempt to register a device if it finds a bcache superblock</li>
<li>This can also happen if using udev's 69-bcache.rules in Installation's step 7 and blkid and bcache-probe "disagree" due to rogue superblocks. See <a rel="nofollow" class="external text" href="https://bcache.evilpiepirate.org/#index6h1">bcache's wiki</a> for a possible explanation/resolution.</li>
</ul>
</div>
<ul><li>Re-attach the cache to the backing device:</li></ul>
<p>If the cache device was registered, a folder with the UUID of the cache should exist in <code>/sys/fs/bcache</code>. Use that UUID when following the example below:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># ls /sys/fs/bcache/</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">b6b2d82b-f87e-44d5-bbc5-c51dd7aace15     register     register_quiet
</pre>
<pre># echo b6b2d82b-f87e-44d5-bbc5-c51dd7aace15 &gt; /sys/block/sda/sda3/bcache/attach
</pre>
<p>If the <code>/dev/bcache0</code> device now exists, type exit and continue booting. You should not have to do this again. If it persists, ask on the bcache mailing list.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> An error of <code>sh: echo: write error: Invalid argument</code> means the device was already attached. An error of <code>sh: echo: write error: No such file or directory</code> means the UUID is not a valid cache (make sure you typed it correctly).</div>
<ul><li>Invalidate the cache and force the backing device to run without it. You might want to check some stats, such as "dirty_data" so you have some idea of how much data will be lost.</li></ul>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># cat /sys/block/sda/sda3/bcache/dirty_data</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">-3.9M
</pre>
<p>dirty data is data in the cache that has not been written to the backing device. If you force the backing device to run, this data will be lost, even if you later re-attach the cache.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># cat /sys/block/sda/sda3/bcache/running</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">0
</pre>
<pre># echo 1 &gt; /sys/block/sda/sda3/bcache/running
</pre>
<p>The <code>/dev/bcache0</code> device will now exist. Type exit and continue booting. You might want to unregister the cache device and run make-bcache again. An fsck on <code>/dev/bcache0</code> would also be wise. See the <a rel="nofollow" class="external text" href="https://docs.kernel.org/admin-guide/bcache.html">bcache documentation</a>.
</p>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> Only invalidate the cache if one of the two options above did not work.</div>
<h3>
<span id=".2Fsys.2Ffs.2Fbcache.2F_does_not_exist"></span><span class="mw-headline" id="/sys/fs/bcache/_does_not_exist">/sys/fs/bcache/ does not exist</span>
</h3>
<p>The kernel you booted is not bcache enabled, or you the bcache <a href="../en/Kernel_module.html#Manual_module_handling" title="Kernel module">module is not loaded</a>
</p>
<h3><span class="mw-headline" id="write_error:_Invalid_argument_when_trying_to_attach_a_device_due_to_mismatched_block_parameter">write error: Invalid argument when trying to attach a device due to mismatched block parameter</span></h3>
<p>Given <code>bash: echo: write error: Invalid argument</code> when trying to attach a device, and the actual error is shown with <a href="../en/Core_utilities.html#Essentials" class="mw-redirect" title="Dmesg">dmesg</a>:
</p>
<pre>bcache: bch_cached_dev_attach() Couldn't attach sdc: block size less than set's block size
</pre>
<p>This happens because the <code>--block 4k</code> parameter was not set on either device and defaults can mismatch.
</p>
<p>Creating both the backing and caching device in one command automatically solves the issue, but when using separate commands the block size parameter sometimes needs to be set manually on both devices.
</p>
<h3><span class="mw-headline" id="Device_or_resource_busy">Device or resource busy</span></h3>
<p>When a device is in use as a bcache backing device, it can not be formatted nor partitioned: 
</p>
<pre># make-bcache -C /dev/sdb1
Can't open dev /dev/sdb1: Device or resource busy
</pre>
<pre># fdisk /dev/sdb

Welcome to fdisk (util-linux 2.37.2).
Changes will remain in memory only, until you decide to write them.
Be careful before using the write command.

This disk is currently in use - repartitioning is probably a bad idea.
It's recommended to umount all file systems, and swapoff all swap
partitions on this disk.


Command (m for help): q
</pre>
<p>To fix this, first run this command to confirm the disk is actually used as a bcache backing device:
</p>
<pre># bcache-super-show /dev/sdb1
sb.magic		ok
sb.first_sector		8 [match]
sb.csum			A3D2B8610F6C5E35 [match]
sb.version		1 [backing device]

dev.label		(empty)
dev.uuid		5a868788-65a2-4564-b4b7-c1817d0b6080
dev.sectors_per_block	1
dev.sectors_per_bucket	1024
dev.data.first_sector	16
dev.data.cache_mode	1 [writeback]
dev.data.cache_state	2 [dirty]

cset.uuid		42dcb651-6b53-4b65-bc49-9b1ca0acc5b1
</pre>
<p>Then stop the backing device. This will also remove the corresponding /dev/bcache device.
</p>
<pre># echo 1 &gt; /sys/class/block/sdb1/bcache/stop
</pre>
<pre># dmesg
[ 3171.263577] bcache: bcache_device_free() bcache0 stopped
</pre>
<p>Now the device can be partitioned:
</p>
<pre># fdisk /dev/sdb

Welcome to fdisk (util-linux 2.37.2).
Changes will remain in memory only, until you decide to write them.
Be careful before using the write command.


Command (m for help): q
</pre>
<p>When fdisk exits, the kernel scans the drive again, notices it's a bcache backing device, and uses the drive as a backing device.
</p>
<pre># dmesg
[ 3190.643270]  sdb: sdb1
[ 3190.833029] bcache: register_bdev() registered backing device sdb1
</pre>
<p>This creates the directory bcache under /sys/class/block/sdb1/
</p>
<pre># ls /sys/class/block/sdb1/
alignment_offset  bcache  dev  discard_alignment  holders  inflight  partition	power  ro  size  start	stat  subsystem  uevent
</pre>
<h2><span class="mw-headline" id="See_also">See also</span></h2>
<ul>
<li><a rel="nofollow" class="external text" href="https://bcache.evilpiepirate.org">Bcache Homepage</a></li>
<li><a rel="nofollow" class="external text" href="https://docs.kernel.org/admin-guide/bcache.html">Bcache Manual</a></li>
</ul>
</div>
</div>
					<div id="catlinks" class="catlinks" data-mw="interface">
<div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../Special:Categories.html" title="Special:Categories">Category</a>: <ul><li><a href="../en/Category:File_systems.html" title="Category:File systems">File systems</a></li></ul>
</div>
<div id="mw-hidden-catlinks" class="mw-hidden-catlinks mw-hidden-cats-hidden">Hidden categories: <ul>
<li><a href="../en/Category:Pages_or_sections_flagged_with_Template:Style.html" title="Category:Pages or sections flagged with Template:Style">Pages or sections flagged with Template:Style</a></li>
<li><a href="../en/Category:Pages_or_sections_flagged_with_Template:Out_of_date.html" title="Category:Pages or sections flagged with Template:Out of date">Pages or sections flagged with Template:Out of date</a></li>
</ul>
</div>
</div>
				</div>
			</main>
			
		</div>
		<div class="mw-footer-container">
			
<footer id="footer" class="mw-footer" role="contentinfo" style="margin: 0">
	<ul id="footer-info">
	<li data-nosnippet="">Retrieved from "<a dir="ltr" href="https://wiki.archlinux.org/index.php?title=Bcache&amp;oldid=790715">https://wiki.archlinux.org/index.php?title=Bcache&amp;oldid=790715</a>"</li>
<li id="footer-info-lastmod"> This page was last edited on 22 October 2023, at 08:43.</li>
	<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="https://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.3 or later</a> unless otherwise noted.</li>
<br>
</ul>

	<ul id="footer-places">
	<li id="footer-places-privacy"><a href="https://terms.archlinux.org/docs/privacy-policy/">Privacy policy</a></li>
	<li id="footer-places-about"><a href="../en/ArchWiki:About.html">About ArchWiki</a></li>
	<li id="footer-places-disclaimers"><a href="../en/ArchWiki:General_disclaimer.html">Disclaimers</a></li>
	<li id="footer-places-archwiki-code-of-conduct"><a href="https://terms.archlinux.org/docs/code-of-conduct/" class="extiw" title="archlinux-service-agreements:code-of-conduct">Code of conduct</a></li>
	<li id="footer-places-archwiki-terms-of-service"><a href="https://terms.archlinux.org/docs/terms-of-service/" class="extiw" title="archlinux-service-agreements:terms-of-service">Terms of service</a></li>
</ul>

	<ul id="footer-icons" class="noprint">
	<li id="footer-copyrightico"><a href="https://www.gnu.org/copyleft/fdl.html"><img src="/resources/assets/licenses/gnu-fdl.png" alt="GNU Free Documentation License 1.3 or later" width="88" height="31" loading="lazy"></a></li>
	<li id="footer-poweredbyico"><img src="/resources/assets/poweredby_mediawiki_88x31.png" srcset="/resources/assets/poweredby_mediawiki_132x47.png 1.5x, /resources/assets/poweredby_mediawiki_176x62.png 2x" width="88" height="31" loading="lazy"></li>
</ul>

</footer>

		</div>
	</div> 
</div> 
<div class="vector-settings" id="p-dock-bottom">
	<ul>
		<li>
		<button class="cdx-button cdx-button--icon-only vector-limited-width-toggle" id=""><span class="vector-icon mw-ui-icon-fullScreen mw-ui-icon-wikimedia-fullScreen"></span>

<span>Toggle limited content width</span>
</button>
</li>
	</ul>
</div>
</body>
</html>
