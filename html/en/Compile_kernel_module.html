<!DOCTYPE html>
<html class="client-nojs vector-feature-language-in-header-enabled vector-feature-language-in-main-page-header-disabled vector-feature-sticky-header-disabled vector-feature-page-tools-pinned-disabled vector-feature-toc-pinned-clientpref-1 vector-feature-main-menu-pinned-disabled vector-feature-limited-width-clientpref-1 vector-feature-limited-width-content-enabled vector-feature-custom-font-size-clientpref-0 vector-feature-client-preferences-disabled vector-feature-client-prefs-pinned-disabled vector-feature-night-mode-disabled skin-theme-clientpref-day vector-toc-available" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>Compile kernel module - ArchWiki</title>
<link rel="stylesheet" href="../ArchWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<meta name="generator" content="MediaWiki 1.42.1">
<meta name="referrer" content="no-referrer-when-downgrade">
<meta name="robots" content="max-image-preview:standard">
<meta name="format-detection" content="telephone=no">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=0.25, maximum-scale=5.0">
<link rel="icon" href="/favicon.ico">
<link rel="search" type="application/opensearchdescription+xml" href="/opensearch_desc.php" title="ArchWiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.archlinux.org/api.php?action=rsd">
<link rel="license" href="https://www.gnu.org/copyleft/fdl.html">
<link rel="alternate" type="application/atom+xml" title="ArchWiki Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="skin-vector skin-vector-search-vue mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-Compile_kernel_module rootpage-Compile_kernel_module skin-vector-2022 action-view skin--responsive">
<a class="mw-jump-link" href="#bodyContent">Jump to content</a>
<div class="vector-header-container">
	</div>
<div class="mw-page-container">
	<div class="mw-page-container-inner">
		<div class="vector-column-start">
			<div class="vector-main-menu-container">
		</div>
	<div class="vector-sticky-pinned-container">
				<nav id="mw-panel-toc" role="navigation" aria-label="Contents" data-event-name="ui.sidebar-toc" class="mw-table-of-contents-container vector-toc-landmark">
					<div id="vector-toc-pinned-container" class="vector-pinned-container">
					<div id="vector-toc" class="vector-toc vector-pinnable-element">
	<div class="vector-pinnable-header vector-toc-pinnable-header vector-pinnable-header-pinned" data-feature-name="toc-pinned" data-pinnable-element-id="vector-toc">
	<h2 class="vector-pinnable-header-label">Contents</h2>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-pin-button" data-event-name="pinnable-header.vector-toc.pin">move to sidebar</button>
	<button class="vector-pinnable-header-toggle-button vector-pinnable-header-unpin-button" data-event-name="pinnable-header.vector-toc.unpin">hide</button>
</div>


	<ul class="vector-toc-contents" id="mw-panel-toc-list">
		<li id="toc-mw-content-text" class="vector-toc-list-item vector-toc-level-1">
			<a href="#" class="vector-toc-link">
				<div class="vector-toc-text">Beginning</div>
			</a>
		</li>
		<li id="toc-Build_environment" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#Build_environment">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">1</span>Build environment</div>
		</a>
		
			<button aria-controls="toc-Build_environment-sublist" class="cdx-button cdx-button--weight-quiet cdx-button--icon-only vector-toc-toggle">
				<span class="vector-icon vector-icon--x-small mw-ui-icon-wikimedia-expand"></span>
				<span>Toggle Build environment subsection</span>
			</button>
		
		<ul id="toc-Build_environment-sublist" class="vector-toc-list">
			<li id="toc-Traditional_compilation" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Traditional_compilation">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">1.1</span>Traditional compilation</div>
			</a>
			
			<ul id="toc-Traditional_compilation-sublist" class="vector-toc-list">
			</ul>
		</li>
		<li id="toc-Arch_Build_System" class="vector-toc-list-item vector-toc-level-2">
			<a class="vector-toc-link" href="#Arch_Build_System">
				<div class="vector-toc-text">
				<span class="vector-toc-numb">1.2</span>Arch Build System</div>
			</a>
			
			<ul id="toc-Arch_Build_System-sublist" class="vector-toc-list">
			</ul>
		</li>
	</ul>
	</li>
	<li id="toc-Source_configuration" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#Source_configuration">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">2</span>Source configuration</div>
		</a>
		
		<ul id="toc-Source_configuration-sublist" class="vector-toc-list">
		</ul>
	</li>
	<li id="toc-Module_compilation" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#Module_compilation">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">3</span>Module compilation</div>
		</a>
		
		<ul id="toc-Module_compilation-sublist" class="vector-toc-list">
		</ul>
	</li>
	<li id="toc-out-of-tree_module_compilation" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#out-of-tree_module_compilation">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">4</span>out-of-tree module compilation</div>
		</a>
		
		<ul id="toc-out-of-tree_module_compilation-sublist" class="vector-toc-list">
		</ul>
	</li>
	<li id="toc-Module_installation" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#Module_installation">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">5</span>Module installation</div>
		</a>
		
		<ul id="toc-Module_installation-sublist" class="vector-toc-list">
		</ul>
	</li>
	<li id="toc-possible_errors" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#possible_errors">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">6</span>possible errors</div>
		</a>
		
		<ul id="toc-possible_errors-sublist" class="vector-toc-list">
		</ul>
	</li>
	<li id="toc-See_also" class="vector-toc-list-item vector-toc-level-1 vector-toc-list-item-expanded">
		<a class="vector-toc-link" href="#See_also">
			<div class="vector-toc-text">
			<span class="vector-toc-numb">7</span>See also</div>
		</a>
		
		<ul id="toc-See_also-sublist" class="vector-toc-list">
		</ul>
	</li>
</ul>
</div>

					</div>
		</nav>
			</div>
		</div>
		<div class="mw-content-container">
			<main id="content" class="mw-body" role="main" style="margin: 0">
				<header class="mw-body-header vector-page-titlebar">
					<nav role="navigation" aria-label="Contents" class="vector-toc-landmark">
						
<div id="vector-page-titlebar-toc" class="vector-dropdown vector-page-titlebar-toc vector-button-flush-left">
	<input type="checkbox" id="vector-page-titlebar-toc-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-vector-page-titlebar-toc" class="vector-dropdown-checkbox " aria-label="Toggle the table of contents">
	<label id="vector-page-titlebar-toc-label" for="vector-page-titlebar-toc-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--icon-only " aria-hidden="true"><span class="vector-icon mw-ui-icon-listBullet mw-ui-icon-wikimedia-listBullet"></span>

<span class="vector-dropdown-label-text">Toggle the table of contents</span>
	</label>
	<div class="vector-dropdown-content">


							<div id="vector-page-titlebar-toc-unpinned-container" class="vector-unpinned-container">
			</div>
		
	</div>
</div>

					</nav>
					<h1 id="firstHeading" class="firstHeading mw-first-heading"><span class="mw-page-title-main">Compile kernel module</span></h1>
							
<div id="p-lang-btn" class="vector-dropdown mw-portlet mw-portlet-lang">
	<input type="checkbox" id="p-lang-btn-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-p-lang-btn" class="vector-dropdown-checkbox mw-interlanguage-selector" aria-label="Go to an article in another language. Available in 2 languages">
	<label id="p-lang-btn-label" for="p-lang-btn-checkbox" class="vector-dropdown-label cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--action-progressive mw-portlet-lang-heading-2" aria-hidden="true"><span class="vector-icon mw-ui-icon-language-progressive mw-ui-icon-wikimedia-language-progressive"></span>

<span class="vector-dropdown-label-text">2 languages</span>
	</label>
	<div class="vector-dropdown-content">

		<div class="vector-menu-content">
			
			<ul class="vector-menu-content-list">
				
				<li class="interlanguage-link interwiki-bs mw-list-item"><a href="../bs/Compile_kernel_module.html" title="Compile kernel module – bosanski" lang="bs" hreflang="bs" class="interlanguage-link-target"><span>Bosanski</span></a></li>
<li class="interlanguage-link interwiki-ja mw-list-item"><a href="https://wiki.archlinux.jp/index.php/%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E3%81%AE%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB" title="カーネルモジュールのコンパイル – 日本語" lang="ja" hreflang="ja" class="interlanguage-link-target"><span>日本語</span></a></li>
			</ul>
			
		</div>

	</div>
</div>
</header>
				<div class="vector-column-end">
					<div class="vector-sticky-pinned-container">
						<nav class="vector-page-tools-landmark" aria-label="Page tools">
							<div id="vector-page-tools-pinned-container" class="vector-pinned-container">
				
							</div>
		</nav>
						<nav class="vector-client-prefs-landmark" aria-label="Appearance">
						</nav>
					</div>
				</div>
				<div id="bodyContent" class="vector-body" aria-labelledby="firstHeading" data-mw-ve-target-container>
					<div class="vector-body-before-content">
							<div class="mw-indicators">
		</div>

						<div id="siteSub" class="noprint">From ArchWiki</div>
					</div>
					<div id="contentSub"><div id="mw-content-subtitle"></div></div>
					
					
					<div id="mw-content-text" class="mw-body-content">
<div class="mw-content-ltr mw-parser-output" lang="en" dir="ltr">
<div class="archwiki-template-meta-related-articles">
<p>Related articles</p>
<ul>
<li><a href="../en/Kernel.html" title="Kernel">Kernel</a></li>
<li><a href="../en/Kernel_module.html" class="mw-redirect" title="Kernel modules">Kernel modules</a></li>
<li><a href="../en/Dynamic_Kernel_Module_Support.html" title="Dynamic Kernel Module Support">Dynamic Kernel Module Support</a></li>
</ul>
</div>
<p>Sometimes you may wish to compile Linux's <a href="../en/Kernel_module.html" title="Kernel module">Kernel module</a> without recompiling the whole kernel.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> You can only replace existing module if it is compiled as module (M) and not builtin (y) into kernel.</div>
<meta property="mw:PageProp/toc">
<h2><span class="mw-headline" id="Build_environment">Build environment</span></h2>
<p>Firstly you will need to install build dependencies such as a compiler (<span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=base-devel">base-devel</a></span>) and <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=linux-headers">linux-headers</a></span>.
</p>
<p>Next you will need to get the source code for the kernel version the module is intended to run on. You may try using newer kernel sources but most likely the compiled module will not load.
</p>
<p>In case the intended kernel version is the installed kernel, find its version with
</p>
<pre>$ uname -r
</pre>
<p>There are two main options to acquire the required source. Each option has slightly different usage methods and directory structure.
</p>
<h3><span class="mw-headline" id="Traditional_compilation">Traditional compilation</span></h3>
<p>See <a href="../en/Kernel/Traditional_compilation.html#Download_the_kernel_source" title="Kernel/Traditional compilation">Kernel/Traditional compilation#Download the kernel source</a>. If you fetch latest source using <a href="../en/Git.html" title="Git">Git</a> you will need to checkout needed version using tag (eg. v4.1).
</p>
<h3><span class="mw-headline" id="Arch_Build_System">Arch Build System</span></h3>
<p>For a general overview on Arch Build System read <a href="../en/Arch_build_system.html" class="mw-redirect" title="ABS">ABS</a>. See <a href="../en/Kernel/Arch_build_system.html" title="Kernel/Arch build system">Kernel/Arch build system</a> for acquiring the kernel source, as well as the directory structure, and other details.
</p>
<h2><span class="mw-headline" id="Source_configuration">Source configuration</span></h2>
<p>When you have the source code, enter its directory. For the <a href="#Arch_Build_System">#Arch Build System</a> case, that directory would be <code>src/archlinux-linux/</code> down from where the PKGBUILD is.
</p>
<p>The output from <code>make help</code> is beneficial here. Start by cleaning with 
</p>
<pre>$ make mrproper
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> it will delete both <code>.config</code> and <code>.config.old</code>. You might want to save those files some where else before cleaning.</div>
<p>An appropriate <code>.config</code> file is now required. If none is nearby, perhaps from a saved <code>.config</code>, and the intended kernel version is the running kernel, you can use its configuration file: 
</p>
<pre>$ zcat /proc/config.gz &gt; .config
</pre>
<p>Next ensure the <code>.config</code> file is adjusted for the kernel version. If you are using kernel sources for the exact current version then it should not ask anything. But for another version than the current kernel you might be asked about some options. In any case, for the <a href="#Arch_Build_System">#Arch Build System</a> option, you might want to examine the <code>PKGBUILD::prepare()</code> function. 
</p>
<p>If the module you want to compile have some compilation options such as debug build, or it was not compiled before, you can also, possibly must, adjust the kernel configuration. You can do this with one of the many configuration targets mentioned by make help.
</p>
<pre>$ make oldconfig
</pre>
<h2><span class="mw-headline" id="Module_compilation">Module compilation</span></h2>
<p>In order to compile and load our module cleanly, we must find the value of the EXTRAVERSION component of the current kernel version number so we can match the version number exactly in our kernel source. EXTRAVERSION is a variable set in the kernel top-level Makefile, but the Makefile in a vanilla kernel source will have EXTRAVERSION empty; it is set only as part of the Arch kernel build process. If relevant, the value of the current kernel's EXTRAVERSION can be found by looking at the output of the <code>uname -r</code> command. In general, the kernel version is the concatenation of three components. Namely, the numeric version, the EXTRAVERSION, and the LOCALVERSION. The numeric version itself is a concatenation of three numbers. If built by a <a href="../en/PKGBUILD.html" title="PKGBUILD">PKGBUILD</a> file, the LOCALVERSION will be taken from the <code>pkgrel</code> variable, prefixed by a hyphen. And the EXTRAVERSION will be the suffix of the <code>pkgver</code> variable, where the period character to the right of the third numeric number of the numeric version is replaced by a hyphen. For example, with the linux package <code>linux 5.5.8.arch1-1</code>, the LOCALVERSION is <code>-1</code>. The EXTRAVERSION is <code>-arch1</code>. The output of <code>uname -r</code> will be <code>5.5.8-arch1-1</code> in that example.
</p>
<p>Once the EXTRAVERSION value is known, we prepare the source for module compilation:
</p>
<pre>$ make EXTRAVERSION=&lt;YOUR EXTRAVERSION HERE&gt; modules_prepare
</pre>
<p>Example:
</p>
<pre>$ make EXTRAVERSION=-arch1 modules_prepare
</pre>
<p>Alternatively, if you are happy to load modules with <i>modprobe</i> using the <code>--force-vermagic</code> option to ignore mismatches in the kernel version number, you can simply run:
</p>
<pre>$ make modules_prepare
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> Using the EXTRAVERSION that is recorded in the top level Makefile to avoid manually specifying the EXTRAVERSION on the command line could cause a version mismatch. The kernel build process would recognize that, causing it to append a <code>+</code> character to the LOCALVERSION configuration setting. For example: <code>5.5.8-arch1-1+</code>.</div>
<p>Finally, compile wanted module by specifying its directory name. You can find the module location, thus also its directory name, with <i>modinfo</i> or <i>find</i>.
</p>
<pre>$ make M=fs/btrfs
</pre>
<p>As a last resort, if nothing else has worked, you can
</p>
<pre>$ make modules
</pre>
<p>Which will build all the modules from the kernel configuration.
</p>
<h2><span class="mw-headline" id="out-of-tree_module_compilation">out-of-tree module compilation</span></h2>
<p>get the official source code of the current running linux kernel as described in <a href="../en/Kernel/Arch_build_system.html" title="Kernel/Arch build system">Kernel/Arch build system</a>:
</p>
<pre>$ cd &amp;&amp; mkdir build
$ pkgctl repo clone linux
</pre>
<p>then point to the checked out source when compiling the module:
</p>
<pre>$ cd build/mymod
$ make -C ~/build/linux/src/archlinux-linux M=$PWD modules
</pre>
<h2><span class="mw-headline" id="Module_installation">Module installation</span></h2>
<p>Now after successful compilation you just need to gzip and copy it over for your current kernel. 
</p>
<p>If you are replacing some existing module you will need to overwrite it (and remember that reinstalling <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=linux">linux</a></span> will replace it with default module)
</p>
<pre>$ zstd fs/btrfs/btrfs.ko
# cp -f fs/btrfs/btrfs.ko.zst /usr/lib/modules/$(uname -r)/kernel/fs/btrfs/
</pre>
<p>Or alternatively, you can place the updated module in the updates folder (create it if it does not already exist). 
</p>
<pre>$ cp fs/btrfs/btrfs.ko.zst /usr/lib/modules/$(uname -r)/updates
</pre>
<p>However if you are adding a new module you can just copy it to extramodules (note, this is just example as btrfs will not get loaded from here)
</p>
<pre># cp fs/btrfs/btrfs.ko.zst /usr/lib/modules/$(uname -r)/extramodules/
</pre>
<p>You need to rebuild the module dependency tree with "depmod" to use installed modules.
</p>
<p>If you are compiling a module for early boot (e.g. updated module) which is copied to <a href="../en/Arch_boot_process.html#initramfs" class="mw-redirect" title="Initramfs">Initramfs</a> then you must remember to regenerate it with (otherwise your compiled module will not be loaded). 
</p>
<pre># mkinitcpio -p linux
</pre>
<h2><span class="mw-headline" id="possible_errors">possible errors</span></h2>
<p>If EXTRAVERSION is not set correctly the following errors may occur
</p>
<pre># insmod mymod.ko
insmod: ERROR: could not insert module mymod.ko: Invalid module format
# modprobe mymod
modprobe: ERROR: could not insert 'mymod': Exec format error
</pre>
<p>adding force-vermagic makes it ignore the version mismatch
</p>
<pre>modprobe mymod --force-vermagic
</pre>
<h2><span class="mw-headline" id="See_also">See also</span></h2>
<ul>
<li><a rel="nofollow" class="external text" href="https://kernelnewbies.org/">Linux Kernel Newbies</a></li>
<li><a rel="nofollow" class="external text" href="https://sysprog21.github.io/lkmpg/">The Linux Kernel Module Programming Guide</a></li>
</ul>
</div>
</div>
					<div id="catlinks" class="catlinks" data-mw="interface"><div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../Special:Categories.html" title="Special:Categories">Category</a>: <ul><li><a href="../en/Category:Kernel.html" title="Category:Kernel">Kernel</a></li></ul>
</div></div>
				</div>
			</main>
			
		</div>
		<div class="mw-footer-container">
			
<footer id="footer" class="mw-footer" role="contentinfo" style="margin: 0">
	<ul id="footer-info">
	<li data-nosnippet="">Retrieved from "<a dir="ltr" href="https://wiki.archlinux.org/index.php?title=Compile_kernel_module&amp;oldid=806343">https://wiki.archlinux.org/index.php?title=Compile_kernel_module&amp;oldid=806343</a>"</li>
<li id="footer-info-lastmod"> This page was last edited on 18 April 2024, at 08:50.</li>
	<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="https://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.3 or later</a> unless otherwise noted.</li>
<br>
</ul>

	<ul id="footer-places">
	<li id="footer-places-privacy"><a href="https://terms.archlinux.org/docs/privacy-policy/">Privacy policy</a></li>
	<li id="footer-places-about"><a href="../en/ArchWiki:About.html">About ArchWiki</a></li>
	<li id="footer-places-disclaimers"><a href="../en/ArchWiki:General_disclaimer.html">Disclaimers</a></li>
	<li id="footer-places-archwiki-code-of-conduct"><a href="https://terms.archlinux.org/docs/code-of-conduct/" class="extiw" title="archlinux-service-agreements:code-of-conduct">Code of conduct</a></li>
	<li id="footer-places-archwiki-terms-of-service"><a href="https://terms.archlinux.org/docs/terms-of-service/" class="extiw" title="archlinux-service-agreements:terms-of-service">Terms of service</a></li>
</ul>

	<ul id="footer-icons" class="noprint">
	<li id="footer-copyrightico"><a href="https://www.gnu.org/copyleft/fdl.html"><img src="/resources/assets/licenses/gnu-fdl.png" alt="GNU Free Documentation License 1.3 or later" width="88" height="31" loading="lazy"></a></li>
	<li id="footer-poweredbyico"><img src="/resources/assets/poweredby_mediawiki_88x31.png" srcset="/resources/assets/poweredby_mediawiki_132x47.png 1.5x, /resources/assets/poweredby_mediawiki_176x62.png 2x" width="88" height="31" loading="lazy"></li>
</ul>

</footer>

		</div>
	</div> 
</div> 
<div class="vector-settings" id="p-dock-bottom">
	<ul>
		<li>
		<button class="cdx-button cdx-button--icon-only vector-limited-width-toggle" id=""><span class="vector-icon mw-ui-icon-fullScreen mw-ui-icon-wikimedia-fullScreen"></span>

<span>Toggle limited content width</span>
</button>
</li>
	</ul>
</div>
</body>
</html>
